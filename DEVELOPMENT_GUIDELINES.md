# ArchiDeck 開発ガイドライン

## デバッグ・問題解決の原則

### 1. 自責ファースト原則

問題が発生したとき、以下の順序で原因を調査する：

| 順位 | 調査対象 | 理由 |
|------|----------|------|
| 1 | **自分のコード** | 最も変更頻度が高く、バグの可能性が最も高い |
| 2 | 設定・環境変数 | 設定ミスは頻繁に起こる |
| 3 | 依存ライブラリ | バージョン不整合など |
| 4 | 外部サービス | API障害、ネットワークなど |

**NG例：**
- ユーザーに「キャッシュをクリアして」と言う
- 「CDNの問題かもしれない」と外部要因を疑う
- エラーハンドリングを追加して問題を覆い隠す

**OK例：**
- 「最近変更したコードを確認します」
- 「論理フローを追跡してどこで問題が起きているか特定します」
- 「デバッグログを追加して問題箇所を特定します」

### 2. 根本原因分析（RCA）

問題を修正する前に、必ず以下を実行：

1. **再現手順を明確にする** - いつ、どの操作で問題が発生するか
2. **コードの論理フローを追跡する** - データがどう流れているか
3. **仮説を立てて検証する** - 「もし〇〇なら△△になるはず」
4. **根本原因を特定してから修正する** - 対症療法より根治療法

### 3. エラーハンドリングの考え方

- エラーハンドリングは**予防策**であり、**問題の覆い隠し**ではない
- try-catchを追加しても根本原因が解決されるわけではない
- エラーハンドリングを追加する前に、なぜそのエラーが起きるのかを理解する

### 4. 提出前の自己評価・検証（最重要）

**絶対原則：ユーザーに見せる前に、自分自身で評価と改善を繰り返す**

コードを書いたら、以下のサイクルを必ず実行してから提出する：

```
[コード作成] → [自己レビュー] → [動作確認] → [問題発見] → [修正] → [再確認] → ... → [提出]
                     ↑_________________________________________|
```

**NG例（絶対にやってはいけないこと）：**
- コードを書いてすぐにコミット・プッシュ
- 「動くはず」という思い込みでデプロイ
- ユーザーを本番環境のテスターにする
- 修正が新たなバグを生んでいないか確認しない

**OK例：**
- ローカルで動作確認してからコミット
- 変更箇所が既存機能を壊していないか確認
- エッジケースを考慮してテスト
- 「この修正で何が壊れる可能性があるか」を自問する

**検証項目：**
1. 基本機能が動作するか
2. 認証フローが正常か（ログイン必須の画面にログインなしでアクセスできないか）
3. データが正しく表示されるか
4. エラー時の挙動が正しいか
5. 既存機能を壊していないか

---

## 具体的な失敗事例と教訓

### 事例1: 画面が真っ白になる問題（v4.99.12）

**状況：**
- ユーザー報告：「ログイン画面が一瞬表示され、完全に真っ白になる」
- コンソールエラーなし

**悪い対応（実際にやってしまったこと）：**
1. 「Service Workerのキャッシュ問題かもしれない」→ Service Worker無効化
2. 「CDNのキャッシュかもしれない」→ Vercel no-cacheヘッダー追加
3. 「ユーザーにサイトデータ消去してもらおう」→ 一時的な対処

**良い対応（すべきだったこと）：**
1. 「ログイン画面が表示された後に消えるということは、checkAuth()の処理中に何か起きている」
2. checkAuth()のフローを追跡：
   - ログイン画面表示 → セッション確認 → loginContainer非表示 → (ここで何か？) → mainContainer表示されない
3. 「loginContainerを隠してからmainContainerを表示するまでの間に、非同期処理でエラーが起きると両方非表示になる」
4. 根本原因：非同期処理の順序とエラーハンドリングの問題

**教訓：**
- ユーザーに操作を求める前に自分のコードを確認する
- 「コンソールエラーなし」は「バグがない」ではない（サイレントエラーの可能性）
- 非同期処理のフローを紙に書いて追跡する

### 事例2: 修正がさらなる障害を引き起こした（v4.99.12）

**状況：**
- 事例1の修正としてエラーハンドリングを追加
- その修正をテストせずに本番にデプロイ

**結果：**
- **ログインなしでシステムにアクセス可能になった**（認証バイパス）
- **全データが空っぽで表示された**（初期化処理の破壊）
- 緊急リバートが必要になった

**原因：**
- 修正コードを書いた後、動作確認をせずにコミット・プッシュした
- 「エラーハンドリングを追加しただけだから大丈夫」という思い込み
- 認証フローに変更を加えたのに、ログイン動作を確認しなかった

**教訓：**
1. **どんな小さな修正でも、本番に出す前に動作確認する**
2. 認証関連のコードを変更したら、必ずログイン動作を確認する
3. 「修正」が新たなバグを生む可能性を常に考慮する
4. ユーザーを本番環境のテスターにしてはいけない

**正しい対応手順：**
```
1. 修正コードを書く
2. ローカルで動作確認（ログインできるか？データ表示されるか？）
3. 問題なければコミット
4. 問題あれば修正して2に戻る
5. プッシュ・デプロイ
```

---

## チェックリスト

### 問題報告を受けたとき

- [ ] まず自分のコードを確認したか？
- [ ] 最近の変更を git log で確認したか？
- [ ] 論理フローを追跡したか？
- [ ] デバッグログを追加して問題箇所を特定したか？
- [ ] ユーザーに操作を求める前に自己解決を試みたか？

### 修正をコミットする前

- [ ] 根本原因を特定したか？
- [ ] 対症療法ではなく根治療法か？
- [ ] 同様の問題が他の箇所で起きる可能性は？
- [ ] テストで問題が再現しないことを確認したか？

---

*このドキュメントは2026-01-10に作成されました。失敗から学び、より良い開発者になるために。*
