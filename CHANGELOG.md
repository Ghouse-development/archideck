# ArchiDeck 開発履歴

## 技術仕様

### アーキテクチャ
- **フロントエンド**: 単一HTMLファイル（CSS/JS埋め込み）
- **バックエンド**: Supabase（PostgreSQL + RLS + Storage + Auth）
- **ホスティング**: Vercel
- **認証**: Supabase Auth（メール/パスワード）

### データベーステーブル
| テーブル名 | 用途 |
|-----------|------|
| projects | 案件情報 |
| designers | 設計士・IC・外構担当 |
| tasks | タスクマスタ |
| project_tasks | カスタムタスク |
| project_minutes | 議事録 |
| project_handovers | 引継書 |
| products | 商品マスタ |
| vendors | 業者情報 |
| organizations | 組織（マルチテナント） |
| subscriptions | サブスクリプション |
| plans | 料金プラン |
| audit_logs | 監査ログ |

### セキュリティ
- RLS（Row Level Security）による組織単位のデータ分離
- JWT認証
- XSS対策ヘッダー（vercel.json）

### 本番URL
- メインアプリ: https://nandemo-nu.vercel.app/ （ドメイン変更予定）
- 管理者画面: https://nandemo-nu.vercel.app/admin

---

## v4.31.0 (2025-12-14)

### バグ修正

#### 申請Goロジック改善
- タスクキーを動的に検索するように変更（ハードコード依存を解消）
- データベースのタスク定義に基づいて条件をチェック
- 各タスクの「最終状態」を自動判定（state_optionsの最後の値）
- ツールチップも動的に生成

#### SRIハッシュ修正
- Supabase CDNの正しいSRIハッシュに修正

#### isDemoMode初期化順序修正
- 変数宣言を関数の前に移動（TDZエラー解消）

#### レポート機能改善
- 週報・月報のタスクステータス表示を動的に生成
- データベースのタスク定義に基づいて表示

---

## v4.30.0 (2025-12-14)

### 生産性向上（Phase 2）

#### 検索オートコンプリート
- 検索ボックスで過去の検索履歴と顧客名を候補表示
- 最大20件の検索履歴を自動保存
- 入力時にドロップダウンで候補選択可能

#### 右クリックメニュー対応
- 案件カード上で右クリックするとコンテキストメニューを表示
- 操作: 編集、お気に入り、選択、完了済み移動、削除
- マウス操作の効率化

---

## v4.29.0 (2025-12-14)

### 生産性向上（Phase 1）

#### キーボードショートカット拡張
- `Ctrl+E`: CSV出力
- `Ctrl+A`: 全案件選択（テキスト入力中以外）
- ヘルプ画面（Shift+?）に新ショートカットを追加

#### 保存フィードバック改善
- ステータス表示を3秒後に自動クリア
- 連続保存時のステータス表示が見やすく

#### デフォルト担当者機能
- 「全案件」タブでも最後に使用した担当者を自動選択
- 担当者選択の手間を削減

---

## v4.28.0 (2025-12-14)

### コード品質改善

#### 未使用コード削除
- `memoize`関数を削除（定義のみで未使用）

#### コードリファクタリング
- デザイナーフィルタリングを共通関数化
  - `getDesignersByCategory(category)` - 汎用ヘルパー関数
  - `getSekkeiDesigners()`, `getIcDesigners()`, `getExteriorDesigners()` - カテゴリ別ヘルパー
- 重複コードを削減し保守性向上

### セキュリティ強化

#### CDN SRI対応
- Supabase JSライブラリにSRI（Subresource Integrity）属性を追加
  - バージョンを2.87.1に固定
  - `integrity="sha256-..."` でファイル改ざん検知

---

## v4.27.0 (2025-12-14)

### UI改善

#### サイドバーデザイン統一
- 外構担当セクションのデザインを設計担当・IC担当と統一
  - 特別な左ボーダー（緑色）を削除
  - `sidebar-section-exterior` クラスを廃止

---

## v4.26.0 (2025-12-14)

### UI改善

#### 月報の視認性・モバイル対応
- ハードコードされた白色をCSS変数に変更（背景と文字が同化する問題を修正）
  - `.report-designer-section`: #FFFFFF → var(--bg-primary)
  - `.report-project-detail`: #F8FAFC → var(--bg-secondary)
  - `.report-status-tag`: ハードコード色 → CSS変数
- 左ボーダー色をプライマリカラーに統一
- スマホ表示の文字重なり修正
  - ヘッダー・担当者セクション・タイトルを縦並びに
  - ステータスタグのフォントサイズ縮小
  - 統計グリッドを2列に調整

### 機能削除（実用性のない機能を整理）

#### ガントチャート削除
- 進捗率の横棒グラフに過ぎず、実際のスケジュール管理には使えなかった

#### AI予測分析削除
- 実際にはAIではなく単純なif文ロジックだった

#### カレンダービュー削除
- 期限設定された案件のみ表示され、使用頻度が低かった

#### KPIカード削除
- 総案件数、完了済み、要注意案件、平均進捗率の表示
- 実務で活用されていなかった

#### 担当者別パフォーマンス表削除
- 担当案件数、完了率などの統計表
- 実務で活用されていなかった

#### タスク-テンプレート紐づけ削除
- 「旧システムです」と表示されるだけのデッドコード

### コード品質改善

#### 古い業者管理関数を削除
- V2版と重複していた旧関数を削除（約190行）
  - `renderVendors()` → `renderVendorsV2()`
  - `openVendorModal()` → `openVendorModalV2()`
  - `closeVendorModal()` → `closeVendorModalV2()`
  - `saveVendor()` → `saveVendorV2()`
  - `editVendor()` → `editVendorV2()`
  - `deleteVendor()` → `deleteVendorV2()`

### バグ修正

#### クラッシュ防止
- `openProjectModal`: 削除された案件を開こうとした時のnullチェック追加
- `formatDateTime`: 無効な日付でNaN表示される問題を修正

---

## v4.25.0 (2025-12-14)

### コード品質改善

#### 不要コードの削除
- 本番用console.log削除（申請GO条件チェック用デバッグログ、SaveGuardデバッグログ）
- 未使用スケルトンローディング関数削除（`showSkeletonLoading`, `hideSkeletonLoading`）

#### ModalManager統一
- 全モーダルをModalManagerで統一管理（Escapeキー・フォーカス管理の一貫性）
  - `openVendorModalV2` / `closeVendorModalV2`
  - `openCategoryModal` / `closeCategoryModal`
  - `openTaskModal` / `closeTaskModal`
  - `openFcModal` / `closeFcModal`

#### イベントリスナー蓄積防止
- `openFcModal`: カラーピッカー同期をHTML側のoninputに移動

#### 二重実行防止（SaveGuard）追加
- `saveCategory`: カテゴリ保存の連打防止
- `saveTask`: タスク保存の連打防止
- `saveTemplate`: テンプレート保存の連打防止
- `deleteFc`: FC削除の連打防止

---

## v4.24.0 (2025-12-14)

### セキュリティ修正

#### カスタマイズプレビューの安全性向上
- ロゴURL: http/httpsのみ許可、DOM操作でXSS防止
- カラー値: #RRGGBB形式のみ許可（CSS注入防止）
- null参照エラー防止のためのチェック追加
- 画像読み込みエラー時のフォールバック

#### ModalManager改善
- Escapeハンドラの蓄積を防止
- open()時に既存ハンドラを先に解除

---

## v4.23.0 (2025-12-14)

### 新機能

#### インタラクティブツアー（初めての方へ）
- 初回訪問時に自動でウェルカム画面を表示
- 5ステップのガイドツアー:
  1. サイドバー（担当者切り替え）
  2. 案件カード（詳細・進捗管理）
  3. 新規案件追加ボタン
  4. 検索・フィルター
  5. 設定画面
- ヘッダーに「❓」ボタン追加（いつでもツアー再開可能）
- ステップインジケーター（進捗表示）
- localStorageで完了状態を記憶

---

## v4.22.0 (2025-12-14)

### 安定性向上

#### 削除操作の二重実行防止
- 主要な削除関数にSaveGuard追加（連打対策）
  - `deleteVendorV2`, `deleteCategory`, `deleteProject`
  - `deleteDesigner`, `deleteTask`

#### Service Worker処理の順序制御
- キャッシュクリア → SW更新 → 再登録の順に実行
- Promise.allで並列処理しつつ各ステップを順次実行
- エラー時はlogErrorで記録

---

## v4.21.0 (2025-12-14)

### 堅牢性向上

#### UndoManager エラーハンドリング追加
- `revert()` / `apply()` の全DB操作にエラーチェック追加
- 失敗時は即座にエラーをthrowし、ユーザーに通知

#### saveTaskVendorMappings 修正
- 既存紐づけ削除時のエラーチェック追加
- 削除失敗時は新規挿入を中止

#### CSV読み込み検証追加
- 空ファイル/ヘッダーのみのファイルをチェック
- エラー時にユーザーへ通知

#### バックアップ復元のエラー通知
- 失敗件数をカウントして表示
- 部分的な失敗も警告として通知

#### 印刷機能のポップアップブロック対応
- `window.open` 失敗時にエラーメッセージ表示

---

## v4.20.0 (2025-12-14)

### UI改善

#### 月報の視認性向上
- 担当者セクション：白背景+境界線+影でカード化
- ステータスタグ：背景色とテキスト色のコントラスト改善
- プロジェクト詳細：左境界線を濃く、背景を薄いグレーに
- 全体的に読みやすさが大幅に向上

---

## v4.19.0 (2025-12-14)

### コード品質改善

#### エラーハンドリングの統一
- `loadTasksV2()` - エラー時に適切なログ出力と配列初期化を追加
- `loadVendorCategories()` - 同上
- `loadTaskVendorMappings()` - 冗長なデバッグログを削除、エラーハンドリングを統一

すべてのデータ読み込み関数で以下のパターンを統一:
1. エラー時は `logError()` でエラー出力
2. 変数を空配列で初期化（不整合防止）
3. `return` で早期終了

---

## v4.18.0 (2025-12-14)

### セキュリティ・品質改善

#### XSS対策
- `error.message`のinnerHTML使用箇所を修正（3箇所）
- CSVプレビューにエスケープ処理追加

#### 重複コード修正
- `toggleProjectTask`関数の重複を解消（2引数版を削除、3引数版に統一）
- タスク完了時にスタッフ別タスク一覧も更新するよう改善

#### 関数名の競合解消
- ドラッグ&ドロップ関数を用途別にリネーム:
  - `handleDesignerDrag*` - スタッフ並び替え用
  - `handleProjectDrag*` - 案件カード並び替え用
  - `handleMinutesDrag*` - 議事録アップロード用

---

## v4.17.0 (2025-12-14)

### コード品質改善

#### 重複コード削除
- `openEmailFromTask`関数の重複定義を削除（旧システム2つを削除、新システム1つに統一）
- 関連する未使用ヘルパー関数を削除（`updateVendorInfo`, `generateEmail`, `copyText`等）
- 約340行のデッドコードを削除

#### XSS対策追加（セレクトボックス）
- 商品選択ドロップダウン
- 業者カテゴリドロップダウン
- 設計担当者・IC担当者・外構担当者選択
- メールテンプレート選択（3箇所）
- 業者選択ドロップダウン（2箇所）
- 一括担当者変更モーダル

#### パフォーマンス改善
- N+1問題を解決：案件表示時の大量並列リクエストをバッチ処理化
- 同時リクエストを5件ずつに制限してAPIレート制限を回避

---

## v4.16.0 (2025-12-14)

### FC（フランチャイズ）管理機能

#### データベース
- `fc_organizations`テーブル追加（FC組織管理）
- `fc_staff`テーブル追加（FC所属スタッフ管理）
- SQLマイグレーションファイル: `archideck/sql/production/fc_management.sql`

#### 管理画面
- 設定 > 🏪 FC管理タブを追加
- FC一覧表示（名前、スラッグ、専用URL、ステータス）
- FC追加/編集モーダル
- ワンクリックでFC専用URLをコピー
- FC削除機能

#### FC専用URL発行
- `/fc/{slug}/` 形式のホワイトラベルURL
- FC組織ごとにカスタマイズ可能:
  - 組織名
  - ロゴURL
  - プライマリカラー
  - 連絡先情報

#### FC専用モード
- FC URLアクセス時に自動でFCモード適用
- FC組織のカスタム設定（ロゴ、色）を自動反映
- 管理者機能を非表示化
- 「Gハウス」ブランディングを自動削除

---

## v4.15.0 (2025-12-14)

### セキュリティ強化

#### XSS対策追加
- 業者一覧（会社名、担当者、TEL、Email）
- 商品一覧（商品名）
- タスク一覧（タスク名、業者名）
- カテゴリフィルター（カテゴリ名）
- メール作成画面（業者情報）
- プロジェクトタスク（タスク名、顧客名）

### コード品質改善

#### safeJsonParse関数追加
- localStorageからのJSON読み込み時のクラッシュ防止
- 適用箇所:
  - お気に入り（FavoritesManager）
  - フィルタープリセット（FilterPresets）
  - リマインダー（DeadlineManager）
  - テンプレート（TemplateManager）
  - バックアップ履歴
  - 外構タスク設定

#### 暗黙的event変数の修正
- `setCategoryFilter()`関数で暗黙的なevent変数使用を修正
- イベント引数を明示的に渡すよう変更

#### alert()をshowToast()に統一
- 業者読み込みエラーメッセージをtoast表示に変更

---

## v4.14.0 (2025-12-14)

### 機能削除

#### ダークモード削除
- ダークモード機能を完全削除（使用不可のため）
  - ヘッダーのトグルボタン削除
  - キーボードショートカット（Ctrl+D）削除
  - ヘルプメニューから削除
  - 全ダークモードCSS（約300行）削除
  - 関連JavaScript関数削除

### 二重クリック防止

#### SaveGuardユーティリティ追加
- 保存処理の二重実行を防止する`SaveGuard`ヘルパーを追加
- 適用箇所:
  - `saveProject()` - 案件保存
  - `saveVendorV2()` - 業者保存
  - `executeApplicationGo()` - 申請GO実行

### デバッグ機能

#### 申請GO条件ログ
- `canPressApplicationGo()`にコンソールログを追加
  - 各条件（太陽光、給排水、換気、サッシ）の状態を表示
  - 問題診断を容易に

---

## v4.13.0 (2025-12-14)

### セキュリティ改善

#### XSS対策
- `escapeHtml()`関数を以下の箇所に適用:
  - プロジェクトカード（顧客名、担当者、IC担当、外構担当、メモ）
  - カレンダービュー（顧客名、担当者）
  - 期限設定モーダル（顧客名）
  - ガントチャート（顧客名）
  - 週報・月報（顧客名、担当者名）

### UI/UX改善

#### モーダルのキーボードナビゲーション
- `ModalManager`ユーティリティを追加
  - Escapeキーでモーダルを閉じる
  - モーダル表示時に最初の入力欄にフォーカス
  - モーダルを閉じた時に元の位置にフォーカス復帰
- 対応モーダル: プロジェクト編集、メール作成、スタッフ管理、業者、テンプレート、タスク一覧、申請GO

#### 週報・月報のダークモード対応
- 以下の要素にダークモードスタイルを追加:
  - `.report-card` - 背景色を暗い青に
  - `.report-header h2` - 文字色を明るく
  - `.report-period` - 背景と文字色を調整
  - `.report-stat-item` - 背景色を暗く
  - `.report-section-title` - 文字色を明るく
  - `.report-list-item` - 背景色を暗く
  - `.report-project-name` - 文字色を明るく
  - `.report-designer-count` - 背景と文字色を調整

### バグ修正

#### 申請GOの条件チェック
- `executeApplicationGo()`で実行前に`canPressApplicationGo()`を再チェック
- 条件が満たされていない場合はエラーメッセージを表示して処理を中断
- 問題: 一度条件を満たすとその後条件を外しても進められていた

#### 完了済みセクションの表示
- オーバーライドされた`renderSidebar`関数に完了済みセクションが欠けていた問題を修正
- 「全案件」の直下に「✓ 完了済」セクションを追加

#### 議事録アップロードエラー
- 問題: ファイル名に日本語・スペースが含まれているとSupabase Storageが400エラーを返していた
- 修正: ストレージパスをASCII文字のみに変更（`{timestamp}_{日付}.{拡張子}`）
- DBには元の日本語ファイル名（`日付_案件名_担当者.pdf`）を保存

### パフォーマンス改善

#### メモリリーク修正
- `URL.revokeObjectURL()`を以下の関数に追加:
  - `downloadLocalBackup()` - バックアップダウンロード後
  - `createBackup()` - 自動バックアップ後
  - CSVエクスポート機能 - ダウンロード後

#### DOM描画タイミング調整
- カード描画後のタスク読み込み遅延を50ms→100msに調整
- DOM描画の完了を確実に待つように改善

---

## v4.12.0 (2025-12-14)

### UI/UX改善

#### 業務内容の改善
- タスクの期限入力を削除（シンプル化）
- 0回目打合せにステータス追加（-・実施済）
- ステータス変更時に画面がリセットされる問題を修正
  - カード単位で再描画（セクションの開閉状態を保持）

#### 要対応案件機能の削除
- alertSummary（🚨 要対応案件）セクションを削除
- 不要なアラート機能を整理

#### スタッフ管理の改善
- スタッフ追加時にサイドバーが即座に更新されるように修正
- スタッフ管理画面に外構担当を表示
- スタッフ編集機能を追加（名前変更・メールアドレス変更・カテゴリ変更）
- 名前変更時に関連案件の担当者名も自動更新

#### ダークモードの改善
- 全コンポーネントでCSS変数を使用するように修正
- ハードコードされた背景色を変数化
- サイドバー、フォーム入力、テーブルのコントラスト改善
- 分析画面（KPIカード、パフォーマンステーブル、レポート）のダークモード対応
- data-tableスタイルを追加

#### 自動レポート機能の改善
- 週報・月報をHTMLカード形式に刷新
- 統計グリッドで主要KPIを視覚的に表示
- 進捗バッジでプロジェクト状況を色分け表示
- ダークモード対応のレポートスタイル追加
- 担当者ごとにグループ化表示
  - 各案件のタスクステータス（太陽光、給排水、換気、サッシ等）を表示
  - 更新のあった案件にバッジ表示（週報: 📝 今週更新 / 月報: 今月更新）
  - 担当者名と案件数をヘッダーに表示

#### 申請Go機能の刷新
- 条件達成時のみクリック可能なボタンに変更
  - 条件: 太陽光(営業共有済)、給排水(保存済)、換気(保存済)、サッシ(保存済)
- フルワイドの目立つデザインに変更（🚀アイコン、矢印アニメーション）
- 確認モーダルで条件チェック状況を表示
- クリックで案件を「完了済」に移動

#### 完了済BOX機能
- サイドバーに「✓ 完了済」セクションを追加
- 完了済案件の一覧表示
- チェックボックスを外すと担当者に復元
- 復元時は自動で担当者タブに切り替え

### パフォーマンス・品質改善

#### コンソール出力の制御
- DEBUG_MODEフラグによる出力制御を導入
- console.log/warn/error を全て制御関数に置換（171+箇所）
- 本番環境ではコンソール出力を完全に抑制

#### エラーハンドリングの統一
- 詳細なエラーメッセージ表示
- PostgreSQLエラーコード別のユーザーフレンドリーなメッセージ

### データベース修正
- project_tasks テーブルのRLS無効化SQL追加
  - タスク追加時の権限エラー（42501）を解決

### コード品質改善

#### ハードコード色のCSS変数化
- インラインスタイルの色指定をCSS変数に統一
- 完了済セクション、外構担当などの色を変数化

#### カード警告表示の削除
- 「間取確定が未完了」「申請GOが未完了」などの警告バッジを削除
- カード表示をシンプル化

#### キーボードショートカット改善
- Escキーでモーダルを閉じる処理を修正（.showクラス対応）

---

## v4.11.0 (2025-12-14)

### 大型機能追加

#### クイック編集 (QuickEdit)
- 担当者名をクリックで直接変更可能
- ドロップダウンメニューから担当者を選択
- モーダルを開かずに素早く変更

#### 期限・リマインダー (DeadlineManager)
- 案件ごとに期限を設定可能
- 期限バッジをカードに表示（色で状態を識別）
- 期限3日前から自動でリマインダー通知
- 期限超過時は警告表示

#### カレンダービュー (CalendarView)
- 新しい「📅 カレンダー」タブ
- 月間カレンダー形式で案件を表示
- 期限が設定された案件を日付にマッピング
- 日付クリックで案件一覧をポップアップ表示

#### プロジェクトテンプレート (TemplateManager)
- 案件の設定をテンプレートとして保存
- 新規/既存案件にテンプレートを適用
- テンプレート管理画面で一覧・削除
- 商品仕様と進捗設定をテンプレート化

#### モバイルスワイプ操作 (MobileGestures)
- 右スワイプ: お気に入り登録/解除
- 左スワイプ: 完了済みに変更（進捗100%時のみ）
- スワイプ中の視覚的フィードバック

---

## v4.10.0 (2025-12-14)

### フィルタープリセット機能

#### FilterPresets
- 現在のフィルター条件を名前付きで保存
- ワンクリックで保存済みプリセットを適用
- 保存される条件:
  - 担当者タブ
  - ステータスフィルター（アクティブ/完了済み/お気に入り）
  - 検索キーワード
  - 商品仕様フィルター
- プリセット削除機能
- localStorage保存（ブラウザ間で永続化）

#### UI
- ツールバーに「📋 プリセット」ドロップダウン追加
- プリセット一覧にフィルター内容の概要を表示
- 「+ 保存」ボタンで現在の条件を保存

---

## v4.9.0 (2025-12-14)

### お気に入り＆バッチ操作

#### FavoritesManager
- 案件をお気に入りに登録/解除
- ★マークで視覚的に識別
- お気に入りは常にリスト先頭に表示
- 「★ お気に入り」フィルターで絞り込み
- localStorage保存（ブラウザ間で永続化）

#### BatchOperations
- 複数案件の一括選択
- 「☑ 全選択」ボタン
- 選択ツールバー（画面下部に固定表示）
- 一括完了（アーカイブ）
- 一括担当者変更

#### UI/UX
- お気に入りカードは黄色ボーダーでハイライト
- 選択カードは青枠でハイライト
- 各カードにチェックボックスと★ボタン追加

---

## v4.8.0 (2025-12-14)

### データインポート＆セッション管理

#### DataImporter
- CSV/JSONファイルからの案件インポート
- ファイル選択時のプレビュー表示
- 重複チェック（スキップオプション）
- エクスポートしたファイルの再取り込み対応

#### SessionManager
- 60分間操作なしでタイムアウト
- 残り5分で警告表示
- 「セッションを延長」ボタン
- 自動ログアウト

#### UI改善
- ツールバーに「📥 取込」ボタン追加
- 「📤 出力」ボタンでエクスポート

---

## v4.7.0 (2025-12-14)

### Undo/Redo機能追加

#### UndoManager実装
- 操作履歴スタック（最大50操作）
- タスク完了/未完了の取り消し
- 期限設定の取り消し
- 状態変更の取り消し
- Redo（やり直し）対応

#### キーボードショートカット
- `Ctrl/Cmd + Z`: 元に戻す
- `Ctrl/Cmd + Shift + Z`: やり直す
- `Ctrl/Cmd + Y`: やり直す（Windows標準）

#### UI
- ヘッダーにUndo/Redoボタン追加（↩️/↪️）
- 操作がない時は無効化表示
- ツールチップで最後の操作を表示
- トースト通知で操作内容を表示

---

## v4.6.0 (2025-12-14)

### 大幅UX/アクセシビリティ改善

#### ダークモード
- システムテーマ自動検出
- ヘッダーにトグルボタン追加（🌙/☀️）
- localStorage永続化
- 全CSS変数のダークテーマ対応
- 滑らかな切り替えトランジション

#### キーボードショートカット
- `Ctrl/Cmd + N`: 新規案件作成
- `Ctrl/Cmd + S`: データ同期
- `Ctrl/Cmd + D`: ダークモード切替
- `Ctrl/Cmd + K`: 検索フォーカス
- `Escape`: モーダル/サイドバーを閉じる
- `Shift + ?`: ショートカットヘルプ表示

#### アクセシビリティ（WCAG準拠）
- スキップリンク追加（メインコンテンツへジャンプ）
- ARIA属性追加（role, aria-label）
- スクリーンリーダー用ライブリージョン
- フォーカス表示の強化（3pxアウトライン）
- 高コントラストモード対応（prefers-contrast: high）
- 動き軽減モード対応（prefers-reduced-motion）
- `announceToScreenReader()`関数追加

#### 印刷スタイル
- 印刷用CSS最適化
- 不要UI要素の非表示化
- 案件カードのpage-break対応
- A4サイズ最適化

#### パフォーマンス最適化
- `debounce()`関数追加（検索入力250ms遅延）
- `throttle()`関数追加
- `memoize()`関数追加（TTL付きキャッシュ）
- `requestIdleCallback`ポリフィル
- 検索入力にデバウンス適用

#### ブラウザ通知システム
- `NotificationSystem`オブジェクト追加
- 通知許可リクエスト機能
- 期限間近タスク通知
- 通知音（WebAudio API）
- 通知音ON/OFF設定

#### エクスポート機能強化
- `ExportManager`オブジェクト追加
- エクスポートモーダル追加
- CSV/JSON/印刷用レポートの3形式対応
- タスク詳細含む/含まないの選択
- アクティブ案件のみフィルタ
- 印刷用レポート（新ウィンドウで開く）

---

## v4.5.0 (2025-12-14)

### 包括的品質改善

#### メール送信機能強化
- Gmail、Outlook両対応
- メール内容コピー機能追加
- 送信履歴ログ機能（将来実装用準備）
- XSS対策適用（業者名・連絡先のエスケープ）

#### セキュリティ強化
- `escapeHtml()`を全ユーザー入力に適用
- メールモーダル内のXSS脆弱性修正
- `Validators`オブジェクト追加（メール、パスワード、電話番号、日付検証）

#### エラーハンドリング改善
- `ErrorHandler`オブジェクト追加
- Supabaseエラーコードの日本語変換
- ユーザーフレンドリーなエラーメッセージ表示
- 統一されたエラーログ機能

#### モバイル対応強化
- タッチターゲット44px以上に拡大
- iOS zoom防止（font-size: 16px）
- モーダル全画面化
- 超小画面（360px以下）対応
- タッチデバイスのホバー無効化
- スケルトンローディングCSS追加

#### データ検証
- 過去日付チェック（タスク期限設定時に警告）
- メールアドレス形式検証
- パスワード強度検証（8文字以上、英数字混在）
- 電話番号形式検証

#### FC管理API本実装
- Supabaseで組織作成
- サブスクリプション自動作成
- 管理者ユーザー作成
- organization_members登録

#### スケルトンローディング
- `showSkeletonLoading()`関数追加
- カード、リスト、テーブル3種類のスケルトン
- シマーアニメーション

---

## v4.4.0 (2025-12-14)

### FC（フランチャイズ）管理機能

#### FC管理画面（本部専用）
- 管理者ダッシュボードに「FC管理」セクション追加
- FC一覧：全FCの一覧表示、検索、ステータス管理
- FC新規作成：FCの登録フォーム、専用URL自動生成
- FCデータ閲覧：FCごとのデータ閲覧（サマリー、案件、スタッフ、タスク進捗）

#### FC一覧機能
- KPIカード（FC総数、アクティブFC、FC総案件数、今月新規FC）
- FC検索（名前、スラッグ、メールで検索）
- 専用URLのコピー機能
- FCステータス切り替え（アクティブ/停止）

#### FC新規作成機能
- FC名、URLスラッグ、管理者メール、電話番号の入力
- 専用URLの自動生成・プレビュー
- 初期パスワードの自動生成
- プラン選択（スターター/プロフェッショナル/エンタープライズ）
- 作成完了時に情報サマリーを表示

#### FCデータ閲覧機能
- FC選択プルダウン
- データ種別切り替え（サマリー/案件一覧/スタッフ一覧/タスク進捗）
- FC情報詳細表示
- CSVエクスポート機能

#### FC展開方針
- パターンB（FC別URL）を採用
- 各FCに専用URLを発行（例：https://archideck.vercel.app/fc/sample-fc/）
- FCはGハウス本部がデータを閲覧できることを認識しない設計

#### FC向けホワイトラベル版
- `/fc/` ディレクトリにFC専用エントリーポイント作成
- URLパラメータ（`?fc=slug`）またはlocalStorageでFCモード検出
- FCモード時の自動UI調整:
  - 「Gハウス」ブランディング非表示
  - タイトルを「設計業務管理システム」に変更
  - 管理者ボタン・カテゴリ切り替えを非表示
  - ヘッダーロゴを「ArchiDeck」に統一
- `detectFCMode()`: FCモード自動検出
- `applyFCMode()`: FCモードUI適用
- `exitFCMode()`: FCモード解除

---

## v4.3.0 (2025-12-14)

### 安定性向上 & 機能整理

#### キャッシュ問題修正
- Service Workerキャッシュをv2に更新
- ページ読み込み時の自動キャッシュクリア機能追加
- ヘッダーにデバッグボタン追加（🔄リロード、🔍デバッグ情報）
- バージョン番号にタイムスタンプを付与してキャッシュ破棄

#### 設定画面の再構成
- 「タスク管理」を「業務管理」に変更
- 「設計業務管理」と「IC業務管理」を別タブに分離
- 「外構業務管理」タブを新規追加
- 外構タスクのカスタマイズ機能（ステータスオプション編集可能）

#### 自動バックアップ機能
- 5分ごとの自動ローカルバックアップ
- トグルスイッチでON/OFF切り替え可能
- LocalStorage使用（5MB制限内）
- 最終バックアップ日時表示

#### バグ修正
- デモモードのnullエラー修正（currentUser?.email対応）
- Service Worker/manifestの404エラー修正（絶対パスに変更）
- 案件・スタッフが表示されない問題を解消

#### サイドバー色分け機能完全実装
- 設計担当・IC担当・外構担当の全セクションで色分け対応
- 4件以下: 青色（通常）
- 5件以上: 黄色（注意）
- 7件以上: 名前が赤色 + カウント黄色（警告）

#### 分析ダッシュボード（完全実装確認済み）
- KPIカード（総案件数、完了済み、要注意案件、平均進捗率）
- AI予測分析（遅延リスク予測、推奨アクション）
- ガントチャート（月表示、前月/次月ナビゲーション）
- 担当者別パフォーマンス表
- 自動レポート生成（週報/月報）
- CSVエクスポート
- 分析画面の縦スクロール改善

#### タスク期限・遅延通知機能（新機能）
- 各タスクに期限日を設定可能
- 遅延タスクは赤色背景で強調表示
- 期限間近（3日以内）は黄色で警告
- 遅延日数をバッジで表示（「○日遅延」「本日期限」「あと○日」）
- アラートサマリーに遅延タスク数を表示

#### パスワード機能強化
- ログイン画面に「パスワードを忘れた方」リンク追加
- Supabase resetPasswordForEmail APIでメール再設定対応
- スタッフ自身でパスワード再発行可能

#### 物件名の視認性向上
- 案件カードの物件名に淡いブルー背景を追加
- ホバー時に背景色が変化

#### 用語の統一
- システム全体で「設計士」→「スタッフ」に統一
- コンソールログ、エラーメッセージも統一

---

## v4.2.0 (2025-12-13)

### プレミアムUI & FC展開対応

#### UIデザイン全面刷新
- プレミアムカラーパレット（Deep Ocean Blue + Emerald Green）
- 洗練されたシャドウとトランジション効果
- グローバルスクロールバースタイリング
- アニメーションユーティリティクラス追加
- プロジェクトカードのホバーエフェクト改善

#### FC向けノーコードカスタマイズ
- 設定画面に「カスタマイズ」タブ追加
- 会社名・ロゴURL設定
- メインカラー/アクセントカラー設定（カラーピッカー）
- リアルタイムプレビュー機能
- 組織別ホワイトラベル適用

#### 議事録機能強化
- 複数ファイル保存対応
- ファイル一覧表示
- 個別削除機能
- ファイルサイズ表示

#### kintone連携
- CSVインポート機能
- CSVエクスポート機能
- フィールドマッピング設定

#### バックアップ機能
- 全データJSONエクスポート
- JSONからの復元機能
- 復元前の注意事項表示

#### 品質向上
- 案件カード初期状態：全セクション閉じた状態
- 不要ページ削除（landing.html, signup.html）
- CSSの整理・最適化

---

## v4.1.0 (2025-12-13)

### UX改善 - 販売レベルへの品質向上

#### 案件カード改善
- 5部構成の順番を変更（タスク→メモ→議事録→引継書→業務内容）
- 業務内容は初期表示で開いた状態、他は閉じた状態
- ドラッグ&ドロップで議事録ファイルをアップロード可能に

#### モバイル対応強化
- スマートフォン・タブレットでの操作性向上
- タッチ操作に最適化されたボタンサイズ
- 横スクロール可能なタブナビゲーション
- レスポンシブなフォーム入力

#### ログイン機能
- 開発中のためパスワード無しログイン機能追加
- デモモードでの動作確認が可能

#### 管理者ダッシュボード
- デモモード追加（アカウントなしで画面確認可能）
- 全ボタン・機能の動作を実装
- 組織の追加・編集・削除機能
- プランの追加・編集機能
- サブスクリプション詳細表示
- 監査ログのCSVエクスポート
- ユーザードロップダウンメニュー

#### 外構依頼
- ステータス名を簡略化（「ヒアリングシート＋3DSデータ：UP済」→「UP済」）

---

## v4.0.0 (2025-12-13)

### SaaS版マルチテナント対応 - 100社販売に向けて

#### 新規ページ
- **ランディングページ** (`landing.html`): 新規顧客向けの営業ページ
- **会社登録ページ** (`signup.html`): 3ステップのサインアップフロー
- **管理者ダッシュボード** (`admin/index.html`): スーパーアドミン用管理画面

#### マルチテナント対応
- 組織（会社）テーブル追加
- サブスクリプション管理テーブル追加
- 組織メンバー管理
- RLSポリシーによるデータ分離
- 招待トークンによるユーザー招待機能

#### 料金プラン
| プラン | 月額 | ユーザー | 案件 |
|-------|------|---------|------|
| スターター | ¥9,800 | 5名 | 100件 |
| プロフェッショナル | ¥19,800 | 15名 | 500件 |
| エンタープライズ | ¥49,800 | 50名 | 無制限 |

#### ホワイトラベル対応
- 会社ロゴのカスタマイズ
- プライマリカラー・セカンダリカラーの変更
- タイトル・ファビコンのカスタマイズ
- カスタムドメイン対応（エンタープライズプラン）

#### 管理者ダッシュボード機能
- KPIダッシュボード（総組織数、アクティブユーザー、月間売上）
- 組織管理（追加・編集・検索）
- サブスクリプション管理
- プラン設定
- 監査ログ

#### SQLマイグレーション
```sql
-- 新規テーブル
organizations          -- 組織情報
subscriptions          -- サブスクリプション
plans                  -- プランマスタ
organization_members   -- 組織メンバー
invitations            -- 招待トークン
audit_logs             -- 監査ログ
super_admins           -- スーパーアドミン
usage_stats            -- 使用量統計
```

---

## v3.0.0 (2025-12-13)

### 大規模リニューアル - ArchiDeckへリブランディング

#### システム名変更
- 旧名称: 設計・IC業務管理システム / nandemo
- 新名称: **ArchiDeck** (Gハウス 設計業務管理システム)

#### フォルダ・URL変更
- フォルダ: `sekkei` → `archideck`
- GitHub: `nandemo` → `archideck`
- Vercel: `nandemo` → `archideck`
- 本番URL: `https://archiceck.vercel.app/archideck/index.html`

#### 商品マスタ名称変更
- `LIFEリミ` → `LIFE Limited`
- `LIFE+リミ` → `LIFE+ Limited`

#### タスク定義変更

**削除したタスク:**
- 1回目打合せ、2回目打合せ、3回目打合せ
- 見積、契約、構造図書類、確認済証、図面等納品

**追加したタスク:**
1. 契約書・引継書チェック
2. 現地調査
3. 間取確定
4. 面積チェック
5. チェックリスト
6. 引継書入力
7. 外構依頼
8. 実施図依頼
9. 地盤調査

**名称変更:**
- エボルツ依頼 → evoltz依頼
- サッシプレゼン → サッシ依頼
- 確認申請 → 申請GO
- 換気図面 → 換気図依頼
- 給排水設備図面 → 給排水依頼

**ステータスオプション更新:**
- 構造依頼: ラフチェック / 構造GO / 1回目CB / 2回目CB / 変更契約前会議UP / 確定図をダンドリワークUP
- evoltz依頼: 候補図依頼 / 候補図保存済 / 確定図依頼 / 確定図保存済
- 太陽光依頼: 依頼済 / 保存済 / 営業共有済

#### 新機能

**5部構成カードUI:**
1. 業務内容（タスクチェックボックス）
2. タスク（カスタムタスク追加）
3. メモ欄（IC・外構共有）
4. 議事録（ファイルアップロード）
5. 引継書（内容保存）

**外構担当機能:**
- アカウント選択画面に外構担当追加
- スタッフ管理に外構担当カテゴリ追加
- サイドバーに外構担当セクション追加（緑色アクセント）
- 案件モーダルに外構担当フィールド追加

**サイドバー色分け表示:**
- 4件以下: 青色
- 5件以上: 黄色
- 7件以上: 名前が赤色

**申請GO条件チェック:**
以下の条件を満たさないと押せない:
- 太陽光依頼が「営業共有済」
- 給排水依頼が「保存済」
- 換気図依頼が「保存済」
- サッシ依頼が「保存済」

**担当者タスク一覧:**
- サイドバーの各担当者名横に📋ボタン
- クリックでタスク一覧モーダル表示
- 期限順/邸名順の切り替え可能

**kintone連携設定:**
- ドメイン設定
- アプリID設定
- APIトークン設定
- 接続テスト機能

**議事録アップロード:**
- Supabase Storageへのファイルアップロード
- PDF, Word, Excel対応

**共有メモ・引継書:**
- IC・外構も見られる共有メモ欄
- 引継書の入力・保存機能

#### 新規テーブル（SQL）
1. `project_tasks` - 案件タスク管理
2. `project_minutes` - 議事録管理
3. `notifications` - 通知管理
4. `project_handovers` - 引継書管理
5. `kintone_settings` - kintone連携設定

#### projectsテーブル新カラム
- `exterior_assignee` - 外構担当
- `shared_memo` - 共有メモ
- `kintone_record_id` - kintone連携用
- `layout_confirmed_date` - 間取確定日
- `construction_permit_date` - 着工許可日
- `pre_contract_meeting_date` - 変更契約前会議日

---

## v2.0.0 (2025-11)

### カスタマイズ可能システム

- 業者管理機能
- タスク-業者紐づけ
- メールテンプレート管理
- IC担当機能追加
- アーカイブ機能

---

## v1.0.0 (2025-10)

### 初期リリース

- 案件管理（CRUD）
- 16種類のタスク進捗管理
- 設計士管理
- Supabase認証
