<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2563EB">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ArchiDeck">
<meta name="description" content="菴丞ｮ・ｨｭ險域･ｭ蜍吶ｒ髱ｩ譁ｰ逧・↓蜉ｹ邇・喧縺吶ｋ繧ｿ繧ｹ繧ｯ邂｡逅・す繧ｹ繝・Β">
<link rel="manifest" href="/archideck/manifest.json">
<title>ArchiDeck | G繝上え繧ｹ 險ｭ險域･ｭ蜍咏ｮ｡逅・す繧ｹ繝・Β</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>匠</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232563EB' width='100' height='100' rx='20'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white'>A</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.87.1/dist/umd/supabase.min.js" integrity="sha256-mgB0KFXEH7op01hbCXulq3TZjSqvaCMD35XeKkoTqL8=" crossorigin="anonymous"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  /* Primary - Deep Ocean Blue */
  --primary-color: #2563EB;
  --primary-hover: #1D4ED8;
  --primary-light: #DBEAFE;
  --primary-dark: #1E40AF;

  /* Secondary - Emerald Green */
  --secondary-color: #059669;
  --secondary-hover: #047857;
  --secondary-light: #D1FAE5;

  /* Accent - Violet */
  --accent-color: #7C3AED;
  --accent-light: #EDE9FE;

  /* Status Colors */
  --danger-color: #DC2626;
  --danger-light: #FEE2E2;
  --danger-bg: #FEE2E2;
  --warning-color: #D97706;
  --warning-light: #FEF3C7;
  --warning-bg: #FEF3C7;
  --success-color: #16A34A;
  --success-light: #DCFCE7;
  --success-bg: #DCFCE7;
  --info-color: #0891B2;
  --info-light: #CFFAFE;

  /* Text Colors */
  --text-primary: #0F172A;
  --text-secondary: #475569;
  --text-muted: #94A3B8;
  --text-light: #CBD5E1;

  /* Background Colors */
  --bg-primary: #FFFFFF;
  --bg-secondary: #F8FAFC;
  --bg-tertiary: #F1F5F9;
  --bg-hover: #E2E8F0;

  /* Border Colors */
  --border-color: #E2E8F0;
  --border-light: #F1F5F9;
  --border-focus: #93C5FD;

  /* Shadows - More refined */
  --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -2px rgba(0,0,0,0.04);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.03);
  --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.08), 0 8px 10px -6px rgba(0,0,0,0.03);
  --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,0.15);
  --shadow-inner: inset 0 2px 4px rgba(0,0,0,0.04);
  --shadow-glow: 0 0 20px rgba(37, 99, 235, 0.15);

  /* Border Radius */
  --radius-xs: 4px;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --radius-2xl: 20px;
  --radius-full: 9999px;

  /* Transitions */
  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-normal: 200ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-bounce: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);

  /* Spacing */
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-2xl: 48px;
}

/* 繝繝ｼ繧ｯ繝｢繝ｼ繝・*/
[data-theme="dark"] {
  --primary-color: #60A5FA;
  --primary-hover: #3B82F6;
  --primary-light: #1E3A5F;
  --primary-dark: #93C5FD;

  --secondary-color: #34D399;
  --secondary-hover: #10B981;
  --secondary-light: #064E3B;

  --accent-color: #A78BFA;
  --accent-light: #2E1065;

  --danger-color: #F87171;
  --danger-light: #450A0A;
  --danger-bg: #450A0A;
  --warning-color: #FBBF24;
  --warning-light: #451A03;
  --warning-bg: #451A03;
  --success-color: #4ADE80;
  --success-light: #052E16;
  --success-bg: #052E16;
  --info-color: #22D3EE;
  --info-light: #083344;

  --text-primary: #F1F5F9;
  --text-secondary: #CBD5E1;
  --text-muted: #64748B;
  --text-light: #475569;

  --bg-primary: #0F172A;
  --bg-secondary: #1E293B;
  --bg-tertiary: #334155;
  --bg-hover: #475569;

  --border-color: #334155;
  --border-light: #1E293B;
  --border-focus: #60A5FA;

  --shadow-xs: 0 1px 2px rgba(0,0,0,0.3);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.4), 0 1px 2px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.4), 0 2px 4px -2px rgba(0,0,0,0.3);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.4), 0 4px 6px -4px rgba(0,0,0,0.2);
  --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.4), 0 8px 10px -6px rgba(0,0,0,0.2);
  --shadow-glow: 0 0 20px rgba(96, 165, 250, 0.2);
}


/* data-table 繧ｹ繧ｿ繧､繝ｫ・亥・譫千判髱｢逕ｨ・・*/
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.data-table th,
.data-table td {
  padding: 12px 16px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.data-table th {
  background: var(--bg-secondary);
  font-weight: 600;
  color: var(--text-primary);
}

.data-table td {
  color: var(--text-primary);
}

.data-table tr:hover td {
  background: var(--bg-hover);
}

body {
  font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-secondary);
  color: var(--text-primary);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Global Scrollbar Styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

/* Focus Visible - Accessibility */
:focus-visible {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

/* Selection Styling */
::selection {
  background: var(--primary-light);
  color: var(--primary-dark);
}

/* Utility Classes */
.text-primary { color: var(--text-primary); }
.text-secondary { color: var(--text-secondary); }
.text-muted { color: var(--text-muted); }
.text-success { color: var(--success-color); }
.text-danger { color: var(--danger-color); }
.text-warning { color: var(--warning-color); }

.bg-primary { background: var(--primary-light); }
.bg-success { background: var(--success-light); }
.bg-danger { background: var(--danger-light); }
.bg-warning { background: var(--warning-light); }

.font-medium { font-weight: 500; }
.font-semibold { font-weight: 600; }
.font-bold { font-weight: 700; }

.rounded { border-radius: var(--radius-md); }
.rounded-lg { border-radius: var(--radius-lg); }
.rounded-full { border-radius: var(--radius-full); }

.shadow-sm { box-shadow: var(--shadow-sm); }
.shadow-md { box-shadow: var(--shadow-md); }
.shadow-lg { box-shadow: var(--shadow-lg); }

/* Animation Classes */
.animate-fade-in {
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.animate-slide-up {
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-scale-in {
  animation: scaleIn 0.2s ease-out;
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* 繝ｭ繧ｰ繧､繝ｳ逕ｻ髱｢ - Premium Design */
.login-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--bg-secondary) 0%, #E8F4FE 100%);
  padding: 20px;
  position: relative;
  overflow: hidden;
}

.login-container::before {
  content: '';
  position: absolute;
  width: 600px;
  height: 600px;
  background: radial-gradient(circle, rgba(37, 99, 235, 0.08) 0%, transparent 70%);
  top: -200px;
  right: -200px;
  pointer-events: none;
}

.login-container::after {
  content: '';
  position: absolute;
  width: 400px;
  height: 400px;
  background: radial-gradient(circle, rgba(5, 150, 105, 0.06) 0%, transparent 70%);
  bottom: -100px;
  left: -100px;
  pointer-events: none;
}

.login-card {
  background: var(--bg-primary);
  border: 1px solid rgba(255,255,255,0.8);
  border-radius: var(--radius-2xl);
  padding: 48px;
  box-shadow: var(--shadow-xl), 0 0 40px rgba(37, 99, 235, 0.06);
  max-width: 440px;
  width: 100%;
  text-align: center;
  position: relative;
  z-index: 1;
}

.login-logo {
  width: 64px;
  height: 64px;
  margin: 0 auto 20px;
  background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);
}

.login-card h1 {
  font-size: 26px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
  letter-spacing: -0.02em;
}

.login-card p {
  color: var(--text-secondary);
  margin-bottom: 32px;
  font-size: 14px;
  line-height: 1.5;
}

/* 繝｡繧､繝ｳ繧ｳ繝ｳ繝・リ */
.main-container {
  display: none;
  max-width: 1800px;
  margin: 0 auto;
  background: var(--bg-secondary);
  min-height: 100vh;
}

.main-container.show {
  display: block;
}

/* 繝倥ャ繝繝ｼ - Premium Design */
.header {
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  padding: 0 32px;
  height: 64px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 32px;
}

.sidebar-toggle {
  display: none;
}

.logo {
  font-size: 22px;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
  letter-spacing: -0.02em;
}

.logo-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
}

.logo-text {
  background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* 繝倥ャ繝繝ｼ蜀・リ繝薙ご繝ｼ繧ｷ繝ｧ繝ｳ */
.header-nav {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-left: 16px;
}

.header-nav-btn {
  padding: 8px 14px;
  background: transparent;
  border: none;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  white-space: nowrap;
}

.header-nav-btn:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.header-nav-btn.active {
  background: var(--primary-color);
  color: white;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-action-btn {
  width: 40px;
  height: 40px;
  border: none;
  background: transparent;
  border-radius: var(--radius-md);
  cursor: pointer;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-fast);
}

.header-action-btn:hover {
  background: var(--bg-secondary);
  color: var(--primary-color);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 6px 12px 6px 6px;
  background: var(--bg-secondary);
  border-radius: var(--radius-full);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.user-info:hover {
  background: var(--bg-hover);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  font-weight: 600;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

.user-role {
  font-size: 11px;
  color: var(--text-muted);
}

/* 繧ｫ繝・ざ繝ｪ蛻・ｊ譖ｿ縺医Γ繝九Η繝ｼ */
.category-switch-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  min-width: 180px;
}

.category-switch-menu button {
  display: block;
  width: 100%;
  padding: 12px 16px;
  text-align: left;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-primary);
  transition: background 0.2s;
}

.category-switch-menu button:hover {
  background: var(--bg-secondary);
}

.category-switch-menu button:first-child {
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.category-switch-menu button:last-child {
  border-radius: 0 0 var(--radius-md) var(--radius-md);
}

/* 繧ｿ繝悶リ繝薙ご繝ｼ繧ｷ繝ｧ繝ｳ */
.tabs-nav {
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  padding: 0 32px;
  display: flex;
  gap: 8px;
}

.tab-nav-btn {
  padding: 16px 24px;
  border: none;
  background: transparent;
  font-size: 15px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.tab-nav-btn:hover {
  color: var(--text-primary);
  background: var(--bg-secondary);
}

.tab-nav-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
}

/* 繧ｳ繝ｳ繝・Φ繝・お繝ｪ繧｢ */
.tab-panel {
  display: none;
  flex: 1;
  overflow-y: auto;
}

.tab-panel.active {
  display: flex;
  flex-direction: column;
}

/* 繝・・繝ｫ繝舌・ */
.toolbar {
  background: var(--bg-primary);
  padding: 20px 32px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.toolbar-left {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  flex: 1;
}

.toolbar-right {
  display: flex;
  gap: 12px;
}

/* 繧ｳ繝ｳ繝代け繝医ヤ繝ｼ繝ｫ繝舌・ */
.compact-toolbar {
  padding: 12px 20px;
  flex-direction: column;
  gap: 8px;
}

.toolbar-main {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
}

.toolbar-spacer {
  flex: 1;
}

.select-compact {
  padding: 6px 10px;
  font-size: 12px;
  min-width: auto;
}

.filter-panel {
  width: 100%;
  padding-top: 8px;
  border-top: 1px solid var(--border-light);
}

.filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}

@media (max-width: 768px) {
  .toolbar-main {
    flex-wrap: wrap;
  }
  .filter-row {
    flex-direction: column;
    align-items: stretch;
  }
  .filter-row .select-compact {
    width: 100%;
  }
}

/* 繝・じ繧､繝翫・繧ｿ繝・*/
.designer-tabs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.designer-tab {
  padding: 8px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.designer-tab:hover {
  background: var(--bg-tertiary);
}

.designer-group-label {
  width: 100%;
  padding: 8px 12px;
  margin-top: 12px;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border-radius: 8px;
  border-left: 3px solid var(--primary-color);
}

.designer-tab.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* 繝懊ち繝ｳ - Premium Design */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 11px 22px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-normal);
  white-space: nowrap;
  position: relative;
  overflow: hidden;
  letter-spacing: 0.01em;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.12) 0%, transparent 50%);
  pointer-events: none;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2), 0 1px 2px rgba(37, 99, 235, 0.12);
}

.btn-primary:hover {
  background: var(--primary-hover);
  box-shadow: 0 8px 16px rgba(37, 99, 235, 0.25), 0 3px 6px rgba(37, 99, 235, 0.15);
  transform: translateY(-1px);
}

.btn-primary:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
}

.btn-secondary {
  background: var(--secondary-color);
  color: white;
  box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2);
}

.btn-secondary:hover {
  background: var(--secondary-hover);
  box-shadow: 0 8px 16px rgba(5, 150, 105, 0.25);
  transform: translateY(-1px);
}

.btn-ghost {
  background: transparent;
  border: 1.5px solid var(--border-color);
  color: var(--text-primary);
}

.btn-ghost::before {
  display: none;
}

.btn-ghost:hover {
  background: var(--bg-secondary);
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.btn-outline {
  background: transparent;
  border: 1.5px solid var(--primary-color);
  color: var(--primary-color);
}

.btn-outline::before {
  display: none;
}

.btn-outline:hover {
  background: var(--primary-light);
}

.btn-danger {
  background: var(--danger-color);
  color: white;
  box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
}

.btn-danger:hover {
  background: #B91C1C;
  box-shadow: 0 8px 16px rgba(220, 38, 38, 0.25);
  transform: translateY(-1px);
}

.btn-soft {
  background: var(--primary-light);
  color: var(--primary-color);
  border: none;
}

.btn-soft::before {
  display: none;
}

.btn-soft:hover {
  background: var(--border-focus);
}

.btn-small {
  padding: 7px 14px;
  font-size: 13px;
}

.btn-large {
  padding: 14px 28px;
  font-size: 16px;
}

.btn-icon {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: var(--radius-md);
}

.btn-icon.btn-small {
  width: 32px;
  height: 32px;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* 蜈･蜉帙ヵ繧｣繝ｼ繝ｫ繝・- Premium Design */
.input, .select {
  padding: 11px 16px;
  border: 1.5px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  background: var(--bg-primary);
  transition: all var(--transition-normal);
  color: var(--text-primary);
}

.input:hover, .select:hover {
  border-color: var(--text-muted);
}

.input:focus, .select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  background: #FAFBFF;
}

.input::placeholder {
  color: var(--text-muted);
}

.input {
  min-width: 200px;
}

.input-group {
  position: relative;
}

.input-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  pointer-events: none;
}

.input-group .input {
  padding-left: 42px;
}

/* 繧ｫ繝ｼ繝峨げ繝ｪ繝・ラ */
.cards-container {
  padding: 32px;
}

.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
  gap: 24px;
}

/* 譯井ｻｶ繧ｫ繝ｼ繝・- Premium Design */
.project-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-xl);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: all var(--transition-slow);
  position: relative;
  overflow: hidden;
}

.project-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--secondary-color));
  opacity: 0;
  transition: opacity var(--transition-normal);
}

.project-card:hover {
  box-shadow: var(--shadow-lg), var(--shadow-glow);
  transform: translateY(-2px);
  border-color: transparent;
}

.project-card:hover::before {
  opacity: 1;
}

/* 驕ｸ謚樔ｸｭ繧ｫ繝ｼ繝・*/
.project-card.selected {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px var(--primary-light);
}

/* 繝舌ャ繝・∈謚槭メ繧ｧ繝・け繝懊ャ繧ｯ繧ｹ */
.batch-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
  margin-top: 2px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border-light);
}

.card-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 12px;
  line-height: 1.3;
  letter-spacing: -0.02em;
}

.card-title:hover {
  color: var(--primary-color);
}

/* 迚ｩ莉ｶ蜷阪・閭梧勹繝上う繝ｩ繧､繝・*/
.customer-name {
  background: linear-gradient(135deg, #DBEAFE 0%, #EFF6FF 100%);
  padding: 4px 12px;
  border-radius: 6px;
  color: #1E40AF;
}

.card-title:hover .customer-name {
  background: linear-gradient(135deg, #BFDBFE 0%, #DBEAFE 100%);
}

.card-subtitle {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.card-subtitle::before {
  content: '';
  display: inline-block;
  width: 4px;
  height: 4px;
  background: var(--text-muted);
  border-radius: 50%;
}

/* 繝舌ャ繧ｸ - Premium Design */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  border-radius: var(--radius-full);
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.02em;
  border: none;
}

.badge-primary {
  background: var(--primary-light);
  color: var(--primary-color);
}

.badge-success {
  background: var(--success-light);
  color: var(--success-color);
}

.badge-warning {
  background: var(--warning-light);
  color: var(--warning-color);
}

.badge-danger {
  background: var(--danger-light);
  color: var(--danger-color);
}

.badge-secondary {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
}

.badge-info {
  background: var(--info-light);
  color: var(--info-color);
}

.badge-accent {
  background: var(--accent-light);
  color: var(--accent-color);
}

/* 繝医げ繝ｫ繧ｹ繧､繝・メ */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 26px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.3s;
  border-radius: 26px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: var(--primary-color);
}

input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

/* 繝溘せ繝ｻ貍上ｌ髦ｲ豁｢: 隴ｦ蜻翫ヰ繝・ず */
.project-warnings {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.warning-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  animation: pulse-warning 2s ease-in-out infinite;
}

.warning-badge.warning-danger {
  background: linear-gradient(135deg, #FEE2E2, #FECACA);
  color: #DC2626;
  border: 1px solid #FCA5A5;
}

.warning-badge.warning-warning {
  background: linear-gradient(135deg, #FEF3C7, #FDE68A);
  color: #D97706;
  border: 1px solid #FCD34D;
}

.warning-icon {
  font-size: 14px;
}

@keyframes pulse-warning {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* 繧｢繝ｩ繝ｼ繝医し繝槭Μ繝ｼ */
.alert-summary {
  background: linear-gradient(135deg, #FEF2F2, #FEE2E2);
  border: 2px solid #FCA5A5;
  border-radius: 12px;
  padding: 16px 20px;
  margin-bottom: 20px;
  animation: slide-down 0.3s ease-out;
}

@keyframes slide-down {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.alert-summary-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}

.alert-summary-icon {
  font-size: 20px;
}

.alert-summary-title {
  font-size: 16px;
  font-weight: 700;
  color: #DC2626;
}

.alert-summary-count {
  background: #DC2626;
  color: white;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.alert-summary-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.alert-item {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--bg-primary);
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  color: #991B1B;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid #FECACA;
}

.alert-item:hover {
  background: #FEF2F2;
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15);
}

/* 繧ｫ繝ｼ繝峨ワ繧､繝ｩ繧､繝・*/
.project-card.highlight-card {
  animation: highlight-pulse 0.5s ease-out 3;
  box-shadow: 0 0 0 3px var(--primary-color), var(--shadow-lg);
}

@keyframes highlight-pulse {
  0%, 100% { box-shadow: 0 0 0 3px var(--primary-color), var(--shadow-lg); }
  50% { box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.3), var(--shadow-lg); }
}

.badge-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
}

/* 讌ｭ閠・き繝ｼ繝・*/
.vendor-card {
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.vendor-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
  border-color: var(--primary-color);
}

.vendor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--bg-secondary);
}

.vendor-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.vendor-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
  font-size: 14px;
  color: var(--text-secondary);
}

.vendor-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* 邨ｱ險医ム繝・す繝･繝懊・繝・*/
.stats-dashboard {
  background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-color);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 16px;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: var(--bg-primary);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-color);
  transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.stat-card.stat-warning {
  border-color: var(--warning-color);
  background: var(--warning-light);
}

.stat-icon {
  font-size: 28px;
}

.stat-content {
  display: flex;
  flex-direction: column;
}

.stat-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1.2;
}

.stat-label {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 2px;
}

.stats-toggle-btn {
  margin-top: 12px;
  padding: 6px 12px;
  background: transparent;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 12px;
  color: var(--text-muted);
  transition: all 0.2s;
}

.stats-toggle-btn:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

/* 譛滄剞蛻・ｌ繝ｻ譛滄剞髢楢ｿ代・繧ｫ繝ｼ繝峨せ繧ｿ繧､繝ｫ */
.project-card.overdue {
  border-left: 4px solid var(--danger-color);
  background: linear-gradient(90deg, var(--danger-light) 0%, var(--bg-primary) 8%);
  animation: overdueGlow 2s ease-in-out infinite;
}

.project-card.due-soon {
  border-left: 4px solid var(--warning-color);
  background: linear-gradient(90deg, var(--warning-light) 0%, var(--bg-primary) 8%);
}

@keyframes overdueGlow {
  0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
  50% { box-shadow: 0 0 8px 2px rgba(220, 38, 38, 0.3); }
}

/* 繝峨Λ繝・げ&繝峨Ο繝・・繧ｹ繧ｿ繧､繝ｫ */
.project-card.dragging {
  opacity: 0.5;
  transform: scale(1.02);
  box-shadow: var(--shadow-xl);
  cursor: grabbing;
}

.project-card.drag-over {
  border: 2px dashed var(--primary-color);
  background: var(--primary-light);
}

.project-card[draggable="true"] {
  cursor: grab;
}

.project-card[draggable="true"]:active {
  cursor: grabbing;
}

/* 繝輔Ο繝ｼ繝・ぅ繝ｳ繧ｰ繧｢繧ｯ繧ｷ繝ｧ繝ｳ繝懊ち繝ｳ */
.fab-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 1000;
}

.fab-button {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  border: none;
  box-shadow: var(--shadow-lg);
  cursor: pointer;
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-normal);
}

.fab-button:hover {
  background: var(--primary-hover);
  transform: scale(1.1);
  box-shadow: var(--shadow-xl);
}

.fab-button.active {
  transform: rotate(45deg);
}

.fab-menu {
  position: absolute;
  bottom: 70px;
  right: 0;
  display: none;
  flex-direction: column;
  gap: 8px;
}

.fab-menu.show {
  display: flex;
}

.fab-menu-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  cursor: pointer;
  white-space: nowrap;
  font-size: 14px;
  color: var(--text-primary);
  transition: all var(--transition-fast);
  animation: fabItemIn 0.2s ease-out forwards;
  opacity: 0;
  transform: translateX(20px);
}

.fab-menu-item:nth-child(1) { animation-delay: 0ms; }
.fab-menu-item:nth-child(2) { animation-delay: 50ms; }
.fab-menu-item:nth-child(3) { animation-delay: 100ms; }
.fab-menu-item:nth-child(4) { animation-delay: 150ms; }
.fab-menu-item:nth-child(5) { animation-delay: 200ms; }

@keyframes fabItemIn {
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.fab-menu-item:hover {
  background: var(--bg-secondary);
  transform: translateX(-4px);
}

.fab-menu-item span.icon {
  font-size: 18px;
}

/* 蠑ｷ蛹悶ヤ繝ｼ繝ｫ繝√ャ繝・*/
[data-tooltip] {
  position: relative;
}

[data-tooltip]::before,
[data-tooltip]::after {
  position: absolute;
  visibility: hidden;
  opacity: 0;
  transition: all 0.2s ease;
  pointer-events: none;
  z-index: 1000;
}

[data-tooltip]::before {
  content: attr(data-tooltip);
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%) translateY(4px);
  padding: 8px 12px;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  font-size: 12px;
  white-space: nowrap;
  max-width: 250px;
  text-overflow: ellipsis;
  overflow: hidden;
}

[data-tooltip]::after {
  content: '';
  bottom: calc(100% + 2px);
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: var(--bg-tertiary);
}

[data-tooltip]:hover::before,
[data-tooltip]:hover::after {
  visibility: visible;
  opacity: 1;
}

[data-tooltip]:hover::before {
  transform: translateX(-50%) translateY(0);
}

/* 荳句髄縺阪ヤ繝ｼ繝ｫ繝√ャ繝・*/
[data-tooltip-pos="bottom"]::before {
  bottom: auto;
  top: calc(100% + 8px);
  transform: translateX(-50%) translateY(-4px);
}

[data-tooltip-pos="bottom"]::after {
  bottom: auto;
  top: calc(100% + 2px);
  border-top-color: transparent;
  border-bottom-color: var(--bg-tertiary);
}

[data-tooltip-pos="bottom"]:hover::before {
  transform: translateX(-50%) translateY(0);
}

/* 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ繧ｹ繝斐リ繝ｼ */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--border-color);
  border-top-color: var(--primary-color);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

.loading-spinner.large {
  width: 40px;
  height: 40px;
  border-width: 3px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s ease;
}

.loading-overlay.show {
  opacity: 1;
  visibility: visible;
}

.loading-card {
  background: var(--bg-primary);
  padding: 32px 48px;
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-2xl);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

.loading-text {
  font-size: 14px;
  color: var(--text-secondary);
}

/* 繧ｹ繧ｱ繝ｫ繝医Φ繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ */
.skeleton {
  background: linear-gradient(90deg, var(--bg-tertiary) 0%, var(--bg-hover) 50%, var(--bg-tertiary) 100%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s ease-in-out infinite;
  border-radius: var(--radius-sm);
}

@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.skeleton-card {
  height: 200px;
  border-radius: var(--radius-lg);
}

.skeleton-text {
  height: 16px;
  width: 60%;
}

.skeleton-text.short {
  width: 30%;
}

/* 繧ｭ繝ｼ繝懊・繝峨リ繝薙ご繝ｼ繧ｷ繝ｧ繝ｳ */
.project-card.keyboard-focused {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
  box-shadow: var(--shadow-glow);
}

.project-card.keyboard-focused .card-header {
  background: var(--primary-light);
}

/* 繧ｫ繝・ざ繝ｪ繝輔ぅ繝ｫ繧ｿ繝ｼ */
.category-filter-btn {
  padding: 8px 16px;
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
}

.category-filter-btn:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  background: var(--bg-secondary);
}

.category-filter-btn.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* 繝√ぉ繝・け繝懊ャ繧ｯ繧ｹ繝ｩ繝吶Ν */
.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
}

.checkbox-label input[type="checkbox"] {
  cursor: pointer;
  width: 18px;
  height: 18px;
}

.checkbox-label span {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

/* 騾ｲ謐励ヰ繝ｼ - Premium Design */
.progress-section {
  margin-bottom: 20px;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.progress-label {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
}

.progress-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--primary-color);
  display: flex;
  align-items: baseline;
  gap: 2px;
}

.progress-value-unit {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-muted);
}

.progress-bar {
  height: 8px;
  background: var(--bg-hover);
  border-radius: var(--radius-full);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: var(--radius-full);
  position: relative;
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
  animation: shimmer 2s ease-in-out infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.progress-fill.complete {
  background: var(--success-color);
}

/* 繧ｿ繧ｹ繧ｯ繝ｪ繧ｹ繝・- Premium Design */
.tasks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 8px;
  margin-bottom: 16px;
}

.task-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 12px;
  background: var(--bg-primary);
  border-radius: 8px;
  font-size: 13px;
  transition: all 0.15s ease;
  border: 1px solid var(--border-light);
  min-height: 40px;
}

.task-item:hover {
  background: var(--bg-secondary);
  border-color: var(--border-color);
}

/* 繧ｿ繧ｹ繧ｯ譛滄剞繝ｻ驕・ｻｶ陦ｨ遉ｺ */
.task-item.overdue {
  border-left: 3px solid var(--danger-color);
  background: #FEF2F2;
}

.task-item.due-soon {
  border-left: 3px solid var(--warning-color);
  background: #FFFBEB;
}

.task-due-date {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
  margin-left: auto;
  white-space: nowrap;
}

.task-due-date.overdue {
  background: var(--danger-light);
  color: var(--danger-color);
  font-weight: 600;
}

.task-due-date.due-soon {
  background: var(--warning-light);
  color: #92400E;
}

.task-due-date.normal {
  background: var(--bg-tertiary);
  color: var(--text-muted);
}

.task-due-input {
  width: 110px;
  padding: 4px 8px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 12px;
  flex-shrink: 0;
}

.task-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
  border-radius: var(--radius-xs);
}

.task-state-select {
  height: 32px;
  padding: 0 10px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  background: var(--bg-primary);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--transition-fast);
  min-width: 90px;
  flex-shrink: 0;
}

.task-state-select:hover {
  border-color: var(--primary-color);
}

.task-state-select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
}

.task-state-select.state-yellow {
  background: var(--warning-light);
  border-color: #F59E0B;
  color: #92400E;
}

.task-state-select.state-blue {
  background: var(--primary-light);
  border-color: #3B82F6;
  color: #1E40AF;
}

/* 繧ｹ繝・・繧ｿ繧ｹ繧ｫ繝ｼ繝蛾∈謚橸ｼ医・繝ｫ繝繧ｦ繝ｳ莉｣譖ｿ・・- Unified Design */
.status-cards {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  flex: 1;
  justify-content: flex-end;
  align-items: center;
}

.status-card {
  padding: 4px 8px;
  font-size: 11px;
  border-radius: 4px;
  border: 1px solid transparent;
  background: #F1F5F9;
  color: #64748B;
  cursor: pointer;
  transition: all 0.12s ease;
  white-space: nowrap;
  line-height: 1;
  font-weight: 500;
  min-width: 32px;
  text-align: center;
}

.status-card:hover {
  background: #E2E8F0;
  color: #475569;
}

.status-card.active {
  background: #E2E8F0;
  border-color: #94A3B8;
  color: #334155;
  font-weight: 600;
}

.status-card.active.state-yellow {
  background: #FEF3C7;
  border-color: #F59E0B;
  color: #92400E;
}

.status-card.active.state-blue {
  background: #DBEAFE;
  border-color: #3B82F6;
  color: #1E40AF;
}

.status-card.active.state-red {
  background: #FEE2E2;
  border-color: #EF4444;
  color: #991B1B;
}

/* IC蝗槭き繝ｼ繝会ｼ・蝗樒岼縲・蝗樒岼・・*/
.ic-round-cards {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 8px;
}

.ic-round-card {
  padding: 6px 14px;
  border-radius: 6px;
  border: 2px solid var(--border-color);
  background: var(--bg-secondary);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 12px;
  font-weight: 600;
  min-width: 60px;
  text-align: center;
}

.ic-round-card:hover {
  border-color: var(--primary-color);
  transform: translateY(-1px);
}

.ic-round-card.active {
  border-color: var(--primary-color);
  box-shadow: 0 2px 8px rgba(74, 144, 226, 0.2);
}

.ic-round-card.state-gray {
  background: #F3F4F6;
  border-color: #D1D5DB;
  color: #6B7280;
}

.ic-round-card.state-blue {
  background: var(--primary-light);
  border-color: #3B82F6;
  color: #1E40AF;
}

.ic-round-card.state-yellow {
  background: var(--warning-light);
  border-color: #F59E0B;
  color: #92400E;
}

.ic-round-card.state-red {
  background: #FEE2E2;
  border-color: #EF4444;
  color: #991B1B;
}

.ic-round-content {
  display: none;
  padding: 10px;
  background: var(--bg-tertiary);
  border-radius: 6px;
  margin-top: 6px;
  border: 1px solid var(--border-light);
}

.ic-round-content.active {
  display: block;
}

.ic-round-content .task-item {
  background: var(--bg-primary);
  margin-bottom: 6px;
}

.ic-round-content .task-item:last-child {
  margin-bottom: 0;
}

.task-label {
  min-width: 100px;
  max-width: 140px;
  color: #374151;
  font-weight: 500;
  font-size: 12px;
  flex-shrink: 0;
  line-height: 1.3;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.task-email-btn {
  width: 26px;
  height: 26px;
  padding: 0;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.15s;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 4px;
}

.task-email-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(74, 144, 226, 0.3);
}

/* 萓晞ｼ譌･繝舌ャ繧ｸ */
.request-date-badge {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 3px;
  background: #F0F9FF;
  color: #0284C7;
  white-space: nowrap;
  cursor: help;
  flex-shrink: 0;
  font-weight: 500;
}

/* 繧ｿ繧ｹ繧ｯ繝｡繝｢蜈･蜉・*/
.task-memo-input {
  width: 100px;
  font-size: 11px;
  padding: 4px 8px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background: var(--bg-primary);
  flex-shrink: 0;
}

.task-memo-input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
}

/* 讌ｭ蜍吝・螳ｹ繧ｫ繧ｦ繝ｳ繝医ヰ繝・ず - 邨ｱ荳繧ｹ繧ｿ繧､繝ｫ */
.biz-task-count {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-left: 8px;
  min-width: 20px;
  height: 20px;
  padding: 0 6px;
  border-radius: var(--radius-full);
  font-size: 11px;
  font-weight: 600;
  background: var(--primary-color);
  color: white;
}

.biz-task-count.incomplete {
  background: var(--warning-color);
  color: white;
}

.biz-task-count.complete {
  background: var(--success-color);
  color: white;
}

/* 譯井ｻｶ繧ｫ繝ｼ繝峨ヵ繝・ち繝ｼ */
.project-card-footer {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.project-card-footer .update-time {
  font-size: 13px;
  color: var(--text-muted);
}

/* 遨ｺ繧ｿ繧ｹ繧ｯ繝｡繝・そ繝ｼ繧ｸ */
.empty-task-message {
  color: var(--text-muted);
  font-size: 13px;
  margin: 0;
}

/* 逕ｳ隲季o繧ｳ繝ｳ繝・リ・医ヵ繝ｫ繝ｯ繧､繝会ｼ・*/
.application-go-container {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 16px 24px;
  border-radius: 12px;
  margin-top: 8px;
  transition: all 0.3s ease;
}

.application-go-icon {
  font-size: 24px;
}

.application-go-text {
  font-size: 16px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.application-go-arrow {
  font-size: 20px;
  font-weight: 700;
  animation: pulse-arrow 1.5s infinite;
}

@keyframes pulse-arrow {
  0%, 100% { opacity: 1; transform: translateX(0); }
  50% { opacity: 0.6; transform: translateX(4px); }
}

.application-go-status {
  font-size: 12px;
  padding: 4px 12px;
  background: rgba(0,0,0,0.1);
  border-radius: 12px;
}

/* 譚｡莉ｶ驕疲・譎ゑｼ壹け繝ｪ繝・け蜿ｯ閭ｽ */
.application-go-ready {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
}

.application-go-ready:hover {
  background: linear-gradient(135deg, #059669, #047857);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
}

/* 螳御ｺ・ｸ医∩ */
.application-go-completed {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}

.application-go-completed .application-go-icon {
  background: white;
  color: #10b981;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
}

/* 譚｡莉ｶ譛ｪ驕・*/
.application-go-disabled {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 2px dashed var(--border-color);
}

.application-go-disabled .application-go-icon {
  opacity: 0.5;
}

/* 逕ｳ隲季o 繝｢繝舌う繝ｫ蟇ｾ蠢・*/
@media (max-width: 768px) {
  .application-go-container {
    padding: 14px 16px;
    gap: 10px;
  }

  .application-go-icon {
    font-size: 20px;
  }

  .application-go-text {
    font-size: 14px;
  }

  .application-go-arrow {
    font-size: 16px;
  }
}

.template-select-btn {
  width: 100%;
  padding: 16px;
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}

.template-select-btn:hover {
  border-color: var(--primary-color);
  background: var(--bg-secondary);
  transform: translateX(4px);
}

/* 繝｢繝ｼ繝繝ｫ - Premium Design */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.6);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(8px);
  padding: 20px;
}

.modal.show {
  display: flex;
  animation: modalBgFadeIn 0.2s ease-out;
}

@keyframes modalBgFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: var(--bg-primary);
  border-radius: var(--radius-2xl);
  width: min(800px, 100%);
  max-height: calc(100vh - 40px);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-2xl), 0 0 60px rgba(0, 0, 0, 0.15);
  animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-24px) scale(0.96);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  padding: 24px 28px;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg-primary);
  flex-shrink: 0;
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.02em;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.modal-title-icon {
  width: 36px;
  height: 36px;
  background: var(--primary-light);
  color: var(--primary-color);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

.close {
  width: 36px;
  height: 36px;
  border: none;
  background: var(--bg-secondary);
  color: var(--text-secondary);
  font-size: 20px;
  cursor: pointer;
  border-radius: var(--radius-md);
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
}

.close:hover {
  background: var(--danger-light);
  color: var(--danger-color);
}

.modal-body {
  padding: 28px;
  overflow-y: auto;
  flex: 1;
}

.modal-body::-webkit-scrollbar {
  width: 6px;
}

.modal-body::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 3px;
}

.modal-footer {
  padding: 20px 28px;
  border-top: 1px solid var(--border-light);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  background: var(--bg-secondary);
  flex-shrink: 0;
}

/* 繝輔か繝ｼ繝 - Premium Design */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.form-label-required {
  color: var(--danger-color);
  font-size: 12px;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 12px 16px;
  border: 1.5px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  transition: all var(--transition-fast);
  background: var(--bg-primary);
  color: var(--text-primary);
}

.form-input:hover, .form-select:hover, .form-textarea:hover {
  border-color: var(--text-muted);
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  background: #FAFBFF;
}

.form-input::placeholder {
  color: var(--text-muted);
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
  line-height: 1.5;
}

.form-hint {
  margin-top: 6px;
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 4px;
}

.state-options-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.state-option-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.state-option-item input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
}

.state-option-item .btn-remove {
  padding: 4px 8px;
  background: var(--danger);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.state-option-item .btn-remove:hover {
  opacity: 0.8;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.form-divider {
  height: 1px;
  background: var(--border-light);
  margin: 24px 0;
}

.form-section-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* 繧ｹ繝・・繧ｿ繧ｹ繧､繝ｳ繧ｸ繧ｱ繝ｼ繧ｿ繝ｼ */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 600;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.status-saving {
  background: #FFF4E6;
  color: var(--warning-color);
}

.status-saving .status-dot {
  background: var(--warning-color);
  animation: pulse 1.5s infinite;
}

.status-saved {
  background: #E6F9F0;
  color: var(--success-color);
}

.status-saved .status-dot {
  background: var(--success-color);
}

.status-error {
  background: #FFE6E6;
  color: var(--danger-color);
}

.status-error .status-dot {
  background: var(--danger-color);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* 繝・・繝悶Ν */
.table-container {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table thead {
  background: linear-gradient(180deg, #f8f9fa, #f0f1f3);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
}

.table th {
  padding: 18px 20px;
  text-align: left;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table td {
  padding: 16px 20px;
  border-top: 1px solid var(--border-color);
  font-size: 14px;
  color: var(--text-primary);
}

.table tbody tr:nth-child(even) {
  background: #fafbfc;
}

.table tbody tr:hover {
  background: #f0f7ff;
  box-shadow: inset 0 0 0 1px rgba(74, 144, 226, 0.1);
  transition: all 0.2s;
}

/* 遨ｺ迥ｶ諷・*/
.empty-state {
  padding: 80px 40px;
  text-align: center;
  color: var(--text-secondary);
}

.empty-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.empty-description {
  font-size: 14px;
  margin-bottom: 24px;
}

/* 繝｡繝ｼ繝ｫ蜃ｺ蜉・*/
.email-output {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: 20px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.8;
  white-space: pre-wrap;
  margin: 16px 0;
  max-height: 400px;
  overflow-y: auto;
}

/* 繝峨Λ繝・げ&繝峨Ο繝・・ */
.minutes-upload-area.drag-over {
  background: var(--bg-tertiary);
  border-color: var(--primary-color);
  transform: scale(1.02);
}

/* 繝ｬ繧ｹ繝昴Φ繧ｷ繝・*/
@media (max-width: 1200px) {
  .cards-grid {
    grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
  }
}

@media (max-width: 768px) {
  .header {
    padding: 12px 16px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .header-left {
    gap: 8px;
    flex-wrap: wrap;
  }

  .logo {
    font-size: 18px;
  }

  .header-nav {
    gap: 2px;
    margin-left: 0;
    order: 3;
    width: 100%;
    justify-content: center;
    margin-top: 4px;
  }

  .header-nav-btn {
    padding: 6px 10px;
    font-size: 12px;
  }

  .tabs-nav {
    padding: 0 12px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .tab-nav-btn {
    padding: 12px 16px;
    font-size: 14px;
    white-space: nowrap;
  }

  .toolbar {
    padding: 12px 16px;
    flex-direction: column;
    align-items: stretch;
  }

  .toolbar-left {
    flex-direction: column;
  }

  .toolbar-right {
    justify-content: center;
  }

  .cards-container {
    padding: 12px;
  }

  .cards-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .project-card {
    padding: 16px;
  }

  .card-header {
    flex-direction: column;
    gap: 12px;
  }

  .card-title {
    font-size: 18px;
    flex-wrap: wrap;
  }

  .tasks-grid {
    grid-template-columns: 1fr;
  }

  .task-item {
    flex-wrap: wrap;
    gap: 8px;
  }

  .task-state-select {
    width: 100%;
    margin-top: 4px;
  }

  .modal-content {
    width: 95vw;
    max-height: 90vh;
  }

  .modal-body {
    padding: 16px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-input, .form-select, .select {
    font-size: 16px;
    padding: 12px;
  }

  .btn {
    padding: 12px 16px;
    font-size: 14px;
    min-height: 44px;
  }

  .btn-small {
    padding: 10px 14px;
    min-height: 40px;
  }

  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 1000;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    width: 280px;
  }

  .sidebar.open {
    transform: translateX(0);
  }

  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
  }

  .sidebar-overlay.show {
    display: block;
  }

  .sidebar-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: none;
    background: var(--primary-color);
    color: white;
    border-radius: 8px;
    font-size: 20px;
    cursor: pointer;
    margin-right: 8px;
  }

  .add-task-form {
    flex-direction: column;
  }

  .add-task-form input {
    width: 100%;
  }

  .designer-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 8px;
  }

  .designer-tab {
    flex-shrink: 0;
  }
}

@media (max-width: 480px) {
  .login-card {
    padding: 24px 20px;
  }

  .login-card h1 {
    font-size: 24px;
  }

  .header-right {
    gap: 8px;
  }

  .user-info {
    padding: 6px 10px;
    font-size: 13px;
  }

  .badge {
    padding: 4px 8px;
    font-size: 11px;
  }
}

/* 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ繧ｹ繝斐リ繝ｼ */
.spinner {
  border: 3px solid var(--bg-secondary);
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 40px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 繝峨Λ繝・げ&繝峨Ο繝・・ */
.draggable-row {
  cursor: move;
  transition: all 0.2s;
}

.draggable-row:hover {
  background: var(--bg-secondary);
}

.draggable-row.dragging {
  opacity: 0.5;
  background: var(--bg-hover);
}

.draggable-row.drag-over {
  border-top: 3px solid var(--primary-color);
}

.drag-handle {
  cursor: grab;
  color: var(--text-secondary);
  font-size: 18px;
  padding: 0 8px;
  user-select: none;
}

.drag-handle:active {
  cursor: grabbing;
}

/* 繧ｳ繝ｳ繝・く繧ｹ繝医Γ繝九Η繝ｼ */
.context-menu {
  position: fixed;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  min-width: 180px;
  z-index: 10000;
  display: none;
  padding: 8px 0;
}
.context-menu.show { display: block; }
.context-menu-item {
  padding: 10px 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  color: var(--text-primary);
  transition: background 0.15s;
}
.context-menu-item:hover { background: var(--bg-secondary); }
.context-menu-item.danger { color: var(--error-color); }
.context-menu-divider { height: 1px; background: var(--border-color); margin: 4px 0; }

/* 繝医・繧ｹ繝磯夂衍 - Premium Design */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  padding: 16px 20px;
  box-shadow: var(--shadow-xl);
  display: none;
  align-items: center;
  gap: 12px;
  z-index: 2000;
  max-width: 400px;
  border: 1px solid var(--border-color);
}

.toast.show {
  display: flex;
  animation: toastSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes toastSlideIn {
  from {
    transform: translateX(120%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 14px;
}

.toast-success {
  border-left: 4px solid var(--success-color);
}

.toast-success .toast-icon {
  background: var(--success-light);
  color: var(--success-color);
}

.toast-error {
  border-left: 4px solid var(--danger-color);
}

.toast-error .toast-icon {
  background: var(--danger-light);
  color: var(--danger-color);
}

.toast-warning {
  border-left: 4px solid var(--warning-color);
}

.toast-warning .toast-icon {
  background: var(--warning-light);
  color: var(--warning-color);
}

.toast-message {
  font-size: 14px;
  color: var(--text-primary);
  font-weight: 500;
  line-height: 1.4;
}

/* 繧ｵ繧､繝峨ヰ繝ｼ繝ｬ繧､繧｢繧ｦ繝・- Premium Design */
.app-layout {
  display: flex;
  height: calc(100vh - 64px);
  overflow: hidden;
}

.sidebar {
  width: 280px;
  background: linear-gradient(180deg, white 0%, var(--bg-secondary) 100%);
  border-right: 1px solid var(--border-color);
  overflow-y: auto;
  flex-shrink: 0;
}

.sidebar::-webkit-scrollbar {
  width: 6px;
}

.sidebar::-webkit-scrollbar-track {
  background: transparent;
}

.sidebar::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 3px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

.sidebar-header {
  padding: 20px 16px;
  border-bottom: 1px solid var(--border-light);
}

.sidebar-section {
  padding: 16px;
  border-bottom: 1px solid var(--border-light);
}

.sidebar-section:last-child {
  border-bottom: none;
}

.sidebar-section-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 12px;
  padding-left: 4px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--transition-fast);
  margin-bottom: 2px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
}

.sidebar-item:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.sidebar-item.active {
  background: var(--primary-color);
  color: white;
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25);
}

.sidebar-item-label {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-item-icon {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.7;
}

.sidebar-item.active .sidebar-item-icon {
  opacity: 1;
}

/* 繧ｵ繧､繝峨ヰ繝ｼ謨ｰ蟄励ヰ繝・ず - Unified Design */
.sidebar-item-count {
  font-size: 11px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 10px;
  background: #E5E7EB;
  color: #374151;
  min-width: 24px;
  text-align: center;
}

.sidebar-item.active .sidebar-item-count {
  background: rgba(255, 255, 255, 0.25);
  color: white;
}

.sidebar-item-count.warning {
  background: #FEF3C7;
  color: #B45309;
}

.sidebar-item-count.danger {
  background: #FEE2E2;
  color: #DC2626;
}

.sidebar-counts {
  display: flex;
  align-items: center;
  gap: 4px;
}

.sidebar-archived-count {
  font-size: 10px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 8px;
  background: #D1FAE5;
  color: #059669;
  cursor: pointer;
  transition: all 0.15s ease;
}

.sidebar-archived-count:hover {
  background: #059669;
  color: white;
}

.sidebar-item.active .sidebar-archived-count {
  background: rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.9);
}

.sidebar-item.active .sidebar-archived-count:hover {
  background: rgba(255, 255, 255, 0.35);
  color: white;
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* 繧ｵ繝悶ち繝悶リ繝薙ご繝ｼ繧ｷ繝ｧ繝ｳ - Premium Design */
.sub-tabs-nav {
  display: flex;
  gap: 4px;
  padding: 12px 24px 0 24px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  overflow-x: auto;
}

.sub-tabs-nav::-webkit-scrollbar {
  height: 4px;
}

.sub-tabs-nav::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 2px;
}

.sub-tab-btn {
  padding: 12px 20px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  border-bottom: 2px solid transparent;
  transition: all var(--transition-fast);
  white-space: nowrap;
  position: relative;
}

.sub-tab-btn:hover {
  color: var(--primary-color);
  background: var(--primary-light);
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.sub-tab-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
  background: var(--primary-light);
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.sub-tab-panel {
  display: none;
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  max-height: calc(100vh - 180px);
}

.sub-tab-panel.active {
  display: block;
}

/* 險ｭ螳壹き繝ｼ繝峨げ繝ｪ繝・ラ */
.settings-cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
  padding: 24px;
  max-width: 1400px;
  margin: 0 auto;
}

.settings-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.settings-card:hover {
  border-color: var(--primary-color);
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.settings-card-icon {
  font-size: 32px;
  width: 56px;
  height: 56px;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
}

.settings-card-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
}

.settings-card-description {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
}

.settings-back-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  color: var(--text-primary);
  cursor: pointer;
  margin-bottom: 20px;
  transition: all 0.2s;
}

.settings-back-btn:hover {
  background: var(--bg-tertiary);
  border-color: var(--primary-color);
}

.table-container {
  overflow-y: auto;
  max-height: calc(100vh - 350px);
}

.cards-grid {
  overflow-y: auto;
  max-height: calc(100vh - 300px);
}

/* 讌ｭ閠・き繝ｼ繝・*/
.vendor-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.vendor-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
  border-color: var(--primary-color);
}

.vendor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--bg-secondary);
}

.vendor-header h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.vendor-info {
  margin-bottom: 16px;
}

.vendor-info > div {
  padding: 6px 0;
  font-size: 14px;
  color: var(--text-secondary);
}

.vendor-info strong {
  color: var(--text-primary);
  font-weight: 600;
  min-width: 80px;
  display: inline-block;
}

.vendor-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* ===== 繧ｫ繝ｬ繝ｳ繝繝ｼ ===== */
.calendar-container {
  padding: 12px;
  max-width: 100%;
  margin: 0;
  height: calc(100vh - 120px);
  display: flex;
  flex-direction: column;
}

.calendar-header {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 24px;
  margin-bottom: 8px;
  padding: 8px 0;
}

.calendar-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  min-width: 140px;
  text-align: center;
}

.calendar-legend {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 8px;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  color: var(--text-muted);
}

.legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.legend-design { background: #4A90E2; }
.legend-ic { background: #9C27B0; }
.legend-exterior { background: #4CAF50; }
.legend-construction { background: #FF9800; }
.legend-task { background: #F44336; }

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  background: var(--border-color);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  overflow: hidden;
  flex: 1;
}

.calendar-day-header {
  background: var(--bg-tertiary);
  padding: 6px;
  text-align: center;
  font-weight: 600;
  font-size: 12px;
  color: var(--text-muted);
}

.calendar-day {
  background: var(--bg-primary);
  min-height: 80px;
  padding: 4px;
  position: relative;
  transition: background 0.15s;
}

.calendar-day:hover {
  background: var(--bg-secondary);
}

.calendar-day.other-month {
  background: var(--bg-secondary);
  opacity: 0.4;
}

.calendar-day.today {
  background: #E3F2FD;
}

.calendar-day-number {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 2px;
}

.calendar-day.today .calendar-day-number {
  background: var(--primary-color);
  color: white;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
}

.calendar-events {
  display: flex;
  flex-direction: column;
  gap: 1px;
  max-height: calc(100% - 26px);
  overflow-y: auto;
}

.calendar-event {
  font-size: 10px;
  padding: 2px 4px;
  border-radius: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
  border-left: 3px solid;
  background: white;
}

.calendar-event.design { border-color: #1565C0; color: #1565C0; }
.calendar-event.ic { border-color: #7B1FA2; color: #7B1FA2; }
.calendar-event.exterior { border-color: #388E3C; color: #388E3C; }
.calendar-event.construction { border-color: #E65100; color: #E65100; }
.calendar-event.task { border-color: #C62828; color: #C62828; }

.calendar-event:hover {
  background: var(--bg-secondary);
}

/* ===== 蛻・梵繝繝・す繝･繝懊・繝・===== */
.analytics-container {
  padding: 24px;
  max-width: 1400px;
  margin: 0 auto;
}

.analytics-section {
  background: var(--bg-primary);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--border-light);
}

/* 繝ｬ繝昴・繝・*/
.report-buttons {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.report-preview {
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 24px;
}

.report-card {
  background: var(--bg-primary);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  border: 1px solid var(--border-color);
  color: #000000;
}

.report-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--primary);
}

.report-header h2 {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0;
  color: #000000;
}

.report-period {
  font-size: 0.875rem;
  color: #333333;
  background: var(--bg-secondary);
  padding: 4px 12px;
  border-radius: 20px;
}

.report-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.report-stat-item {
  background: var(--bg-secondary);
  padding: 16px;
  border-radius: 10px;
  text-align: center;
}

.report-stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary);
}

.report-stat-label {
  font-size: 0.75rem;
  color: #333333;
  margin-top: 4px;
}

.report-section {
  margin-top: 20px;
}

.report-section-title {
  font-size: 1rem;
  font-weight: 600;
  color: #000000;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.report-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.report-list-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-radius: 8px;
  margin-bottom: 8px;
}

.report-list-item:last-child {
  margin-bottom: 0;
}

.report-project-name {
  font-weight: 500;
  color: #000000;
}

.report-project-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.875rem;
}

.report-progress-badge {
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

.report-progress-badge.high { background: #dcfce7; color: #166534; }
.report-progress-badge.medium { background: #fef9c3; color: #854d0e; }
.report-progress-badge.low { background: #fee2e2; color: #991b1b; }

.report-assignee {
  color: #333333;
}

.report-empty {
  text-align: center;
  padding: 20px;
  color: #333333;
  font-style: italic;
}

/* 諡・ｽ楢・挨繝ｬ繝昴・繝医せ繧ｿ繧､繝ｫ */
.report-designer-section {
  background: var(--bg-primary);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid var(--border-color);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
}

.report-designer-section:last-child {
  margin-bottom: 0;
}

.report-designer-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-bottom: 12px;
  margin-bottom: 12px;
  border-bottom: 1px solid var(--border-color);
}

.report-designer-name {
  font-weight: 600;
  font-size: 1rem;
  color: #000000;
}

.report-designer-count {
  background: #e0e7ff;
  color: #000000;
  font-size: 0.75rem;
  padding: 2px 10px;
  border-radius: 12px;
}

.report-project-detail {
  background: var(--bg-secondary);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  border-left: 3px solid var(--primary);
}

.report-project-detail:last-child {
  margin-bottom: 0;
}

.report-project-detail.updated {
  border-left-color: var(--success-color);
  background: linear-gradient(90deg, rgba(16, 185, 129, 0.05), var(--bg-primary));
}

.report-project-title {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.report-project-title .project-name {
  font-weight: 600;
  color: #000000;
}

.report-updated-badge {
  background: #d1fae5;
  color: #000000;
  font-size: 0.65rem;
  padding: 2px 6px;
  border-radius: 8px;
}

.report-status-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.report-status-tag {
  font-size: 0.75rem;
  padding: 3px 8px;
  border-radius: 6px;
  background: var(--bg-primary);
  color: #000000;
  border: 1px solid var(--border-color);
}

.report-status-tag.active {
  background: #e0e7ff;
  color: #000000;
  border-color: var(--primary);
}

/* ===== ArchiDeck v3.0 譁ｰ讖溯・繧ｹ繧ｿ繧､繝ｫ ===== */

/* 5驛ｨ讒区・繧ｫ繝ｼ繝峨そ繧ｯ繧ｷ繝ｧ繝ｳ - Premium Design */
.card-section {
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  margin-bottom: 12px;
  overflow: hidden;
  background: var(--bg-primary);
  transition: all var(--transition-fast);
}

.card-section:hover {
  border-color: var(--border-color);
}

.card-section:last-child {
  margin-bottom: 0;
}

.card-section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  background: var(--bg-secondary);
  cursor: pointer;
  user-select: none;
  transition: all var(--transition-fast);
  border-bottom: 1px solid transparent;
}

.card-section-header:hover {
  background: var(--bg-tertiary);
}

.card-section:not(.collapsed) .card-section-header {
  border-bottom-color: var(--border-light);
}

.card-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-section-icon {
  width: 28px;
  height: 28px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  background: var(--primary-light);
  color: var(--primary-color);
}

.card-section:nth-child(2) .card-section-icon {
  background: var(--accent-light);
  color: var(--accent-color);
}

.card-section:nth-child(3) .card-section-icon {
  background: var(--warning-light);
  color: var(--warning-color);
}

.card-section:nth-child(4) .card-section-icon {
  background: var(--info-light);
  color: var(--info-color);
}

.card-section:nth-child(5) .card-section-icon {
  background: var(--success-light);
  color: var(--success-color);
}

.card-section-toggle {
  font-size: 10px;
  color: var(--text-muted);
  transition: transform var(--transition-fast);
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-sm);
}

.card-section-header:hover .card-section-toggle {
  background: var(--bg-hover);
}

.card-section.collapsed .card-section-toggle {
  transform: rotate(-90deg);
}

.card-section-content {
  padding: 18px;
  display: block;
  background: var(--bg-primary);
}

.card-section.collapsed .card-section-content {
  display: none;
}

/* 讓ｪ荳ｦ縺ｳ3繧ｫ繝ｩ繝繝ｬ繧､繧｢繧ｦ繝茨ｼ医ち繧ｹ繧ｯ繝ｻ繝｡繝｢繝ｻ隴ｰ莠矩鹸・・*/
.card-sections-row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 12px;
}

.card-sections-row .card-section {
  margin-bottom: 0;
}

/* 繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ繧ｿ繧､繝医Ν蜀・・繝舌ャ繧ｸ */
.section-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px;
  height: 20px;
  padding: 0 6px;
  border-radius: var(--radius-full);
  font-size: 11px;
  font-weight: 600;
  margin-left: 8px;
}

.section-badge.badge-primary {
  background: var(--primary-color);
  color: white;
}

.section-badge.badge-warning {
  background: var(--warning-color);
  color: white;
}

.section-badge.badge-success {
  background: var(--success-color);
  color: white;
}

.section-badge.badge-info {
  background: var(--info-color);
  color: white;
}

.section-badge.badge-muted {
  background: var(--bg-tertiary);
  color: var(--text-muted);
}

@media (max-width: 768px) {
  .card-sections-row {
    grid-template-columns: 1fr;
  }
  .card-quick-actions {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* 繧ｯ繧､繝・け繧｢繧ｯ繧ｷ繝ｧ繝ｳ繝懊ち繝ｳ・・繧ｫ繝ｩ繝讓ｪ荳ｦ縺ｳ・・*/
.card-quick-actions {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-bottom: 12px;
}

.quick-action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  font-size: 12px;
  font-weight: 500;
  color: var(--text-primary);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.quick-action-btn:hover {
  background: var(--bg-tertiary);
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.quick-action-btn .section-badge {
  font-size: 10px;
  min-width: 16px;
  height: 16px;
  padding: 0 4px;
}

/* 繧ｫ繝ｼ繝峨Δ繝ｼ繝繝ｫ */
.card-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 20px;
}

.card-modal {
  background: var(--bg-primary);
  border-radius: var(--radius-xl);
  width: 100%;
  max-width: 600px;
  max-height: 80vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-2xl);
}

.card-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-light);
  background: var(--bg-secondary);
}

.card-modal-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
}

.card-modal-close {
  background: none;
  border: none;
  font-size: 20px;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: var(--radius-sm);
}

.card-modal-close:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

.card-modal-body {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}

/* 繧ｿ繧ｹ繧ｯ讖溯・ */
.project-task-list {
  margin-top: 12px;
}

.project-task-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  transition: all 0.2s;
}

.project-task-item.completed {
  opacity: 0.5;
  background: #f5f5f5;
}

.project-task-item.completed .project-task-name {
  text-decoration: line-through;
  color: var(--text-muted);
}

.project-task-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
}

.project-task-name {
  flex: 1;
  font-size: 14px;
}

.project-task-due {
  font-size: 12px;
  color: var(--text-muted);
  padding: 2px 8px;
  background: var(--bg-tertiary);
  border-radius: 12px;
}

.project-task-due.overdue {
  background: #ffe5e5;
  color: var(--danger-color);
}

.add-task-form {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.add-task-form input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 13px;
}

/* 蜈ｱ譛峨Γ繝｢谺・*/
.shared-memo-area {
  width: 100%;
  min-height: 80px;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 14px;
  resize: vertical;
  font-family: inherit;
}

/* 隴ｰ莠矩鹸繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ */
.minutes-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.minutes-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
}

.minutes-item-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.minutes-upload-area {
  border: 2px dashed var(--border-color);
  border-radius: var(--radius-md);
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.minutes-upload-area:hover {
  border-color: var(--primary-color);
  background: #f8fbff;
}

/* 蠑慕ｶ呎嶌繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ */
.handover-content {
  width: 100%;
  min-height: 120px;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 14px;
  resize: vertical;
  font-family: inherit;
}

/* 蠑慕ｶ呎嶌 驛ｨ鄂ｲ蛻･蜈･蜉帙・繝・け繧ｹ */
.handover-sections {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.handover-section {
  border: 1px solid var(--border-color);
  border-radius: 8px;
  overflow: hidden;
}

.handover-label {
  display: block;
  padding: 8px 12px;
  background: var(--bg-tertiary);
  font-weight: 600;
  font-size: 13px;
  color: var(--text-primary);
  border-bottom: 1px solid var(--border-color);
}

.handover-textarea {
  width: 100%;
  padding: 10px 12px;
  border: none;
  font-size: 13px;
  font-family: inherit;
  resize: vertical;
  min-height: 60px;
}

.handover-textarea:focus {
  outline: none;
  background: var(--bg-secondary);
}

/* 繧ｵ繧､繝峨ヰ繝ｼ諡・ｽ楢・牡蛻・￠ */
.sidebar-item-count.count-blue {
  background: #e3f2fd;
  color: #1976d2;
}

.sidebar-item-count.count-yellow {
  background: #fff8e1;
  color: #f57c00;
}

.sidebar-item-label.name-red {
  color: #d32f2f;
  font-weight: 700;
}

/* 繧ｿ繧ｹ繧ｯ荳隕ｧ繝懊ち繝ｳ */
.sidebar-task-btn {
  padding: 4px 8px;
  font-size: 11px;
  background: var(--bg-tertiary);
  border: none;
  border-radius: 12px;
  cursor: pointer;
  margin-left: 8px;
}

.sidebar-task-btn:hover {
  background: var(--primary-color);
  color: white;
}

/* 繧ｿ繧ｹ繧ｯ荳隕ｧ繝｢繝ｼ繝繝ｫ */
.task-list-modal {
  max-height: 70vh;
  overflow-y: auto;
}

.task-list-group {
  margin-bottom: 24px;
}

.task-list-group-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-color);
}

/* 逕ｳ隲季O繝懊ち繝ｳ辟｡蜉ｹ蛹・*/
.task-item-btn.disabled {
  opacity: 0.4;
  cursor: not-allowed;
  pointer-events: none;
}

.task-item-btn.disabled:hover {
  transform: none;
}

/* kintone騾｣謳ｺ陦ｨ遉ｺ */
.kintone-info {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.kintone-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: #e8f5e9;
  color: #2e7d32;
  border-radius: 12px;
  font-size: 12px;
}

/* 騾夂衍繝舌ャ繧ｸ */
.notification-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--danger-color);
  color: white;
  font-size: 10px;
  font-weight: 700;
  min-width: 18px;
  height: 18px;
  border-radius: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
}


/* ============================================
   繧ｹ繧ｱ繝ｫ繝医Φ繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ
   ============================================ */
.skeleton-line,
.skeleton-circle {
  background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-hover) 50%, var(--bg-tertiary) 75%);
  background-size: 200% 100%;
  animation: skeleton-shimmer 1.5s infinite;
  border-radius: 4px;
}

.skeleton-circle {
  border-radius: 50%;
}

@keyframes skeleton-shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.skeleton-card {
  padding: 20px;
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-color);
}

.animate-pulse {
  animation: pulse-opacity 2s ease-in-out infinite;
}

@keyframes pulse-opacity {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ============================================
   繝｢繝舌う繝ｫ霑ｽ蜉謾ｹ蝟・
   ============================================ */
@media (max-width: 768px) {
  /* 繧ｿ繝・メ繧ｿ繝ｼ繧ｲ繝・ヨ譛驕ｩ蛹・*/
  .btn, button, a.btn {
    min-height: 44px;
    min-width: 44px;
  }

  /* 繝輔か繝ｼ繝蜈･蜉帶僑螟ｧ */
  input, select, textarea {
    font-size: 16px !important; /* iOS zoom髦ｲ豁｢ */
  }

  /* 繝｢繝ｼ繝繝ｫ蜈ｨ逕ｻ髱｢蛹・*/
  .modal-content {
    width: 100vw;
    height: 100vh;
    max-height: 100vh;
    border-radius: 0;
    margin: 0;
  }

  .modal {
    padding: 0;
  }

  /* 繧ｫ繝ｼ繝牙・繝懊ち繝ｳ驟咲ｽｮ */
  .card-actions {
    flex-direction: column;
    width: 100%;
  }

  .card-actions .btn {
    width: 100%;
    justify-content: center;
  }

  /* 繝・・繝悶Ν繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* 讀懃ｴ｢繝舌・ */
  .search-box {
    width: 100%;
  }

  /* 繝懊ヨ繝繝翫ン逕ｨ繧ｹ繝壹・繧ｹ */
  .main-content {
    padding-bottom: 80px;
  }

  /* 繧ｿ繧ｹ繧ｯ繧｢繧､繝・Β謾ｹ蝟・*/
  .task-item {
    padding: 12px;
    gap: 8px;
  }

  .task-label {
    font-size: 14px;
    flex: 1;
    min-width: 0;
  }

  .task-state-select {
    font-size: 13px;
    min-width: 100px;
  }

  .task-email-btn {
    min-width: 36px;
    min-height: 36px;
  }

  /* 譌･莉伜・蜉帶隼蝟・*/
  .task-due-input {
    min-width: 130px;
  }

  /* 譛亥ｱ繝｢繝舌う繝ｫ蟇ｾ蠢・*/
  .report-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .report-header h2 {
    font-size: 1.25rem;
  }

  .report-stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .report-stat-value {
    font-size: 1.5rem;
  }

  .report-designer-section {
    padding: 12px;
  }

  .report-designer-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .report-project-title {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }

  .report-project-title .project-name {
    word-break: break-word;
  }

  .report-status-list {
    gap: 4px;
  }

  .report-status-tag {
    font-size: 0.65rem;
    padding: 2px 6px;
  }

  .report-list-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
}

/* 雜・ｰ冗判髱｢蟇ｾ蠢・*/
@media (max-width: 360px) {
  .header {
    padding: 8px 12px;
  }

  .logo {
    font-size: 18px;
  }

  .tab-nav-btn {
    padding: 10px 12px;
    font-size: 13px;
  }

  .project-card {
    padding: 12px;
  }

  .card-title {
    font-size: 16px;
  }
}

/* 繧ｿ繝・メ繝・ヰ繧､繧ｹ蜷代￠繝帙ヰ繝ｼ辟｡蜉ｹ蛹・*/
@media (hover: none) {
  .btn:hover,
  .project-card:hover,
  .task-item:hover {
    transform: none;
    box-shadow: inherit;
  }
}

/* ============================================
   繧｢繧ｯ繧ｻ繧ｷ繝薙Μ繝・ぅ - Accessibility
   ============================================ */

/* 繧ｹ繧ｯ繝ｪ繝ｼ繝ｳ繝ｪ繝ｼ繝繝ｼ蟆ら畑 */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* 繧ｹ繧ｭ繝・・繝ｪ繝ｳ繧ｯ */
.skip-link {
  position: fixed;
  top: -100px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--primary-color);
  color: white;
  padding: 12px 24px;
  border-radius: var(--radius-md);
  z-index: 10001;
  font-weight: 600;
  text-decoration: none;
  transition: top 0.3s ease;
}

.skip-link:focus {
  top: 10px;
  outline: 3px solid var(--warning-color);
  outline-offset: 2px;
}

/* 繝輔か繝ｼ繧ｫ繧ｹ陦ｨ遉ｺ縺ｮ蠑ｷ蛹・*/
:focus-visible {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
}

button:focus-visible,
a:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
  box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
}

/* 鬮倥さ繝ｳ繝医Λ繧ｹ繝医Δ繝ｼ繝牙ｯｾ蠢・*/
@media (prefers-contrast: high) {
  :root {
    --text-primary: #000000;
    --text-secondary: #1a1a1a;
    --border-color: #000000;
  }

  .btn {
    border: 2px solid currentColor;
  }
}

/* 蜍輔″繧呈ｸ帙ｉ縺吶Δ繝ｼ繝・*/
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }

  .loading-spinner {
    animation: none;
    border-color: var(--primary-color);
  }
}

/* ============================================
   蜊ｰ蛻ｷ繧ｹ繧ｿ繧､繝ｫ - Print Styles
   ============================================ */
@media print {
  /* 髱櫁｡ｨ遉ｺ隕∫ｴ */
  .header,
  .sidebar,
  .tabs-nav,
  .btn,
  button,
  .modal-overlay,
  .skip-link,
  .status-indicator,
  .toast-container {
    display: none !important;
  }

  /* 蝓ｺ譛ｬ繧ｹ繧ｿ繧､繝ｫ */
  body {
    background: var(--bg-primary) !important;
    color: black !important;
    font-size: 12pt;
    line-height: 1.4;
  }

  /* 繝｡繧､繝ｳ繧ｳ繝ｳ繝・Φ繝・*/
  .main-container,
  .app-layout,
  .main-content {
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* 繧ｫ繝ｼ繝峨・譯井ｻｶ */
  .project-card {
    break-inside: avoid;
    page-break-inside: avoid;
    border: 1px solid #ccc !important;
    box-shadow: none !important;
    margin-bottom: 16pt !important;
  }

  /* 繧ｿ繧ｹ繧ｯ繝ｪ繧ｹ繝・*/
  .task-item {
    border-bottom: 1px solid #eee;
    padding: 8pt 0;
  }

  /* 繧ｹ繝・・繧ｿ繧ｹ繝舌ャ繧ｸ繧堤區鮟偵〒 */
  .status-badge {
    border: 1px solid black !important;
    background: var(--bg-primary) !important;
    color: black !important;
  }

  /* 繝ｪ繝ｳ繧ｯ縺ｫURL繧定｡ｨ遉ｺ */
  a[href^="http"]:after {
    content: " (" attr(href) ")";
    font-size: 10pt;
    color: #666;
  }

  /* 繝壹・繧ｸ險ｭ螳・*/
  @page {
    margin: 2cm;
    size: A4;
  }

  /* 繝倥ャ繝繝ｼ繝ｻ繝輔ャ繧ｿ繝ｼ */
  .print-header {
    display: block !important;
    text-align: center;
    margin-bottom: 20pt;
    font-size: 18pt;
    font-weight: bold;
  }

  .print-footer {
    display: block !important;
    text-align: center;
    margin-top: 20pt;
    font-size: 10pt;
    color: #666;
  }
}
</style>
</head>
<body>

<!-- 繧ｹ繧ｭ繝・・繝ｪ繝ｳ繧ｯ・医い繧ｯ繧ｻ繧ｷ繝薙Μ繝・ぅ・・-->
<a href="#mainContent" class="skip-link">繝｡繧､繝ｳ繧ｳ繝ｳ繝・Φ繝・∈繧ｹ繧ｭ繝・・</a>

<!-- 繝ｩ繧､繝悶Μ繝ｼ繧ｸ繝ｧ繝ｳ・医せ繧ｯ繝ｪ繝ｼ繝ｳ繝ｪ繝ｼ繝繝ｼ逕ｨ・・-->
<div id="liveRegion" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<!-- 繝ｭ繧ｰ繧､繝ｳ逕ｻ髱｢ -->
<div id="loginContainer" class="login-container">
  <div class="login-card">
    <h1>ArchiDeck</h1>
    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">G繝上え繧ｹ 險ｭ險域･ｭ蜍咏ｮ｡逅・す繧ｹ繝・Β</p>
    <p>繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ縺ｨ繝代せ繝ｯ繝ｼ繝峨〒繝ｭ繧ｰ繧､繝ｳ縺励※縺上□縺輔＞</p>
    <form onsubmit="signIn(); return false;" style="margin-bottom: 20px;">
      <input type="email" class="form-input" id="loginEmail" placeholder="繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ" style="width: 100%; margin-bottom: 12px;" inputmode="email">
      <input type="password" class="form-input" id="loginPassword" placeholder="繝代せ繝ｯ繝ｼ繝・ style="width: 100%; margin-bottom: 12px;">
      <div style="text-align: right; margin-bottom: 16px;">
        <a href="#" onclick="showForgotPassword(); return false;" style="font-size: 13px; color: var(--primary-color);">繝代せ繝ｯ繝ｼ繝峨ｒ蠢倥ｌ縺滓婿</a>
      </div>
      <button type="submit" class="btn btn-primary" style="width: 100%;">繝ｭ繧ｰ繧､繝ｳ</button>
    </form>
    <div id="forgotPasswordSection" style="display: none; margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="font-size: 13px; margin-bottom: 12px;">逋ｻ骭ｲ貂医∩縺ｮ繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ繧貞・蜉帙＠縺ｦ縺上□縺輔＞縲ゅヱ繧ｹ繝ｯ繝ｼ繝牙・險ｭ螳夂畑縺ｮ繝ｪ繝ｳ繧ｯ繧帝∽ｿ｡縺励∪縺吶・/p>
      <input type="email" class="form-input" id="forgotEmail" placeholder="繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ" style="width: 100%; margin-bottom: 12px;">
      <button class="btn btn-primary" style="width: 100%; margin-bottom: 8px;" onclick="sendPasswordReset()">蜀崎ｨｭ螳壹Γ繝ｼ繝ｫ繧帝∽ｿ｡</button>
      <button class="btn btn-ghost" style="width: 100%;" onclick="hideForgotPassword()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
    </div>
  </div>
</div>

<!-- 繝代せ繝ｯ繝ｼ繝芽ｨｭ螳夂判髱｢・亥・蝗槭Ο繧ｰ繧､繝ｳ逕ｨ・・-->
<div id="setPasswordContainer" class="login-container" style="display: none;">
  <div class="login-card">
    <h1>繝代せ繝ｯ繝ｼ繝芽ｨｭ螳・/h1>
    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">ArchiDeck</p>
    <p>譁ｰ縺励＞繝代せ繝ｯ繝ｼ繝峨ｒ險ｭ螳壹＠縺ｦ縺上□縺輔＞</p>
    <form onsubmit="saveNewPassword(); return false;" style="margin-bottom: 20px;">
      <div class="form-group" style="margin-bottom: 16px;">
        <label class="form-label">譁ｰ縺励＞繝代せ繝ｯ繝ｼ繝・/label>
        <input type="password" class="form-input" id="setNewPassword" placeholder="闍ｱ謨ｰ蟄玲ｷｷ蜷・譁・ｭ嶺ｻ･荳・ style="width: 100%;">
      </div>
      <div class="form-group" style="margin-bottom: 16px;">
        <label class="form-label">譁ｰ縺励＞繝代せ繝ｯ繝ｼ繝会ｼ育｢ｺ隱搾ｼ・/label>
        <input type="password" class="form-input" id="setConfirmPassword" placeholder="繧ゅ≧荳蠎ｦ蜈･蜉・ style="width: 100%;">
      </div>
      <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
        窶ｻ 繝代せ繝ｯ繝ｼ繝峨・闍ｱ蟄励→謨ｰ蟄励ｒ蜷ｫ繧8譁・ｭ嶺ｻ･荳翫〒險ｭ螳壹＠縺ｦ縺上□縺輔＞
      </p>
      <button type="submit" class="btn btn-primary" style="width: 100%;">繝代せ繝ｯ繝ｼ繝峨ｒ險ｭ螳・/button>
    </form>
  </div>
</div>

<!-- 繝｡繧､繝ｳ繧｢繝励Μ繧ｱ繝ｼ繧ｷ繝ｧ繝ｳ -->
<div id="mainContainer" class="main-container">
  <!-- 繝倥ャ繝繝ｼ -->
  <header class="header" role="banner" aria-label="繧ｵ繧､繝医・繝・ム繝ｼ">
    <div class="header-left">
      <button class="sidebar-toggle" onclick="toggleSidebar()">笘ｰ</button>
      <div class="logo">ArchiDeck</div>
      <!-- 繝倥ャ繝繝ｼ蜀・リ繝薙ご繝ｼ繧ｷ繝ｧ繝ｳ -->
      <nav class="header-nav">
        <button class="header-nav-btn active" onclick="switchMainTab('projects', this)">搭 譯井ｻｶ邂｡逅・/button>
        <button class="header-nav-btn" onclick="switchMainTab('calendar', this)">套 繧ｫ繝ｬ繝ｳ繝繝ｼ</button>
        <button class="header-nav-btn" onclick="switchMainTab('analytics', this)">投 蛻・梵</button>
        <button class="header-nav-btn" onclick="switchMainTab('settings', this)">笞呻ｸ・險ｭ螳・/button>
      </nav>
    </div>
    <div class="header-right">
      <div class="status-indicator status-saved" id="statusIndicator">
        <span class="status-dot"></span>
        <span id="statusText">菫晏ｭ俶ｸ医∩</span>
      </div>
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="" alt="">
        <span id="userName" class="user-name"></span>
      </div>
      <div style="position: relative;">
        <button class="btn btn-ghost btn-small" onclick="toggleCategorySwitcher()" id="categorySwitchBtn" style="display: none;">
          <span id="currentCategoryLabel">盗 險ｭ險・/span> 笆ｼ
        </button>
        <div id="categorySwitchMenu" class="category-switch-menu" style="display: none;">
          <button onclick="switchCategory('險ｭ險・)">盗 險ｭ險域球蠖・/button>
          <button onclick="switchCategory('IC')">耳 IC諡・ｽ・/button>
          <button onclick="switchCategory('螟匁ｧ・)">元 螟匁ｧ区球蠖・/button>
          <button onclick="switchCategory('荳榊虚逕｣')">匠 荳榊虚逕｣諡・ｽ・/button>
          <button onclick="switchCategory('admin')">荘 邂｡逅・・/button>
        </div>
      </div>
      <button class="btn btn-ghost btn-small" onclick="UndoManager.undo()" title="蜈・↓謌ｻ縺・(Ctrl+Z)" id="undoBtn" disabled>竊ｩ・・/button>
      <button class="btn btn-ghost btn-small" onclick="UndoManager.redo()" title="繧・ｊ逶ｴ縺・(Ctrl+Y)" id="redoBtn" disabled>竊ｪ・・/button>
      <button class="btn btn-ghost btn-small" onclick="forceReloadData()" title="繝・・繧ｿ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ">売</button>
      <button class="btn btn-ghost btn-small" onclick="showDebugInfo()" title="繝・ヰ繝・げ諠・ｱ">剥</button>
      <button class="btn btn-ghost btn-small" onclick="signOut()">繝ｭ繧ｰ繧｢繧ｦ繝・/button>
    </div>
  </header>

  <!-- 繧｢繝励Μ繝ｬ繧､繧｢繧ｦ繝・-->
  <div class="app-layout">
    <!-- 繧ｵ繧､繝峨ヰ繝ｼ繧ｪ繝ｼ繝舌・繝ｬ繧､・医Δ繝舌う繝ｫ逕ｨ・・-->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <!-- 繧ｵ繧､繝峨ヰ繝ｼ -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="繧ｵ繧､繝峨ヰ繝ｼ繝翫ン繧ｲ繝ｼ繧ｷ繝ｧ繝ｳ">
      <div id="sidebarContent"></div>
    </aside>

    <!-- 繝｡繧､繝ｳ繧ｳ繝ｳ繝・Φ繝・-->
    <main class="main-content" id="mainContent" role="main" aria-label="繝｡繧､繝ｳ繧ｳ繝ｳ繝・Φ繝・>
      <!-- 譯井ｻｶ邂｡逅・ち繝・-->
      <div id="projectsTab" class="tab-panel active">
        <div class="toolbar compact-toolbar">
          <div class="toolbar-main">
            <input type="text" class="input" id="searchQuery" placeholder="讀懃ｴ｢... (Ctrl+K)" oninput="debouncedRenderProjects()" onfocus="updateSearchSuggestions()" list="searchSuggestions" aria-label="譯井ｻｶ繧呈､懃ｴ｢" autocomplete="off" style="flex:1;max-width:280px;">
            <datalist id="searchSuggestions"></datalist>
            <select class="select select-compact" id="archiveFilter" onchange="renderProjects()">
              <option value="active">繧｢繧ｯ繝・ぅ繝・/option>
              <option value="all">縺吶∋縺ｦ</option>
              <option value="archived">螳御ｺ・ｸ・/option>
            </select>
            <button class="btn btn-ghost btn-small" onclick="toggleFilterPanel()" id="filterToggleBtn" title="繝輔ぅ繝ｫ繧ｿ繝ｼ螻暮幕">反 邨櫁ｾｼ</button>
            <button class="btn btn-ghost btn-small" onclick="resetAllFilters()" title="繝ｪ繧ｻ繝・ヨ">売</button>
            <div class="toolbar-spacer"></div>
            <button class="btn btn-ghost btn-small" onclick="manualKintoneSync()" title="kintone蜷梧悄" id="kintoneRefreshBtn">売 kintone</button>
            <button class="btn btn-ghost btn-small" onclick="DataImporter.showModal()" title="蜿冶ｾｼ">踏</button>
            <button class="btn btn-ghost btn-small" onclick="exportCSV()" title="蜃ｺ蜉・>豆</button>
            <button class="btn btn-primary btn-small" onclick="openProjectModal()">+ 霑ｽ蜉</button>
          </div>
          <div class="filter-panel" id="filterPanel" style="display:none;">
            <div class="filter-row">
              <select class="select select-compact" id="specFilter" onchange="renderProjects()">
                <option value="">蝠・刀: 縺吶∋縺ｦ</option>
                <option>LIFE</option>
                <option>LIFE+</option>
                <option>HOURS</option>
                <option>LACIE</option>
                <option>LIFE Limited</option>
                <option>LIFE+ Limited</option>
              </select>
              <select class="select select-compact" id="icProgressFilter" onchange="renderProjects()">
                <option value="">IC騾ｲ謐・ 縺吶∋縺ｦ</option>
                <option value="not_started">IC譛ｪ逹謇・/option>
                <option value="in_progress">IC騾ｲ陦御ｸｭ</option>
                <option value="completed">IC螳御ｺ・/option>
                <option value="no_ic">IC諡・ｽ薙↑縺・/option>
              </select>
              <select class="select select-compact" id="sourceFilter" onchange="renderProjects()">
                <option value="">繧ｽ繝ｼ繧ｹ: 縺吶∋縺ｦ</option>
                <option value="kintone">kintone騾｣謳ｺ</option>
                <option value="demo">謇句虚霑ｽ蜉/繝・Δ</option>
              </select>
              <select class="select select-compact" id="icAssigneeFilter" onchange="renderProjects()">
                <option value="">IC諡・ｽ・ 縺吶∋縺ｦ</option>
              </select>
              <select class="select select-compact" id="exteriorAssigneeFilter" onchange="renderProjects()">
                <option value="">螟匁ｧ・ 縺吶∋縺ｦ</option>
              </select>
              <select class="select select-compact" id="realestateAssigneeFilter" onchange="renderProjects()">
                <option value="">荳榊虚逕｣: 縺吶∋縺ｦ</option>
              </select>
              <select class="select select-compact" id="sortOrder" onchange="renderProjects()">
                <option value="custom">繧ｫ繧ｹ繧ｿ繝鬆・/option>
                <option value="updated_desc">譖ｴ譁ｰ譌･竊・/option>
                <option value="updated_asc">譖ｴ譁ｰ譌･竊・/option>
                <option value="progress_desc">騾ｲ謐冷・</option>
                <option value="progress_asc">騾ｲ謐冷・</option>
                <option value="customer_asc">鬘ｧ螳｢蜷喉-Z</option>
                <option value="created_desc">菴懈・譌･竊・/option>
              </select>
              <div style="position: relative;">
                <button class="btn btn-ghost btn-small" onclick="FilterPresets.toggleMenu()" title="繝励Μ繧ｻ繝・ヨ">搭</button>
                <div id="presetMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 280px; z-index: 100;">
                  <div style="padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600; font-size: 14px;">繝輔ぅ繝ｫ繧ｿ繝ｼ繝励Μ繧ｻ繝・ヨ</span>
                    <button class="btn btn-primary btn-small" onclick="FilterPresets.showSaveModal(); document.getElementById('presetMenu').style.display='none';">+ 菫晏ｭ・/button>
                  </div>
                  <div id="presetDropdown" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
              </div>
              <button class="btn btn-ghost btn-small" onclick="BatchOperations.selectAll()" title="蜈ｨ驕ｸ謚・>笘・/button>
            </div>
          </div>
        </div>
    <!-- 邨ｱ險医ム繝・す繝･繝懊・繝・-->
    <div id="statsDashboard" class="stats-dashboard" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">投</div>
          <div class="stat-content">
            <div class="stat-value" id="statTotalProjects">0</div>
            <div class="stat-label">繧｢繧ｯ繝・ぅ繝匁｡井ｻｶ</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">盗</div>
          <div class="stat-content">
            <div class="stat-value" id="statDesignProgress">0%</div>
            <div class="stat-label">蟷ｳ蝮・ｨｭ險磯ｲ謐・/div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">耳</div>
          <div class="stat-content">
            <div class="stat-value" id="statICProgress">0%</div>
            <div class="stat-label">蟷ｳ蝮⑩C騾ｲ謐・/div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">笨・/div>
          <div class="stat-content">
            <div class="stat-value" id="statCompletedThisMonth">0</div>
            <div class="stat-label">莉頑怦螳御ｺ・/div>
          </div>
        </div>
        <div class="stat-card stat-warning" id="statOverdueCard" style="display: none;">
          <div class="stat-icon">笞・・/div>
          <div class="stat-content">
            <div class="stat-value" id="statOverdue">0</div>
            <div class="stat-label">譛滄剞雜・℃</div>
          </div>
        </div>
      </div>
      <button class="stats-toggle-btn" onclick="toggleStatsDashboard()">邨ｱ險医ｒ髱櫁｡ｨ遉ｺ</button>
    </div>
    <div class="cards-container">
      <div class="cards-grid" id="projectsGrid"></div>
      <div class="empty-state" id="emptyProjects" style="display: none;">
        <div class="empty-icon">搭</div>
        <div class="empty-title">譯井ｻｶ縺後≠繧翫∪縺帙ｓ</div>
        <div class="empty-description">縲梧｡井ｻｶ霑ｽ蜉縲阪・繧ｿ繝ｳ縺九ｉ譁ｰ縺励＞譯井ｻｶ繧堤匳骭ｲ縺励※縺上□縺輔＞</div>
        <button class="btn btn-primary" onclick="openProjectModal()">+ 譯井ｻｶ霑ｽ蜉</button>
      </div>
    </div>
  </div>

      <!-- 繧ｫ繝ｬ繝ｳ繝繝ｼ繧ｿ繝・-->
      <div id="calendarTab" class="tab-panel">
        <div class="calendar-container">
          <div class="calendar-header">
            <button class="btn btn-ghost" onclick="navigateCalendar(-1)">笳 蜑肴怦</button>
            <h2 id="calendarTitle" class="calendar-title"></h2>
            <button class="btn btn-ghost" onclick="navigateCalendar(1)">谺｡譛・笆ｶ</button>
          </div>
          <div class="calendar-legend">
            <span class="legend-item"><span class="legend-dot legend-design"></span>險ｭ險・/span>
            <span class="legend-item"><span class="legend-dot legend-ic"></span>IC</span>
            <span class="legend-item"><span class="legend-dot legend-exterior"></span>螟匁ｧ・/span>
            <span class="legend-item"><span class="legend-dot legend-construction"></span>蟾･莠・/span>
            <span class="legend-item"><span class="legend-dot legend-task"></span>繧ｿ繧ｹ繧ｯ</span>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
      </div>

      <!-- 蛻・梵繧ｿ繝・-->
      <div id="analyticsTab" class="tab-panel">
        <div class="analytics-container">
          <!-- 閾ｪ蜍輔Ξ繝昴・繝育函謌・-->
          <div class="analytics-section">
            <h3 class="section-title">統 閾ｪ蜍輔Ξ繝昴・繝育函謌・/h3>
            <div class="report-buttons">
              <button class="btn btn-primary" onclick="generateWeeklyReport()">投 騾ｱ蝣ｱ繧堤函謌・/button>
              <button class="btn btn-ghost" onclick="generateMonthlyReport()">嶋 譛亥ｱ繧堤函謌・/button>
              <button class="btn btn-ghost" onclick="exportAnalyticsCSV()">刀 CSV蜃ｺ蜉・/button>
            </div>
            <div id="reportPreview" class="report-preview" style="display: none;"></div>
          </div>
        </div>
      </div>

      <!-- 險ｭ螳壹ち繝・-->
      <div id="settingsTab" class="tab-panel">
        <!-- 險ｭ螳壹き繝ｼ繝峨げ繝ｪ繝・ラ・医Γ繧､繝ｳ逕ｻ髱｢・・-->
        <div id="settingsCardsView" class="settings-cards-grid">
          <div class="settings-card" onclick="openSettingsPanel('staff')">
            <div class="settings-card-icon">則</div>
            <div class="settings-card-title">諡・ｽ鍋ｮ｡逅・/div>
            <div class="settings-card-description">險ｭ險医・IC繝ｻ螟匁ｧ九・荳榊虚逕｣繝ｻ蟾･莠九・諡・ｽ楢・ｒ邂｡逅・/div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('vendors')">
            <div class="settings-card-icon">召</div>
            <div class="settings-card-title">讌ｭ閠・・繝｡繝ｼ繝ｫ邂｡逅・/div>
            <div class="settings-card-description">讌ｭ閠・ュ蝣ｱ縺ｨ繝｡繝ｼ繝ｫ繝・Φ繝励Ξ繝ｼ繝医ｒ邂｡逅・/div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('categories')">
            <div class="settings-card-icon">捷・・/div>
            <div class="settings-card-title">繧ｫ繝・ざ繝ｪ邂｡逅・/div>
            <div class="settings-card-description">讌ｭ閠・ｒ蛻・｡槭☆繧九き繝・ざ繝ｪ繧堤ｮ｡逅・/div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('tasks')">
            <div class="settings-card-icon">盗</div>
            <div class="settings-card-title">險ｭ險域･ｭ蜍咏ｮ｡逅・/div>
            <div class="settings-card-description">險ｭ險域球蠖楢・・繧ｿ繧ｹ繧ｯ繧堤ｮ｡逅・/div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('icTasks')">
            <div class="settings-card-icon">耳</div>
            <div class="settings-card-title">IC讌ｭ蜍咏ｮ｡逅・/div>
            <div class="settings-card-description">IC諡・ｽ楢・・繧ｿ繧ｹ繧ｯ繧堤ｮ｡逅・/div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('exteriorTasks')">
            <div class="settings-card-icon">元</div>
            <div class="settings-card-title">螟匁ｧ区･ｭ蜍咏ｮ｡逅・/div>
            <div class="settings-card-description">螟匁ｧ区球蠖楢・・繧ｿ繧ｹ繧ｯ繧堤ｮ｡逅・/div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('realestateTasks')">
            <div class="settings-card-icon">召</div>
            <div class="settings-card-title">荳榊虚逕｣讌ｭ蜍咏ｮ｡逅・/div>
            <div class="settings-card-description">荳榊虚逕｣諡・ｽ楢・・繧ｿ繧ｹ繧ｯ繧堤ｮ｡逅・/div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('constructionTasks')">
            <div class="settings-card-icon">畑</div>
            <div class="settings-card-title">蟾･莠区･ｭ蜍咏ｮ｡逅・/div>
            <div class="settings-card-description">蟾･莠区球蠖楢・・繧ｿ繧ｹ繧ｯ繧堤ｮ｡逅・/div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('products')">
            <div class="settings-card-icon">逃</div>
            <div class="settings-card-title">蝠・刀邂｡逅・/div>
            <div class="settings-card-description">譯井ｻｶ縺ｧ驕ｸ謚槭〒縺阪ｋ蝠・刀繧堤ｮ｡逅・/div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('customize')">
            <div class="settings-card-icon">耳</div>
            <div class="settings-card-title">繧ｫ繧ｹ繧ｿ繝槭う繧ｺ</div>
            <div class="settings-card-description">繧ｷ繧ｹ繝・Β縺ｮ螟冶ｦｳ繧偵き繧ｹ繧ｿ繝槭う繧ｺ</div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('kintone')">
            <div class="settings-card-icon">迫</div>
            <div class="settings-card-title">kintone騾｣謳ｺ</div>
            <div class="settings-card-description">kintone縺ｨ縺ｮ繝・・繧ｿ騾｣謳ｺ繧定ｨｭ螳・/div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('backup')">
            <div class="settings-card-icon">沈</div>
            <div class="settings-card-title">繝舌ャ繧ｯ繧｢繝・・</div>
            <div class="settings-card-description">繝・・繧ｿ縺ｮ繝舌ャ繧ｯ繧｢繝・・縺ｨ蠕ｩ蜈・/div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('fcManagement')">
            <div class="settings-card-icon">宵</div>
            <div class="settings-card-title">FC邂｡逅・/div>
            <div class="settings-card-description">繝輔Λ繝ｳ繝√Ε繧､繧ｺ邨・ｹ斐ｒ邂｡逅・/div>
          </div>
          <div class="settings-card" onclick="openSettingsPanel('account')">
            <div class="settings-card-icon">柏</div>
            <div class="settings-card-title">繧｢繧ｫ繧ｦ繝ｳ繝郁ｨｭ螳・/div>
            <div class="settings-card-description">繝代せ繝ｯ繝ｼ繝牙､画峩繝ｻ繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ遒ｺ隱・/div>
          </div>
        </div>

        <!-- 諡・ｽ鍋ｮ｡逅・-->
        <div id="staffPanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div style="max-width: 1000px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">則 諡・ｽ鍋ｮ｡逅・/h2>
            <div class="form-group">
              <label class="form-label">譁ｰ縺励＞諡・ｽ薙ｒ霑ｽ蜉</label>
              <div style="display: grid; grid-template-columns: 1fr 1fr 150px 150px; gap: 12px; align-items: center;">
                <input type="text" class="form-input" id="newDesignerNameInline" placeholder="諡・ｽ灘錐 *">
                <input type="email" class="form-input" id="newDesignerEmailInline" placeholder="繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ *">
                <input type="tel" class="form-input" id="newDesignerPhoneInline" placeholder="謳ｺ蟶ｯ逡ｪ蜿ｷ(11譯・" maxlength="11" pattern="[0-9]{11}" style="width: 150px;">
                <select class="form-select" id="newDesignerDepartmentInline" style="width: 150px;">
                  <option value="">驛ｨ鄂ｲ繧帝∈謚・/option>
                </select>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: center; margin-top: 12px;">
                <select class="form-select" id="newDesignerCategoryInline" style="width: 150px;">
                  <option value="險ｭ險・>險ｭ險域球蠖・/option>
                  <option value="IC">IC諡・ｽ・/option>
                  <option value="螟匁ｧ・>螟匁ｧ区球蠖・/option>
                  <option value="荳榊虚逕｣">荳榊虚逕｣諡・ｽ・/option>
                  <option value="蟾･莠・>蟾･莠区球蠖・/option>
                  <option value="蝟ｶ讌ｭ">蝟ｶ讌ｭ諡・ｽ・/option>
                  <option value="邂｡逅・・>邂｡逅・・/option>
                </select>
                <div></div>
                <button class="btn btn-primary" onclick="addDesignerInline()">霑ｽ蜉</button>
              </div>
              <p style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">窶ｻ 霑ｽ蜉蠕後∵球蠖楢・・繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ螳帙↓繝代せ繝ｯ繝ｼ繝芽ｨｭ螳壹Γ繝ｼ繝ｫ縺瑚・蜍暮∽ｿ｡縺輔ｌ縺ｾ縺・/p>
            </div>

            <!-- 驛ｨ鄂ｲ繝槭せ繧ｿ邂｡逅・-->
            <div style="margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
              <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">驛ｨ鄂ｲ繝槭せ繧ｿ</h3>
              <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;" id="departmentChips"></div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" class="form-input" id="newDepartmentName" placeholder="譁ｰ縺励＞驛ｨ鄂ｲ蜷・ style="width: 200px;">
                <button class="btn btn-ghost" onclick="addDepartment()">+ 霑ｽ蜉</button>
              </div>
            </div>
            <div id="designerListInline" style="margin-top: 24px;"></div>
          </div>
        </div>

        <!-- 讌ｭ閠・ｮ｡逅・-->
        <div id="vendorsPanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <div id="categoryFilters"></div>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openVendorModalV2()">+ 讌ｭ閠・ｿｽ蜉</button>
            </div>
          </div>
          <div id="vendorsGrid" class="cards-grid"></div>
        </div>

        <!-- 繧ｫ繝・ざ繝ｪ邂｡逅・-->
        <div id="categoriesPanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">捷・・讌ｭ閠・き繝・ざ繝ｪ邂｡逅・/h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">讌ｭ閠・ｒ蛻・｡槭☆繧九き繝・ざ繝ｪ繧定ｿｽ蜉繝ｻ邱ｨ髮・・蜑企勁縺ｧ縺阪∪縺吶・/p>
            <div class="form-group">
              <label class="form-label">譁ｰ縺励＞繧ｫ繝・ざ繝ｪ繧定ｿｽ蜉</label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="newCategoryNameInline" placeholder="繧ｫ繝・ざ繝ｪ蜷搾ｼ井ｾ具ｼ夐崕豌怜ｷ･莠具ｼ・ style="flex: 1;">
                <button class="btn btn-primary" onclick="addCategoryInline()">霑ｽ蜉</button>
              </div>
            </div>
            <div id="categoriesGrid" style="margin-top: 32px;"></div>
          </div>
        </div>

        <!-- 險ｭ險域･ｭ蜍咏ｮ｡逅・-->
        <div id="tasksPanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">盗 險ｭ險医ち繧ｹ繧ｯ邂｡逅・/h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openTaskModal('險ｭ險・)">+ 險ｭ險医ち繧ｹ繧ｯ霑ｽ蜉</button>
            </div>
          </div>
          <p style="margin-bottom: 16px; color: var(--text-secondary);">險ｭ險域球蠖楢・′菴ｿ逕ｨ縺吶ｋ繧ｿ繧ｹ繧ｯ繧堤ｮ｡逅・＠縺ｾ縺吶・/p>
          <div id="tasksGrid"></div>
        </div>

        <!-- IC讌ｭ蜍咏ｮ｡逅・-->
        <div id="icTasksPanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">耳 IC繧ｿ繧ｹ繧ｯ邂｡逅・/h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-warning" onclick="runICTasksMigration()" title="21鬆・岼縺ｮIC繧ｿ繧ｹ繧ｯ縺ｫ譖ｴ譁ｰ">売 21鬆・岼縺ｫ譖ｴ譁ｰ</button>
              <button class="btn btn-primary" onclick="openTaskModal('IC')">+ IC繧ｿ繧ｹ繧ｯ霑ｽ蜉</button>
            </div>
          </div>
          <p style="margin-bottom: 16px; color: var(--text-secondary);">IC諡・ｽ楢・′菴ｿ逕ｨ縺吶ｋ繧ｿ繧ｹ繧ｯ繧堤ｮ｡逅・＠縺ｾ縺吶・/p>
          <div id="icMigrationNotice" style="display: none; margin-bottom: 16px; padding: 12px; background: var(--warning-light); border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
            <p style="margin: 0; font-size: 13px; color: var(--warning-color);">
              笞・・<strong>IC繧ｿ繧ｹ繧ｯ縺悟商縺・ｽ｢蠑上〒縺・/strong>: 縲・1鬆・岼縺ｫ譖ｴ譁ｰ縲阪・繧ｿ繝ｳ繧偵け繝ｪ繝・け縺励※縲∵眠縺励＞21鬆・岼縺ｮIC繧ｿ繧ｹ繧ｯ縺ｫ譖ｴ譁ｰ縺励※縺上□縺輔＞縲・
            </p>
          </div>
          <div style="margin-bottom: 16px; padding: 12px; background: var(--primary-light); border-radius: var(--radius-md); border-left: 4px solid var(--primary-color);">
            <p style="margin: 0; font-size: 13px; color: var(--primary-color);">
              庁 <strong>繝｡繝ｼ繝ｫ騾∽ｿ｡讖溯・縺ｮ險ｭ螳・/strong>: 繧ｭ繝・メ繝ｳ繝ｻ縺企｢ｨ蜻ゅ・豢鈴擇繝ｻ繝医う繝ｬ繝ｻ辣ｧ譏弱・繝ｩ繝ｳ縺ｮ繝｡繝ｼ繧ｫ繝ｼ驕ｸ謚槭↓蟇ｾ蠢懊＠縺溘Γ繝ｼ繝ｫ繧帝∽ｿ｡縺吶ｋ縺ｫ縺ｯ縲√交沛｢ 讌ｭ閠・・繝｡繝ｼ繝ｫ邂｡逅・阪ち繝悶〒蜷・Γ繝ｼ繧ｫ繝ｼ縺ｮ繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ繧定ｨｭ螳壹＠縺ｦ縺上□縺輔＞縲・
            </p>
          </div>
          <div id="icTasksGrid"></div>
        </div>

        <!-- 螟匁ｧ区･ｭ蜍咏ｮ｡逅・-->
        <div id="exteriorTasksPanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">元 螟匁ｧ区･ｭ蜍吶ち繧ｹ繧ｯ邂｡逅・/h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openExteriorTaskModal()">+ 螟匁ｧ九ち繧ｹ繧ｯ霑ｽ蜉</button>
            </div>
          </div>
          <p style="margin-bottom: 24px; color: var(--text-secondary);">螟匁ｧ玖ｨｭ險医・讌ｭ蜍吶ヵ繝ｭ繝ｼ繧堤ｮ｡逅・＠縺ｾ縺吶・/p>
          <div id="exteriorTasksGrid"></div>
        </div>

        <!-- 荳榊虚逕｣讌ｭ蜍咏ｮ｡逅・-->
        <div id="realestateTasksPanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">召 荳榊虚逕｣讌ｭ蜍吶ち繧ｹ繧ｯ邂｡逅・/h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openRealestateTaskModal()">+ 荳榊虚逕｣繧ｿ繧ｹ繧ｯ霑ｽ蜉</button>
            </div>
          </div>
          <p style="margin-bottom: 24px; color: var(--text-secondary);">荳榊虚逕｣髢｢騾｣縺ｮ讌ｭ蜍吶ヵ繝ｭ繝ｼ繧堤ｮ｡逅・＠縺ｾ縺吶・/p>
          <div id="realestateTasksGrid"></div>
        </div>

        <!-- 蟾･莠区･ｭ蜍咏ｮ｡逅・-->
        <div id="constructionTasksPanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">畑 蟾･莠区･ｭ蜍吶ち繧ｹ繧ｯ邂｡逅・/h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openConstructionTaskModal()">+ 蟾･莠九ち繧ｹ繧ｯ霑ｽ蜉</button>
            </div>
          </div>
          <p style="margin-bottom: 24px; color: var(--text-secondary);">蟾･莠矩未騾｣縺ｮ讌ｭ蜍吶ヵ繝ｭ繝ｼ繧堤ｮ｡逅・＠縺ｾ縺吶・/p>
          <div id="constructionTasksGrid"></div>
        </div>

        <!-- 蝠・刀邂｡逅・-->
        <div id="productsPanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">逃 蝠・刀繝槭せ繧ｿ邂｡逅・/h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">譯井ｻｶ縺ｧ驕ｸ謚槭〒縺阪ｋ蝠・刀繧堤ｮ｡逅・＠縺ｾ縺吶・/p>
            <div class="form-group">
              <label class="form-label">譁ｰ縺励＞蝠・刀繧定ｿｽ蜉</label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="newProductNameInline" placeholder="蝠・刀蜷搾ｼ井ｾ具ｼ哭IFE縲´IFE+縲？OURS・・ style="flex: 1;">
                <button class="btn btn-primary" onclick="addProductInline()">霑ｽ蜉</button>
              </div>
            </div>
            <div id="productsGrid" style="margin-top: 32px;"></div>
          </div>
        </div>

        <!-- 繧ｫ繧ｹ繧ｿ繝槭う繧ｺ -->
        <div id="customizePanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">耳 螟冶ｦｳ繧ｫ繧ｹ繧ｿ繝槭う繧ｺ</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">莨夂､ｾ縺ｮ繝悶Λ繝ｳ繝峨↓蜷医ｏ縺帙※繧ｷ繧ｹ繝・Β縺ｮ螟冶ｦｳ繧偵き繧ｹ繧ｿ繝槭う繧ｺ縺ｧ縺阪∪縺吶ゅさ繝ｼ繝・ぅ繝ｳ繧ｰ荳崎ｦ√〒邁｡蜊倥↓螟画峩縺ｧ縺阪∪縺吶・/p>

            <div style="display: grid; grid-template-columns: 1fr 300px; gap: 32px;">
              <div>
                <div class="form-group">
                  <label class="form-label">莨夂､ｾ蜷・/label>
                  <input type="text" class="form-input" id="customOrgName" placeholder="萓具ｼ壽ｪ蠑丈ｼ夂､ｾ繧ｵ繝ｳ繝励Ν蟾･蜍吝ｺ・ style="width: 100%;">
                  <div class="form-hint">繝倥ャ繝繝ｼ縺ｮ繧ｿ繧､繝医Ν縺ｫ陦ｨ遉ｺ縺輔ｌ縺ｾ縺・/div>
                </div>

                <div class="form-group">
                  <label class="form-label">繝ｭ繧ｴURL</label>
                  <input type="text" class="form-input" id="customLogoUrl" placeholder="https://example.com/logo.png" style="width: 100%;">
                  <div class="form-hint">謗ｨ螂ｨ繧ｵ繧､繧ｺ: 150x40px・・NG/SVG蠖｢蠑擾ｼ・/div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div class="form-group">
                    <label class="form-label">繝｡繧､繝ｳ繧ｫ繝ｩ繝ｼ</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input type="color" id="customPrimaryColor" value="#2563EB" style="width: 50px; height: 40px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); cursor: pointer;">
                      <input type="text" class="form-input" id="customPrimaryColorText" value="#2563EB" style="flex: 1;" oninput="document.getElementById('customPrimaryColor').value = this.value">
                    </div>
                    <div class="form-hint">繝懊ち繝ｳ繧・Μ繝ｳ繧ｯ縺ｮ濶ｲ</div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">繧｢繧ｯ繧ｻ繝ｳ繝医き繝ｩ繝ｼ</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input type="color" id="customSecondaryColor" value="#059669" style="width: 50px; height: 40px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); cursor: pointer;">
                      <input type="text" class="form-input" id="customSecondaryColorText" value="#059669" style="flex: 1;" oninput="document.getElementById('customSecondaryColor').value = this.value">
                    </div>
                    <div class="form-hint">謌仙粥迥ｶ諷九ｄ繧ｵ繝悶・繧ｿ繝ｳ縺ｮ濶ｲ</div>
                  </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                  <button class="btn btn-primary" onclick="saveCustomization()">繧ｫ繧ｹ繧ｿ繝槭う繧ｺ繧剃ｿ晏ｭ・/button>
                  <button class="btn btn-ghost" onclick="previewCustomization()">繝励Ξ繝薙Η繝ｼ</button>
                  <button class="btn btn-ghost" onclick="resetCustomization()">繝ｪ繧ｻ繝・ヨ</button>
                </div>

                <div id="customizeStatus" style="margin-top: 16px;"></div>
              </div>

              <div style="padding: 20px; background: var(--bg-secondary); border-radius: var(--radius-lg); height: fit-content;">
                <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">繝励Ξ繝薙Η繝ｼ</h3>
                <div id="customizePreview" style="padding: 16px; background: var(--bg-primary); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <div id="previewLogo" style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">匠</div>
                    <span id="previewTitle" style="font-weight: 600; font-size: 14px;">ArchiDeck</span>
                  </div>
                  <button class="btn btn-primary btn-small" style="margin-right: 8px;">繝｡繧､繝ｳ繝懊ち繝ｳ</button>
                  <button class="btn btn-secondary btn-small">繧ｵ繝悶・繧ｿ繝ｳ</button>
                </div>
              </div>
            </div>

            <div style="margin-top: 32px; padding: 16px; background: var(--primary-light); border-radius: var(--radius-md); border-left: 4px solid var(--primary-color);">
              <h4 style="font-size: 14px; font-weight: 600; color: var(--primary-color); margin-bottom: 8px;">繝偵Φ繝・/h4>
              <ul style="font-size: 13px; color: var(--text-secondary); margin: 0; padding-left: 20px;">
                <li>繝ｭ繧ｴ縺ｯURL繧貞・蜉帙☆繧九°縲∫判蜒上ｒ繝帙せ繝・ぅ繝ｳ繧ｰ繧ｵ繝ｼ繝薙せ縺ｫ繧｢繝・・繝ｭ繝ｼ繝峨＠縺ｦ縺上□縺輔＞</li>
                <li>繧ｫ繝ｩ繝ｼ縺ｯ莨夂､ｾ縺ｮ繝悶Λ繝ｳ繝峨き繝ｩ繝ｼ縺ｫ蜷医ｏ縺帙ｋ縺薙→繧偵♀蜍ｧ繧√＠縺ｾ縺・/li>
                <li>螟画峩縺ｯ縲後・繝ｬ繝薙Η繝ｼ縲阪〒遒ｺ隱阪＠縺ｦ縺九ｉ菫晏ｭ倥＠縺ｦ縺上□縺輔＞</li>
              </ul>
            </div>

          </div>
        </div>

        <!-- kintone騾｣謳ｺ -->
        <div id="kintonePanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">迫 kintone騾｣謳ｺ險ｭ螳・/h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">kintone縺ｨ騾｣謳ｺ縺励※縲・ず蜷阪・髢灘叙遒ｺ螳壽律繝ｻ逹蟾･險ｱ蜿ｯ繝ｻ螟画峩螂醍ｴ・燕莨夊ｭｰ縺ｮ諠・ｱ繧貞酔譛溘＠縺ｾ縺吶・/p>

            <div class="form-group">
              <label class="form-label">kintone 繝峨Γ繧､繝ｳ</label>
              <input type="text" class="form-input" id="kintoneDomain" placeholder="萓具ｼ噐our-company.cybozu.com" style="width: 100%;">
            </div>

            <div class="form-group">
              <label class="form-label">API繝医・繧ｯ繝ｳ</label>
              <input type="password" class="form-input" id="kintoneApiToken" placeholder="API繝医・繧ｯ繝ｳ繧貞・蜉・ style="width: 100%;">
              <div class="form-hint" style="font-size: 11px; margin-top: 4px;">kintone繧｢繝励Μ縺ｮ險ｭ螳壹°繧陰PI繝医・繧ｯ繝ｳ繧堤匱陦後＠縺ｦ縺上□縺輔＞・郁､・焚繧｢繝励Μ縺ｧ蜈ｱ騾壹・繝医・繧ｯ繝ｳ繧剃ｽｿ逕ｨ・・/div>
            </div>

            <div style="margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
              <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">蟷ｴ蠎ｦ蛻･繧｢繝励Μ險ｭ螳・/h3>
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">蟷ｴ蠎ｦ縺斐→縺ｫ逡ｰ縺ｪ繧九い繝励ΜID繧定ｨｭ螳壹〒縺阪∪縺吶り､・焚蟷ｴ蠎ｦ繧偵∪縺溘＞縺ｧ繝・・繧ｿ邂｡逅・′蜿ｯ閭ｽ縺ｧ縺吶・/p>
              <div id="kintoneAppsList" style="display: flex; flex-direction: column; gap: 8px;"></div>
              <button class="btn btn-ghost" onclick="addKintoneAppRow()" style="margin-top: 12px;">+ 蟷ｴ蠎ｦ繧定ｿｽ蜉</button>
            </div>

            <!-- 蠕梧婿莠呈鋤諤ｧ縺ｮ縺溘ａ縺ｮ髱櫁｡ｨ遉ｺ繝輔ぅ繝ｼ繝ｫ繝・-->
            <input type="hidden" id="kintoneAppId" value="">

            <div style="margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
              <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">繝輔ぅ繝ｼ繝ｫ繝峨・繝・ヴ繝ｳ繧ｰ・亥渕譛ｬ諠・ｱ・・/h3>
              <div class="form-hint" style="font-size: 11px; margin-bottom: 12px;">kintone縺ｮ繝輔ぅ繝ｼ繝ｫ繝峨さ繝ｼ繝峨ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">竭驍ｸ蜷搾ｼ医♀螳｢讒伜錐・・/label>
                  <input type="text" class="form-input" id="kintoneFieldCustomer" placeholder="譁・ｭ誉蝓ｺ譛ｬ諠・ｱ_縺雁ｮ｢讒伜錐_繝｡繧､繝ｳ" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">竭･繝励Λ繝ｳ遒ｺ螳壽律</label>
                  <input type="text" class="form-input" id="kintoneFieldLayout" placeholder="譌･莉論險ｭ險・繝励Λ繝ｳ遒ｺ螳喟莠亥ｮ壽焔蜈･蜉・ style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">竭ｧ逹蟾･險ｱ蜿ｯ譌･</label>
                  <input type="text" class="form-input" id="kintoneFieldPermit" placeholder="譌･莉論險ｭ險・逹蟾･險ｱ蜿ｯ_莠亥ｮ壽焔蜈･蜉・ style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">竭ｦ螟画峩螂醍ｴ・燕莨夊ｭｰ譌･</label>
                  <input type="text" class="form-input" id="kintoneFieldMeeting" placeholder="譌･莉論IC_螟画峩螂醍ｴ・燕莨夊ｭｰ_莠亥ｮ壽焔蜈･蜉・ style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">竭ｨ蝠・刀</label>
                  <input type="text" class="form-input" id="kintoneFieldProduct" placeholder="繝峨Ο繝・・繝繧ｦ繝ｳ_蝟ｶ讌ｭ_螂醍ｴ・ｾ契蝠・刀" style="width: 100%;">
                </div>
              </div>
            </div>

            <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
              <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">繝輔ぅ繝ｼ繝ｫ繝峨・繝・ヴ繝ｳ繧ｰ・域球蠖楢・ｼ・/h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">竭｡蝟ｶ讌ｭ諡・ｽ・/label>
                  <input type="text" class="form-input" id="kintoneFieldSales" placeholder="繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚枩蝓ｺ譛ｬ諠・ｱ_蝟ｶ讌ｭ" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">竭｢險ｭ險域球蠖・/label>
                  <input type="text" class="form-input" id="kintoneFieldDesign" placeholder="繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚枩蝓ｺ譛ｬ諠・ｱ_險ｭ險・ style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">竭｣IC諡・ｽ・/label>
                  <input type="text" class="form-input" id="kintoneFieldIC" placeholder="繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚枩蝓ｺ譛ｬ諠・ｱ_IC" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">竭､蟾･莠区球蠖・/label>
                  <input type="text" class="form-input" id="kintoneFieldConstruction" placeholder="繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚枩蝓ｺ譛ｬ諠・ｱ_蟾･莠・ style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">竭ｩ螟匁ｧ区球蠖・/label>
                  <input type="text" class="form-input" id="kintoneFieldExterior" placeholder="譁・ｭ怜・_蝓ｺ譛ｬ諠・ｱ_螟匁ｧ区命蟾･諡・ｽ・ style="width: 100%;">
                </div>
              </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button class="btn btn-primary" onclick="saveKintoneSettings()">險ｭ螳壹ｒ菫晏ｭ・/button>
              <button class="btn btn-ghost" onclick="testKintoneConnection()">謗･邯壹ユ繧ｹ繝・/button>
            </div>

            <div id="kintoneStatus" style="margin-top: 16px;"></div>

            <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border-color);">
              <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">繝・・繧ｿ騾｣謳ｺ</h3>
              <div style="margin-bottom: 16px;">
                <label class="form-label" style="font-size: 13px;">繧､繝ｳ繝昴・繝亥ｯｾ雎｡蟷ｴ蠎ｦ</label>
                <div id="kintoneImportYearSelect" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                  <!-- 蜍慕噪縺ｫ蟷ｴ蠎ｦ繝√ぉ繝・け繝懊ャ繧ｯ繧ｹ縺瑚ｿｽ蜉縺輔ｌ繧・-->
                </div>
              </div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="importFromKintoneDirect()">踏 kintone縺九ｉ逶ｴ謗･繧､繝ｳ繝昴・繝・/button>
                <button class="btn btn-ghost" onclick="importFromKintone()">踏 CSV繧､繝ｳ繝昴・繝・/button>
                <button class="btn btn-ghost" onclick="exportToKintone()">豆 CSV繧ｨ繧ｯ繧ｹ繝昴・繝・/button>
              </div>
              <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">
                驕ｸ謚槭＠縺溷ｹｴ蠎ｦ縺ｮkintone繧｢繝励Μ縺九ｉ繝・・繧ｿ繧貞叙蠕励＠縺ｦ繧､繝ｳ繝昴・繝医＠縺ｾ縺吶・
              </p>
              <div id="kintoneImportStatus" style="margin-top: 12px;"></div>

              <!-- 繝・・繧ｿ謨ｴ逅・-->
              <div style="margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">繝・・繧ｿ謨ｴ逅・/h4>
                <div id="dataStatsInfo" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;"></div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <button class="btn btn-ghost btn-sm" onclick="showDataStats()">投 繝・・繧ｿ迥ｶ豕√ｒ遒ｺ隱・/button>
                  <button class="btn btn-ghost btn-sm" onclick="clearDemoDataConfirm()" style="color: var(--warning-color);">卵・・繝・Δ繝・・繧ｿ繧貞炎髯､</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 繝舌ャ繧ｯ繧｢繝・・ -->
        <div id="backupPanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">沈 繝・・繧ｿ繝舌ャ繧ｯ繧｢繝・・</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">繧ｷ繧ｹ繝・Β蜈ｨ菴薙・繝・・繧ｿ繧偵ヰ繝・け繧｢繝・・繝ｻ蠕ｩ蜈・〒縺阪∪縺吶り・蜍輔ヰ繝・け繧｢繝・・繧ょ茜逕ｨ蜿ｯ閭ｽ縺ｧ縺吶・/p>

            <!-- 閾ｪ蜍輔ヰ繝・け繧｢繝・・險ｭ螳・-->
            <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #e0f2fe, #dbeafe); border-radius: var(--radius-md);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <div>
                  <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 4px;">売 閾ｪ蜍輔ヰ繝・け繧｢繝・・</h3>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">繝・・繧ｿ螟画峩譎ゅ↓閾ｪ蜍輔〒繝ｭ繝ｼ繧ｫ繝ｫ縺ｫ繝舌ャ繧ｯ繧｢繝・・繧剃ｿ晏ｭ倥＠縺ｾ縺・/p>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px;">
                <div>譛邨ゅヰ繝・け繧｢繝・・: <strong id="lastBackupTime">-</strong></div>
                <div>繝舌ャ繧ｯ繧｢繝・・莉ｶ謨ｰ: <strong id="localBackupCount">0</strong>莉ｶ</div>
                <button class="btn btn-secondary btn-small" onclick="downloadLocalBackup()">繝ｭ繝ｼ繧ｫ繝ｫ繝舌ャ繧ｯ繧｢繝・・繧偵ム繧ｦ繝ｳ繝ｭ繝ｼ繝・/button>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
              <div style="padding: 24px; background: var(--bg-secondary); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">豆</div>
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">繝舌ャ繧ｯ繧｢繝・・菴懈・</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">蜈ｨ繝・・繧ｿ繧谷SON繝輔ぃ繧､繝ｫ縺ｨ縺励※繝繧ｦ繝ｳ繝ｭ繝ｼ繝峨＠縺ｾ縺・/p>
                <button class="btn btn-primary" onclick="createBackup()">繝舌ャ繧ｯ繧｢繝・・繧剃ｽ懈・</button>
              </div>

              <div style="padding: 24px; background: var(--bg-secondary); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">踏</div>
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">繝舌ャ繧ｯ繧｢繝・・蠕ｩ蜈・/h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">JSON繝輔ぃ繧､繝ｫ縺九ｉ繝・・繧ｿ繧貞ｾｩ蜈・＠縺ｾ縺・/p>
                <button class="btn btn-ghost" onclick="restoreBackup()">蠕ｩ蜈・ヵ繧｡繧､繝ｫ繧帝∈謚・/button>
              </div>
            </div>

            <div style="margin-top: 32px; padding: 16px; background: rgba(245, 166, 35, 0.1); border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
              <h4 style="font-size: 14px; font-weight: 600; color: var(--warning-color); margin-bottom: 8px;">笞・・豕ｨ諢丈ｺ矩・/h4>
              <ul style="font-size: 13px; color: var(--text-secondary); margin: 0; padding-left: 20px;">
                <li>蠕ｩ蜈・ｒ陦後≧縺ｨ譌｢蟄倥ョ繝ｼ繧ｿ縺御ｸ頑嶌縺阪＆繧後∪縺・/li>
                <li>蠕ｩ蜈・燕縺ｫ蠢・★迴ｾ蝨ｨ縺ｮ繝舌ャ繧ｯ繧｢繝・・繧剃ｽ懈・縺励※縺上□縺輔＞</li>
                <li>繝舌ャ繧ｯ繧｢繝・・繝輔ぃ繧､繝ｫ縺ｯ螳牙・縺ｪ蝣ｴ謇縺ｫ菫晉ｮ｡縺励※縺上□縺輔＞</li>
                <li>閾ｪ蜍輔ヰ繝・け繧｢繝・・縺ｯ繝悶Λ繧ｦ繧ｶ縺ｮ繝ｭ繝ｼ繧ｫ繝ｫ繧ｹ繝医Ξ繝ｼ繧ｸ縺ｫ菫晏ｭ倥＆繧後∪縺呻ｼ域怙螟ｧ5MB・・/li>
              </ul>
            </div>

            <div id="backupStatus" style="margin-top: 24px;"></div>
          </div>
        </div>

        <!-- FC邂｡逅・-->
        <div id="fcManagementPanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">
            竊・險ｭ螳壹↓謌ｻ繧・
          </button>
          <div style="max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <div>
                <h2 style="margin: 0; font-size: 24px; font-weight: 700;">宵 FC・医ヵ繝ｩ繝ｳ繝√Ε繧､繧ｺ・臥ｮ｡逅・/h2>
                <p style="margin: 8px 0 0; color: var(--text-secondary);">FC蜈医↓繝帙Ρ繧､繝医Λ繝吶Ν迚医ｒ逋ｺ陦後・邂｡逅・〒縺阪∪縺吶・/p>
              </div>
              <button class="btn btn-primary" onclick="openFcModal()">+ FC霑ｽ蜉</button>
            </div>

            <div class="card" style="margin-bottom: 24px; padding: 20px;">
              <h3 style="margin: 0 0 12px; font-size: 16px;">FC蟆ら畑URL縺ｫ縺､縺・※</h3>
              <p style="margin: 0; color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
                FC蜈医↓縺ｯ蟆ら畑縺ｮURL縺檎匱陦後＆繧後∪縺吶・br>
                萓・ <code style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px;">https://nandemo-nu.vercel.app/fc/tokyo-fc/</code><br>
                FC蟆ら畑URL縺ｧ繧｢繧ｯ繧ｻ繧ｹ縺吶ｋ縺ｨ縲；繝上え繧ｹ縺ｮ繝悶Λ繝ｳ繝・ぅ繝ｳ繧ｰ縺碁撼陦ｨ遉ｺ縺ｫ縺ｪ繧翫∬ｨｭ螳壹＠縺溘き繧ｹ繧ｿ繝繝ｭ繧ｴ繝ｻ繧ｫ繝ｩ繝ｼ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺吶・
              </p>
            </div>

            <div id="fcListContainer">
              <div class="empty-state">
                <div class="empty-icon">宵</div>
                <p>FC縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ<br><small>縲・ FC霑ｽ蜉縲阪・繧ｿ繝ｳ縺九ｉ逋ｻ骭ｲ縺励※縺上□縺輔＞</small></p>
              </div>
            </div>
          </div>
        </div>

        <!-- 繧｢繧ｫ繧ｦ繝ｳ繝郁ｨｭ螳・-->
        <div id="accountPanel" class="sub-tab-panel">
          <button class="settings-back-btn" onclick="closeSettingsPanel()">竊・險ｭ螳壹↓謌ｻ繧・/button>
          <div style="max-width: 600px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">柏 繧｢繧ｫ繧ｦ繝ｳ繝郁ｨｭ螳・/h2>

            <!-- 迴ｾ蝨ｨ縺ｮ繧｢繧ｫ繧ｦ繝ｳ繝域ュ蝣ｱ -->
            <div class="card" style="margin-bottom: 24px; padding: 20px;">
              <h3 style="margin: 0 0 16px; font-size: 16px;">繧｢繧ｫ繧ｦ繝ｳ繝域ュ蝣ｱ</h3>
              <div style="margin-bottom: 12px;">
                <label style="font-size: 13px; color: var(--text-secondary);">繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ</label>
                <div id="accountEmail" style="font-weight: 600; margin-top: 4px;">-</div>
              </div>
              <div>
                <label style="font-size: 13px; color: var(--text-secondary);">繝ｭ繧ｰ繧､繝ｳ繝ｦ繝ｼ繧ｶ繝ｼ蜷・/label>
                <div id="accountUsername" style="font-weight: 600; margin-top: 4px;">-</div>
              </div>
            </div>

            <!-- 繝代せ繝ｯ繝ｼ繝牙､画峩 -->
            <div class="card" style="padding: 20px;">
              <h3 style="margin: 0 0 16px; font-size: 16px;">繝代せ繝ｯ繝ｼ繝牙､画峩</h3>
              <p style="margin: 0 0 16px; font-size: 13px; color: var(--text-secondary);">
                譁ｰ縺励＞繝代せ繝ｯ繝ｼ繝峨ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞縲ゅヱ繧ｹ繝ｯ繝ｼ繝峨・闍ｱ蟄励→謨ｰ蟄励ｒ蜷ｫ繧8譁・ｭ嶺ｻ･荳翫〒險ｭ螳壹＠縺ｦ縺上□縺輔＞縲・
              </p>
              <div class="form-group" style="margin-bottom: 16px;">
                <label class="form-label">譁ｰ縺励＞繝代せ繝ｯ繝ｼ繝・/label>
                <input type="password" class="form-input" id="newPassword" placeholder="闍ｱ謨ｰ蟄玲ｷｷ蜷・譁・ｭ嶺ｻ･荳・ style="width: 100%;">
              </div>
              <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">譁ｰ縺励＞繝代せ繝ｯ繝ｼ繝会ｼ育｢ｺ隱搾ｼ・/label>
                <input type="password" class="form-input" id="confirmPassword" placeholder="繧ゅ≧荳蠎ｦ蜈･蜉・ style="width: 100%;">
              </div>
              <button class="btn btn-primary" onclick="changePassword()" style="width: 100%;">繝代せ繝ｯ繝ｼ繝峨ｒ螟画峩</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- 繝｢繝ｼ繝繝ｫ・壽｡井ｻｶ霑ｽ蜉/邱ｨ髮・-->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="projectModalTitle">譯井ｻｶ霑ｽ蜉</h2>
      <button class="close" onclick="closeProjectModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">縺雁ｮ｢讒伜錐 *</label>
        <input type="text" class="form-input" id="projectCustomer" placeholder="萓具ｼ夂伐荳ｭ螟ｪ驛取ｧ・>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
        <div class="form-group">
          <label class="form-label">諡・ｽ難ｼ郁ｨｭ險茨ｼ・*</label>
          <select class="form-select" id="projectAssignedTo"></select>
        </div>
        <div class="form-group">
          <label class="form-label">諡・ｽ難ｼ・C・・/label>
          <select class="form-select" id="projectIcAssignee">
            <option value="">譛ｪ螳・/option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">諡・ｽ難ｼ亥､匁ｧ具ｼ・/label>
          <select class="form-select" id="projectExteriorAssignee">
            <option value="">譛ｪ螳・/option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">諡・ｽ難ｼ井ｸ榊虚逕｣・・/label>
          <select class="form-select" id="projectRealestateAssignee">
            <option value="">譛ｪ螳・/option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">諡・ｽ難ｼ亥ｷ･莠具ｼ・/label>
          <select class="form-select" id="projectConstructionAssignee">
            <option value="">譛ｪ螳・/option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">諡・ｽ難ｼ亥霧讌ｭ・・/label>
          <select class="form-select" id="projectSalesAssignee">
            <option value="">譛ｪ螳・/option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">蝠・刀</label>
        <select class="form-select" id="projectSpecifications"></select>
      </div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: space-between;">
      <div id="templateButtons" style="display: none;">
        <button class="btn btn-ghost btn-small" onclick="TemplateManager.createFromProject(editingProjectId)" title="迴ｾ蝨ｨ縺ｮ險ｭ螳壹ｒ繝・Φ繝励Ξ繝ｼ繝医→縺励※菫晏ｭ・>搭 繝・Φ繝励Ξ繝ｼ繝井ｿ晏ｭ・/button>
        <button class="btn btn-ghost btn-small" onclick="TemplateManager.showSelectModal(editingProjectId)" title="菫晏ｭ俶ｸ医∩繝・Φ繝励Ξ繝ｼ繝医ｒ驕ｩ逕ｨ">搭 繝・Φ繝励Ξ繝ｼ繝磯←逕ｨ</button>
      </div>
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-ghost" onclick="closeProjectModal()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
        <button class="btn btn-primary" onclick="saveProject()">菫晏ｭ・/button>
      </div>
    </div>
  </div>
</div>

<!-- 繝｢繝ｼ繝繝ｫ・壹Γ繝ｼ繝ｫ繝・Φ繝励Ξ繝ｼ繝郁ｿｽ蜉/邱ｨ髮・-->
<div id="templateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="templateModalTitle">繝・Φ繝励Ξ繝ｼ繝郁ｿｽ蜉</h2>
      <button class="close" onclick="closeTemplateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">繝・Φ繝励Ξ繝ｼ繝・D *</label>
        <input type="text" class="form-input" id="templateId" placeholder="萓具ｼ嗜ew-template">
        <div class="form-hint">闍ｱ謨ｰ蟄励→繝上う繝輔Φ縺ｮ縺ｿ菴ｿ逕ｨ蜿ｯ閭ｽ</div>
      </div>
      <div class="form-group">
        <label class="form-label">陦ｨ遉ｺ蜷・*</label>
        <input type="text" class="form-input" id="templateDisplayName" placeholder="萓具ｼ壽眠莨夂､ｾ蜷搾ｼ井ｽ懈･ｭ蜀・ｮｹ・・>
      </div>
      <div class="form-group">
        <label class="form-label">繧ｫ繝・ざ繝ｪ *</label>
        <select class="form-select" id="templateCategory">
          <option value="險ｭ險・>險ｭ險・/option>
          <option value="IC">IC</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">莨夂､ｾ蜷・*</label>
        <input type="text" class="form-input" id="templateCompany" placeholder="萓具ｼ壽ｪ蠑丈ｼ夂､ｾ縲・・>
      </div>
      <div class="form-group">
        <label class="form-label">螳帛・蜷・/label>
        <input type="text" class="form-input" id="templateContact" placeholder="萓具ｼ夂伐荳ｭ讒・>
      </div>
      <div class="form-group">
        <label class="form-label">繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ</label>
        <input type="text" class="form-input" id="templateEmail" placeholder="萓具ｼ嗾anaka@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">莉ｶ蜷阪ヵ繧ｩ繝ｼ繝槭ャ繝・*</label>
        <input type="text" class="form-input" id="templateSubjectFormat" placeholder="萓具ｼ嘴customerName}讒・譁ｰ隕上・・ｽ懈・萓晞ｼ縲譛滓律{dueDate}">
        <div class="form-hint">菴ｿ逕ｨ蜿ｯ閭ｽ・嘴customerName}, {dueDate}, {staffName}</div>
      </div>
      <div class="form-group">
        <label class="form-label">繝｡繝ｼ繝ｫ譛ｬ譁・*</label>
        <textarea class="form-textarea" id="templateText" rows="10" placeholder="萓・&#10;{company}&#10;{contact}&#10;&#10;縺・▽繧ゅ♀荳冶ｩｱ縺ｫ縺ｪ縺｣縺ｦ縺翫ｊ縺ｾ縺吶・></textarea>
        <div class="form-hint">菴ｿ逕ｨ蜿ｯ閭ｽ・嘴company}, {contact}, {customerName}, {dueDate}, {staffName}, {specialContent}</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTemplateModal()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
      <button class="btn btn-primary" onclick="saveTemplate()">菫晏ｭ・/button>
    </div>
  </div>
</div>

<!-- 繝｢繝ｼ繝繝ｫ・壽球蠖鍋ｮ｡逅・-->
<div id="designerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">諡・ｽ鍋ｮ｡逅・/h2>
      <button class="close" onclick="closeDesignerModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">譁ｰ縺励＞諡・ｽ薙ｒ霑ｽ蜉</label>
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px;">
          <input type="text" class="form-input" id="newDesignerName" placeholder="諡・ｽ灘錐">
          <select class="form-select" id="newDesignerCategory" style="width: 150px;">
            <option value="險ｭ險・>險ｭ險域球蠖・/option>
            <option value="IC">IC諡・ｽ・/option>
            <option value="螟匁ｧ・>螟匁ｧ区球蠖・/option>
            <option value="荳榊虚逕｣">荳榊虚逕｣諡・ｽ・/option>
            <option value="蟾･莠・>蟾･莠区球蠖・/option>
            <option value="蝟ｶ讌ｭ">蝟ｶ讌ｭ諡・ｽ・/option>
            <option value="邂｡逅・・>邂｡逅・・/option>
          </select>
          <button class="btn btn-primary" onclick="addDesigner()">霑ｽ蜉</button>
        </div>
      </div>
      <div id="designerList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeDesignerModal()">螳御ｺ・/button>
    </div>
  </div>
</div>

<!-- 繝｢繝ｼ繝繝ｫ・壹Γ繝ｼ繝ｫ菴懈・ -->
<div id="emailModal" class="modal">
  <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
      <h2 class="modal-title">透 繝｡繝ｼ繝ｫ菴懈・</h2>
      <button class="close" onclick="closeEmailModal()">&times;</button>
    </div>
    <div class="modal-body" id="emailComposerContent"></div>
  </div>
</div>

<!-- 繝｢繝ｼ繝繝ｫ・壽･ｭ閠・ｿｽ蜉/邱ｨ髮・2 -->
<div id="vendorModalV2" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title" id="vendorModalTitle">讌ｭ閠・ｿｽ蜉</h2>
      <button class="close" onclick="closeVendorModalV2()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="vendorForm">
        <input type="hidden" id="vendorId">

        <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">蝓ｺ譛ｬ諠・ｱ</h3>

        <div class="form-group">
          <label class="form-label">莨夂､ｾ蜷・*</label>
          <input type="text" class="form-input" id="vendorCompany" placeholder="萓具ｼ壽ｪ蠑丈ｼ夂､ｾ縲・・ required>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">諡・ｽ楢・錐</label>
            <input type="text" class="form-input" id="vendorContact" placeholder="萓具ｼ夂伐荳ｭ讒・>
          </div>

          <div class="form-group">
            <label class="form-label">髮ｻ隧ｱ逡ｪ蜿ｷ</label>
            <input type="text" class="form-input" id="vendorTel" placeholder="萓具ｼ・90-1234-5678">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ</label>
            <input type="email" class="form-input" id="vendorEmail" placeholder="萓具ｼ嗾anaka@example.com">
          </div>

          <div class="form-group">
            <label class="form-label">繧ｫ繝・ざ繝ｪ</label>
            <select class="form-select" id="vendorCategory"></select>
          </div>
        </div>

        <h3 style="margin: 24px 0 16px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">繝｡繝ｼ繝ｫ繝・Φ繝励Ξ繝ｼ繝・/h3>

        <div class="form-group">
          <label class="form-label">莉ｶ蜷阪ヵ繧ｩ繝ｼ繝槭ャ繝・/label>
          <input type="text" class="form-input" id="vendorSubject" placeholder="萓具ｼ嘴customerName}讒・譁ｰ隕上・・ｽ懈・萓晞ｼ縲譛滓律{dueDate}">
          <div class="form-hint">菴ｿ逕ｨ蜿ｯ閭ｽ・嘴customerName}, {dueDate}, {staffName}</div>
        </div>

        <div class="form-group">
          <label class="form-label">繝｡繝ｼ繝ｫ譛ｬ譁・/label>
          <textarea class="form-textarea" id="vendorTemplate" rows="8" placeholder="萓・&#10;{company}&#10;{contact}&#10;&#10;縺・▽繧ゅ♀荳冶ｩｱ縺ｫ縺ｪ縺｣縺ｦ縺翫ｊ縺ｾ縺吶・></textarea>
          <div class="form-hint">菴ｿ逕ｨ蜿ｯ閭ｽ・嘴company}, {contact}, {customerName}, {dueDate}, {staffName}</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeVendorModalV2()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
      <button class="btn btn-primary" onclick="saveVendorV2()">菫晏ｭ・/button>
    </div>
  </div>
</div>

<!-- 繝｢繝ｼ繝繝ｫ・壽球蠖楢・ち繧ｹ繧ｯ荳隕ｧ -->
<div id="staffTasksModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="staffTasksModalTitle">繧ｿ繧ｹ繧ｯ荳隕ｧ</h2>
      <button class="close" onclick="closeStaffTasksModal()">&times;</button>
    </div>
    <div class="modal-body task-list-modal">
      <div style="margin-bottom: 16px; display: flex; gap: 8px;">
        <button class="btn btn-small btn-ghost" id="sortByDueBtn" onclick="sortTasksBy('due')">譛滄剞鬆・/button>
        <button class="btn btn-small btn-ghost" id="sortByProjectBtn" onclick="sortTasksBy('project')">驍ｸ蜷埼・/button>
      </div>
      <div id="staffTasksList"></div>
    </div>
  </div>
</div>

<!-- 繝｢繝ｼ繝繝ｫ・壹き繝・ざ繝ｪ霑ｽ蜉/邱ｨ髮・-->
<div id="categoryModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="categoryModalTitle">繧ｫ繝・ざ繝ｪ霑ｽ蜉</h2>
      <button class="close" onclick="closeCategoryModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="categoryForm">
        <input type="hidden" id="categoryId">

        <div class="form-group">
          <label class="form-label">繧ｫ繝・ざ繝ｪ蜷・*</label>
          <input type="text" class="form-input" id="categoryName" placeholder="萓具ｼ夊ｨｭ蛯・ required>
        </div>

        <div class="form-group">
          <label class="form-label">陦ｨ遉ｺ鬆・/label>
          <input type="number" class="form-input" id="categoryOrder" placeholder="1" min="1">
          <div class="form-hint">蟆上＆縺・焚蟄励⊇縺ｩ蜈医↓陦ｨ遉ｺ縺輔ｌ縺ｾ縺・/div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeCategoryModal()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
      <button class="btn btn-primary" onclick="saveCategory()">菫晏ｭ・/button>
    </div>
  </div>
</div>

<!-- 繝｢繝ｼ繝繝ｫ・壹ち繧ｹ繧ｯ霑ｽ蜉/邱ｨ髮・-->
<div id="taskModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="taskModalTitle">繧ｿ繧ｹ繧ｯ霑ｽ蜉</h2>
      <button class="close" onclick="closeTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="taskForm">
        <input type="hidden" id="taskId">
        <input type="hidden" id="taskKey">

        <div class="form-group">
          <label class="form-label">繧ｿ繧ｹ繧ｯ蜷・*</label>
          <input type="text" class="form-input" id="taskName" placeholder="萓具ｼ・蝗樒岼謇灘粋縺・ required>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">繧ｫ繝・ざ繝ｪ *</label>
            <select class="form-select" id="taskCategory" required>
              <option value="險ｭ險・>險ｭ險・/option>
              <option value="IC">IC</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">陦ｨ遉ｺ鬆・/label>
            <input type="number" class="form-input" id="taskOrder" placeholder="1" min="1">
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="taskHasState" onchange="toggleTaskState()">
            <span>迥ｶ諷狗ｮ｡逅・ｒ譛牙柑縺ｫ縺吶ｋ</span>
          </label>
          <div class="form-hint">繝√ぉ繝・け縺吶ｋ縺ｨ縲御ｾ晞ｼ貂医阪御ｿ晏ｭ俶ｸ医阪↑縺ｩ縺ｮ迥ｶ諷九ｒ驕ｸ謚槫庄閭ｽ縺ｫ縺ｪ繧翫∪縺・/div>
        </div>

        <div id="stateOptionsGroup" style="display: none;">
          <div class="form-group">
            <label class="form-label">迥ｶ諷九が繝励す繝ｧ繝ｳ</label>
            <div id="stateOptionsList" class="state-options-list">
              <!-- 蜍慕噪縺ｫ霑ｽ蜉縺輔ｌ繧・-->
            </div>
            <button type="button" class="btn btn-ghost btn-small" onclick="addStateOption()" style="margin-top: 8px;">+ 繧ｪ繝励す繝ｧ繝ｳ霑ｽ蜉</button>
            <div class="form-hint">蜷・が繝励す繝ｧ繝ｳ繧貞・蜉帙＠縺ｦ縺上□縺輔＞縲らｩｺ谺・ｼ・・峨・閾ｪ蜍輔〒蜈磯ｭ縺ｫ霑ｽ蜉縺輔ｌ縺ｾ縺・/div>
            <input type="hidden" id="taskStateOptions">
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="taskHasEmailButton">
            <span>透 繝｡繝ｼ繝ｫ菴懈・繝懊ち繝ｳ繧定｡ｨ遉ｺ縺吶ｋ</span>
          </label>
          <div class="form-hint">繝√ぉ繝・け縺吶ｋ縺ｨ譯井ｻｶ繧ｫ繝ｼ繝峨・繧ｿ繧ｹ繧ｯ縺ｫ透繝懊ち繝ｳ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/div>
        </div>

        <div class="form-group">
          <label class="form-label">邏舌▼縺第･ｭ閠・ｼ郁､・焚驕ｸ謚槫庄・・/label>
          <div id="taskVendorSelection" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
            <!-- 繝吶Φ繝繝ｼ縺ｮ繝√ぉ繝・け繝懊ャ繧ｯ繧ｹ繝ｪ繧ｹ繝医′縺薙％縺ｫ陦ｨ遉ｺ縺輔ｌ繧・-->
          </div>
          <div class="form-hint">縺薙・繧ｿ繧ｹ繧ｯ縺九ｉ逶ｴ謗･繝｡繝ｼ繝ｫ繧帝∽ｿ｡縺吶ｋ讌ｭ閠・ｒ驕ｸ謚槭＠縺ｦ縺上□縺輔＞</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTaskModal()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
      <button class="btn btn-primary" onclick="saveTask()">菫晏ｭ・/button>
    </div>
  </div>
</div>

<!-- 繝｢繝ｼ繝繝ｫ・哥C霑ｽ蜉/邱ｨ髮・-->
<div id="fcModal" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title" id="fcModalTitle">FC霑ｽ蜉</h2>
      <button class="close" onclick="closeFcModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="fcForm">
        <input type="hidden" id="fcId">

        <div class="form-group">
          <label class="form-label">FC蜷・*</label>
          <input type="text" class="form-input" id="fcName" placeholder="萓具ｼ壽擲莠ｬ繝輔Λ繝ｳ繝√Ε繧､繧ｺ" required>
        </div>

        <div class="form-group">
          <label class="form-label">URL繧ｹ繝ｩ繝・げ *</label>
          <input type="text" class="form-input" id="fcSlug" placeholder="萓具ｼ嗾okyo-fc" required pattern="[a-z0-9-]+" title="蜊願ｧ定恭謨ｰ蟄励→繝上う繝輔Φ縺ｮ縺ｿ菴ｿ逕ｨ蜿ｯ閭ｽ">
          <div class="form-hint">蜊願ｧ定恭謨ｰ蟄励→繝上う繝輔Φ縺ｮ縺ｿ縲ゆｾ・ tokyo-fc 竊・/fc/tokyo-fc/ 縺ｧ繧｢繧ｯ繧ｻ繧ｹ蜿ｯ閭ｽ</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">騾｣邨｡蜈医Γ繝ｼ繝ｫ</label>
            <input type="email" class="form-input" id="fcEmail" placeholder="contact@example.com">
          </div>
          <div class="form-group">
            <label class="form-label">騾｣邨｡蜈磯崕隧ｱ</label>
            <input type="tel" class="form-input" id="fcTel" placeholder="03-1234-5678">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">繝悶Λ繝ｳ繝峨き繝ｩ繝ｼ</label>
          <div style="display: flex; gap: 12px; align-items: center;">
            <input type="color" id="fcColor" value="#2563EB" style="width: 50px; height: 36px; border: none; border-radius: 4px; cursor: pointer;" oninput="document.getElementById('fcColorText').value = this.value">
            <input type="text" class="form-input" id="fcColorText" value="#2563EB" style="width: 120px;" oninput="document.getElementById('fcColor').value = this.value">
          </div>
          <div class="form-hint">FC蟆ら畑逕ｻ髱｢縺ｧ菴ｿ逕ｨ縺輔ｌ繧九Γ繧､繝ｳ繧ｫ繝ｩ繝ｼ</div>
        </div>

        <div class="form-group">
          <label class="form-label">繧ｫ繧ｹ繧ｿ繝繝ｭ繧ｴURL</label>
          <input type="url" class="form-input" id="fcLogoUrl" placeholder="https://example.com/logo.png">
          <div class="form-hint">遨ｺ逋ｽ縺ｮ蝣ｴ蜷医・繝・ヵ繧ｩ繝ｫ繝医・繧ｷ繧ｹ繝・Β繧｢繧､繧ｳ繝ｳ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="fcIsActive" checked>
            <span>譛牙柑</span>
          </label>
          <div class="form-hint">辟｡蜉ｹ縺ｫ縺吶ｋ縺ｨFC蟆ら畑URL縺ｫ繧｢繧ｯ繧ｻ繧ｹ縺ｧ縺阪↑縺上↑繧翫∪縺・/div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeFcModal()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
      <button class="btn btn-primary" onclick="saveFc()">菫晏ｭ・/button>
    </div>
  </div>
</div>

<!-- 繝｢繝ｼ繝繝ｫ・壽球蠖楢ｪ崎ｨｼ險ｭ螳・-->
<div id="designerAuthModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h2 class="modal-title">泊 諡・ｽ楢ｪ崎ｨｼ險ｭ螳・/h2>
      <button class="close" onclick="closeDesignerAuthModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="designerAuthForm">
        <input type="hidden" id="authDesignerId">

        <div class="form-group">
          <label class="form-label">諡・ｽ灘錐</label>
          <input type="text" class="form-input" id="authDesignerName" disabled>
        </div>

        <div class="form-group">
          <label class="form-label">繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ・医Ο繧ｰ繧､繝ｳID・・*</label>
          <input type="email" class="form-input" id="authDesignerEmail" placeholder="萓具ｼ噐amada@ghouse.jp" required>
          <div class="form-hint">縺薙・繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ縺ｧ繝ｭ繧ｰ繧､繝ｳ縺ｧ縺阪ｋ繧医≧縺ｫ縺ｪ繧翫∪縺・/div>
        </div>

        <div class="form-group">
          <label class="form-label">繝代せ繝ｯ繝ｼ繝・*</label>
          <input type="password" class="form-input" id="authDesignerPassword" placeholder="8譁・ｭ嶺ｻ･荳・ required>
          <div class="form-hint">8譁・ｭ嶺ｻ･荳翫〒險ｭ螳壹＠縺ｦ縺上□縺輔＞</div>
        </div>

        <div class="form-group">
          <label class="form-label">繝代せ繝ｯ繝ｼ繝会ｼ育｢ｺ隱搾ｼ・*</label>
          <input type="password" class="form-input" id="authDesignerPasswordConfirm" placeholder="繧ゅ≧荳蠎ｦ蜈･蜉・>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeDesignerAuthModal()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
      <button class="btn btn-primary" onclick="saveDesignerAuth()">菫晏ｭ・/button>
    </div>
  </div>
</div>

<!-- 繝｢繝ｼ繝繝ｫ・夂筏隲季o遒ｺ隱・-->
<div id="applicationGoModal" class="modal">
  <div class="modal-content" style="max-width: 450px;">
    <div class="modal-header">
      <h2 class="modal-title">遒ｺ隱咲筏隲・/h2>
      <button class="close" onclick="closeApplicationGoModal()">&times;</button>
    </div>
    <div class="modal-body" style="text-align: center; padding: 30px;">
      <div style="font-size: 48px; margin-bottom: 16px;">搭</div>
      <p id="applicationGoProjectName" style="font-size: 18px; font-weight: 600; margin-bottom: 8px;"></p>
      <p style="color: var(--text-secondary); margin-bottom: 24px;">縺薙・譯井ｻｶ繧貞ｮ御ｺ・ｸ医∩縺ｫ遘ｻ蜍輔＠縺ｾ縺吶°・・/p>
      <div class="application-go-checklist" style="text-align: left; background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <div style="font-weight: 600; margin-bottom: 8px;">譚｡莉ｶ遒ｺ隱・</div>
        <div id="applicationGoConditions"></div>
      </div>
    </div>
    <div class="modal-footer" style="justify-content: center; gap: 12px;">
      <button class="btn btn-ghost" onclick="closeApplicationGoModal()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
      <button class="btn btn-success" onclick="executeApplicationGo()" style="background: linear-gradient(135deg, #10b981, #059669);">螳御ｺ・ｸ医∩縺ｫ縺吶ｋ</button>
    </div>
  </div>
</div>

<!-- 繝｢繝ｼ繝繝ｫ・壼ｮ御ｺ・ｸ医∩遒ｺ隱・-->
<div id="archiveConfirmModal" class="modal">
  <div class="modal-content" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title">螳御ｺ・ｸ医∩縺ｫ遘ｻ蜍・/h2>
      <button class="close" onclick="closeArchiveConfirmModal()">&times;</button>
    </div>
    <div class="modal-body" style="text-align: center; padding: 30px;">
      <div style="font-size: 48px; margin-bottom: 16px;">逃</div>
      <p id="archiveConfirmProjectName" style="font-size: 18px; font-weight: 600; margin-bottom: 8px;"></p>
      <p style="color: var(--text-secondary); margin-bottom: 16px;">縺薙・譯井ｻｶ繧貞ｮ御ｺ・ｸ医∩縺ｫ遘ｻ蜍輔＠縺ｾ縺吶°・・/p>
      <p style="color: var(--text-muted); font-size: 12px;">螳御ｺ・ｸ医∩縺ｮ譯井ｻｶ縺ｯ縲悟ｮ御ｺ・ｸ医阪ヵ繧｣繝ｫ繧ｿ繝ｼ縺ｧ遒ｺ隱阪〒縺阪∪縺吶・/p>
    </div>
    <div class="modal-footer" style="justify-content: center; gap: 12px;">
      <button class="btn btn-ghost" onclick="closeArchiveConfirmModal()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
      <button class="btn btn-success" onclick="executeArchive()" style="background: linear-gradient(135deg, #10b981, #059669);">螳御ｺ・ｸ医∩縺ｫ縺吶ｋ</button>
    </div>
  </div>
</div>

<!-- 繝医・繧ｹ繝磯夂衍 -->
<div id="toast" class="toast"></div>
<div id="contextMenu" class="context-menu">
  <div class="context-menu-item" onclick="ContextMenu.edit()">笨擾ｸ・邱ｨ髮・/div>
  <div class="context-menu-item" onclick="ContextMenu.toggleSelect()">笘托ｸ・驕ｸ謚・/div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="ContextMenu.archive()">逃 螳御ｺ・ｸ医∩縺ｫ遘ｻ蜍・/div>
  <div class="context-menu-item danger" onclick="ContextMenu.delete()">卵・・蜑企勁</div>
</div>

<script>
// ============================================
// 繝・ヰ繝・げ繝｢繝ｼ繝芽ｨｭ螳・
// ============================================
const DEBUG_MODE = false; // 譛ｬ逡ｪ迺ｰ蠅・〒縺ｯ false
const log = DEBUG_MODE ? console.log.bind(console) : () => {};
const warn = DEBUG_MODE ? console.warn.bind(console) : () => {};
const logError = DEBUG_MODE ? console.error.bind(console) : () => {};

// ============================================
// 繝舌・繧ｸ繝ｧ繝ｳ邂｡逅・& 繧ｭ繝｣繝・す繝･繧ｯ繝ｪ繧｢
// ============================================
const APP_VERSION = '4.12.0-' + Date.now();
if (DEBUG_MODE) log('噫 ArchiDeck 繝舌・繧ｸ繝ｧ繝ｳ:', APP_VERSION);

// 襍ｷ蜍墓凾縺ｫ繧ｭ繝｣繝・す繝･繧貞ｼｷ蛻ｶ繧ｯ繝ｪ繧｢
(async function forceClearCache() {
  try {
    // Service Worker 縺ｮ繧ｭ繝｣繝・す繝･繧偵け繝ｪ繧｢
    const cacheNames = await caches.keys();
    for (const name of cacheNames) {
      await caches.delete(name);
      log('卵・・繧ｭ繝｣繝・す繝･蜑企勁:', name);
    }

    // Service Worker 繧堤匳骭ｲ隗｣髯､・亥ｮ悟・辟｡蜉ｹ蛹厄ｼ・
    if ('serviceWorker' in navigator) {
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const reg of registrations) {
        await reg.unregister();
        log('卵・・Service Worker 逋ｻ骭ｲ隗｣髯､');
      }
    }
    log('笨・繧ｭ繝｣繝・す繝･繧ｯ繝ｪ繧｢螳御ｺ・);
  } catch (e) {
    log('繧ｭ繝｣繝・す繝･繧ｯ繝ｪ繧｢繧ｨ繝ｩ繝ｼ・育┌隕門庄・・', e);
  }
})();

// ============================================
// 繝ｦ繝ｼ繝・ぅ繝ｪ繝・ぅ髢｢謨ｰ
// ============================================

// 繝・ヰ繧ｦ繝ｳ繧ｹ髢｢謨ｰ - 騾｣邯壼他縺ｳ蜃ｺ縺励ｒ蛻ｶ髯・
function debounce(func, wait = 300) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// 繧ｹ繝ｭ繝・ヨ繝ｫ髢｢謨ｰ - 荳螳夐俣髫斐〒螳溯｡後ｒ蛻ｶ髯・
function throttle(func, limit = 100) {
  let inThrottle;
  return function(...args) {
    if (!inThrottle) {
      func.apply(this, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}

// 莠碁㍾繧ｯ繝ｪ繝・け髦ｲ豁｢繝倥Ν繝代・
const SaveGuard = {
  _locks: new Set(),

  // 菫晏ｭ伜・逅・ｒ繝ｭ繝・け・井ｺ碁㍾螳溯｡碁亟豁｢・・
  async run(key, asyncFn) {
    if (this._locks.has(key)) {
      return false;
    }
    this._locks.add(key);
    try {
      return await asyncFn();
    } finally {
      this._locks.delete(key);
    }
  },

  // 繝ｭ繝・け迥ｶ諷九ｒ遒ｺ隱・
  isLocked(key) {
    return this._locks.has(key);
  }
};

// 螳牙・縺ｪJSON繝代・繧ｹ・医お繝ｩ繝ｼ譎ゅ・繝・ヵ繧ｩ繝ｫ繝亥､繧定ｿ斐☆・・
function safeJsonParse(str, defaultValue = null) {
  if (!str) return defaultValue;
  try {
    return JSON.parse(str);
  } catch (e) {
    warn('JSON.parse繧ｨ繝ｩ繝ｼ:', e.message);
    return defaultValue;
  }
}

// 繝｢繝ｼ繝繝ｫ邂｡逅・Θ繝ｼ繝・ぅ繝ｪ繝・ぅ
const ModalManager = {
  activeModal: null,
  previousFocus: null,

  // 繝｢繝ｼ繝繝ｫ繧帝幕縺擾ｼ医ヵ繧ｩ繝ｼ繧ｫ繧ｹ邂｡逅・ｻ倥″・・
  open(modalElement, firstFocusSelector = 'input:not([type="hidden"]), select, textarea, button') {
    if (!modalElement) return;

    // 譌｢蟄倥・Escape繝上Φ繝峨Λ縺後≠繧後・蜈医↓隗｣髯､・郁塘遨埼亟豁｢・・
    if (this._escapeHandler) {
      document.removeEventListener('keydown', this._escapeHandler);
      this._escapeHandler = null;
    }

    // 迴ｾ蝨ｨ縺ｮ繝輔か繝ｼ繧ｫ繧ｹ隕∫ｴ繧剃ｿ晏ｭ・
    this.previousFocus = document.activeElement;
    this.activeModal = modalElement;

    // 繝｢繝ｼ繝繝ｫ繧定｡ｨ遉ｺ
    modalElement.classList.add('show');

    // 譛蛻昴・蜈･蜉幄ｦ∫ｴ縺ｫ繝輔か繝ｼ繧ｫ繧ｹ
    setTimeout(() => {
      const firstFocusable = modalElement.querySelector(firstFocusSelector);
      if (firstFocusable) {
        firstFocusable.focus();
      }
    }, 100);

    // Escape繧ｭ繝ｼ縺ｧ縺ｮ繧ｯ繝ｭ繝ｼ繧ｺ繧定ｨｭ螳・
    this._escapeHandler = (e) => {
      if (e.key === 'Escape' && this.activeModal === modalElement) {
        this.close(modalElement);
      }
    };
    document.addEventListener('keydown', this._escapeHandler);
  },

  // 繝｢繝ｼ繝繝ｫ繧帝哩縺倥ｋ
  close(modalElement) {
    if (!modalElement) return;

    modalElement.classList.remove('show');

    // Escape繝上Φ繝峨Λ繧定ｧ｣髯､
    if (this._escapeHandler) {
      document.removeEventListener('keydown', this._escapeHandler);
      this._escapeHandler = null;
    }

    // 蜑阪・繝輔か繝ｼ繧ｫ繧ｹ隕∫ｴ縺ｫ謌ｻ縺・
    if (this.previousFocus && typeof this.previousFocus.focus === 'function') {
      this.previousFocus.focus();
    }

    this.activeModal = null;
    this.previousFocus = null;
  }
};

// 繝ｪ繧ｯ繧ｨ繧ｹ繝医い繧､繝峨Ν繧ｳ繝ｼ繝ｫ繝舌ャ繧ｯ・医・繝ｪ繝輔ぅ繝ｫ莉倥″・・
const requestIdleCallback = window.requestIdleCallback || function(cb) {
  const start = Date.now();
  return setTimeout(() => {
    cb({
      didTimeout: false,
      timeRemaining: () => Math.max(0, 50 - (Date.now() - start))
    });
  }, 1);
};

// 繝・ヰ繧ｦ繝ｳ繧ｹ貂医∩讀懃ｴ｢髢｢謨ｰ
const debouncedRenderProjects = debounce(() => {
  renderProjects();
  // 讀懃ｴ｢螻･豁ｴ繧剃ｿ晏ｭ・
  const query = document.getElementById('searchQuery')?.value.trim();
  if (query && query.length >= 2) {
    saveSearchHistory(query);
  }
}, 250);

// 繧ｳ繝ｳ繝・く繧ｹ繝医Γ繝九Η繝ｼ讖溯・
const ContextMenu = {
  currentProjectId: null,
  menu: null,

  init() {
    this.menu = document.getElementById('contextMenu');
    // 譯井ｻｶ繧ｫ繝ｼ繝峨・蜿ｳ繧ｯ繝ｪ繝・け繧､繝吶Φ繝医ｒ繝・Μ繧ｲ繝ｼ繝・
    document.addEventListener('contextmenu', (e) => {
      const card = e.target.closest('[data-project-id]');
      if (card && document.getElementById('projectsTab').contains(card)) {
        e.preventDefault();
        this.show(e.clientX, e.clientY, card.dataset.projectId);
      }
    });
    // 繧ｯ繝ｪ繝・け縺ｧ繝｡繝九Η繝ｼ繧帝哩縺倥ｋ
    document.addEventListener('click', () => this.hide());
  },

  show(x, y, projectId) {
    this.currentProjectId = projectId;
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    // 繝｡繝九Η繝ｼ鬆・岼繧貞虚逧・↓譖ｴ譁ｰ・・逡ｪ逶ｮ縺ｮ蟄占ｦ∫ｴ縺後い繝ｼ繧ｫ繧､繝夜・岼・・
    const archiveItem = this.menu.querySelector('.context-menu-item:nth-child(4)');
    if (archiveItem) {
      archiveItem.innerHTML = project.is_archived ? '唐 蠕ｩ蜈・ : '逃 螳御ｺ・ｸ医∩縺ｫ遘ｻ蜍・;
    }

    // 逕ｻ髱｢螟悶↓縺ｯ縺ｿ蜃ｺ縺輔↑縺・ｈ縺・↓菴咲ｽｮ隱ｿ謨ｴ
    this.menu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
    this.menu.style.top = Math.min(y, window.innerHeight - 250) + 'px';
    this.menu.classList.add('show');
  },

  hide() {
    if (this.menu) this.menu.classList.remove('show');
    this.currentProjectId = null;
  },

  edit() {
    if (this.currentProjectId) openProjectModal(this.currentProjectId);
    this.hide();
  },

  toggleSelect() {
    if (this.currentProjectId) BatchOperations.toggle(this.currentProjectId);
    this.hide();
  },

  archive() {
    if (this.currentProjectId) {
      const project = projects.find(p => p.id === this.currentProjectId);
      if (project) {
        toggleArchive(this.currentProjectId, !project.is_archived);
      }
    }
    this.hide();
  },

  delete() {
    if (this.currentProjectId) deleteProject(this.currentProjectId);
    this.hide();
  }
};

// 讀懃ｴ｢繧ｪ繝ｼ繝医さ繝ｳ繝励Μ繝ｼ繝域ｩ溯・
function getSearchHistory() {
  return safeJsonParse(localStorage.getItem('archideck_search_history'), []);
}

function saveSearchHistory(query) {
  let history = getSearchHistory();
  // 驥崎､・ｒ蜑企勁縺励※蜈磯ｭ縺ｫ霑ｽ蜉
  history = history.filter(h => h.toLowerCase() !== query.toLowerCase());
  history.unshift(query);
  // 譛螟ｧ20莉ｶ縺ｾ縺ｧ菫晄戟
  history = history.slice(0, 20);
  localStorage.setItem('archideck_search_history', JSON.stringify(history));
}

function updateSearchSuggestions() {
  const datalist = document.getElementById('searchSuggestions');
  if (!datalist) return;

  const history = getSearchHistory();
  // 鬘ｧ螳｢蜷堺ｸ隕ｧ繧貞叙蠕暦ｼ磯㍾隍・↑縺暦ｼ・
  const customers = [...new Set(projects.map(p => p.customer).filter(Boolean))];

  // 螻･豁ｴ縺ｨ鬘ｧ螳｢蜷阪ｒ邨ｱ蜷茨ｼ亥ｱ･豁ｴ蜆ｪ蜈茨ｼ・
  const suggestions = [...new Set([...history, ...customers])].slice(0, 15);

  datalist.innerHTML = suggestions.map(s => `<option value="${escapeHtml(s)}">`).join('');
}

// ============================================
// Undo/Redo 邂｡逅・
// ============================================
const UndoManager = {
  history: [],
  redoStack: [],
  maxHistory: 50,
  isUndoing: false,

  // 繧｢繧ｯ繧ｷ繝ｧ繝ｳ繧定ｨ倬鹸
  record(action) {
    if (this.isUndoing) return;

    this.history.push({
      ...action,
      timestamp: Date.now()
    });

    // 螻･豁ｴ縺ｮ荳企剞繧定ｶ・∴縺溘ｉ蜿､縺・ｂ縺ｮ繧貞炎髯､
    if (this.history.length > this.maxHistory) {
      this.history.shift();
    }

    // 譁ｰ縺励＞繧｢繧ｯ繧ｷ繝ｧ繝ｳ縺瑚ｨ倬鹸縺輔ｌ縺溘ｉRedo繧ｹ繧ｿ繝・け繧偵け繝ｪ繧｢
    this.redoStack = [];

    this.updateUI();
    log(`統 謫堺ｽ懆ｨ倬鹸: ${action.description}`, action);
  },

  // 蜈・↓謌ｻ縺・
  async undo() {
    if (this.history.length === 0) {
      showToast('蜈・↓謌ｻ縺呎桃菴懊′縺ゅｊ縺ｾ縺帙ｓ', 'info');
      return;
    }

    this.isUndoing = true;

    try {
      const action = this.history.pop();
      this.redoStack.push(action);

      await this.revert(action);

      showToast(`竊ｩ・・蜈・↓謌ｻ縺励∪縺励◆: ${action.description}`, 'success');
      announceToScreenReader(`蜈・↓謌ｻ縺励∪縺励◆: ${action.description}`);
    } catch (error) {
      logError('Undo螟ｱ謨・', error);
      showToast('蜈・↓謌ｻ縺呎桃菴懊↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
    } finally {
      this.isUndoing = false;
      this.updateUI();
    }
  },

  // 繧・ｊ逶ｴ縺・
  async redo() {
    if (this.redoStack.length === 0) {
      showToast('繧・ｊ逶ｴ縺呎桃菴懊′縺ゅｊ縺ｾ縺帙ｓ', 'info');
      return;
    }

    this.isUndoing = true;

    try {
      const action = this.redoStack.pop();
      this.history.push(action);

      await this.apply(action);

      showToast(`竊ｪ・・繧・ｊ逶ｴ縺励∪縺励◆: ${action.description}`, 'success');
      announceToScreenReader(`繧・ｊ逶ｴ縺励∪縺励◆: ${action.description}`);
    } catch (error) {
      logError('Redo螟ｱ謨・', error);
      showToast('繧・ｊ逶ｴ縺呎桃菴懊↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
    } finally {
      this.isUndoing = false;
      this.updateUI();
    }
  },

  // 繧｢繧ｯ繧ｷ繝ｧ繝ｳ繧貞・縺ｫ謌ｻ縺・
  async revert(action) {
    switch (action.type) {
      case 'UPDATE_PROJECT': {
        const { error } = await supabase
          .from('projects')
          .update(action.oldValue)
          .eq('id', action.projectId);
        if (error) throw new Error(`譯井ｻｶ譖ｴ譁ｰ螟ｱ謨・ ${error.message}`);
        // 繝ｭ繝ｼ繧ｫ繝ｫ繝・・繧ｿ繧よ峩譁ｰ
        const projectIdx = projects.findIndex(p => p.id === action.projectId);
        if (projectIdx !== -1) {
          Object.assign(projects[projectIdx], action.oldValue);
        }
        renderProjects();
        break;
      }

      case 'UPDATE_TASK': {
        const proj = projects.find(p => p.id === action.projectId);
        if (proj && proj.tasks) {
          proj.tasks[action.taskKey] = { ...action.oldValue };
          const { error } = await supabase
            .from('projects')
            .update({ tasks: proj.tasks })
            .eq('id', action.projectId);
          if (error) throw new Error(`繧ｿ繧ｹ繧ｯ譖ｴ譁ｰ螟ｱ謨・ ${error.message}`);
        }
        renderProjects();
        break;
      }

      case 'CREATE_PROJECT': {
        const { error } = await supabase.from('projects').delete().eq('id', action.projectId);
        if (error) throw new Error(`譯井ｻｶ蜑企勁螟ｱ謨・ ${error.message}`);
        projects = projects.filter(p => p.id !== action.projectId);
        renderProjects();
        renderSidebar();
        break;
      }

      case 'DELETE_PROJECT': {
        const { data, error } = await supabase
          .from('projects')
          .insert(action.oldValue)
          .select()
          .single();
        if (error) throw new Error(`譯井ｻｶ蠕ｩ蜈・､ｱ謨・ ${error.message}`);
        if (data) {
          projects.push(data);
        }
        renderProjects();
        renderSidebar();
        break;
      }

      case 'ARCHIVE_PROJECT': {
        const { error } = await supabase
          .from('projects')
          .update({ is_archived: action.oldValue })
          .eq('id', action.projectId);
        if (error) throw new Error(`繧｢繝ｼ繧ｫ繧､繝匁峩譁ｰ螟ｱ謨・ ${error.message}`);
        const archiveIdx = projects.findIndex(p => p.id === action.projectId);
        if (archiveIdx !== -1) {
          projects[archiveIdx].is_archived = action.oldValue;
        }
        renderProjects();
        renderSidebar();
        break;
      }

      default:
        warn('譛ｪ蟇ｾ蠢懊・繧｢繧ｯ繧ｷ繝ｧ繝ｳ繧ｿ繧､繝・', action.type);
    }
  },

  // 繧｢繧ｯ繧ｷ繝ｧ繝ｳ繧貞・驕ｩ逕ｨ
  async apply(action) {
    switch (action.type) {
      case 'UPDATE_PROJECT': {
        const { error } = await supabase
          .from('projects')
          .update(action.newValue)
          .eq('id', action.projectId);
        if (error) throw new Error(`譯井ｻｶ譖ｴ譁ｰ螟ｱ謨・ ${error.message}`);
        const projectIdx = projects.findIndex(p => p.id === action.projectId);
        if (projectIdx !== -1) {
          Object.assign(projects[projectIdx], action.newValue);
        }
        renderProjects();
        break;
      }

      case 'UPDATE_TASK': {
        const proj = projects.find(p => p.id === action.projectId);
        if (proj && proj.tasks) {
          proj.tasks[action.taskKey] = { ...action.newValue };
          const { error } = await supabase
            .from('projects')
            .update({ tasks: proj.tasks })
            .eq('id', action.projectId);
          if (error) throw new Error(`繧ｿ繧ｹ繧ｯ譖ｴ譁ｰ螟ｱ謨・ ${error.message}`);
        }
        renderProjects();
        break;
      }

      case 'CREATE_PROJECT': {
        const { data, error } = await supabase
          .from('projects')
          .insert(action.newValue)
          .select()
          .single();
        if (error) throw new Error(`譯井ｻｶ菴懈・螟ｱ謨・ ${error.message}`);
        if (data) {
          projects.push(data);
        }
        renderProjects();
        renderSidebar();
        break;
      }

      case 'DELETE_PROJECT': {
        const { error } = await supabase.from('projects').delete().eq('id', action.projectId);
        if (error) throw new Error(`譯井ｻｶ蜑企勁螟ｱ謨・ ${error.message}`);
        projects = projects.filter(p => p.id !== action.projectId);
        renderProjects();
        renderSidebar();
        break;
      }

      case 'ARCHIVE_PROJECT': {
        const { error } = await supabase
          .from('projects')
          .update({ is_archived: action.newValue })
          .eq('id', action.projectId);
        if (error) throw new Error(`繧｢繝ｼ繧ｫ繧､繝匁峩譁ｰ螟ｱ謨・ ${error.message}`);
        const archiveIdx = projects.findIndex(p => p.id === action.projectId);
        if (archiveIdx !== -1) {
          projects[archiveIdx].is_archived = action.newValue;
        }
        renderProjects();
        renderSidebar();
        break;
      }

      default:
        warn('譛ｪ蟇ｾ蠢懊・繧｢繧ｯ繧ｷ繝ｧ繝ｳ繧ｿ繧､繝・', action.type);
    }
  },

  // UI譖ｴ譁ｰ
  updateUI() {
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');

    if (undoBtn) {
      undoBtn.disabled = this.history.length === 0;
      undoBtn.title = this.history.length > 0
        ? `蜈・↓謌ｻ縺・ ${this.history[this.history.length - 1].description}`
        : '蜈・↓謌ｻ縺呎桃菴懊′縺ゅｊ縺ｾ縺帙ｓ';
    }

    if (redoBtn) {
      redoBtn.disabled = this.redoStack.length === 0;
      redoBtn.title = this.redoStack.length > 0
        ? `繧・ｊ逶ｴ縺・ ${this.redoStack[this.redoStack.length - 1].description}`
        : '繧・ｊ逶ｴ縺呎桃菴懊′縺ゅｊ縺ｾ縺帙ｓ';
    }
  },

  // 螻･豁ｴ繧偵け繝ｪ繧｢
  clear() {
    this.history = [];
    this.redoStack = [];
    this.updateUI();
  },

  // 謫堺ｽ懷庄閭ｽ縺九メ繧ｧ繝・け
  canUndo() {
    return this.history.length > 0;
  },

  canRedo() {
    return this.redoStack.length > 0;
  }
};

// ============================================
// Supabase蛻晄悄蛹・
// ============================================
const SUPABASE_URL = 'https://twzsirpfudqwboeyakta.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3enNpcnBmdWRxd2JvZXlha3RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MzM4NjgsImV4cCI6MjA3NzAwOTg2OH0.E_8GxfsO6Scjc0dDoEoyxq3i4lfvNxYZvnSL1OlSDSM';

// Supabase CDN縺ｮ繝ｭ繝ｼ繝臥｢ｺ隱・
if (!window.supabase) {
  logError('笶・Supabase CDN 縺瑚ｪｭ縺ｿ霎ｼ縺ｾ繧後※縺・∪縺帙ｓ・・);
  alert('Supabase CDN 縺瑚ｪｭ縺ｿ霎ｼ縺ｾ繧後※縺・∪縺帙ｓ縲ゅ・繝ｼ繧ｸ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ縺励※縺上□縺輔＞縲・);
}

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
log('笨・Supabase蛻晄悄蛹門ｮ御ｺ・', SUPABASE_URL);

// 繧ｰ繝ｭ繝ｼ繝舌Ν螟画焚
let currentUser = null;
let currentDesigner = null;
let currentUserCategory = null; // 'admin' | '險ｭ險・ | 'IC'
let projects = [];
let designers = [];

// 驛ｨ鄂ｲ繝槭せ繧ｿ・・ocalStorage邂｡逅・ｼ・
let departmentMaster = [];
const DEFAULT_DEPARTMENTS = ['豕ｨ譁・ｽ丞ｮ・ｺ区･ｭ驛ｨ', '荳榊虚逕｣莠区･ｭ驛ｨ', '螟匁ｧ倶ｺ区･ｭ驛ｨ', 'AX謌ｦ逡･驛ｨ'];
const OLD_DEFAULT_DEPARTMENTS = ['邨悟霧莨∫判驛ｨ', '繧ｷ繧ｹ繝・Β髢狗匱驛ｨ', '險ｭ險磯Κ', '蝟ｶ讌ｭ驛ｨ', '蟾･莠矩Κ', 'IC驛ｨ'];

function loadDepartmentMaster() {
  const saved = localStorage.getItem('departmentMaster');
  const version = localStorage.getItem('departmentMasterVersion');

  // 繝舌・繧ｸ繝ｧ繝ｳ2譛ｪ貅縺ｾ縺溘・譛ｪ險ｭ螳壹・蝣ｴ蜷医・蠑ｷ蛻ｶ逧・↓繝・ヵ繧ｩ繝ｫ繝亥､繧定ｨｭ螳・
  if (!version || parseInt(version) < 2) {
    departmentMaster = [...DEFAULT_DEPARTMENTS];
    saveDepartmentMaster();
    localStorage.setItem('departmentMasterVersion', '2');
    return;
  }

  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      // 譛牙柑縺ｪ驟榊・縺九▽遨ｺ縺ｧ縺ｪ縺・ｴ蜷医・縺ｿ菴ｿ逕ｨ
      if (Array.isArray(parsed) && parsed.length > 0) {
        departmentMaster = parsed;
      } else {
        departmentMaster = [...DEFAULT_DEPARTMENTS];
        saveDepartmentMaster();
      }
    } catch (e) {
      // JSON繝代・繧ｹ繧ｨ繝ｩ繝ｼ縺ｮ蝣ｴ蜷医・繝・ヵ繧ｩ繝ｫ繝亥､繧剃ｽｿ逕ｨ
      departmentMaster = [...DEFAULT_DEPARTMENTS];
      saveDepartmentMaster();
    }
  } else {
    departmentMaster = [...DEFAULT_DEPARTMENTS];
    saveDepartmentMaster();
  }
}

function saveDepartmentMaster() {
  localStorage.setItem('departmentMaster', JSON.stringify(departmentMaster));
}

function renderDepartmentChips() {
  const container = document.getElementById('departmentChips');
  if (!container) return;

  container.innerHTML = departmentMaster.map((dept, index) => `
    <span class="department-chip" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 16px; font-size: 13px;">
      ${escapeHtml(dept)}
      <button onclick="removeDepartment(${index})" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; line-height: 1; padding: 0 0 0 4px;">&times;</button>
    </span>
  `).join('');
}

function updateDepartmentDropdowns() {
  // departmentMaster縺檎ｩｺ縺ｮ蝣ｴ蜷医・蜈医↓隱ｭ縺ｿ霎ｼ繧
  if (!departmentMaster || departmentMaster.length === 0) {
    loadDepartmentMaster();
  }

  const selects = document.querySelectorAll('#newDesignerDepartmentInline, #editDesignerDepartment');
  selects.forEach(select => {
    const currentValue = select.value;
    const options = '<option value="">驛ｨ鄂ｲ繧帝∈謚・/option>' +
      departmentMaster.map(dept => `<option value="${escapeHtml(dept)}" ${currentValue === dept ? 'selected' : ''}>${escapeHtml(dept)}</option>`).join('');
    select.innerHTML = options;
  });
}

function addDepartment() {
  const input = document.getElementById('newDepartmentName');
  const name = input.value.trim();

  if (!name) {
    showToast('驛ｨ鄂ｲ蜷阪ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (departmentMaster.includes(name)) {
    showToast('譌｢縺ｫ蟄伜惠縺吶ｋ驛ｨ鄂ｲ蜷阪〒縺・, 'error');
    return;
  }

  departmentMaster.push(name);
  saveDepartmentMaster();
  renderDepartmentChips();
  updateDepartmentDropdowns();
  input.value = '';
  showToast('驛ｨ鄂ｲ繧定ｿｽ蜉縺励∪縺励◆', 'success');
}

function removeDepartment(index) {
  if (!confirm(`縲・{departmentMaster[index]}縲阪ｒ蜑企勁縺励∪縺吶°・歔)) return;

  departmentMaster.splice(index, 1);
  saveDepartmentMaster();
  renderDepartmentChips();
  updateDepartmentDropdowns();
  showToast('驛ｨ鄂ｲ繧貞炎髯､縺励∪縺励◆', 'success');
}

// IC髢｢騾｣螳壽焚
const IC_MAKER_TASKS = ['ic_kitchen', 'ic_bath', 'ic_washroom', 'ic_toilet', 'ic_lighting', 'ic_tategu', 'ic_curtain', 'ic_zousaku', 'ic_furniture', 'ic_iron', 'ic_other_estimate'];
const INTERNAL_STATUSES = ['繧ｪ繝ｪ繧ｸ繝翫Ν', 'GRAFTECT', '-', '']; // 遉ｾ蜀・ｯｾ蠢懊せ繝・・繧ｿ繧ｹ・医Γ繝ｼ繝ｫ荳崎ｦ・ｼ・

// IC蝗槫挨繧ｿ繧ｹ繧ｯ繧ｰ繝ｫ繝ｼ繝怜ｮ夂ｾｩ・・蝗樒岼縲・蝗樒岼・・
const IC_ROUNDS = [
  {
    round: 1,
    name: '1蝗樒岼',
    tasks: ['ic_funding_check', 'ic_exterior_pres', 'ic_interior_pres']
  },
  {
    round: 2,
    name: '2蝗樒岼',
    tasks: ['ic_kitchen', 'ic_bath', 'ic_washroom_1f', 'ic_washroom_2f', 'ic_toilet_1f', 'ic_toilet_2f', 'ic_lighting']
  },
  {
    round: 3,
    name: '3蝗樒岼',
    tasks: ['ic_spec_doc', 'ic_longterm_doc', 'ic_execution_drawing', 'ic_tategu', 'ic_tile_pres']
  },
  {
    round: 4,
    name: '4蝗樒岼',
    tasks: ['ic_exterior_meeting', 'ic_curtain', 'ic_zousaku', 'ic_furniture', 'ic_iron', 'ic_other_estimate']
  },
  {
    round: 5,
    name: '5蝗樒岼',
    tasks: ['ic_final_checklist', 'ic_op_check', 'ic_meeting_followup', 'ic_final_approval']
  }
];

let emailTemplates = [];
let vendors = [];
let taskMappings = {};
let currentDesignerTab = 'ALL';
let editingProjectId = null;
let editingTemplateId = null;
let editingVendorId = null;

// 譁ｰ繧ｷ繧ｹ繝・Β逕ｨ螟画焚
let vendorCategories = [];
let tasksV2 = [];
let vendorsV2 = [];
let taskVendorMappings = [];
let products = [];

// 繝槭Ν繝√ユ繝翫Φ繝亥ｯｾ蠢懶ｼ・aaS迚茨ｼ・
let currentOrganization = null;
let currentSubscription = null;

// FC繝｢繝ｼ繝会ｼ医ヵ繝ｩ繝ｳ繝√Ε繧､繧ｺ蜷代￠繝帙Ρ繧､繝医Λ繝吶Ν・・
let isFCMode = false;
let fcSlug = null;
let organizationSettings = null;

// 邨・ｹ疲ュ蝣ｱ繧定ｪｭ縺ｿ霎ｼ繧
async function loadOrganization() {
  // 蛟句挨繧ｯ繧ｨ繝ｪ縺ｮ繧ｿ繧､繝繧｢繧ｦ繝医Λ繝・ヱ繝ｼ
  const queryWithTimeout = async (queryPromise, label, timeoutMs = 5000) => {

    const timeout = new Promise((_, reject) =>
      setTimeout(() => {

        reject(new Error(`${label} timeout`));
      }, timeoutMs)
    );
    try {
      const result = await Promise.race([queryPromise, timeout]);

      return result;
    } catch (e) {

      throw e;
    }
  };

  try {
    const { data: memberData } = await queryWithTimeout(
      supabase
        .from('organization_members')
        .select('organization_id')
        .eq('user_id', currentUser.id)
        .eq('status', 'active')
        .single(),
      'memberData',
      5000
    );

    if (memberData) {
      const { data: orgData } = await queryWithTimeout(
        supabase
          .from('organizations')
          .select('*')
          .eq('id', memberData.organization_id)
          .single(),
        'orgData',
        5000
      );

      if (orgData) {
        currentOrganization = orgData;
        applyWhiteLabel(orgData);

        // 繧ｵ繝悶せ繧ｯ繝ｪ繝励す繝ｧ繝ｳ諠・ｱ
        const { data: subData } = await queryWithTimeout(
          supabase
            .from('subscriptions')
            .select('*')
            .eq('organization_id', orgData.id)
            .single(),
          'subData',
          5000
        );

        currentSubscription = subData;
        checkSubscriptionStatus(subData);
      }
    }

  } catch (error) {

    log('邨・ｹ疲ュ蝣ｱ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ繧偵せ繧ｭ繝・・・医ユ繝ｼ繝悶Ν譛ｪ菴懈・縺ｮ蜿ｯ閭ｽ諤ｧ・・);
  }
}

// 繝帙Ρ繧､繝医Λ繝吶Ν驕ｩ逕ｨ
function applyWhiteLabel(org) {
  if (!org) return;

  // 繝ｭ繧ｴ螟画峩
  if (org.logo_url) {
    const logoElements = document.querySelectorAll('.logo, .sidebar-logo');
    logoElements.forEach(el => {
      if (el.tagName === 'IMG') {
        el.src = org.logo_url;
      }
    });
  }

  // 繧ｫ繝ｩ繝ｼ螟画峩
  if (org.primary_color) {
    document.documentElement.style.setProperty('--primary-color', org.primary_color);
  }
  if (org.secondary_color) {
    document.documentElement.style.setProperty('--secondary-color', org.secondary_color);
  }

  // 繧ｿ繧､繝医Ν螟画峩
  if (org.name) {
    document.title = `ArchiDeck | ${org.name}`;
  }
}

// 繧ｵ繝悶せ繧ｯ繝ｪ繝励す繝ｧ繝ｳ迥ｶ諷九メ繧ｧ繝・け
function checkSubscriptionStatus(sub) {
  if (!sub) return;

  if (sub.status === 'trial') {
    const trialEnd = new Date(sub.trial_ends_at);
    const now = new Date();
    const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));

    if (daysLeft <= 3 && daysLeft > 0) {
      showToast(`繝医Λ繧､繧｢繝ｫ譛滄俣縺後≠縺ｨ${daysLeft}譌･縺ｧ邨ゆｺ・＠縺ｾ縺兪, 'warning');
    } else if (daysLeft <= 0) {
      showToast('繝医Λ繧､繧｢繝ｫ譛滄俣縺檎ｵゆｺ・＠縺ｾ縺励◆縲ゅ・繝ｩ繝ｳ繧偵い繝・・繧ｰ繝ｬ繝ｼ繝峨＠縺ｦ縺上□縺輔＞縲・, 'error');
    }
  } else if (sub.status === 'past_due') {
    showToast('縺頑髪謇輔＞縺碁≦蟒ｶ縺励※縺・∪縺吶らｮ｡逅・判髱｢縺ｧ遒ｺ隱阪＠縺ｦ縺上□縺輔＞縲・, 'error');
  }
}

// 辟｡髯舌Ν繝ｼ繝鈴亟豁｢繝輔Λ繧ｰ
let isHandlingHashChange = false;

// 諡・ｽ楢・・繧ｫ繝・ざ繝ｪ縺ｫ蠢懊§縺溘ち繧ｹ繧ｯ繝ｪ繧ｹ繝医ｒ蜿門ｾ暦ｼ域眠繧ｷ繧ｹ繝・Β・・
function getTasksForAssignee(assigneeName) {
  const designer = designers.find(d => d.name === assigneeName);
  const category = designer?.category || '險ｭ險・;

  // tasksV2縺檎ｩｺ縺ｮ蝣ｴ蜷医・遨ｺ驟榊・繧定ｿ斐☆
  if (!tasksV2 || tasksV2.length === 0) {
    warn('笞・・tasksV2繝・・繝悶Ν縺ｫ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ縲Ｎigration_customizable_system.sql繧貞ｮ溯｡後＠縺ｦ縺上□縺輔＞縲・);
    return [];
  }

  return tasksV2.filter(t => t.category === category).sort((a, b) => a.display_order - b.display_order);
}

// 繧ｫ繝・ざ繝ｪ蛻･縺ｮ繧ｿ繧ｹ繧ｯ螳夂ｾｩ繧貞叙蠕暦ｼ・upabase + localStorage邨ｱ蜷茨ｼ・
function getTasksForCategory(category) {
  // 縺ｾ縺嗾asksV2・・upabase・峨°繧牙叙蠕・
  const supabaseTasks = tasksV2.filter(t => t.category === category).sort((a, b) => a.display_order - b.display_order);
  if (supabaseTasks.length > 0) {
    return supabaseTasks;
  }

  // Supabase縺ｫ繝・・繧ｿ縺後↑縺・ｴ蜷医〕ocalStorage縺九ｉ蜿門ｾ暦ｼ亥､匁ｧ九・荳榊虚逕｣繝ｻ蟾･莠具ｼ・
  let localTasks = [];
  if (category === '螟匁ｧ・ && typeof exteriorTasks !== 'undefined' && Array.isArray(exteriorTasks)) {
    localTasks = exteriorTasks;
  } else if (category === '荳榊虚逕｣' && typeof realestateTasks !== 'undefined' && Array.isArray(realestateTasks)) {
    localTasks = realestateTasks;
  } else if (category === '蟾･莠・ && typeof constructionTasks !== 'undefined' && Array.isArray(constructionTasks)) {
    localTasks = constructionTasks;
  }

  // localStorage縺ｮ繧ｿ繧ｹ繧ｯ繧稚asksV2莠呈鋤縺ｮ蠖｢蠑上↓螟画鋤
  return localTasks.map((t, index) => ({
    id: t.id,
    task_key: t.id,
    task_name: t.name,
    category: category,
    display_order: t.order || index + 1,
    has_state: true,
    state_options: t.states,
    has_email_button: false
  }));
}

// 繧ｿ繧ｹ繧ｯ縺ｮ迥ｶ諷九が繝励す繝ｧ繝ｳ繧貞叙蠕暦ｼ域眠繧ｷ繧ｹ繝・Β・・
function getTaskStateOptions(taskKey) {
  // 縺ｾ縺嗾asksV2・・upabase・峨°繧画爾縺・
  const task = tasksV2.find(t => t.task_key === taskKey);
  if (task && task.has_state && task.state_options) {
    // JSON譁・ｭ怜・縺ｮ蝣ｴ蜷医・繝代・繧ｹ
    let options = task.state_options;
    if (typeof options === 'string') {
      try {
        options = JSON.parse(options);
      } catch (e) {
        return null;
      }
    }
    return options;
  }

  // localStorage繝吶・繧ｹ縺ｮ繧ｿ繧ｹ繧ｯ・亥､匁ｧ九・荳榊虚逕｣繝ｻ蟾･莠具ｼ峨°繧峨ｂ謗｢縺・
  if (typeof exteriorTasks !== 'undefined' && Array.isArray(exteriorTasks)) {
    const exteriorTask = exteriorTasks.find(t => t.id === taskKey);
    if (exteriorTask && exteriorTask.states) return exteriorTask.states;
  }

  if (typeof realestateTasks !== 'undefined' && Array.isArray(realestateTasks)) {
    const realestateTask = realestateTasks.find(t => t.id === taskKey);
    if (realestateTask && realestateTask.states) return realestateTask.states;
  }

  if (typeof constructionTasks !== 'undefined' && Array.isArray(constructionTasks)) {
    const constructionTask = constructionTasks.find(t => t.id === taskKey);
    if (constructionTask && constructionTask.states) return constructionTask.states;
  }

  return null;
}

// ============================================
// 隱崎ｨｼ蜃ｦ逅・
// ============================================

// 繝ｦ繝ｼ繧ｶ繝ｼ蜷阪・繧｢繝舌ち繝ｼ陦ｨ遉ｺ縺ｮ蜈ｱ騾夐未謨ｰ
function updateUserDisplay(displayName) {
  const userNameEl = document.getElementById('userName');
  const userAvatarEl = document.getElementById('userAvatar');
  if (userNameEl) userNameEl.textContent = displayName;
  if (userAvatarEl) userAvatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=4A90E2&color=fff&size=32`;
}

// 繝代せ繝ｯ繝ｼ繝牙・險ｭ螳啅I陦ｨ遉ｺ
function showForgotPassword() {
  document.getElementById('forgotPasswordSection').style.display = 'block';
  document.getElementById('forgotEmail').value = document.getElementById('loginEmail').value;
  document.getElementById('forgotEmail').focus();
}

function hideForgotPassword() {
  document.getElementById('forgotPasswordSection').style.display = 'none';
}

// 繝代せ繝ｯ繝ｼ繝牙・險ｭ螳壹Γ繝ｼ繝ｫ騾∽ｿ｡
async function sendPasswordReset() {
  const email = document.getElementById('forgotEmail').value.trim();

  if (!email) {
    showToast('繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ繧貞・蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (!window.supabase) {
    showToast('繧ｨ繝ｩ繝ｼ: 繧ｷ繧ｹ繝・Β縺悟・譛溷喧縺輔ｌ縺ｦ縺・∪縺帙ｓ', 'error');
    return;
  }

  // 遒ｺ隱阪ム繧､繧｢繝ｭ繧ｰ繧定｡ｨ遉ｺ
  if (!confirm(`繝代せ繝ｯ繝ｼ繝峨ｒ蜀咲匱陦後＠縺ｾ縺吶°・歃n\n${email} 螳帙↓繝代せ繝ｯ繝ｼ繝牙・險ｭ螳夂畑縺ｮ繝｡繝ｼ繝ｫ繧帝∽ｿ｡縺励∪縺吶・n繝｡繝ｼ繝ｫ蜀・・繝ｪ繝ｳ繧ｯ縺九ｉ譁ｰ縺励＞繝代せ繝ｯ繝ｼ繝峨ｒ險ｭ螳壹＠縺ｦ縺上□縺輔＞縲Ａ)) {
    return;
  }

  try {
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.origin
    });

    if (error) {
      logError('繝代せ繝ｯ繝ｼ繝峨Μ繧ｻ繝・ヨ繧ｨ繝ｩ繝ｼ:', error);
      showToast('繝｡繝ｼ繝ｫ騾∽ｿ｡縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
      return;
    }

    showToast('繝代せ繝ｯ繝ｼ繝牙・險ｭ螳夂畑縺ｮ繝｡繝ｼ繝ｫ繧帝∽ｿ｡縺励∪縺励◆縲ゅΓ繝ｼ繝ｫ繧偵＃遒ｺ隱阪￥縺縺輔＞縲・, 'success', 5000);
    hideForgotPassword();
  } catch (e) {
    logError('繝代せ繝ｯ繝ｼ繝峨Μ繧ｻ繝・ヨ萓句､・', e);
    showToast('繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆', 'error');
  }
}

// 繧｢繧ｫ繧ｦ繝ｳ繝域ュ蝣ｱ陦ｨ遉ｺ
function renderAccountInfo() {
  const emailEl = document.getElementById('accountEmail');
  const usernameEl = document.getElementById('accountUsername');

  if (currentUser) {
    if (emailEl) emailEl.textContent = currentUser.email || '-';
    if (usernameEl) usernameEl.textContent = currentUser.email?.split('@')[0] || '-';
  } else {
    if (emailEl) emailEl.textContent = '繝ｭ繧ｰ繧､繝ｳ縺励※縺・∪縺帙ｓ';
    if (usernameEl) usernameEl.textContent = '-';
  }
}

// 繝代せ繝ｯ繝ｼ繝牙､画峩
async function changePassword() {
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;

  // 繝舌Μ繝・・繧ｷ繝ｧ繝ｳ
  if (!newPassword) {
    showToast('譁ｰ縺励＞繝代せ繝ｯ繝ｼ繝峨ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  // 闍ｱ謨ｰ蟄玲ｷｷ蜷・譁・ｭ嶺ｻ･荳翫・繝√ぉ繝・け
  const hasLetter = /[a-zA-Z]/.test(newPassword);
  const hasNumber = /[0-9]/.test(newPassword);
  if (newPassword.length < 8 || !hasLetter || !hasNumber) {
    showToast('繝代せ繝ｯ繝ｼ繝峨・闍ｱ蟄励→謨ｰ蟄励ｒ蜷ｫ繧8譁・ｭ嶺ｻ･荳翫〒險ｭ螳壹＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (newPassword !== confirmPassword) {
    showToast('繝代せ繝ｯ繝ｼ繝峨′荳閾ｴ縺励∪縺帙ｓ', 'error');
    return;
  }

  if (!window.supabase) {
    showToast('繧ｨ繝ｩ繝ｼ: 繧ｷ繧ｹ繝・Β縺悟・譛溷喧縺輔ｌ縺ｦ縺・∪縺帙ｓ', 'error');
    return;
  }

  try {
    const { error } = await supabase.auth.updateUser({
      password: newPassword
    });

    if (error) {
      logError('繝代せ繝ｯ繝ｼ繝牙､画峩繧ｨ繝ｩ繝ｼ:', error);
      showToast('繝代せ繝ｯ繝ｼ繝牙､画峩縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
      return;
    }

    // 蜈･蜉帶ｬ・ｒ繧ｯ繝ｪ繧｢
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';

    showToast('繝代せ繝ｯ繝ｼ繝峨ｒ螟画峩縺励∪縺励◆', 'success');
  } catch (e) {
    logError('繝代せ繝ｯ繝ｼ繝牙､画峩萓句､・', e);
    showToast('繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆', 'error');
  }
}

// 繝代せ繝ｯ繝ｼ繝芽ｨｭ螳壹Δ繝ｼ繝繝ｫ繧定｡ｨ遉ｺ・亥・蝗槭Ο繧ｰ繧､繝ｳ/繝代せ繝ｯ繝ｼ繝峨Μ繧ｻ繝・ヨ逕ｨ・・
function showSetPasswordModal() {
  log('泊 繝代せ繝ｯ繝ｼ繝芽ｨｭ螳夂判髱｢繧定｡ｨ遉ｺ');
  document.getElementById('loginContainer').style.display = 'none';
  document.getElementById('mainContainer').classList.remove('show');
  document.getElementById('setPasswordContainer').style.display = 'flex';
}

// 譁ｰ縺励＞繝代せ繝ｯ繝ｼ繝峨ｒ菫晏ｭ假ｼ亥・蝗櫁ｨｭ螳夂畑・・
async function saveNewPassword() {
  const newPassword = document.getElementById('setNewPassword').value;
  const confirmPassword = document.getElementById('setConfirmPassword').value;

  // 繝舌Μ繝・・繧ｷ繝ｧ繝ｳ
  if (!newPassword) {
    showToast('譁ｰ縺励＞繝代せ繝ｯ繝ｼ繝峨ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  // 闍ｱ謨ｰ蟄玲ｷｷ蜷・譁・ｭ嶺ｻ･荳翫・繝√ぉ繝・け
  const hasLetter = /[a-zA-Z]/.test(newPassword);
  const hasNumber = /[0-9]/.test(newPassword);
  if (newPassword.length < 8 || !hasLetter || !hasNumber) {
    showToast('繝代せ繝ｯ繝ｼ繝峨・闍ｱ蟄励→謨ｰ蟄励ｒ蜷ｫ繧8譁・ｭ嶺ｻ･荳翫〒險ｭ螳壹＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (newPassword !== confirmPassword) {
    showToast('繝代せ繝ｯ繝ｼ繝峨′荳閾ｴ縺励∪縺帙ｓ', 'error');
    return;
  }

  if (!window.supabase) {
    showToast('繧ｨ繝ｩ繝ｼ: 繧ｷ繧ｹ繝・Β縺悟・譛溷喧縺輔ｌ縺ｦ縺・∪縺帙ｓ', 'error');
    return;
  }

  try {
    // 繧ｻ繝・す繝ｧ繝ｳ迥ｶ諷九ｒ遒ｺ隱・
    const { data: { session } } = await supabase.auth.getSession();
    log('泊 繝代せ繝ｯ繝ｼ繝芽ｨｭ螳壽凾縺ｮ繧ｻ繝・す繝ｧ繝ｳ:', session ? session.user.email : '縺ｪ縺・);

    if (!session) {
      showToast('繧ｻ繝・す繝ｧ繝ｳ縺檎┌蜉ｹ縺ｧ縺吶ゅΓ繝ｼ繝ｫ縺ｮ繝ｪ繝ｳ繧ｯ繧貞・蠎ｦ繧ｯ繝ｪ繝・け縺励※縺上□縺輔＞縲・, 'error');
      return;
    }

    const { error } = await supabase.auth.updateUser({
      password: newPassword
    });

    if (error) {
      logError('繝代せ繝ｯ繝ｼ繝芽ｨｭ螳壹お繝ｩ繝ｼ:', error);
      showToast('繝代せ繝ｯ繝ｼ繝芽ｨｭ螳壹↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
      return;
    }

    // 蜈･蜉帶ｬ・ｒ繧ｯ繝ｪ繧｢
    document.getElementById('setNewPassword').value = '';
    document.getElementById('setConfirmPassword').value = '';

    // 繝代せ繝ｯ繝ｼ繝芽ｨｭ螳夂判髱｢繧帝撼陦ｨ遉ｺ縺ｫ縺励※繝ｭ繧ｰ繧､繝ｳ逕ｻ髱｢縺ｸ
    document.getElementById('setPasswordContainer').style.display = 'none';
    document.getElementById('loginContainer').style.display = 'flex';

    showToast('繝代せ繝ｯ繝ｼ繝峨ｒ險ｭ螳壹＠縺ｾ縺励◆縲よ眠縺励＞繝代せ繝ｯ繝ｼ繝峨〒繝ｭ繧ｰ繧､繝ｳ縺励※縺上□縺輔＞縲・, 'success', 5000);
  } catch (e) {
    logError('繝代せ繝ｯ繝ｼ繝芽ｨｭ螳壻ｾ句､・', e);
    showToast('繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆', 'error');
  }
}

async function signIn() {


  const email = document.getElementById('loginEmail')?.value?.trim() || '';
  const password = document.getElementById('loginPassword')?.value?.trim() || '';



  if (!email) {

    showToast('繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ繧貞・蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (!password) {

    showToast('繝代せ繝ｯ繝ｼ繝峨ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (!window.supabase) {

    showToast('繧ｨ繝ｩ繝ｼ: Supabase縺悟・譛溷喧縺輔ｌ縺ｦ縺・∪縺帙ｓ縲ゅ・繝ｼ繧ｸ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ縺励※縺上□縺輔＞縲・, 'error');
    return;
  }

  try {

    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });


    if (error) {

      throw error;
    }


    // 繝ｭ繧ｰ繧､繝ｳ謌仙粥 - onAuthStateChange縺ｧ蜃ｦ逅・＆繧後ｋ縺ｮ縺ｧreload縺ｯ荳崎ｦ・
  } catch (error) {

    showToast('繝ｭ繧ｰ繧､繝ｳ縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
  }
}

async function signOut() {
  try {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
    location.reload();
  } catch (error) {
    logError('繝ｭ繧ｰ繧｢繧ｦ繝医お繝ｩ繝ｼ:', error);
    showToast('繝ｭ繧ｰ繧｢繧ｦ繝医↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
  }
}

// 繝・ヰ繝・げ陦ｨ遉ｺ・育判髱｢縺ｫ迥ｶ諷九ｒ陦ｨ遉ｺ・・
// debugShow removed - debugging complete

async function checkAuth() {


  try {
    // URL繝上ャ繧ｷ繝･縺ｫ繝代せ繝ｯ繝ｼ繝峨Μ繧ｫ繝舌Μ繝ｼ繝医・繧ｯ繝ｳ縺悟性縺ｾ繧後※縺・ｋ縺九メ繧ｧ繝・け
    const hashParams = window.location.hash.substring(1);


    // 繧ｨ繝ｩ繝ｼ縺後≠繧句ｴ蜷茨ｼ医Μ繝ｳ繧ｯ譛滄剞蛻・ｌ遲会ｼ・
    if (hashParams.includes('error=')) {
    const urlParams = new URLSearchParams(hashParams);
    const errorCode = urlParams.get('error_code');
    const errorDesc = urlParams.get('error_description');
    log('笶・隱崎ｨｼ繧ｨ繝ｩ繝ｼ:', errorCode, errorDesc);

    if (errorCode === 'otp_expired') {
      showToast('繝｡繝ｼ繝ｫ繝ｪ繝ｳ繧ｯ縺ｮ譛牙柑譛滄剞縺悟・繧後※縺・∪縺吶ゅ後ヱ繧ｹ繝ｯ繝ｼ繝峨ｒ蠢倥ｌ縺滓婿縲阪°繧牙・騾∽ｿ｡縺励※縺上□縺輔＞縲・, 'error', 8000);
    } else {
      showToast('隱崎ｨｼ繧ｨ繝ｩ繝ｼ: ' + (errorDesc || errorCode), 'error', 8000);
    }
    // 繧ｨ繝ｩ繝ｼ蠕後・繝ｭ繧ｰ繧､繝ｳ逕ｻ髱｢繧定｡ｨ遉ｺ
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('mainContainer').classList.remove('show');
    // URL縺九ｉ繧ｨ繝ｩ繝ｼ繝代Λ繝｡繝ｼ繧ｿ繧帝勁蜴ｻ
    history.replaceState(null, '', window.location.pathname);
    checkAuthCompleted = true;
    return;
  }

  const isRecoveryFlow = hashParams.includes('type=recovery') || hashParams.includes('type=signup');

  if (isRecoveryFlow) {
    log('泊 繝代せ繝ｯ繝ｼ繝峨Μ繧ｫ繝舌Μ繝ｼ繝輔Ο繝ｼ讀懷・ - 繧ｻ繝・す繝ｧ繝ｳ遒ｺ遶九ｒ蠕・ｩ・);
    // 繝ｪ繧ｫ繝舌Μ繝ｼ繝輔Ο繝ｼ縺ｮ蝣ｴ蜷医・縲ヾupabase縺後ヨ繝ｼ繧ｯ繝ｳ繧貞・逅・☆繧九・繧貞ｾ・▽
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('setPasswordContainer').style.display = 'flex';

    // Supabase縺後ヨ繝ｼ繧ｯ繝ｳ繧貞・逅・＠縺ｦ繧ｻ繝・す繝ｧ繝ｳ繧堤｢ｺ遶九☆繧九・繧貞ｾ・ｩ・
    let retryCount = 0;
    const maxRetries = 20; // 譛螟ｧ10遘貞ｾ・ｩ滂ｼ・00ms ﾃ・20・・
    const waitForSession = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        log('笨・繝ｪ繧ｫ繝舌Μ繝ｼ繧ｻ繝・す繝ｧ繝ｳ遒ｺ遶・', session.user.email);
        return;
      }
      retryCount++;
      if (retryCount < maxRetries) {
        log('竢ｳ 繧ｻ繝・す繝ｧ繝ｳ蠕・ｩ滉ｸｭ...', retryCount);
        await new Promise(resolve => setTimeout(resolve, 500));
        await waitForSession();
      } else {
        log('笶・繧ｻ繝・す繝ｧ繝ｳ遒ｺ遶九ち繧､繝繧｢繧ｦ繝・);
        showToast('繧ｻ繝・す繝ｧ繝ｳ縺ｮ遒ｺ遶九↓螟ｱ謨励＠縺ｾ縺励◆縲ゅΓ繝ｼ繝ｫ縺ｮ繝ｪ繝ｳ繧ｯ繧貞・蠎ｦ繧ｯ繝ｪ繝・け縺励※縺上□縺輔＞縲・, 'error');
        document.getElementById('setPasswordContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'flex';
      }
    };
    await waitForSession();
    checkAuthCompleted = true;
    return;
  }

    // 繧ｻ繝・す繝ｧ繝ｳ蜿門ｾ暦ｼ医ち繧､繝繧｢繧ｦ繝井ｻ倥″ - 繝上Φ繧ｰ蟇ｾ遲厄ｼ・

    let session = null;
    try {
      // 5遘偵〒繧ｿ繧､繝繧｢繧ｦ繝・
      const timeoutPromise = new Promise((_, reject) =>
        setTimeout(() => reject(new Error('getSession timeout')), 5000)
      );
      const sessionPromise = supabase.auth.getSession();

      const result = await Promise.race([sessionPromise, timeoutPromise]);
      session = result?.data?.session;
    } catch (sessionError) {

      // 繧ｿ繧､繝繧｢繧ｦ繝医∪縺溘・繧ｨ繝ｩ繝ｼ縺ｮ蝣ｴ蜷医∫憾諷九ｒ繝ｪ繧ｻ繝・ヨ縺励※繝ｭ繧ｰ繧､繝ｳ逕ｻ髱｢繧定｡ｨ遉ｺ


      // 驥崎ｦ・ 隱崎ｨｼ迥ｶ諷九ｒ繝ｪ繧ｻ繝・ヨ・域ｬ｡縺ｮ繝ｭ繧ｰ繧､繝ｳ隧ｦ陦後・縺溘ａ・・
      currentUser = null;
      currentDesigner = null;
      isAuthProcessing = false;

      try {
        // Supabase繧ｻ繝・す繝ｧ繝ｳ繧偵け繝ｪ繧｢・医Μ繝ｭ繝ｼ繝峨ｒ髦ｲ縺舌◆繧√ヵ繝ｩ繧ｰ險ｭ螳夲ｼ・
        isSilentSignOut = true;
        await supabase.auth.signOut();
        isSilentSignOut = false;
      } catch (e) {
        isSilentSignOut = false;

      }

      try {
        // 繝ｭ繝ｼ繧ｫ繝ｫ繧ｹ繝医Ξ繝ｼ繧ｸ繧ゅけ繝ｪ繧｢
        const keys = Object.keys(localStorage).filter(k => k.startsWith('sb-'));
        keys.forEach(k => localStorage.removeItem(k));
      } catch (e) {}

      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('mainContainer').classList.remove('show');
      checkAuthCompleted = true;  // 谺｡縺ｮ繝ｭ繧ｰ繧､繝ｳ縺ｧonAuthStateChange縺悟・逅・〒縺阪ｋ繧医≧縺ｫ

      return;
    }

    if (session && session.user) {

      currentUser = session.user;
      document.getElementById('loginContainer').style.display = 'none';


      // admin@ghouse.jp縺ｮ蝣ｴ蜷医・邂｡逅・・Δ繝ｼ繝峨〒逶ｴ謗･繝｡繧､繝ｳ逕ｻ髱｢縺ｸ
      if (currentUser.email === 'admin@ghouse.jp') {

        await selectAccountType('admin');

        return;
      }

      // 縺昴・莉悶・蝣ｴ蜷医・諡・ｽ捺ュ蝣ｱ繧貞叙蠕励＠縺ｦcategory繧貞愛螳・

      try {
        const designerTimeout = new Promise((_, reject) =>
          setTimeout(() => reject(new Error('designerData timeout')), 10000)
        );
        const designerQuery = supabase
          .from('designers')
          .select('*')
          .eq('email', currentUser.email)
          .single();

        const { data: designerData, error: designerError } = await Promise.race([designerQuery, designerTimeout]);



        if (designerError) {

        }

        if (designerData) {
          currentDesigner = designerData;
          currentUserCategory = designerData.category;


          if (!designerData.auth_confirmed) {
            await supabase.from('designers').update({ auth_confirmed: true }).eq('id', designerData.id);
            currentDesigner.auth_confirmed = true;
          }
        } else {

        }
      } catch (designerFetchError) {

      }

      // 繝｡繧､繝ｳ繧ｳ繝ｳ繝・リ繧定｡ｨ遉ｺ・郁ｪ崎ｨｼ謌仙粥蠕後↓蠢・★螳溯｡鯉ｼ・

      document.getElementById('mainContainer').classList.add('show');

      // 繝ｦ繝ｼ繧ｶ繝ｼ蜷阪・繧｢繝舌ち繝ｼ繧定｡ｨ遉ｺ
      updateUserDisplay(currentUser.email.split('@')[0]);


      try {
        await init();

      } catch (initError) {

      }

      // 蛻晄悄蛹門ｮ御ｺ・ｾ後↓URL逶ｴ謗･繧｢繧ｯ繧ｻ繧ｹ縺ｮ蜃ｦ逅・ｒ螳溯｡鯉ｼ・蝗槭□縺托ｼ・
      if (!window.location.hash || window.location.hash === '#') {
        window.location.hash = 'projects';
      }

      checkAuthCompleted = true;
    } else {

      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('mainContainer').classList.remove('show');
      checkAuthCompleted = true;
    }
  } catch (outerError) {

    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('mainContainer').classList.remove('show');
    checkAuthCompleted = true;
  }
}

// 隱崎ｨｼ蜃ｦ逅・ｸｭ繝輔Λ繧ｰ
let isAuthProcessing = false;
// 繧ｵ繧､繝ｬ繝ｳ繝医し繧､繝ｳ繧｢繧ｦ繝井ｸｭ繝輔Λ繧ｰ・医Μ繝ｭ繝ｼ繝蛾亟豁｢逕ｨ・・
let isSilentSignOut = false;
// checkAuth螳御ｺ・ヵ繝ｩ繧ｰ
let checkAuthCompleted = false;

// 隱崎ｨｼ迥ｶ諷句､画峩繧堤屮隕・
supabase.auth.onAuthStateChange(async (event, session) => {
  // checkAuthが完了するまでSIGNED_INを処理しない（競合防止）
  if (event === 'SIGNED_IN' && !checkAuthCompleted) {
    return;
  }

  if (event === 'SIGNED_IN' && session && session.user && !currentUser && !isAuthProcessing) {
    isAuthProcessing = true;


    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';


    // 笘・㍾隕・ 蜈医↓繝｡繧､繝ｳ繧ｳ繝ｳ繝・リ繧定｡ｨ遉ｺ・医ョ繝ｼ繧ｿ蜿門ｾ励′繝上Φ繧ｰ縺励※繧ら判髱｢縺ｯ隕九∴繧具ｼ・

    document.getElementById('mainContainer').classList.add('show');
    updateUserDisplay(currentUser.email.split('@')[0]);

    // admin@ghouse.jp縺ｮ蝣ｴ蜷医・邂｡逅・・Δ繝ｼ繝峨〒逶ｴ謗･繝｡繧､繝ｳ逕ｻ髱｢縺ｸ
    if (currentUser.email === 'admin@ghouse.jp') {

      currentUserCategory = 'admin';
      try {
        await init();

      } catch (e) {

      }
      isAuthProcessing = false;
      return;
    }

    // 縺昴・莉悶・蝣ｴ蜷医・諡・ｽ捺ュ蝣ｱ繧貞叙蠕励＠縺ｦcategory繧貞愛螳夲ｼ医ち繧､繝繧｢繧ｦ繝井ｻ倥″・・

    try {
      const timeoutPromise = new Promise((_, reject) =>
        setTimeout(() => reject(new Error('designerData timeout')), 5000)
      );
      const fetchPromise = supabase
        .from('designers')
        .select('*')
        .eq('email', currentUser.email)
        .single();

      const { data: designerData, error: designerError } = await Promise.race([fetchPromise, timeoutPromise]);



      if (designerError) {

      }

      if (designerData) {
        currentDesigner = designerData;
        currentUserCategory = designerData.category;

      } else {

      }
    } catch (designerFetchError) {

    }


    try {
      await init();

    } catch (initError) {

    }
    isAuthProcessing = false;

  } else if (event === 'PASSWORD_RECOVERY') {

    showSetPasswordModal();
  } else if (event === 'SIGNED_OUT') {
    if (isSilentSignOut) {

    } else {

      location.reload();
    }
  } else {

  }
});

// 繧｢繧ｫ繧ｦ繝ｳ繝医ち繧､繝鈴∈謚・
async function selectAccountType(category) {
  log('識 繧｢繧ｫ繧ｦ繝ｳ繝医ち繧､繝鈴∈謚・', category);
  currentUserCategory = category;
  document.getElementById('mainContainer').classList.add('show');

  // 繝ｦ繝ｼ繧ｶ繝ｼ蜷阪・繧｢繝舌ち繝ｼ繧定｡ｨ遉ｺ・医ョ繝｢繝｢繝ｼ繝牙ｯｾ蠢懶ｼ・
  const displayName = currentUser?.email ? currentUser.email.split('@')[0] : 'demo';
  updateUserDisplay(displayName);

  // 蛻・ｊ譖ｿ縺医・繧ｿ繝ｳ繧定｡ｨ遉ｺ
  updateCategorySwitchButton();

  await init();

  // 蛻晄悄蛹門ｮ御ｺ・ｾ後↓繝・ヵ繧ｩ繝ｫ繝医ち繝悶ｒ險ｭ螳夲ｼ・蝗槭□縺托ｼ・
  if (!window.location.hash || window.location.hash === '#') {
    window.location.hash = 'projects';
  }

  log('笨・繧｢繧ｫ繧ｦ繝ｳ繝医ち繧､繝鈴∈謚槫ｮ御ｺ・);
}

// 繧ｫ繝・ざ繝ｪ蛻・ｊ譖ｿ縺医・繧ｿ繝ｳ縺ｮ陦ｨ遉ｺ譖ｴ譁ｰ
function updateCategorySwitchButton() {
  const btn = document.getElementById('categorySwitchBtn');
  const label = document.getElementById('currentCategoryLabel');

  if (currentUserCategory === '險ｭ險・) {
    label.textContent = '盗 險ｭ險・;
  } else if (currentUserCategory === 'IC') {
    label.textContent = '耳 IC';
  } else if (currentUserCategory === '螟匁ｧ・) {
    label.textContent = '元 螟匁ｧ・;
  } else if (currentUserCategory === '荳榊虚逕｣') {
    label.textContent = '匠 荳榊虚逕｣';
  } else if (currentUserCategory === 'admin') {
    label.textContent = '荘 邂｡逅・・;
  }

  btn.style.display = 'block';
}

// 繧ｫ繝・ざ繝ｪ蛻・ｊ譖ｿ縺医Γ繝九Η繝ｼ縺ｮ髢矩哩
function toggleCategorySwitcher() {
  const menu = document.getElementById('categorySwitchMenu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// 繝｡繝九Η繝ｼ螟悶け繝ｪ繝・け縺ｧ髢峨§繧・
document.addEventListener('click', function(e) {
  const menu = document.getElementById('categorySwitchMenu');
  const btn = document.getElementById('categorySwitchBtn');
  if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
    menu.style.display = 'none';
  }
});

// 繧ｫ繝・ざ繝ｪ蛻・ｊ譖ｿ縺・
async function switchCategory(category) {
  log('売 繧ｫ繝・ざ繝ｪ蛻・ｊ譖ｿ縺・', category);

  // 繝｡繝九Η繝ｼ繧帝哩縺倥ｋ
  document.getElementById('categorySwitchMenu').style.display = 'none';

  // 蜷後§繧ｫ繝・ざ繝ｪ縺ｪ繧我ｽ輔ｂ縺励↑縺・
  if (currentUserCategory === category) {
    log('竢ｭ・・蜷後§繧ｫ繝・ざ繝ｪ縺ｮ縺溘ａ繧ｹ繧ｭ繝・・');
    return;
  }

  // 繧ｫ繝・ざ繝ｪ繧呈峩譁ｰ
  currentUserCategory = category;

  // 繝懊ち繝ｳ陦ｨ遉ｺ繧呈峩譁ｰ
  updateCategorySwitchButton();

  // 繝・・繧ｿ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ
  showStatus('隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...', 'saving');
  await init();

  showToast(`${category === 'admin' ? '邂｡逅・・ : category + '諡・ｽ・}逕ｻ髱｢縺ｫ蛻・ｊ譖ｿ縺医∪縺励◆`, 'success');
  log('笨・繧ｫ繝・ざ繝ｪ蛻・ｊ譖ｿ縺亥ｮ御ｺ・);
}

// ============================================
// FC繝｢繝ｼ繝会ｼ医ヵ繝ｩ繝ｳ繝√Ε繧､繧ｺ蜷代￠繝帙Ρ繧､繝医Λ繝吶Ν・・
// ============================================
function detectFCMode() {
  // URL繝代Λ繝｡繝ｼ繧ｿ縺九ｉFC繧ｹ繝ｩ繝・げ繧貞叙蠕・
  const urlParams = new URLSearchParams(window.location.search);
  const fcParam = urlParams.get('fc');

  // localStorage縺九ｉFC繝｢繝ｼ繝画ュ蝣ｱ繧貞叙蠕・
  const fcModeData = localStorage.getItem('fc_mode');

  if (fcParam) {
    isFCMode = true;
    fcSlug = fcParam;
    log('宵 FC繝｢繝ｼ繝画､懷・・・RL繝代Λ繝｡繝ｼ繧ｿ・・', fcSlug);
  } else if (fcModeData) {
    try {
      const fcConfig = JSON.parse(fcModeData);
      // 24譎る俣莉･蜀・・險ｭ螳壹・縺ｿ譛牙柑
      if (fcConfig.timestamp && (Date.now() - fcConfig.timestamp < 24 * 60 * 60 * 1000)) {
        isFCMode = true;
        fcSlug = fcConfig.slug;
        log('宵 FC繝｢繝ｼ繝画､懷・・・ocalStorage・・', fcSlug);
      }
    } catch (e) {
      warn('FC險ｭ螳壹・隗｣譫舌↓螟ｱ謨・', e);
    }
  }

  // FC繝｢繝ｼ繝峨・蝣ｴ蜷医・UI隱ｿ謨ｴ・磯撼蜷梧悄縺ｧ螳溯｡鯉ｼ・
  if (isFCMode) {
    applyFCMode().catch(e => warn('FC繝｢繝ｼ繝蛾←逕ｨ繧ｨ繝ｩ繝ｼ:', e));
  }
}

async function applyFCMode() {
  log('耳 FC繝｢繝ｼ繝蔚I驕ｩ逕ｨ荳ｭ...');

  // 邂｡逅・・・繧ｿ繝ｳ繧帝撼陦ｨ遉ｺ縺ｫ縺吶ｋCSS霑ｽ蜉
  const fcStyle = document.createElement('style');
  fcStyle.id = 'fc-mode-styles';
  fcStyle.textContent = `
    /* FC繝｢繝ｼ繝・ 邂｡逅・・未騾｣繧帝撼陦ｨ遉ｺ */
    .fc-hide { display: none !important; }

    /* 繧｢繧ｫ繧ｦ繝ｳ繝磯∈謚樒判髱｢縺ｮ邂｡逅・・・繧ｿ繝ｳ */
    button[onclick="selectAccountType('admin')"] { display: none !important; }

    /* 繧ｫ繝・ざ繝ｪ蛻・ｊ譖ｿ縺医・邂｡逅・・・繧ｿ繝ｳ */
    button[onclick="switchCategory('admin')"] { display: none !important; }

    /* 險ｭ螳夂判髱｢縺ｮ邂｡逅・・ｰら畑繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ */
    .admin-only-section { display: none !important; }

    /* 繝倥ャ繝繝ｼ縺ｮG繝上え繧ｹ繝ｭ繧ｴ */
    .header-logo-text .ghouse-text { display: none !important; }
  `;
  document.head.appendChild(fcStyle);

  // FC邨・ｹ疲ュ蝣ｱ繧奪B縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ
  let fcOrg = null;
  try {
    const { data, error } = await supabase
      .from('fc_organizations')
      .select('*')
      .eq('slug', fcSlug)
      .eq('is_active', true)
      .single();

    if (!error && data) {
      fcOrg = data;
      log('逃 FC邨・ｹ疲ュ蝣ｱ蜿門ｾ・', fcOrg.name);
    }
  } catch (e) {
    warn('FC邨・ｹ疲ュ蝣ｱ蜿門ｾ励お繝ｩ繝ｼ:', e);
  }

  // FC邨・ｹ斐・繧ｫ繧ｹ繧ｿ繝險ｭ螳壹ｒ驕ｩ逕ｨ
  if (fcOrg) {
    // 繧ｿ繧､繝医Ν險ｭ螳・
    document.title = fcOrg.name + ' | 險ｭ險域･ｭ蜍咏ｮ｡逅・す繧ｹ繝・Β';

    // 繝励Λ繧､繝槭Μ繧ｫ繝ｩ繝ｼ繧帝←逕ｨ
    if (fcOrg.primary_color) {
      document.documentElement.style.setProperty('--primary-color', fcOrg.primary_color);
    }

    // 繝ｭ繧ｴ繧帝←逕ｨ・医・繝・ム繝ｼ・・
    setTimeout(() => {
      const headerLogo = document.querySelector('.header-logo-text');
      if (headerLogo) {
        if (fcOrg.logo_url) {
          headerLogo.innerHTML = `<img src="${escapeHtml(fcOrg.logo_url)}" alt="${escapeHtml(fcOrg.name)}" style="height: 32px; vertical-align: middle;">`;
        } else {
          headerLogo.innerHTML = `<span style="color: var(--primary-color);">${escapeHtml(fcOrg.name)}</span>`;
        }
      }

      // 繝ｭ繧ｰ繧､繝ｳ逕ｻ髱｢縺ｮ繝ｭ繧ｴ繝・く繧ｹ繝医ｒ螟画峩
      const loginLogoText = document.querySelector('.login-logo-text');
      if (loginLogoText) {
        if (fcOrg.logo_url) {
          loginLogoText.innerHTML = `<img src="${escapeHtml(fcOrg.logo_url)}" alt="${escapeHtml(fcOrg.name)}" style="height: 48px;">`;
        } else {
          loginLogoText.innerHTML = `<span style="color: var(--primary-color);">${escapeHtml(fcOrg.name)}</span>`;
        }
      }

      // 險ｭ螳夂判髱｢縺ｧ邨・ｹ泌錐繧定｡ｨ遉ｺ
      const orgNameDisplay = document.getElementById('orgNameDisplay');
      if (orgNameDisplay) {
        orgNameDisplay.textContent = fcOrg.name;
      }
    }, 100);
  } else {
    // FC邨・ｹ斐′隕九▽縺九ｉ縺ｪ縺・ｴ蜷医・繝・ヵ繧ｩ繝ｫ繝郁ｨｭ螳・
    document.title = '險ｭ險域･ｭ蜍咏ｮ｡逅・す繧ｹ繝・Β';

    // 繝ｭ繧ｰ繧､繝ｳ逕ｻ髱｢縺ｮG繝上え繧ｹ陦ｨ遉ｺ繧帝撼陦ｨ遉ｺ
    const loginBranding = document.querySelector('#loginContainer p[style*="color: var(--text-muted)"]');
    if (loginBranding && loginBranding.textContent.includes('G繝上え繧ｹ')) {
      loginBranding.style.display = 'none';
    }

    // 繝ｭ繧ｰ繧､繝ｳ逕ｻ髱｢縺ｮ繝ｭ繧ｴ繝・く繧ｹ繝医ｒ螟画峩
    const loginLogoText = document.querySelector('.login-logo-text');
    if (loginLogoText) {
      loginLogoText.innerHTML = '<span style="color: var(--primary-color);">險ｭ險域･ｭ蜍・/span>邂｡逅・す繧ｹ繝・Β';
    }

    setTimeout(() => {
      const headerLogo = document.querySelector('.header-logo-text');
      if (headerLogo && headerLogo.innerHTML.includes('G繝上え繧ｹ')) {
        headerLogo.innerHTML = '<span style="color: var(--primary-color);">Archi</span>Deck';
      }

      const orgNameDisplay = document.getElementById('orgNameDisplay');
      if (orgNameDisplay && fcSlug) {
        orgNameDisplay.textContent = fcSlug + ' 蟆ら畑繧ｷ繧ｹ繝・Β';
      }
    }, 100);
  }

  log('笨・FC繝｢繝ｼ繝蔚I驕ｩ逕ｨ螳御ｺ・);
}

function exitFCMode() {
  localStorage.removeItem('fc_mode');
  isFCMode = false;
  fcSlug = null;
  // URL繝代Λ繝｡繝ｼ繧ｿ繧貞炎髯､縺励※繝ｪ繝ｭ繝ｼ繝・
  const url = new URL(window.location);
  url.searchParams.delete('fc');
  window.location.href = url.toString();
}

// ============================================
// 繧ｭ繝ｼ繝懊・繝峨す繝ｧ繝ｼ繝医き繝・ヨ
// ============================================
function initKeyboardShortcuts() {
  document.addEventListener('keydown', handleKeyboardShortcut);
}

function handleKeyboardShortcut(e) {
  // 繝｢繝ｼ繝繝ｫ縺碁幕縺・※縺・ｋ蝣ｴ蜷医・Escape繧ｭ繝ｼ
  if (e.key === 'Escape') {
    // .show 繧ｯ繝ｩ繧ｹ縺ｮ繝｢繝ｼ繝繝ｫ繧帝哩縺倥ｋ
    const openModals = document.querySelectorAll('.modal.show');
    openModals.forEach(modal => modal.classList.remove('show'));
    // 繧ｵ繧､繝峨ヰ繝ｼ繧帝哩縺倥ｋ
    closeSidebar();
    return;
  }

  // Ctrl/Cmd + 繧ｭ繝ｼ 縺ｮ繧ｷ繝ｧ繝ｼ繝医き繝・ヨ
  if (e.ctrlKey || e.metaKey) {
    switch (e.key.toLowerCase()) {
      case 'n':
        // 譁ｰ隕乗｡井ｻｶ菴懈・
        if (!isLoginScreen()) {
          e.preventDefault();
          showNewProjectModal();
        }
        break;
      case 's':
        // 菫晏ｭ假ｼ育樟蝨ｨ縺ｮ迥ｶ諷九ｒ蜷梧悄・・
        e.preventDefault();
        forceReloadData();
        showToast('繝・・繧ｿ繧貞酔譛溘＠縺ｾ縺励◆', 'success');
        break;
      case 'k':
        // 繧ｯ繧､繝・け讀懃ｴ｢
        e.preventDefault();
        const searchInput = document.querySelector('#searchQuery');
        if (searchInput) {
          searchInput.focus();
        }
        break;
      case 'z':
        // 蜈・↓謌ｻ縺・/ 繧・ｊ逶ｴ縺・
        e.preventDefault();
        if (e.shiftKey) {
          // Ctrl+Shift+Z = 繧・ｊ逶ｴ縺・
          UndoManager.redo();
        } else {
          // Ctrl+Z = 蜈・↓謌ｻ縺・
          UndoManager.undo();
        }
        break;
      case 'y':
        // Ctrl+Y = 繧・ｊ逶ｴ縺呻ｼ・indows讓呎ｺ厄ｼ・
        e.preventDefault();
        UndoManager.redo();
        break;
      case 'e':
        // Ctrl+E = CSV蜃ｺ蜉・
        if (!isLoginScreen()) {
          e.preventDefault();
          exportToCSV();
        }
        break;
      case 'a':
        // Ctrl+A = 蜈ｨ驕ｸ謚橸ｼ医ユ繧ｭ繧ｹ繝亥・蜉帑ｸｭ縺ｧ縺ｪ縺・ｴ蜷茨ｼ・
        if (!isLoginScreen() && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
          e.preventDefault();
          BatchOperations.selectAll();
        }
        break;
      case 'd':
        // Ctrl+Shift+D = 繝繝ｼ繧ｯ繝｢繝ｼ繝牙・繧頑崛縺・
        if (e.shiftKey) {
          e.preventDefault();
          toggleDarkMode();
        }
        break;
    }
  }

  // Shift + 繧ｭ繝ｼ 縺ｮ繧ｷ繝ｧ繝ｼ繝医き繝・ヨ
  if (e.shiftKey && !e.ctrlKey && !e.metaKey) {
    switch (e.key) {
      case '?':
        // 繧ｷ繝ｧ繝ｼ繝医き繝・ヨ繝倥Ν繝励ｒ陦ｨ遉ｺ
        showShortcutHelp();
        break;
    }
  }

  // 謨ｰ蟄励く繝ｼ縺ｧ繧ｿ繝門・繧頑崛縺茨ｼ亥・蜉帑ｸｭ縺ｧ縺ｪ縺・ｴ蜷茨ｼ・
  if (!e.ctrlKey && !e.metaKey && !e.shiftKey && !e.altKey) {
    if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'SELECT') {
      switch (e.key) {
        case '1':
          switchTab('projects');
          break;
        case '2':
          switchTab('analytics');
          break;
        case '3':
          switchTab('settings');
          break;
        case 'r':
          // 繝輔ぅ繝ｫ繧ｿ繝ｼ繝ｪ繧ｻ繝・ヨ
          e.preventDefault();
          resetAllFilters();
          break;
        case 'd':
          // 邨ｱ險医ム繝・す繝･繝懊・繝牙・繧頑崛縺・
          e.preventDefault();
          toggleStatsDashboard();
          break;
        case 'j':
          // 谺｡縺ｮ繧ｫ繝ｼ繝峨∈遘ｻ蜍・
          e.preventDefault();
          CardNavigation.next();
          break;
        case 'k':
          // 蜑阪・繧ｫ繝ｼ繝峨∈遘ｻ蜍・
          e.preventDefault();
          CardNavigation.prev();
          break;
        case 'Enter':
          // 驕ｸ謚槭き繝ｼ繝臥ｷｨ髮・
          if (CardNavigation.currentIndex >= 0) {
            e.preventDefault();
            CardNavigation.edit();
          }
          break;
        case 'x':
          // 繧ｫ繝ｼ繝蛾∈謚槭ヨ繧ｰ繝ｫ
          e.preventDefault();
          CardNavigation.toggleSelect();
          break;
      }
    }
  }
}

// 繧ｫ繝ｼ繝峨リ繝薙ご繝ｼ繧ｷ繝ｧ繝ｳ
const CardNavigation = {
  currentIndex: -1,

  getCards() {
    return [...document.querySelectorAll('#projectsContainer .project-card')];
  },

  highlightCard(index) {
    const cards = this.getCards();
    cards.forEach((card, i) => {
      card.classList.remove('keyboard-focused');
      if (i === index) {
        card.classList.add('keyboard-focused');
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
    this.currentIndex = index;
  },

  next() {
    const cards = this.getCards();
    if (cards.length === 0) return;
    const newIndex = this.currentIndex < cards.length - 1 ? this.currentIndex + 1 : 0;
    this.highlightCard(newIndex);
  },

  prev() {
    const cards = this.getCards();
    if (cards.length === 0) return;
    const newIndex = this.currentIndex > 0 ? this.currentIndex - 1 : cards.length - 1;
    this.highlightCard(newIndex);
  },

  edit() {
    const cards = this.getCards();
    if (this.currentIndex >= 0 && this.currentIndex < cards.length) {
      const projectId = cards[this.currentIndex].dataset.projectId;
      if (projectId) editProject(projectId);
    }
  },

  toggleSelect() {
    const cards = this.getCards();
    if (this.currentIndex >= 0 && this.currentIndex < cards.length) {
      const projectId = cards[this.currentIndex].dataset.projectId;
      if (projectId) BatchOperations.toggle(projectId);
    }
  },

  reset() {
    this.currentIndex = -1;
    this.getCards().forEach(card => card.classList.remove('keyboard-focused'));
  }
};

// 繝輔ぅ繝ｫ繧ｿ繝ｼ繝代ロ繝ｫ陦ｨ遉ｺ蛻・ｊ譖ｿ縺・
function toggleFilterPanel() {
  const panel = document.getElementById('filterPanel');
  const btn = document.getElementById('filterToggleBtn');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    btn.innerHTML = '半 邨櫁ｾｼ';
  } else {
    panel.style.display = 'none';
    btn.innerHTML = '反 邨櫁ｾｼ';
  }
}

// 繝輔ぅ繝ｫ繧ｿ繝ｼ繝ｪ繧ｻ繝・ヨ
function resetAllFilters() {
  const specFilter = document.getElementById('specFilter');
  const archiveFilter = document.getElementById('archiveFilter');
  const icProgressFilter = document.getElementById('icProgressFilter');
  const icAssigneeFilter = document.getElementById('icAssigneeFilter');
  const exteriorAssigneeFilter = document.getElementById('exteriorAssigneeFilter');
  const realestateAssigneeFilter = document.getElementById('realestateAssigneeFilter');
  const sourceFilter = document.getElementById('sourceFilter');
  const sortOrder = document.getElementById('sortOrder');
  const searchQuery = document.getElementById('searchQuery');

  if (specFilter) specFilter.value = '';
  if (archiveFilter) archiveFilter.value = 'active';
  if (icProgressFilter) icProgressFilter.value = '';
  if (icAssigneeFilter) icAssigneeFilter.value = '';
  if (exteriorAssigneeFilter) exteriorAssigneeFilter.value = '';
  if (realestateAssigneeFilter) realestateAssigneeFilter.value = '';
  if (sourceFilter) sourceFilter.value = '';
  if (sortOrder) sortOrder.value = 'updated_desc';
  if (searchQuery) searchQuery.value = '';

  renderProjects();
  showToast('繝輔ぅ繝ｫ繧ｿ繝ｼ繧偵Μ繧ｻ繝・ヨ縺励∪縺励◆', 'info');
}

// 繝繝ｼ繧ｯ繝｢繝ｼ繝牙・繧頑崛縺・
function toggleDarkMode() {
  const html = document.documentElement;
  const currentTheme = html.dataset.theme;
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

  html.dataset.theme = newTheme;
  localStorage.setItem('archideck_theme', newTheme);

  // 繝懊ち繝ｳ繧｢繧､繧ｳ繝ｳ譖ｴ譁ｰ
  const darkModeBtn = document.getElementById('darkModeBtn');
  if (darkModeBtn) {
    darkModeBtn.textContent = newTheme === 'dark' ? '笘・・ : '嫌';
  }

  showToast(newTheme === 'dark' ? '繝繝ｼ繧ｯ繝｢繝ｼ繝峨ｒ譛牙柑蛹悶＠縺ｾ縺励◆' : '繝ｩ繧､繝医Δ繝ｼ繝峨↓謌ｻ縺励∪縺励◆', 'info');
}

// 繝繝ｼ繧ｯ繝｢繝ｼ繝牙・譛溷喧
function initDarkMode() {
  const savedTheme = localStorage.getItem('archideck_theme');
  if (savedTheme === 'dark') {
    document.documentElement.dataset.theme = 'dark';
    const darkModeBtn = document.getElementById('darkModeBtn');
    if (darkModeBtn) {
      darkModeBtn.textContent = '笘・・;
    }
  }
}

function isLoginScreen() {
  const loginContainer = document.getElementById('loginContainer');
  return loginContainer && loginContainer.style.display !== 'none';
}

function showShortcutHelp() {
  const helpContent = `
    <div style="padding: 20px; max-height: 80vh; overflow-y: auto;">
      <h3 style="margin-bottom: 16px; font-size: 18px;">竚ｨ・・繧ｭ繝ｼ繝懊・繝峨す繝ｧ繝ｼ繝医き繝・ヨ</h3>
      <div style="display: grid; gap: 8px;">
        <div style="font-weight: 600; color: var(--primary-color); margin-top: 8px;">蝓ｺ譛ｬ謫堺ｽ・/div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + N</span><span>譁ｰ隕乗｡井ｻｶ菴懈・</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + S</span><span>繝・・繧ｿ蜷梧悄</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + K</span><span>讀懃ｴ｢縺ｫ繝輔か繝ｼ繧ｫ繧ｹ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Escape</span><span>繝｢繝ｼ繝繝ｫ繧帝哩縺倥ｋ</span>
        </div>
        <div style="font-weight: 600; color: var(--primary-color); margin-top: 8px;">繧ｿ繝門・繧頑崛縺・/div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>1</span><span>譯井ｻｶ繧ｿ繝・/span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>2</span><span>蛻・梵繧ｿ繝・/span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>3</span><span>險ｭ螳壹ち繝・/span>
        </div>
        <div style="font-weight: 600; color: var(--primary-color); margin-top: 8px;">繝輔ぅ繝ｫ繧ｿ繝ｼ繝ｻ陦ｨ遉ｺ</div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>R</span><span>繝輔ぅ繝ｫ繧ｿ繝ｼ繝ｪ繧ｻ繝・ヨ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>D</span><span>邨ｱ險医ム繝・す繝･繝懊・繝牙・繧頑崛縺・/span>
        </div>
        <div style="font-weight: 600; color: var(--primary-color); margin-top: 8px;">邱ｨ髮・・驕ｸ謚・/div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + Z</span><span>蜈・↓謌ｻ縺呻ｼ・ndo・・/span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + Shift + Z</span><span>繧・ｊ逶ｴ縺呻ｼ・edo・・/span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + A</span><span>蜈ｨ譯井ｻｶ驕ｸ謚・/span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + E</span><span>CSV蜃ｺ蜉・/span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + Shift + D</span><span>繝繝ｼ繧ｯ繝｢繝ｼ繝牙・繧頑崛縺・/span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Shift + ?</span><span>縺薙・繝倥Ν繝励ｒ陦ｨ遉ｺ</span>
        </div>
        <div style="font-weight: 600; color: var(--primary-color); margin-top: 8px;">繧ｫ繝ｼ繝峨リ繝薙ご繝ｼ繧ｷ繝ｧ繝ｳ</div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>J</span><span>谺｡縺ｮ繧ｫ繝ｼ繝峨∈遘ｻ蜍・/span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>K</span><span>蜑阪・繧ｫ繝ｼ繝峨∈遘ｻ蜍・/span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Enter</span><span>繧ｫ繝ｼ繝峨ｒ邱ｨ髮・/span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>X</span><span>繧ｫ繝ｼ繝蛾∈謚槭ヨ繧ｰ繝ｫ</span>
        </div>
      </div>
    </div>
  `;

  // 邁｡譏薙Δ繝ｼ繝繝ｫ縺ｧ陦ｨ遉ｺ
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
  modal.innerHTML = `
    <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 400px; width: 90%;">
      ${helpContent}
      <div style="padding: 0 20px 20px; text-align: right;">
        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">髢峨§繧・/button>
      </div>
    </div>
  `;
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });
  document.body.appendChild(modal);
}

// ============================================
// 蛻晄悄蛹・
// ============================================
async function init() {
  log('噫 蛻晄悄蛹夜幕蟋・..');

  showStatus('隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...', 'saving');

  // 繧ｭ繝ｼ繝懊・繝峨す繝ｧ繝ｼ繝医き繝・ヨ蛻晄悄蛹・
  initKeyboardShortcuts();

  // 繧ｳ繝ｳ繝・く繧ｹ繝医Γ繝九Η繝ｼ蛻晄悄蛹・
  ContextMenu.init();

  // 繧ｻ繝・す繝ｧ繝ｳ繧ｿ繧､繝繧｢繧ｦ繝亥・譛溷喧
  SessionManager.init();

  // FC繝｢繝ｼ繝画､懷・
  detectFCMode();


  try {
    // 繝槭Ν繝√ユ繝翫Φ繝・ 邨・ｹ疲ュ蝣ｱ繧貞・縺ｫ隱ｭ縺ｿ霎ｼ繧・医ち繧､繝繧｢繧ｦ繝井ｻ倥″・・

    const orgTimeout = new Promise((_, reject) =>
      setTimeout(() => reject(new Error('loadOrganization timeout')), 10000)
    );
    await Promise.race([loadOrganization(), orgTimeout]);


    log('逃 繝・・繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ髢句ｧ・..');


    // 蜈ｨ菴薙↓繧ｿ繧､繝繧｢繧ｦ繝医ｒ險ｭ螳夲ｼ・0遘抵ｼ・
    const dataLoadTimeout = new Promise((_, reject) =>
      setTimeout(() => reject(new Error('data load timeout')), 30000)
    );

    const dataLoadPromise = Promise.allSettled([
      loadDesigners(),
      loadCurrentDesigner(),
      loadProjects(),
      loadEmailTemplates(),
      loadVendors(),
      loadTaskMappings(),
      loadVendorCategories(),
      loadTasksV2(),
      loadVendorsV2(),
      loadTaskVendorMappings(),
      loadProducts(),
      loadFcOrganizations()
    ]);

    // 繧ｿ繧､繝繧｢繧ｦ繝井ｻ倥″縺ｧ蠕・ｩ・
    const results = await Promise.race([dataLoadPromise, dataLoadTimeout]);


    // 蜷・ｵ先棡繧堤｢ｺ隱・
    results.forEach((result, index) => {
      const names = ['繧ｹ繧ｿ繝・ヵ', '迴ｾ蝨ｨ縺ｮ繧ｹ繧ｿ繝・ヵ', '譯井ｻｶ', '繝・Φ繝励Ξ繝ｼ繝・, '讌ｭ閠・, '繧ｿ繧ｹ繧ｯ險ｭ螳・, '繧ｫ繝・ざ繝ｪ', '繧ｿ繧ｹ繧ｯV2', '讌ｭ閠・2', '繧ｿ繧ｹ繧ｯ讌ｭ閠・ｴ舌▼縺・, '蝠・刀', 'FC邨・ｹ・];
      if (result.status === 'rejected') {
        logError(`笶・${names[index]}縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ螟ｱ謨・`, result.reason);
      } else {
        log(`笨・${names[index]}縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ謌仙粥`);
      }
    });

    // 螟ｱ謨励＠縺溘ｂ縺ｮ縺後≠繧後・繧ｨ繝ｩ繝ｼ繧定｡ｨ遉ｺ
    const failedCount = results.filter(r => r.status === 'rejected').length;
    if (failedCount > 0) {
      warn(`笞・・${failedCount}莉ｶ縺ｮ繝・・繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆`);
      showToast(`${failedCount}莉ｶ縺ｮ繝・・繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆縲ゅさ繝ｳ繧ｽ繝ｼ繝ｫ繧堤｢ｺ隱阪＠縺ｦ縺上□縺輔＞縲Ａ, 'error');
    }

    // 讌ｭ閠・ョ繝ｼ繧ｿ縺ｨ繧ｫ繝・ざ繝ｪ繝・・繧ｿ繧偵・繝ｼ繧ｸ・井ｸ｡譁ｹ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺悟ｮ御ｺ・＠縺溷ｾ後↓螳溯｡鯉ｼ・
    mergeVendorCategories();

    // 驛ｨ鄂ｲ繝槭せ繧ｿ繧定ｪｭ縺ｿ霎ｼ縺ｿ

    loadDepartmentMaster();

    // IC繧ｿ繧ｹ繧ｯ閾ｪ蜍輔・繧､繧ｰ繝ｬ繝ｼ繧ｷ繝ｧ繝ｳ・・1鬆・岼譛ｪ貅縺ｮ蝣ｴ蜷茨ｼ・

    await autoMigrateICTasks();


    log('耳 逕ｻ髱｢謠冗判髢句ｧ・..');
    renderSidebar();

    // 繝ｭ繧ｰ繧､繝ｳ譎ゅ↓閾ｪ蛻・・諡・ｽ薙ち繝悶ｒ閾ｪ蜍暮∈謚橸ｼ・LL繧・ｻ悶・莠ｺ縺ｸ縺ｮ蛻・ｊ譖ｿ縺医ｂ蜿ｯ閭ｽ・・
    if (currentDesigner && currentDesigner.name) {
      log('側 閾ｪ蛻・・繧ｿ繝悶ｒ閾ｪ蜍暮∈謚・', currentDesigner.name);
      selectDesigner(currentDesigner.name);
    } else {
      renderProjects();
    }

    renderTemplates();
    renderVendorsV2();

    // 譁ｰ繧ｷ繧ｹ繝・Β縺ｮUI蛻晄悄蛹・
    populateVendorCategoryDropdown();
    populateProductDropdown();

    // 譁ｰ繧ｷ繧ｹ繝・Β縺ｮ蜷・ｮ｡逅・判髱｢縺ｮ蛻晄悄謠冗判
    log('耳 譁ｰ繧ｷ繧ｹ繝・Β謠冗判髢句ｧ・', {
      vendorsV2Length: vendorsV2.length,
      vendorCategoriesLength: vendorCategories.length,
      tasksV2Length: tasksV2.length,
      taskVendorMappingsLength: taskVendorMappings.length
    });

    renderDesignerListInline();  // 諡・ｽ鍋ｮ｡逅・
    renderCategoryFilters();      // 繧ｫ繝・ざ繝ｪ繝輔ぅ繝ｫ繧ｿ繝ｼ
    populateAssigneeFilters();    // 諡・ｽ楢・ヵ繧｣繝ｫ繧ｿ繝ｼ
    renderVendorsV2();            // 讌ｭ閠・ｮ｡逅・
    renderCategoriesList();       // 繧ｫ繝・ざ繝ｪ邂｡逅・
    renderTasksManagement();      // 繧ｿ繧ｹ繧ｯ邂｡逅・
    renderProductsList();         // 蝠・刀邂｡逅・


    // 繝｢繝舌う繝ｫ繧ｹ繝ｯ繧､繝励ず繧ｧ繧ｹ繝√Ε繝ｼ蛻晄悄蛹・
    MobileGestures.init();

    // 譛滄剞繝ｪ繝槭う繝ｳ繝繝ｼ縺ｮ繝√ぉ繝・け・・遘貞ｾ後↓螳溯｡鯉ｼ・
    setTimeout(() => {
      DeadlineManager.checkReminders();
    }, 3000);

    // kintone閾ｪ蜍募酔譛滂ｼ・遘貞ｾ後↓螳溯｡後∬ｨｭ螳壹＆繧後※縺・ｋ蝣ｴ蜷医・縺ｿ・・
    setTimeout(() => {
      autoSyncKintone();
    }, 5000);


    log('笨・蛻晄悄蛹門ｮ御ｺ・);
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');

    // 繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄繧帝幕蟋・
    setupRealtimeSync();

  } catch (error) {

    logError('笶・蛻晄悄蛹悶お繝ｩ繝ｼ:', error);
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('繝・・繧ｿ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
  }
}

// ============================================
// 繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄・亥酔譎よ磁邯壼ｯｾ蠢懶ｼ・
// ============================================
let realtimeChannel = null;

function setupRealtimeSync() {
  try {
    // 譌｢蟄倥・繝√Ε繝ｳ繝阪Ν縺後≠繧後・隗｣髯､
    if (realtimeChannel) {
      supabase.removeChannel(realtimeChannel);
    }

    log('売 繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄繧帝幕蟋・..');

    // 譯井ｻｶ繝・・繝悶Ν縺ｮ螟画峩繧堤屮隕・
    realtimeChannel = supabase
      .channel('realtime-sync')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'projects'
      }, (payload) => {
        handleProjectChange(payload);
      })
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'designers'
      }, (payload) => {
        handleDesignerChange(payload);
      })
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'project_tasks'
      }, (payload) => {
        handleTaskChange(payload);
      })
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'project_minutes'
      }, (payload) => {
        handleMinutesChange(payload);
      })
      .subscribe((status) => {
        if (status === 'SUBSCRIBED') {
          log('笨・繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄: 謗･邯壼ｮ御ｺ・);
        } else if (status === 'CHANNEL_ERROR') {
          log('笶・繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄: 謗･邯壹お繝ｩ繝ｼ');
        }
      });

  } catch (e) {
    logError('笶・繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄繧ｻ繝・ヨ繧｢繝・・繧ｨ繝ｩ繝ｼ:', e);
  }
}

// 譯井ｻｶ螟画峩繝上Φ繝峨Λ繝ｼ
function handleProjectChange(payload) {
  const { eventType, new: newRecord, old: oldRecord } = payload;
  log(`藤 繝ｪ繧｢繝ｫ繧ｿ繧､繝: projects ${eventType}`, payload);

  // 閾ｪ蛻・・霄ｫ縺ｮ螟画峩縺ｯ辟｡隕厄ｼ井ｺ碁㍾譖ｴ譁ｰ髦ｲ豁｢・・
  const lastLocalUpdate = localStorage.getItem('lastProjectUpdate');
  if (lastLocalUpdate && newRecord?.id) {
    const parsed = safeJsonParse(lastLocalUpdate, {});
    if (parsed.id === newRecord.id && Date.now() - parsed.time < 2000) {
      log('竢ｭ・・閾ｪ蛻・・螟画峩繧偵せ繧ｭ繝・・');
      return;
    }
  }

  switch (eventType) {
    case 'INSERT':
      // 譁ｰ隕乗｡井ｻｶ縺瑚ｿｽ蜉縺輔ｌ縺・
      if (newRecord && !projects.find(p => p.id === newRecord.id)) {
        projects.push(newRecord);
        showToast(`譁ｰ隕乗｡井ｻｶ縺瑚ｿｽ蜉縺輔ｌ縺ｾ縺励◆: ${newRecord.customer}`, 'info', 3000);
        renderSidebar();
        renderProjects();
      }
      break;

    case 'UPDATE':
      // 譯井ｻｶ縺梧峩譁ｰ縺輔ｌ縺・
      if (newRecord) {
        const idx = projects.findIndex(p => p.id === newRecord.id);
        if (idx !== -1) {
          const oldData = projects[idx];
          projects[idx] = { ...oldData, ...newRecord };

          // 驥崎ｦ√↑螟画峩縺後≠縺｣縺溷ｴ蜷医・縺ｿ騾夂衍
          if (oldData.is_archived !== newRecord.is_archived ||
              oldData.assigned_to !== newRecord.assigned_to ||
              oldData.ic_assignee !== newRecord.ic_assignee) {
            showToast(`譯井ｻｶ縺梧峩譁ｰ縺輔ｌ縺ｾ縺励◆: ${newRecord.customer}`, 'info', 2000);
          }

          renderSidebar();
          renderProjects();
        }
      }
      break;

    case 'DELETE':
      // 譯井ｻｶ縺悟炎髯､縺輔ｌ縺・
      if (oldRecord) {
        const idx = projects.findIndex(p => p.id === oldRecord.id);
        if (idx !== -1) {
          projects.splice(idx, 1);
          showToast(`譯井ｻｶ縺悟炎髯､縺輔ｌ縺ｾ縺励◆: ${oldRecord.customer}`, 'warning', 3000);
          renderSidebar();
          renderProjects();
        }
      }
      break;
  }
}

// 諡・ｽ灘､画峩繝上Φ繝峨Λ繝ｼ
function handleDesignerChange(payload) {
  const { eventType, new: newRecord, old: oldRecord } = payload;
  log(`藤 繝ｪ繧｢繝ｫ繧ｿ繧､繝: designers ${eventType}`, payload);

  switch (eventType) {
    case 'INSERT':
      if (newRecord && !designers.find(d => d.id === newRecord.id)) {
        designers.push(newRecord);
        renderSidebar();
        populateAssigneeFilters();
      }
      break;

    case 'UPDATE':
      if (newRecord) {
        const idx = designers.findIndex(d => d.id === newRecord.id);
        if (idx !== -1) {
          designers[idx] = { ...designers[idx], ...newRecord };
          renderSidebar();
          populateAssigneeFilters();
        }
      }
      break;

    case 'DELETE':
      if (oldRecord) {
        const idx = designers.findIndex(d => d.id === oldRecord.id);
        if (idx !== -1) {
          designers.splice(idx, 1);
          renderSidebar();
          populateAssigneeFilters();
        }
      }
      break;
  }
}

// 繧ｿ繧ｹ繧ｯ螟画峩繝上Φ繝峨Λ繝ｼ
function handleTaskChange(payload) {
  const { eventType, new: newRecord } = payload;
  log(`藤 繝ｪ繧｢繝ｫ繧ｿ繧､繝: project_tasks ${eventType}`, payload);

  // 繧ｿ繧ｹ繧ｯ縺悟､画峩縺輔ｌ縺滓｡井ｻｶ繧貞・謠冗判
  if (newRecord && newRecord.project_id) {
    const projectCard = document.querySelector(`[data-project-id="${newRecord.project_id}"]`);
    if (projectCard) {
      // 繧ｿ繧ｹ繧ｯ繝ｪ繧ｹ繝医ｒ蜀崎ｪｭ縺ｿ霎ｼ縺ｿ
      loadProjectTasks(newRecord.project_id);
    }
  }
}

// 隴ｰ莠矩鹸螟画峩繝上Φ繝峨Λ繝ｼ
function handleMinutesChange(payload) {
  const { eventType, new: newRecord } = payload;
  log(`藤 繝ｪ繧｢繝ｫ繧ｿ繧､繝: project_minutes ${eventType}`, payload);

  // 隴ｰ莠矩鹸縺悟､画峩縺輔ｌ縺滓｡井ｻｶ繧貞・謠冗判
  if (newRecord && newRecord.project_id) {
    const projectCard = document.querySelector(`[data-project-id="${newRecord.project_id}"]`);
    if (projectCard) {
      loadProjectMinutes(newRecord.project_id);
    }
  }
}

// 閾ｪ蛻・・螟画峩繧定ｨ倬鹸・医Μ繧｢繝ｫ繧ｿ繧､繝蜷梧悄縺ｧ縺ｮ莠碁㍾譖ｴ譁ｰ髦ｲ豁｢逕ｨ・・
function markLocalUpdate(projectId) {
  localStorage.setItem('lastProjectUpdate', JSON.stringify({
    id: projectId,
    time: Date.now()
  }));
}

// ============================================
// 繝・・繧ｿ蠑ｷ蛻ｶ繝ｪ繝ｭ繝ｼ繝・
// ============================================
let isReloading = false;

async function forceReloadData() {
  // 驥崎､・ｮ溯｡碁亟豁｢
  if (isReloading) {
    showToast('蜀崎ｪｭ縺ｿ霎ｼ縺ｿ荳ｭ縺ｧ縺・..', 'info');
    return;
  }

  isReloading = true;

  // 繝懊ち繝ｳ繧堤┌蜉ｹ蛹・
  const reloadBtns = document.querySelectorAll('[onclick*="forceReloadData"]');
  reloadBtns.forEach(btn => {
    btn.disabled = true;
    btn.style.opacity = '0.5';
  });

  try {
    showStatus('繧ｭ繝｣繝・す繝･繧ｯ繝ｪ繧｢荳ｭ...', 'saving');

    // 繧ｭ繝｣繝・す繝･繧偵け繝ｪ繧｢
    try {
      const cacheNames = await caches.keys();
      for (const name of cacheNames) {
        await caches.delete(name);
      }
    } catch (e) {
      warn('繧ｭ繝｣繝・す繝･繧ｯ繝ｪ繧｢繧ｨ繝ｩ繝ｼ:', e);
    }

    showStatus('繝・・繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...', 'saving');

    // 繝・・繧ｿ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ
    await init();

    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast(`繝・・繧ｿ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ縺励∪縺励◆縲よ｡井ｻｶ謨ｰ: ${projects.length}莉ｶ`, 'success');
  } catch (error) {
    logError('蜀崎ｪｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('蜀崎ｪｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆', 'danger');
  } finally {
    isReloading = false;
    // 繝懊ち繝ｳ繧貞・譛牙柑蛹・
    reloadBtns.forEach(btn => {
      btn.disabled = false;
      btn.style.opacity = '1';
    });
  }
}

// ============================================
// 繝・ヰ繝・げ諠・ｱ陦ｨ遉ｺ・医・繝・・繧｢繝・・・・
// ============================================
async function showDebugInfo() {
  // 繝・・繧ｿ繝吶・繧ｹ縺ｫ逶ｴ謗･繧｢繧ｯ繧ｻ繧ｹ縺励※莉ｶ謨ｰ繧堤｢ｺ隱・
  let dbProjectsCount = '蜿門ｾ嶺ｸｭ...';
  let dbDesignersCount = '蜿門ｾ嶺ｸｭ...';
  let dbError = null;

  try {
    const projectsResult = await supabase.from('projects').select('id', { count: 'exact', head: true });
    const designersResult = await supabase.from('designers').select('id', { count: 'exact', head: true });

    dbProjectsCount = projectsResult.count ?? `繧ｨ繝ｩ繝ｼ: ${projectsResult.error?.message}`;
    dbDesignersCount = designersResult.count ?? `繧ｨ繝ｩ繝ｼ: ${designersResult.error?.message}`;

    if (projectsResult.error) dbError = projectsResult.error;
    if (designersResult.error) dbError = designersResult.error;
  } catch (e) {
    dbError = e;
  }

  const info = `
ArchiDeck 繝・ヰ繝・げ諠・ｱ
========================
繝舌・繧ｸ繝ｧ繝ｳ: ${APP_VERSION}
繝ｦ繝ｼ繧ｶ繝ｼ: ${currentUser?.email || '譛ｪ繝ｭ繧ｰ繧､繝ｳ'}
繧ｫ繝・ざ繝ｪ: ${currentUserCategory || '譛ｪ驕ｸ謚・}
諡・ｽ薙ち繝・ ${currentDesignerTab}

繝｡繝｢繝ｪ荳翫・繝・・繧ｿ
----------------
譯井ｻｶ謨ｰ: ${projects.length}莉ｶ
諡・ｽ捺焚: ${designers.length}莠ｺ
繧ｿ繧ｹ繧ｯ謨ｰ: ${tasksV2.length}莉ｶ
讌ｭ閠・焚: ${vendorsV2.length}莉ｶ

繝・・繧ｿ繝吶・繧ｹ逶ｴ謗･遒ｺ隱・
--------------------
DB譯井ｻｶ謨ｰ: ${dbProjectsCount}莉ｶ
DB諡・ｽ捺焚: ${dbDesignersCount}莠ｺ
${dbError ? `DB繧ｨ繝ｩ繝ｼ: ${dbError.message || dbError}` : ''}

譯井ｻｶ隧ｳ邏ｰ
--------
${projects.slice(0, 5).map(p => `繝ｻ${p.customer} (險ｭ險・${p.assigned_to || '譛ｪ蜑ｲ蠖・}, IC:${p.ic_assignee || '譛ｪ蜑ｲ蠖・})`).join('\n')}
${projects.length > 5 ? `...莉・{projects.length - 5}莉ｶ` : ''}
${projects.length === 0 ? '・域｡井ｻｶ繝・・繧ｿ縺ｪ縺暦ｼ・ : ''}

諡・ｽ楢ｩｳ邏ｰ
----------
${designers.slice(0, 5).map(d => `繝ｻ${d.name} (${d.category})`).join('\n')}
${designers.length > 5 ? `...莉・{designers.length - 5}莠ｺ` : ''}
${designers.length === 0 ? '・域球蠖薙ョ繝ｼ繧ｿ縺ｪ縺暦ｼ・ : ''}

繧｢繝ｼ繧ｫ繧､繝也憾豕・
--------------
繧｢繧ｯ繝・ぅ繝・ ${projects.filter(p => !p.is_archived).length}莉ｶ
螳御ｺ・ｸ医∩: ${projects.filter(p => p.is_archived).length}莉ｶ

繝輔ぅ繝ｫ繧ｿ繝ｼ
----------
繧｢繝ｼ繧ｫ繧､繝悶ヵ繧｣繝ｫ繧ｿ繝ｼ: ${document.getElementById('archiveFilter')?.value || '荳肴・'}
讀懃ｴ｢: ${document.getElementById('searchQuery')?.value || '縺ｪ縺・}
蝠・刀: ${document.getElementById('specFilter')?.value || '蜈ｨ縺ｦ'}

RLS豕ｨ諢・
-------
繝・・繧ｿ繝吶・繧ｹ縺ｫ謨ｰ縺後≠縺｣縺ｦ繧ゅΓ繝｢繝ｪ縺・縺ｮ蝣ｴ蜷医・
RLS(Row Level Security)縺後ョ繝ｼ繧ｿ繧偵ヶ繝ｭ繝・け縺励※縺・ｋ
蜿ｯ閭ｽ諤ｧ縺後≠繧翫∪縺吶４upabase邂｡逅・判髱｢縺ｧRLS險ｭ螳壹ｒ遒ｺ隱阪＠縺ｦ縺上□縺輔＞縲・
  `.trim();

  alert(info);
  log(info);

  // 繝・・繧ｿ縺・莉ｶ縺ｮ蝣ｴ蜷医・隴ｦ蜻翫ｒ陦ｨ遉ｺ
  if (projects.length === 0 || designers.length === 0) {
    logError('圷 繝・・繧ｿ豸亥､ｱ蝠城｡梧､懷・・・);
    logError('Supabase縺ｮ繝繝・す繝･繝懊・繝峨〒莉･荳九ｒ遒ｺ隱阪＠縺ｦ縺上□縺輔＞:');
    logError('1. projects繝・・繝悶Ν縺ｫ繝・・繧ｿ縺後≠繧九°');
    logError('2. designers繝・・繝悶Ν縺ｫ繝・・繧ｿ縺後≠繧九°');
    logError('3. RLS繝昴Μ繧ｷ繝ｼ縺梧ｭ｣縺励￥險ｭ螳壹＆繧後※縺・ｋ縺・);
    logError('4. anon key縺ｫ驕ｩ蛻・↑讓ｩ髯舌′縺ゅｋ縺・);
  }
}

// ============================================
// 繝・ヰ繝・げ逕ｨ繧ｰ繝ｭ繝ｼ繝舌Ν髢｢謨ｰ
// ============================================
// 繧ｳ繝ｳ繧ｽ繝ｼ繝ｫ縺ｧ debug() 繧貞ｮ溯｡後☆繧九→縲∝・繝・・繧ｿ縺ｮ隧ｳ邏ｰ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・
window.debug = function() {
  log('='.repeat(80));
  log('剥 繝・ヰ繝・げ諠・ｱ');
  log('='.repeat(80));

  log('\n投 蝓ｺ譛ｬ諠・ｱ:');
  log('  - 諡・ｽ捺焚:', designers.length);
  log('  - 譯井ｻｶ謨ｰ:', projects.length);
  log('  - 繧ｿ繧ｹ繧ｯ謨ｰ:', tasksV2.length);
  log('  - 讌ｭ閠・焚:', vendorsV2.length);

  log('\n則 諡・ｽ謎ｸ隕ｧ:');
  designers.forEach(d => {
    log(`  - [${d.category}] ${d.name} (${d.email})`);
  });

  log('\n搭 譯井ｻｶ荳隕ｧ:');
  projects.forEach(p => {
    log(`  - ${p.customer}`);
    log(`    險ｭ險・ "${p.assigned_to}" (trim: "${(p.assigned_to || '').trim()}")`);
    log(`    IC: "${p.ic_assignee}" (trim: "${(p.ic_assignee || '').trim()}")`);
    log(`    status: ${p.status}, is_archived: ${p.is_archived}`);
  });

  log('\n' + '='.repeat(80));
  return '繝・ヰ繝・げ諠・ｱ繧貞・蜉帙＠縺ｾ縺励◆縲ゆｸ願ｨ倥ｒ遒ｺ隱阪＠縺ｦ縺上□縺輔＞縲・;
};

// 繧ｳ繝ｳ繧ｽ繝ｼ繝ｫ縺ｧ checkAssignment('諡・ｽ楢・錐', '譯井ｻｶ蜷・) 繧貞ｮ溯｡後☆繧九→縲∬ｩｳ邏ｰ繝√ぉ繝・け縺後〒縺阪∪縺・
window.checkAssignment = function(designerName, projectName) {
  log('='.repeat(80));
  log(`剥 蜑ｲ繧雁ｽ薙※繝√ぉ繝・け: ${designerName} 竊・${projectName}`);
  log('='.repeat(80));

  const designer = designers.find(d => d.name.includes(designerName));
  if (!designer) {
    logError(`笶・諡・ｽ・"${designerName}" 縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ`);
    log('逋ｻ骭ｲ縺輔ｌ縺ｦ縺・ｋ諡・ｽ・', designers.map(d => d.name));
    return;
  }

  const project = projects.find(p => p.customer.includes(projectName));
  if (!project) {
    logError(`笶・譯井ｻｶ "${projectName}" 縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ`);
    log('逋ｻ骭ｲ縺輔ｌ縺ｦ縺・ｋ譯井ｻｶ:', projects.map(p => p.customer));
    return;
  }

  log('\n笨・繝・・繧ｿ遒ｺ隱・');
  log('諡・ｽ捺ュ蝣ｱ:', {
    name: designer.name,
    nameLength: designer.name.length,
    nameTrimmed: designer.name.trim(),
    category: designer.category,
    email: designer.email
  });

  log('\n譯井ｻｶ諠・ｱ:', {
    customer: project.customer,
    assigned_to: `"${project.assigned_to}"`,
    assigned_to_length: project.assigned_to?.length,
    assigned_to_trimmed: `"${(project.assigned_to || '').trim()}"`,
    ic_assignee: `"${project.ic_assignee}"`,
    ic_assignee_length: project.ic_assignee?.length,
    ic_assignee_trimmed: `"${(project.ic_assignee || '').trim()}"`,
    status: project.status,
    is_archived: project.is_archived
  });

  log('\n剥 繝槭ャ繝√Φ繧ｰ邨先棡:');
  const designerNameTrimmed = designer.name.trim();
  const assignedToTrimmed = (project.assigned_to || '').trim();
  const icAssigneeTrimmed = (project.ic_assignee || '').trim();

  const matchAssigned = assignedToTrimmed === designerNameTrimmed;
  const matchIC = icAssigneeTrimmed === designerNameTrimmed;
  const statusOK = project.status !== 'completed';
  const archivedOK = !project.is_archived;
  const finalMatch = (matchAssigned || matchIC) && statusOK && archivedOK;

  log(`  - assigned_to荳閾ｴ: ${matchAssigned ? '笨・ : '笶・} ("${assignedToTrimmed}" === "${designerNameTrimmed}")`);
  log(`  - ic_assignee荳閾ｴ: ${matchIC ? '笨・ : '笶・} ("${icAssigneeTrimmed}" === "${designerNameTrimmed}")`);
  log(`  - status繝√ぉ繝・け: ${statusOK ? '笨・ : '笶・} (status !== "completed")`);
  log(`  - archived繝√ぉ繝・け: ${archivedOK ? '笨・ : '笶・} (!is_archived)`);
  log(`  - 譛邨ょ愛螳・ ${finalMatch ? '笨・繧ｫ繧ｦ繝ｳ繝医＆繧後ｋ' : '笶・繧ｫ繧ｦ繝ｳ繝医＆繧後↑縺・}`);

  if (!finalMatch) {
    log('\n庁 繧ｫ繧ｦ繝ｳ繝医＆繧後↑縺・炊逕ｱ:');
    if (!matchAssigned && !matchIC) {
      log('  - 諡・ｽ楢・錐縺御ｸ閾ｴ縺励※縺・∪縺帙ｓ');
      if (assignedToTrimmed !== designerNameTrimmed) {
        log(`    險ｭ險・ "${assignedToTrimmed}" 竕 "${designerNameTrimmed}"`);
      }
      if (icAssigneeTrimmed !== designerNameTrimmed) {
        log(`    IC: "${icAssigneeTrimmed}" 竕 "${designerNameTrimmed}"`);
      }
    }
    if (!statusOK) {
      log(`  - status縺・"completed" 縺ｧ縺兪);
    }
    if (!archivedOK) {
      log(`  - is_archived 縺・true 縺ｧ縺兪);
    }
  }

  log('\n' + '='.repeat(80));
  return finalMatch ? '縺薙・譯井ｻｶ縺ｯ繧ｫ繧ｦ繝ｳ繝医＆繧後∪縺・笨・ : '縺薙・譯井ｻｶ縺ｯ繧ｫ繧ｦ繝ｳ繝医＆繧後∪縺帙ｓ 笶・;
};

log('庁 繝・ヰ繝・げ髢｢謨ｰ縺悟茜逕ｨ蜿ｯ閭ｽ縺ｧ縺・');
log('  - debug() : 蜈ｨ繝・・繧ｿ縺ｮ隧ｳ邏ｰ繧定｡ｨ遉ｺ');
log('  - checkAssignment("諡・ｽ楢・錐", "譯井ｻｶ蜷・) : 蜑ｲ繧雁ｽ薙※繝√ぉ繝・け');

// ============================================
// 繝・・繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ
// ============================================
async function loadDesigners() {
  log('売 諡・ｽ薙ョ繝ｼ繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ髢句ｧ・..');

  try {
    const { data, error, count } = await supabaseWithTimeout(() =>
      supabase
        .from('designers')
        .select('*', { count: 'exact' })
        .order('display_order'),
      10000
    );

    if (error) {
      logError('笶・諡・ｽ薙ョ繝ｼ繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
      designers = [];
      return;
    }

    designers = data || [];
    log('笨・諡・ｽ薙ョ繝ｼ繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ螳御ｺ・', designers.length, '莉ｶ');
  } catch (err) {
    logError('笶・loadDesigners()繧ｿ繧､繝繧｢繧ｦ繝医∪縺溘・繧ｨ繝ｩ繝ｼ:', err);
    designers = [];
  }
}

async function loadCurrentDesigner() {
  if (!currentUser || !currentUser.email) return;

  // admin@ghouse.jp縺ｮ蝣ｴ蜷医・諡・ｽ薙ｒ迚ｹ螳壹＠縺ｪ縺・ｼ亥・譯井ｻｶ髢ｲ隕ｧ蜿ｯ閭ｽ・・
  if (currentUser.email === 'admin@ghouse.jp') {
    currentDesigner = null;
    return;
  }

  try {
    const { data, error } = await supabaseWithTimeout(() =>
      supabase
        .from('designers')
        .select('*')
        .eq('email', currentUser.email)
        .single(),
      10000
    );

    if (error) {
      warn('諡・ｽ捺ュ蝣ｱ縺ｮ蜿門ｾ励↓螟ｱ謨・', error);
      currentDesigner = null;
      return;
    }

    currentDesigner = data;
    log('迴ｾ蝨ｨ縺ｮ諡・ｽ・', currentDesigner);
  } catch (e) {
    warn('諡・ｽ捺ュ蝣ｱ蜿門ｾ励ち繧､繝繧｢繧ｦ繝・', e.message);
    currentDesigner = null;
  }
}

async function loadProjects() {
  log('売 譯井ｻｶ繝・・繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...');
  try {
    const { data, error } = await supabaseWithTimeout(() =>
      supabase
        .from('projects')
        .select('*')
        .order('created_at', { ascending: false }),
      15000  // 譯井ｻｶ繝・・繧ｿ縺ｯ螟壹＞蜿ｯ閭ｽ諤ｧ縺後≠繧九・縺ｧ髟ｷ繧√↓
    );
    if (error) {
      logError('笶・譯井ｻｶ繝・・繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
      projects = [];
      return;
    }
    projects = data || [];
    log('笨・譯井ｻｶ繝・・繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ螳御ｺ・', projects.length, '莉ｶ');

    // 繧ｯ繝ｪ繝ｼ繝ｳ繧｢繝・・縺ｯ髱槫酔譛溘〒蠕後°繧牙ｮ溯｡鯉ｼ医ヶ繝ｭ繝・け縺励↑縺・ｼ・
    setTimeout(() => cleanupProjectAssignees(), 1000);
  } catch (err) {
    logError('笶・loadProjects()繧ｿ繧､繝繧｢繧ｦ繝医∪縺溘・繧ｨ繝ｩ繝ｼ:', err);
    projects = [];
  }
}

async function cleanupProjectAssignees() {
  log('ｧｹ 譯井ｻｶ縺ｮ諡・ｽ楢・ョ繝ｼ繧ｿ繧偵け繝ｪ繝ｼ繝ｳ繧｢繝・・荳ｭ...');
  let updatedCount = 0;

  for (const project of projects) {
    // "null"縺ｨ縺・≧譁・ｭ怜・繧Ｏull縺ｨ縺励※謇ｱ縺・
    let assigned = (project.assigned_to || '').trim();
    let icAssigned = (project.ic_assignee || '').trim();
    let exteriorAssigned = (project.exterior_assignee || '').trim();
    let realestateAssigned = (project.realestate_assignee || '').trim();

    if (assigned === 'null' || assigned === 'undefined') assigned = '';
    if (icAssigned === 'null' || icAssigned === 'undefined') icAssigned = '';
    if (exteriorAssigned === 'null' || exteriorAssigned === 'undefined') exteriorAssigned = '';
    if (realestateAssigned === 'null' || realestateAssigned === 'undefined') realestateAssigned = '';

    let needsUpdate = false;

    // trim()縺励◆邨先棡縺悟・縺ｮ蛟､縺ｨ驕輔≧蝣ｴ蜷医√∪縺溘・"null"譁・ｭ怜・縺ｮ蝣ｴ蜷医・譖ｴ譁ｰ
    if (project.assigned_to !== assigned ||
        project.ic_assignee !== icAssigned ||
        project.exterior_assignee !== exteriorAssigned ||
        project.realestate_assignee !== realestateAssigned ||
        project.assigned_to === 'null' ||
        project.ic_assignee === 'null' ||
        project.exterior_assignee === 'null' ||
        project.realestate_assignee === 'null') {
      needsUpdate = true;
    }

    if (needsUpdate) {
      log(`肌 繧ｯ繝ｪ繝ｼ繝ｳ繧｢繝・・: ${project.customer}`);

      const { error } = await supabase
        .from('projects')
        .update({
          assigned_to: assigned || null,
          ic_assignee: icAssigned || null,
          exterior_assignee: exteriorAssigned || null,
          realestate_assignee: realestateAssigned || null
        })
        .eq('id', project.id);

      if (!error) {
        project.assigned_to = assigned || null;
        project.ic_assignee = icAssigned || null;
        project.exterior_assignee = exteriorAssigned || null;
        project.realestate_assignee = realestateAssigned || null;
        updatedCount++;
      } else {
        logError('笶・繧ｯ繝ｪ繝ｼ繝ｳ繧｢繝・・螟ｱ謨・', project.customer, error);
      }
    }
  }

  if (updatedCount > 0) {
    log(`笨・${updatedCount}莉ｶ縺ｮ譯井ｻｶ繧偵け繝ｪ繝ｼ繝ｳ繧｢繝・・縺励∪縺励◆`);
  } else {
    log('笨・繧ｯ繝ｪ繝ｼ繝ｳ繧｢繝・・荳崎ｦ・ｼ亥・譯井ｻｶ豁｣蟶ｸ・・);
  }
}

async function loadEmailTemplates() {
  try {
    const { data, error } = await supabaseWithTimeout(() =>
      supabase.from('email_templates').select('*').order('display_name'),
      10000
    );
    if (error) {
      logError('笶・繝｡繝ｼ繝ｫ繝・Φ繝励Ξ繝ｼ繝郁ｪｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
      emailTemplates = [];
      return;
    }
    emailTemplates = data || [];
    log('笨・繝｡繝ｼ繝ｫ繝・Φ繝励Ξ繝ｼ繝郁ｪｭ縺ｿ霎ｼ縺ｿ螳御ｺ・', emailTemplates.length, '莉ｶ');
  } catch (err) {
    logError('笶・loadEmailTemplates繧ｿ繧､繝繧｢繧ｦ繝・', err);
    emailTemplates = [];
  }
}

async function loadVendors() {
  try {
    const { data, error } = await supabaseWithTimeout(() =>
      supabase.from('template_vendors').select('*').order('company'),
      10000
    );
    if (error) {
      logError('笶・讌ｭ閠・ｪｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
      vendors = [];
      return;
    }
    vendors = data || [];
    log('笨・讌ｭ閠・ｪｭ縺ｿ霎ｼ縺ｿ螳御ｺ・', vendors.length, '莉ｶ');
  } catch (err) {
    logError('笶・loadVendors繧ｿ繧､繝繧｢繧ｦ繝・', err);
    vendors = [];
  }
}

async function loadTaskMappings() {
  try {
    const { data, error } = await supabaseWithTimeout(() =>
      supabase.from('task_template_mappings').select('*'),
      10000
    );
    if (error) {
      logError('笶・繧ｿ繧ｹ繧ｯ繝槭ャ繝斐Φ繧ｰ隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
      taskMappings = {};
      return;
    }
    taskMappings = {};
    (data || []).forEach(mapping => {
      taskMappings[mapping.task_key] = mapping.template_id;
    });
    log('笨・繧ｿ繧ｹ繧ｯ繝槭ャ繝斐Φ繧ｰ隱ｭ縺ｿ霎ｼ縺ｿ螳御ｺ・', Object.keys(taskMappings).length, '莉ｶ');
  } catch (err) {
    logError('笶・loadTaskMappings繧ｿ繧､繝繧｢繧ｦ繝・', err);
    taskMappings = {};
  }
}

// 豎守畑繧ｿ繧､繝繧｢繧ｦ繝井ｻ倥″Supabase繧ｯ繧ｨ繝ｪ
async function supabaseWithTimeout(queryFn, timeoutMs = 10000) {
  const timeout = new Promise((_, reject) =>
    setTimeout(() => reject(new Error('Query timeout')), timeoutMs)
  );
  return Promise.race([queryFn(), timeout]);
}

// 譁ｰ繧ｷ繧ｹ繝・Β逕ｨ繝・・繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ
async function loadVendorCategories() {
  try {
    const { data, error } = await supabaseWithTimeout(() =>
      supabase
        .from('vendor_categories')
        .select('*')
        .order('display_order'),
      10000
    );

    if (error) {
      logError('笶・讌ｭ閠・き繝・ざ繝ｪ隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
      vendorCategories = [];
      return;
    }

    vendorCategories = data || [];
    log('笨・讌ｭ閠・き繝・ざ繝ｪ隱ｭ縺ｿ霎ｼ縺ｿ螳御ｺ・', vendorCategories.length, '莉ｶ');
  } catch (e) {
    logError('笶・讌ｭ閠・き繝・ざ繝ｪ隱ｭ縺ｿ霎ｼ縺ｿ繧ｿ繧､繝繧｢繧ｦ繝・', e.message);
    vendorCategories = [];
  }
}

async function loadTasksV2() {
  try {
    const { data, error } = await supabaseWithTimeout(() =>
      supabase.from('tasks').select('*').order('display_order'),
      10000
    );

    if (error) {
      logError('笶・繧ｿ繧ｹ繧ｯ隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
      tasksV2 = [];
      return;
    }

    tasksV2 = data || [];
    log('笨・繧ｿ繧ｹ繧ｯ隱ｭ縺ｿ霎ｼ縺ｿ螳御ｺ・', tasksV2.length, '莉ｶ');

    // IC繧ｿ繧ｹ繧ｯ縺・1鬆・岼譛ｪ貅縺ｮ蝣ｴ蜷医・隴ｦ蜻願｡ｨ遉ｺ
    const icTasks = tasksV2.filter(t => t.category === 'IC');
    const notice = document.getElementById('icMigrationNotice');
    if (notice) {
      notice.style.display = icTasks.length < 21 ? 'block' : 'none';
    }
  } catch (e) {
    logError('笶・loadTasksV2繧ｿ繧､繝繧｢繧ｦ繝・', e);
    tasksV2 = [];
  }
}

// IC繧ｿ繧ｹ繧ｯ21鬆・岼繝槭う繧ｰ繝ｬ繝ｼ繧ｷ繝ｧ繝ｳ螳溯｡・
async function runICTasksMigration() {
  if (!confirm('IC繧ｿ繧ｹ繧ｯ繧・1鬆・岼縺ｫ譖ｴ譁ｰ縺励∪縺吶よ里蟄倥・IC繧ｿ繧ｹ繧ｯ縺ｯ鄂ｮ縺肴鋤縺医ｉ繧後∪縺吶らｶ夊｡後＠縺ｾ縺吶°・・)) {
    return;
  }

  showToast('売 IC繧ｿ繧ｹ繧ｯ繧呈峩譁ｰ荳ｭ...', 'info');

  try {
    // 繧ｹ繝・ャ繝・: has_email_button繧ｫ繝ｩ繝縺悟ｭ伜惠縺吶ｋ縺狗｢ｺ隱阪＠縲√↑縺代ｌ縺ｰ霑ｽ蜉
    // Supabase縺ｧ縺ｯ逶ｴ謗･ALTER TABLE縺ｧ縺阪↑縺・◆繧√ヽPC邨檎罰縺ｧ螳溯｡・

    // 繧ｹ繝・ャ繝・: 譌｢蟄露C繧ｿ繧ｹ繧ｯ繧貞炎髯､
    const { error: deleteError } = await supabase
      .from('tasks')
      .delete()
      .eq('category', 'IC');

    if (deleteError) {
      throw new Error('譌｢蟄露C繧ｿ繧ｹ繧ｯ蜑企勁繧ｨ繝ｩ繝ｼ: ' + deleteError.message);
    }
    log('笨・譌｢蟄露C繧ｿ繧ｹ繧ｯ蜑企勁螳御ｺ・);

    // 繧ｹ繝・ャ繝・: 讌ｭ閠・き繝・ざ繝ｪ繧定ｿｽ蜉
    const newCategories = [
      { name: '繧ｭ繝・メ繝ｳ', display_order: 10 },
      { name: '縺企｢ｨ蜻・, display_order: 11 },
      { name: '豢鈴擇', display_order: 12 },
      { name: '繝医う繝ｬ', display_order: 13 },
      { name: '辣ｧ譏・, display_order: 14 },
      { name: '蟒ｺ蜈ｷ', display_order: 15 },
      { name: '繧ｫ繝ｼ繝・Φ', display_order: 16 },
      { name: '騾菴・, display_order: 17 },
      { name: '螳ｶ蜈ｷ', display_order: 18 }
    ];

    for (const cat of newCategories) {
      await supabase.from('vendor_categories').upsert(cat, { onConflict: 'name' });
    }
    log('笨・讌ｭ閠・き繝・ざ繝ｪ霑ｽ蜉螳御ｺ・);

    // 繧ｹ繝・ャ繝・: 譁ｰ縺励＞IC繧ｿ繧ｹ繧ｯ21鬆・岼繧呈諺蜈･
    const newICTasks = [
      { task_key: 'ic_funding_check', task_name: '雉・≡險育判繝ｻ蠑慕ｶ呎嶌遒ｺ隱・, category: 'IC', display_order: 1, has_state: true, state_options: '["-", "遒ｺ隱肴ｸ・]', has_email_button: false },
      { task_key: 'ic_kitchen', task_name: '繧ｭ繝・メ繝ｳ繝ｻ繧ｫ繝・・繝懊・繝・, category: 'IC', display_order: 2, has_state: true, state_options: '["-", "GRAFTECT", "繧ｪ繝ｪ繧ｸ繝翫Ν", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_bath', task_name: '縺企｢ｨ蜻・, category: 'IC', display_order: 3, has_state: true, state_options: '["-", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_washroom_1f', task_name: '豢鈴擇1髫・, category: 'IC', display_order: 4, has_state: true, state_options: '["-", "辟｡縺・, "TOTO", "AICA", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_washroom_2f', task_name: '豢鈴擇2髫・, category: 'IC', display_order: 5, has_state: true, state_options: '["-", "辟｡縺・, "TOTO", "AICA", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_toilet_1f', task_name: '繝医う繝ｬ1髫・, category: 'IC', display_order: 6, has_state: true, state_options: '["-", "辟｡縺・, "TOTO", "Lixil", "Panasonic"]', has_email_button: true },
      { task_key: 'ic_toilet_2f', task_name: '繝医う繝ｬ2髫・, category: 'IC', display_order: 7, has_state: true, state_options: '["-", "辟｡縺・, "TOTO", "Lixil", "Panasonic"]', has_email_button: true },
      { task_key: 'ic_lighting', task_name: '辣ｧ譏弱・繝ｩ繝ｳ', category: 'IC', display_order: 8, has_state: true, state_options: '["-", "ODELIC", "DAIKO", "KOIZUMI", "Panasonic"]', has_email_button: true },
      { task_key: 'ic_spec_doc', task_name: '莉墓ｧ俶嶌菴懈・', category: 'IC', display_order: 9, has_state: true, state_options: '["-", "菴懈・貂・]', has_email_button: false },
      { task_key: 'ic_longterm_doc', task_name: '髟ｷ譛溯ｳ・侭騾∽ｻ・, category: 'IC', display_order: 10, has_state: true, state_options: '["-", "騾∽ｻ俶ｸ・]', has_email_button: false },
      { task_key: 'ic_execution_drawing', task_name: '螳滓命蝗ｳ', category: 'IC', display_order: 11, has_state: true, state_options: '["-", "菫ｮ豁｣萓晞ｼ貂・, "蝗ｳ髱｢繝√ぉ繝・け貂・]', has_email_button: false },
      { task_key: 'ic_exterior_pres', task_name: '螟冶｣・・繝ｬ繧ｼ繝ｳ菴懈・', category: 'IC', display_order: 12, has_state: true, state_options: '["-", "菴懈・貂・]', has_email_button: false },
      { task_key: 'ic_interior_pres', task_name: '蜀・｣・・繝ｬ繧ｼ繝ｳ菴懈・', category: 'IC', display_order: 13, has_state: true, state_options: '["-", "菴懈・貂・]', has_email_button: false },
      { task_key: 'ic_tategu', task_name: '蟒ｺ蜈ｷ繝励Ξ繧ｼ繝ｳ萓晞ｼ', category: 'IC', display_order: 14, has_state: true, state_options: '["-", "萓晞ｼ貂・, "菫晏ｭ俶ｸ・]', has_email_button: true },
      { task_key: 'ic_tile_pres', task_name: '繧ｿ繧､繝ｫ繝励Ξ繧ｼ繝ｳ菴懈・', category: 'IC', display_order: 15, has_state: true, state_options: '["-", "辟｡縺・, "菴懈・貂・]', has_email_button: false },
      { task_key: 'ic_exterior_meeting', task_name: '螟匁ｧ九∈縺ｮ謇灘粋縺帑ｾ晞ｼ', category: 'IC', display_order: 16, has_state: true, state_options: '["-", "萓晞ｼ貂・]', has_email_button: false },
      { task_key: 'ic_curtain', task_name: '繧ｫ繝ｼ繝・Φ邏ｹ莉・, category: 'IC', display_order: 17, has_state: true, state_options: '["-", "辟｡縺・, "萓晞ｼ貂・]', has_email_button: true },
      { task_key: 'ic_zousaku', task_name: '騾菴懈･ｭ閠・ｴｹ莉・, category: 'IC', display_order: 18, has_state: true, state_options: '["-", "辟｡縺・, "萓晞ｼ貂・]', has_email_button: true },
      { task_key: 'ic_furniture', task_name: '螳ｶ蜈ｷ隕狗ｩ堺ｾ晞ｼ', category: 'IC', display_order: 19, has_state: true, state_options: '["-", "辟｡縺・, "萓晞ｼ貂・]', has_email_button: true },
      { task_key: 'ic_iron', task_name: '繧｢繧､繧｢繝ｳ萓晞ｼ', category: 'IC', display_order: 20, has_state: true, state_options: '["-", "辟｡縺・, "萓晞ｼ貂・, "菫晏ｭ俶ｸ・]', has_email_button: true },
      { task_key: 'ic_other_estimate', task_name: '縺昴・莉冶ｦ狗ｩ堺ｾ晞ｼ', category: 'IC', display_order: 21, has_state: true, state_options: '["-", "辟｡縺・, "萓晞ｼ貂・, "菫晏ｭ俶ｸ・]', has_email_button: true, has_memo: true },
      { task_key: 'ic_final_checklist', task_name: '遒ｺ螳壼峙繝√ぉ繝・け繝ｪ繧ｹ繝・, category: 'IC', display_order: 22, has_state: true, state_options: '["-", "螳滓命貂・]', has_email_button: false },
      { task_key: 'ic_op_check', task_name: 'OP隕狗ｩ阪メ繧ｧ繝・け', category: 'IC', display_order: 23, has_state: true, state_options: '["-", "萓晞ｼ貂・, "菫晏ｭ俶ｸ・]', has_email_button: false },
      { task_key: 'ic_meeting_followup', task_name: '莨夊ｭｰ蠕檎｢ｺ隱堺ｺ矩・∽ｻ・, category: 'IC', display_order: 24, has_state: true, state_options: '["-", "騾∽ｻ俶ｸ・]', has_email_button: false },
      { task_key: 'ic_final_approval', task_name: '遒ｺ螳壼峙謇ｿ隱・, category: 'IC', display_order: 25, has_state: true, state_options: '["-", "萓晞ｼ荳ｭ", "繝繝ｳ繝峨Μ繝ｯ繝ｼ繧ｯ菫晏ｭ俶ｸ・]', has_email_button: false }
    ];

    const { error: insertError } = await supabase
      .from('tasks')
      .upsert(newICTasks, { onConflict: 'task_key' });

    if (insertError) {
      throw new Error('IC繧ｿ繧ｹ繧ｯ謖ｿ蜈･繧ｨ繝ｩ繝ｼ: ' + insertError.message);
    }
    log('笨・IC繧ｿ繧ｹ繧ｯ霑ｽ蜉螳御ｺ・);

    // 繝・・繧ｿ蜀崎ｪｭ縺ｿ霎ｼ縺ｿ
    await loadTasksV2();
    await loadVendorCategories();
    renderTasksManagement();

    showToast('笨・IC繧ｿ繧ｹ繧ｯ繧・1鬆・岼縺ｫ譖ｴ譁ｰ縺励∪縺励◆・・, 'success');

    // 隴ｦ蜻翫ｒ髱櫁｡ｨ遉ｺ
    const notice = document.getElementById('icMigrationNotice');
    if (notice) notice.style.display = 'none';

  } catch (error) {
    logError('IC繧ｿ繧ｹ繧ｯ繝槭う繧ｰ繝ｬ繝ｼ繧ｷ繝ｧ繝ｳ繧ｨ繝ｩ繝ｼ:', error);
    showToast('笶・IC繧ｿ繧ｹ繧ｯ譖ｴ譁ｰ縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
  }
}

// IC繧ｿ繧ｹ繧ｯ閾ｪ蜍輔・繧､繧ｰ繝ｬ繝ｼ繧ｷ繝ｧ繝ｳ・郁ｵｷ蜍墓凾縺ｫ21鬆・岼譛ｪ貅縺ｪ繧芽・蜍募ｮ溯｡鯉ｼ・
async function autoMigrateICTasks() {
  const icTasks = tasksV2.filter(t => t.category === 'IC');

  // 譌｢縺ｫ21鬆・岼莉･荳翫≠繧句ｴ蜷医・繧ｹ繧ｭ繝・・
  if (icTasks.length >= 21) {
    log('笨・IC繧ｿ繧ｹ繧ｯ縺ｯ譌｢縺ｫ21鬆・岼莉･荳翫≠繧翫∪縺・', icTasks.length);
    return;
  }

  log('売 IC繧ｿ繧ｹ繧ｯ閾ｪ蜍輔・繧､繧ｰ繝ｬ繝ｼ繧ｷ繝ｧ繝ｳ髢句ｧ・.. (迴ｾ蝨ｨ:', icTasks.length, '鬆・岼)');

  try {
    // 譌｢蟄露C繧ｿ繧ｹ繧ｯ繧貞炎髯､
    const { error: deleteError } = await supabase
      .from('tasks')
      .delete()
      .eq('category', 'IC');

    if (deleteError) {
      throw new Error('譌｢蟄露C繧ｿ繧ｹ繧ｯ蜑企勁繧ｨ繝ｩ繝ｼ: ' + deleteError.message);
    }

    // 讌ｭ閠・き繝・ざ繝ｪ繧定ｿｽ蜉
    const newCategories = [
      { name: '繧ｭ繝・メ繝ｳ', display_order: 10 },
      { name: '縺企｢ｨ蜻・, display_order: 11 },
      { name: '豢鈴擇', display_order: 12 },
      { name: '繝医う繝ｬ', display_order: 13 },
      { name: '辣ｧ譏・, display_order: 14 },
      { name: '蟒ｺ蜈ｷ', display_order: 15 },
      { name: '繧ｫ繝ｼ繝・Φ', display_order: 16 },
      { name: '騾菴・, display_order: 17 },
      { name: '螳ｶ蜈ｷ', display_order: 18 }
    ];

    for (const cat of newCategories) {
      await supabase.from('vendor_categories').upsert(cat, { onConflict: 'name' });
    }

    // 21鬆・岼縺ｮIC繧ｿ繧ｹ繧ｯ繧呈諺蜈･
    const newICTasks = [
      { task_key: 'ic_funding_check', task_name: '雉・≡險育判繝ｻ蠑慕ｶ呎嶌遒ｺ隱・, category: 'IC', display_order: 1, has_state: true, state_options: '["-", "遒ｺ隱肴ｸ・]', has_email_button: false },
      { task_key: 'ic_kitchen', task_name: '繧ｭ繝・メ繝ｳ繝ｻ繧ｫ繝・・繝懊・繝・, category: 'IC', display_order: 2, has_state: true, state_options: '["-", "GRAFTECT", "繧ｪ繝ｪ繧ｸ繝翫Ν", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_bath', task_name: '縺企｢ｨ蜻・, category: 'IC', display_order: 3, has_state: true, state_options: '["-", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_washroom_1f', task_name: '豢鈴擇1髫・, category: 'IC', display_order: 4, has_state: true, state_options: '["-", "辟｡縺・, "TOTO", "AICA", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_washroom_2f', task_name: '豢鈴擇2髫・, category: 'IC', display_order: 5, has_state: true, state_options: '["-", "辟｡縺・, "TOTO", "AICA", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_toilet_1f', task_name: '繝医う繝ｬ1髫・, category: 'IC', display_order: 6, has_state: true, state_options: '["-", "辟｡縺・, "TOTO", "Lixil", "Panasonic"]', has_email_button: true },
      { task_key: 'ic_toilet_2f', task_name: '繝医う繝ｬ2髫・, category: 'IC', display_order: 7, has_state: true, state_options: '["-", "辟｡縺・, "TOTO", "Lixil", "Panasonic"]', has_email_button: true },
      { task_key: 'ic_lighting', task_name: '辣ｧ譏弱・繝ｩ繝ｳ', category: 'IC', display_order: 8, has_state: true, state_options: '["-", "ODELIC", "DAIKO", "KOIZUMI", "Panasonic"]', has_email_button: true },
      { task_key: 'ic_spec_doc', task_name: '莉墓ｧ俶嶌菴懈・', category: 'IC', display_order: 9, has_state: true, state_options: '["-", "菴懈・貂・]', has_email_button: false },
      { task_key: 'ic_longterm_doc', task_name: '髟ｷ譛溯ｳ・侭騾∽ｻ・, category: 'IC', display_order: 10, has_state: true, state_options: '["-", "騾∽ｻ俶ｸ・]', has_email_button: false },
      { task_key: 'ic_execution_drawing', task_name: '螳滓命蝗ｳ', category: 'IC', display_order: 11, has_state: true, state_options: '["-", "菫ｮ豁｣萓晞ｼ貂・, "蝗ｳ髱｢繝√ぉ繝・け貂・]', has_email_button: false },
      { task_key: 'ic_exterior_pres', task_name: '螟冶｣・・繝ｬ繧ｼ繝ｳ菴懈・', category: 'IC', display_order: 12, has_state: true, state_options: '["-", "菴懈・貂・]', has_email_button: false },
      { task_key: 'ic_interior_pres', task_name: '蜀・｣・・繝ｬ繧ｼ繝ｳ菴懈・', category: 'IC', display_order: 13, has_state: true, state_options: '["-", "菴懈・貂・]', has_email_button: false },
      { task_key: 'ic_tategu', task_name: '蟒ｺ蜈ｷ繝励Ξ繧ｼ繝ｳ萓晞ｼ', category: 'IC', display_order: 14, has_state: true, state_options: '["-", "萓晞ｼ貂・, "菫晏ｭ俶ｸ・]', has_email_button: true },
      { task_key: 'ic_tile_pres', task_name: '繧ｿ繧､繝ｫ繝励Ξ繧ｼ繝ｳ菴懈・', category: 'IC', display_order: 15, has_state: true, state_options: '["-", "辟｡縺・, "菴懈・貂・]', has_email_button: false },
      { task_key: 'ic_exterior_meeting', task_name: '螟匁ｧ九∈縺ｮ謇灘粋縺帑ｾ晞ｼ', category: 'IC', display_order: 16, has_state: true, state_options: '["-", "萓晞ｼ貂・]', has_email_button: false },
      { task_key: 'ic_curtain', task_name: '繧ｫ繝ｼ繝・Φ邏ｹ莉・, category: 'IC', display_order: 17, has_state: true, state_options: '["-", "辟｡縺・, "萓晞ｼ貂・]', has_email_button: true },
      { task_key: 'ic_zousaku', task_name: '騾菴懈･ｭ閠・ｴｹ莉・, category: 'IC', display_order: 18, has_state: true, state_options: '["-", "辟｡縺・, "萓晞ｼ貂・]', has_email_button: true },
      { task_key: 'ic_furniture', task_name: '螳ｶ蜈ｷ隕狗ｩ堺ｾ晞ｼ', category: 'IC', display_order: 19, has_state: true, state_options: '["-", "辟｡縺・, "萓晞ｼ貂・]', has_email_button: true },
      { task_key: 'ic_iron', task_name: '繧｢繧､繧｢繝ｳ萓晞ｼ', category: 'IC', display_order: 20, has_state: true, state_options: '["-", "辟｡縺・, "萓晞ｼ貂・, "菫晏ｭ俶ｸ・]', has_email_button: true },
      { task_key: 'ic_other_estimate', task_name: '縺昴・莉冶ｦ狗ｩ堺ｾ晞ｼ', category: 'IC', display_order: 21, has_state: true, state_options: '["-", "辟｡縺・, "萓晞ｼ貂・, "菫晏ｭ俶ｸ・]', has_email_button: true, has_memo: true },
      { task_key: 'ic_final_checklist', task_name: '遒ｺ螳壼峙繝√ぉ繝・け繝ｪ繧ｹ繝・, category: 'IC', display_order: 22, has_state: true, state_options: '["-", "螳滓命貂・]', has_email_button: false },
      { task_key: 'ic_op_check', task_name: 'OP隕狗ｩ阪メ繧ｧ繝・け', category: 'IC', display_order: 23, has_state: true, state_options: '["-", "萓晞ｼ貂・, "菫晏ｭ俶ｸ・]', has_email_button: false },
      { task_key: 'ic_meeting_followup', task_name: '莨夊ｭｰ蠕檎｢ｺ隱堺ｺ矩・∽ｻ・, category: 'IC', display_order: 24, has_state: true, state_options: '["-", "騾∽ｻ俶ｸ・]', has_email_button: false },
      { task_key: 'ic_final_approval', task_name: '遒ｺ螳壼峙謇ｿ隱・, category: 'IC', display_order: 25, has_state: true, state_options: '["-", "萓晞ｼ荳ｭ", "繝繝ｳ繝峨Μ繝ｯ繝ｼ繧ｯ菫晏ｭ俶ｸ・]', has_email_button: false }
    ];

    const { error: insertError } = await supabase
      .from('tasks')
      .upsert(newICTasks, { onConflict: 'task_key' });

    if (insertError) {
      throw new Error('IC繧ｿ繧ｹ繧ｯ謖ｿ蜈･繧ｨ繝ｩ繝ｼ: ' + insertError.message);
    }

    // 繧ｿ繧ｹ繧ｯ繝・・繧ｿ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ
    await loadTasksV2();
    await loadVendorCategories();

    log('笨・IC繧ｿ繧ｹ繧ｯ閾ｪ蜍輔・繧､繧ｰ繝ｬ繝ｼ繧ｷ繝ｧ繝ｳ螳御ｺ・(21鬆・岼)');
    showToast('笨・IC繧ｿ繧ｹ繧ｯ繧・1鬆・岼縺ｫ閾ｪ蜍墓峩譁ｰ縺励∪縺励◆', 'success');

  } catch (error) {
    logError('IC繧ｿ繧ｹ繧ｯ閾ｪ蜍輔・繧､繧ｰ繝ｬ繝ｼ繧ｷ繝ｧ繝ｳ繧ｨ繝ｩ繝ｼ:', error);
    // 繧ｨ繝ｩ繝ｼ縺ｧ繧らｶ夊｡鯉ｼ域里蟄俶ｩ溯・縺ｫ蠖ｱ髻ｿ縺輔○縺ｪ縺・ｼ・
  }
}

async function loadVendorsV2() {
  try {
    const { data, error } = await supabaseWithTimeout(() =>
      supabase.from('vendors_v2').select('*').order('company'),
      10000
    );

    if (error) {
      logError('笶・讌ｭ閠・2隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
      vendorsV2 = [];
      return;
    }

    vendorsV2 = data || [];
    log('笨・讌ｭ閠・2隱ｭ縺ｿ霎ｼ縺ｿ螳御ｺ・', vendorsV2.length, '莉ｶ');
  } catch (e) {
    logError('笶・loadVendorsV2繧ｿ繧､繝繧｢繧ｦ繝・', e);
    vendorsV2 = [];
  }
}

function mergeVendorCategories() {
  log('迫 mergeVendorCategories() 髢句ｧ・', {
    vendorsV2Length: vendorsV2.length,
    vendorCategoriesLength: vendorCategories.length,
    vendorCategories: vendorCategories
  });

  // 繧ｫ繝・ざ繝ｪ諠・ｱ繧呈･ｭ閠・ョ繝ｼ繧ｿ縺ｫ繝槭・繧ｸ・・romise.allSettled螳御ｺ・ｾ後↓蜻ｼ縺ｳ蜃ｺ縺呻ｼ・
  if (vendorsV2.length > 0 && vendorCategories.length > 0) {
    vendorsV2 = vendorsV2.map(vendor => {
      const category = vendorCategories.find(c => c.id === vendor.category_id);
      return {
        ...vendor,
        vendor_categories: category ? { name: category.name } : null
      };
    });
    log('笨・讌ｭ閠・繧ｫ繝・ざ繝ｪ繝槭・繧ｸ螳御ｺ・', vendorsV2.slice(0, 2));
  } else {
    warn('笞・・繝槭・繧ｸ繧ｹ繧ｭ繝・・:', {
      vendorsV2Empty: vendorsV2.length === 0,
      vendorCategoriesEmpty: vendorCategories.length === 0
    });
  }
}

async function loadTaskVendorMappings() {
  try {
    const { data, error } = await supabaseWithTimeout(() =>
      supabase
        .from('task_vendor_mappings_v2')
        .select('*'),
      10000
    );

    if (error) {
      logError('笶・繧ｿ繧ｹ繧ｯ-讌ｭ閠・ｴ舌▼縺題ｪｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', error);
      taskVendorMappings = [];
      return;
    }

    taskVendorMappings = data || [];
    log('笨・繧ｿ繧ｹ繧ｯ-讌ｭ閠・ｴ舌▼縺題ｪｭ縺ｿ霎ｼ縺ｿ螳御ｺ・', taskVendorMappings.length, '莉ｶ');
  } catch (e) {
    logError('笶・繧ｿ繧ｹ繧ｯ-讌ｭ閠・ｴ舌▼縺代ち繧､繝繧｢繧ｦ繝・', e.message);
    taskVendorMappings = [];
  }
}

async function loadProducts() {
  try {
    const { data, error } = await supabaseWithTimeout(() =>
      supabase.from('products').select('*').order('display_order'),
      10000
    );
    if (!error && data) {
      products = data;
    } else {
      // 繝・・繝悶Ν縺悟ｭ伜惠縺励↑縺・ｴ蜷医・繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ
      products = [
        { id: '1', name: 'LIFE', display_order: 1 },
        { id: '2', name: 'LIFE+', display_order: 2 },
        { id: '3', name: 'HOURS', display_order: 3 },
        { id: '4', name: 'LACIE', display_order: 4 },
        { id: '5', name: 'LIFE Limited', display_order: 5 },
        { id: '6', name: 'LIFE+ Limited', display_order: 6 }
      ];
    }
    log('笨・蝠・刀隱ｭ縺ｿ霎ｼ縺ｿ螳御ｺ・', products.length, '莉ｶ');
  } catch (e) {
    logError('笶・loadProducts繧ｿ繧､繝繧｢繧ｦ繝・', e);
    products = [];
  }
}

// ============================================
// 讌ｭ閠・ｮ｡逅・2
// ============================================
let currentCategoryFilter = 'ALL';

function renderVendorsV2() {
  log('到 renderVendorsV2() 蜻ｼ縺ｳ蜃ｺ縺鈴幕蟋・);
  log('投 vendorsV2驟榊・縺ｮ迥ｶ諷・', {
    length: vendorsV2.length,
    data: vendorsV2.slice(0, 3),
    '蜈ｨ繝・・繧ｿ': vendorsV2
  });

  const container = document.getElementById('vendorsGrid');
  log('識 vendorsGrid隕∫ｴ:', container ? 'found 笨・ : 'NOT FOUND 笨・);

  if (!container) {
    logError('笶・CRITICAL: vendorsGrid隕∫ｴ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ・・);
    log('桃 迴ｾ蝨ｨ縺ｮDOM迥ｶ諷・', document.getElementById('vendorsPanel'));
    return;
  }

  log('剥 renderVendorsV2():', {
    totalVendors: vendorsV2.length,
    currentFilter: currentCategoryFilter,
    vendors: vendorsV2
  });

  const filtered = currentCategoryFilter === 'ALL'
    ? vendorsV2
    : vendorsV2.filter(v => v.category_id === currentCategoryFilter);

  log('剥 繝輔ぅ繝ｫ繧ｿ繝ｼ蠕後・讌ｭ閠・焚:', filtered.length);

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">逃</div><p>讌ｭ閠・′逋ｻ骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ<br><small>縲・ 讌ｭ閠・ｿｽ蜉縲阪・繧ｿ繝ｳ縺九ｉ逋ｻ骭ｲ縺励※縺上□縺輔＞</small></p></div>';
    return;
  }

  container.innerHTML = filtered.map(vendor => {
    const categoryName = vendor.vendor_categories?.name || '譛ｪ蛻・｡・;
    return `
      <div class="vendor-card">
        <div class="vendor-header">
          <h3>${escapeHtml(vendor.company)}</h3>
          <span class="badge badge-primary">${escapeHtml(categoryName)}</span>
        </div>
        <div class="vendor-info">
          <div><strong>諡・ｽ楢・</strong> ${escapeHtml(vendor.contact || '-')}</div>
          <div><strong>TEL:</strong> ${escapeHtml(vendor.tel || '-')}</div>
          <div><strong>Email:</strong> ${escapeHtml(vendor.email || '-')}</div>
        </div>
        <div class="vendor-actions">
          <button class="btn btn-secondary btn-small" onclick="editVendorV2('${vendor.id}')">邱ｨ髮・/button>
          <button class="btn btn-danger btn-small" onclick="deleteVendorV2('${vendor.id}')">蜑企勁</button>
        </div>
      </div>
    `;
  }).join('');
}

function setCategoryFilter(categoryId, e) {
  currentCategoryFilter = categoryId;
  document.querySelectorAll('.category-filter-btn').forEach(btn => btn.classList.remove('active'));
  if (e && e.target) {
    e.target.classList.add('active');
  }
  renderVendorsV2();
}

function openVendorModalV2(vendorId = null) {
  const modal = document.getElementById('vendorModalV2');
  const title = document.getElementById('vendorModalTitle');

  // 繧ｫ繝・ざ繝ｪ繝峨Ο繝・・繝繧ｦ繝ｳ繧呈峩譁ｰ
  populateVendorCategoryDropdown();

  if (vendorId) {
    const vendor = vendorsV2.find(v => v.id === vendorId);
    if (!vendor) return;

    title.textContent = '讌ｭ閠・ｷｨ髮・;
    document.getElementById('vendorId').value = vendor.id;
    document.getElementById('vendorCompany').value = vendor.company;
    document.getElementById('vendorContact').value = vendor.contact || '';
    document.getElementById('vendorTel').value = vendor.tel || '';
    document.getElementById('vendorEmail').value = vendor.email || '';
    document.getElementById('vendorCategory').value = vendor.category_id || '';
    document.getElementById('vendorSubject').value = vendor.subject_format || '';
    document.getElementById('vendorTemplate').value = vendor.template_text || '';
  } else {
    title.textContent = '讌ｭ閠・ｿｽ蜉';
    document.getElementById('vendorForm').reset();
    document.getElementById('vendorId').value = '';
  }

  ModalManager.open(modal, '#vendorCompany');
}

function closeVendorModalV2() {
  ModalManager.close(document.getElementById('vendorModalV2'));
}

async function saveVendorV2() {
  // 莠碁㍾繧ｯ繝ｪ繝・け髦ｲ豁｢
  if (SaveGuard.isLocked('saveVendorV2')) return;

  const id = document.getElementById('vendorId')?.value || '';
  const company = document.getElementById('vendorCompany')?.value?.trim() || '';
  const contact = document.getElementById('vendorContact')?.value?.trim() || '';
  const tel = document.getElementById('vendorTel')?.value?.trim() || '';
  const email = document.getElementById('vendorEmail')?.value?.trim() || '';
  const categoryId = document.getElementById('vendorCategory')?.value || '';
  const subjectFormat = document.getElementById('vendorSubject')?.value?.trim() || '';
  const templateText = document.getElementById('vendorTemplate')?.value?.trim() || '';

  if (!company) {
    showToast('莨夂､ｾ蜷阪ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (!categoryId) {
    showToast('繧ｫ繝・ざ繝ｪ繧帝∈謚槭＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  await SaveGuard.run('saveVendorV2', async () => {
    showStatus('菫晏ｭ倅ｸｭ...', 'saving');

    const vendorData = {
      company,
      contact: contact || null,
      tel: tel || null,
      email: email || null,
      category_id: categoryId || null,
      subject_format: subjectFormat || null,
      template_text: templateText || null
    };

    let result;
    if (id) {
      result = await supabase
        .from('vendors_v2')
        .update(vendorData)
        .eq('id', id)
        .select('*, vendor_categories(name)');
    } else {
      result = await supabase
        .from('vendors_v2')
        .insert([vendorData])
        .select('*, vendor_categories(name)');
    }

    if (result.error) {
      showStatus('菫晏ｭ伜､ｱ謨・, 'error');
      showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + result.error.message, 'error');
      return;
    }

    showStatus('菫晏ｭ伜ｮ御ｺ・, 'success');
    showToast(id ? '讌ｭ閠・ｒ譖ｴ譁ｰ縺励∪縺励◆' : '讌ｭ閠・ｒ霑ｽ蜉縺励∪縺励◆', 'success');
    closeVendorModalV2();
    await loadVendorsV2();
    mergeVendorCategories(); // 繧ｫ繝・ざ繝ｪ諠・ｱ繧偵・繝ｼ繧ｸ
    renderVendorsV2();
  });
}

function editVendorV2(vendorId) {
  openVendorModalV2(vendorId);
}

async function deleteVendorV2(vendorId) {
  const vendor = vendorsV2.find(v => v.id === vendorId);
  if (!vendor) return;

  if (!confirm(`縲・{vendor.company}縲阪ｒ蜑企勁縺励∪縺吶°・歔)) return;

  await SaveGuard.run(`deleteVendor_${vendorId}`, async () => {
    showStatus('蜑企勁荳ｭ...', 'saving');

    const { error } = await supabase
      .from('vendors_v2')
      .delete()
      .eq('id', vendorId);

    if (error) {
      showStatus('蜑企勁螟ｱ謨・, 'error');
      showToast('蜑企勁縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
      return;
    }

    showStatus('蜑企勁螳御ｺ・, 'success');
    showToast('讌ｭ閠・ｒ蜑企勁縺励∪縺励◆', 'success');
    await loadVendorsV2();
    renderVendorsV2();
  });
}

// ============================================
// 繧ｫ繝・ざ繝ｪ邂｡逅・
// ============================================
function renderCategoriesList() {
  const container = document.getElementById('categoriesGrid');
  if (!container) return;

  if (vendorCategories.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">捷・・/div><p>繧ｫ繝・ざ繝ｪ縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ</p></div>';
    return;
  }

  // 陦ｨ遉ｺ鬆・〒繧ｽ繝ｼ繝・
  const sortedCategories = [...vendorCategories].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>繧ｫ繝・ざ繝ｪ蜷・/th>
            <th style="width: 100px;">讌ｭ閠・焚</th>
            <th style="width: 180px;">謫堺ｽ・/th>
          </tr>
        </thead>
        <tbody>
          ${sortedCategories.map(cat => {
            const count = vendorsV2.filter(v => v.category_id === cat.id).length;
            return `
              <tr draggable="true" ondragstart="handleCategoryDragStart(event, '${cat.id}')" ondragover="handleCategoryDragOver(event)" ondrop="handleCategoryDrop(event, '${cat.id}')" style="cursor: move;">
                <td><span style="color: var(--text-muted);">站ｮ站ｮ</span></td>
                <td><strong>${cat.name}</strong></td>
                <td>${count}遉ｾ</td>
                <td>
                  <button class="btn btn-secondary btn-small" onclick="editCategory('${cat.id}')">邱ｨ髮・/button>
                  <button class="btn btn-danger btn-small" onclick="deleteCategory('${cat.id}')">蜑企勁</button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function openCategoryModal(categoryId = null) {
  const modal = document.getElementById('categoryModal');
  const title = document.getElementById('categoryModalTitle');

  if (categoryId) {
    const category = vendorCategories.find(c => c.id === categoryId);
    if (!category) return;

    title.textContent = '繧ｫ繝・ざ繝ｪ邱ｨ髮・;
    document.getElementById('categoryId').value = category.id;
    document.getElementById('categoryName').value = category.name;
    document.getElementById('categoryOrder').value = category.display_order;
  } else {
    title.textContent = '繧ｫ繝・ざ繝ｪ霑ｽ蜉';
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryId').value = '';
    document.getElementById('categoryOrder').value = vendorCategories.length + 1;
  }

  ModalManager.open(modal, '#categoryName');
}

function closeCategoryModal() {
  ModalManager.close(document.getElementById('categoryModal'));
}

async function saveCategory() {
  if (SaveGuard.isLocked('saveCategory')) return;

  const id = document.getElementById('categoryId').value;
  const name = document.getElementById('categoryName').value.trim();
  const order = parseInt(document.getElementById('categoryOrder').value) || 0;

  if (!name) {
    showToast('繧ｫ繝・ざ繝ｪ蜷阪ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  await SaveGuard.run('saveCategory', async () => {
    showStatus('菫晏ｭ倅ｸｭ...', 'saving');

    const categoryData = {
      name,
      display_order: order
    };

    let result;
    if (id) {
      result = await supabase
        .from('vendor_categories')
        .update(categoryData)
        .eq('id', id)
        .select();
    } else {
      result = await supabase
        .from('vendor_categories')
        .insert([categoryData])
        .select();
    }

    if (result.error) {
      showStatus('菫晏ｭ伜､ｱ謨・, 'error');
      showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + result.error.message, 'error');
      return;
    }

    showStatus('菫晏ｭ伜ｮ御ｺ・, 'success');
    showToast(id ? '繧ｫ繝・ざ繝ｪ繧呈峩譁ｰ縺励∪縺励◆' : '繧ｫ繝・ざ繝ｪ繧定ｿｽ蜉縺励∪縺励◆', 'success');
    closeCategoryModal();
    await loadVendorCategories();
    renderCategoriesList();
    renderCategoryFilters();
  });
}

function editCategory(categoryId) {
  openCategoryModal(categoryId);
}

async function deleteCategory(categoryId) {
  const category = vendorCategories.find(c => c.id === categoryId);
  if (!category) return;

  const vendorCount = vendorsV2.filter(v => v.category_id === categoryId).length;
  if (vendorCount > 0) {
    showToast(`縺薙・繧ｫ繝・ざ繝ｪ縺ｫ縺ｯ${vendorCount}遉ｾ縺ｮ讌ｭ閠・′邏舌▼縺・※縺・∪縺吶ょ・縺ｫ讌ｭ閠・ｒ蜑企勁縺励※縺上□縺輔＞縲Ａ, 'error');
    return;
  }

  if (!confirm(`繧ｫ繝・ざ繝ｪ縲・{category.name}縲阪ｒ蜑企勁縺励∪縺吶°・歔)) return;

  await SaveGuard.run(`deleteCategory_${categoryId}`, async () => {
    showStatus('蜑企勁荳ｭ...', 'saving');

    const { error } = await supabase
      .from('vendor_categories')
      .delete()
      .eq('id', categoryId);

    if (error) {
      showStatus('蜑企勁螟ｱ謨・, 'error');
      showToast('蜑企勁縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
      return;
    }

    showStatus('蜑企勁螳御ｺ・, 'success');
    showToast('繧ｫ繝・ざ繝ｪ繧貞炎髯､縺励∪縺励◆', 'success');
    await loadVendorCategories();
    renderCategoriesList();
    renderCategoryFilters();
  });
}

// 繝峨Λ繝・げ&繝峨Ο繝・・縺ｧ繧ｫ繝・ざ繝ｪ縺ｮ陦ｨ遉ｺ鬆・ｒ螟画峩
let draggedCategoryId = null;

function handleCategoryDragStart(event, categoryId) {
  draggedCategoryId = categoryId;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.5';
}

function handleCategoryDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  return false;
}

async function handleCategoryDrop(event, targetCategoryId) {
  event.preventDefault();
  event.stopPropagation();

  if (!draggedCategoryId || draggedCategoryId === targetCategoryId) {
    resetCategoryDragState();
    return;
  }

  const draggedCategory = vendorCategories.find(c => c.id === draggedCategoryId);
  const targetCategory = vendorCategories.find(c => c.id === targetCategoryId);

  if (!draggedCategory || !targetCategory) {
    resetCategoryDragState();
    return;
  }

  // 陦ｨ遉ｺ鬆・ｒ蜈･繧梧崛縺・
  const draggedOrder = draggedCategory.display_order;
  const targetOrder = targetCategory.display_order;

  showStatus('荳ｦ縺ｳ譖ｿ縺井ｸｭ...', 'saving');

  // 荳｡譁ｹ縺ｮ繧ｫ繝・ざ繝ｪ縺ｮ陦ｨ遉ｺ鬆・ｒ譖ｴ譁ｰ
  const updates = [
    supabase.from('vendor_categories').update({ display_order: targetOrder }).eq('id', draggedCategoryId),
    supabase.from('vendor_categories').update({ display_order: draggedOrder }).eq('id', targetCategoryId)
  ];

  const results = await Promise.all(updates);

  if (results.some(r => r.error)) {
    showStatus('荳ｦ縺ｳ譖ｿ縺亥､ｱ謨・, 'error');
    showToast('荳ｦ縺ｳ譖ｿ縺医↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
    resetCategoryDragState();
    return;
  }

  // 繝ｭ繝ｼ繧ｫ繝ｫ繝・・繧ｿ繧よ峩譁ｰ
  draggedCategory.display_order = targetOrder;
  targetCategory.display_order = draggedOrder;

  // 蜀肴緒逕ｻ
  renderCategoriesList();
  renderCategoryFilters();
  showStatus('荳ｦ縺ｳ譖ｿ縺亥ｮ御ｺ・, 'success');
  showToast('陦ｨ遉ｺ鬆・ｒ螟画峩縺励∪縺励◆', 'success');
  resetCategoryDragState();
}

function resetCategoryDragState() {
  draggedCategoryId = null;
  // 縺吶∋縺ｦ縺ｮ陦後・騾乗・蠎ｦ繧偵Μ繧ｻ繝・ヨ
  document.querySelectorAll('#categoriesGrid tr[draggable]').forEach(tr => {
    tr.style.opacity = '1';
  });
}

function renderCategoryFilters() {
  const container = document.getElementById('categoryFilters');
  if (!container) return;

  let html = `<button class="category-filter-btn ${currentCategoryFilter === 'ALL' ? 'active' : ''}" onclick="setCategoryFilter('ALL', event)">蜈ｨ縺ｦ (${vendorsV2.length})</button>`;

  vendorCategories.forEach(cat => {
    const count = vendorsV2.filter(v => v.category_id === cat.id).length;
    html += `<button class="category-filter-btn ${currentCategoryFilter === cat.id ? 'active' : ''}" onclick="setCategoryFilter('${cat.id}', event)">${escapeHtml(cat.name)} (${count})</button>`;
  });

  container.innerHTML = html;
}

// 諡・ｽ楢・ヵ繧｣繝ｫ繧ｿ繝ｼ縺ｮ繝峨Ο繝・・繝繧ｦ繝ｳ繧貞・譛溷喧
function populateAssigneeFilters() {
  // IC諡・ｽ楢・ヵ繧｣繝ｫ繧ｿ繝ｼ
  const icFilter = document.getElementById('icAssigneeFilter');
  if (icFilter) {
    const icAssignees = [...new Set(projects.map(p => p.ic_assignee).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ja'));
    icFilter.innerHTML = '<option value="">IC諡・ｽ・ 縺吶∋縺ｦ</option>' + icAssignees.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
  }

  // 螟匁ｧ区球蠖楢・ヵ繧｣繝ｫ繧ｿ繝ｼ
  const exteriorFilter = document.getElementById('exteriorAssigneeFilter');
  if (exteriorFilter) {
    const exteriorAssignees = [...new Set(projects.map(p => p.exterior_assignee).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ja'));
    exteriorFilter.innerHTML = '<option value="">螟匁ｧ区球蠖・ 縺吶∋縺ｦ</option>' + exteriorAssignees.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
  }

  // 荳榊虚逕｣諡・ｽ楢・ヵ繧｣繝ｫ繧ｿ繝ｼ
  const realestateFilter = document.getElementById('realestateAssigneeFilter');
  if (realestateFilter) {
    const realestateAssignees = [...new Set(projects.map(p => p.realestate_assignee).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ja'));
    realestateFilter.innerHTML = '<option value="">荳榊虚逕｣諡・ｽ・ 縺吶∋縺ｦ</option>' + realestateAssignees.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
  }
}

// ============================================
// 蝠・刀邂｡逅・
// ============================================
function renderProductsList() {
  const container = document.getElementById('productsGrid');
  if (!container) return;

  if (products.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">逃</div><p>蝠・刀縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ</p></div>';
    return;
  }

  // 陦ｨ遉ｺ鬆・〒繧ｽ繝ｼ繝・
  const sortedProducts = [...products].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));

  container.innerHTML = '<div class="table-container"><table class="table"><thead><tr><th style="width: 60px;"></th><th>蝠・刀蜷・/th><th style="width: 100px;">謫堺ｽ・/th></tr></thead><tbody>' +
    sortedProducts.map(product => `
      <tr draggable="true" ondragstart="handleProductDragStart(event, '${product.id}')" ondragover="handleProductDragOver(event)" ondrop="handleProductDrop(event, '${product.id}')" style="cursor: move;">
        <td><span style="color: var(--text-muted);">站ｮ站ｮ</span></td>
        <td><strong>${escapeHtml(product.name)}</strong></td>
        <td><button class="btn btn-danger btn-small" onclick="deleteProductInline('${product.id}')">蜑企勁</button></td>
      </tr>
    `).join('') +
    '</tbody></table></div>';
}

async function addProductInline() {
  const name = document.getElementById('newProductNameInline').value.trim();

  if (!name) {
    showToast('蝠・刀蜷阪ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (products.find(p => p.name === name)) {
    showToast('譌｢縺ｫ蟄伜惠縺吶ｋ蝠・刀蜷阪〒縺・, 'error');
    return;
  }

  showStatus('霑ｽ蜉荳ｭ...', 'saving');

  const maxDisplayOrder = products.length > 0 ? Math.max(...products.map(p => p.display_order || 0)) : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('products')
    .insert([{ name, display_order: newDisplayOrder }])
    .select();

  if (error) {
    // 繝・・繝悶Ν縺悟ｭ伜惠縺励↑縺・ｴ蜷医√Ο繝ｼ繧ｫ繝ｫ縺ｫ霑ｽ蜉
    products.push({ id: Date.now().toString(), name, display_order: newDisplayOrder });
    document.getElementById('newProductNameInline').value = '';
    renderProductsList();
    populateProductDropdown();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast('蝠・刀繧定ｿｽ蜉縺励∪縺励◆・医Ο繝ｼ繧ｫ繝ｫ縺ｮ縺ｿ・・, 'success');
    return;
  }

  products.push(data[0]);
  document.getElementById('newProductNameInline').value = '';
  renderProductsList();
  populateProductDropdown();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('蝠・刀繧定ｿｽ蜉縺励∪縺励◆', 'success');
}

async function deleteProductInline(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;

  if (!confirm(`蝠・刀縲・{product.name}縲阪ｒ蜑企勁縺励∪縺吶°・歔)) return;

  showStatus('蜑企勁荳ｭ...', 'saving');

  const { error } = await supabase
    .from('products')
    .delete()
    .eq('id', productId);

  if (error && !error.message.includes('does not exist')) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('蜑企勁縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  products = products.filter(p => p.id !== productId);
  renderProductsList();
  populateProductDropdown();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('蝠・刀繧貞炎髯､縺励∪縺励◆', 'success');
}

// 繝峨Λ繝・げ&繝峨Ο繝・・縺ｧ蝠・刀縺ｮ陦ｨ遉ｺ鬆・ｒ螟画峩
let draggedProductId = null;

function handleProductDragStart(event, productId) {
  draggedProductId = productId;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.5';
}

function handleProductDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  return false;
}

async function handleProductDrop(event, targetProductId) {
  event.preventDefault();
  event.stopPropagation();

  if (!draggedProductId || draggedProductId === targetProductId) {
    resetProductDragState();
    return;
  }

  const draggedProduct = products.find(p => p.id === draggedProductId);
  const targetProduct = products.find(p => p.id === targetProductId);

  if (!draggedProduct || !targetProduct) {
    resetProductDragState();
    return;
  }

  // 陦ｨ遉ｺ鬆・ｒ蜈･繧梧崛縺・
  const draggedOrder = draggedProduct.display_order;
  const targetOrder = targetProduct.display_order;

  showStatus('荳ｦ縺ｳ譖ｿ縺井ｸｭ...', 'saving');

  // 荳｡譁ｹ縺ｮ蝠・刀縺ｮ陦ｨ遉ｺ鬆・ｒ譖ｴ譁ｰ
  const updates = [
    supabase.from('products').update({ display_order: targetOrder }).eq('id', draggedProductId),
    supabase.from('products').update({ display_order: draggedOrder }).eq('id', targetProductId)
  ];

  const results = await Promise.all(updates);

  if (results.some(r => r.error)) {
    // 繧ｨ繝ｩ繝ｼ縺後≠縺｣縺ｦ繧ゅΟ繝ｼ繧ｫ繝ｫ縺ｧ譖ｴ譁ｰ
    draggedProduct.display_order = targetOrder;
    targetProduct.display_order = draggedOrder;
    renderProductsList();
    populateProductDropdown();
    showStatus('荳ｦ縺ｳ譖ｿ縺亥ｮ御ｺ・, 'success');
    showToast('陦ｨ遉ｺ鬆・ｒ螟画峩縺励∪縺励◆・医Ο繝ｼ繧ｫ繝ｫ縺ｮ縺ｿ・・, 'success');
    resetProductDragState();
    return;
  }

  // 繝ｭ繝ｼ繧ｫ繝ｫ繝・・繧ｿ繧よ峩譁ｰ
  draggedProduct.display_order = targetOrder;
  targetProduct.display_order = draggedOrder;

  // 蜀肴緒逕ｻ
  renderProductsList();
  populateProductDropdown();
  showStatus('荳ｦ縺ｳ譖ｿ縺亥ｮ御ｺ・, 'success');
  showToast('陦ｨ遉ｺ鬆・ｒ螟画峩縺励∪縺励◆', 'success');
  resetProductDragState();
}

function resetProductDragState() {
  draggedProductId = null;
  // 縺吶∋縺ｦ縺ｮ陦後・騾乗・蠎ｦ繧偵Μ繧ｻ繝・ヨ
  document.querySelectorAll('#productsGrid tr[draggable]').forEach(tr => {
    tr.style.opacity = '1';
  });
}

function populateProductDropdown() {
  const select = document.getElementById('projectSpecifications');
  if (!select) return;

  const currentValue = select.value;
  select.innerHTML = '<option value="">驕ｸ謚槭＠縺ｦ縺上□縺輔＞</option>' +
    products.map(p => `<option value="${escapeHtml(p.name)}">${escapeHtml(p.name)}</option>`).join('');

  if (currentValue) select.value = currentValue;
}

// ============================================
// 繧ｿ繧ｹ繧ｯ邂｡逅・ｼ郁ｨｭ險医・IC蛻・屬・・
// ============================================
function renderTasksManagement() {
  const container = document.getElementById('tasksGrid');
  if (!container) return;

  const sekkeiTasks = tasksV2.filter(t => t.category === '險ｭ險・);

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>繧ｿ繧ｹ繧ｯ蜷・/th>
            <th style="width: 100px;">迥ｶ諷狗ｮ｡逅・/th>
            <th style="width: 120px;">透繝懊ち繝ｳ</th>
            <th>邏舌▼縺第･ｭ閠・/th>
            <th style="width: 180px;">謫堺ｽ・/th>
          </tr>
        </thead>
        <tbody id="sekkeiTasksBody">
          ${sekkeiTasks.map(task => renderTaskRow(task)).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
        盗 險ｭ險医ち繧ｹ繧ｯ: ${sekkeiTasks.length}莉ｶ逋ｻ骭ｲ貂医∩
      </p>
    </div>
  `;
}

function renderIcTasksManagement() {
  const container = document.getElementById('icTasksGrid');
  if (!container) return;

  const icTasks = tasksV2.filter(t => t.category === 'IC');

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>繧ｿ繧ｹ繧ｯ蜷・/th>
            <th style="width: 100px;">迥ｶ諷狗ｮ｡逅・/th>
            <th style="width: 120px;">透繝懊ち繝ｳ</th>
            <th>邏舌▼縺第･ｭ閠・/th>
            <th style="width: 180px;">謫堺ｽ・/th>
          </tr>
        </thead>
        <tbody id="icTasksBody">
          ${icTasks.map(task => renderTaskRow(task)).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
        耳 IC繧ｿ繧ｹ繧ｯ: ${icTasks.length}莉ｶ逋ｻ骭ｲ貂医∩
      </p>
    </div>
  `;
}

function renderTaskRow(task) {
  const mappings = taskVendorMappings.filter(m => m.task_id === task.id);
  const vendorNames = mappings.map(m => {
    const vendor = vendorsV2.find(v => v.id === m.vendor_id);
    return vendor ? vendor.company : '荳肴・';
  }).join(', ');

  const stateInfo = task.has_state ?
    `<span class="badge badge-success">縺ゅｊ</span>` :
    `<span class="badge badge-secondary">縺ｪ縺・/span>`;

  const emailButtonInfo = task.has_email_button ?
    `<span class="badge badge-success">陦ｨ遉ｺ</span>` :
    `<span class="badge badge-secondary">髱櫁｡ｨ遉ｺ</span>`;

  return `
    <tr draggable="true" ondragstart="handleTaskDragStart(event, '${task.id}')" ondragover="handleTaskDragOver(event)" ondrop="handleTaskDrop(event, '${task.id}')" style="cursor: move;">
      <td><span style="color: var(--text-muted);">站ｮ站ｮ</span></td>
      <td><strong>${escapeHtml(task.task_name)}</strong></td>
      <td>${stateInfo}</td>
      <td>${emailButtonInfo}</td>
      <td>${escapeHtml(vendorNames || '-')}</td>
      <td>
        <button class="btn btn-secondary btn-small" onclick="editTask('${task.id}')">邱ｨ髮・/button>
        <button class="btn btn-danger btn-small" onclick="deleteTask('${task.id}')">蜑企勁</button>
      </td>
    </tr>
  `;
}

// ============================================
// 螟匁ｧ区･ｭ蜍咏ｮ｡逅・
// ============================================
// 螟匁ｧ九ち繧ｹ繧ｯ縺ｮ繝・ヵ繧ｩ繝ｫ繝亥ｮ夂ｾｩ
const defaultExteriorTasks = [
  { id: 'ext_hearing', name: '繝偵い繝ｪ繝ｳ繧ｰ', order: 1, states: ['譛ｪ逹謇・, '螳御ｺ・] },
  { id: 'ext_site_survey', name: '迴ｾ蝨ｰ隱ｿ譟ｻ', order: 2, states: ['譛ｪ逹謇・, '隱ｿ譟ｻ貂・, '蝣ｱ蜻頑ｸ・] },
  { id: 'ext_first_proposal', name: '蛻晏屓謠先｡・, order: 3, states: ['譛ｪ逹謇・, '菴懈・荳ｭ', '謠仙・貂・, '謇ｿ隱・] },
  { id: 'ext_estimate', name: '隕狗ｩ堺ｽ懈・', order: 4, states: ['譛ｪ逹謇・, '菴懈・荳ｭ', '謠仙・貂・, '謇ｿ隱・] },
  { id: 'ext_final_design', name: '譛邨りｨｭ險・, order: 5, states: ['譛ｪ逹謇・, '菴懈・荳ｭ', '遒ｺ螳・] },
  { id: 'ext_material_order', name: '雉・攝逋ｺ豕ｨ', order: 6, states: ['譛ｪ逹謇・, '逋ｺ豕ｨ貂・, '邏榊刀貂・] },
  { id: 'ext_construction', name: '譁ｽ蟾･', order: 7, states: ['譛ｪ逹謇・, '逹蟾･', '騾ｲ陦御ｸｭ', '螳悟ｷ･'] },
  { id: 'ext_inspection', name: '螳御ｺ・､懈渊', order: 8, states: ['譛ｪ逹謇・, '讀懈渊貂・, '蠑墓ｸ｡螳御ｺ・] }
];

// 螟匁ｧ九ち繧ｹ繧ｯ繧偵Ο繝ｼ繧ｫ繝ｫ繧ｹ繝医Ξ繝ｼ繧ｸ縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ
let exteriorTasks = safeJsonParse(localStorage.getItem('exteriorTasks'), defaultExteriorTasks);

function renderExteriorTasksManagement() {
  const container = document.getElementById('exteriorTasksGrid');
  if (!container) return;

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>繧ｿ繧ｹ繧ｯ蜷・/th>
            <th>繧ｹ繝・・繧ｿ繧ｹ繧ｪ繝励す繝ｧ繝ｳ</th>
            <th style="width: 180px;">謫堺ｽ・/th>
          </tr>
        </thead>
        <tbody>
          ${exteriorTasks.map(task => `
            <tr>
              <td><span style="color: var(--text-muted);">站ｮ站ｮ</span></td>
              <td><strong>${task.name}</strong></td>
              <td>
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                  ${task.states.map(s => `<span class="badge badge-secondary">${s}</span>`).join('')}
                </div>
              </td>
              <td>
                <button class="btn btn-secondary btn-small" onclick="editExteriorTask('${task.id}')">邱ｨ髮・/button>
                <button class="btn btn-danger btn-small" onclick="deleteExteriorTask('${task.id}')">蜑企勁</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
        庁 螟匁ｧ区･ｭ蜍吶ち繧ｹ繧ｯ縺ｯ譯井ｻｶ繧ｫ繝ｼ繝峨・縲悟､匁ｧ倶ｾ晞ｼ縲阪そ繧ｯ繧ｷ繝ｧ繝ｳ縺ｧ菴ｿ逕ｨ縺輔ｌ縺ｾ縺吶・
        蜷・ち繧ｹ繧ｯ縺ｮ繧ｹ繝・・繧ｿ繧ｹ繧定ｨｭ螳壹＠縺ｦ縲∝､匁ｧ玖ｨｭ險医・騾ｲ謐励ｒ邂｡逅・〒縺阪∪縺吶・
      </p>
    </div>
  `;
}

function openExteriorTaskModal(taskId = null) {
  const name = taskId ? exteriorTasks.find(t => t.id === taskId)?.name : '';
  const states = taskId ? exteriorTasks.find(t => t.id === taskId)?.states.join(', ') : '譛ｪ逹謇・ 螳御ｺ・;

  const newName = prompt('繧ｿ繧ｹ繧ｯ蜷阪ｒ蜈･蜉・', name);
  if (!newName) return;

  const newStates = prompt('繧ｹ繝・・繧ｿ繧ｹ繧ｪ繝励す繝ｧ繝ｳ・医き繝ｳ繝槫玄蛻・ｊ・・', states);
  if (!newStates) return;

  const statesArray = newStates.split(',').map(s => s.trim()).filter(s => s);

  if (taskId) {
    const task = exteriorTasks.find(t => t.id === taskId);
    if (task) {
      task.name = newName;
      task.states = statesArray;
    }
  } else {
    exteriorTasks.push({
      id: 'ext_' + Date.now(),
      name: newName,
      order: exteriorTasks.length + 1,
      states: statesArray
    });
  }

  localStorage.setItem('exteriorTasks', JSON.stringify(exteriorTasks));
  renderExteriorTasksManagement();
  showToast('螟匁ｧ九ち繧ｹ繧ｯ繧剃ｿ晏ｭ倥＠縺ｾ縺励◆', 'success');
}

function editExteriorTask(taskId) {
  openExteriorTaskModal(taskId);
}

function deleteExteriorTask(taskId) {
  if (!confirm('縺薙・繧ｿ繧ｹ繧ｯ繧貞炎髯､縺励∪縺吶°・・)) return;

  exteriorTasks = exteriorTasks.filter(t => t.id !== taskId);
  localStorage.setItem('exteriorTasks', JSON.stringify(exteriorTasks));
  renderExteriorTasksManagement();
  showToast('繧ｿ繧ｹ繧ｯ繧貞炎髯､縺励∪縺励◆', 'success');
}

// 荳榊虚逕｣繝・ヵ繧ｩ繝ｫ繝医ち繧ｹ繧ｯ螳夂ｾｩ
const defaultRealestateTasks = [
  { id: 'real_hearing', name: '繝偵い繝ｪ繝ｳ繧ｰ', order: 1, states: ['譛ｪ逹謇・, '螳滓命荳ｭ', '螳御ｺ・] },
  { id: 'real_search', name: '迚ｩ莉ｶ讀懃ｴ｢', order: 2, states: ['譛ｪ逹謇・, '讀懃ｴ｢荳ｭ', '蛟呵｣懊≠繧・, '螳御ｺ・] },
  { id: 'real_inspection', name: '迚ｩ莉ｶ蜀・ｦ・, order: 3, states: ['譛ｪ逹謇・, '譌･遞玖ｪｿ謨ｴ荳ｭ', '蜀・ｦ区ｸ・, '螳御ｺ・] },
  { id: 'real_proposal', name: '謠先｡・, order: 4, states: ['譛ｪ逹謇・, '雉・侭菴懈・荳ｭ', '謠先｡域ｸ・, '謇ｿ隱・] },
  { id: 'real_negotiation', name: '莠､貂・, order: 5, states: ['譛ｪ逹謇・, '莠､貂我ｸｭ', '蜷域э', '螳御ｺ・] },
  { id: 'real_contract', name: '螂醍ｴ・, order: 6, states: ['譛ｪ逹謇・, '譖ｸ鬘樊ｺ門ｙ', '螂醍ｴ・ｸ・, '螳御ｺ・] },
  { id: 'real_loan', name: '繝ｭ繝ｼ繝ｳ謇狗ｶ壹″', order: 7, states: ['譛ｪ逹謇・, '逕ｳ霎ｼ荳ｭ', '蟇ｩ譟ｻ荳ｭ', '謇ｿ隱・, '螳御ｺ・] },
  { id: 'real_settlement', name: '豎ｺ貂医・蠑墓ｸ｡', order: 8, states: ['譛ｪ逹謇・, '貅門ｙ荳ｭ', '豎ｺ貂亥ｮ御ｺ・, '蠑墓ｸ｡螳御ｺ・] }
];

// 荳榊虚逕｣繧ｿ繧ｹ繧ｯ繧偵Ο繝ｼ繧ｫ繝ｫ繧ｹ繝医Ξ繝ｼ繧ｸ縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ
let realestateTasks = safeJsonParse(localStorage.getItem('realestateTasks'), defaultRealestateTasks);

// 蟾･莠九ョ繝輔か繝ｫ繝医ち繧ｹ繧ｯ螳夂ｾｩ
const defaultConstructionTasks = [
  { id: 'const_hearing', name: '繝偵い繝ｪ繝ｳ繧ｰ', order: 1, states: ['譛ｪ逹謇・, '螳滓命荳ｭ', '螳御ｺ・] },
  { id: 'const_survey', name: '迴ｾ蝨ｰ隱ｿ譟ｻ', order: 2, states: ['譛ｪ逹謇・, '隱ｿ譟ｻ貂・, '蝣ｱ蜻頑ｸ・] },
  { id: 'const_estimate', name: '隕狗ｩ堺ｽ懈・', order: 3, states: ['譛ｪ逹謇・, '菴懈・荳ｭ', '謠仙・貂・, '謇ｿ隱・] },
  { id: 'const_contract', name: '蟾･莠句･醍ｴ・, order: 4, states: ['譛ｪ逹謇・, '隱ｿ謨ｴ荳ｭ', '螂醍ｴ・ｸ・] },
  { id: 'const_permit', name: '螻雁・繝ｻ險ｱ蜿ｯ', order: 5, states: ['譛ｪ逹謇・, '逕ｳ隲倶ｸｭ', '險ｱ蜿ｯ貂・] },
  { id: 'const_order', name: '雉・攝逋ｺ豕ｨ', order: 6, states: ['譛ｪ逹謇・, '逋ｺ豕ｨ貂・, '邏榊刀貂・] },
  { id: 'const_start', name: '逹蟾･', order: 7, states: ['譛ｪ逹謇・, '貅門ｙ荳ｭ', '逹蟾･貂・] },
  { id: 'const_progress', name: '譁ｽ蟾･', order: 8, states: ['譛ｪ逹謇・, '蝓ｺ遉主ｷ･莠・, '霄ｯ菴灘ｷ･莠・, '莉穂ｸ雁ｷ･莠・, '螳御ｺ・] },
  { id: 'const_inspection', name: '螳御ｺ・､懈渊', order: 9, states: ['譛ｪ逹謇・, '讀懈渊莠育ｴ・, '讀懈渊貂・, '譏ｯ豁｣螳御ｺ・] },
  { id: 'const_handover', name: '蠑墓ｸ｡縺・, order: 10, states: ['譛ｪ逹謇・, '譛邨ら｢ｺ隱・, '蠑墓ｸ｡螳御ｺ・] }
];

// 蟾･莠九ち繧ｹ繧ｯ繧偵Ο繝ｼ繧ｫ繝ｫ繧ｹ繝医Ξ繝ｼ繧ｸ縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ
let constructionTasks = safeJsonParse(localStorage.getItem('constructionTasks'), defaultConstructionTasks);

// 荳榊虚逕｣讌ｭ蜍咏ｮ｡逅・
function renderRealestateTasksManagement() {
  const container = document.getElementById('realestateTasksGrid');
  if (!container) return;

  container.innerHTML = `
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th style="width: 40px;">鬆・ｺ・/th>
            <th>繧ｿ繧ｹ繧ｯ蜷・/th>
            <th>繧ｹ繝・・繧ｿ繧ｹ繧ｪ繝励す繝ｧ繝ｳ</th>
            <th style="width: 150px;">謫堺ｽ・/th>
          </tr>
        </thead>
        <tbody>
          ${realestateTasks.map((task, index) => `
            <tr>
              <td>${index + 1}</td>
              <td><strong>${task.name}</strong></td>
              <td>
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                  ${task.states.map(s => `<span class="badge badge-secondary">${s}</span>`).join('')}
                </div>
              </td>
              <td>
                <button class="btn btn-secondary btn-small" onclick="editRealestateTask('${task.id}')">邱ｨ髮・/button>
                <button class="btn btn-danger btn-small" onclick="deleteRealestateTask('${task.id}')">蜑企勁</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
        庁 荳榊虚逕｣讌ｭ蜍吶ち繧ｹ繧ｯ縺ｯ譯井ｻｶ繧ｫ繝ｼ繝峨・縲御ｸ榊虚逕｣讌ｭ蜍吝・螳ｹ縲阪そ繧ｯ繧ｷ繝ｧ繝ｳ縺ｧ菴ｿ逕ｨ縺輔ｌ縺ｾ縺吶・
      </p>
    </div>
  `;
}

function openRealestateTaskModal(taskId = null) {
  const name = taskId ? realestateTasks.find(t => t.id === taskId)?.name : '';
  const states = taskId ? realestateTasks.find(t => t.id === taskId)?.states.join(', ') : '譛ｪ逹謇・ 螳御ｺ・;

  const newName = prompt('繧ｿ繧ｹ繧ｯ蜷阪ｒ蜈･蜉・', name);
  if (!newName) return;

  const newStates = prompt('繧ｹ繝・・繧ｿ繧ｹ繧ｪ繝励す繝ｧ繝ｳ・医き繝ｳ繝槫玄蛻・ｊ・・', states);
  if (!newStates) return;

  const statesArray = newStates.split(',').map(s => s.trim()).filter(s => s);

  if (taskId) {
    const task = realestateTasks.find(t => t.id === taskId);
    if (task) {
      task.name = newName;
      task.states = statesArray;
    }
  } else {
    realestateTasks.push({
      id: 're_' + Date.now(),
      name: newName,
      order: realestateTasks.length + 1,
      states: statesArray
    });
  }

  localStorage.setItem('realestateTasks', JSON.stringify(realestateTasks));
  renderRealestateTasksManagement();
  showToast('荳榊虚逕｣繧ｿ繧ｹ繧ｯ繧剃ｿ晏ｭ倥＠縺ｾ縺励◆', 'success');
}

function editRealestateTask(taskId) {
  openRealestateTaskModal(taskId);
}

function deleteRealestateTask(taskId) {
  if (!confirm('縺薙・繧ｿ繧ｹ繧ｯ繧貞炎髯､縺励∪縺吶°・・)) return;

  realestateTasks = realestateTasks.filter(t => t.id !== taskId);
  localStorage.setItem('realestateTasks', JSON.stringify(realestateTasks));
  renderRealestateTasksManagement();
  showToast('繧ｿ繧ｹ繧ｯ繧貞炎髯､縺励∪縺励◆', 'success');
}

// 蟾･莠区･ｭ蜍咏ｮ｡逅・
function renderConstructionTasksManagement() {
  const container = document.getElementById('constructionTasksGrid');
  if (!container) return;

  container.innerHTML = `
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th style="width: 40px;">鬆・ｺ・/th>
            <th>繧ｿ繧ｹ繧ｯ蜷・/th>
            <th>繧ｹ繝・・繧ｿ繧ｹ繧ｪ繝励す繝ｧ繝ｳ</th>
            <th style="width: 150px;">謫堺ｽ・/th>
          </tr>
        </thead>
        <tbody>
          ${constructionTasks.map((task, index) => `
            <tr>
              <td>${index + 1}</td>
              <td><strong>${task.name}</strong></td>
              <td>
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                  ${task.states.map(s => `<span class="badge badge-secondary">${s}</span>`).join('')}
                </div>
              </td>
              <td>
                <button class="btn btn-secondary btn-small" onclick="editConstructionTask('${task.id}')">邱ｨ髮・/button>
                <button class="btn btn-danger btn-small" onclick="deleteConstructionTask('${task.id}')">蜑企勁</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
        庁 蟾･莠区･ｭ蜍吶ち繧ｹ繧ｯ縺ｯ譯井ｻｶ繧ｫ繝ｼ繝峨・縲悟ｷ･莠区･ｭ蜍吝・螳ｹ縲阪そ繧ｯ繧ｷ繝ｧ繝ｳ縺ｧ菴ｿ逕ｨ縺輔ｌ縺ｾ縺吶・
      </p>
    </div>
  `;
}

function openConstructionTaskModal(taskId = null) {
  const name = taskId ? constructionTasks.find(t => t.id === taskId)?.name : '';
  const states = taskId ? constructionTasks.find(t => t.id === taskId)?.states.join(', ') : '譛ｪ逹謇・ 螳御ｺ・;

  const newName = prompt('繧ｿ繧ｹ繧ｯ蜷阪ｒ蜈･蜉・', name);
  if (!newName) return;

  const newStates = prompt('繧ｹ繝・・繧ｿ繧ｹ繧ｪ繝励す繝ｧ繝ｳ・医き繝ｳ繝槫玄蛻・ｊ・・', states);
  if (!newStates) return;

  const statesArray = newStates.split(',').map(s => s.trim()).filter(s => s);

  if (taskId) {
    const task = constructionTasks.find(t => t.id === taskId);
    if (task) {
      task.name = newName;
      task.states = statesArray;
    }
  } else {
    constructionTasks.push({
      id: 'con_' + Date.now(),
      name: newName,
      order: constructionTasks.length + 1,
      states: statesArray
    });
  }

  localStorage.setItem('constructionTasks', JSON.stringify(constructionTasks));
  renderConstructionTasksManagement();
  showToast('蟾･莠九ち繧ｹ繧ｯ繧剃ｿ晏ｭ倥＠縺ｾ縺励◆', 'success');
}

function editConstructionTask(taskId) {
  openConstructionTaskModal(taskId);
}

function deleteConstructionTask(taskId) {
  if (!confirm('縺薙・繧ｿ繧ｹ繧ｯ繧貞炎髯､縺励∪縺吶°・・)) return;

  constructionTasks = constructionTasks.filter(t => t.id !== taskId);
  localStorage.setItem('constructionTasks', JSON.stringify(constructionTasks));
  renderConstructionTasksManagement();
  showToast('繧ｿ繧ｹ繧ｯ繧貞炎髯､縺励∪縺励◆', 'success');
}

function openTaskModal(taskIdOrCategory = null) {
  const modal = document.getElementById('taskModal');
  const title = document.getElementById('taskModalTitle');

  // 繧ｫ繝・ざ繝ｪ蜷阪′貂｡縺輔ｌ縺溷ｴ蜷茨ｼ域眠隕剰ｿｽ蜉・・
  const isCategory = taskIdOrCategory === '險ｭ險・ || taskIdOrCategory === 'IC';

  if (taskIdOrCategory && !isCategory) {
    // 邱ｨ髮・Δ繝ｼ繝会ｼ・askId縺梧ｸ｡縺輔ｌ縺滂ｼ・
    const task = tasksV2.find(t => t.id === taskIdOrCategory);
    if (!task) return;

    title.textContent = '繧ｿ繧ｹ繧ｯ邱ｨ髮・;
    document.getElementById('taskId').value = task.id;
    document.getElementById('taskKey').value = task.task_key;
    document.getElementById('taskName').value = task.task_name;
    document.getElementById('taskCategory').value = task.category;
    document.getElementById('taskOrder').value = task.display_order;
    document.getElementById('taskHasState').checked = task.has_state;
    renderStateOptions(task.state_options || []);
    document.getElementById('taskHasEmailButton').checked = task.has_email_button !== false;
    toggleTaskState();
    populateTaskVendorSelection(taskIdOrCategory);
  } else {
    // 譁ｰ隕剰ｿｽ蜉繝｢繝ｼ繝・
    const category = isCategory ? taskIdOrCategory : '險ｭ險・;
    title.textContent = `${category}繧ｿ繧ｹ繧ｯ霑ｽ蜉`;
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
    document.getElementById('taskCategory').value = category;
    document.getElementById('taskOrder').value = tasksV2.filter(t => t.category === category).length + 1;
    document.getElementById('taskHasState').checked = false;
    document.getElementById('taskHasEmailButton').checked = true;
    renderStateOptions([]);
    toggleTaskState();
    populateTaskVendorSelection(null);
  }

  ModalManager.open(modal, '#taskKey');
}

function populateTaskVendorSelection(taskId) {
  const container = document.getElementById('taskVendorSelection');
  if (!container) return;

  // 迴ｾ蝨ｨ縺ｮ繧ｿ繧ｹ繧ｯ縺ｫ邏舌▼縺・※縺・ｋ讌ｭ閠・D繝ｪ繧ｹ繝医ｒ蜿門ｾ・
  const currentMappings = taskId ? taskVendorMappings.filter(m => m.task_id === taskId).map(m => m.vendor_id) : [];

  // 繧ｫ繝・ざ繝ｪ縺斐→縺ｫ繧ｰ繝ｫ繝ｼ繝怜喧縺励※陦ｨ遉ｺ
  const categories = [...new Set(vendorsV2.map(v => v.vendor_categories?.name || '譛ｪ蛻・｡・))].sort();

  container.innerHTML = categories.map(category => {
    const categoryVendors = vendorsV2.filter(v => (v.vendor_categories?.name || '譛ｪ蛻・｡・) === category);

    return `
      <div style="margin-bottom: 12px;">
        <div style="font-weight: 600; color: #4A90E2; margin-bottom: 4px; font-size: 12px;">${category}</div>
        ${categoryVendors.map(vendor => `
          <label style="display: block; padding: 4px 0; cursor: pointer;">
            <input type="checkbox"
                   value="${vendor.id}"
                   ${currentMappings.includes(vendor.id) ? 'checked' : ''}
                   style="margin-right: 8px;">
            ${escapeHtml(vendor.company)}
          </label>
        `).join('')}
      </div>
    `;
  }).join('');
}

function closeTaskModal() {
  ModalManager.close(document.getElementById('taskModal'));
}

function toggleTaskState() {
  const hasState = document.getElementById('taskHasState').checked;
  const stateGroup = document.getElementById('stateOptionsGroup');
  stateGroup.style.display = hasState ? 'block' : 'none';
}

function renderStateOptions(options = []) {
  const container = document.getElementById('stateOptionsList');
  if (!container) return;

  // 遨ｺ縺ｮ縲・縲阪・髯､螟悶＠縺ｦ陦ｨ遉ｺ
  const filteredOptions = options.filter(opt => opt && opt !== '-' && opt !== '');

  if (filteredOptions.length === 0) {
    // 繝・ヵ繧ｩ繝ｫ繝医〒1縺､遨ｺ縺ｮ蜈･蜉帶ｬ・ｒ陦ｨ遉ｺ
    filteredOptions.push('');
  }

  container.innerHTML = filteredOptions.map((opt, index) => `
    <div class="state-option-item">
      <input type="text" class="state-option-input" value="${escapeHtml(opt)}" placeholder="萓具ｼ壻ｾ晞ｼ貂・>
      <button type="button" class="btn-remove" onclick="removeStateOption(${index})">蜑企勁</button>
    </div>
  `).join('');
}

function addStateOption() {
  const container = document.getElementById('stateOptionsList');
  if (!container) return;

  const newItem = document.createElement('div');
  newItem.className = 'state-option-item';
  newItem.innerHTML = `
    <input type="text" class="state-option-input" value="" placeholder="萓具ｼ壻ｾ晞ｼ貂・>
    <button type="button" class="btn-remove" onclick="this.parentElement.remove()">蜑企勁</button>
  `;
  container.appendChild(newItem);
  newItem.querySelector('input').focus();
}

function removeStateOption(index) {
  const container = document.getElementById('stateOptionsList');
  if (!container) return;

  const items = container.querySelectorAll('.state-option-item');
  if (items[index]) {
    items[index].remove();
  }
}

function collectStateOptions() {
  const container = document.getElementById('stateOptionsList');
  if (!container) return [];

  const inputs = container.querySelectorAll('.state-option-input');
  const options = ['-']; // 蜈磯ｭ縺ｫ遨ｺ縺ｮ驕ｸ謚櫁い繧定ｿｽ蜉

  inputs.forEach(input => {
    const value = input.value.trim();
    if (value && value !== '-') {
      options.push(value);
    }
  });

  return options;
}

async function saveTask() {
  if (SaveGuard.isLocked('saveTask')) return;

  const id = document.getElementById('taskId')?.value || '';
  const taskName = document.getElementById('taskName')?.value?.trim() || '';
  const category = document.getElementById('taskCategory')?.value || '';
  const order = parseInt(document.getElementById('taskOrder')?.value) || 0;
  const hasState = document.getElementById('taskHasState')?.checked || false;
  const hasEmailButton = document.getElementById('taskHasEmailButton')?.checked || false;

  if (!taskName) {
    showToast('繧ｿ繧ｹ繧ｯ蜷阪ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  // 繧ｿ繧ｹ繧ｯ繧ｭ繝ｼ繧定・蜍慕函謌撰ｼ育ｷｨ髮・凾縺ｯ譌｢蟄倥・繧ｭ繝ｼ繧剃ｽｿ逕ｨ・・
  let taskKey = document.getElementById('taskKey').value;
  if (!taskKey) {
    // 譁ｰ隕丈ｽ懈・譎ゑｼ壹ち繧ｹ繧ｯ蜷阪°繧芽・蜍慕函謌撰ｼ域律譛ｬ隱槭ｒ蜑企勁縺励√せ繝壹・繧ｹ繧偵い繝ｳ繝繝ｼ繧ｹ繧ｳ繧｢縺ｫ螟画鋤・・
    taskKey = 'task_' + taskName.replace(/[\u3000-\u9FFF]/g, '').replace(/\s+/g, '_').toLowerCase() + '_' + Date.now();
    // 螳牙・縺ｮ縺溘ａ縲∬恭謨ｰ蟄励→繧｢繝ｳ繝繝ｼ繧ｹ繧ｳ繧｢縺ｮ縺ｿ縺ｫ蛻ｶ髯・
    taskKey = taskKey.replace(/[^a-z0-9_]/g, '_');
  }

  // 迥ｶ諷九が繝励す繝ｧ繝ｳ繧貞虚逧・Μ繧ｹ繝医°繧牙庶髮・
  let stateOptions = null;
  if (hasState) {
    stateOptions = collectStateOptions();
  }

  await SaveGuard.run('saveTask', async () => {
    showStatus('菫晏ｭ倅ｸｭ...', 'saving');

    const taskData = {
      task_key: taskKey,
      task_name: taskName,
      category,
      display_order: order,
      has_state: hasState,
      state_options: stateOptions,
      has_email_button: hasEmailButton
    };

    let result;
    if (id) {
      result = await supabase
        .from('tasks')
        .update(taskData)
        .eq('id', id)
        .select();
    } else {
      result = await supabase
        .from('tasks')
        .insert([taskData])
        .select();
    }

    if (result.error) {
      showStatus('菫晏ｭ伜､ｱ謨・, 'error');
      showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + result.error.message, 'error');
      return;
    }

    // 讌ｭ閠・ｴ舌▼縺代・菫晏ｭ・
    const savedTaskId = id || result.data[0].id;
    await saveTaskVendorMappings(savedTaskId);

    showStatus('菫晏ｭ伜ｮ御ｺ・, 'success');
    showToast(id ? '繧ｿ繧ｹ繧ｯ繧呈峩譁ｰ縺励∪縺励◆' : '繧ｿ繧ｹ繧ｯ繧定ｿｽ蜉縺励∪縺励◆', 'success');
    closeTaskModal();
    await loadTasksV2();
    await loadTaskVendorMappings();
    renderTasksManagement();
  });
}

async function saveTaskVendorMappings(taskId) {
  // 驕ｸ謚槭＆繧後◆讌ｭ閠・D繧貞叙蠕・
  const checkboxes = document.querySelectorAll('#taskVendorSelection input[type="checkbox"]:checked');
  const selectedVendorIds = Array.from(checkboxes).map(cb => cb.value);

  // 譌｢蟄倥・邏舌▼縺代ｒ蜈ｨ蜑企勁
  const { error: deleteError } = await supabase
    .from('task_vendor_mappings_v2')
    .delete()
    .eq('task_id', taskId);

  if (deleteError) {
    logError('讌ｭ閠・ｴ舌▼縺大炎髯､繧ｨ繝ｩ繝ｼ:', deleteError);
    showToast('譌｢蟄倥・邏舌▼縺大炎髯､縺ｫ螟ｱ謨励＠縺ｾ縺励◆', 'error');
    return;
  }

  // 譁ｰ縺励＞邏舌▼縺代ｒ菴懈・
  if (selectedVendorIds.length > 0) {
    const mappings = selectedVendorIds.map(vendorId => ({
      task_id: taskId,
      vendor_id: vendorId
    }));

    const { error } = await supabase
      .from('task_vendor_mappings_v2')
      .insert(mappings);

    if (error) {
      logError('讌ｭ閠・ｴ舌▼縺台ｿ晏ｭ倥お繝ｩ繝ｼ:', error);
      showToast('讌ｭ閠・ｴ舌▼縺代・菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
    }
  }
}

function editTask(taskId) {
  openTaskModal(taskId);
}

async function deleteTask(taskId) {
  const task = tasksV2.find(t => t.id === taskId);
  if (!task) return;

  if (!confirm(`繧ｿ繧ｹ繧ｯ縲・{task.task_name}縲阪ｒ蜑企勁縺励∪縺吶°・歔)) return;

  await SaveGuard.run(`deleteTask_${taskId}`, async () => {
    showStatus('蜑企勁荳ｭ...', 'saving');

    const { error } = await supabase
      .from('tasks')
      .delete()
      .eq('id', taskId);

    if (error) {
      showStatus('蜑企勁螟ｱ謨・, 'error');
      showToast('蜑企勁縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
      return;
    }

    showStatus('蜑企勁螳御ｺ・, 'success');
    showToast('繧ｿ繧ｹ繧ｯ繧貞炎髯､縺励∪縺励◆', 'success');
    await loadTasksV2();
    renderTasksManagement();
  });
}

// 繝峨Λ繝・げ&繝峨Ο繝・・縺ｧ繧ｿ繧ｹ繧ｯ縺ｮ陦ｨ遉ｺ鬆・ｒ螟画峩
let draggedTaskId = null;

function handleTaskDragStart(event, taskId) {
  draggedTaskId = taskId;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.5';
}

function handleTaskDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  return false;
}

async function handleTaskDrop(event, targetTaskId) {
  event.preventDefault();
  event.stopPropagation();

  if (!draggedTaskId || draggedTaskId === targetTaskId) {
    resetDragState();
    return;
  }

  const draggedTask = tasksV2.find(t => t.id === draggedTaskId);
  const targetTask = tasksV2.find(t => t.id === targetTaskId);

  if (!draggedTask || !targetTask) {
    resetDragState();
    return;
  }

  // 蜷後§繧ｫ繝・ざ繝ｪ蜀・〒縺ｮ縺ｿ荳ｦ縺ｳ譖ｿ縺亥庄閭ｽ
  if (draggedTask.category !== targetTask.category) {
    showToast('蜷後§繧ｫ繝・ざ繝ｪ蜀・〒縺ｮ縺ｿ荳ｦ縺ｳ譖ｿ縺亥庄閭ｽ縺ｧ縺・, 'error');
    resetDragState();
    return;
  }

  // 陦ｨ遉ｺ鬆・ｒ蜈･繧梧崛縺・
  const draggedOrder = draggedTask.display_order;
  const targetOrder = targetTask.display_order;

  showStatus('荳ｦ縺ｳ譖ｿ縺井ｸｭ...', 'saving');

  // 荳｡譁ｹ縺ｮ繧ｿ繧ｹ繧ｯ縺ｮ陦ｨ遉ｺ鬆・ｒ譖ｴ譁ｰ
  const updates = [
    supabase.from('tasks').update({ display_order: targetOrder }).eq('id', draggedTaskId),
    supabase.from('tasks').update({ display_order: draggedOrder }).eq('id', targetTaskId)
  ];

  const results = await Promise.all(updates);

  if (results.some(r => r.error)) {
    showStatus('荳ｦ縺ｳ譖ｿ縺亥､ｱ謨・, 'error');
    showToast('荳ｦ縺ｳ譖ｿ縺医↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
    resetDragState();
    return;
  }

  // 繝ｭ繝ｼ繧ｫ繝ｫ繝・・繧ｿ繧よ峩譁ｰ
  draggedTask.display_order = targetOrder;
  targetTask.display_order = draggedOrder;

  // 蜀肴緒逕ｻ
  renderTasksManagement();
  showStatus('荳ｦ縺ｳ譖ｿ縺亥ｮ御ｺ・, 'success');
  showToast('陦ｨ遉ｺ鬆・ｒ螟画峩縺励∪縺励◆', 'success');
  resetDragState();
}

function resetDragState() {
  draggedTaskId = null;
  // 縺吶∋縺ｦ縺ｮ陦後・騾乗・蠎ｦ繧偵Μ繧ｻ繝・ヨ
  document.querySelectorAll('#tasksGrid tr[draggable]').forEach(tr => {
    tr.style.opacity = '1';
  });
}

// ============================================
// UI蛻ｶ蠕｡
// ============================================
// 繧ｵ繧､繝峨ヰ繝ｼ謠冗判
function renderSidebar() {
  const container = document.getElementById('sidebarContent');
  if (!container) return;

  const sekkeiDesigners = getSekkeiDesigners();
  const icDesigners = getIcDesigners();
  // 蜈ｨ譯井ｻｶ: 螳御ｺ・ｸ茨ｼ・s_archived・峨ｒ髯､螟・
  const allCount = projects.filter(p => p.status !== 'completed' && !p.is_archived).length;

  // 螳御ｺ・ｸ医・莉ｶ謨ｰ
  const archivedCount = projects.filter(p => p.is_archived).length;

  let html = `
    <div class="sidebar-section">
      <div class="sidebar-item ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="selectDesigner('ALL')">
        <span class="sidebar-item-label">蜈ｨ譯井ｻｶ</span>
        <span class="sidebar-item-count">${allCount}</span>
      </div>
      <div class="sidebar-item ${currentDesignerTab === 'ARCHIVED' ? 'active' : ''}" onclick="selectDesigner('ARCHIVED')" style="background: ${currentDesignerTab === 'ARCHIVED' ? 'var(--success-bg)' : 'transparent'};">
        <span class="sidebar-item-label" style="color: var(--success-color);">笨・螳御ｺ・ｸ・/span>
        <span class="sidebar-item-count" style="background: var(--success-color); color: white;">${archivedCount}</span>
      </div>
    </div>
  `;

  // 莉ｶ謨ｰ縺ｫ繧医ｋ濶ｲ蛻・￠繝倥Ν繝代・髢｢謨ｰ
  function getCountStyle(count) {
    if (count >= 7) {
      return 'color: #dc2626; font-weight: 700;'; // 襍､濶ｲ・亥些髯ｺ・・
    } else if (count >= 5) {
      return 'color: #d97706; font-weight: 600;'; // 鮟・牡・域ｳｨ諢擾ｼ・
    }
    return ''; // 騾壼ｸｸ・・莉ｶ莉･荳具ｼ・
  }

  function getCountBadgeClass(count) {
    if (count >= 7) return 'badge-danger';
    if (count >= 5) return 'badge-warning';
    return 'badge-primary';
  }

  if (sekkeiDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">盗 險ｭ險域球蠖・/div>';
    sekkeiDesigners.forEach(designer => {
      const designerName = designer.name.trim();
      const count = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        return assigned === designerName && p.status !== 'completed' && !p.is_archived;
      }).length;
      const archivedCountForDesigner = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        return assigned === designerName && p.is_archived;
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-counts">
            <span class="sidebar-item-count ${badgeClass}">${count}</span>
            ${archivedCountForDesigner > 0 ? `<span class="sidebar-archived-count" onclick="event.stopPropagation(); selectDesignerArchived('${designer.name}')" title="螳御ｺ・ｸ医ｒ陦ｨ遉ｺ">笨・{archivedCountForDesigner}</span>` : ''}
          </span>
        </div>
      `;
    });
    html += '</div>';
  }

  if (icDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">耳 IC諡・ｽ・/div>';
    icDesigners.forEach(designer => {
      const designerName = designer.name.trim();
      // IC諡・ｽ楢・・蝣ｴ蜷医・俣蜿也｢ｺ螳壹′螳御ｺ・＠縺ｦ縺・ｋ譯井ｻｶ縺ｮ縺ｿ陦ｨ遉ｺ
      // 逕ｳ隲季O貂医∩・・s_archived・峨〒繧・C騾ｲ謐・00%譛ｪ貅縺ｯ繧｢繧ｯ繝・ぅ繝悶→縺励※謇ｱ縺・
      const count = projects.filter(p => {
        // 髢灘叙遒ｺ螳壽律縺後↑縺・｡井ｻｶ縺ｯIC縺ｫ陦ｨ遉ｺ縺励↑縺・
        if (!p.layout_confirmed_date) return false;
        const assigned = (p.assigned_to || '').trim();
        const icAssigned = (p.ic_assignee || '').trim();
        const isMyProject = assigned === designerName || icAssigned === designerName;
        if (!isMyProject) return false;
        if (p.status === 'completed') return false;
        // 逕ｳ隲季O貂医∩縺ｮ蝣ｴ蜷医！C騾ｲ謐・00%縺ｪ繧牙ｮ御ｺ・桶縺・∵悴貅縺ｪ繧峨い繧ｯ繝・ぅ繝匁桶縺・
        if (p.is_archived) {
          const icProgress = calculateICProgress(p);
          return icProgress !== null && icProgress < 100;
        }
        return true;
      }).length;
      // IC諡・ｽ楢・・螳御ｺ・｡井ｻｶ: 逕ｳ隲季O貂医∩縺九▽IC騾ｲ謐・00%・磯俣蜿也｢ｺ螳壽ｸ医∩縺ｮ縺ｿ・・
      const archivedCountForDesigner = projects.filter(p => {
        // 髢灘叙遒ｺ螳壽律縺後↑縺・｡井ｻｶ縺ｯIC縺ｫ陦ｨ遉ｺ縺励↑縺・
        if (!p.layout_confirmed_date) return false;
        const assigned = (p.assigned_to || '').trim();
        const icAssigned = (p.ic_assignee || '').trim();
        const isMyProject = assigned === designerName || icAssigned === designerName;
        if (!isMyProject) return false;
        if (!p.is_archived) return false;
        const icProgress = calculateICProgress(p);
        return icProgress === null || icProgress === 100; // IC諡・ｽ薙↑縺励√∪縺溘・IC騾ｲ謐・00%
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-counts">
            <span class="sidebar-item-count ${badgeClass}">${count}</span>
            ${archivedCountForDesigner > 0 ? `<span class="sidebar-archived-count" onclick="event.stopPropagation(); selectDesignerArchived('${designer.name}')" title="螳御ｺ・ｸ医ｒ陦ｨ遉ｺ">笨・{archivedCountForDesigner}</span>` : ''}
          </span>
        </div>
      `;
    });
    html += '</div>';
  }

  // 螟匁ｧ区球蠖・
  const exteriorDesigners = getExteriorDesigners();
  if (exteriorDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">升 螟匁ｧ区球蠖・/div>';
    exteriorDesigners.forEach(designer => {
      const designerName = designer.name.trim();
      const count = projects.filter(p => {
        const exteriorAssigned = (p.exterior_assignee || '').trim();
        return exteriorAssigned === designerName && p.status !== 'completed' && !p.is_archived;
      }).length;
      const archivedCountForDesigner = projects.filter(p => {
        const exteriorAssigned = (p.exterior_assignee || '').trim();
        return exteriorAssigned === designerName && p.is_archived;
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-counts">
            <span class="sidebar-item-count ${badgeClass}">${count}</span>
            ${archivedCountForDesigner > 0 ? `<span class="sidebar-archived-count" onclick="event.stopPropagation(); selectDesignerArchived('${designer.name}')" title="螳御ｺ・ｸ医ｒ陦ｨ遉ｺ">笨・{archivedCountForDesigner}</span>` : ''}
          </span>
        </div>
      `;
    });
    html += '</div>';
  }

  // 荳榊虚逕｣諡・ｽ・
  const realestateDesigners = getRealestateDesigners();
  if (realestateDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">召 荳榊虚逕｣諡・ｽ・/div>';
    realestateDesigners.forEach(designer => {
      const designerName = designer.name.trim();
      const count = projects.filter(p => {
        const realestateAssigned = (p.realestate_assignee || '').trim();
        return realestateAssigned === designerName && p.status !== 'completed' && !p.is_archived;
      }).length;
      const archivedCountForDesigner = projects.filter(p => {
        const realestateAssigned = (p.realestate_assignee || '').trim();
        return realestateAssigned === designerName && p.is_archived;
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-counts">
            <span class="sidebar-item-count ${badgeClass}">${count}</span>
            ${archivedCountForDesigner > 0 ? `<span class="sidebar-archived-count" onclick="event.stopPropagation(); selectDesignerArchived('${designer.name}')" title="螳御ｺ・ｸ医ｒ陦ｨ遉ｺ">笨・{archivedCountForDesigner}</span>` : ''}
          </span>
        </div>
      `;
    });
    html += '</div>';
  }

  // 蟾･莠区球蠖・
  const constructionDesigners = getConstructionDesigners();
  if (constructionDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">畑 蟾･莠区球蠖・/div>';
    constructionDesigners.forEach(designer => {
      const designerName = designer.name.trim();
      const count = projects.filter(p => {
        const constructionAssigned = (p.construction_assignee || '').trim();
        return constructionAssigned === designerName && p.status !== 'completed' && !p.is_archived;
      }).length;
      const archivedCountForDesigner = projects.filter(p => {
        const constructionAssigned = (p.construction_assignee || '').trim();
        return constructionAssigned === designerName && p.is_archived;
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-counts">
            <span class="sidebar-item-count ${badgeClass}">${count}</span>
            ${archivedCountForDesigner > 0 ? `<span class="sidebar-archived-count" onclick="event.stopPropagation(); selectDesignerArchived('${designer.name}')" title="螳御ｺ・ｸ医ｒ陦ｨ遉ｺ">笨・{archivedCountForDesigner}</span>` : ''}
          </span>
        </div>
      `;
    });
    html += '</div>';
  }

  container.innerHTML = html;
}

function selectDesigner(name) {
  currentDesignerTab = name;
  console.log('套 selectDesigner: 諡・ｽ楢・､画峩', { name, currentDesignerTab });

  // 繧｢繝ｼ繧ｫ繧､繝悶ヵ繧｣繝ｫ繧ｿ繝ｼ繧偵Μ繧ｻ繝・ヨ
  const archiveFilter = document.getElementById('archiveFilter');
  if (archiveFilter) {
    if (name === 'ARCHIVED') {
      // 螳御ｺ・ｸ医∩繧ｿ繝・ 螳御ｺ・ｸ医∩縺ｮ縺ｿ陦ｨ遉ｺ
      archiveFilter.value = 'archived';
    } else {
      // 縺昴・莉悶・繧ｿ繝・ 繧｢繧ｯ繝・ぅ繝悶・縺ｿ陦ｨ遉ｺ
      archiveFilter.value = 'active';
    }
  }

  // URL繧呈峩譁ｰ
  updateURLWithDesigner(name);

  renderSidebar();
  renderProjects();

  // 繧ｫ繝ｬ繝ｳ繝繝ｼ縺ｯ蟶ｸ縺ｫ蜀肴緒逕ｻ・域球蠖楢・ヵ繧｣繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ縺ｮ縺溘ａ・・
  console.log('套 selectDesigner: renderCalendar蜻ｼ縺ｳ蜃ｺ縺・);
  renderCalendar();
}

// 諡・ｽ楢・・螳御ｺ・ｸ域｡井ｻｶ繧定｡ｨ遉ｺ
function selectDesignerArchived(name) {
  currentDesignerTab = name;

  // 繧｢繝ｼ繧ｫ繧､繝悶ヵ繧｣繝ｫ繧ｿ繝ｼ繧貞ｮ御ｺ・ｸ医↓險ｭ螳・
  const archiveFilter = document.getElementById('archiveFilter');
  if (archiveFilter) {
    archiveFilter.value = 'archived';
  }

  // URL繧呈峩譁ｰ
  updateURLWithDesigner(name);

  renderSidebar();
  renderProjects();
  renderCalendar(); // 繧ｫ繝ｬ繝ｳ繝繝ｼ繧よ球蠖楢・↓騾｣蜍・
}

// 繝｡繧､繝ｳ繧ｿ繝門・繧頑崛縺・
function switchMainTab(tabName, element) {
  log('淘 switchMainTab 髢句ｧ・', {
    tabName: tabName,
    isHandlingHashChange: isHandlingHashChange,
    currentHash: window.location.hash,
    timestamp: new Date().toISOString()
  });

  // 繝倥ャ繝繝ｼ繝翫ン繧ｲ繝ｼ繧ｷ繝ｧ繝ｳ繝懊ち繝ｳ繧呈峩譁ｰ
  document.querySelectorAll('.header-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) element.classList.add('active');

  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');

  // URL繧呈峩譁ｰ・・andleHashChange蜃ｦ逅・ｸｭ縺ｧ縺ｪ縺・ｴ蜷医・縺ｿ・・
  if (!isHandlingHashChange && window.location.hash !== '#' + tabName) {
    log('迫 switchMainTab: URL繧呈峩譁ｰ:', tabName);
    window.location.hash = tabName;
  } else {
    log('竢ｸ・・switchMainTab: URL譖ｴ譁ｰ繧偵せ繧ｭ繝・・ (isHandlingHashChange=' + isHandlingHashChange + ')');
  }

  // 繧ｫ繝ｬ繝ｳ繝繝ｼ繧ｿ繝悶・蝣ｴ蜷医・謠冗判
  if (tabName === 'calendar') {
    renderCalendar();
  }
}

// ===== 繧ｫ繝ｬ繝ｳ繝繝ｼ讖溯・ =====
let calendarCurrentDate = new Date();

function navigateCalendar(direction) {
  calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + direction);
  renderCalendar();
}

function renderCalendar() {
  console.log('套 renderCalendar: 髢句ｧ・, { currentDesignerTab });
  const grid = document.getElementById('calendarGrid');
  const title = document.getElementById('calendarTitle');
  if (!grid || !title) {
    console.log('套 renderCalendar: DOM隕∫ｴ縺瑚ｦ九▽縺九ｉ縺ｪ縺・, { grid: !!grid, title: !!title });
    return;
  }

  const year = calendarCurrentDate.getFullYear();
  const month = calendarCurrentDate.getMonth();

  // 繧ｿ繧､繝医Ν譖ｴ譁ｰ
  title.textContent = `${year}蟷ｴ${month + 1}譛・;

  // 譛医・譛蛻昴→譛蠕後・譌･
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDayOfWeek = firstDay.getDay();

  // 譛滄剞莉倥″繧ｿ繧ｹ繧ｯ繧貞庶髮・
  const events = collectCalendarEvents();
  console.log('套 renderCalendar: 繧､繝吶Φ繝亥庶髮・ｮ御ｺ・, { eventCount: events.length });

  // 繧ｫ繝ｬ繝ｳ繝繝ｼ繧ｰ繝ｪ繝・ラ逕滓・
  let html = '';

  // 譖懈律繝倥ャ繝繝ｼ
  const dayNames = ['譌･', '譛・, '轣ｫ', '豌ｴ', '譛ｨ', '驥・, '蝨・];
  dayNames.forEach(name => {
    html += `<div class="calendar-day-header">${name}</div>`;
  });

  // 莉頑律縺ｮ譌･莉・
  const today = new Date();
  const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

  // 蜑肴怦縺ｮ譌･繧貞沂繧√ｋ
  const prevMonthLastDay = new Date(year, month, 0).getDate();
  for (let i = startDayOfWeek - 1; i >= 0; i--) {
    const day = prevMonthLastDay - i;
    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    html += `<div class="calendar-day other-month">
      <div class="calendar-day-number">${day}</div>
    </div>`;
  }

  // 蠖捺怦縺ｮ譌･
  for (let day = 1; day <= lastDay.getDate(); day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const isToday = dateStr === todayStr;
    const dayEvents = events.filter(e => e.date === dateStr);

    html += `<div class="calendar-day ${isToday ? 'today' : ''}">
      <div class="calendar-day-number">${day}</div>
      <div class="calendar-events">
        ${dayEvents.slice(0, 3).map(e => `<div class="calendar-event ${e.category}" title="${escapeHtml(e.customer.replace(/讒・/, ''))}讒倬ず: ${escapeHtml(e.taskName)}">${escapeHtml(e.customer.slice(0, 3))} ${escapeHtml(e.taskName.slice(0, 4))}</div>`).join('')}
        ${dayEvents.length > 3 ? `<div class="calendar-event" style="background:#ddd;color:#666;">+${dayEvents.length - 3}莉ｶ</div>` : ''}
      </div>
    </div>`;
  }

  // 鄙梧怦縺ｮ譌･繧貞沂繧√ｋ・・騾ｱ蛻・↓縺ｪ繧九∪縺ｧ・・
  const totalCells = startDayOfWeek + lastDay.getDate();
  const remainingCells = (7 - (totalCells % 7)) % 7;
  for (let day = 1; day <= remainingCells; day++) {
    html += `<div class="calendar-day other-month">
      <div class="calendar-day-number">${day}</div>
    </div>`;
  }

  grid.innerHTML = html;
}

function collectCalendarEvents() {
  const events = [];

  console.log('套 collectCalendarEvents: 髢句ｧ・, { currentDesignerTab, totalProjects: projects.length });

  // 繧ｵ繧､繝峨ヰ繝ｼ縺ｧ驕ｸ謚槭＠縺滓球蠖楢・・譯井ｻｶ縺ｮ縺ｿ繧偵ヵ繧｣繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ
  const filteredProjects = projects.filter(project => {
    // 螳御ｺ・ｸ医∩繧ｿ繝悶・蝣ｴ蜷・
    if (currentDesignerTab === 'ARCHIVED') {
      return project.is_archived;
    }

    // 騾壼ｸｸ縺ｯ螳御ｺ・ｸ医∩繧帝勁螟・
    if (project.is_archived) return false;

    // 蜈ｨ譯井ｻｶ縺ｮ蝣ｴ蜷・
    if (currentDesignerTab === 'ALL') return true;

    // 迚ｹ螳壹・諡・ｽ楢・′驕ｸ謚槭＆繧後※縺・ｋ蝣ｴ蜷・
    const selectedName = currentDesignerTab.trim();
    const assigned = (project.assigned_to || '').trim();
    const icAssigned = (project.ic_assignee || '').trim();
    const exteriorAssigned = (project.exterior_assignee || '').trim();
    const realestateAssigned = (project.realestate_assignee || '').trim();
    const constructionAssigned = (project.construction_assignee || '').trim();
    const salesAssigned = (project.sales_assignee || '').trim();

    return assigned === selectedName ||
           icAssigned === selectedName ||
           exteriorAssigned === selectedName ||
           realestateAssigned === selectedName ||
           constructionAssigned === selectedName ||
           salesAssigned === selectedName;
  });

  console.log('套 collectCalendarEvents: 繝輔ぅ繝ｫ繧ｿ蠕・, { filteredCount: filteredProjects.length });

  filteredProjects.forEach(project => {
    const progressData = project.progress || {};

    // 險ｭ險医ち繧ｹ繧ｯ縺ｮ譛滄剞縺ｨ萓晞ｼ譌･
    tasksV2.filter(t => t.category === '險ｭ險・).forEach(task => {
      const taskData = progressData[task.task_key];
      if (taskData?.due_date) {
        events.push({
          date: taskData.due_date,
          customer: project.customer,
          taskName: task.task_name + '(譛滄剞)',
          category: 'design',
          projectId: project.id
        });
      }
      if (taskData?.request_date) {
        events.push({
          date: taskData.request_date,
          customer: project.customer,
          taskName: task.task_name + '(萓晞ｼ)',
          category: 'task',
          projectId: project.id
        });
      }
    });

    // IC繧ｿ繧ｹ繧ｯ縺ｮ譛滄剞縺ｨ萓晞ｼ譌･
    tasksV2.filter(t => t.category === 'IC').forEach(task => {
      const taskData = progressData[task.task_key];
      if (taskData?.due_date) {
        events.push({
          date: taskData.due_date,
          customer: project.customer,
          taskName: task.task_name + '(譛滄剞)',
          category: 'ic',
          projectId: project.id
        });
      }
      if (taskData?.request_date) {
        events.push({
          date: taskData.request_date,
          customer: project.customer,
          taskName: task.task_name + '(萓晞ｼ)',
          category: 'task',
          projectId: project.id
        });
      }
    });

    // 螟匁ｧ九ち繧ｹ繧ｯ縺ｮ萓晞ｼ譌･
    tasksV2.filter(t => t.category === '螟匁ｧ・).forEach(task => {
      const taskData = progressData[task.task_key];
      if (taskData?.request_date) {
        events.push({
          date: taskData.request_date,
          customer: project.customer,
          taskName: task.task_name + '(萓晞ｼ)',
          category: 'exterior',
          projectId: project.id
        });
      }
    });

    // 蟾･莠九ち繧ｹ繧ｯ縺ｮ萓晞ｼ譌･
    tasksV2.filter(t => t.category === '蟾･莠・).forEach(task => {
      const taskData = progressData[task.task_key];
      if (taskData?.request_date) {
        events.push({
          date: taskData.request_date,
          customer: project.customer,
          taskName: task.task_name + '(萓晞ｼ)',
          category: 'construction',
          projectId: project.id
        });
      }
    });

    // 荳ｻ隕√↑譌･遞・
    if (project.layout_confirmed_date) {
      events.push({
        date: project.layout_confirmed_date,
        customer: project.customer,
        taskName: '髢灘叙遒ｺ螳・,
        category: 'design',
        projectId: project.id
      });
    }

    if (project.construction_permit_date) {
      events.push({
        date: project.construction_permit_date,
        customer: project.customer,
        taskName: '逹蟾･險ｱ蜿ｯ',
        category: 'construction',
        projectId: project.id
      });
    }

    if (project.pre_contract_meeting_date) {
      events.push({
        date: project.pre_contract_meeting_date,
        customer: project.customer,
        taskName: '螟画峩螂醍ｴ・燕莨夊ｭｰ',
        category: 'design',
        projectId: project.id
      });
    }
  });

  console.log('套 collectCalendarEvents: 螳御ｺ・, { totalEvents: events.length });
  return events;
}

// 繧ｵ繝悶ち繝門・繧頑崛縺・
function switchSubTab(panelName, element) {
  log('淘 switchSubTab 髢句ｧ・', {
    panelName: panelName,
    isHandlingHashChange: isHandlingHashChange,
    currentHash: window.location.hash,
    timestamp: new Date().toISOString()
  });

  document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
  if (element) element.classList.add('active');

  document.querySelectorAll('.sub-tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(panelName + 'Panel').classList.add('active');

  // URL繧呈峩譁ｰ・・andleHashChange蜃ｦ逅・ｸｭ縺ｧ縺ｪ縺・ｴ蜷医・縺ｿ・・
  if (!isHandlingHashChange && window.location.hash !== `#settings/${panelName}`) {
    log('迫 switchSubTab: URL繧呈峩譁ｰ:', panelName);
    window.location.hash = `settings/${panelName}`;
  } else {
    log('竢ｸ・・switchSubTab: URL譖ｴ譁ｰ繧偵せ繧ｭ繝・・ (isHandlingHashChange=' + isHandlingHashChange + ')');
  }

  // 繧ｵ繝悶ち繝門・繧頑崛縺域凾縺ｫ蟇ｾ蠢懊☆繧区緒逕ｻ髢｢謨ｰ繧貞ｮ溯｡・
  switch(panelName) {
    case 'staff':
      renderDesignerListInline();
      renderDepartmentChips();
      updateDepartmentDropdowns();
      break;
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
    case 'icTasks':
      renderIcTasksManagement();
      break;
    case 'exteriorTasks':
      renderExteriorTasksManagement();
      break;
    case 'realestateTasks':
      renderRealestateTasksManagement();
      break;
    case 'constructionTasks':
      renderConstructionTasksManagement();
      break;
    case 'products':
      renderProductsList();
      break;
    case 'customize':
      break;
    case 'kintone':
      loadKintoneSettings();
      break;
  }
}

// 險ｭ螳壹ヱ繝阪Ν繧帝幕縺擾ｼ医き繝ｼ繝牙ｼ酋I逕ｨ・・
function openSettingsPanel(panelName) {
  // 繧ｫ繝ｼ繝峨げ繝ｪ繝・ラ繧帝撼陦ｨ遉ｺ
  const cardsView = document.getElementById('settingsCardsView');
  if (cardsView) cardsView.style.display = 'none';

  // 蜈ｨ繝代ロ繝ｫ繧帝撼陦ｨ遉ｺ
  document.querySelectorAll('.sub-tab-panel').forEach(panel => panel.classList.remove('active'));

  // 謖・ｮ壹ヱ繝阪Ν繧定｡ｨ遉ｺ
  const panel = document.getElementById(panelName + 'Panel');
  if (panel) panel.classList.add('active');

  // URL繧呈峩譁ｰ
  if (!isHandlingHashChange && window.location.hash !== `#settings/${panelName}`) {
    window.location.hash = `settings/${panelName}`;
  }

  // 繝代ロ繝ｫ蝗ｺ譛峨・蛻晄悄蛹門・逅・
  switch(panelName) {
    case 'staff':
      renderDesignerListInline();
      renderDepartmentChips();
      updateDepartmentDropdowns();
      break;
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
    case 'icTasks':
      renderIcTasksManagement();
      break;
    case 'exteriorTasks':
      renderExteriorTasksManagement();
      break;
    case 'realestateTasks':
      renderRealestateTasksManagement();
      break;
    case 'constructionTasks':
      renderConstructionTasksManagement();
      break;
    case 'products':
      renderProductsList();
      break;
    case 'customize':
      break;
    case 'kintone':
      loadKintoneSettings();
      break;
    case 'account':
      renderAccountInfo();
      break;
  }
}

// 險ｭ螳壹き繝ｼ繝我ｸ隕ｧ縺ｫ謌ｻ繧・
function closeSettingsPanel() {
  // 蜈ｨ繝代ロ繝ｫ繧帝撼陦ｨ遉ｺ
  document.querySelectorAll('.sub-tab-panel').forEach(panel => panel.classList.remove('active'));

  // 繧ｫ繝ｼ繝峨げ繝ｪ繝・ラ繧定｡ｨ遉ｺ
  const cardsView = document.getElementById('settingsCardsView');
  if (cardsView) cardsView.style.display = 'grid';
}

// 譌ｧswitchTab髢｢謨ｰ・井ｺ呈鋤諤ｧ縺ｮ縺溘ａ谿九☆・・
function switchTab(tabName, element) {
  document.querySelectorAll('.header-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) {
    element.classList.add('active');
  } else {
    // 繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ・嗾abName縺ｫ蝓ｺ縺･縺・※繧｢繧ｯ繝・ぅ繝悶↑繝懊ち繝ｳ繧定ｦ九▽縺代ｋ
    const buttons = document.querySelectorAll('.header-nav-btn');
    buttons.forEach((btn, index) => {
      const tabs = ['projects', 'analytics', 'settings'];
      if (tabs[index] === tabName) {
        btn.classList.add('active');
      }
    });
  }
  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');

  // 繧ｿ繝門・繧頑崛縺域凾縺ｫ蟇ｾ蠢懊☆繧区緒逕ｻ髢｢謨ｰ繧貞ｮ溯｡・
  switch(tabName) {
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
  }
}

// 繧ｫ繝・ざ繝ｪ繝峨Ο繝・・繝繧ｦ繝ｳ繧貞虚逧・↓逕滓・
function populateVendorCategoryDropdown() {
  const dropdown = document.getElementById('vendorCategory');
  if (!dropdown) return;

  dropdown.innerHTML = '<option value="">繧ｫ繝・ざ繝ｪ繧帝∈謚・..</option>' +
    vendorCategories.map(cat => `<option value="${escapeHtml(cat.id)}">${escapeHtml(cat.name)}</option>`).join('');
}

let statusClearTimeout = null;
function showStatus(message, type) {
  const indicator = document.getElementById('statusIndicator');
  const text = document.getElementById('statusText');
  indicator.className = 'status-indicator status-' + type;
  text.textContent = message;

  // 菫晏ｭ伜ｮ御ｺ・ｾ後・3遘偵〒騾壼ｸｸ迥ｶ諷九↓謌ｻ縺・
  if (statusClearTimeout) clearTimeout(statusClearTimeout);
  if (type === 'saved' || type === 'success') {
    statusClearTimeout = setTimeout(() => {
      indicator.className = 'status-indicator';
      text.textContent = '';
    }, 3000);
  }
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.className = 'toast toast-' + type + ' show';
  toast.textContent = message;

  // 繧ｹ繧ｯ繝ｪ繝ｼ繝ｳ繝ｪ繝ｼ繝繝ｼ縺ｫ繧る夂衍
  announceToScreenReader(message);

  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// 繧ｹ繧ｯ繝ｪ繝ｼ繝ｳ繝ｪ繝ｼ繝繝ｼ逕ｨ繧｢繝翫え繝ｳ繧ｹ
function announceToScreenReader(message, priority = 'polite') {
  const liveRegion = document.getElementById('liveRegion');
  if (liveRegion) {
    liveRegion.setAttribute('aria-live', priority);
    liveRegion.textContent = message;
    // 蜷後§繝｡繝・そ繝ｼ繧ｸ縺ｧ繧ょ・騾夂衍縺吶ｋ縺溘ａ縺ｫ荳蠎ｦ繧ｯ繝ｪ繧｢
    setTimeout(() => {
      liveRegion.textContent = '';
    }, 1000);
  }
}

// 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ繧ｪ繝ｼ繝舌・繝ｬ繧､
function showLoading(message = '隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...') {
  const overlay = document.getElementById('loadingOverlay');
  const text = document.getElementById('loadingText');
  if (overlay) {
    if (text) text.textContent = message;
    overlay.classList.add('show');
  }
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.classList.remove('show');
  }
}

// 繝励Ο繧ｰ繝ｬ繧ｹ莉倥″繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ
let loadingProgress = 0;
function showLoadingProgress(message, current, total) {
  const overlay = document.getElementById('loadingOverlay');
  const text = document.getElementById('loadingText');
  if (overlay && text) {
    const percent = Math.round((current / total) * 100);
    text.textContent = `${message} (${percent}%)`;
    overlay.classList.add('show');
  }
}

// ============================================
// 繝悶Λ繧ｦ繧ｶ騾夂衍繧ｷ繧ｹ繝・Β
// ============================================
const NotificationSystem = {
  permission: 'default',
  soundEnabled: localStorage.getItem('notificationSound') !== 'false',

  async init() {
    if ('Notification' in window) {
      this.permission = Notification.permission;
      log('粕 騾夂衍讓ｩ髯・', this.permission);
    }
  },

  async requestPermission() {
    if (!('Notification' in window)) {
      showToast('縺薙・繝悶Λ繧ｦ繧ｶ縺ｯ騾夂衍縺ｫ蟇ｾ蠢懊＠縺ｦ縺・∪縺帙ｓ', 'warning');
      return false;
    }

    try {
      const permission = await Notification.requestPermission();
      this.permission = permission;

      if (permission === 'granted') {
        showToast('騾夂衍縺梧怏蜉ｹ縺ｫ縺ｪ繧翫∪縺励◆', 'success');
        return true;
      } else {
        showToast('騾夂衍縺瑚ｨｱ蜿ｯ縺輔ｌ縺ｾ縺帙ｓ縺ｧ縺励◆', 'warning');
        return false;
      }
    } catch (error) {
      logError('騾夂衍讓ｩ髯舌Μ繧ｯ繧ｨ繧ｹ繝医お繝ｩ繝ｼ:', error);
      return false;
    }
  },

  async send(title, options = {}) {
    if (this.permission !== 'granted') {
      log('騾夂衍讓ｩ髯舌′縺ゅｊ縺ｾ縺帙ｓ');
      return null;
    }

    const defaultOptions = {
      icon: '/archideck/icon-192.png',
      badge: '/archideck/badge.png',
      tag: 'archideck-notification',
      requireInteraction: false,
      ...options
    };

    try {
      // 繧ｵ繧ｦ繝ｳ繝牙・逕・
      if (this.soundEnabled && options.sound !== false) {
        this.playSound();
      }

      const notification = new Notification(title, defaultOptions);

      notification.onclick = () => {
        window.focus();
        notification.close();
        if (options.onClick) options.onClick();
      };

      return notification;
    } catch (error) {
      logError('騾夂衍騾∽ｿ｡繧ｨ繝ｩ繝ｼ:', error);
      return null;
    }
  },

  playSound() {
    try {
      // 繧ｷ繝ｳ繝励Ν縺ｪ騾夂衍髻ｳ繧堤函謌・
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = 800;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    } catch (e) {
      log('騾夂衍髻ｳ蜀咲函繧ｨ繝ｩ繝ｼ・育┌隕門庄・・', e);
    }
  },

  toggleSound() {
    this.soundEnabled = !this.soundEnabled;
    localStorage.setItem('notificationSound', this.soundEnabled);
    showToast(this.soundEnabled ? '騾夂衍髻ｳ繧偵が繝ｳ縺ｫ縺励∪縺励◆' : '騾夂衍髻ｳ繧偵が繝輔↓縺励∪縺励◆', 'info');
    return this.soundEnabled;
  },

  // 譛滄剞髢楢ｿ代・譯井ｻｶ繧帝夂衍
  async checkDeadlines() {
    const today = new Date();
    const threeDaysLater = new Date(today);
    threeDaysLater.setDate(today.getDate() + 3);

    const upcomingDeadlines = projects.filter(p => {
      if (!p.tasks || p.status === 'completed' || p.is_archived) return false;

      return Object.entries(p.tasks).some(([key, task]) => {
        if (!task.due_date || task.status === 'completed') return false;
        const dueDate = new Date(task.due_date);
        return dueDate >= today && dueDate <= threeDaysLater;
      });
    });

    if (upcomingDeadlines.length > 0) {
      await this.send('譛滄剞髢楢ｿ代・繧ｿ繧ｹ繧ｯ縺後≠繧翫∪縺・, {
        body: `${upcomingDeadlines.length}莉ｶ縺ｮ譯井ｻｶ縺ｫ譛滄剞縺瑚ｿ代＞繧ｿ繧ｹ繧ｯ縺後≠繧翫∪縺兪,
        tag: 'deadline-warning'
      });
    }
  }
};

// 騾夂衍繧ｷ繧ｹ繝・Β蛻晄悄蛹・
document.addEventListener('DOMContentLoaded', () => {
  NotificationSystem.init();
});

// ============================================
// 譯井ｻｶ邂｡逅・
// ============================================
function renderDesignerTabs() {
  const container = document.getElementById('designerTabs');
  if (!container) {
    warn('笞・・designerTabs隕∫ｴ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ');
    return;
  }

  log('耳 諡・ｽ楢・ち繝匁緒逕ｻ:', {
    '邱乗球蠖捺焚': designers.length,
    '險ｭ險域球蠖・: designers.filter(d => d.category === '險ｭ險・).length,
    'IC諡・ｽ・: designers.filter(d => d.category === 'IC').length,
    '譯井ｻｶ謨ｰ': projects.length
  });

  const activeCount = projects.filter(p => p.status !== 'completed').length;

  let html = `<button class="designer-tab ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="setDesignerTab('ALL')">蜈ｨ譯井ｻｶ (${activeCount})</button>`;

  // 險ｭ險域球蠖・
  const sekkeiDesigners = designers.filter(d => d.category === '險ｭ險・);
  log('盗 險ｭ險域球蠖・', sekkeiDesigners.map(d => d.name));
  if (sekkeiDesigners.length > 0) {
    html += '<div class="designer-group-label">險ｭ險域球蠖・/div>';
    sekkeiDesigners.forEach(designer => {
      const designerProjects = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const designerName = designer.name.trim();
        return assigned === designerName && p.status !== 'completed' && !p.is_archived;
      });
      const count = designerProjects.length;

      html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
    });
  } else {
    warn('笞・・險ｭ險域球蠖薙′0蜷阪〒縺・);
  }

  // IC諡・ｽ難ｼ磯俣蜿也｢ｺ螳壽ｸ医∩縺ｮ縺ｿ・・
  const icDesigners = designers.filter(d => d.category === 'IC');
  log('耳 IC諡・ｽ・', icDesigners.map(d => d.name));
  if (icDesigners.length > 0) {
    html += '<div class="designer-group-label">IC諡・ｽ・/div>';
    icDesigners.forEach(designer => {
      const designerProjects = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const icAssigned = (p.ic_assignee || '').trim();
        const designerName = designer.name.trim();
        // IC諡・ｽ薙・髢灘叙遒ｺ螳壽ｸ医∩縺ｮ譯井ｻｶ縺ｮ縺ｿ陦ｨ遉ｺ
        const isICAssigned = icAssigned === designerName && p.layout_confirmed_date;
        const isDesignAssigned = assigned === designerName;
        return (isDesignAssigned || isICAssigned) && p.status !== 'completed' && !p.is_archived;
      });
      const count = designerProjects.length;

      html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
    });
  }

  container.innerHTML = html;
}

function setDesignerTab(name) {
  currentDesignerTab = name;

  // URL繧呈峩譁ｰ
  updateURLWithDesigner(name);

  renderDesignerTabs();
  renderProjects();
}

function renderProjects() {
  const container = document.getElementById('projectsGrid');
  const emptyState = document.getElementById('emptyProjects');

  log('耳 renderProjects() 髢句ｧ・);
  log('投 迴ｾ蝨ｨ縺ｮ繧ｿ繝・', currentDesignerTab);
  log('投 蜈ｨ譯井ｻｶ謨ｰ:', projects.length);
  log('投 蜈ｨ譯井ｻｶ:', projects.map(p => ({ customer: p.customer, assigned_to: p.assigned_to, ic_assignee: p.ic_assignee })));

  let filtered = projects.filter(p => {
    // 螳御ｺ・ｸ医ち繝悶′驕ｸ謚槭＆繧後※縺・ｋ蝣ｴ蜷・
    if (currentDesignerTab === 'ARCHIVED') {
      // 螳御ｺ・ｸ域｡井ｻｶ縺ｮ縺ｿ陦ｨ遉ｺ
      if (!p.is_archived) return false;

      // 讀懃ｴ｢繧ｯ繧ｨ繝ｪ繝輔ぅ繝ｫ繧ｿ繝ｼ
      const query = document.getElementById('searchQuery').value.toLowerCase();
      if (query && !p.customer.toLowerCase().includes(query) && !(p.memo || '').toLowerCase().includes(query)) return false;

      return true;
    }

    // 諡・ｽ楢・ヵ繧｣繝ｫ繧ｿ繝ｼ・郁ｨｭ險・IC/螟匁ｧ・荳榊虚逕｣諡・ｽ難ｼ・
    if (currentDesignerTab !== 'ALL') {
      const assigned = (p.assigned_to || '').trim();
      const icAssigned = (p.ic_assignee || '').trim();
      const exteriorAssigned = (p.exterior_assignee || '').trim();
      const realestateAssigned = (p.realestate_assignee || '').trim();
      const currentTab = currentDesignerTab.trim();

      // IC諡・ｽ薙→縺励※繝槭ャ繝√☆繧九↓縺ｯ髢灘叙遒ｺ螳壹′蠢・ｦ・
      const icMatches = icAssigned === currentTab && p.layout_confirmed_date;

      if (assigned !== currentTab && !icMatches && exteriorAssigned !== currentTab && realestateAssigned !== currentTab) {
        log(`笶・繝輔ぅ繝ｫ繧ｿ縺ｧ髯､螟・ ${p.customer} (assigned_to: "${assigned}", ic: "${icAssigned}", 螟匁ｧ・ "${exteriorAssigned}", 荳榊虚逕｣: "${realestateAssigned}", currentTab: "${currentTab}")`);
        return false;
      }
    }

    // 繧｢繝ｼ繧ｫ繧､繝悶ヵ繧｣繝ｫ繧ｿ繝ｼ・磯壼ｸｸ譎ゅ・螳御ｺ・ｸ医ｒ髯､螟厄ｼ・
    const archiveFilter = document.getElementById('archiveFilter').value;
    const isArchived = p.is_archived || p.status === 'completed';

    // IC諡・ｽ楢・→縺励※驕ｸ謚槭＆繧後※縺・ｋ蝣ｴ蜷医∫筏隲季O貂医∩縺ｧ繧・C騾ｲ謐・00%譛ｪ貅縺ｯ繧｢繧ｯ繝・ぅ繝匁桶縺・
    const isICDesigner = designers.some(d => d.category === 'IC' && d.name.trim() === currentDesignerTab.trim());
    if (isICDesigner) {
      const icProgress = calculateICProgress(p);
      // IC諡・ｽ楢・′縺・※IC騾ｲ謐・00%・医∪縺溘・繧ｿ繧ｹ繧ｯ縺ｪ縺暦ｼ峨↑繧牙ｮ御ｺ・！C諡・ｽ楢・′縺・↑縺・ｴ蜷医・騾壼ｸｸ縺ｮ繧｢繝ｼ繧ｫ繧､繝門愛螳壹↓蠕薙≧
      const hasICAssignee = !!p.ic_assignee;
      // icProgress縺系ull・医ち繧ｹ繧ｯ縺ｪ縺暦ｼ峨・蝣ｴ蜷医ｂ螳御ｺ・桶縺・
      const isICComplete = hasICAssignee ? (icProgress === null || icProgress === 100) : true;
      if (archiveFilter === 'active') {
        // 繧｢繧ｯ繝・ぅ繝冶｡ｨ遉ｺ: 譛ｪ繧｢繝ｼ繧ｫ繧､繝悶√∪縺溘・繧｢繝ｼ繧ｫ繧､繝匁ｸ医∩縺縺栗C譛ｪ螳御ｺ・
        if (isArchived && isICComplete) return false;
      } else if (archiveFilter === 'archived') {
        // 螳御ｺ・ｸ郁｡ｨ遉ｺ: 繧｢繝ｼ繧ｫ繧､繝匁ｸ医∩縺九▽IC螳御ｺ・
        if (!isArchived || !isICComplete) return false;
      }
    } else {
      // 騾壼ｸｸ縺ｮ諡・ｽ楢・ 蠕捺擂縺ｮ繝ｭ繧ｸ繝・け
      if (archiveFilter === 'active' && isArchived) return false;
      if (archiveFilter === 'archived' && !isArchived) return false;
    }
    const query = document.getElementById('searchQuery').value.toLowerCase();
    if (query && !p.customer.toLowerCase().includes(query) && !(p.memo || '').toLowerCase().includes(query)) return false;

    const specFilter = document.getElementById('specFilter').value;
    if (specFilter && p.specifications !== specFilter) return false;

    // IC騾ｲ謐励ヵ繧｣繝ｫ繧ｿ繝ｼ
    const icProgressFilter = document.getElementById('icProgressFilter')?.value || '';
    if (icProgressFilter) {
      const icProgress = calculateICProgress(p);
      if (icProgressFilter === 'no_ic' && p.ic_assignee) return false;
      if (icProgressFilter === 'no_ic' && !p.ic_assignee) return true;
      if (!p.ic_assignee) return false;
      if (icProgressFilter === 'not_started' && icProgress !== 0) return false;
      if (icProgressFilter === 'in_progress' && (icProgress === 0 || icProgress === 100)) return false;
      if (icProgressFilter === 'completed' && icProgress !== 100) return false;
    }

    // IC諡・ｽ楢・ヵ繧｣繝ｫ繧ｿ繝ｼ
    const icAssigneeFilter = document.getElementById('icAssigneeFilter')?.value || '';
    if (icAssigneeFilter && (p.ic_assignee || '') !== icAssigneeFilter) return false;

    // 螟匁ｧ区球蠖楢・ヵ繧｣繝ｫ繧ｿ繝ｼ
    const exteriorAssigneeFilter = document.getElementById('exteriorAssigneeFilter')?.value || '';
    if (exteriorAssigneeFilter && (p.exterior_assignee || '') !== exteriorAssigneeFilter) return false;

    // 荳榊虚逕｣諡・ｽ楢・ヵ繧｣繝ｫ繧ｿ繝ｼ
    const realestateAssigneeFilter = document.getElementById('realestateAssigneeFilter')?.value || '';
    if (realestateAssigneeFilter && (p.realestate_assignee || '') !== realestateAssigneeFilter) return false;

    // 繧ｽ繝ｼ繧ｹ繝輔ぅ繝ｫ繧ｿ繝ｼ・・intone騾｣謳ｺ / 謇句虚霑ｽ蜉繝ｻ繝・Δ・・
    const sourceFilter = document.getElementById('sourceFilter')?.value || '';
    if (sourceFilter === 'kintone' && !p.kintone_record_id) return false;
    if (sourceFilter === 'demo' && p.kintone_record_id) return false;

    return true;
  });

  log('笨・繝輔ぅ繝ｫ繧ｿ蠕後・譯井ｻｶ謨ｰ:', filtered.length);
  log('笨・繝輔ぅ繝ｫ繧ｿ蠕後・譯井ｻｶ:', filtered.map(p => ({ customer: p.customer, assigned_to: p.assigned_to })));

  // 繧ｽ繝ｼ繝亥・逅・
  const sortOrder = document.getElementById('sortOrder')?.value || 'updated_desc';
  filtered.sort((a, b) => {
    switch (sortOrder) {
      case 'custom':
        // 繧ｫ繧ｹ繧ｿ繝鬆・ｺ擾ｼ医ラ繝ｩ繝・げ&繝峨Ο繝・・縺ｧ菫晏ｭ倥＠縺滄・ｺ擾ｼ・
        const customOrder = getCustomCardOrder();
        const aIdx = customOrder.indexOf(a.id);
        const bIdx = customOrder.indexOf(b.id);
        // 荳｡譁ｹ縺後き繧ｹ繧ｿ繝鬆・ｺ上↓縺ゅｋ蝣ｴ蜷・
        if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
        // 迚・婿縺縺代き繧ｹ繧ｿ繝鬆・ｺ上↓縺ゅｋ蝣ｴ蜷医√き繧ｹ繧ｿ繝鬆・ｒ蜆ｪ蜈・
        if (aIdx !== -1) return -1;
        if (bIdx !== -1) return 1;
        // 縺ｩ縺｡繧峨ｂ繧ｫ繧ｹ繧ｿ繝鬆・ｺ上↓縺ｪ縺・ｴ蜷医・譖ｴ譁ｰ譌･鬆・
        return new Date(b.updated_at || 0) - new Date(a.updated_at || 0);
      case 'updated_desc':
        return new Date(b.updated_at || 0) - new Date(a.updated_at || 0);
      case 'updated_asc':
        return new Date(a.updated_at || 0) - new Date(b.updated_at || 0);
      case 'progress_desc':
        return calculateProgress(b) - calculateProgress(a);
      case 'progress_asc':
        return calculateProgress(a) - calculateProgress(b);
      case 'customer_asc':
        return (a.customer || '').localeCompare(b.customer || '', 'ja');
      case 'customer_desc':
        return (b.customer || '').localeCompare(a.customer || '', 'ja');
      case 'created_desc':
        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
      default:
        return new Date(b.updated_at || 0) - new Date(a.updated_at || 0);
    }
  });

  if (filtered.length === 0) {
    container.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  container.style.display = 'grid';
  emptyState.style.display = 'none';
  container.innerHTML = filtered.map(project => renderProjectCard(project)).join('');

  // 繧ｫ繝ｼ繝牙ｱ暮幕迥ｶ諷九ｒ蠕ｩ蜈・
  filtered.forEach(project => restoreCardStates(project.id));

  // 繧ｫ繝ｼ繝画緒逕ｻ蠕後↓繧ｿ繧ｹ繧ｯ縺ｨ隴ｰ莠矩鹸繧定ｪｭ縺ｿ霎ｼ繧・医ヰ繝・メ蜃ｦ逅・〒N+1蝠城｡後ｒ蝗樣∩・・
  // 繝舌ャ繧ｸ繧ｫ繧ｦ繝ｳ繝郁ｪｭ縺ｿ霎ｼ縺ｿ・医ち繧ｹ繧ｯ謨ｰ繝ｻ隴ｰ莠矩鹸謨ｰ・・
  setTimeout(async () => {
    const BATCH_SIZE = 5; // 蜷梧凾縺ｫ5莉ｶ縺ｾ縺ｧ
    for (let i = 0; i < filtered.length; i += BATCH_SIZE) {
      const batch = filtered.slice(i, i + BATCH_SIZE);
      await Promise.all(batch.map(project => loadBadgeCounts(project.id)));
    }
  }, 100);

  // 邨ｱ險医ム繝・す繝･繝懊・繝画峩譁ｰ
  updateStatsDashboard();
}

// ============================================
// 邨ｱ險医ム繝・す繝･繝懊・繝画ｩ溯・
// ============================================
let statsVisible = localStorage.getItem('statsVisible') !== 'false';

function toggleStatsDashboard() {
  statsVisible = !statsVisible;
  localStorage.setItem('statsVisible', statsVisible);
  const dashboard = document.getElementById('statsDashboard');
  if (dashboard) {
    dashboard.style.display = statsVisible ? 'block' : 'none';
    dashboard.querySelector('.stats-toggle-btn').textContent = statsVisible ? '邨ｱ險医ｒ髱櫁｡ｨ遉ｺ' : '邨ｱ險医ｒ陦ｨ遉ｺ';
  }
}

function updateStatsDashboard() {
  const dashboard = document.getElementById('statsDashboard');
  if (!dashboard) return;

  // 陦ｨ遉ｺ/髱櫁｡ｨ遉ｺ
  dashboard.style.display = statsVisible ? 'block' : 'none';

  // 繧｢繧ｯ繝・ぅ繝匁｡井ｻｶ謨ｰ
  const activeProjects = projects.filter(p => !p.is_archived);
  document.getElementById('statTotalProjects').textContent = activeProjects.length;

  // 蟷ｳ蝮・ｨｭ險磯ｲ謐・
  if (activeProjects.length > 0) {
    const avgDesignProgress = Math.round(activeProjects.reduce((sum, p) => sum + calculateProgress(p), 0) / activeProjects.length);
    document.getElementById('statDesignProgress').textContent = avgDesignProgress + '%';
  } else {
    document.getElementById('statDesignProgress').textContent = '0%';
  }

  // 蟷ｳ蝮⑩C騾ｲ謐・
  const projectsWithIC = activeProjects.filter(p => p.ic_assignee);
  if (projectsWithIC.length > 0) {
    const avgICProgress = Math.round(projectsWithIC.reduce((sum, p) => sum + (calculateICProgress(p) || 0), 0) / projectsWithIC.length);
    document.getElementById('statICProgress').textContent = avgICProgress + '%';
  } else {
    document.getElementById('statICProgress').textContent = '-';
  }

  // 莉頑怦螳御ｺ・焚
  const now = new Date();
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();
  const completedThisMonth = projects.filter(p => {
    if (!p.is_archived) return false;
    const archivedDate = new Date(p.updated_at);
    return archivedDate.getMonth() === thisMonth && archivedDate.getFullYear() === thisYear;
  }).length;
  document.getElementById('statCompletedThisMonth').textContent = completedThisMonth;

  // 譛滄剞雜・℃・域悄髯舌′險ｭ螳壹＆繧後※縺・※雜・℃縺励※縺・ｋ繧ゅ・・・
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const overdueProjects = activeProjects.filter(p => {
    const deadline = DeadlineManager.getDeadline(p.id);
    if (!deadline) return false;
    return new Date(deadline) < today;
  });
  const overdueCard = document.getElementById('statOverdueCard');
  if (overdueProjects.length > 0) {
    overdueCard.style.display = 'flex';
    document.getElementById('statOverdue').textContent = overdueProjects.length;
  } else {
    overdueCard.style.display = 'none';
  }
}

// 譯井ｻｶ繧ｫ繝ｼ繝峨↓繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ
function scrollToProject(projectId) {
  const card = document.querySelector(`[data-project-id="${projectId}"]`);
  if (card) {
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    card.classList.add('highlight-card');
    setTimeout(() => card.classList.remove('highlight-card'), 2000);
  }
}

// 繧ｫ繝ｼ繝牙腰菴阪〒蜀肴緒逕ｻ・医そ繧ｯ繧ｷ繝ｧ繝ｳ縺ｮ髢矩哩迥ｶ諷九ｒ菫晄戟・・
function updateSingleProjectCard(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const cardElement = document.querySelector(`[data-project-id="${projectId}"]`);
  if (!cardElement) return;

  // 繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ縺ｮ髢矩哩迥ｶ諷九ｒ菫晄戟
  const sectionStates = [];
  cardElement.querySelectorAll('.card-section').forEach((section, idx) => {
    sectionStates[idx] = !section.classList.contains('collapsed');
  });

  // 繧ｫ繝ｼ繝峨ｒ蜀肴緒逕ｻ
  const newCard = document.createElement('div');
  newCard.innerHTML = renderProjectCard(project);
  const newCardElement = newCard.firstElementChild;

  // 繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ縺ｮ髢矩哩迥ｶ諷九ｒ蠕ｩ蜈・
  newCardElement.querySelectorAll('.card-section').forEach((section, idx) => {
    if (sectionStates[idx]) {
      section.classList.remove('collapsed');
    }
  });

  cardElement.replaceWith(newCardElement);

  // 繝舌ャ繧ｸ繧ｫ繧ｦ繝ｳ繝亥・繝ｭ繝ｼ繝・
  loadBadgeCounts(projectId);
}

function renderProjectCard(project) {
  const progress = calculateProgress(project);
  const icProgress = calculateICProgress(project);
  const exteriorProgress = calculateExteriorProgress(project);
  const realestateProgress = calculateRealestateProgress(project);
  const constructionProgress = calculateConstructionProgress(project);
  const progressData = project.progress || {};
  const staleDays = getProjectStaleDays(project);
  const tasks = getTasksForAssignee(project.assigned_to);

  // 繧ｵ繧､繝峨ヰ繝ｼ縺ｧ驕ｸ謚樔ｸｭ縺ｮ諡・ｽ楢・・繧ｫ繝・ざ繝ｪ繧貞叙蠕暦ｼ・C驕ｸ謚樊凾縺ｯIC讌ｭ蜍吶・縺ｿ陦ｨ遉ｺ遲会ｼ・
  const selectedDesignerCategory = currentDesignerTab && currentDesignerTab !== 'ALL' && currentDesignerTab !== 'ARCHIVED'
    ? designers.find(d => d.name.trim() === currentDesignerTab.trim())?.category || null
    : null;
  // 陦ｨ遉ｺ繧ｫ繝・ざ繝ｪ・医し繧､繝峨ヰ繝ｼ驕ｸ謚槫━蜈医√↑縺代ｌ縺ｰ繝ｭ繧ｰ繧､繝ｳ繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ繧ｫ繝・ざ繝ｪ・・
  const viewCategory = selectedDesignerCategory || currentUserCategory;

  // 蜈ｨ繧ｿ繧ｹ繧ｯ螳御ｺ・メ繧ｧ繝・け
  const canArchive = tasks.every(taskDef => {
    const task = progressData[taskDef.task_key] || { completed: false, state: '' };
    if (!task.completed) return false;
    if (taskDef.has_state && task.state !== '菫晏ｭ俶ｸ・) return false;
    return true;
  });

  // 逕ｳ隲季O譚｡莉ｶ繝√ぉ繝・け
  const applicationGoEnabled = canPressApplicationGo(project);


  const tasksHtml = tasks.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '', due_date: '' };
    const isApplicationGo = key === 'application';

    // 逕ｳ隲季o縺ｮ蝣ｴ蜷医・迚ｹ蛻･縺ｪ繝輔Ν繝ｯ繧､繝芽｡ｨ遉ｺ
    if (isApplicationGo) {
      if (task.completed) {
        // 譌｢縺ｫ螳御ｺ・ｸ医∩縺ｮ蝣ｴ蜷・
        return `<div class="application-go-container application-go-completed">
          <div class="application-go-icon">笨・/div>
          <div class="application-go-text">${taskDef.task_name} 螳御ｺ・/div>
        </div>`;
      } else if (applicationGoEnabled) {
        // 譚｡莉ｶ縺梧純縺｣縺ｦ縺・ｋ蝣ｴ蜷茨ｼ壹け繝ｪ繝・け蜿ｯ閭ｽ縺ｪ繝懊ち繝ｳ
        return `<div class="application-go-container application-go-ready" onclick="confirmApplicationGo('${project.id}')">
          <div class="application-go-icon">噫</div>
          <div class="application-go-text">${taskDef.task_name}</div>
          <div class="application-go-arrow">竊・/div>
        </div>`;
      } else {
        // 譚｡莉ｶ縺梧純縺｣縺ｦ縺・↑縺・ｴ蜷茨ｼ夂┌蜉ｹ陦ｨ遉ｺ・亥虚逧・↓繝・・繝ｫ繝√ャ繝礼函謌撰ｼ・
        const requiredTasks = getApplicationGoRequiredTasks();
        const tooltip = requiredTasks.length > 0
          ? requiredTasks.map(r => `${r.task_name}:${r.finalState}`).join('縲・) + ' 縺悟ｿ・ｦ・
          : '螟ｪ髯ｽ蜈・蝟ｶ讌ｭ蜈ｱ譛画ｸ医∫ｵｦ謗呈ｰｴ:菫晏ｭ俶ｸ医∵鋤豌・菫晏ｭ俶ｸ医√し繝・す:菫晏ｭ俶ｸ・縺悟ｿ・ｦ・;
        return `<div class="application-go-container application-go-disabled" title="${tooltip}">
          <div class="application-go-icon">白</div>
          <div class="application-go-text">${taskDef.task_name}</div>
          <div class="application-go-status">譚｡莉ｶ譛ｪ驕・/div>
        </div>`;
      }
    }

    // 繝｡繝ｼ繝ｫ繝懊ち繝ｳ陦ｨ遉ｺ譚｡莉ｶ: 繧ｿ繧ｹ繧ｯ險ｭ螳壹〒繝｡繝ｼ繝ｫ辟｡蜉ｹ・・as_email_button=false・峨〒縺ｪ縺代ｌ縺ｰ陦ｨ遉ｺ
    // 險ｭ險医ち繧ｹ繧ｯ縺ｯ蟶ｸ縺ｫ陦ｨ遉ｺ・医せ繝・・繧ｿ繧ｹ縺ｫ髢｢菫ゅ↑縺擾ｼ・
    // 螟ｪ髯ｽ蜈我ｾ晞ｼ縺ｯ迚ｹ蛻･縺ｪ螟夜Κ繝ｪ繝ｳ繧ｯ繝懊ち繝ｳ繧定｡ｨ遉ｺ
    const showEmailButton = taskDef.has_email_button !== false;
    let emailBtn = '';
    if (key === 'solar') {
      // 螟ｪ髯ｽ蜈我ｾ晞ｼ縺ｯ螟夜Κ繧ｵ繧､繝医∈縺ｮ繝ｪ繝ｳ繧ｯ繝懊ち繝ｳ
      emailBtn = `<a href="https://bmp-shop.com/nextsolar/wp/wp-login.php" target="_blank" class="task-email-btn" title="螟ｪ髯ｽ蜈峨し繧､繝医ｒ髢九￥" style="text-decoration:none;">迫</a>`;
    } else if (showEmailButton) {
      emailBtn = `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="繝｡繝ｼ繝ｫ菴懈・">透</button>`;
    }

    // 繧ｹ繝・・繧ｿ繧ｹ繧ｫ繝ｼ繝臥函謌・
    const stateOptions = getTaskStateOptions(key);
    const stateCards = generateStatusCards(stateOptions, task.state, project.id, key);

    // 萓晞ｼ譌･繝舌ャ繧ｸ
    const requestDateBadge = task.request_date
      ? `<span class="request-date-badge" title="萓晞ｼ譌･: ${task.request_date}">${formatDateShort(task.request_date)}</span>`
      : '';

    return `<div class="task-item">
      <span class="task-label">${taskDef.task_name}</span>${stateCards}${requestDateBadge}${emailBtn}</div>`;
  }).join('');

  // IC讌ｭ蜍吝・螳ｹ繧堤函謌撰ｼ域眠縺励＞蝗槫挨繧ｫ繝ｼ繝牙ｽ｢蠑擾ｼ・
  const icTasks = tasksV2.filter(t => t.category === 'IC').sort((a, b) => a.display_order - b.display_order);
  const icRoundCardsHtml = generateICRoundCards(project, progressData);

  // 螟匁ｧ区･ｭ蜍吝・螳ｹ繧堤函謌・
  const exteriorTasksList = getTasksForCategory('螟匁ｧ・);
  const exteriorTasksHtml = exteriorTasksList.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '', due_date: '' };

    const hasVendor = taskVendorMappings.some(m => m.task_id === taskDef.id);
    const isInternalStatus = INTERNAL_STATUSES.includes(task.state);
    const showEmailButton = taskDef.has_email_button !== false && hasVendor && !isInternalStatus;
    const emailBtn = showEmailButton ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="繝｡繝ｼ繝ｫ菴懈・">透</button>` : '';

    // 繧ｹ繝・・繧ｿ繧ｹ繧ｫ繝ｼ繝臥函謌・
    const stateOptions = getTaskStateOptions(key);
    const stateCards = generateStatusCards(stateOptions, task.state, project.id, key);

    // 萓晞ｼ譌･繝舌ャ繧ｸ
    const requestDateBadge = task.request_date
      ? `<span class="request-date-badge" title="萓晞ｼ譌･: ${task.request_date}">${formatDateShort(task.request_date)}</span>`
      : '';

    return `<div class="task-item">
      <span class="task-label">${taskDef.task_name}</span>${stateCards}${requestDateBadge}${emailBtn}</div>`;
  }).join('');

  // 荳榊虚逕｣讌ｭ蜍吝・螳ｹ繧堤函謌・
  const realestateTasksList = getTasksForCategory('荳榊虚逕｣');
  const realestateTasksHtml = realestateTasksList.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '', due_date: '' };

    const hasVendor = taskVendorMappings.some(m => m.task_id === taskDef.id);
    const isInternalStatus = INTERNAL_STATUSES.includes(task.state);
    const showEmailButton = taskDef.has_email_button !== false && hasVendor && !isInternalStatus;
    const emailBtn = showEmailButton ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="繝｡繝ｼ繝ｫ菴懈・">透</button>` : '';

    // 繧ｹ繝・・繧ｿ繧ｹ繧ｫ繝ｼ繝臥函謌・
    const stateOptions = getTaskStateOptions(key);
    const stateCards = generateStatusCards(stateOptions, task.state, project.id, key);

    // 萓晞ｼ譌･繝舌ャ繧ｸ
    const requestDateBadge = task.request_date
      ? `<span class="request-date-badge" title="萓晞ｼ譌･: ${task.request_date}">${formatDateShort(task.request_date)}</span>`
      : '';

    return `<div class="task-item">
      <span class="task-label">${taskDef.task_name}</span>${stateCards}${requestDateBadge}${emailBtn}</div>`;
  }).join('');

  // 蟾･莠区･ｭ蜍吝・螳ｹ繧堤函謌・
  const constructionTasksList = getTasksForCategory('蟾･莠・);
  const constructionTasksHtml = constructionTasksList.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '', due_date: '' };

    const hasVendor = taskVendorMappings.some(m => m.task_id === taskDef.id);
    const isInternalStatus = INTERNAL_STATUSES.includes(task.state);
    const showEmailButton = taskDef.has_email_button !== false && hasVendor && !isInternalStatus;
    const emailBtn = showEmailButton ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="繝｡繝ｼ繝ｫ菴懈・">透</button>` : '';

    // 繧ｹ繝・・繧ｿ繧ｹ繧ｫ繝ｼ繝臥函謌・
    const stateOptions = getTaskStateOptions(key);
    const stateCards = generateStatusCards(stateOptions, task.state, project.id, key);

    // 萓晞ｼ譌･繝舌ャ繧ｸ
    const requestDateBadge = task.request_date
      ? `<span class="request-date-badge" title="萓晞ｼ譌･: ${task.request_date}">${formatDateShort(task.request_date)}</span>`
      : '';

    return `<div class="task-item">
      <span class="task-label">${taskDef.task_name}</span>${stateCards}${requestDateBadge}${emailBtn}</div>`;
  }).join('');

  const isSelected = BatchOperations.isSelected(project.id);

  // 譛滄剞雜・℃繝√ぉ繝・け
  const deadline = DeadlineManager.getDeadline(project.id);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const isOverdue = deadline && new Date(deadline) < today && !project.is_archived;
  const isDueSoon = deadline && !isOverdue && (new Date(deadline) - today) <= 3 * 24 * 60 * 60 * 1000 && !project.is_archived;

  return `<div class="project-card ${isSelected ? 'selected' : ''} ${isOverdue ? 'overdue' : ''} ${isDueSoon ? 'due-soon' : ''}" data-project-id="${project.id}" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" ondragend="handleDragEnd(event)">
    <div class="card-header">
      <div style="display: flex; align-items: flex-start; gap: 8px;">
        <input type="checkbox" class="batch-checkbox" data-project-id="${project.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); BatchOperations.toggle('${project.id}')" title="驕ｸ謚・>
        <div>
          <div class="card-title"><span class="customer-name">${escapeHtml(project.customer)}</span><span class="badge badge-primary">${escapeHtml(project.specifications || 'LIFE')}</span>${project.is_archived ? '<span class="badge badge-success">螳御ｺ・ｸ医∩</span>' : ''}${!project.is_archived && staleDays >= 7 ? `<span class="badge badge-warning" title="${staleDays}譌･髢捺悴譖ｴ譁ｰ">笞・・${staleDays}譌･</span>` : ''}</div>
          <div class="card-subtitle"><span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this)" style="cursor: pointer; text-decoration: underline dotted;" title="繧ｯ繝ｪ繝・け縺ｧ諡・ｽ楢・､画峩">險ｭ險茨ｼ・{escapeHtml(project.assigned_to || '譛ｪ蜑ｲ蠖・)}</span>${project.ic_assignee ? `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'ic_assignee')" style="cursor: pointer; text-decoration: underline dotted;" title="繧ｯ繝ｪ繝・け縺ｧIC諡・ｽ楢・､画峩"> | IC・・{escapeHtml(project.ic_assignee)}</span>` : `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'ic_assignee')" style="cursor: pointer; color: var(--text-muted); font-size: 11px;" title="IC諡・ｽ楢・ｒ霑ｽ蜉"> | +IC</span>`}${project.exterior_assignee ? `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'exterior_assignee')" style="cursor: pointer; text-decoration: underline dotted;" title="繧ｯ繝ｪ繝・け縺ｧ螟匁ｧ区球蠖楢・､画峩"> | 螟匁ｧ具ｼ・{escapeHtml(project.exterior_assignee)}</span>` : `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'exterior_assignee')" style="cursor: pointer; color: var(--text-muted); font-size: 11px;" title="螟匁ｧ区球蠖楢・ｒ霑ｽ蜉"> | +螟匁ｧ・/span>`}${project.realestate_assignee ? `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'realestate_assignee')" style="cursor: pointer; text-decoration: underline dotted;" title="繧ｯ繝ｪ繝・け縺ｧ荳榊虚逕｣諡・ｽ楢・､画峩"> | 荳榊虚逕｣・・{escapeHtml(project.realestate_assignee)}</span>` : `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'realestate_assignee')" style="cursor: pointer; color: var(--text-muted); font-size: 11px;" title="荳榊虚逕｣諡・ｽ楢・ｒ霑ｽ蜉"> | +荳榊虚逕｣</span>`}${project.construction_assignee ? `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'construction_assignee')" style="cursor: pointer; text-decoration: underline dotted;" title="繧ｯ繝ｪ繝・け縺ｧ蟾･莠区球蠖楢・､画峩"> | 蟾･莠具ｼ・{escapeHtml(project.construction_assignee)}</span>` : `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'construction_assignee')" style="cursor: pointer; color: var(--text-muted); font-size: 11px;" title="蟾･莠区球蠖楢・ｒ霑ｽ蜉"> | +蟾･莠・/span>`}</div>
          ${(() => {
            const dates = [];
            if (project.layout_confirmed_date) dates.push(`髢灘叙遒ｺ螳・ ${project.layout_confirmed_date}`);
            if (project.pre_contract_meeting_date) dates.push(`螟画峩螂醍ｴ・燕莨夊ｭｰ: ${project.pre_contract_meeting_date}`);
            if (project.construction_permit_date) dates.push(`逹蟾･險ｱ蜿ｯ: ${project.construction_permit_date}`);
            return dates.length > 0 ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${dates.join(' | ')}</div>` : '';
          })()}
        </div>
      </div>
      <div style="display: flex; gap: 8px; align-items: center;">
        ${project.is_archived ? `
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; background: var(--success-color); color: white; padding: 4px 12px; border-radius: 6px; font-size: 13px;">
            <input type="checkbox" checked onchange="restoreFromArchive('${project.id}')" style="width: 16px; height: 16px; cursor: pointer;">
            螳御ｺ・ｸ・
          </label>
        ` : `
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; background: #F3F4F6; padding: 4px 12px; border-radius: 6px; font-size: 12px; color: #6B7280; border: 1px solid #E5E7EB;" title="繝√ぉ繝・け縺ｧ螳御ｺ・ｸ医∩縺ｫ遘ｻ蜍・>
            <input type="checkbox" onchange="markAsCompleted('${project.id}')" style="width: 14px; height: 14px; cursor: pointer;">
            螳御ｺ・
          </label>
        `}
        <button class="btn btn-ghost btn-small" onclick="quickEmail('${project.id}')" title="繝｡繝ｼ繝ｫ菴懈・">透</button>
        <button class="btn btn-ghost btn-small" onclick="editProject('${project.id}')">邱ｨ髮・/button>
      </div>
    </div>
    <div class="card-quick-actions">
      <button class="quick-action-btn" onclick="openCardModal('${project.id}', 'tasks')">笨・繧ｿ繧ｹ繧ｯ<span class="section-badge badge-primary" id="taskBadge_${project.id}" style="display:none">0</span></button>
      <button class="quick-action-btn" onclick="openCardModal('${project.id}', 'memo')">統 繝｡繝｢<span class="section-badge badge-primary" id="memoBadge_${project.id}" style="display:${project.shared_memo ? 'inline-flex' : 'none'}">1</span></button>
      <button class="quick-action-btn" onclick="openCardModal('${project.id}', 'minutes')">塘 隴ｰ莠矩鹸<span class="section-badge badge-primary" id="minutesBadge_${project.id}" style="display:none">0</span></button>
      <button class="quick-action-btn" onclick="openCardModal('${project.id}', 'handover')">搭 蠑慕ｶ呎嶌<span class="section-badge badge-primary" id="handoverBadge_${project.id}" style="display:none">1</span></button>
    </div>

    ${(() => {
      // 驛ｨ鄂ｲ蛻･讌ｭ蜍吝・螳ｹ陦ｨ遉ｺ
      // 邂｡逅・・ 謗剃ｻ也噪繧｢繧ｳ繝ｼ繝・ぅ繧ｪ繝ｳ・・縺､髢九￥縺ｨ莉悶′髢峨§繧具ｼ・
      // 髱樒ｮ｡逅・・ 閾ｪ蛻・・驛ｨ鄂ｲ縺ｮ縺ｿ縲√い繧ｳ繝ｼ繝・ぅ繧ｪ繝ｳ縺ｪ縺励〒逶ｴ謗･陦ｨ遉ｺ

      // 蜷・き繝・ざ繝ｪ縺ｮ螳御ｺ・・譛ｪ螳御ｺ・ち繧ｹ繧ｯ謨ｰ繧定ｨ育ｮ・
      const countTasks = (taskList) => {
        const total = taskList.length;
        const completed = taskList.filter(t => {
          const task = progressData[t.task_key] || {};
          const stateOptions = getTaskStateOptions(t.task_key);
          const lastOption = stateOptions && stateOptions.length > 0 ? stateOptions[stateOptions.length - 1] : null;
          return task.state === lastOption;
        }).length;
        return { completed, total, incomplete: total - completed };
      };

      const designTaskList = tasksV2.filter(t => t.category === '險ｭ險・).sort((a, b) => a.display_order - b.display_order);
      const designCount = countTasks(designTaskList);
      const icCount = countTasks(icTasks);
      const exteriorCount = countTasks(exteriorTasksList);
      const realestateCount = countTasks(realestateTasksList);
      const constructionCount = countTasks(constructionTasksList);

      // 邂｡逅・・髄縺・ 繧｢繧ｳ繝ｼ繝・ぅ繧ｪ繝ｳ・亥・譛溽憾諷九・髢峨§繧九∵悴螳御ｺ・蜈ｨ繧ｿ繧ｹ繧ｯ謨ｰ繧定｡ｨ遉ｺ・・
      const getBizContent = (title, icon, content, count) => {
        const countBadge = count.total > 0 ? `<span class="biz-task-count ${count.incomplete > 0 ? 'incomplete' : 'complete'}">${count.incomplete}/${count.total}</span>` : '';
        return `<div class="card-section biz-section collapsed"><div class="card-section-header" onclick="toggleBizSection(this, '${project.id}')"><span class="card-section-title">${icon} ${title}${countBadge}</span><span class="card-section-toggle">笆ｼ</span></div><div class="card-section-content">${content}</div></div>`;
      };

      // 髱樒ｮ｡逅・・髄縺・ 繧ｷ繝ｳ繝励Ν縺ｪ繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ・医い繧ｳ繝ｼ繝・ぅ繧ｪ繝ｳ縺ゅｊ縲∝・譛溽憾諷九・髢峨§繧九∵悴螳御ｺ・蜈ｨ繧ｿ繧ｹ繧ｯ謨ｰ繧定｡ｨ遉ｺ・・
      const getSimpleBizContent = (title, icon, content, count) => {
        const countBadge = count.total > 0 ? `<span class="biz-task-count ${count.incomplete > 0 ? 'incomplete' : 'complete'}">${count.incomplete}/${count.total}</span>` : '';
        return `<div class="card-section biz-section collapsed"><div class="card-section-header" onclick="toggleBizSection(this, '${project.id}')"><span class="card-section-title">${icon} ${title}${countBadge}</span><span class="card-section-toggle">笆ｼ</span></div><div class="card-section-content">${content}</div></div>`;
      };

      if (viewCategory === 'admin' || !viewCategory) {
        // 邂｡逅・・ALL: 縺吶∋縺ｦ縺ｮ讌ｭ蜍吝・螳ｹ繧定｡ｨ遉ｺ・域賜莉也噪繧｢繧ｳ繝ｼ繝・ぅ繧ｪ繝ｳ・蛾・ｺ・ 荳榊虚逕｣竊定ｨｭ險遺・IC竊貞ｷ･莠銀・螟匁ｧ・
        return `<div class="biz-sections-group">
    ${getBizContent('荳榊虚逕｣讌ｭ蜍吝・螳ｹ', '召', realestateTasksList.length > 0 ? `<div class="tasks-grid">${realestateTasksHtml}</div>` : '<p class="empty-task-message">荳榊虚逕｣繧ｿ繧ｹ繧ｯ縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ</p>', realestateCount)}
    ${getBizContent('險ｭ險域･ｭ蜍吝・螳ｹ', '盗', `<div class="tasks-grid">${tasksHtml}</div>`, designCount)}
    ${getBizContent('IC讌ｭ蜍吝・螳ｹ', '耳', icTasks.length > 0 ? icRoundCardsHtml : '<p class="empty-task-message">IC繧ｿ繧ｹ繧ｯ縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ</p>', icCount)}
    ${getBizContent('蟾･莠区･ｭ蜍吝・螳ｹ', '畑', constructionTasksList.length > 0 ? `<div class="tasks-grid">${constructionTasksHtml}</div>` : '<p class="empty-task-message">蟾･莠九ち繧ｹ繧ｯ縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ</p>', constructionCount)}
    ${getBizContent('螟匁ｧ区･ｭ蜍吝・螳ｹ', '升', exteriorTasksList.length > 0 ? `<div class="tasks-grid">${exteriorTasksHtml}</div>` : '<p class="empty-task-message">螟匁ｧ九ち繧ｹ繧ｯ縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ</p>', exteriorCount)}</div>`;
      } else if (viewCategory === '險ｭ險・) {
        // 險ｭ險域球蠖・ 險ｭ險域･ｭ蜍吝・螳ｹ縺ｮ縺ｿ縲√い繧ｳ繝ｼ繝・ぅ繧ｪ繝ｳ縺ｪ縺・
        return getSimpleBizContent('險ｭ險域･ｭ蜍吝・螳ｹ', '盗', `<div class="tasks-grid">${tasksHtml}</div>`, designCount);
      } else if (viewCategory === 'IC') {
        // IC諡・ｽ・ IC讌ｭ蜍吝・螳ｹ縺ｮ縺ｿ縲√い繧ｳ繝ｼ繝・ぅ繧ｪ繝ｳ縺ｪ縺・
        return getSimpleBizContent('IC讌ｭ蜍吝・螳ｹ', '耳', icTasks.length > 0 ? icRoundCardsHtml : '<p class="empty-task-message">IC繧ｿ繧ｹ繧ｯ縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ</p>', icCount);
      } else if (viewCategory === '螟匁ｧ・) {
        // 螟匁ｧ区球蠖・ 螟匁ｧ区･ｭ蜍吝・螳ｹ縺ｮ縺ｿ縲√い繧ｳ繝ｼ繝・ぅ繧ｪ繝ｳ縺ｪ縺・
        return getSimpleBizContent('螟匁ｧ区･ｭ蜍吝・螳ｹ', '升', exteriorTasksList.length > 0 ? `<div class="tasks-grid">${exteriorTasksHtml}</div>` : '<p class="empty-task-message">螟匁ｧ九ち繧ｹ繧ｯ縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ</p>', exteriorCount);
      } else if (viewCategory === '荳榊虚逕｣') {
        // 荳榊虚逕｣諡・ｽ・ 荳榊虚逕｣讌ｭ蜍吝・螳ｹ縺ｮ縺ｿ縲√い繧ｳ繝ｼ繝・ぅ繧ｪ繝ｳ縺ｪ縺・
        return getSimpleBizContent('荳榊虚逕｣讌ｭ蜍吝・螳ｹ', '召', realestateTasksList.length > 0 ? `<div class="tasks-grid">${realestateTasksHtml}</div>` : '<p class="empty-task-message">荳榊虚逕｣繧ｿ繧ｹ繧ｯ縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ</p>', realestateCount);
      } else if (viewCategory === '蟾･莠・) {
        // 蟾･莠区球蠖・ 蟾･莠区･ｭ蜍吝・螳ｹ縺ｮ縺ｿ縲√い繧ｳ繝ｼ繝・ぅ繧ｪ繝ｳ縺ｪ縺・
        return getSimpleBizContent('蟾･莠区･ｭ蜍吝・螳ｹ', '畑', constructionTasksList.length > 0 ? `<div class="tasks-grid">${constructionTasksHtml}</div>` : '<p class="empty-task-message">蟾･莠九ち繧ｹ繧ｯ縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ</p>', constructionCount);
      } else {
        return '';
      }
    })()}

    <div class="project-card-footer"><span class="update-time">譖ｴ譁ｰ: ${formatDateTime(project.updated_at)}</span><button class="btn btn-danger btn-small" onclick="deleteProject('${project.id}')">蜑企勁</button></div>
  </div>`;
}

function calculateProgress(project) {
  if (!project) return 0;
  const progressData = project.progress || {};
  const tasks = getTasksForAssignee(project.assigned_to);
  if (tasks.length === 0) return 0;
  const completed = tasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / tasks.length) * 100);
}

// 譯井ｻｶ縺ｮ譛ｪ譖ｴ譁ｰ譌･謨ｰ繧定ｨ育ｮ・
function getProjectStaleDays(project) {
  if (!project.updated_at) return 0;
  const lastUpdate = new Date(project.updated_at);
  const now = new Date();
  const diffMs = now - lastUpdate;
  return Math.floor(diffMs / (1000 * 60 * 60 * 24));
}

// IC諡・ｽ楢・畑縺ｮ騾ｲ謐礼紫險育ｮ暦ｼ・C繧ｿ繧ｹ繧ｯ繝吶・繧ｹ・・
function calculateICProgress(project) {
  if (!project.ic_assignee) return null;
  const progressData = project.progress || {};
  // IC繧ｫ繝・ざ繝ｪ縺ｮ繧ｿ繧ｹ繧ｯ繧貞叙蠕・
  const icTasks = tasksV2.filter(t => t.category === 'IC').sort((a, b) => a.display_order - b.display_order);
  if (icTasks.length === 0) return null;
  const completed = icTasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / icTasks.length) * 100);
}

// 螟匁ｧ区球蠖楢・畑縺ｮ騾ｲ謐礼紫險育ｮ暦ｼ亥､匁ｧ九ち繧ｹ繧ｯ繝吶・繧ｹ・・
function calculateExteriorProgress(project) {
  if (!project.exterior_assignee) return null;
  const progressData = project.progress || {};
  // 螟匁ｧ九き繝・ざ繝ｪ縺ｮ繧ｿ繧ｹ繧ｯ繧貞叙蠕暦ｼ・upabase + localStorage邨ｱ蜷茨ｼ・
  const extTasks = getTasksForCategory('螟匁ｧ・);
  if (extTasks.length === 0) return null;
  const completed = extTasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / extTasks.length) * 100);
}

// 荳榊虚逕｣諡・ｽ楢・畑縺ｮ騾ｲ謐礼紫險育ｮ暦ｼ井ｸ榊虚逕｣繧ｿ繧ｹ繧ｯ繝吶・繧ｹ・・
function calculateRealestateProgress(project) {
  if (!project.realestate_assignee) return null;
  const progressData = project.progress || {};
  // 荳榊虚逕｣繧ｫ繝・ざ繝ｪ縺ｮ繧ｿ繧ｹ繧ｯ繧貞叙蠕暦ｼ・upabase + localStorage邨ｱ蜷茨ｼ・
  const realTasks = getTasksForCategory('荳榊虚逕｣');
  if (realTasks.length === 0) return null;
  const completed = realTasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / realTasks.length) * 100);
}

// 蟾･莠区球蠖楢・畑縺ｮ騾ｲ謐礼紫險育ｮ暦ｼ亥ｷ･莠九ち繧ｹ繧ｯ繝吶・繧ｹ・・
function calculateConstructionProgress(project) {
  if (!project.construction_assignee) return null;
  const progressData = project.progress || {};
  // 蟾･莠九き繝・ざ繝ｪ縺ｮ繧ｿ繧ｹ繧ｯ繧貞叙蠕暦ｼ・upabase + localStorage邨ｱ蜷茨ｼ・
  const constTasks = getTasksForCategory('蟾･莠・);
  if (constTasks.length === 0) return null;
  const completed = constTasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / constTasks.length) * 100);
}

// 蜈ｨ繧ｿ繧ｹ繧ｯ螳御ｺ・メ繧ｧ繝・け縺ｨ閾ｪ蜍輔い繝ｼ繧ｫ繧､繝・
async function checkAndAutoArchive(project) {
  if (project.is_archived) return; // 譌｢縺ｫ繧｢繝ｼ繧ｫ繧､繝匁ｸ医∩縺ｪ繧峨せ繧ｭ繝・・

  const progressData = project.progress || {};
  let allCompleted = true;
  let hasAnyAssignee = false;

  // 險ｭ險域球蠖薙・繧ｿ繧ｹ繧ｯ繝√ぉ繝・け
  if (project.assigned_to) {
    hasAnyAssignee = true;
    const designTasks = tasksV2.filter(t => t.category === '險ｭ險・);
    if (designTasks.length > 0) {
      const designCompleted = designTasks.every(t => progressData[t.task_key]?.completed);
      if (!designCompleted) allCompleted = false;
    }
  }

  // IC諡・ｽ薙・繧ｿ繧ｹ繧ｯ繝√ぉ繝・け
  if (project.ic_assignee) {
    hasAnyAssignee = true;
    const icTasks = tasksV2.filter(t => t.category === 'IC');
    if (icTasks.length > 0) {
      const icCompleted = icTasks.every(t => progressData[t.task_key]?.completed);
      if (!icCompleted) allCompleted = false;
    }
  }

  // 螟匁ｧ区球蠖薙・繧ｿ繧ｹ繧ｯ繝√ぉ繝・け
  if (project.exterior_assignee) {
    hasAnyAssignee = true;
    const extTasks = getTasksForCategory('螟匁ｧ・);
    if (extTasks.length > 0) {
      const extCompleted = extTasks.every(t => progressData[t.task_key]?.completed);
      if (!extCompleted) allCompleted = false;
    }
  }

  // 荳榊虚逕｣諡・ｽ薙・繧ｿ繧ｹ繧ｯ繝√ぉ繝・け
  if (project.realestate_assignee) {
    hasAnyAssignee = true;
    const reTasks = getTasksForCategory('荳榊虚逕｣');
    if (reTasks.length > 0) {
      const reCompleted = reTasks.every(t => progressData[t.task_key]?.completed);
      if (!reCompleted) allCompleted = false;
    }
  }

  // 蟾･莠区球蠖薙・繧ｿ繧ｹ繧ｯ繝√ぉ繝・け
  if (project.construction_assignee) {
    hasAnyAssignee = true;
    const conTasks = getTasksForCategory('蟾･莠・);
    if (conTasks.length > 0) {
      const conCompleted = conTasks.every(t => progressData[t.task_key]?.completed);
      if (!conCompleted) allCompleted = false;
    }
  }

  // 諡・ｽ楢・′險ｭ螳壹＆繧後※縺・※蜈ｨ繧ｿ繧ｹ繧ｯ螳御ｺ・↑繧芽・蜍輔い繝ｼ繧ｫ繧､繝・
  if (hasAnyAssignee && allCompleted) {
    // 遒ｺ隱阪ム繧､繧｢繝ｭ繧ｰ繧定｡ｨ遉ｺ
    const confirmed = await showConfirmDialog(
      '蜈ｨ繧ｿ繧ｹ繧ｯ螳御ｺ・,
      `縲・{project.customer}縲阪・蜈ｨ繧ｿ繧ｹ繧ｯ縺悟ｮ御ｺ・＠縺ｾ縺励◆縲・n譯井ｻｶ繧貞ｮ御ｺ・ｸ医∩縺ｫ遘ｻ蜍輔＠縺ｾ縺吶°・歔
    );

    if (confirmed) {
      const { error } = await supabase
        .from('projects')
        .update({ is_archived: true, updated_at: new Date().toISOString() })
        .eq('id', project.id);

      if (!error) {
        project.is_archived = true;
        showToast(`縲・{project.customer}縲阪ｒ螳御ｺ・ｸ医∩縺ｫ遘ｻ蜍輔＠縺ｾ縺励◆`, 'success');
        renderProjects();
        renderSidebar();
      }
    }
  }
}

// 遒ｺ隱阪ム繧､繧｢繝ｭ繧ｰ・・romise迚茨ｼ・
function showConfirmDialog(title, message) {
  return new Promise((resolve) => {
    const result = confirm(`${title}\n\n${message}`);
    resolve(result);
  });
}

function formatDateTime(dateStr) {
  if (!dateStr) return '窶・;
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return '窶・;
  return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
}

async function updateTaskStatus(projectId, taskKey, completed) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // Undo逕ｨ縺ｫ螟画峩蜑阪・迥ｶ諷九ｒ菫晏ｭ・
  const oldProgress = JSON.parse(JSON.stringify(project.progress || {}));

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].completed = completed;
  if (completed && !progressData[taskKey].date) {
    progressData[taskKey].date = new Date().toISOString().split('T')[0];
  }

  showStatus('菫晏ｭ倅ｸｭ...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  // Undo險倬鹸
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  UndoManager.record({
    type: 'UPDATE_PROJECT',
    projectId: projectId,
    description: `${project.customer} - ${taskDef?.task_name || taskKey}繧・{completed ? '螳御ｺ・ : '譛ｪ螳御ｺ・}縺ｫ螟画峩`,
    oldValue: { progress: oldProgress },
    newValue: { progress: progressData }
  });

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  markLocalUpdate(projectId); // 繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄縺ｮ莠碁㍾譖ｴ譁ｰ髦ｲ豁｢
  renderProjects();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
}

// 繧ｿ繧ｹ繧ｯ譛滄剞縺ｮ繧ｹ繝・・繧ｿ繧ｹ蛻､螳・
function getTaskDueStatus(dueDate, completed) {
  if (!dueDate || completed) {
    return { class: '', badgeClass: 'normal', label: '' };
  }

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const due = new Date(dueDate);
  due.setHours(0, 0, 0, 0);
  const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

  if (diffDays < 0) {
    return { class: 'overdue', badgeClass: 'overdue', label: `${Math.abs(diffDays)}譌･驕・ｻｶ` };
  } else if (diffDays === 0) {
    return { class: 'due-soon', badgeClass: 'overdue', label: '譛ｬ譌･譛滄剞' };
  } else if (diffDays <= 3) {
    return { class: 'due-soon', badgeClass: 'due-soon', label: `縺ゅ→${diffDays}譌･` };
  } else {
    const m = due.getMonth() + 1;
    const d = due.getDate();
    return { class: '', badgeClass: 'normal', label: `${m}/${d}` };
  }
}

// 繧ｿ繧ｹ繧ｯ譛滄剞縺ｮ譖ｴ譁ｰ
async function updateTaskDueDate(projectId, taskKey, dueDate) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // 驕主悉譌･莉倥メ繧ｧ繝・け・郁ｭｦ蜻翫・縺ｿ縲∽ｿ晏ｭ倥・險ｱ蜿ｯ・・
  if (dueDate && !Validators.isNotPastDate(dueDate)) {
    const confirmPast = confirm('驕主悉縺ｮ譌･莉倥′險ｭ螳壹＆繧後※縺・∪縺吶ゅ％縺ｮ譌･莉倥〒菫晏ｭ倥＠縺ｾ縺吶°・・);
    if (!confirmPast) {
      renderProjects();
      return;
    }
  }

  // Undo逕ｨ縺ｫ螟画峩蜑阪・迥ｶ諷九ｒ菫晏ｭ・
  const oldProgress = JSON.parse(JSON.stringify(project.progress || {}));
  const oldDueDate = oldProgress[taskKey]?.due_date || '';

  // 譌｢蟄倥・progress繝・・繧ｿ繧貞ｮ悟・縺ｫ繧ｳ繝斐・縺励※譁ｰ縺励＞繧ｪ繝悶ず繧ｧ繧ｯ繝医ｒ菴懈・
  const progressData = JSON.parse(JSON.stringify(project.progress || {}));
  // 譌｢蟄倥・繧ｿ繧ｹ繧ｯ繝・・繧ｿ繧剃ｿ晄戟縺励↑縺後ｉdue_date縺ｮ縺ｿ譖ｴ譁ｰ
  if (!progressData[taskKey]) {
    progressData[taskKey] = { completed: false, date: '', state: '', due_date: '' };
  }
  progressData[taskKey].due_date = dueDate;

  showStatus('菫晏ｭ倅ｸｭ...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    ErrorHandler.handle(error, '譛滄剞菫晏ｭ・);
    return;
  }

  // Undo險倬鹸
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  UndoManager.record({
    type: 'UPDATE_PROJECT',
    projectId: projectId,
    description: `${project.customer} - ${taskDef?.task_name || taskKey}縺ｮ譛滄剞繧・{dueDate || '隗｣髯､'}縺ｫ螟画峩`,
    oldValue: { progress: oldProgress },
    newValue: { progress: progressData }
  });

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  markLocalUpdate(projectId); // 繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄縺ｮ莠碁㍾譖ｴ譁ｰ髦ｲ豁｢
  renderProjects();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  if (dueDate) {
    showToast('譛滄剞繧定ｨｭ螳壹＠縺ｾ縺励◆', 'success');
  }
}

// 繧ｿ繧ｹ繧ｯ繝｡繝｢縺ｮ譖ｴ譁ｰ・医◎縺ｮ莉冶ｦ狗ｩ堺ｾ晞ｼ縺ｪ縺ｩ・・
async function updateTaskMemo(projectId, taskKey, memo) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // 譌｢蟄倥・progress繝・・繧ｿ繧貞ｮ悟・縺ｫ繧ｳ繝斐・縺励※譁ｰ縺励＞繧ｪ繝悶ず繧ｧ繧ｯ繝医ｒ菴懈・
  const progressData = JSON.parse(JSON.stringify(project.progress || {}));
  // 譌｢蟄倥・繧ｿ繧ｹ繧ｯ繝・・繧ｿ繧剃ｿ晄戟縺励↑縺後ｉmemo縺ｮ縺ｿ譖ｴ譁ｰ
  if (!progressData[taskKey]) {
    progressData[taskKey] = { completed: false, date: '', state: '', due_date: '', memo: '' };
  }
  progressData[taskKey].memo = memo;

  showStatus('菫晏ｭ倅ｸｭ...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    ErrorHandler.handle(error, '繝｡繝｢菫晏ｭ・);
    return;
  }

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  markLocalUpdate(projectId); // 繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄縺ｮ莠碁㍾譖ｴ譁ｰ髦ｲ豁｢
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
}

// 繧ｹ繝・・繧ｿ繧ｹ濶ｲ蛻・￠縺ｮ繧ｯ繝ｩ繧ｹ繧貞叙蠕・
// taskKey: 繧ｪ繝励す繝ｧ繝ｳ縲・C繧ｿ繧ｹ繧ｯ縺ｮ迚ｹ蛻･縺ｪ濶ｲ蛻・￠縺ｫ菴ｿ逕ｨ
function getStateColorClass(state, lastOption, taskKey = '') {
  // 遨ｺ縲・縲］ull 竊・濶ｲ縺ｪ縺暦ｼ育區・・
  if (!state || state === '-' || state === '') {
    return '';
  }

  // IC繝｡繝ｼ繧ｫ繝ｼ繧ｿ繧ｹ繧ｯ: 螳御ｺ・憾諷具ｼ域怙蠕後・驕ｸ謚櫁い・峨・縺ｿ髱定牡縲√◎繧御ｻ･螟悶・鮟・牡
  if (IC_MAKER_TASKS.includes(taskKey)) {
    // 譛蠕後・驕ｸ謚櫁い・井ｿ晏ｭ俶ｸ医↑縺ｩ・俄・ 髱・
    if (state === lastOption) {
      return 'state-blue';
    }
    // 縺昴ｌ莉･螟厄ｼ井ｾ晞ｼ貂医↑縺ｩ・俄・ 鮟・
    return 'state-yellow';
  }

  // IC繧ｿ繧ｹ繧ｯ迚ｹ蛻･蜃ｦ逅・ 繧ｫ繝ｼ繝・Φ邏ｹ莉九・騾菴懈･ｭ閠・ｴｹ莉九・螳ｶ蜈ｷ隕狗ｩ堺ｾ晞ｼ繝ｻ繧ｿ繧､繝ｫ繝励Ξ繧ｼ繝ｳ縺ｯ縲檎┌縲阪檎┌縺励阪ｂ髱定牡
  if (taskKey === 'ic_curtain' || taskKey === 'ic_zousaku' || taskKey === 'ic_furniture' || taskKey === 'ic_tile_pres') {
    if (state === '辟｡' || state === '辟｡縺・ || state === '萓晞ｼ貂・ || state === '菴懈・貂・) {
      return 'state-blue';
    }
  }

  // 繧｢繧､繧｢繝ｳ萓晞ｼ繝ｻ縺昴・莉冶ｦ狗ｩ堺ｾ晞ｼ: 縲檎┌縺励阪御ｿ晏ｭ俶ｸ医阪・髱定牡縲√御ｾ晞ｼ貂医阪・鮟・牡
  if (taskKey === 'ic_iron' || taskKey === 'ic_other_estimate') {
    if (state === '辟｡縺・ || state === '菫晏ｭ俶ｸ・) {
      return 'state-blue';
    }
    if (state === '萓晞ｼ貂・) {
      return 'state-yellow';
    }
  }

  // 譛蠕後・驕ｸ謚櫁い・亥ｮ御ｺ・憾諷具ｼ俄・ 髱・
  if (state === lastOption) {
    return 'state-blue';
  }
  // 縺昴・莉厄ｼ磯ｲ陦御ｸｭ・俄・ 鮟・
  return 'state-yellow';
}

// 繧ｹ繝・・繧ｿ繧ｹ繧ｫ繝ｼ繝蛾∈謚槭・HTML逕滓・
function generateStatusCards(stateOptions, currentState, projectId, taskKey) {
  if (!stateOptions || !Array.isArray(stateOptions)) return '';
  const lastOption = stateOptions[stateOptions.length - 1];
  return `<div class="status-cards" data-project-id="${projectId}" data-task-key="${taskKey}" data-last-option="${lastOption}">${stateOptions.map(state => {
    const isActive = currentState === state;
    const stateClass = isActive ? getStateColorClass(state, lastOption, taskKey) : '';
    const displayText = state || '-';
    return `<span class="status-card${isActive ? ' active' : ''}${stateClass ? ' ' + stateClass : ''}" data-value="${state}" onclick="selectStatusCard(this, '${projectId}', '${taskKey}')">${displayText}</span>`;
  }).join('')}</div>`;
}

// 繧ｹ繝・・繧ｿ繧ｹ繧ｫ繝ｼ繝峨け繝ｪ繝・け蜃ｦ逅・
function selectStatusCard(cardEl, projectId, taskKey) {
  const container = cardEl.closest('.status-cards');
  const lastOption = container.dataset.lastOption || '';
  const state = cardEl.dataset.value;

  // 縺吶∋縺ｦ縺ｮ繧ｫ繝ｼ繝峨°繧餌ctive繧貞､悶☆
  container.querySelectorAll('.status-card').forEach(c => {
    c.classList.remove('active', 'state-blue', 'state-yellow', 'state-red');
  });

  // 繧ｯ繝ｪ繝・け縺励◆繧ｫ繝ｼ繝峨ｒactive縺ｫ
  cardEl.classList.add('active');
  const stateClass = getStateColorClass(state, lastOption, taskKey);
  if (stateClass) {
    cardEl.classList.add(stateClass);
  }

  // 繝｡繝ｼ繝ｫ繝懊ち繝ｳ縺ｮ陦ｨ遉ｺ/髱櫁｡ｨ遉ｺ繧呈峩譁ｰ・郁ｨｭ險医ち繧ｹ繧ｯ縺ｯ蟶ｸ縺ｫ陦ｨ遉ｺ・・
  const taskItem = cardEl.closest('.task-item');
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  const isDesignTask = taskDef?.category === '險ｭ險・;
  const isInternalStatus = INTERNAL_STATUSES.includes(state);
  if (taskItem && !isDesignTask) {
    const emailBtn = taskItem.querySelector('.task-email-btn');
    if (emailBtn) {
      emailBtn.style.display = isInternalStatus ? 'none' : '';
    }
  }

  // IC繝｡繝ｼ繧ｫ繝ｼ繧ｿ繧ｹ繧ｯ縺ｮ繝・・繝ｫ繝√ャ繝玲峩譁ｰ
  if (IC_MAKER_TASKS.includes(taskKey) && state && state !== '-') {
    if (!isInternalStatus) {
      cardEl.title = `透 ${state}縺ｫ繝｡繝ｼ繝ｫ騾∽ｿ｡蜿ｯ閭ｽ`;
    } else {
      cardEl.removeAttribute('title');
    }
  }

  // 騾ｲ謐励ョ繝ｼ繧ｿ繧剃ｿ晏ｭ・
  updateTaskState(projectId, taskKey, state);

  // IC繧ｿ繧ｹ繧ｯ縺ｮ蝣ｴ蜷医∝・5蝗槫ｮ御ｺ・メ繧ｧ繝・け
  if (taskKey.startsWith('ic_')) {
    setTimeout(() => checkICCompletionAndArchive(projectId), 500);
  }
}

// IC蜈ｨ5蝗槫ｮ御ｺ・凾縺ｮ閾ｪ蜍輔い繝ｼ繧ｫ繧､繝也｢ｺ隱・
async function checkICCompletionAndArchive(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project || project.is_archived) return;

  const progressData = project.progress || {};

  // 蜷・屓縺ｮ迥ｶ諷九ｒ險育ｮ・
  const roundStatuses = IC_ROUNDS.map((round, idx) =>
    getICRoundStatus(progressData, round.tasks, idx, IC_ROUNDS)
  );

  // 蜈ｨ5蝗槭′髱抵ｼ亥ｮ御ｺ・ｼ峨°繝√ぉ繝・け
  const allComplete = roundStatuses.every(status => status === 'blue');

  if (allComplete) {
    // 蜈ｨ蝗槫ｮ御ｺ・竊・繧｢繝ｼ繧ｫ繧､繝也｢ｺ隱・
    if (confirm(`脂 IC讌ｭ蜍吶′蜈ｨ縺ｦ螳御ｺ・＠縺ｾ縺励◆・―n\n縲・{project.customer}縲阪ｒ螳御ｺ・ｸ医∩譯井ｻｶ縺ｫ遘ｻ蜍輔＠縺ｾ縺吶°・歔)) {
      await archiveProjectDirect(projectId);
    }
  }
}

// 逶ｴ謗･繧｢繝ｼ繧ｫ繧､繝門ｮ溯｡鯉ｼ育｢ｺ隱阪↑縺暦ｼ・
async function archiveProjectDirect(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  showStatus('譖ｴ譁ｰ荳ｭ...', 'saving');

  const updateData = {
    is_archived: true,
    archived_at: new Date().toISOString()
  };

  const { error } = await supabase
    .from('projects')
    .update(updateData)
    .eq('id', projectId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('譖ｴ譁ｰ縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  // 繝ｭ繝ｼ繧ｫ繝ｫ繝・・繧ｿ繧呈峩譁ｰ
  project.is_archived = true;
  project.archived_at = updateData.archived_at;
  markLocalUpdate(projectId); // 繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄縺ｮ莠碁㍾譖ｴ譁ｰ髦ｲ豁｢

  renderProjects();
  renderSidebar();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('笨・螳御ｺ・ｸ医∩譯井ｻｶ縺ｫ遘ｻ蜍輔＠縺ｾ縺励◆', 'success');
}

// IC蝗槭・迥ｶ諷九ｒ險育ｮ暦ｼ・ray/blue/yellow/red・・
function getICRoundStatus(progressData, roundTasks, roundIndex, allRounds) {
  if (!roundTasks || roundTasks.length === 0) return 'gray';

  let completedCount = 0;
  let hasAnyValue = false;

  for (const taskKey of roundTasks) {
    const taskData = progressData[taskKey];
    const state = taskData?.state || '';
    const taskDef = tasksV2.find(t => t.task_key === taskKey);

    if (state && state !== '-' && state !== '') {
      hasAnyValue = true;
      // 譛邨ら憾諷九°縺ｩ縺・°繝√ぉ繝・け
      if (taskDef && taskDef.state_options) {
        let options = taskDef.state_options;
        if (typeof options === 'string') {
          try { options = JSON.parse(options); } catch (e) { options = []; }
        }
        const lastOption = options[options.length - 1];
        // 迚ｹ螳壹ち繧ｹ繧ｯ縺ｯ縲檎┌縺励阪ｂ螳御ｺ・桶縺・
        const isCompleted = state === lastOption ||
          (['ic_zousaku', 'ic_furniture', 'ic_tile_pres', 'ic_iron', 'ic_other_estimate'].includes(taskKey) &&
            (state === '辟｡' || state === '辟｡縺・));
        if (isCompleted) completedCount++;
      }
    }
  }

  // 蜈ｨ繧ｿ繧ｹ繧ｯ螳御ｺ・竊・髱・
  if (completedCount === roundTasks.length) return 'blue';

  // 騾比ｸｭ 竊・鮟・
  if (hasAnyValue) {
    // 蜑阪・蝗槭′譛ｪ螳御ｺ・↑縺ｮ縺ｫ縺薙・蝗槭↓騾ｲ繧薙〒縺・ｋ 竊・襍､
    if (roundIndex > 0) {
      const prevRound = allRounds[roundIndex - 1];
      const prevStatus = getICRoundStatus(progressData, prevRound.tasks, roundIndex - 1, allRounds);
      if (prevStatus !== 'blue' && prevStatus !== 'gray') {
        // 蜑阪・蝗槭′鮟・牡・磯比ｸｭ・峨〒縺薙・蝗槭↓騾ｲ繧薙〒縺・ｋ蝣ｴ蜷医∝燕縺ｮ蝗槭ｒ襍､縺ｫ縺吶ｋ蛻､螳壹・蛻･騾・
      }
    }
    return 'yellow';
  }

  // 譛ｪ逹謇・竊・繧ｰ繝ｬ繝ｼ
  return 'gray';
}

// IC蝗槭き繝ｼ繝峨・HTML逕滓・
function generateICRoundCards(project, progressData) {
  const projectId = project.id;

  // 蜷・屓縺ｮ迥ｶ諷九ｒ險育ｮ暦ｼ亥・縺ｫ蜈ｨ蝗櫁ｨ育ｮ励＠縺ｦ襍､縺ｮ蛻､螳壹↓菴ｿ逕ｨ・・
  const roundStatuses = IC_ROUNDS.map((round, idx) =>
    getICRoundStatus(progressData, round.tasks, idx, IC_ROUNDS)
  );

  // 襍､縺ｮ蛻､螳・ 蜑阪・蝗槭′譛ｪ螳御ｺ・〒谺｡縺ｮ蝗槭↓騾ｲ繧薙〒縺・ｋ蝣ｴ蜷・
  for (let i = 0; i < roundStatuses.length - 1; i++) {
    if (roundStatuses[i] !== 'blue' && roundStatuses[i] !== 'gray') {
      // 縺薙・蝗槭・騾比ｸｭ縺縺後∵ｬ｡縺ｮ蝗樔ｻ･髯阪↓騾ｲ繧薙〒縺・ｋ縺具ｼ・
      for (let j = i + 1; j < roundStatuses.length; j++) {
        if (roundStatuses[j] !== 'gray') {
          roundStatuses[i] = 'red'; // 譛ｪ螳御ｺ・・縺ｾ縺ｾ繧ｹ繧ｭ繝・・
          break;
        }
      }
    }
  }

  // 繧ｫ繝ｼ繝羽TML
  const cardsHtml = IC_ROUNDS.map((round, idx) => {
    const status = roundStatuses[idx];
    return `<div class="ic-round-card state-${status}" data-round="${round.round}" data-project-id="${projectId}" onclick="toggleICRound(this, '${projectId}', ${round.round})">${round.name}</div>`;
  }).join('');

  // 蜷・屓縺ｮ繧ｿ繧ｹ繧ｯHTML
  const contentsHtml = IC_ROUNDS.map(round => {
    const roundTasks = round.tasks.map(taskKey => {
      const taskDef = tasksV2.find(t => t.task_key === taskKey);
      if (!taskDef) return '';

      const task = progressData[taskKey] || { completed: false, date: '', state: '', due_date: '' };
      const hasVendor = taskVendorMappings.some(m => m.task_id === taskDef.id);
      const isInternalStatus = INTERNAL_STATUSES.includes(task.state);
      const showEmailButton = taskDef.has_email_button !== false && hasVendor && !isInternalStatus;
      const emailBtn = showEmailButton ?
        `<button class="task-email-btn" onclick="openEmailFromTask('${projectId}', '${taskKey}')" title="繝｡繝ｼ繝ｫ菴懈・">透</button>` : '';

      const stateOptions = getTaskStateOptions(taskKey);
      const stateCards = generateStatusCards(stateOptions, task.state, projectId, taskKey);

      const requestDateBadge = task.request_date
        ? `<span class="request-date-badge" title="萓晞ｼ譌･: ${task.request_date}">${formatDateShort(task.request_date)}</span>`
        : '';

      const dueDateInput = taskKey === 'ic_final_checklist'
        ? `<input type="date" class="task-due-input" value="${task.due_date || ''}" onchange="updateTaskDueDate('${projectId}', '${taskKey}', this.value)" title="譛滄剞繧定ｨｭ螳・>`
        : '';

      const memoInput = taskDef.has_memo
        ? `<input type="text" class="task-memo-input" value="${task.memo || ''}" placeholder="萓晞ｼ蜀・ｮｹ繧貞・蜉・ onchange="updateTaskMemo('${projectId}', '${taskKey}', this.value)" >`
        : '';

      return `<div class="task-item">
        <span class="task-label">${taskDef.task_name}</span>${stateCards}${memoInput}${dueDateInput}${requestDateBadge}${emailBtn}</div>`;
    }).join('');

    return `<div class="ic-round-content" data-round="${round.round}" data-project-id="${projectId}">${roundTasks}</div>`;
  }).join('');

  return `<div class="ic-rounds-container" data-project-id="${projectId}">
    <div class="ic-round-cards">${cardsHtml}</div>
    ${contentsHtml}
  </div>`;
}

// IC蝗槭き繝ｼ繝峨・繧ｯ繝ｪ繝・け蜃ｦ逅・
function toggleICRound(cardEl, projectId, roundNum) {
  const container = cardEl.closest('.ic-rounds-container');

  // 縺吶∋縺ｦ縺ｮ繧ｫ繝ｼ繝峨°繧餌ctive繧貞､悶☆
  container.querySelectorAll('.ic-round-card').forEach(c => c.classList.remove('active'));
  // 縺吶∋縺ｦ縺ｮ繧ｳ繝ｳ繝・Φ繝・ｒ髱櫁｡ｨ遉ｺ
  container.querySelectorAll('.ic-round-content').forEach(c => c.classList.remove('active'));

  // 繧ｯ繝ｪ繝・け縺励◆繧ｫ繝ｼ繝峨ｒactive縺ｫ
  cardEl.classList.add('active');

  // 蟇ｾ蠢懊☆繧九さ繝ｳ繝・Φ繝・ｒ陦ｨ遉ｺ
  const content = container.querySelector(`.ic-round-content[data-round="${roundNum}"]`);
  if (content) content.classList.add('active');
}

// 繧ｹ繝・・繧ｿ繧ｹ螟画峩譎ゅ↓濶ｲ繧よ峩譁ｰ
function updateTaskStateWithColor(selectEl, projectId, taskKey) {
  const state = selectEl.value;
  const lastOption = selectEl.dataset.lastOption || '';

  // CSS繧ｯ繝ｩ繧ｹ繧呈峩譁ｰ
  selectEl.classList.remove('state-blue', 'state-yellow');
  const newClass = getStateColorClass(state, lastOption, taskKey);
  if (newClass) {
    selectEl.classList.add(newClass);
  }

  // 繝｡繝ｼ繝ｫ繝懊ち繝ｳ縺ｮ陦ｨ遉ｺ/髱櫁｡ｨ遉ｺ繧貞虚逧・↓譖ｴ譁ｰ
  const taskItem = selectEl.closest('.task-item');
  const isInternalStatus = INTERNAL_STATUSES.includes(state);
  if (taskItem) {
    const emailBtn = taskItem.querySelector('.task-email-btn');
    if (emailBtn) {
      emailBtn.style.display = isInternalStatus ? 'none' : '';
    }
  }

  // 繝・・繝ｫ繝√ャ繝励ｒ譖ｴ譁ｰ・医Γ繝ｼ繧ｫ繝ｼ驕ｸ謚槭ち繧ｹ繧ｯ・・
  if (IC_MAKER_TASKS.includes(taskKey)) {
    if (state && !isInternalStatus) {
      selectEl.title = `透 ${state}縺ｫ繝｡繝ｼ繝ｫ騾∽ｿ｡蜿ｯ閭ｽ`;
    } else {
      selectEl.removeAttribute('title');
    }
  }

  // 繝・・繧ｿ繧剃ｿ晏ｭ・
  updateTaskState(projectId, taskKey, state);
}

async function updateTaskState(projectId, taskKey, state) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // Undo逕ｨ縺ｫ螟画峩蜑阪・迥ｶ諷九ｒ菫晏ｭ・
  const oldProgress = JSON.parse(JSON.stringify(project.progress || {}));
  const oldState = oldProgress[taskKey]?.state || '';

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].state = state;

  // 萓晞ｼ譌･縺ｮ險倬鹸・医御ｾ晞ｼ縲阪ｒ蜷ｫ繧繧ｹ繝・・繧ｿ繧ｹ縺ｫ螟画峩縺輔ｌ縺滓凾轤ｹ縺ｧ險倬鹸・・
  if (state && state.includes('萓晞ｼ') && !progressData[taskKey].request_date) {
    progressData[taskKey].request_date = new Date().toISOString().split('T')[0];
  }
  // 繧ｹ繝・・繧ｿ繧ｹ縺後・縲阪↓謌ｻ縺輔ｌ縺溘ｉ萓晞ｼ譌･繧偵け繝ｪ繧｢
  if (state === '-' || state === '') {
    progressData[taskKey].request_date = null;
  }

  // 繧ｹ繝・・繧ｿ繧ｹ縺梧怙邨ら憾諷九↓縺ｪ縺｣縺溘ｉcompleted繧稚rue縺ｫ縺吶ｋ
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  if (taskDef && taskDef.state_options) {
    try {
      const options = typeof taskDef.state_options === 'string'
        ? JSON.parse(taskDef.state_options)
        : taskDef.state_options;
      const lastOption = options[options.length - 1];
      progressData[taskKey].completed = (state === lastOption);
    } catch (e) {
      console.warn('繧ｹ繝・・繧ｿ繧ｹ繧ｪ繝励す繝ｧ繝ｳ縺ｮ繝代・繧ｹ縺ｫ螟ｱ謨・', e);
    }
  }

  // 逕ｳ隲季o縺悟ｮ御ｺ・ｸ医∩縺ｮ蝣ｴ蜷医∵擅莉ｶ繧貞・繝√ぉ繝・け
  let applicationGoCleared = false;
  if (progressData['application']?.completed) {
    // 荳譎ら噪縺ｫprogress繧呈峩譁ｰ縺励※譚｡莉ｶ繝√ぉ繝・け
    const tempProject = { ...project, progress: progressData };
    if (!canPressApplicationGo(tempProject)) {
      // 譚｡莉ｶ縺九ｉ螟悶ｌ縺溘・縺ｧ逕ｳ隲季o繧偵け繝ｪ繧｢
      progressData['application'].completed = false;
      progressData['application'].date = null;
      applicationGoCleared = true;
    }
  }

  showStatus('菫晏ｭ倅ｸｭ...', 'saving');

  // 逕ｳ隲季o縺後け繝ｪ繧｢縺輔ｌ縺溷ｴ蜷医（s_archived繧Ｇalse縺ｫ謌ｻ縺・
  const updateData = {
    progress: progressData,
    updated_at: new Date().toISOString()
  };
  if (applicationGoCleared) {
    updateData.is_archived = false;
  }

  const { error } = await supabase
    .from('projects')
    .update(updateData)
    .eq('id', projectId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  // Undo險倬鹸
  UndoManager.record({
    type: 'UPDATE_PROJECT',
    projectId: projectId,
    description: `${project.customer} - ${taskDef?.task_name || taskKey}繧偵・{state || '譛ｪ險ｭ螳・}縲阪↓螟画峩`,
    oldValue: { progress: oldProgress },
    newValue: { progress: progressData }
  });

  project.progress = progressData;
  project.updated_at = new Date().toISOString();

  // 蜈ｨ繧ｿ繧ｹ繧ｯ螳御ｺ・メ繧ｧ繝・け・郁ｨｭ螳壹＆繧後※縺・ｋ諡・ｽ楢・・繧ｿ繧ｹ繧ｯ縺後☆縺ｹ縺ｦ螳御ｺ・＠縺溘ｉ閾ｪ蜍輔い繝ｼ繧ｫ繧､繝厄ｼ・
  checkAndAutoArchive(project);

  // 逕ｳ隲季O縺ｮ迥ｶ諷九′螟峨ｏ繧句庄閭ｽ諤ｧ縺後≠繧九◆繧√∝ｸｸ縺ｫUI繧呈峩譁ｰ
  // 隧ｲ蠖薙・譯井ｻｶ繧ｫ繝ｼ繝峨・縺ｿ繧呈峩譁ｰ・医ヱ繝輔か繝ｼ繝槭Φ繧ｹ譛驕ｩ蛹厄ｼ・
  const projectCard = document.querySelector(`.project-card[data-project-id="${projectId}"]`);
  if (projectCard) {
    const applicationGoEnabled = canPressApplicationGo(project);
    const applicationGoContainer = projectCard.querySelector('.application-go-container');
    if (applicationGoContainer) {
      const taskDef = tasksV2.find(t => t.task_key === 'application');
      const applicationGoData = progressData['application'] || {};

      if (applicationGoData.completed) {
        // 螳御ｺ・ｸ医∩
        applicationGoContainer.outerHTML = `<div class="application-go-container application-go-completed">
          <div class="application-go-icon">笨・/div>
          <div class="application-go-text">${taskDef?.task_name || '逕ｳ隲季O'} 螳御ｺ・/div>
        </div>`;
      } else if (applicationGoEnabled) {
        // 譚｡莉ｶ縺梧純縺｣縺ｦ縺・ｋ・壹け繝ｪ繝・け蜿ｯ閭ｽ
        applicationGoContainer.outerHTML = `<div class="application-go-container application-go-ready" onclick="confirmApplicationGo('${projectId}')">
          <div class="application-go-icon">噫</div>
          <div class="application-go-text">${taskDef?.task_name || '逕ｳ隲季O'}</div>
          <div class="application-go-arrow">竊・/div>
        </div>`;
      } else {
        // 譚｡莉ｶ譛ｪ驕・
        const requiredTasks = getApplicationGoRequiredTasks();
        const tooltip = requiredTasks.length > 0
          ? requiredTasks.map(r => `${r.task_name}:${r.finalState}`).join('縲・) + ' 縺悟ｿ・ｦ・
          : '螟ｪ髯ｽ蜈・蝟ｶ讌ｭ蜈ｱ譛画ｸ医∫ｵｦ謗呈ｰｴ:菫晏ｭ俶ｸ医∵鋤豌・菫晏ｭ俶ｸ医√し繝・す:菫晏ｭ俶ｸ・縺悟ｿ・ｦ・;
        applicationGoContainer.outerHTML = `<div class="application-go-container application-go-disabled" title="${tooltip}">
          <div class="application-go-icon">白</div>
          <div class="application-go-text">${taskDef?.task_name || '逕ｳ隲季O'}</div>
          <div class="application-go-status">譚｡莉ｶ譛ｪ驕・/div>
        </div>`;
      }
    }
  }

  if (applicationGoCleared) {
    project.is_archived = false;
    renderProjects();
    renderSidebar();
    showToast('逕ｳ隲季o譚｡莉ｶ縺九ｉ螟悶ｌ縺溘◆繧√∝ｮ御ｺ・憾諷九ｒ隗｣髯､縺励∪縺励◆', 'warning');
  }
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
}

function openProjectModal(projectId = null) {
  log('統 openProjectModal() 蜻ｼ縺ｳ蜃ｺ縺・', projectId);
  log('則 designers驟榊・:', designers);

  editingProjectId = projectId;
  const modal = document.getElementById('projectModal');
  const title = document.getElementById('projectModalTitle');

  log('識 modal隕∫ｴ:', modal);
  log('識 title隕∫ｴ:', title);

  let project = null;
  if (projectId) {
    project = projects.find(p => p.id === projectId);
    if (!project) {
      showToast('譯井ｻｶ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ', 'error');
      return;
    }
    title.textContent = '譯井ｻｶ邱ｨ髮・;
    document.getElementById('projectCustomer').value = project.customer;
    document.getElementById('projectSpecifications').value = project.specifications || 'LIFE';
  } else {
    title.textContent = '譯井ｻｶ霑ｽ蜉';
    document.getElementById('projectCustomer').value = '';
    document.getElementById('projectSpecifications').value = 'LIFE';
  }

  // 險ｭ險域球蠖楢・ｼ郁ｨｭ險医き繝・ざ繝ｪ縺ｮ縺ｿ・峨ｒ蝓九ａ繧・
  log('肌 險ｭ險域球蠖楢・ｒ繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ荳ｭ...');
  const sekkeiDesigners = designers.filter(d => d.category === '險ｭ險・);
  log('笨・險ｭ險域球蠖楢・', sekkeiDesigners);

  const assignedToSelect = document.getElementById('projectAssignedTo');
  log('識 assignedToSelect隕∫ｴ:', assignedToSelect);

  if (assignedToSelect) {
    assignedToSelect.innerHTML = '<option value="">驕ｸ謚槭＠縺ｦ縺上□縺輔＞</option>' +
      sekkeiDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    // 蛟､繧定ｨｭ螳夲ｼ・nnerHTML蠕後↓螳溯｡鯉ｼ・
    if (projectId && project) {
      // 邱ｨ髮・凾: 譌｢蟄倥・諡・ｽ楢・ｒ驕ｸ謚・
      assignedToSelect.value = project.assigned_to;
    } else if (currentDesignerTab !== 'ALL' && currentDesignerTab !== 'ARCHIVED') {
      // 譁ｰ隕乗｡井ｻｶ縺ｮ蝣ｴ蜷医∫樟蝨ｨ驕ｸ謚樔ｸｭ縺ｮ繧ｿ繝悶・諡・ｽ楢・ｒ閾ｪ蜍暮∈謚・
      const currentDesigner = sekkeiDesigners.find(d => d.name === currentDesignerTab);
      if (currentDesigner) {
        assignedToSelect.value = currentDesigner.name;
      }
    } else {
      // 縲悟・譯井ｻｶ縲阪ち繝悶・蝣ｴ蜷医∵怙蠕後↓菴ｿ逕ｨ縺励◆諡・ｽ楢・ｒ閾ｪ蜍暮∈謚・
      const lastAssignee = localStorage.getItem('archideck_last_assignee');
      if (lastAssignee && sekkeiDesigners.find(d => d.name === lastAssignee)) {
        assignedToSelect.value = lastAssignee;
      }
    }
  }

  // IC諡・ｽ楢・ｼ・C繧ｫ繝・ざ繝ｪ縺ｮ縺ｿ・峨ｒ蝓九ａ繧・
  log('肌 IC諡・ｽ楢・ｒ繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ荳ｭ...');
  const icDesigners = designers.filter(d => d.category === 'IC');
  log('笨・IC諡・ｽ楢・', icDesigners);

  const icAssigneeSelect = document.getElementById('projectIcAssignee');
  log('識 icAssigneeSelect隕∫ｴ:', icAssigneeSelect);

  if (icAssigneeSelect) {
    icAssigneeSelect.innerHTML = '<option value="">譛ｪ螳・/option>' +
      icDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    // 蛟､繧定ｨｭ螳夲ｼ・nnerHTML蠕後↓螳溯｡鯉ｼ・
    if (projectId && project) {
      // 邱ｨ髮・凾: 譌｢蟄倥・IC諡・ｽ楢・ｒ驕ｸ謚・
      icAssigneeSelect.value = project.ic_assignee || '';
    }
  }

  // 繝・Φ繝励Ξ繝ｼ繝医・繧ｿ繝ｳ縺ｮ陦ｨ遉ｺ蛻ｶ蠕｡・育ｷｨ髮・凾縺ｮ縺ｿ陦ｨ遉ｺ・・
  const templateButtons = document.getElementById('templateButtons');
  if (templateButtons) {
    templateButtons.style.display = projectId ? 'block' : 'none';
  }

  log('汐 繝｢繝ｼ繝繝ｫ繧定｡ｨ遉ｺ縺励∪縺・..');
  ModalManager.open(modal, '#projectCustomer');
  log('笨・openProjectModal() 螳御ｺ・);
}

function closeProjectModal() {
  ModalManager.close(document.getElementById('projectModal'));
  editingProjectId = null;
}

async function saveProject() {
  // 莠碁㍾繧ｯ繝ｪ繝・け髦ｲ豁｢
  if (SaveGuard.isLocked('saveProject')) {
    return;
  }

  const customer = document.getElementById('projectCustomer')?.value?.trim() || '';
  const assignedTo = document.getElementById('projectAssignedTo')?.value?.trim() || '';
  const icAssignee = document.getElementById('projectIcAssignee')?.value?.trim() || '';
  const specifications = document.getElementById('projectSpecifications')?.value || '';

  log('沈 saveProject髢句ｧ・', { customer, assignedTo, icAssignee, specifications });

  if (!customer || !assignedTo) {
    showToast('縺雁ｮ｢讒伜錐縺ｨ險ｭ險域球蠖薙・蠢・医〒縺・, 'error');
    return;
  }

  await SaveGuard.run('saveProject', async () => {
    showStatus('菫晏ｭ倅ｸｭ...', 'saving');

    // 險ｭ險域球蠖薙・ID繧貞叙蠕・
    const designer = designers.find(d => d.name.trim() === assignedTo);
    const designerId = designer ? designer.id : null;

    // IC諡・ｽ楢・・ID繧貞叙蠕暦ｼ育ｩｺ譁・ｭ怜・縺ｮ蝣ｴ蜷医・null・・
    const icDesigner = icAssignee ? designers.find(d => d.name.trim() === icAssignee) : null;
    const icDesignerId = icDesigner ? icDesigner.id : null;

    const blankProgress = {};
    tasksV2.forEach(task => {
      blankProgress[task.task_key] = { completed: false, date: '', state: '' };
    });

    if (editingProjectId) {
      const project = projects.find(p => p.id === editingProjectId);
      const { error } = await supabase
        .from('projects')
        .update({
          customer,
          assigned_to: assignedTo,
          designer_id: designerId,
          ic_assignee: icAssignee || null,
          ic_designer_id: icDesignerId,
          specifications,
          updated_at: new Date().toISOString()
        })
        .eq('id', editingProjectId);

      if (error) {
        showStatus('繧ｨ繝ｩ繝ｼ', 'error');
        showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
        return;
      }

      Object.assign(project, {
        customer,
        assigned_to: assignedTo,
        ic_assignee: icAssignee || null,
        ic_designer_id: icDesignerId,
        specifications,
        updated_at: new Date().toISOString()
      });
    } else {
      const newProject = {
        uid: 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        customer,
        assigned_to: assignedTo,
        designer_id: designerId,
        ic_assignee: icAssignee || null,
        ic_designer_id: icDesignerId,
        specifications,
        status: 'active',
        progress: blankProgress,
        created_by: currentUser?.id || null
      };

      const { data, error } = await supabase
        .from('projects')
        .insert([newProject])
        .select();

      if (error) {
        showStatus('繧ｨ繝ｩ繝ｼ', 'error');
        showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
        return;
      }

      log('笨・譁ｰ隕乗｡井ｻｶ菫晏ｭ俶・蜉・', data[0]);
      log('投 assigned_to:', data[0].assigned_to);
      log('投 ic_assignee:', data[0].ic_assignee);
      projects.unshift(data[0]);
    }

    log('売 renderDesignerTabs()縺ｨrenderProjects()繧貞ｮ溯｡後＠縺ｾ縺・);
    log('投 迴ｾ蝨ｨ縺ｮprojects謨ｰ:', projects.length);
    closeProjectModal();
    renderDesignerTabs();
    renderProjects();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast('譯井ｻｶ繧剃ｿ晏ｭ倥＠縺ｾ縺励◆', 'success');
  });
}

function editProject(projectId) {
  openProjectModal(projectId);
}

async function deleteProject(projectId) {
  if (!confirm('縺薙・譯井ｻｶ繧貞炎髯､縺励∪縺吶°・・)) return;

  await SaveGuard.run(`deleteProject_${projectId}`, async () => {
    showStatus('蜑企勁荳ｭ...', 'saving');
    const { error } = await supabase
      .from('projects')
      .delete()
      .eq('id', projectId);

    if (error) {
      showStatus('繧ｨ繝ｩ繝ｼ', 'error');
      showToast('蜑企勁縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
      return;
    }

    projects = projects.filter(p => p.id !== projectId);
    renderDesignerTabs();
    renderProjects();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast('譯井ｻｶ繧貞炎髯､縺励∪縺励◆', 'success');
  });
}

let archiveConfirmProjectId = null;

// 螳御ｺ・ｸ医∩遒ｺ隱阪Δ繝ｼ繝繝ｫ繧帝幕縺・
async function openArchiveConfirmModal(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // 譛ｪ螳御ｺ・ち繧ｹ繧ｯ縺後≠繧九°遒ｺ隱・
  const { data: incompleteTasks } = await supabase
    .from('project_tasks')
    .select('id')
    .eq('project_id', projectId)
    .eq('is_completed', false);

  if (incompleteTasks && incompleteTasks.length > 0) {
    showToast(`譛ｪ螳御ｺ・・繧ｿ繧ｹ繧ｯ縺・{incompleteTasks.length}莉ｶ縺ゅｊ縺ｾ縺吶ゅち繧ｹ繧ｯ繧貞ｮ御ｺ・＠縺ｦ縺九ｉ螳御ｺ・ｸ医∩縺ｫ縺励※縺上□縺輔＞縲Ａ, 'warning');
    return;
  }

  archiveConfirmProjectId = projectId;
  document.getElementById('archiveConfirmProjectName').textContent = project.customer;
  ModalManager.open(document.getElementById('archiveConfirmModal'));
}

function closeArchiveConfirmModal() {
  ModalManager.close(document.getElementById('archiveConfirmModal'));
  archiveConfirmProjectId = null;
}

// 螳御ｺ・ｸ医∩縺ｫ遘ｻ蜍輔ｒ螳溯｡・
async function executeArchive() {
  if (!archiveConfirmProjectId) return;

  const project = projects.find(p => p.id === archiveConfirmProjectId);
  if (!project) return;

  showStatus('譖ｴ譁ｰ荳ｭ...', 'saving');

  const updateData = {
    is_archived: true,
    archived_at: new Date().toISOString()
  };

  const { error } = await supabase
    .from('projects')
    .update(updateData)
    .eq('id', archiveConfirmProjectId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('譖ｴ譁ｰ縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    closeArchiveConfirmModal();
    return;
  }

  // 繝ｭ繝ｼ繧ｫ繝ｫ繝・・繧ｿ繧呈峩譁ｰ
  project.is_archived = true;
  project.archived_at = updateData.archived_at;

  closeArchiveConfirmModal();
  renderProjects();
  renderSidebar();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('譯井ｻｶ繧貞ｮ御ｺ・ｸ医∩縺ｫ縺励∪縺励◆', 'success');
}

async function toggleArchive(projectId, isArchived) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // 螳御ｺ・ｸ医∩縺ｫ縺吶ｋ蝣ｴ蜷医・繝｢繝ｼ繝繝ｫ縺ｧ遒ｺ隱・
  if (isArchived) {
    openArchiveConfirmModal(projectId);
    return;
  }

  // 蠕ｩ蜈・・蝣ｴ蜷医・蠕捺擂騾壹ｊconfirm縺ｧ遒ｺ隱・
  if (!confirm('譯井ｻｶ繧貞ｾｩ蜈・＠縺ｾ縺吶°・・)) return;

  showStatus('譖ｴ譁ｰ荳ｭ...', 'saving');

  const updateData = {
    is_archived: false,
    archived_at: null
  };

  const { error } = await supabase
    .from('projects')
    .update(updateData)
    .eq('id', projectId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('譖ｴ譁ｰ縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  // 繝ｭ繝ｼ繧ｫ繝ｫ繝・・繧ｿ繧呈峩譁ｰ
  project.is_archived = false;
  project.archived_at = null;
  markLocalUpdate(projectId); // 繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄縺ｮ莠碁㍾譖ｴ譁ｰ髦ｲ豁｢

  renderProjects();
  renderSidebar();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('譯井ｻｶ繧貞ｾｩ蜈・＠縺ｾ縺励◆', 'success');
}

// 螳御ｺ・ｸ医°繧牙ｾｩ蜈・ｼ医メ繧ｧ繝・け繝懊ャ繧ｯ繧ｹ隗｣髯､譎ゑｼ・
// 繝√ぉ繝・け繝懊ャ繧ｯ繧ｹ縺ｧ螳御ｺ・ｸ医∩縺ｫ縺吶ｋ
async function markAsCompleted(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // 遒ｺ隱阪ム繧､繧｢繝ｭ繧ｰ
  if (!confirm(`縲・{project.customer}縲阪ｒ螳御ｺ・ｸ医∩縺ｫ遘ｻ蜍輔＠縺ｾ縺吶°・歔)) {
    // 繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺溷ｴ蜷医√メ繧ｧ繝・け繝懊ャ繧ｯ繧ｹ繧貞・縺ｫ謌ｻ縺・
    renderProjects();
    return;
  }

  showStatus('譖ｴ譁ｰ荳ｭ...', 'saving');

  const { error } = await supabase
    .from('projects')
    .update({
      is_archived: true,
      archived_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    })
    .eq('id', projectId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('螳御ｺ・・逅・↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    renderProjects();
    return;
  }

  project.is_archived = true;
  project.archived_at = new Date().toISOString();

  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast(`縲・{project.customer}縲阪ｒ螳御ｺ・ｸ医∩縺ｫ遘ｻ蜍輔＠縺ｾ縺励◆`, 'success');
  renderProjects();
  renderSidebar();
}

async function restoreFromArchive(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  if (!confirm(`縲・{project.customer}縲阪ｒ諡・ｽ楢・ｼ・{project.assigned_to || '譛ｪ蜑ｲ蠖・}・峨↓謌ｻ縺励∪縺吶°・歔)) {
    // 繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺輔ｌ縺溷ｴ蜷医√メ繧ｧ繝・け繝懊ャ繧ｯ繧ｹ繧呈綾縺・
    renderProjects();
    return;
  }

  showStatus('蠕ｩ蜈・ｸｭ...', 'saving');

  const { error } = await supabase
    .from('projects')
    .update({
      is_archived: false,
      archived_at: null,
      updated_at: new Date().toISOString()
    })
    .eq('id', projectId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('蠕ｩ蜈・↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    renderProjects(); // 繝√ぉ繝・け繝懊ャ繧ｯ繧ｹ繧呈綾縺・
    return;
  }

  project.is_archived = false;
  project.archived_at = null;
  project.updated_at = new Date().toISOString();
  markLocalUpdate(projectId); // 繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄縺ｮ莠碁㍾譖ｴ譁ｰ髦ｲ豁｢

  // 諡・ｽ楢・・繧ｿ繝悶↓蛻・ｊ譖ｿ縺・
  if (project.assigned_to) {
    currentDesignerTab = project.assigned_to;
  } else {
    currentDesignerTab = 'ALL';
  }

  renderSidebar();
  renderProjects();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast(`${project.customer} 繧貞ｾｩ蜈・＠縺ｾ縺励◆`, 'success');
}

// ============================================
// 諡・ｽ鍋ｮ｡逅・ｩ溯・
// ============================================
function openDesignerModal() {
  renderDesignerList();
  ModalManager.open(document.getElementById('designerModal'));
}

function closeDesignerModal() {
  ModalManager.close(document.getElementById('designerModal'));
}

function renderDesignerList() {
  const container = document.getElementById('designerList');

  // 繧ｫ繝・ざ繝ｪ縺ｧ荳ｦ縺ｳ譖ｿ縺茨ｼ郁ｨｭ險遺・IC・・
  const sortedDesigners = [...designers].sort((a, b) => {
    if (a.category === '險ｭ險・ && b.category === 'IC') return -1;
    if (a.category === 'IC' && b.category === '險ｭ險・) return 1;
    return (a.display_order || 999) - (b.display_order || 999);
  });

  container.innerHTML = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">逋ｻ骭ｲ貂医∩諡・ｽ難ｼ・ + designers.length + '蜷搾ｼ・/h3>' +
    '<div class="table-container"><table class="table"><thead><tr><th>諡・ｽ灘錐</th><th>繧ｫ繝・ざ繝ｪ</th><th>諡・ｽ捺｡井ｻｶ謨ｰ</th><th>謫堺ｽ・/th></tr></thead><tbody>' +
    sortedDesigners.map(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name).length;
      const categoryLabel = designer.category === '險ｭ險・ ? '險ｭ險域球蠖・ : 'IC諡・ｽ・;
      return `
        <tr>
          <td><strong>${designer.name}</strong></td>
          <td><span class="badge ${designer.category === '險ｭ險・ ? 'badge-primary' : 'badge-success'}">${categoryLabel}</span></td>
          <td>${count}莉ｶ</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteDesigner('${designer.id}')">蜑企勁</button></td>
        </tr>
      `;
    }).join('') +
    '</tbody></table></div>';
}

async function addDesigner() {
  const name = document.getElementById('newDesignerName')?.value?.trim() || '';
  const category = document.getElementById('newDesignerCategory')?.value || '';

  if (!name) {
    showToast('諡・ｽ灘錐繧貞・蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('譌｢縺ｫ蟄伜惠縺吶ｋ諡・ｽ灘錐縺ｧ縺・, 'error');
    return;
  }

  showStatus('霑ｽ蜉荳ｭ...', 'saving');

  // 蜷後§繧ｫ繝・ざ繝ｪ縺ｮ譛螟ｧdisplay_order繧貞叙蠕励＠縺ｦ+1
  const sameCategoryDesigners = designers.filter(d => d.category === category);
  const maxDisplayOrder = sameCategoryDesigners.length > 0
    ? Math.max(...sameCategoryDesigners.map(d => d.display_order || 0))
    : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('designers')
    .insert([{ name, category, email: `${name.replace(/\s/g, '')}@temp.local`, created_by: currentUser?.id, display_order: newDisplayOrder }])
    .select();

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('霑ｽ蜉縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerName').value = '';
  renderDesignerList();
  renderDesignerTabs();
  renderSidebar();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('諡・ｽ薙ｒ霑ｽ蜉縺励∪縺励◆', 'success');
}

async function deleteDesigner(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('縺薙・諡・ｽ薙・譯井ｻｶ縺ｫ蜑ｲ蠖薙※繧峨ｌ縺ｦ縺・∪縺吶よ｡井ｻｶ縺ｮ諡・ｽ薙ｒ螟画峩縺励※縺九ｉ蜑企勁縺励※縺上□縺輔＞縲・, 'error');
    return;
  }

  if (!confirm(`${designer.name}繧貞炎髯､縺励∪縺吶°・歔)) return;

  await SaveGuard.run(`deleteDesigner_${designerId}`, async () => {
    showStatus('蜑企勁荳ｭ...', 'saving');
    const { error } = await supabase
      .from('designers')
      .delete()
      .eq('id', designerId);

    if (error) {
      showStatus('繧ｨ繝ｩ繝ｼ', 'error');
      showToast('蜑企勁縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
      return;
    }

    designers = designers.filter(d => d.id !== designerId);
    renderDesignerList();
    renderDesignerListInline();
    renderSidebar();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast('諡・ｽ薙ｒ蜑企勁縺励∪縺励◆', 'success');
  });
}

// 繧､繝ｳ繝ｩ繧､繝ｳ迚域球蠖鍋ｮ｡逅・未謨ｰ
function renderDesignerListInline() {
  const container = document.getElementById('designerListInline');
  if (!container) return;

  const sekkeiDesigners = [...designers].filter(d => d.category === '險ｭ險・).sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const icDesigners = [...designers].filter(d => d.category === 'IC').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const exteriorDesigners = [...designers].filter(d => d.category === '螟匁ｧ・).sort((a, b) => (a.display_order || 999) - (b.display_order || 999));

  let html = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">逋ｻ骭ｲ貂医∩諡・ｽ難ｼ・ + designers.length + '蜷搾ｼ・/h3>';
  html += '<p style="color: var(--text-secondary); margin-bottom: 16px;">庁 陦後ｒ繝峨Λ繝・げ&繝峨Ο繝・・縺励※陦ｨ遉ｺ鬆・ｺ上ｒ螟画峩縺ｧ縺阪∪縺・/p>';

  // 諡・ｽ楢｡後ｒ逕滓・縺吶ｋ繝倥Ν繝代・髢｢謨ｰ
  function renderDesignerRow(designer, category, countField) {
    const count = countField ? projects.filter(p => p[countField] === designer.name).length : '-';
    const emailDisplay = designer.email && !designer.email.includes('@temp.local') ? designer.email : '<span style="color: var(--text-muted);">譛ｪ險ｭ螳・/span>';
    const phoneDisplay = designer.phone ? designer.phone : '<span style="color: var(--text-muted);">譛ｪ險ｭ螳・/span>';
    const departmentDisplay = designer.department ? designer.department : '<span style="color: var(--text-muted);">譛ｪ險ｭ螳・/span>';
    const hasValidEmail = designer.email && !designer.email.includes('@temp.local');
    const needsInvite = hasValidEmail && !designer.auth_confirmed;
    return `
      <tr class="draggable-row" draggable="true" data-designer-id="${designer.id}" data-category="${category}">
        <td><span class="drag-handle">竕｡</span></td>
        <td><strong>${designer.name}</strong>${designer.auth_confirmed ? ' <span style="color: var(--success-color); font-size: 12px;">笨・/span>' : ''}</td>
        <td>${emailDisplay}</td>
        <td>${phoneDisplay}</td>
        <td>${departmentDisplay}</td>
        <td>${countField ? count + '莉ｶ' : '-'}</td>
        <td>
          ${needsInvite ? `<button class="btn btn-primary btn-small" onclick="resendInvite('${designer.id}')" style="margin-right: 4px;">透 諡帛ｾ・/button>` : ''}
          <button class="btn btn-ghost btn-small" onclick="openEditDesignerModal('${designer.id}')" style="margin-right: 4px;">笨擾ｸ・邱ｨ髮・/button>
          <button class="btn btn-danger btn-small" onclick="deleteDesignerInline('${designer.id}')">蜑企勁</button>
        </td>
      </tr>
    `;
  }

  // 險ｭ險域球蠖・
  if (sekkeiDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--primary-color);">盗 險ｭ險域球蠖・/h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>諡・ｽ灘錐</th><th>繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ</th><th>髮ｻ隧ｱ逡ｪ蜿ｷ</th><th>驛ｨ鄂ｲ</th><th>諡・ｽ捺｡井ｻｶ謨ｰ</th><th>謫堺ｽ・/th></tr></thead><tbody id="sekkeiTbody">';
    sekkeiDesigners.forEach(designer => {
      html += renderDesignerRow(designer, '險ｭ險・, 'assigned_to');
    });
    html += '</tbody></table></div>';
  }

  // IC諡・ｽ・
  if (icDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--success-color);">耳 IC諡・ｽ・/h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>諡・ｽ灘錐</th><th>繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ</th><th>髮ｻ隧ｱ逡ｪ蜿ｷ</th><th>驛ｨ鄂ｲ</th><th>諡・ｽ捺｡井ｻｶ謨ｰ</th><th>謫堺ｽ・/th></tr></thead><tbody id="icTbody">';
    icDesigners.forEach(designer => {
      html += renderDesignerRow(designer, 'IC', 'ic_assignee');
    });
    html += '</tbody></table></div>';
  }

  // 螟匁ｧ区球蠖・
  if (exteriorDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--secondary-color);">元 螟匁ｧ区球蠖・/h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>諡・ｽ灘錐</th><th>繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ</th><th>髮ｻ隧ｱ逡ｪ蜿ｷ</th><th>驛ｨ鄂ｲ</th><th>諡・ｽ捺｡井ｻｶ謨ｰ</th><th>謫堺ｽ・/th></tr></thead><tbody id="exteriorTbody">';
    exteriorDesigners.forEach(designer => {
      html += renderDesignerRow(designer, '螟匁ｧ・, 'exterior_assignee');
    });
    html += '</tbody></table></div>';
  }

  // 荳榊虚逕｣諡・ｽ・
  const realestateDesigners = [...designers].filter(d => d.category === '荳榊虚逕｣').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  if (realestateDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: #8B4513;">匠 荳榊虚逕｣諡・ｽ・/h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>諡・ｽ灘錐</th><th>繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ</th><th>髮ｻ隧ｱ逡ｪ蜿ｷ</th><th>驛ｨ鄂ｲ</th><th>諡・ｽ捺｡井ｻｶ謨ｰ</th><th>謫堺ｽ・/th></tr></thead><tbody id="realestateTbody">';
    realestateDesigners.forEach(designer => {
      html += renderDesignerRow(designer, '荳榊虚逕｣', 'realestate_assignee');
    });
    html += '</tbody></table></div>';
  }

  // 蟾･莠区球蠖・
  const constructionDesigners = [...designers].filter(d => d.category === '蟾･莠・).sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  if (constructionDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: #FF6B35;">畑 蟾･莠区球蠖・/h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>諡・ｽ灘錐</th><th>繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ</th><th>髮ｻ隧ｱ逡ｪ蜿ｷ</th><th>驛ｨ鄂ｲ</th><th>諡・ｽ捺｡井ｻｶ謨ｰ</th><th>謫堺ｽ・/th></tr></thead><tbody id="constructionTbody">';
    constructionDesigners.forEach(designer => {
      html += renderDesignerRow(designer, '蟾･莠・, 'construction_assignee');
    });
    html += '</tbody></table></div>';
  }

  // 蝟ｶ讌ｭ諡・ｽ・
  const salesDesigners = [...designers].filter(d => d.category === '蝟ｶ讌ｭ').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  if (salesDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: #2196F3;">直 蝟ｶ讌ｭ諡・ｽ・/h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>諡・ｽ灘錐</th><th>繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ</th><th>髮ｻ隧ｱ逡ｪ蜿ｷ</th><th>驛ｨ鄂ｲ</th><th>諡・ｽ捺｡井ｻｶ謨ｰ</th><th>謫堺ｽ・/th></tr></thead><tbody id="salesTbody">';
    salesDesigners.forEach(designer => {
      html += renderDesignerRow(designer, '蝟ｶ讌ｭ', 'sales_assignee');
    });
    html += '</tbody></table></div>';
  }

  // 邂｡逅・・
  const adminDesigners = [...designers].filter(d => d.category === '邂｡逅・・).sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  if (adminDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: #9C27B0;">荘 邂｡逅・・/h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>諡・ｽ灘錐</th><th>繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ</th><th>髮ｻ隧ｱ逡ｪ蜿ｷ</th><th>驛ｨ鄂ｲ</th><th>諡・ｽ捺｡井ｻｶ謨ｰ</th><th>謫堺ｽ・/th></tr></thead><tbody id="adminTbody">';
    adminDesigners.forEach(designer => {
      html += renderDesignerRow(designer, '邂｡逅・・, null);
    });
    html += '</tbody></table></div>';
  }

  container.innerHTML = html;

  // 繝峨Λ繝・げ&繝峨Ο繝・・繧､繝吶Φ繝郁ｨｭ螳・
  setupDragAndDrop();
}

// 諡・ｽ鍋ｷｨ髮・Δ繝ｼ繝繝ｫ
function openEditDesignerModal(designerId) {
  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.id = 'editDesignerModal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">諡・ｽ鍋ｷｨ髮・/h2>
        <button class="close" onclick="closeEditDesignerModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editDesignerId" value="${designer.id}">
        <div class="form-group">
          <label class="form-label">諡・ｽ灘錐 *</label>
          <input type="text" class="form-input" id="editDesignerName" value="${designer.name}" style="width: 100%;">
        </div>
        <div class="form-group">
          <label class="form-label">繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ</label>
          <input type="email" class="form-input" id="editDesignerEmail" value="${designer.email && !designer.email.includes('@temp.local') ? designer.email : ''}" placeholder="萓・ staff@example.com" style="width: 100%;">
        </div>
        <div class="form-group">
          <label class="form-label">謳ｺ蟶ｯ髮ｻ隧ｱ逡ｪ蜿ｷ・・1譯√・繝上う繝輔Φ縺ｪ縺暦ｼ・/label>
          <input type="tel" class="form-input" id="editDesignerPhone" value="${designer.phone || ''}" placeholder="萓・ 09012345678" maxlength="11" pattern="[0-9]{11}" style="width: 100%;">
        </div>
        <div class="form-group">
          <label class="form-label">驛ｨ鄂ｲ</label>
          <select class="form-input" id="editDesignerDepartment" style="width: 100%;">
            <option value="">驛ｨ鄂ｲ繧帝∈謚・/option>
            ${departmentMaster.map(dept => `<option value="${escapeHtml(dept)}" ${designer.department === dept ? 'selected' : ''}>${escapeHtml(dept)}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">繧ｫ繝・ざ繝ｪ</label>
          <select class="form-input" id="editDesignerCategory" style="width: 100%;">
            <option value="險ｭ險・ ${designer.category === '險ｭ險・ ? 'selected' : ''}>險ｭ險域球蠖・/option>
            <option value="IC" ${designer.category === 'IC' ? 'selected' : ''}>IC諡・ｽ・/option>
            <option value="螟匁ｧ・ ${designer.category === '螟匁ｧ・ ? 'selected' : ''}>螟匁ｧ区球蠖・/option>
            <option value="荳榊虚逕｣" ${designer.category === '荳榊虚逕｣' ? 'selected' : ''}>荳榊虚逕｣諡・ｽ・/option>
            <option value="蟾･莠・ ${designer.category === '蟾･莠・ ? 'selected' : ''}>蟾･莠区球蠖・/option>
            <option value="蝟ｶ讌ｭ" ${designer.category === '蝟ｶ讌ｭ' ? 'selected' : ''}>蝟ｶ讌ｭ諡・ｽ・/option>
            <option value="邂｡逅・・ ${designer.category === '邂｡逅・・ ? 'selected' : ''}>邂｡逅・・/option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeEditDesignerModal()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
        <button class="btn btn-primary" onclick="saveEditDesigner()">菫晏ｭ・/button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function closeEditDesignerModal() {
  const modal = document.getElementById('editDesignerModal');
  if (modal) modal.remove();
}

async function saveEditDesigner() {
  const designerId = document.getElementById('editDesignerId').value;
  const name = document.getElementById('editDesignerName').value.trim();
  const email = document.getElementById('editDesignerEmail').value.trim();
  const phone = document.getElementById('editDesignerPhone').value.trim();
  const department = document.getElementById('editDesignerDepartment').value;
  const category = document.getElementById('editDesignerCategory').value;

  if (!name) {
    showToast('諡・ｽ灘錐繧貞・蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  // 髮ｻ隧ｱ逡ｪ蜿ｷ蠖｢蠑上メ繧ｧ繝・け・・1譯√・謨ｰ蟄励・縺ｿ・・
  if (phone && !/^[0-9]{11}$/.test(phone)) {
    showToast('謳ｺ蟶ｯ髮ｻ隧ｱ逡ｪ蜿ｷ縺ｯ11譯√・謨ｰ蟄励〒蜈･蜉帙＠縺ｦ縺上□縺輔＞・医ワ繧､繝輔Φ縺ｪ縺暦ｼ・, 'error');
    return;
  }

  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  // 蜷榊燕縺悟､画峩縺輔ｌ縺溷ｴ蜷医・㍾隍・メ繧ｧ繝・け
  if (name !== designer.name && designers.find(d => d.name === name && d.id !== designerId)) {
    showToast('譌｢縺ｫ蟄伜惠縺吶ｋ諡・ｽ灘錐縺ｧ縺・, 'error');
    return;
  }

  showStatus('菫晏ｭ倅ｸｭ...', 'saving');

  const oldName = designer.name;
  const updateData = {
    name,
    category,
    email: email || `${name.replace(/\s/g, '')}@temp.local`,
    phone: phone || null,
    department: department || null
  };

  const { error } = await supabase
    .from('designers')
    .update(updateData)
    .eq('id', designerId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  // 蜷榊燕縺悟､峨ｏ縺｣縺溷ｴ蜷医・未騾｣縺吶ｋ譯井ｻｶ縺ｮ諡・ｽ楢・錐繧よ峩譁ｰ
  if (oldName !== name) {
    const fieldsToUpdate = {
      '險ｭ險・: 'assigned_to',
      'IC': 'ic_assignee',
      '螟匁ｧ・: 'exterior_assignee'
    };
    const field = fieldsToUpdate[designer.category];
    if (field) {
      const relatedProjects = projects.filter(p => p[field] === oldName);
      for (const project of relatedProjects) {
        await supabase.from('projects').update({ [field]: name }).eq('id', project.id);
        project[field] = name;
      }
    }
  }

  // 繝ｭ繝ｼ繧ｫ繝ｫ繝・・繧ｿ繧呈峩譁ｰ
  Object.assign(designer, updateData);

  closeEditDesignerModal();
  renderDesignerListInline();
  renderDesignerTabs();
  renderSidebar();
  renderProjects();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('諡・ｽ捺ュ蝣ｱ繧呈峩譁ｰ縺励∪縺励◆', 'success');
}

async function addDesignerInline() {
  const name = document.getElementById('newDesignerNameInline').value.trim();
  const email = document.getElementById('newDesignerEmailInline').value.trim();
  const phone = document.getElementById('newDesignerPhoneInline').value.trim();
  const department = document.getElementById('newDesignerDepartmentInline').value;
  const category = document.getElementById('newDesignerCategoryInline').value;

  if (!name) {
    showToast('諡・ｽ灘錐繧貞・蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (!email) {
    showToast('繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ繧貞・蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  // 繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ蠖｢蠑上メ繧ｧ繝・け
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showToast('譛牙柑縺ｪ繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ繧貞・蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  // 髮ｻ隧ｱ逡ｪ蜿ｷ蠖｢蠑上メ繧ｧ繝・け・・1譯√・謨ｰ蟄励・縺ｿ・・
  if (phone && !/^[0-9]{11}$/.test(phone)) {
    showToast('謳ｺ蟶ｯ髮ｻ隧ｱ逡ｪ蜿ｷ縺ｯ11譯√・謨ｰ蟄励〒蜈･蜉帙＠縺ｦ縺上□縺輔＞・医ワ繧､繝輔Φ縺ｪ縺暦ｼ・, 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('譌｢縺ｫ蟄伜惠縺吶ｋ諡・ｽ灘錐縺ｧ縺・, 'error');
    return;
  }

  if (designers.find(d => d.email === email)) {
    showToast('縺薙・繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ縺ｯ譌｢縺ｫ菴ｿ逕ｨ縺輔ｌ縺ｦ縺・∪縺・, 'error');
    return;
  }

  showStatus('霑ｽ蜉荳ｭ...', 'saving');

  try {
    // 蜷後§繧ｫ繝・ざ繝ｪ縺ｮ譛螟ｧdisplay_order繧貞叙蠕励＠縺ｦ+1
    const sameCategoryDesigners = designers.filter(d => d.category === category);
    const maxDisplayOrder = sameCategoryDesigners.length > 0
      ? Math.max(...sameCategoryDesigners.map(d => d.display_order || 0))
      : 0;
    const newDisplayOrder = maxDisplayOrder + 1;

    // 1. designers繝・・繝悶Ν縺ｫ繝ｬ繧ｳ繝ｼ繝芽ｿｽ蜉
    const { data, error } = await supabase
      .from('designers')
      .insert([{ name, category, email, phone: phone || null, department: department || null, created_by: currentUser?.id, display_order: newDisplayOrder }])
      .select();

    if (error) {
      throw new Error('諡・ｽ捺ュ蝣ｱ縺ｮ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message);
    }

    const newDesigner = data[0];

    // 2. Supabase Auth縺ｫ繝ｦ繝ｼ繧ｶ繝ｼ繧剃ｽ懈・・井ｸ譎ゅヱ繧ｹ繝ｯ繝ｼ繝会ｼ・
    const tempPassword = crypto.randomUUID().slice(0, 16) + 'Aa1!'; // 荳譎ゅヱ繧ｹ繝ｯ繝ｼ繝・
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email: email,
      password: tempPassword,
      options: {
        data: {
          name: name,
          designer_id: newDesigner.id
        },
        emailRedirectTo: window.location.origin
      }
    });

    if (authError) {
      console.warn('Supabase Auth逋ｻ骭ｲ繧ｨ繝ｩ繝ｼ:', authError);
      // Auth繧ｨ繝ｩ繝ｼ縺ｧ繧Ｅesigners繝・・繝悶Ν縺ｸ縺ｮ霑ｽ蜉縺ｯ謌仙粥縺励※縺・ｋ縺ｮ縺ｧ邯夊｡・
    }

    // 3. 繝代せ繝ｯ繝ｼ繝芽ｨｭ螳壹Γ繝ｼ繝ｫ繧帝∽ｿ｡
    const { error: resetError } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.origin
    });

    if (resetError) {
      console.warn('繝代せ繝ｯ繝ｼ繝峨Μ繧ｻ繝・ヨ繝｡繝ｼ繝ｫ騾∽ｿ｡繧ｨ繝ｩ繝ｼ:', resetError);
    }

    designers.push(newDesigner);
    document.getElementById('newDesignerNameInline').value = '';
    document.getElementById('newDesignerEmailInline').value = '';
    document.getElementById('newDesignerPhoneInline').value = '';
    document.getElementById('newDesignerDepartmentInline').value = '';
    renderDesignerListInline();
    renderSidebar();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast(`諡・ｽ薙ｒ霑ｽ蜉縺励∪縺励◆縲・{email} 縺ｫ繝代せ繝ｯ繝ｼ繝芽ｨｭ螳壹Γ繝ｼ繝ｫ繧帝∽ｿ｡縺励∪縺励◆縲Ａ, 'success');

  } catch (err) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast(err.message, 'error');
  }
}

// 譌｢蟄俶球蠖楢・↓諡帛ｾ・Γ繝ｼ繝ｫ繧貞・騾∽ｿ｡
async function resendInvite(designerId) {
  const designer = designers.find(d => d.id === designerId);
  if (!designer || !designer.email) {
    showToast('繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ', 'error');
    return;
  }

  if (!confirm(`${designer.name}・・{designer.email}・峨↓諡帛ｾ・Γ繝ｼ繝ｫ繧帝∽ｿ｡縺励∪縺吶°・歃n\n繝｡繝ｼ繝ｫ蜀・・繝ｪ繝ｳ繧ｯ縺九ｉ繝代せ繝ｯ繝ｼ繝峨ｒ險ｭ螳壹〒縺阪∪縺吶Ａ)) {
    return;
  }

  showStatus('騾∽ｿ｡荳ｭ...', 'saving');

  try {
    // 1. 縺ｾ縺售upabase Auth縺ｫ繝ｦ繝ｼ繧ｶ繝ｼ繧剃ｽ懈・繧定ｩｦ縺ｿ繧具ｼ域里縺ｫ蟄伜惠縺吶ｋ蝣ｴ蜷医・繧ｨ繝ｩ繝ｼ縺ｫ縺ｪ繧具ｼ・
    const tempPassword = crypto.randomUUID().slice(0, 16) + 'Aa1!';
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email: designer.email,
      password: tempPassword,
      options: {
        data: {
          name: designer.name,
          designer_id: designer.id
        },
        emailRedirectTo: window.location.origin
      }
    });

    if (authError && !authError.message.includes('already registered')) {
      console.warn('Auth逋ｻ骭ｲ:', authError.message);
    }

    // 2. 繝代せ繝ｯ繝ｼ繝芽ｨｭ螳壹Γ繝ｼ繝ｫ繧帝∽ｿ｡
    const { error: resetError } = await supabase.auth.resetPasswordForEmail(designer.email, {
      redirectTo: window.location.origin
    });

    if (resetError) {
      throw new Error('繝｡繝ｼ繝ｫ騾∽ｿ｡縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + resetError.message);
    }

    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast(`${designer.email} 縺ｫ諡帛ｾ・Γ繝ｼ繝ｫ繧帝∽ｿ｡縺励∪縺励◆`, 'success');

  } catch (err) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast(err.message, 'error');
  }
}

async function deleteDesignerInline(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('縺薙・諡・ｽ薙・譯井ｻｶ縺ｫ蜑ｲ蠖薙※繧峨ｌ縺ｦ縺・∪縺吶よ｡井ｻｶ縺ｮ諡・ｽ薙ｒ螟画峩縺励※縺九ｉ蜑企勁縺励※縺上□縺輔＞縲・, 'error');
    return;
  }

  if (!confirm(`${designer.name}繧貞炎髯､縺励∪縺吶°・歔)) return;

  showStatus('蜑企勁荳ｭ...', 'saving');
  const { error } = await supabase
    .from('designers')
    .delete()
    .eq('id', designerId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('蜑企勁縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  designers = designers.filter(d => d.id !== designerId);
  renderDesignerListInline();
  renderSidebar();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('諡・ｽ薙ｒ蜑企勁縺励∪縺励◆', 'success');
}

// ============================================
// 諡・ｽ楢ｪ崎ｨｼ險ｭ螳・
// ============================================
function openDesignerAuthModal(designerId) {
  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  document.getElementById('authDesignerId').value = designer.id;
  document.getElementById('authDesignerName').value = designer.name;
  document.getElementById('authDesignerEmail').value = designer.email && !designer.email.includes('@temp.local') ? designer.email : '';
  document.getElementById('authDesignerPassword').value = '';
  document.getElementById('authDesignerPasswordConfirm').value = '';

  ModalManager.open(document.getElementById('designerAuthModal'), '#authDesignerEmail');
}

function closeDesignerAuthModal() {
  ModalManager.close(document.getElementById('designerAuthModal'));
}

async function saveDesignerAuth() {
  const designerId = document.getElementById('authDesignerId').value;
  const email = document.getElementById('authDesignerEmail').value.trim();
  const password = document.getElementById('authDesignerPassword').value;
  const passwordConfirm = document.getElementById('authDesignerPasswordConfirm').value;

  // 繝舌Μ繝・・繧ｷ繝ｧ繝ｳ
  if (!email) {
    showToast('繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ繧貞・蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (!password) {
    showToast('繝代せ繝ｯ繝ｼ繝峨ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (password.length < 8) {
    showToast('繝代せ繝ｯ繝ｼ繝峨・8譁・ｭ嶺ｻ･荳翫〒險ｭ螳壹＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (password !== passwordConfirm) {
    showToast('繝代せ繝ｯ繝ｼ繝峨′荳閾ｴ縺励∪縺帙ｓ', 'error');
    return;
  }

  showStatus('菫晏ｭ倅ｸｭ...', 'saving');

  try {
    const designer = designers.find(d => d.id === designerId);
    const oldEmail = designer.email;

    log('柏 繝ｦ繝ｼ繧ｶ繝ｼ繧｢繧ｫ繧ｦ繝ｳ繝井ｽ懈・髢句ｧ・', { email, designerId });

    // 1. Supabase Auth縺ｫ繝ｦ繝ｼ繧ｶ繝ｼ繧剃ｽ懈・
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email: email,
      password: password,
      options: {
        data: {
          name: designer.name,
          designer_id: designerId
        },
        emailRedirectTo: window.location.origin
      }
    });

    log('柏 signUp邨先棡:', { authData, authError });

    if (authError) {
      // 繝ｦ繝ｼ繧ｶ繝ｼ縺梧里縺ｫ蟄伜惠縺吶ｋ蝣ｴ蜷医・縲√ヱ繧ｹ繝ｯ繝ｼ繝峨□縺代ｒ譖ｴ譁ｰ縺ｧ縺阪↑縺・・縺ｧ隴ｦ蜻・
      if (authError.message.includes('already registered')) {
        showToast('笞・・縺薙・繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ縺ｯ譌｢縺ｫ逋ｻ骭ｲ縺輔ｌ縺ｦ縺・∪縺吶ゅヱ繧ｹ繝ｯ繝ｼ繝峨・螟画峩縺悟ｿ・ｦ√↑蝣ｴ蜷医・縲√Ο繧ｰ繧､繝ｳ逕ｻ髱｢縺ｮ縲後ヱ繧ｹ繝ｯ繝ｼ繝峨ｒ蠢倥ｌ縺溘阪°繧牙､画峩縺励※縺上□縺輔＞縲・, 'error');
      } else {
        throw authError;
      }
    } else {
      log('笨・Supabase Auth縺ｫ繝ｦ繝ｼ繧ｶ繝ｼ菴懈・螳御ｺ・', authData.user?.id);
    }

    // 2. designers繝・・繝悶Ν縺ｮemail繧呈峩譁ｰ
    const { error: updateError } = await supabase
      .from('designers')
      .update({ email: email })
      .eq('id', designerId);

    if (updateError) {
      logError('笶・designers譖ｴ譁ｰ繧ｨ繝ｩ繝ｼ:', updateError);
      showStatus('繧ｨ繝ｩ繝ｼ', 'error');
      showToast('繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ縺ｮ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + updateError.message, 'error');
      return;
    }

    log('笨・designers繝・・繝悶Ν譖ｴ譁ｰ螳御ｺ・);

    // 3. 繝・じ繧､繝翫・驟榊・繧呈峩譁ｰ
    const designerIndex = designers.findIndex(d => d.id === designerId);
    if (designerIndex !== -1) {
      designers[designerIndex].email = email;
    }

    closeDesignerAuthModal();
    renderDesignerListInline();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');

    if (authError && authError.message.includes('already registered')) {
      showToast('繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ繧剃ｿ晏ｭ倥＠縺ｾ縺励◆・医い繧ｫ繧ｦ繝ｳ繝医・譌｢縺ｫ蟄伜惠縺励∪縺呻ｼ・, 'success');
    } else {
      showToast('笨・繝ｭ繧ｰ繧､繝ｳ繧｢繧ｫ繧ｦ繝ｳ繝医ｒ菴懈・縺励∪縺励◆・√％縺ｮ繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ縺ｨ繝代せ繝ｯ繝ｼ繝峨〒繝ｭ繧ｰ繧､繝ｳ縺ｧ縺阪∪縺吶・, 'success', 5000);
    }

  } catch (error) {
    logError('笶・隱崎ｨｼ險ｭ螳壹お繝ｩ繝ｼ:', error);
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('隱崎ｨｼ險ｭ螳壹↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
  }
}

// 繝峨Λ繝・げ&繝峨Ο繝・・蜃ｦ逅・
let draggedElement = null;

function setupDragAndDrop() {
  const draggableRows = document.querySelectorAll('.draggable-row');

  draggableRows.forEach(row => {
    row.addEventListener('dragstart', handleDesignerDragStart);
    row.addEventListener('dragover', handleDesignerDragOver);
    row.addEventListener('drop', handleDesignerDrop);
    row.addEventListener('dragend', handleDesignerDragEnd);
    row.addEventListener('dragleave', handleDesignerDragLeave);
  });
}

function handleDesignerDragStart(e) {
  draggedElement = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDesignerDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }

  // 蜷後§繧ｫ繝・ざ繝ｪ蜀・〒縺ｮ縺ｿ繝峨Ο繝・・蜿ｯ閭ｽ
  const draggedCategory = draggedElement.dataset.category;
  const targetCategory = this.dataset.category;

  if (draggedCategory === targetCategory && this !== draggedElement) {
    this.classList.add('drag-over');
  }

  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDesignerDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }

  const draggedCategory = draggedElement.dataset.category;
  const targetCategory = this.dataset.category;

  // 蜷後§繧ｫ繝・ざ繝ｪ蜀・〒縺ｮ縺ｿ繝峨Ο繝・・螳溯｡・
  if (draggedCategory === targetCategory && draggedElement !== this) {
    const draggedId = draggedElement.dataset.designerId;
    const targetId = this.dataset.designerId;

    // 鬆・ｺ上ｒ蜈･繧梧崛縺・
    updateDesignerOrder(draggedId, targetId, draggedCategory);
  }

  this.classList.remove('drag-over');
  return false;
}

function handleDesignerDragEnd(e) {
  this.classList.remove('dragging');

  const allRows = document.querySelectorAll('.draggable-row');
  allRows.forEach(row => {
    row.classList.remove('drag-over');
  });
}

function handleDesignerDragLeave(e) {
  this.classList.remove('drag-over');
}

async function updateDesignerOrder(draggedId, targetId, category) {
  showStatus('荳ｦ縺ｳ譖ｿ縺井ｸｭ...', 'saving');

  // 隧ｲ蠖薙き繝・ざ繝ｪ縺ｮ諡・ｽ薙ｒ蜿門ｾ・
  const categoryDesigners = designers.filter(d => d.category === category);

  // 繝峨Λ繝・げ縺輔ｌ縺滓球蠖薙→繧ｿ繝ｼ繧ｲ繝・ヨ諡・ｽ薙ｒ隕九▽縺代ｋ
  const draggedIndex = categoryDesigners.findIndex(d => d.id === draggedId);
  const targetIndex = categoryDesigners.findIndex(d => d.id === targetId);

  // 驟榊・繧剃ｸｦ縺ｳ譖ｿ縺・
  const [draggedDesigner] = categoryDesigners.splice(draggedIndex, 1);
  categoryDesigners.splice(targetIndex, 0, draggedDesigner);

  // display_order繧貞・險育ｮ・
  const updates = [];
  for (let i = 0; i < categoryDesigners.length; i++) {
    const designer = categoryDesigners[i];
    const newOrder = i + 1;

    if (designer.display_order !== newOrder) {
      updates.push({
        id: designer.id,
        display_order: newOrder
      });

      // 繝ｭ繝ｼ繧ｫ繝ｫ繝・・繧ｿ繧よ峩譁ｰ
      const localDesigner = designers.find(d => d.id === designer.id);
      if (localDesigner) {
        localDesigner.display_order = newOrder;
      }
    }
  }

  // Supabase縺ｫ荳諡ｬ譖ｴ譁ｰ
  for (const update of updates) {
    const { error } = await supabase
      .from('designers')
      .update({ display_order: update.display_order })
      .eq('id', update.id);

    if (error) {
      logError('荳ｦ縺ｳ譖ｿ縺医お繝ｩ繝ｼ:', error);
      showStatus('繧ｨ繝ｩ繝ｼ', 'error');
      showToast('荳ｦ縺ｳ譖ｿ縺医↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
      return;
    }
  }

  // UI譖ｴ譁ｰ
  renderDesignerListInline();
  renderSidebar();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('荳ｦ縺ｳ譖ｿ縺医ｒ菫晏ｭ倥＠縺ｾ縺励◆', 'success');
}

// 繧､繝ｳ繝ｩ繧､繝ｳ迚医き繝・ざ繝ｪ霑ｽ蜉
async function addCategoryInline() {
  const name = document.getElementById('newCategoryNameInline').value.trim();

  if (!name) {
    showToast('繧ｫ繝・ざ繝ｪ蜷阪ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  if (vendorCategories.find(c => c.name === name)) {
    showToast('譌｢縺ｫ蟄伜惠縺吶ｋ繧ｫ繝・ざ繝ｪ蜷阪〒縺・, 'error');
    return;
  }

  showStatus('霑ｽ蜉荳ｭ...', 'saving');
  const { data, error } = await supabase
    .from('vendor_categories')
    .insert([{ name, display_order: vendorCategories.length + 1 }])
    .select();

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('霑ｽ蜉縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  vendorCategories.push(data[0]);
  document.getElementById('newCategoryNameInline').value = '';
  renderCategoriesList();
  renderCategoryFilters();
  populateVendorCategoryDropdown();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('繧ｫ繝・ざ繝ｪ繧定ｿｽ蜉縺励∪縺励◆', 'success');
}

// ============================================
// 繝｡繝ｼ繝ｫ繝・Φ繝励Ξ繝ｼ繝育ｮ｡逅・
// ============================================
function renderTemplates() {
  const container = document.getElementById('templatesTable');
  if (!container) return; // 隕∫ｴ縺悟ｭ伜惠縺励↑縺・ｴ蜷医・菴輔ｂ縺励↑縺・

  const categoryFilterEl = document.getElementById('categoryFilter');
  const categoryFilter = categoryFilterEl ? categoryFilterEl.value : null;

  let filtered = emailTemplates;

  // currentUserCategory縺ｫ蠢懊§縺ｦ繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ・育ｮ｡逅・・ｻ･螟厄ｼ・
  if (currentUserCategory && currentUserCategory !== 'admin') {
    filtered = emailTemplates.filter(t => t.category === currentUserCategory);
  }

  // 縺輔ｉ縺ｫ繧ｫ繝・ざ繝ｪ繝輔ぅ繝ｫ繧ｿ繧帝←逕ｨ
  if (categoryFilter) {
    filtered = filtered.filter(t => t.category === categoryFilter);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">透</div><div class="empty-title">繝・Φ繝励Ξ繝ｼ繝医′縺ゅｊ縺ｾ縺帙ｓ</div><div class="empty-description">繝｡繝ｼ繝ｫ繝・Φ繝励Ξ繝ｼ繝医ｒ霑ｽ蜉縺励※縲∵｡井ｻｶ縺九ｉ繝ｯ繝ｳ繧ｯ繝ｪ繝・け縺ｧ繝｡繝ｼ繝ｫ繧剃ｽ懈・縺ｧ縺阪∪縺・/div><button class="btn btn-primary" onclick="openTemplateModal()">+ 繝・Φ繝励Ξ繝ｼ繝郁ｿｽ蜉</button></div>';
    return;
  }

  container.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>陦ｨ遉ｺ蜷・/th>
          <th>繧ｫ繝・ざ繝ｪ</th>
          <th>莨夂､ｾ蜷・/th>
          <th>繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ</th>
          <th>謫堺ｽ・/th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(template => `
          <tr>
            <td><strong>${template.display_name}</strong></td>
            <td><span class="badge ${template.category === 'IC' ? 'badge-success' : 'badge-primary'}">${template.category}</span></td>
            <td>${template.company}</td>
            <td>${template.email || '窶・}</td>
            <td>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-ghost btn-small" onclick="editTemplate('${template.id}')">邱ｨ髮・/button>
                <button class="btn btn-danger btn-small" onclick="deleteTemplate('${template.id}')">蜑企勁</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function openTemplateModal(templateId = null) {
  editingTemplateId = templateId;
  const modal = document.getElementById('templateModal');
  const title = document.getElementById('templateModalTitle');

  if (templateId) {
    const template = emailTemplates.find(t => t.id === templateId);
    title.textContent = '繝・Φ繝励Ξ繝ｼ繝育ｷｨ髮・;
    document.getElementById('templateId').value = template.template_id;
    document.getElementById('templateId').disabled = true;
    document.getElementById('templateDisplayName').value = template.display_name;
    document.getElementById('templateCategory').value = template.category;
    document.getElementById('templateCompany').value = template.company;
    document.getElementById('templateContact').value = template.contact || '';
    document.getElementById('templateEmail').value = template.email || '';
    document.getElementById('templateSubjectFormat').value = template.subject_format || '';
    document.getElementById('templateText').value = template.template_text || '';
  } else {
    title.textContent = '繝・Φ繝励Ξ繝ｼ繝郁ｿｽ蜉';
    document.getElementById('templateId').value = '';
    document.getElementById('templateId').disabled = false;
    document.getElementById('templateDisplayName').value = '';
    document.getElementById('templateCategory').value = '險ｭ險・;
    document.getElementById('templateCompany').value = '';
    document.getElementById('templateContact').value = '';
    document.getElementById('templateEmail').value = '';
    document.getElementById('templateSubjectFormat').value = '';
    document.getElementById('templateText').value = '';
  }

  ModalManager.open(modal, '#templateId');
}

function closeTemplateModal() {
  ModalManager.close(document.getElementById('templateModal'));
  editingTemplateId = null;
}

async function saveTemplate() {
  if (SaveGuard.isLocked('saveTemplate')) return;

  const templateId = document.getElementById('templateId').value.trim();
  const displayName = document.getElementById('templateDisplayName').value.trim();
  const category = document.getElementById('templateCategory').value;
  const company = document.getElementById('templateCompany').value.trim();
  const contact = document.getElementById('templateContact').value.trim();
  const email = document.getElementById('templateEmail').value.trim();
  const subjectFormat = document.getElementById('templateSubjectFormat').value.trim();
  const templateText = document.getElementById('templateText').value.trim();

  if (!templateId || !displayName || !company || !subjectFormat || !templateText) {
    showToast('蠢・磯・岼繧貞・蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  await SaveGuard.run('saveTemplate', async () => {
    showStatus('菫晏ｭ倅ｸｭ...', 'saving');

    const templateData = {
      template_id: templateId,
      display_name: displayName,
      category,
      company,
      contact,
      email,
      subject_format: subjectFormat,
      template_text: templateText,
      has_special_content: false,
      has_sub_options: false,
      created_by: currentUser.id
    };

    if (editingTemplateId) {
      const { error } = await supabase
        .from('email_templates')
        .update(templateData)
        .eq('id', editingTemplateId);

      if (error) {
        showStatus('繧ｨ繝ｩ繝ｼ', 'error');
        showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
        return;
      }

      const template = emailTemplates.find(t => t.id === editingTemplateId);
      Object.assign(template, templateData);
    } else {
      const { data, error } = await supabase
        .from('email_templates')
        .insert([templateData])
        .select();

      if (error) {
        showStatus('繧ｨ繝ｩ繝ｼ', 'error');
        showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
        return;
      }

      emailTemplates.push(data[0]);
    }

    closeTemplateModal();
    renderTemplates();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast('繝・Φ繝励Ξ繝ｼ繝医ｒ菫晏ｭ倥＠縺ｾ縺励◆', 'success');
  });
}

function editTemplate(templateId) {
  openTemplateModal(templateId);
}

async function deleteTemplate(templateId) {
  if (!confirm('縺薙・繝・Φ繝励Ξ繝ｼ繝医ｒ蜑企勁縺励∪縺吶°・・)) return;

  showStatus('蜑企勁荳ｭ...', 'saving');
  const { error } = await supabase
    .from('email_templates')
    .delete()
    .eq('id', templateId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('蜑企勁縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  emailTemplates = emailTemplates.filter(t => t.id !== templateId);
  renderTemplates();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('繝・Φ繝励Ξ繝ｼ繝医ｒ蜑企勁縺励∪縺励◆', 'success');
}

// ============================================
// 繧ｿ繧ｹ繧ｯ縺九ｉ縺ｮ繝｡繝ｼ繝ｫ菴懈・讖溯・・医Δ繝ｼ繝繝ｫ遒ｺ隱榊ｾ後↓Gmail髢九￥・・
// ============================================
async function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) {
    showToast('譯井ｻｶ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ', 'error');
    return;
  }

  // 繧ｿ繧ｹ繧ｯ螳夂ｾｩ繧貞叙蠕・
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  if (!taskDef) {
    showToast('繧ｿ繧ｹ繧ｯ螳夂ｾｩ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ', 'error');
    return;
  }

  // 繧ｿ繧ｹ繧ｯ縺ｫ邏舌▼縺・◆讌ｭ閠・ｒ蜿門ｾ・
  const mappings = taskVendorMappings.filter(m => m.task_id === taskDef.id);
  if (mappings.length === 0) {
    showToast('縺薙・繧ｿ繧ｹ繧ｯ縺ｫ讌ｭ閠・′邏舌▼縺代ｉ繧後※縺・∪縺帙ｓ', 'error');
    return;
  }

  // 讌ｭ閠・ュ蝣ｱ繧貞叙蠕・
  let taskVendors = mappings
    .map(m => vendorsV2.find(v => v.id === m.vendor_id))
    .filter(v => v != null);

  if (taskVendors.length === 0) {
    showToast('讌ｭ閠・ュ蝣ｱ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ', 'error');
    return;
  }

  // IC繧ｿ繧ｹ繧ｯ縺ｮ蝣ｴ蜷・ 驕ｸ謚樔ｸｭ縺ｮ繝｡繝ｼ繧ｫ繝ｼ蜷阪↓蟇ｾ蠢懊＠縺滓･ｭ閠・ｒ蜆ｪ蜈育噪縺ｫ驕ｸ謚・
  if (IC_MAKER_TASKS.includes(taskKey)) {
    const progressData = project.progress || {};
    const selectedMaker = progressData[taskKey]?.state || '';

    if (selectedMaker && selectedMaker !== '-') {
      // 驕ｸ謚樔ｸｭ縺ｮ繝｡繝ｼ繧ｫ繝ｼ蜷阪↓荳閾ｴ縺吶ｋ讌ｭ閠・ｒ蜈磯ｭ縺ｫ荳ｦ縺ｳ譖ｿ縺・
      const matchingVendor = taskVendors.find(v =>
        v.company.toLowerCase().includes(selectedMaker.toLowerCase()) ||
        v.company === selectedMaker
      );
      if (matchingVendor) {
        taskVendors = [matchingVendor, ...taskVendors.filter(v => v.id !== matchingVendor.id)];
      }
    }
  }

  // 迴ｾ蝨ｨ繝ｭ繧ｰ繧､繝ｳ縺励※縺・ｋ繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ諠・ｱ繧堤ｽｲ蜷阪↓菴ｿ逕ｨ
  const staffName = currentDesigner?.name || '';
  const staffEmail = currentDesigner?.email && !currentDesigner.email.includes('@temp.local') ? currentDesigner.email : '';
  const staffPhone = currentDesigner?.phone || '';
  const staffDepartment = currentDesigner?.department || '';

  // 迴ｾ蝨ｨ譌･莉倥°繧画悄譌･繧定ｨｭ螳夲ｼ医ョ繝輔か繝ｫ繝茨ｼ・譌･蠕鯉ｼ・
  const today = new Date();
  const dueDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
  const dueDateStr = dueDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });

  // 驕ｸ謚樔ｸｭ縺ｮ繝｡繝ｼ繧ｫ繝ｼ縺ｫ蟇ｾ蠢懊＠縺滓･ｭ閠・ｼ医∪縺溘・譛蛻昴・讌ｭ閠・ｼ峨・繝・Φ繝励Ξ繝ｼ繝医ｒ菴ｿ逕ｨ
  const vendor = taskVendors[0];

  // 繝励Ξ繝ｼ繧ｹ繝帙Ν繝繝ｼ鄂ｮ謠・
  const replacePlaceholders = (text) => {
    if (!text) return '';
    return text
      .replace(/\{customerName\}/g, project.customer)
      .replace(/\{dueDate\}/g, dueDateStr)
      .replace(/\{staffName\}/g, staffName)
      .replace(/\{staffEmail\}/g, staffEmail)
      .replace(/\{staffPhone\}/g, staffPhone)
      .replace(/\{staffDepartment\}/g, staffDepartment)
      .replace(/\{taskName\}/g, taskDef.task_name)
      .replace(/\{company\}/g, vendor.company)
      .replace(/\{contact\}/g, vendor.contact || '縺疲球蠖楢・ｧ・);
  };

  // 鬘ｧ螳｢蜷阪°繧画忰蟆ｾ縺ｮ縲梧ｧ倥阪ｒ髯､蜴ｻ・磯㍾隍・亟豁｢・・
  const customerName = project.customer.replace(/讒・/, '');

  // 繝・ヵ繧ｩ繝ｫ繝医・莉ｶ蜷阪ヵ繧ｩ繝ｼ繝槭ャ繝・
  const defaultSubject = `縲・{taskDef.task_name}萓晞ｼ縲・{customerName}讒倬ず縲譛滓律・・{dueDateStr}蟶梧悍`;

  // 繝・ヵ繧ｩ繝ｫ繝医・譛ｬ譁・ユ繝ｳ繝励Ξ繝ｼ繝・
  const defaultBody = `${vendor.company}
${vendor.contact || '縺疲球蠖楢・} 讒・

縺・▽繧ゅ♀荳冶ｩｱ縺ｫ縺ｪ縺｣縺ｦ縺翫ｊ縺ｾ縺吶・
譬ｪ蠑丈ｼ夂､ｾG繝上え繧ｹ縺ｮ${staffName}縺ｧ縺吶・

荳玖ｨ俶｡井ｻｶ縺ｫ縺､縺阪∪縺励※縲・{taskDef.task_name}縺ｮ蠕｡隕狗ｩ堺ｽ懈・繧偵♀鬘倥＞縺・◆縺励∪縺吶・

窶補補補補補補補補補補補補補・
縲先｡井ｻｶ蜷阪・{customerName}讒倬ず
縲仙・螳ｹ縲・{taskDef.task_name}
縲先署蜃ｺ譛滄剞縲・{dueDateStr}
窶補補補補補補補補補補補補補・

蠢・ｦ∬ｳ・侭縺ｯ譛ｬ繝｡繝ｼ繝ｫ縺ｫ豺ｻ莉倥＠縺ｦ縺翫ｊ縺ｾ縺吶・
縺皮｢ｺ隱阪・縺・∴縲√ｂ縺嶺ｸ肴・轤ｹ繧・ｿｽ蜉縺ｧ蠢・ｦ√↑雉・侭遲峨′縺斐＊縺・∪縺励◆繧峨・
縺頑焔謨ｰ縺ｧ縺吶′縺比ｸ蝣ｱ縺・◆縺縺代∪縺吶→蟷ｸ縺・〒縺吶・

縺雁ｿ吶＠縺・→縺薙ｍ諱舌ｌ蜈･繧翫∪縺吶′縲・
菴募穀繧医ｍ縺励￥縺企｡倥＞縺・◆縺励∪縺吶・

譬ｪ蠑丈ｼ夂､ｾG繝上え繧ｹ${staffDepartment ? '\n' + staffDepartment : ''}
${staffName}${staffPhone ? '\nTEL・・ + staffPhone : ''}${staffEmail ? '\nMail・・ + staffEmail : ''}`;

  // 蛻晄悄縺ｮ莉ｶ蜷阪→譛ｬ譁・ｒ逕滓・・亥ｸｸ縺ｫ繝・ヵ繧ｩ繝ｫ繝医ユ繝ｳ繝励Ξ繝ｼ繝医ｒ菴ｿ逕ｨ・・
  const initialSubject = defaultSubject;
  const initialBody = defaultBody;

  // 繝｢繝ｼ繝繝ｫ繧定｡ｨ遉ｺ
  showEmailModal(project, taskDef, taskVendors, initialSubject, initialBody);
}

// 繧ｯ繧､繝・け繝｡繝ｼ繝ｫ讖溯・ - 繝ｯ繝ｳ繧ｯ繝ｪ繝・け縺ｧ繝｡繝ｼ繝ｫ菴懈・逕ｻ髱｢繧帝幕縺・
function quickEmail(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // 譛繧ゅｈ縺丈ｽｿ縺・ち繧ｹ繧ｯ・域ｧ矩萓晞ｼ縺ｪ縺ｩ・峨ｒ蜿門ｾ励√∪縺溘・繧ｫ繧ｹ繧ｿ繝繝・Φ繝励Ξ繝ｼ繝医ｒ陦ｨ遉ｺ
  const quickModal = document.createElement('div');
  quickModal.id = 'quickEmailModal';
  quickModal.className = 'modal-overlay';
  quickModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

  // 繧ｿ繧ｹ繧ｯ繝ｪ繧ｹ繝医ｒ蜿門ｾ・
  const tasks = getTasksForAssignee(project.assigned_to);
  const tasksWithVendors = tasks.filter(t => taskVendorMappings.some(m => m.task_id === t.id));

  const taskOptions = tasksWithVendors.map(t =>
    `<button class="quick-email-btn" onclick="openEmailFromTask('${projectId}', '${t.task_key}'); document.getElementById('quickEmailModal').remove();" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; width: 100%; text-align: left; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-light)'; this.style.borderColor='var(--primary-color)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.borderColor='var(--border-color)'">
      <span style="font-size: 20px;">透</span>
      <span style="font-weight: 500;">${escapeHtml(t.task_name)}</span>
    </button>`
  ).join('');

  quickModal.innerHTML = `
    <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 500px; width: 90%;">
      <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
        <h3 style="font-size: 18px; font-weight: 600; margin: 0;">透 繧ｯ繧､繝・け繝｡繝ｼ繝ｫ - ${escapeHtml(project.customer)}</h3>
      </div>
      <div class="modal-body" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
        <p style="margin-bottom: 16px; color: var(--text-secondary);">繝｡繝ｼ繝ｫ繧帝∽ｿ｡縺吶ｋ繧ｿ繧ｹ繧ｯ繧帝∈謚槭＠縺ｦ縺上□縺輔＞</p>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          ${taskOptions || '<p style="color: var(--text-muted);">繝｡繝ｼ繝ｫ騾∽ｿ｡蜿ｯ閭ｽ縺ｪ繧ｿ繧ｹ繧ｯ縺後≠繧翫∪縺帙ｓ</p>'}
        </div>
      </div>
      <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
        <button class="btn btn-ghost" onclick="document.getElementById('quickEmailModal').remove()">髢峨§繧・/button>
      </div>
    </div>
  `;
  quickModal.addEventListener('click', (e) => {
    if (e.target === quickModal) quickModal.remove();
  });
  document.body.appendChild(quickModal);
}

function showEmailModal(project, taskDef, vendors, initialSubject, initialBody) {
  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  // 讌ｭ閠・∈謚槭メ繧ｧ繝・け繝懊ャ繧ｯ繧ｹ縺ｮHTML・・SS蟇ｾ遲・ escapeHtml驕ｩ逕ｨ・・
  const vendorCheckboxes = vendors.map((v, idx) => `
    <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md); cursor: pointer;">
      <input type="checkbox"
        id="vendor_${escapeHtml(v.id)}"
        value="${escapeHtml(v.id)}"
        ${idx === 0 ? 'checked' : ''}
        onchange="updateEmailPreview()"
        style="width: 18px; height: 18px; cursor: pointer;">
      <div style="flex: 1;">
        <div style="font-weight: 600; margin-bottom: 2px;">${escapeHtml(v.company)}</div>
        <div style="font-size: 13px; color: var(--text-secondary);">${escapeHtml(v.contact || '')} - ${escapeHtml(v.email || '')}</div>
      </div>
    </label>
  `).join('');

  content.innerHTML = `
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <div>
        <h3 style="margin: 0 0 8px 0; font-size: 18px;">透 ${escapeHtml(taskDef.task_name)} - 繝｡繝ｼ繝ｫ菴懈・</h3>
        <div style="font-size: 14px; color: var(--text-secondary);">譯井ｻｶ: ${escapeHtml(project.customer)}</div>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">螳帛・讌ｭ閠・ｒ驕ｸ謚・/label>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${vendorCheckboxes}
        </div>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">莉ｶ蜷・/label>
        <input type="text" id="emailSubject" class="form-input" value="${escapeHtml(initialSubject)}">
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">譛ｬ譁・/label>
        <textarea id="emailBody" class="form-textarea" rows="15" style="font-family: inherit; line-height: 1.8;">${escapeHtml(initialBody)}</textarea>
      </div>

      <div style="display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="closeEmailModal()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
        <button class="btn btn-secondary" onclick="copyEmailToClipboard()">搭 繧ｳ繝斐・</button>
        <button class="btn btn-secondary" onclick="openOutlookFromModal()">鐙 Outlook</button>
        <button class="btn btn-primary" onclick="openGmailFromModal()">透 Gmail</button>
      </div>
    </div>
  `;

  // 繧ｰ繝ｭ繝ｼ繝舌Ν縺ｫ菫晏ｭ假ｼ・penGmailFromModal縺ｧ菴ｿ逕ｨ・・
  window.__emailModalData = { project, taskDef, vendors };

  modal.classList.add('show');
}

function updateEmailPreview() {
  // 蠢・ｦ√↓蠢懊§縺ｦ莉ｶ蜷阪・譛ｬ譁・・繝励Ξ繝薙Η繝ｼ譖ｴ譁ｰ蜃ｦ逅・ｒ霑ｽ蜉
}

// 繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ蜿門ｾ怜・騾夐未謨ｰ
function getSelectedEmailAddresses() {
  const { vendors } = window.__emailModalData || {};
  if (!vendors) return { addresses: '', vendors: [] };

  const selectedVendorIds = vendors
    .filter(v => document.getElementById(`vendor_${v.id}`)?.checked)
    .map(v => v.id);

  if (selectedVendorIds.length === 0) {
    showToast('讌ｭ閠・ｒ驕ｸ謚槭＠縺ｦ縺上□縺輔＞', 'error');
    return { addresses: '', vendors: [] };
  }

  const selectedVendors = vendors.filter(v => selectedVendorIds.includes(v.id));
  const emailAddresses = selectedVendors.map(v => v.email).filter(e => e).join(',');

  if (!emailAddresses) {
    showToast('驕ｸ謚槭＆繧後◆讌ｭ閠・↓繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ', 'error');
    return { addresses: '', vendors: [] };
  }

  return { addresses: emailAddresses, vendors: selectedVendors };
}

function openGmailFromModal() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  const { addresses } = getSelectedEmailAddresses();

  if (!addresses) return;

  // 譛ｬ譁・↓縲梧ｷｻ莉倥阪′蜷ｫ縺ｾ繧後ｋ蝣ｴ蜷医・縺ｿ隴ｦ蜻翫ｒ陦ｨ遉ｺ
  if (body.includes('豺ｻ莉・)) {
    if (!confirm('笞・・豺ｻ莉倥ヵ繧｡繧､繝ｫ縺ｮ遒ｺ隱構n\n譛ｬ譁・↓縲梧ｷｻ莉倥阪→縺・≧險倩ｼ峨′縺ゅｊ縺ｾ縺吶′縲√ヵ繧｡繧､繝ｫ縺ｯGmail蛛ｴ縺ｧ豺ｻ莉倥☆繧句ｿ・ｦ√′縺ゅｊ縺ｾ縺吶・n\n雉・侭縺ｮ貅門ｙ縺ｯ縺ｧ縺阪※縺・∪縺吶°・・)) {
      return;
    }
  }

  // Gmail URL繧堤函謌・
  const gmailUrl = `https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(addresses)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  // Gmail繧呈眠縺励＞繧ｿ繝悶〒髢九￥
  window.open(gmailUrl, '_blank');

  // 騾∽ｿ｡螻･豁ｴ繧定ｨ倬鹸
  logEmailSent('gmail', addresses, subject);

  // 繝｢繝ｼ繝繝ｫ繧帝哩縺倥ｋ
  closeEmailModal();

  // 繝医・繧ｹ繝医〒騾夂衍・域ｷｻ莉倥′縺ゅｋ蝣ｴ蜷医・縺ｿ隴ｦ蜻奇ｼ・
  const toastMsg = body.includes('豺ｻ莉・) ? 'Gmail繧帝幕縺阪∪縺励◆縲りｳ・侭縺ｮ豺ｻ莉倥ｒ蠢倥ｌ縺壹↓・・ : 'Gmail繧帝幕縺阪∪縺励◆';
  showToast(toastMsg, 'success');
}

function openOutlookFromModal() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  const { addresses } = getSelectedEmailAddresses();

  if (!addresses) return;

  // 譛ｬ譁・↓縲梧ｷｻ莉倥阪′蜷ｫ縺ｾ繧後ｋ蝣ｴ蜷医・縺ｿ隴ｦ蜻翫ｒ陦ｨ遉ｺ
  if (body.includes('豺ｻ莉・)) {
    if (!confirm('笞・・豺ｻ莉倥ヵ繧｡繧､繝ｫ縺ｮ遒ｺ隱構n\n譛ｬ譁・↓縲梧ｷｻ莉倥阪→縺・≧險倩ｼ峨′縺ゅｊ縺ｾ縺吶′縲√ヵ繧｡繧､繝ｫ縺ｯOutlook蛛ｴ縺ｧ豺ｻ莉倥☆繧句ｿ・ｦ√′縺ゅｊ縺ｾ縺吶・n\n雉・侭縺ｮ貅門ｙ縺ｯ縺ｧ縺阪※縺・∪縺吶°・・)) {
      return;
    }
  }

  // Outlook Web URL繧堤函謌・
  const outlookUrl = `https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(addresses)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  // Outlook繧呈眠縺励＞繧ｿ繝悶〒髢九￥
  window.open(outlookUrl, '_blank');

  // 騾∽ｿ｡螻･豁ｴ繧定ｨ倬鹸
  logEmailSent('outlook', addresses, subject);

  // 繝｢繝ｼ繝繝ｫ繧帝哩縺倥ｋ
  closeEmailModal();

  // 繝医・繧ｹ繝医〒騾夂衍・域ｷｻ莉倥′縺ゅｋ蝣ｴ蜷医・縺ｿ隴ｦ蜻奇ｼ・
  const toastMsg = body.includes('豺ｻ莉・) ? 'Outlook繧帝幕縺阪∪縺励◆縲りｳ・侭縺ｮ豺ｻ莉倥ｒ蠢倥ｌ縺壹↓・・ : 'Outlook繧帝幕縺阪∪縺励◆';
  showToast(toastMsg, 'success');
}

function copyEmailToClipboard() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  const { addresses } = getSelectedEmailAddresses();

  if (!addresses) return;

  const emailText = `螳帛・: ${addresses}\n莉ｶ蜷・ ${subject}\n\n${body}`;

  navigator.clipboard.writeText(emailText).then(() => {
    showToast('繝｡繝ｼ繝ｫ蜀・ｮｹ繧偵さ繝斐・縺励∪縺励◆', 'success');
  }).catch(() => {
    // 繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ
    const textarea = document.createElement('textarea');
    textarea.value = emailText;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast('繝｡繝ｼ繝ｫ蜀・ｮｹ繧偵さ繝斐・縺励∪縺励◆', 'success');
  });
}

// 繝｡繝ｼ繝ｫ騾∽ｿ｡螻･豁ｴ繧定ｨ倬鹸
async function logEmailSent(method, to, subject) {
  const { project, taskDef } = window.__emailModalData || {};
  if (!project || !taskDef) return;

  log(`透 繝｡繝ｼ繝ｫ騾∽ｿ｡險倬鹸: ${method} -> ${to}, 莉ｶ蜷・ ${subject}`);

  // 蟆・擂: Supabase縺ｫ騾∽ｿ｡螻･豁ｴ繧剃ｿ晏ｭ・
  // try {
  //   await supabase.from('email_logs').insert({
  //     project_id: project.id,
  //     task_key: taskDef.task_key,
  //     method,
  //     recipients: to,
  //     subject,
  //     sent_at: new Date().toISOString()
  //   });
  // } catch (e) {
  //   logError('繝｡繝ｼ繝ｫ螻･豁ｴ菫晏ｭ伜､ｱ謨・', e);
  // }
}

// 繝・Φ繝励Ξ繝ｼ繝磯∈謚樒判髱｢繧定｡ｨ遉ｺ
function showTemplateSelector(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  const currentTaskNames = getTaskNames();
  const taskName = currentTaskNames[taskKey];

  // 迴ｾ蝨ｨ縺ｮ繧ｫ繝・ざ繝ｪ縺ｫ蠢懊§縺溘ユ繝ｳ繝励Ξ繝ｼ繝医ｒ繝輔ぅ繝ｫ繧ｿ
  const availableTemplates = emailTemplates.filter(t => t.category === currentUserCategory);

  let html = `
    <div class="form-section">
      <h3 style="margin-bottom: 8px; color: var(--text-primary);">繝｡繝ｼ繝ｫ繝・Φ繝励Ξ繝ｼ繝磯∈謚・/h3>
      <p style="margin-bottom: 24px; color: var(--text-secondary); font-size: 14px;">
        譯井ｻｶ・・{project.customer} ・・繧ｿ繧ｹ繧ｯ・・{taskName}
      </p>

      <div style="display: grid; gap: 12px;">
        ${availableTemplates.map(template => `
          <button class="template-select-btn" onclick="selectTemplateForTask('${projectId}', '${taskKey}', '${template.template_id}')">
            <div style="font-weight: 600; margin-bottom: 4px;">${template.display_name}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">${template.company}</div>
          </button>
        `).join('')}
      </div>

      ${availableTemplates.length === 0 ? '<p style="text-align: center; padding: 32px; color: var(--text-muted);">蛻ｩ逕ｨ蜿ｯ閭ｽ縺ｪ繝・Φ繝励Ξ繝ｼ繝医′縺ゅｊ縺ｾ縺帙ｓ</p>' : ''}
    </div>
  `;

  document.getElementById('emailComposerContent').innerHTML = html;
  ModalManager.open(document.getElementById('emailModal'));
}

// 繝・Φ繝励Ξ繝ｼ繝磯∈謚槫ｾ後↓繝｡繝ｼ繝ｫ菴懈・逕ｻ髱｢繧定｡ｨ遉ｺ
function selectTemplateForTask(projectId, taskKey, templateId) {
  const project = projects.find(p => p.id === projectId);
  const template = emailTemplates.find(t => t.template_id === templateId);
  const designer = designers.find(d => d.id === project.designer_id);
  const staffName = designer ? designer.name : '';

  const composerHTML = createEmailComposer(project, template, staffName, taskKey);
  document.getElementById('emailComposerContent').innerHTML = composerHTML;
}

function createEmailComposer(project, template, staffName, taskKey) {
  const hasSubOptions = template.has_sub_options;
  const hasSpecialContent = template.has_special_content;

  let html = `
    <div class="form-section">
      <h3 style="margin-bottom: 16px; color: var(--text-primary);">${template.display_name}</h3>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div class="form-group">
          <label class="form-label">縺雁ｮ｢讒伜錐:</label>
          <input type="text" class="form-input" id="modalCustomerName" value="${project.customer}" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label class="form-label">諡・ｽ楢・錐:</label>
          <input type="text" class="form-input" id="modalStaffName" value="${staffName}" oninput="updateModalEmail()">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">譛滓律:</label>
        <input type="date" class="form-input" id="modalDueDate" oninput="updateModalEmail()">
      </div>
  `;

  if (hasSpecialContent) {
    const defaultContent = template.default_special_content || '';
    html += `
      <div class="form-group">
        <label class="form-label">迚ｹ險倅ｺ矩・</label>
        <textarea class="form-textarea" id="modalSpecialContent" rows="4" oninput="updateModalEmail()">${defaultContent}</textarea>
      </div>
    `;
  }

  if (hasSubOptions) {
    const templateVendors = vendors.filter(v => v.template_id === template.template_id);
    html += `
      <div class="form-group">
        <label class="form-label">讌ｭ閠・∈謚・</label>
        <select class="form-select" id="modalVendorSelect" onchange="updateModalEmail()">
          <option value="">驕ｸ謚槭＠縺ｦ縺上□縺輔＞</option>
          ${templateVendors.map(v => `<option value="${escapeHtml(v.vendor_id)}">${escapeHtml(v.company)}</option>`).join('')}
        </select>
      </div>
    `;
  }

  html += `
    </div>

    <div style="margin-top: 24px;">
      <h3 style="margin-bottom: 12px; color: var(--text-primary);">闘 逕滓・縺輔ｌ縺溘Γ繝ｼ繝ｫ</h3>

      <div class="form-group">
        <label class="form-label">莉ｶ蜷・</label>
        <div id="modalEmailSubject" style="padding: 12px; background: #f8f9fa; border-radius: 8px; font-weight: 500;"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailSubject')" style="margin-top: 8px;">搭 莉ｶ蜷阪ｒ繧ｳ繝斐・</button>
      </div>

      <div class="form-group">
        <label class="form-label">騾∽ｿ｡蜈・</label>
        <div id="modalEmailAddress" style="padding: 12px; background: #f8f9fa; border-radius: 8px; color: var(--primary-color);"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailAddress')" style="margin-top: 8px;">搭 繧｢繝峨Ξ繧ｹ繧偵さ繝斐・</button>
      </div>

      <div class="form-group">
        <label class="form-label">譛ｬ譁・</label>
        <div id="modalEmailBody" style="padding: 16px; background: #f8f9fa; border-radius: 8px; white-space: pre-wrap; line-height: 1.8; min-height: 200px;"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailBody')" style="margin-top: 8px;">搭 譛ｬ譁・ｒ繧ｳ繝斐・</button>
      </div>
    </div>

    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
      <button class="btn btn-secondary" onclick="closeEmailModal()">髢峨§繧・/button>
      <button class="btn btn-primary" onclick="markTaskAsRequested('${project.id}', '${taskKey}')">萓晞ｼ貂医∩縺ｫ縺吶ｋ</button>
    </div>
  `;

  // 繝・・繧ｿ繧剃ｿ晏ｭ假ｼ・pdateModalEmail縺ｧ菴ｿ逕ｨ・・
  window.__currentEmailData = {
    project,
    template,
    staffName,
    taskKey
  };

  // 蛻晏屓繝｡繝ｼ繝ｫ逕滓・
  setTimeout(() => updateModalEmail(), 100);

  return html;
}

function updateModalEmail() {
  if (!window.__currentEmailData) return;

  const { project, template } = window.__currentEmailData;

  const customerName = document.getElementById('modalCustomerName')?.value || project.customer;
  const staffName = document.getElementById('modalStaffName')?.value || '';
  const dueDate = document.getElementById('modalDueDate')?.value || '';
  const specialContent = document.getElementById('modalSpecialContent')?.value || template.default_special_content || '';
  const vendorSelect = document.getElementById('modalVendorSelect');
  const selectedVendorId = vendorSelect?.value || '';

  let subject = template.subject_format || '';
  let body = template.template_text || '';
  let email = template.email || '';
  let company = template.company || '';
  let contact = template.contact || '';

  // 繧ｵ繝悶が繝励す繝ｧ繝ｳ縺後≠繧句ｴ蜷医・讌ｭ閠・ュ蝣ｱ繧剃ｽｿ逕ｨ
  if (template.has_sub_options && selectedVendorId) {
    const vendor = vendors.find(v => v.template_id === template.template_id && v.vendor_id === selectedVendorId);
    if (vendor) {
      company = vendor.company;
      contact = vendor.contact || '縺疲球蠖楢・ｧ・;
      email = vendor.email || '';
    }
  }

  // 螟画焚繧堤ｽｮ謠・
  subject = subject
    .replace(/\{customerName\}/g, customerName)
    .replace(/\{dueDate\}/g, dueDate);

  body = body
    .replace(/\{company\}/g, company)
    .replace(/\{contact\}/g, contact)
    .replace(/\{customerName\}/g, customerName)
    .replace(/\{staffName\}/g, staffName)
    .replace(/\{dueDate\}/g, dueDate)
    .replace(/\{specialContent\}/g, specialContent);

  // 陦ｨ遉ｺ繧呈峩譁ｰ
  const subjectEl = document.getElementById('modalEmailSubject');
  const addressEl = document.getElementById('modalEmailAddress');
  const bodyEl = document.getElementById('modalEmailBody');

  if (subjectEl) subjectEl.textContent = subject;
  if (addressEl) addressEl.textContent = email;
  if (bodyEl) bodyEl.textContent = body;
}

function copyModalText(elementId) {
  const text = document.getElementById(elementId)?.textContent;
  if (!text || text.includes('{') || text.includes('驕ｸ謚槭＠縺ｦ縺上□縺輔＞')) {
    showToast('繧ｳ繝斐・縺ｧ縺阪ｋ蜀・ｮｹ縺後≠繧翫∪縺帙ｓ', 'error');
    return;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('繧ｳ繝斐・縺励∪縺励◆・・, 'success');
  }).catch(err => {
    logError('繧ｳ繝斐・縺ｫ螟ｱ謨・', err);
    showToast('繧ｳ繝斐・縺ｫ螟ｱ謨励＠縺ｾ縺励◆', 'error');
  });
}

async function markTaskAsRequested(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].state = '萓晞ｼ貂・;

  showStatus('菫晏ｭ倅ｸｭ...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    logError('譖ｴ譁ｰ繧ｨ繝ｩ繝ｼ:', error);
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
    return;
  }

  project.progress = progressData;
  markLocalUpdate(projectId); // 繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄縺ｮ莠碁㍾譖ｴ譁ｰ髦ｲ豁｢
  renderProjects();
  closeEmailModal();
  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('萓晞ｼ貂医∩縺ｫ譖ｴ譁ｰ縺励∪縺励◆', 'success');
}

function closeEmailModal() {
  ModalManager.close(document.getElementById('emailModal'));
  window.__currentEmailData = null;
}

// ============================================
// 迢ｬ遶九＠縺溘Γ繝ｼ繝ｫ菴懈・讖溯・・亥炎髯､莠亥ｮ夲ｼ・
// ============================================
function updateStandaloneEmail() {
  const templateSelect = document.getElementById('standaloneTemplateSelect');
  const templateId = templateSelect.value;

  if (!templateId) {
    // 繝・Φ繝励Ξ繝ｼ繝域悴驕ｸ謚樊凾縺ｯ繧ｯ繝ｪ繧｢
    document.getElementById('standaloneEmailSubject').textContent = '';
    document.getElementById('standaloneEmailAddress').textContent = '';
    document.getElementById('standaloneEmailBody').textContent = '';
    document.getElementById('standaloneVendorGroup').style.display = 'none';
    document.getElementById('standaloneSpecialContentGroup').style.display = 'none';
    return;
  }

  const template = emailTemplates.find(t => t.template_id === templateId);
  if (!template) return;

  // 迚ｹ險倅ｺ矩・ヵ繧｣繝ｼ繝ｫ繝峨・陦ｨ遉ｺ/髱櫁｡ｨ遉ｺ
  if (template.has_special_content) {
    document.getElementById('standaloneSpecialContentGroup').style.display = 'block';
  } else {
    document.getElementById('standaloneSpecialContentGroup').style.display = 'none';
  }

  // 蜈･蜉帛､繧貞叙蠕・
  const customerName = document.getElementById('standaloneCustomerName').value.trim();
  const staffName = document.getElementById('standaloneStaffName').value.trim();
  const dueDate = document.getElementById('standaloneDueDate').value;
  const specialContent = document.getElementById('standaloneSpecialContent').value.trim();

  // 繧ｵ繝悶が繝励す繝ｧ繝ｳ・域･ｭ閠・∈謚橸ｼ峨′縺ゅｋ繝・Φ繝励Ξ繝ｼ繝医・蝣ｴ蜷・
  if (template.has_sub_options) {
    document.getElementById('standaloneVendorGroup').style.display = 'block';
    const vendorSelect = document.getElementById('standaloneVendorSelect');
    const selectedVendorId = vendorSelect.value;

    // 讌ｭ閠・∈謚槭ラ繝ｭ繝・・繝繧ｦ繝ｳ繧呈峩譁ｰ
    if (vendorSelect.options.length === 0) {
      const templateVendors = vendors.filter(v => v.template_id === templateId);
      vendorSelect.innerHTML = '<option value="">讌ｭ閠・ｒ驕ｸ謚槭＠縺ｦ縺上□縺輔＞</option>' +
        templateVendors.map(v =>
          `<option value="${escapeHtml(v.vendor_id)}">${escapeHtml(v.company)}</option>`
        ).join('');
    }

    if (!selectedVendorId) {
      // 讌ｭ閠・悴驕ｸ謚樊凾縺ｯ繝｡繝ｼ繝ｫ逕滓・縺励↑縺・
      document.getElementById('standaloneEmailSubject').textContent = '讌ｭ閠・ｒ驕ｸ謚槭＠縺ｦ縺上□縺輔＞';
      document.getElementById('standaloneEmailAddress').textContent = '';
      document.getElementById('standaloneEmailBody').textContent = '';
      return;
    }

    const vendor = vendors.find(v => v.template_id === templateId && v.vendor_id === selectedVendorId);
    if (!vendor) return;

    // 讌ｭ閠・ュ蝣ｱ縺ｧ螟画焚繧堤ｽｮ謠・
    let subject = template.subject_format || '';
    let body = template.template_text || '';

    subject = subject
      .replace(/\{customerName\}/g, customerName || '{縺雁ｮ｢讒伜錐}')
      .replace(/\{dueDate\}/g, dueDate || '{譛滓律}');

    body = body
      .replace(/\{company\}/g, vendor.company)
      .replace(/\{contact\}/g, vendor.contact || '縺疲球蠖楢・ｧ・)
      .replace(/\{customerName\}/g, customerName || '{縺雁ｮ｢讒伜錐}')
      .replace(/\{staffName\}/g, staffName || '{諡・ｽ楢・錐}')
      .replace(/\{dueDate\}/g, dueDate || '{譛滓律}')
      .replace(/\{specialContent\}/g, specialContent || template.default_special_content || '');

    document.getElementById('standaloneEmailSubject').textContent = subject;
    document.getElementById('standaloneEmailAddress').textContent = vendor.email || '';
    document.getElementById('standaloneEmailBody').textContent = body;
  } else {
    // 繧ｵ繝悶が繝励す繝ｧ繝ｳ縺ｪ縺励ユ繝ｳ繝励Ξ繝ｼ繝・
    document.getElementById('standaloneVendorGroup').style.display = 'none';

    let subject = template.subject_format || '';
    let body = template.template_text || '';

    subject = subject
      .replace(/\{customerName\}/g, customerName || '{縺雁ｮ｢讒伜錐}')
      .replace(/\{dueDate\}/g, dueDate || '{譛滓律}');

    body = body
      .replace(/\{company\}/g, template.company)
      .replace(/\{contact\}/g, template.contact || '縺疲球蠖楢・ｧ・)
      .replace(/\{customerName\}/g, customerName || '{縺雁ｮ｢讒伜錐}')
      .replace(/\{staffName\}/g, staffName || '{諡・ｽ楢・錐}')
      .replace(/\{dueDate\}/g, dueDate || '{譛滓律}')
      .replace(/\{specialContent\}/g, specialContent || template.default_special_content || '');

    document.getElementById('standaloneEmailSubject').textContent = subject;
    document.getElementById('standaloneEmailAddress').textContent = template.email || '';
    document.getElementById('standaloneEmailBody').textContent = body;
  }
}

function copyStandaloneText(elementId) {
  const text = document.getElementById(elementId).textContent;
  if (!text || text.includes('{') || text.includes('驕ｸ謚槭＠縺ｦ縺上□縺輔＞')) {
    showToast('繧ｳ繝斐・縺ｧ縺阪ｋ蜀・ｮｹ縺後≠繧翫∪縺帙ｓ', 'error');
    return;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('繧ｳ繝斐・縺励∪縺励◆', 'success');
  }).catch(err => {
    logError('繧ｳ繝斐・縺ｫ螟ｱ謨・', err);
    showToast('繧ｳ繝斐・縺ｫ螟ｱ謨励＠縺ｾ縺励◆', 'error');
  });
}

function populateStandaloneTemplateSelect() {
  const select = document.getElementById('standaloneTemplateSelect');
  if (!select) return;

  // currentUserCategory縺ｫ蠢懊§縺ｦ繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ
  let filtered = emailTemplates;
  if (currentUserCategory && currentUserCategory !== 'admin') {
    filtered = emailTemplates.filter(t => t.category === currentUserCategory);
  }

  select.innerHTML = '<option value="">繝・Φ繝励Ξ繝ｼ繝医ｒ驕ｸ謚槭＠縺ｦ縺上□縺輔＞</option>' +
    filtered.map(t =>
      `<option value="${escapeHtml(t.template_id)}">${escapeHtml(t.display_name)}</option>`
    ).join('');
}

// ============================================
// 繧ｨ繧ｯ繧ｹ繝昴・繝域ｩ溯・
// ============================================
const ExportManager = {
  // 繧ｨ繧ｯ繧ｹ繝昴・繝医Δ繝ｼ繝繝ｫ繧定｡ｨ遉ｺ
  showModal() {
    const modal = document.createElement('div');
    modal.id = 'exportModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 500px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">刀 繝・・繧ｿ繧ｨ繧ｯ繧ｹ繝昴・繝・/h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">繧ｨ繧ｯ繧ｹ繝昴・繝亥ｽ｢蠑・/label>
            <div style="display: grid; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="exportFormat" value="csv" checked> CSV・・xcel蟇ｾ蠢懶ｼ・
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="exportFormat" value="json"> JSON
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="exportFormat" value="print"> 蜊ｰ蛻ｷ逕ｨ繝ｬ繝昴・繝・
              </label>
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">繧ｨ繧ｯ繧ｹ繝昴・繝亥ｯｾ雎｡</label>
            <div style="display: grid; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exportProjects" checked> 譯井ｻｶ繝・・繧ｿ・・{projects.length}莉ｶ・・
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exportWithTasks" checked> 繧ｿ繧ｹ繧ｯ隧ｳ邏ｰ繧貞性繧√ｋ
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exportOnlyActive" checked> 繧｢繧ｯ繝・ぅ繝悶↑譯井ｻｶ縺ｮ縺ｿ
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('exportModal').remove()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
          <button class="btn btn-primary" onclick="ExportManager.execute()">繧ｨ繧ｯ繧ｹ繝昴・繝・/button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  },

  execute() {
    const format = document.querySelector('input[name="exportFormat"]:checked').value;
    const includeProjects = document.getElementById('exportProjects').checked;
    const includeTasks = document.getElementById('exportWithTasks').checked;
    const onlyActive = document.getElementById('exportOnlyActive').checked;

    document.getElementById('exportModal').remove();

    let dataToExport = projects;
    if (onlyActive) {
      dataToExport = dataToExport.filter(p => p.status !== 'completed' && !p.is_archived);
    }

    switch (format) {
      case 'csv':
        this.exportCSV(dataToExport, includeTasks);
        break;
      case 'json':
        this.exportJSON(dataToExport, includeTasks);
        break;
      case 'print':
        this.exportPrint(dataToExport, includeTasks);
        break;
    }
  },

  exportCSV(data, includeTasks) {
    if (data.length === 0) {
      showToast('繧ｨ繧ｯ繧ｹ繝昴・繝医☆繧区｡井ｻｶ縺後≠繧翫∪縺帙ｓ', 'error');
      return;
    }

    let headers, rows;

    if (includeTasks) {
      headers = ['鬘ｧ螳｢蜷・, '諡・ｽ楢・, 'IC諡・ｽ・, '蝠・刀', '騾ｲ謐礼紫', '繧ｿ繧ｹ繧ｯ蜷・, '繧ｿ繧ｹ繧ｯ迥ｶ諷・, '譛滄剞', '繝｡繝｢', '菴懈・譌･'];
      rows = [];
      data.forEach(p => {
        const progress = calculateProgress(p);
        const tasks = p.tasks || {};
        const taskEntries = Object.entries(tasks);

        if (taskEntries.length === 0) {
          rows.push([
            this.csvEscape(p.customer),
            this.csvEscape(p.assigned_to),
            this.csvEscape(p.ic_assignee),
            this.csvEscape(p.specifications || 'LIFE'),
            `${progress}%`,
            '', '', '',
            this.csvEscape(p.memo),
            p.created_at || ''
          ].join(','));
        } else {
          taskEntries.forEach(([key, task], idx) => {
            const taskDef = tasksV2.find(t => t.task_key === key);
            rows.push([
              idx === 0 ? this.csvEscape(p.customer) : '',
              idx === 0 ? this.csvEscape(p.assigned_to) : '',
              idx === 0 ? this.csvEscape(p.ic_assignee) : '',
              idx === 0 ? this.csvEscape(p.specifications || 'LIFE') : '',
              idx === 0 ? `${progress}%` : '',
              this.csvEscape(taskDef?.task_name || key),
              this.csvEscape(task.status || ''),
              task.due_date || '',
              idx === 0 ? this.csvEscape(p.memo) : '',
              idx === 0 ? (p.created_at || '') : ''
            ].join(','));
          });
        }
      });
    } else {
      headers = ['鬘ｧ螳｢蜷・, '諡・ｽ楢・, 'IC諡・ｽ・, '蝠・刀', '騾ｲ謐礼紫', '繝｡繝｢', '菴懈・譌･', '譖ｴ譁ｰ譌･'];
      rows = data.map(p => {
        const progress = calculateProgress(p);
        return [
          this.csvEscape(p.customer),
          this.csvEscape(p.assigned_to),
          this.csvEscape(p.ic_assignee),
          this.csvEscape(p.specifications || 'LIFE'),
          `${progress}%`,
          this.csvEscape(p.memo),
          p.created_at || '',
          p.updated_at || ''
        ].join(',');
      });
    }

    const csvContent = [headers.join(','), ...rows].join('\n');
    this.download(csvContent, 'csv', 'projects');
    showToast(`${data.length}莉ｶ縺ｮ譯井ｻｶ繧辰SV縺ｧ繧ｨ繧ｯ繧ｹ繝昴・繝医＠縺ｾ縺励◆`, 'success');
  },

  exportJSON(data, includeTasks) {
    if (data.length === 0) {
      showToast('繧ｨ繧ｯ繧ｹ繝昴・繝医☆繧区｡井ｻｶ縺後≠繧翫∪縺帙ｓ', 'error');
      return;
    }

    const exportData = data.map(p => {
      const base = {
        customer: p.customer,
        assigned_to: p.assigned_to,
        ic_assignee: p.ic_assignee,
        specifications: p.specifications,
        progress: calculateProgress(p),
        status: p.status,
        memo: p.memo,
        created_at: p.created_at,
        updated_at: p.updated_at
      };

      if (includeTasks && p.tasks) {
        base.tasks = Object.entries(p.tasks).map(([key, task]) => {
          const taskDef = tasksV2.find(t => t.task_key === key);
          return {
            task_key: key,
            task_name: taskDef?.task_name || key,
            status: task.status,
            due_date: task.due_date,
            completed_at: task.completed_at
          };
        });
      }

      return base;
    });

    const jsonContent = JSON.stringify({
      exported_at: new Date().toISOString(),
      version: APP_VERSION,
      count: exportData.length,
      projects: exportData
    }, null, 2);

    this.download(jsonContent, 'json', 'projects');
    showToast(`${data.length}莉ｶ縺ｮ譯井ｻｶ繧谷SON縺ｧ繧ｨ繧ｯ繧ｹ繝昴・繝医＠縺ｾ縺励◆`, 'success');
  },

  exportPrint(data, includeTasks) {
    if (data.length === 0) {
      showToast('繧ｨ繧ｯ繧ｹ繝昴・繝医☆繧区｡井ｻｶ縺後≠繧翫∪縺帙ｓ', 'error');
      return;
    }

    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      showToast('繝昴ャ繝励い繝・・縺後ヶ繝ｭ繝・け縺輔ｌ縺ｾ縺励◆縲りｨｱ蜿ｯ縺励※縺上□縺輔＞縲・, 'error');
      return;
    }

    const html = `
      <!DOCTYPE html>
      <html lang="ja">
      <head>
        <meta charset="UTF-8">
        <title>ArchiDeck - 譯井ｻｶ繝ｬ繝昴・繝・/title>
        <style>
          body { font-family: 'Noto Sans JP', sans-serif; padding: 20mm; color: #333; }
          h1 { text-align: center; border-bottom: 2px solid #2563EB; padding-bottom: 10px; }
          .meta { text-align: right; color: #666; margin-bottom: 20px; }
          table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background: #f5f5f5; font-weight: 600; }
          .project-section { margin-bottom: 30px; page-break-inside: avoid; }
          .project-title { background: #2563EB; color: white; padding: 10px; margin-bottom: 10px; }
          .tasks-table { font-size: 12px; }
          .progress { font-weight: bold; color: #2563EB; }
          @media print {
            body { padding: 10mm; }
            .project-section { page-break-inside: avoid; }
          }
        </style>
      </head>
      <body>
        <h1>ArchiDeck 譯井ｻｶ繝ｬ繝昴・繝・/h1>
        <div class="meta">
          蜃ｺ蜉帶律譎・ ${new Date().toLocaleString('ja-JP')}<br>
          譯井ｻｶ謨ｰ: ${data.length}莉ｶ
        </div>
        ${data.map(p => {
          const progress = calculateProgress(p);
          const taskRows = includeTasks && p.tasks ? Object.entries(p.tasks).map(([key, task]) => {
            const taskDef = tasksV2.find(t => t.task_key === key);
            return `<tr>
              <td>${this.escapeHtml(taskDef?.task_name || key)}</td>
              <td>${this.escapeHtml(task.status || '譛ｪ逹謇・)}</td>
              <td>${task.due_date || '-'}</td>
            </tr>`;
          }).join('') : '';

          return `
            <div class="project-section">
              <div class="project-title">${this.escapeHtml(p.customer)} - ${this.escapeHtml(p.specifications || 'LIFE')}</div>
              <table>
                <tr><th>諡・ｽ楢・/th><td>${this.escapeHtml(p.assigned_to || '-')}</td><th>IC諡・ｽ・/th><td>${this.escapeHtml(p.ic_assignee || '-')}</td></tr>
                <tr><th>騾ｲ謐・/th><td class="progress">${progress}%</td><th>菴懈・譌･</th><td>${p.created_at?.split('T')[0] || '-'}</td></tr>
                ${p.memo ? `<tr><th>繝｡繝｢</th><td colspan="3">${this.escapeHtml(p.memo)}</td></tr>` : ''}
              </table>
              ${includeTasks && taskRows ? `
                <table class="tasks-table">
                  <thead><tr><th>繧ｿ繧ｹ繧ｯ</th><th>迥ｶ諷・/th><th>譛滄剞</th></tr></thead>
                  <tbody>${taskRows}</tbody>
                </table>
              ` : ''}
            </div>
          `;
        }).join('')}
      </body>
      </html>
    `;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.onload = () => printWindow.print();
    showToast('蜊ｰ蛻ｷ逕ｨ繝ｬ繝昴・繝医ｒ逕滓・縺励∪縺励◆', 'success');
  },

  csvEscape(str) {
    if (!str) return '""';
    return `"${String(str).replace(/"/g, '""')}"`;
  },

  escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  },

  download(content, type, prefix) {
    const mimeTypes = {
      csv: 'text/csv;charset=utf-8;',
      json: 'application/json;charset=utf-8;'
    };
    const extensions = { csv: 'csv', json: 'json' };

    const bom = type === 'csv' ? new Uint8Array([0xEF, 0xBB, 0xBF]) : new Uint8Array([]);
    const blob = new Blob([bom, content], { type: mimeTypes[type] });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${prefix}_${new Date().toISOString().split('T')[0]}.${extensions[type]}`;
    link.click();
    URL.revokeObjectURL(url);
  }
};

// 蠕梧婿莠呈鋤諤ｧ縺ｮ縺溘ａ譌ｧ髢｢謨ｰ繧呈ｮ九☆
function exportCSV() {
  ExportManager.showModal();
}

// ============================================
// 繝・・繧ｿ繧､繝ｳ繝昴・繝域ｩ溯・
// ============================================
const DataImporter = {
  showModal() {
    const modal = document.createElement('div');
    modal.id = 'importModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 500px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">踏 繝・・繧ｿ繧､繝ｳ繝昴・繝・/h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">繧､繝ｳ繝昴・繝亥ｽ｢蠑・/label>
            <select id="importFormat" class="form-input" style="width: 100%; padding: 10px;">
              <option value="csv">CSV・・xcel蜃ｺ蜉帙ヵ繧｡繧､繝ｫ・・/option>
              <option value="json">JSON・医ヰ繝・け繧｢繝・・繝輔ぃ繧､繝ｫ・・/option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">繝輔ぃ繧､繝ｫ驕ｸ謚・/label>
            <input type="file" id="importFile" accept=".csv,.json" style="width: 100%;">
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
              CSV: 鬘ｧ螳｢蜷・諡・ｽ楢・IC諡・ｽ・蝠・刀,繝｡繝｢ 縺ｮ蠖｢蠑・br>
              JSON: 繧ｨ繧ｯ繧ｹ繝昴・繝医＠縺溘ヰ繝・け繧｢繝・・繝輔ぃ繧､繝ｫ
            </p>
          </div>
          <div id="importPreview" style="display: none; margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">繝励Ξ繝薙Η繝ｼ</label>
            <div id="importPreviewContent" style="max-height: 200px; overflow-y: auto; background: var(--bg-secondary); padding: 12px; border-radius: 8px; font-size: 13px;"></div>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="importSkipDuplicates" checked>
              <span>驥崎､・☆繧矩｡ｧ螳｢蜷阪・繧ｹ繧ｭ繝・・</span>
            </label>
          </div>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('importModal').remove()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
          <button class="btn btn-primary" id="importExecuteBtn" onclick="DataImporter.execute()" disabled>繧､繝ｳ繝昴・繝・/button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);

    // 繝輔ぃ繧､繝ｫ驕ｸ謚樊凾縺ｮ繝励Ξ繝薙Η繝ｼ
    document.getElementById('importFile').addEventListener('change', (e) => {
      this.previewFile(e.target.files[0]);
    });
  },

  async previewFile(file) {
    if (!file) return;

    const format = document.getElementById('importFormat').value;
    const previewDiv = document.getElementById('importPreview');
    const previewContent = document.getElementById('importPreviewContent');
    const executeBtn = document.getElementById('importExecuteBtn');

    try {
      const text = await file.text();
      let data;

      if (format === 'csv') {
        data = this.parseCSV(text);
      } else {
        data = this.parseJSON(text);
      }

      if (data.length === 0) {
        previewContent.innerHTML = '<p style="color: var(--danger-color);">繝・・繧ｿ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ</p>';
        executeBtn.disabled = true;
        previewDiv.style.display = 'block';
        return;
      }

      // 繝励Ξ繝薙Η繝ｼ陦ｨ遉ｺ・域怙螟ｧ5莉ｶ・・
      const previewItems = data.slice(0, 5);
      previewContent.innerHTML = `
        <p style="margin-bottom: 8px; font-weight: 500;">${data.length}莉ｶ縺ｮ繝・・繧ｿ繧呈､懷・</p>
        ${previewItems.map(item => `
          <div style="padding: 8px; background: var(--bg-primary); border-radius: 4px; margin-bottom: 4px;">
            ${escapeHtml(item.customer || item.鬘ｧ螳｢蜷・|| '(鬘ｧ螳｢蜷阪↑縺・')} - ${escapeHtml(item.specifications || item.蝠・刀 || 'LIFE')}
          </div>
        `).join('')}
        ${data.length > 5 ? `<p style="color: var(--text-muted);">...莉・${data.length - 5}莉ｶ</p>` : ''}
      `;

      this.pendingData = data;
      executeBtn.disabled = false;
      previewDiv.style.display = 'block';

    } catch (error) {
      previewContent.innerHTML = `<p style="color: var(--danger-color);">繝輔ぃ繧､繝ｫ隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ: ${escapeHtml(error.message || 'Unknown error')}</p>`;
      executeBtn.disabled = true;
      previewDiv.style.display = 'block';
    }
  },

  parseCSV(text) {
    const lines = text.split('\n').filter(line => line.trim());
    if (lines.length < 2) return [];

    // 繝倥ャ繝繝ｼ隗｣譫・
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const data = [];

    for (let i = 1; i < lines.length; i++) {
      const values = this.parseCSVLine(lines[i]);
      if (values.length === 0) continue;

      const row = {};
      headers.forEach((header, idx) => {
        row[header] = values[idx] || '';
      });

      // 鬘ｧ螳｢蜷阪′縺ゅｌ縺ｰ譛牙柑縺ｪ繝・・繧ｿ縺ｨ縺励※霑ｽ蜉
      if (row['鬘ｧ螳｢蜷・] || row['customer']) {
        data.push({
          customer: row['鬘ｧ螳｢蜷・] || row['customer'] || '',
          assigned_to: row['諡・ｽ楢・] || row['assigned_to'] || '',
          ic_assignee: row['IC諡・ｽ・] || row['ic_assignee'] || '',
          specifications: row['蝠・刀'] || row['specifications'] || 'LIFE',
          memo: row['繝｡繝｢'] || row['memo'] || ''
        });
      }
    }

    return data;
  },

  parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === ',' && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    result.push(current.trim());
    return result;
  },

  parseJSON(text) {
    const json = JSON.parse(text);
    // 繧ｨ繧ｯ繧ｹ繝昴・繝亥ｽ｢蠑上・蝣ｴ蜷・
    if (json.projects && Array.isArray(json.projects)) {
      return json.projects;
    }
    // 驟榊・縺ｮ蝣ｴ蜷・
    if (Array.isArray(json)) {
      return json;
    }
    return [];
  },

  async execute() {
    if (!this.pendingData || this.pendingData.length === 0) {
      showToast('繧､繝ｳ繝昴・繝医☆繧九ョ繝ｼ繧ｿ縺後≠繧翫∪縺帙ｓ', 'error');
      return;
    }

    const skipDuplicates = document.getElementById('importSkipDuplicates').checked;
    const existingCustomers = new Set(projects.map(p => p.customer?.toLowerCase()));

    let imported = 0;
    let skipped = 0;

    showStatus('繧､繝ｳ繝昴・繝井ｸｭ...', 'saving');

    for (const item of this.pendingData) {
      // 驥崎､・メ繧ｧ繝・け
      if (skipDuplicates && existingCustomers.has(item.customer?.toLowerCase())) {
        skipped++;
        continue;
      }

      try {
        const newProject = {
          customer: item.customer,
          assigned_to: item.assigned_to || null,
          ic_assignee: item.ic_assignee || null,
          specifications: item.specifications || 'LIFE',
          memo: item.memo || '',
          status: 'active',
          progress: {},
          tasks: {}
        };

        const { data, error } = await supabase
          .from('projects')
          .insert(newProject)
          .select()
          .single();

        if (!error && data) {
          projects.push(data);
          existingCustomers.add(item.customer?.toLowerCase());
          imported++;
        }
      } catch (e) {
        logError('繧､繝ｳ繝昴・繝医お繝ｩ繝ｼ:', e);
      }
    }

    document.getElementById('importModal').remove();
    renderProjects();
    renderSidebar();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');

    let message = `${imported}莉ｶ繧偵う繝ｳ繝昴・繝医＠縺ｾ縺励◆`;
    if (skipped > 0) {
      message += `・・{skipped}莉ｶ縺ｯ驥崎､・・縺溘ａ繧ｹ繧ｭ繝・・・荏;
    }
    showToast(message, 'success');

    this.pendingData = null;
  },

  pendingData: null
};

// ============================================
// 繝舌ャ繝∵桃菴・
// ============================================
const BatchOperations = {
  selected: new Set(),

  toggle(projectId) {
    if (this.selected.has(projectId)) {
      this.selected.delete(projectId);
    } else {
      this.selected.add(projectId);
    }
    this.updateUI();
  },

  selectAll() {
    const visibleCards = document.querySelectorAll('.project-card[data-project-id]');
    visibleCards.forEach(card => {
      this.selected.add(card.dataset.projectId);
    });
    this.updateUI();
    renderProjects();
  },

  deselectAll() {
    this.selected.clear();
    this.updateUI();
    renderProjects();
  },

  isSelected(projectId) {
    return this.selected.has(projectId);
  },

  updateUI() {
    const toolbar = document.getElementById('batchToolbar');
    const count = this.selected.size;

    if (count > 0) {
      if (!toolbar) {
        this.showToolbar();
      }
      document.getElementById('batchCount').textContent = `${count}莉ｶ驕ｸ謚樔ｸｭ`;
    } else {
      if (toolbar) toolbar.remove();
    }

    // 繝√ぉ繝・け繝懊ャ繧ｯ繧ｹ縺ｮ迥ｶ諷九ｒ譖ｴ譁ｰ
    document.querySelectorAll('.batch-checkbox').forEach(cb => {
      cb.checked = this.selected.has(cb.dataset.projectId);
    });
  },

  showToolbar() {
    const toolbar = document.createElement('div');
    toolbar.id = 'batchToolbar';
    toolbar.style.cssText = `
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--bg-primary); border: 1px solid var(--border-color);
      padding: 12px 20px; border-radius: 12px; box-shadow: var(--shadow-lg);
      display: flex; align-items: center; gap: 16px; z-index: 1000;
    `;
    toolbar.innerHTML = `
      <span id="batchCount" style="font-weight: 600;">0莉ｶ驕ｸ謚樔ｸｭ</span>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.showAssignModal()">側 諡・ｽ灘､画峩</button>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.showICTaskModal()">耳 IC荳諡ｬ譖ｴ譁ｰ</button>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.showDeadlineModal()">套 譛滄剞險ｭ螳・/button>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.deselectAll()">笨・驕ｸ謚櫁ｧ｣髯､</button>
    `;
    document.body.appendChild(toolbar);
  },

  showDeadlineModal() {
    if (this.selected.size === 0) return;

    const modal = document.createElement('div');
    modal.id = 'batchDeadlineModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 400px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">套 荳諡ｬ譛滄剞險ｭ螳・/h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <p style="margin-bottom: 16px; color: var(--text-secondary);">${this.selected.size}莉ｶ縺ｮ譯井ｻｶ縺ｫ譛滄剞繧定ｨｭ螳壹＠縺ｾ縺・/p>
          <input type="date" id="batchDeadline" class="form-input" style="width: 100%;">
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('batchDeadlineModal').remove()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
          <button class="btn btn-primary" onclick="BatchOperations.applyDeadline()">險ｭ螳・/button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  },

  async applyDeadline() {
    const deadline = document.getElementById('batchDeadline').value;
    if (!deadline) {
      showToast('譛滄剞繧帝∈謚槭＠縺ｦ縺上□縺輔＞', 'error');
      return;
    }

    document.getElementById('batchDeadlineModal').remove();
    showStatus('蜃ｦ逅・ｸｭ...', 'saving');
    let count = 0;

    for (const projectId of this.selected) {
      DeadlineManager.setDeadline(projectId, deadline);
      count++;
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast(`${count}莉ｶ縺ｫ譛滄剞繧定ｨｭ螳壹＠縺ｾ縺励◆`, 'success');
  },

  async deleteSelected() {
    if (this.selected.size === 0) return;

    const confirmed = confirm(`${this.selected.size}莉ｶ縺ｮ譯井ｻｶ繧貞ｮ悟・縺ｫ蜑企勁縺励∪縺吶°・溘％縺ｮ謫堺ｽ懊・蜈・↓謌ｻ縺帙∪縺帙ｓ縲Ａ);
    if (!confirmed) return;

    const doubleConfirm = confirm('譛ｬ蠖薙↓蜑企勁縺励∪縺吶°・・);
    if (!doubleConfirm) return;

    showStatus('蜃ｦ逅・ｸｭ...', 'saving');
    let count = 0;

    for (const projectId of this.selected) {
      const { error } = await supabase
        .from('projects')
        .delete()
        .eq('id', projectId);

      if (!error) {
        projects = projects.filter(p => p.id !== projectId);
        count++;
      }
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    renderSidebar();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast(`${count}莉ｶ繧貞炎髯､縺励∪縺励◆`, 'success');
  },

  async archiveSelected() {
    if (this.selected.size === 0) return;

    // 逕ｳ隲季O譚｡莉ｶ繧偵メ繧ｧ繝・け
    const projectsToArchive = [];
    const failedProjects = [];
    for (const projectId of this.selected) {
      const project = projects.find(p => p.id === projectId);
      if (project && canPressApplicationGo(project)) {
        projectsToArchive.push(project);
      } else if (project) {
        failedProjects.push(project.customer);
      }
    }

    if (failedProjects.length > 0) {
      showToast(`莉･荳九・譯井ｻｶ縺ｯ逕ｳ隲季O譚｡莉ｶ繧呈ｺ縺溘＠縺ｦ縺・∪縺帙ｓ: ${failedProjects.join(', ')}`, 'warning');
    }

    if (projectsToArchive.length === 0) {
      showToast('螳御ｺ・庄閭ｽ縺ｪ譯井ｻｶ縺後≠繧翫∪縺帙ｓ', 'error');
      return;
    }

    const confirmed = confirm(`${projectsToArchive.length}莉ｶ縺ｮ譯井ｻｶ繧貞ｮ御ｺ・ｸ医∩縺ｫ縺励∪縺吶°・・{failedProjects.length > 0 ? `\n・・{failedProjects.length}莉ｶ縺ｯ譚｡莉ｶ譛ｪ驕斐・縺溘ａ繧ｹ繧ｭ繝・・・荏 : ''}`);
    if (!confirmed) return;

    showStatus('蜃ｦ逅・ｸｭ...', 'saving');
    let count = 0;

    for (const project of projectsToArchive) {
      const { error } = await supabase
        .from('projects')
        .update({ is_archived: true, updated_at: new Date().toISOString() })
        .eq('id', project.id);

      if (!error) {
        project.is_archived = true;
        count++;
      }
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    renderSidebar();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast(`${count}莉ｶ繧貞ｮ御ｺ・ｸ医∩縺ｫ縺励∪縺励◆`, 'success');
  },

  showAssignModal() {
    if (this.selected.size === 0) return;

    const modal = document.createElement('div');
    modal.id = 'batchAssignModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    const designerOptions = designers
      .filter(d => d.category === '險ｭ險・)
      .map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`)
      .join('');

    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 400px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">側 荳諡ｬ諡・ｽ楢・､画峩</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <p style="margin-bottom: 16px; color: var(--text-secondary);">${this.selected.size}莉ｶ縺ｮ譯井ｻｶ縺ｮ諡・ｽ楢・ｒ螟画峩縺励∪縺・/p>
          <select id="batchAssignee" class="form-input" style="width: 100%;">
            <option value="">諡・ｽ楢・ｒ驕ｸ謚・/option>
            ${designerOptions}
          </select>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('batchAssignModal').remove()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
          <button class="btn btn-primary" onclick="BatchOperations.applyAssign()">螟画峩</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  },

  async applyAssign() {
    const assignee = document.getElementById('batchAssignee').value;
    if (!assignee) {
      showToast('諡・ｽ楢・ｒ驕ｸ謚槭＠縺ｦ縺上□縺輔＞', 'error');
      return;
    }

    document.getElementById('batchAssignModal').remove();
    showStatus('蜃ｦ逅・ｸｭ...', 'saving');
    let count = 0;

    for (const projectId of this.selected) {
      const { error } = await supabase
        .from('projects')
        .update({ assigned_to: assignee, updated_at: new Date().toISOString() })
        .eq('id', projectId);

      if (!error) {
        const project = projects.find(p => p.id === projectId);
        if (project) project.assigned_to = assignee;
        count++;
      }
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    renderSidebar();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast(`${count}莉ｶ縺ｮ諡・ｽ楢・ｒ${assignee}縺ｫ螟画峩縺励∪縺励◆`, 'success');
  },

  showICTaskModal() {
    if (this.selected.size === 0) return;

    const icTasks = tasksV2.filter(t => t.category === 'IC').sort((a, b) => a.display_order - b.display_order);
    if (icTasks.length === 0) {
      showToast('IC繧ｿ繧ｹ繧ｯ縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ', 'error');
      return;
    }

    const taskOptions = icTasks.map(t => `<option value="${t.task_key}">${escapeHtml(t.task_name)}</option>`).join('');

    const modal = document.createElement('div');
    modal.id = 'batchICModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 450px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">耳 IC繧ｿ繧ｹ繧ｯ荳諡ｬ譖ｴ譁ｰ</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <p style="margin-bottom: 16px; color: var(--text-secondary);">${this.selected.size}莉ｶ縺ｮ譯井ｻｶ縺ｮIC繧ｿ繧ｹ繧ｯ繧剃ｸ諡ｬ譖ｴ譁ｰ縺励∪縺・/p>
          <div style="margin-bottom: 16px;">
            <label class="form-label">繧ｿ繧ｹ繧ｯ</label>
            <select id="batchICTask" class="form-input" style="width: 100%;" onchange="BatchOperations.updateICStateOptions()">
              <option value="">繧ｿ繧ｹ繧ｯ繧帝∈謚・/option>
              ${taskOptions}
            </select>
          </div>
          <div style="margin-bottom: 16px;">
            <label class="form-label">繧ｹ繝・・繧ｿ繧ｹ</label>
            <select id="batchICState" class="form-input" style="width: 100%;" disabled>
              <option value="">繧ｿ繧ｹ繧ｯ繧貞・縺ｫ驕ｸ謚槭＠縺ｦ縺上□縺輔＞</option>
            </select>
          </div>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('batchICModal').remove()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
          <button class="btn btn-primary" onclick="BatchOperations.applyICTask()">荳諡ｬ譖ｴ譁ｰ</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  },

  updateICStateOptions() {
    const taskKey = document.getElementById('batchICTask').value;
    const stateSelect = document.getElementById('batchICState');

    if (!taskKey) {
      stateSelect.innerHTML = '<option value="">繧ｿ繧ｹ繧ｯ繧貞・縺ｫ驕ｸ謚槭＠縺ｦ縺上□縺輔＞</option>';
      stateSelect.disabled = true;
      return;
    }

    const stateOptions = getTaskStateOptions(taskKey);
    if (stateOptions && Array.isArray(stateOptions)) {
      stateSelect.innerHTML = stateOptions.map(state => `<option value="${state}">${state || '-'}</option>`).join('');
      stateSelect.disabled = false;
    } else {
      stateSelect.innerHTML = '<option value="">繧ｹ繝・・繧ｿ繧ｹ縺ｪ縺・/option>';
      stateSelect.disabled = true;
    }
  },

  async applyICTask() {
    const taskKey = document.getElementById('batchICTask').value;
    const state = document.getElementById('batchICState').value;

    if (!taskKey) {
      showToast('繧ｿ繧ｹ繧ｯ繧帝∈謚槭＠縺ｦ縺上□縺輔＞', 'error');
      return;
    }

    document.getElementById('batchICModal').remove();
    showStatus('蜃ｦ逅・ｸｭ...', 'saving');
    let count = 0;

    for (const projectId of this.selected) {
      const project = projects.find(p => p.id === projectId);
      if (!project) continue;

      const progressData = project.progress || {};
      if (!progressData[taskKey]) progressData[taskKey] = {};
      progressData[taskKey].state = state;

      const { error } = await supabase
        .from('projects')
        .update({ progress: progressData, updated_at: new Date().toISOString() })
        .eq('id', projectId);

      if (!error) {
        project.progress = progressData;
        project.updated_at = new Date().toISOString();
        markLocalUpdate(projectId); // 繝ｪ繧｢繝ｫ繧ｿ繧､繝蜷梧悄縺ｮ莠碁㍾譖ｴ譁ｰ髦ｲ豁｢
        count++;
      }
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');

    const taskDef = tasksV2.find(t => t.task_key === taskKey);
    showToast(`${count}莉ｶ縺ｮ縲・{taskDef?.task_name || taskKey}縲阪ｒ縲・{state || '-'}縲阪↓譖ｴ譁ｰ縺励∪縺励◆`, 'success');
  }
};

// ============================================
// 繝輔ぅ繝ｫ繧ｿ繝ｼ繝励Μ繧ｻ繝・ヨ邂｡逅・
// ============================================
const FilterPresets = {
  presets: safeJsonParse(localStorage.getItem('filterPresets'), []),

  save() {
    localStorage.setItem('filterPresets', JSON.stringify(this.presets));
  },

  getCurrentFilter() {
    return {
      designer: currentDesignerTab,
      archive: document.getElementById('archiveFilter')?.value || 'active',
      search: document.getElementById('searchQuery')?.value || '',
      spec: document.getElementById('specFilter')?.value || ''
    };
  },

  addPreset(name) {
    if (!name || !name.trim()) {
      showToast('繝励Μ繧ｻ繝・ヨ蜷阪ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error');
      return false;
    }

    const filter = this.getCurrentFilter();
    const preset = {
      id: Date.now().toString(),
      name: name.trim(),
      filter: filter,
      createdAt: new Date().toISOString()
    };

    this.presets.unshift(preset);
    this.save();
    this.renderDropdown();
    showToast(`縲・{name}縲阪ｒ菫晏ｭ倥＠縺ｾ縺励◆`, 'success');
    return true;
  },

  deletePreset(id) {
    const preset = this.presets.find(p => p.id === id);
    if (preset && confirm(`縲・{preset.name}縲阪ｒ蜑企勁縺励∪縺吶°・歔)) {
      this.presets = this.presets.filter(p => p.id !== id);
      this.save();
      this.renderDropdown();
      showToast('繝励Μ繧ｻ繝・ヨ繧貞炎髯､縺励∪縺励◆', 'info');
    }
  },

  applyPreset(id) {
    const preset = this.presets.find(p => p.id === id);
    if (!preset) return;

    const { filter } = preset;

    // 諡・ｽ楢・ち繝悶ｒ蛻・ｊ譖ｿ縺・
    if (filter.designer) {
      currentDesignerTab = filter.designer;
      renderDesignerTabs();
    }

    // 繝輔ぅ繝ｫ繧ｿ繝ｼ蛟､繧定ｨｭ螳・
    const archiveFilter = document.getElementById('archiveFilter');
    const searchQuery = document.getElementById('searchQuery');
    const specFilter = document.getElementById('specFilter');

    if (archiveFilter) archiveFilter.value = filter.archive || 'active';
    if (searchQuery) searchQuery.value = filter.search || '';
    if (specFilter) specFilter.value = filter.spec || '';

    renderProjects();
    showToast(`縲・{preset.name}縲阪ｒ驕ｩ逕ｨ縺励∪縺励◆`, 'success');
  },

  showSaveModal() {
    const filter = this.getCurrentFilter();
    const filterDesc = this.describeFilter(filter);

    const modal = document.createElement('div');
    modal.id = 'presetSaveModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">繝輔ぅ繝ｫ繧ｿ繝ｼ繧剃ｿ晏ｭ・/h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
            <strong>迴ｾ蝨ｨ縺ｮ繝輔ぅ繝ｫ繧ｿ繝ｼ:</strong><br>${filterDesc}
          </div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">繝励Μ繧ｻ繝・ヨ蜷・/label>
          <input type="text" id="presetName" class="form-input" style="width: 100%;" placeholder="萓・ 逕ｰ荳ｭ縺輔ｓ縺ｮ騾ｲ陦御ｸｭ譯井ｻｶ" autofocus>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('presetSaveModal').remove()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
          <button class="btn btn-primary" onclick="FilterPresets.confirmSave()">菫晏ｭ・/button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);

    // Enter繧ｭ繝ｼ縺ｧ菫晏ｭ・
    document.getElementById('presetName').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') FilterPresets.confirmSave();
    });
  },

  confirmSave() {
    const name = document.getElementById('presetName').value;
    if (this.addPreset(name)) {
      document.getElementById('presetSaveModal').remove();
    }
  },

  describeFilter(filter) {
    const parts = [];
    if (filter.designer && filter.designer !== 'ALL') {
      parts.push(`諡・ｽ・ ${filter.designer}`);
    }
    if (filter.archive && filter.archive !== 'active') {
      const labels = { all: '蜈ｨ縺ｦ', archived: '螳御ｺ・ｸ医∩' };
      parts.push(labels[filter.archive] || filter.archive);
    }
    if (filter.search) {
      parts.push(`讀懃ｴ｢: "${filter.search}"`);
    }
    if (filter.spec) {
      parts.push(`莉墓ｧ・ ${filter.spec}`);
    }
    return parts.length > 0 ? parts.join('縲・) : '繝輔ぅ繝ｫ繧ｿ繝ｼ縺ｪ縺・;
  },

  renderDropdown() {
    const container = document.getElementById('presetDropdown');
    if (!container) return;

    if (this.presets.length === 0) {
      container.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); font-size: 13px;">菫晏ｭ俶ｸ医∩繝励Μ繧ｻ繝・ヨ縺ｯ縺ゅｊ縺ｾ縺帙ｓ</div>';
      return;
    }

    container.innerHTML = this.presets.map(preset => `
      <div class="preset-item" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid var(--border-color); cursor: pointer;"
           onmouseenter="this.style.background='var(--bg-secondary)'"
           onmouseleave="this.style.background='white'">
        <div style="flex: 1;" onclick="FilterPresets.applyPreset('${preset.id}'); document.getElementById('presetMenu').style.display='none';">
          <div style="font-weight: 500; font-size: 14px;">${preset.name}</div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${this.describeFilter(preset.filter)}</div>
        </div>
        <button class="btn btn-ghost btn-small" style="padding: 4px 8px; font-size: 12px;" onclick="event.stopPropagation(); FilterPresets.deletePreset('${preset.id}')">蜑企勁</button>
      </div>
    `).join('');
  },

  toggleMenu() {
    const menu = document.getElementById('presetMenu');
    if (!menu) return;

    if (menu.style.display === 'none' || !menu.style.display) {
      this.renderDropdown();
      menu.style.display = 'block';
      // 螟門・繧ｯ繝ｪ繝・け縺ｧ髢峨§繧・
      setTimeout(() => {
        document.addEventListener('click', this.closeMenuOnClickOutside);
      }, 10);
    } else {
      menu.style.display = 'none';
      document.removeEventListener('click', this.closeMenuOnClickOutside);
    }
  },

  closeMenuOnClickOutside(e) {
    const menu = document.getElementById('presetMenu');
    const btn = document.getElementById('presetBtn');
    if (menu && !menu.contains(e.target) && !btn.contains(e.target)) {
      menu.style.display = 'none';
      document.removeEventListener('click', FilterPresets.closeMenuOnClickOutside);
    }
  }
};

// ============================================
// 繧ｯ繧､繝・け邱ｨ髮・
// ============================================
const QuickEdit = {
  showAssigneeDropdown(projectId, element, assigneeType = 'assigned_to') {
    // 譌｢蟄倥・繝峨Ο繝・・繝繧ｦ繝ｳ繧貞炎髯､
    document.querySelectorAll('.quick-edit-dropdown').forEach(el => el.remove());

    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const rect = element.getBoundingClientRect();

    // 諡・ｽ楢・ち繧､繝励↓蠢懊§縺ｦ繝輔ぅ繝ｫ繧ｿ
    const categoryMap = {
      'assigned_to': '險ｭ險・,
      'ic_assignee': 'IC',
      'exterior_assignee': '螟匁ｧ・,
      'realestate_assignee': '荳榊虚逕｣'
    };
    const labelMap = {
      'assigned_to': '險ｭ險域球蠖楢・,
      'ic_assignee': 'IC諡・ｽ楢・,
      'exterior_assignee': '螟匁ｧ区球蠖楢・,
      'realestate_assignee': '荳榊虚逕｣諡・ｽ楢・
    };
    const category = categoryMap[assigneeType] || '險ｭ險・;
    const label = labelMap[assigneeType] || '諡・ｽ楢・;
    const designerList = designers.filter(d => d.category === category);
    const currentAssignee = project[assigneeType] || '';

    const dropdown = document.createElement('div');
    dropdown.className = 'quick-edit-dropdown';
    dropdown.style.cssText = `position: fixed; top: ${rect.bottom + 4}px; left: ${rect.left}px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; min-width: 150px; max-height: 300px; overflow-y: auto;`;

    dropdown.innerHTML = `
      <div style="padding: 8px 12px; border-bottom: 1px solid var(--border-color); font-size: 12px; color: var(--text-secondary);">${label}繧貞､画峩</div>
      <div class="quick-edit-option" style="padding: 10px 12px; cursor: pointer; font-size: 14px; ${!currentAssignee ? 'background: var(--primary-light); font-weight: 500;' : ''}"
           onmouseenter="this.style.background='var(--bg-secondary)'"
           onmouseleave="this.style.background='${!currentAssignee ? 'var(--primary-light)' : ''}'"
           onclick="QuickEdit.changeAssignee('${projectId}', '', '${assigneeType}')">・域悴險ｭ螳夲ｼ・/div>
      ${designerList.map(d => `
        <div class="quick-edit-option" style="padding: 10px 12px; cursor: pointer; font-size: 14px; ${currentAssignee === d.name ? 'background: var(--primary-light); font-weight: 500;' : ''}"
             onmouseenter="this.style.background='var(--bg-secondary)'"
             onmouseleave="this.style.background='${currentAssignee === d.name ? 'var(--primary-light)' : ''}'"
             onclick="QuickEdit.changeAssignee('${projectId}', '${d.name}', '${assigneeType}')">${d.name}</div>
      `).join('')}
    `;

    document.body.appendChild(dropdown);

    // 螟門・繧ｯ繝ｪ繝・け縺ｧ髢峨§繧・
    setTimeout(() => {
      document.addEventListener('click', QuickEdit.closeDropdown);
    }, 10);
  },

  closeDropdown(e) {
    if (!e.target.closest('.quick-edit-dropdown') && !e.target.closest('.quick-edit-trigger')) {
      document.querySelectorAll('.quick-edit-dropdown').forEach(el => el.remove());
      document.removeEventListener('click', QuickEdit.closeDropdown);
    }
  },

  async changeAssignee(projectId, assignee, assigneeType = 'assigned_to') {
    document.querySelectorAll('.quick-edit-dropdown').forEach(el => el.remove());

    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const labelMap = {
      'assigned_to': '險ｭ險域球蠖楢・,
      'ic_assignee': 'IC諡・ｽ楢・,
      'exterior_assignee': '螟匁ｧ区球蠖楢・,
      'realestate_assignee': '荳榊虚逕｣諡・ｽ楢・
    };
    const label = labelMap[assigneeType] || '諡・ｽ楢・;
    const oldAssignee = project[assigneeType];
    showStatus('菫晏ｭ倅ｸｭ...', 'saving');

    const updateData = { updated_at: new Date().toISOString() };
    updateData[assigneeType] = assignee || null;

    const { error } = await supabase
      .from('projects')
      .update(updateData)
      .eq('id', projectId);

    if (error) {
      showStatus('繧ｨ繝ｩ繝ｼ', 'error');
      showToast('螟画峩縺ｫ螟ｱ謨励＠縺ｾ縺励◆', 'error');
      return;
    }

    UndoManager.record({
      type: 'UPDATE_PROJECT',
      projectId,
      description: `${project.customer} - ${label}繧・{oldAssignee || '譛ｪ險ｭ螳・}縺九ｉ${assignee || '譛ｪ險ｭ螳・}縺ｫ螟画峩`,
      oldValue: { [assigneeType]: oldAssignee },
      newValue: { [assigneeType]: assignee || null }
    });

    project[assigneeType] = assignee || null;
    project.updated_at = new Date().toISOString();
    renderProjects();
    renderSidebar();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast(`${label}繧・{assignee || '譛ｪ險ｭ螳・}縺ｫ螟画峩縺励∪縺励◆`, 'success');
  }
};

// ============================================
// 譛滄剞繝ｻ繝ｪ繝槭う繝ｳ繝繝ｼ邂｡逅・
// ============================================
const DeadlineManager = {
  reminders: safeJsonParse(localStorage.getItem('projectReminders'), {}),

  setDeadline(projectId, deadline) {
    this.reminders[projectId] = { deadline, notified: false };
    this.save();
  },

  getDeadline(projectId) {
    return this.reminders[projectId]?.deadline || null;
  },

  save() {
    localStorage.setItem('projectReminders', JSON.stringify(this.reminders));
  },

  checkReminders() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    projects.forEach(project => {
      const reminder = this.reminders[project.id];
      if (!reminder || reminder.notified || project.is_archived) return;

      const deadline = new Date(reminder.deadline);
      deadline.setHours(0, 0, 0, 0);
      const diffDays = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));

      if (diffDays <= 3 && diffDays >= 0) {
        const msg = diffDays === 0 ? '譛ｬ譌･縺梧悄髯舌〒縺・ : `縺ゅ→${diffDays}譌･縺ｧ譛滄剞縺ｧ縺兪;
        showToast(`套 ${project.customer}: ${msg}`, 'warning');
        this.reminders[project.id].notified = true;
        this.save();
      } else if (diffDays < 0) {
        showToast(`笞・・${project.customer}: 譛滄剞繧・{Math.abs(diffDays)}譌･驕弱℃縺ｦ縺・∪縺兪, 'error');
        this.reminders[project.id].notified = true;
        this.save();
      }
    });
  },

  getStatus(projectId) {
    const deadline = this.getDeadline(projectId);
    if (!deadline) return null;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const due = new Date(deadline);
    due.setHours(0, 0, 0, 0);
    const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

    if (diffDays < 0) return { class: 'overdue', label: `${Math.abs(diffDays)}譌･雜・℃`, color: '#EF4444' };
    if (diffDays === 0) return { class: 'today', label: '譛ｬ譌･', color: '#F59E0B' };
    if (diffDays <= 3) return { class: 'soon', label: `縺ゅ→${diffDays}譌･`, color: '#F59E0B' };
    return { class: 'normal', label: `${due.getMonth() + 1}/${due.getDate()}`, color: '#6B7280' };
  },

  showModal(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const currentDeadline = this.getDeadline(projectId) || '';

    const modal = document.createElement('div');
    modal.id = 'deadlineModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 360px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">譛滄剞繧定ｨｭ螳・/h3>
          <p style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;">${escapeHtml(project.customer)}</p>
        </div>
        <div style="padding: 20px;">
          <input type="date" id="deadlineInput" class="form-input" style="width: 100%;" value="${currentDeadline}">
          <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">譛滄剞縺ｮ3譌･蜑阪°繧蛾夂衍縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/p>
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between;">
          <button class="btn btn-ghost" onclick="DeadlineManager.clearDeadline('${projectId}')">繧ｯ繝ｪ繧｢</button>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-ghost" onclick="document.getElementById('deadlineModal').remove()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
            <button class="btn btn-primary" onclick="DeadlineManager.saveFromModal('${projectId}')">菫晏ｭ・/button>
          </div>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  },

  saveFromModal(projectId) {
    const deadline = document.getElementById('deadlineInput').value;
    if (deadline) {
      this.setDeadline(projectId, deadline);
      showToast('譛滄剞繧定ｨｭ螳壹＠縺ｾ縺励◆', 'success');
    }
    document.getElementById('deadlineModal').remove();
    renderProjects();
  },

  clearDeadline(projectId) {
    delete this.reminders[projectId];
    this.save();
    document.getElementById('deadlineModal').remove();
    renderProjects();
    showToast('譛滄剞繧偵け繝ｪ繧｢縺励∪縺励◆', 'info');
  }
};

// ============================================
// 譯井ｻｶ繝・Φ繝励Ξ繝ｼ繝・
// ============================================
const TemplateManager = {
  templates: safeJsonParse(localStorage.getItem('projectTemplates'), []),

  save() {
    localStorage.setItem('projectTemplates', JSON.stringify(this.templates));
  },

  createFromProject(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const name = prompt('繝・Φ繝励Ξ繝ｼ繝亥錐繧貞・蜉帙＠縺ｦ縺上□縺輔＞:', `${project.specifications || 'LIFE'}繝・Φ繝励Ξ繝ｼ繝・);
    if (!name) return;

    const template = {
      id: Date.now().toString(),
      name: name,
      specifications: project.specifications,
      progress: project.progress || {},
      createdAt: new Date().toISOString()
    };

    this.templates.push(template);
    this.save();
    showToast(`繝・Φ繝励Ξ繝ｼ繝医・{name}縲阪ｒ菴懈・縺励∪縺励◆`, 'success');
  },

  applyTemplate(templateId, projectId) {
    const template = this.templates.find(t => t.id === templateId);
    const project = projects.find(p => p.id === projectId);
    if (!template || !project) return;

    project.specifications = template.specifications;
    project.progress = JSON.parse(JSON.stringify(template.progress));

    this.saveProject(project);
    showToast(`繝・Φ繝励Ξ繝ｼ繝医・{template.name}縲阪ｒ驕ｩ逕ｨ縺励∪縺励◆`, 'success');
  },

  async saveProject(project) {
    const { error } = await supabase
      .from('projects')
      .update({
        specifications: project.specifications,
        progress: project.progress,
        updated_at: new Date().toISOString()
      })
      .eq('id', project.id);

    if (!error) {
      renderProjects();
    }
  },

  deleteTemplate(templateId) {
    const template = this.templates.find(t => t.id === templateId);
    if (template && confirm(`繝・Φ繝励Ξ繝ｼ繝医・{template.name}縲阪ｒ蜑企勁縺励∪縺吶°・歔)) {
      this.templates = this.templates.filter(t => t.id !== templateId);
      this.save();
      showToast('繝・Φ繝励Ξ繝ｼ繝医ｒ蜑企勁縺励∪縺励◆', 'info');
    }
  },

  showSelectModal(projectId) {
    if (this.templates.length === 0) {
      showToast('菫晏ｭ俶ｸ医∩繝・Φ繝励Ξ繝ｼ繝医′縺ゅｊ縺ｾ縺帙ｓ', 'info');
      return;
    }

    const modal = document.createElement('div');
    modal.id = 'templateSelectModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">繝・Φ繝励Ξ繝ｼ繝医ｒ驕ｩ逕ｨ</h3>
        </div>
        <div style="padding: 12px; max-height: 300px; overflow-y: auto;">
          ${this.templates.map(t => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 500;">${t.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${t.specifications || 'LIFE'}</div>
              </div>
              <button class="btn btn-primary btn-small" onclick="TemplateManager.applyTemplate('${t.id}', '${projectId}'); document.getElementById('templateSelectModal').remove();">驕ｩ逕ｨ</button>
            </div>
          `).join('')}
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color);">
          <button class="btn btn-ghost" style="width: 100%;" onclick="document.getElementById('templateSelectModal').remove()">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  },

  showManageModal() {
    const modal = document.createElement('div');
    modal.id = 'templateManageModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">繝・Φ繝励Ξ繝ｼ繝育ｮ｡逅・/h3>
        </div>
        <div style="padding: 12px; max-height: 400px; overflow-y: auto;">
          ${this.templates.length === 0 ? '<p style="padding: 20px; text-align: center; color: var(--text-secondary);">繝・Φ繝励Ξ繝ｼ繝医′縺ゅｊ縺ｾ縺帙ｓ<br><small>譯井ｻｶ縺ｮ邱ｨ髮・判髱｢縺九ｉ縲後ユ繝ｳ繝励Ξ繝ｼ繝井ｿ晏ｭ倥阪〒菴懈・縺ｧ縺阪∪縺・/small></p>' : this.templates.map(t => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 500;">${t.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${t.specifications || 'LIFE'} | ${new Date(t.createdAt).toLocaleDateString()}</div>
              </div>
              <button class="btn btn-ghost btn-small" style="color: #EF4444;" onclick="TemplateManager.deleteTemplate('${t.id}'); document.getElementById('templateManageModal').remove(); TemplateManager.showManageModal();">蜑企勁</button>
            </div>
          `).join('')}
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color);">
          <button class="btn btn-ghost" style="width: 100%;" onclick="document.getElementById('templateManageModal').remove()">髢峨§繧・/button>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  }
};

// ============================================
// 繝｢繝舌う繝ｫ繧ｹ繝ｯ繧､繝玲桃菴・
// ============================================
const MobileGestures = {
  startX: 0,
  startY: 0,
  currentCard: null,

  init() {
    document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
    document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
    document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: true });
  },

  handleTouchStart(e) {
    const card = e.target.closest('.project-card');
    if (!card) return;

    this.startX = e.touches[0].clientX;
    this.startY = e.touches[0].clientY;
    this.currentCard = card;
  },

  handleTouchMove(e) {
    if (!this.currentCard) return;

    const diffX = e.touches[0].clientX - this.startX;
    const diffY = e.touches[0].clientY - this.startY;

    // 讓ｪ譁ｹ蜷代・繧ｹ繝ｯ繧､繝励ｒ讀懷・
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 30) {
      e.preventDefault();
      const maxSwipe = 100;
      const translateX = Math.max(-maxSwipe, Math.min(maxSwipe, diffX));
      this.currentCard.style.transform = `translateX(${translateX}px)`;
      this.currentCard.style.transition = 'none';

      // 繧ｹ繝ｯ繧､繝玲婿蜷代↓蠢懊§縺溯レ譎ｯ濶ｲ
      if (diffX > 50) {
        this.currentCard.style.background = 'linear-gradient(to right, #10B981 0%, white 30%)';
      } else if (diffX < -50) {
        this.currentCard.style.background = 'linear-gradient(to left, #F59E0B 0%, white 30%)';
      } else {
        this.currentCard.style.background = '';
      }
    }
  },

  handleTouchEnd(e) {
    if (!this.currentCard) return;

    const diffX = e.changedTouches[0].clientX - this.startX;
    const projectId = this.currentCard.dataset.projectId;

    this.currentCard.style.transform = '';
    this.currentCard.style.transition = 'transform 0.2s ease';
    this.currentCard.style.background = '';

    if (diffX < -80 && projectId) {
      // 蟾ｦ繧ｹ繝ｯ繧､繝・ 螳御ｺ・・繧頑崛縺・
      const project = projects.find(p => p.id === projectId);
      if (project && calculateProgress(project) >= 100) {
        toggleArchive(projectId, !project.is_archived);
      } else {
        showToast('螳御ｺ・↓縺吶ｋ縺ｫ縺ｯ騾ｲ謐・00%縺悟ｿ・ｦ√〒縺・, 'info');
      }
    }

    this.currentCard = null;
  }
};

// ============================================
// 繧ｻ繝・す繝ｧ繝ｳ繧ｿ繧､繝繧｢繧ｦ繝育ｮ｡逅・
// ============================================
const SessionManager = {
  timeoutMinutes: 60,
  warningMinutes: 5,
  lastActivity: Date.now(),
  timeoutId: null,
  warningId: null,
  warningShown: false,

  init() {
    this.resetTimer();
    this.setupActivityListeners();
    log('白 繧ｻ繝・す繝ｧ繝ｳ邂｡逅・幕蟋具ｼ医ち繧､繝繧｢繧ｦ繝・ ' + this.timeoutMinutes + '蛻・ｼ・);
  },

  setupActivityListeners() {
    const events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];
    events.forEach(event => {
      document.addEventListener(event, () => this.onActivity(), { passive: true });
    });
  },

  onActivity() {
    this.lastActivity = Date.now();
    if (this.warningShown) {
      this.hideWarning();
    }
    this.resetTimer();
  },

  resetTimer() {
    if (this.timeoutId) clearTimeout(this.timeoutId);
    if (this.warningId) clearTimeout(this.warningId);

    // 隴ｦ蜻願｡ｨ遉ｺ繧ｿ繧､繝槭・
    const warningMs = (this.timeoutMinutes - this.warningMinutes) * 60 * 1000;
    this.warningId = setTimeout(() => this.showWarning(), warningMs);

    // 繧ｿ繧､繝繧｢繧ｦ繝医ち繧､繝槭・
    const timeoutMs = this.timeoutMinutes * 60 * 1000;
    this.timeoutId = setTimeout(() => this.onTimeout(), timeoutMs);
  },

  showWarning() {
    if (this.warningShown) return;
    this.warningShown = true;

    const warning = document.createElement('div');
    warning.id = 'sessionWarning';
    warning.style.cssText = `
      position: fixed; bottom: 20px; right: 20px; z-index: 10001;
      background: var(--warning-color); color: white;
      padding: 16px 20px; border-radius: 8px;
      box-shadow: var(--shadow-lg); max-width: 320px;
    `;
    warning.innerHTML = `
      <div style="font-weight: 600; margin-bottom: 8px;">竢ｰ 繧ｻ繝・す繝ｧ繝ｳ譛滄剞</div>
      <div style="font-size: 14px; margin-bottom: 12px;">
        ${this.warningMinutes}蛻・俣謫堺ｽ懊′縺ｪ縺・→繝ｭ繧ｰ繧｢繧ｦ繝医＠縺ｾ縺・
      </div>
      <button onclick="SessionManager.extendSession()"
        style="background: var(--bg-primary); color: var(--warning-color); border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
        繧ｻ繝・す繝ｧ繝ｳ繧貞ｻｶ髟ｷ
      </button>
    `;
    document.body.appendChild(warning);
  },

  hideWarning() {
    this.warningShown = false;
    const warning = document.getElementById('sessionWarning');
    if (warning) warning.remove();
  },

  extendSession() {
    this.onActivity();
    showToast('繧ｻ繝・す繝ｧ繝ｳ繧貞ｻｶ髟ｷ縺励∪縺励◆', 'success');
  },

  onTimeout() {
    this.hideWarning();
    showToast('繧ｻ繝・す繝ｧ繝ｳ縺後ち繧､繝繧｢繧ｦ繝医＠縺ｾ縺励◆縲ょ・蠎ｦ繝ｭ繧ｰ繧､繝ｳ縺励※縺上□縺輔＞縲・, 'warning');
    setTimeout(() => signOut(), 2000);
  },

  stop() {
    if (this.timeoutId) clearTimeout(this.timeoutId);
    if (this.warningId) clearTimeout(this.warningId);
    this.hideWarning();
  }
};

// ============================================
// 繝峨Λ繝・げ&繝峨Ο繝・・荳ｦ縺ｳ譖ｿ縺・
// ============================================
let draggedProject = null;

let dragAndDropInitialized = false;

function enableDragAndDrop() {
  const container = document.getElementById('projectsContainer');
  if (!container || dragAndDropInitialized) return;

  dragAndDropInitialized = true;

  // 繧､繝吶Φ繝医ョ繝ｪ繧ｲ繝ｼ繧ｷ繝ｧ繝ｳ縺ｧ隕ｪ隕∫ｴ縺ｫ1縺､縺縺代Μ繧ｹ繝翫・繧堤匳骭ｲ・医Γ繝｢繝ｪ繝ｪ繝ｼ繧ｯ髦ｲ豁｢・・
  container.addEventListener('dragstart', (e) => {
    const card = e.target.closest('.project-card');
    if (card) handleProjectDragStart.call(card, e);
  });

  container.addEventListener('dragover', (e) => {
    const card = e.target.closest('.project-card');
    if (card) handleProjectDragOver.call(card, e);
  });

  container.addEventListener('drop', (e) => {
    const card = e.target.closest('.project-card');
    if (card) handleProjectDrop.call(card, e);
  });

  container.addEventListener('dragend', (e) => {
    const card = e.target.closest('.project-card');
    if (card) handleProjectDragEnd.call(card, e);
  });

  // 繧ｫ繝ｼ繝峨↓draggable螻樊ｧ繧剃ｻ倅ｸ趣ｼ・utationObserver縺ｧ逶｣隕厄ｼ・
  const updateDraggable = () => {
    const cards = container.querySelectorAll('.project-card');
    cards.forEach((card, index) => {
      card.setAttribute('draggable', 'true');
      card.dataset.projectIndex = index;
    });
  };

  updateDraggable();

  // DOM螟画峩譎ゅ↓draggable螻樊ｧ繧剃ｻ倅ｸ趣ｼ医う繝吶Φ繝医Μ繧ｹ繝翫・縺ｯ霑ｽ蜉縺励↑縺・ｼ・
  const observer = new MutationObserver(updateDraggable);
  observer.observe(container, { childList: true, subtree: true });
}

function handleProjectDragStart(e) {
  draggedProject = this;
  this.style.opacity = '0.4';
  e.dataTransfer.effectAllowed = 'move';
}

function handleProjectDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleProjectDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }

  if (draggedProject !== this) {
    const draggedIndex = parseInt(draggedProject.dataset.projectIndex);
    const targetIndex = parseInt(this.dataset.projectIndex);

    // 驟榊・縺ｮ鬆・ｺ上ｒ蜈･繧梧崛縺・
    const temp = projects[draggedIndex];
    projects.splice(draggedIndex, 1);
    projects.splice(targetIndex, 0, temp);

    // 蜀肴緒逕ｻ
    renderProjects();
  }

  return false;
}

function handleProjectDragEnd(e) {
  this.style.opacity = '1';

  // 縺吶∋縺ｦ縺ｮ繝峨Λ繝・げ迥ｶ諷九ｒ繝ｪ繧ｻ繝・ヨ
  const cards = document.querySelectorAll('.project-card');
  cards.forEach(card => {
    card.classList.remove('over');
  });
}

// ============================================
// URL逶ｴ謗･繧｢繧ｯ繧ｻ繧ｹ讖溯・・医ワ繝・す繝･繝ｫ繝ｼ繝・ぅ繝ｳ繧ｰ・・
// ============================================
function updateURLWithDesigner(designerName) {
  const currentHash = window.location.hash.substring(1); // #繧帝勁蜴ｻ
  const [pathPart] = currentHash.split('?');
  const mainTab = pathPart.split('/')[0] || 'projects';

  // 譁ｰ縺励＞URL繧呈ｧ狗ｯ・
  let newHash = mainTab;
  if (designerName !== 'ALL') {
    newHash += `?designer=${encodeURIComponent(designerName)}`;
  }

  // hashchange繧､繝吶Φ繝医ｒ逋ｺ轣ｫ縺輔○縺壹↓URL繧呈峩譁ｰ
  history.replaceState(null, '', `#${newHash}`);
}

function handleHashChange() {
  // 辟｡髯舌Ν繝ｼ繝鈴亟豁｢
  if (isHandlingHashChange) {
    log('竢ｸ・・handleHashChange: 縺吶〒縺ｫ蜃ｦ逅・ｸｭ縺ｮ縺溘ａ繧ｹ繧ｭ繝・・');
    return;
  }

  const hash = window.location.hash.substring(1); // #繧帝勁蜴ｻ
  log('迫 handleHashChange 髢句ｧ・', {
    hash: hash,
    timestamp: new Date().toISOString(),
    vendorsV2Length: vendorsV2.length,
    taskVendorMappingsLength: taskVendorMappings.length
  });

  if (!hash) return;

  isHandlingHashChange = true;

  // URL繝代Λ繝｡繝ｼ繧ｿ繧貞・髮｢・井ｾ・ projects?designer=邂墓ｵｦ・・
  const [pathPart, queryPart] = hash.split('?');
  const [mainTab, subTab] = pathPart.split('/');

  // URL繝代Λ繝｡繝ｼ繧ｿ繧定ｧ｣譫・
  const params = new URLSearchParams(queryPart || '');
  const designerParam = params.get('designer');

  // 諡・ｽ楢・ヵ繧｣繝ｫ繧ｿ繝ｼ繧貞ｾｩ蜈・
  if (designerParam) {
    currentDesignerTab = designerParam;
    // 繧ｵ繧､繝峨ヰ繝ｼ縺ｨ譯井ｻｶ陦ｨ遉ｺ繧呈峩譁ｰ・医ち繝門・繧頑崛縺亥ｾ後↓螳溯｡鯉ｼ・
    setTimeout(() => {
      renderSidebar();
      if (mainTab === 'projects') {
        renderProjects();
      }
    }, 150);
  }

  // 繝｡繧､繝ｳ繧ｿ繝悶・蛻・ｊ譖ｿ縺・
  if (mainTab === 'projects') {
    const btn = document.querySelector('.header-nav-btn');
    if (btn) switchMainTab('projects', btn);
  } else if (mainTab === 'calendar') {
    const btn = document.querySelectorAll('.header-nav-btn')[1];
    if (btn) switchMainTab('calendar', btn);
    isHandlingHashChange = false;
    return;
  } else if (mainTab === 'analytics') {
    const btn = document.querySelectorAll('.header-nav-btn')[2];
    if (btn) switchMainTab('analytics', btn);
    isHandlingHashChange = false;
    return;
  } else if (mainTab === 'settings') {
    const btn = document.querySelectorAll('.header-nav-btn')[3];
    if (btn) switchMainTab('settings', btn);

    // 繧ｵ繝悶ち繝厄ｼ郁ｨｭ螳壹ヱ繝阪Ν・峨・蛻・ｊ譖ｿ縺・
    if (subTab) {
      setTimeout(() => {
        // 譛牙柑縺ｪ繝代ロ繝ｫ蜷阪・繝ｪ繧ｹ繝・
        const validPanels = ['staff', 'vendors', 'categories', 'tasks', 'icTasks', 'exteriorTasks', 'realestateTasks', 'constructionTasks', 'products', 'customize', 'kintone', 'account'];
        if (validPanels.includes(subTab)) {
          openSettingsPanel(subTab);
        }
        // 繝輔Λ繧ｰ繧偵Μ繧ｻ繝・ヨ・磯≦蟒ｶ蠕鯉ｼ・
        setTimeout(() => {
          isHandlingHashChange = false;
          log('笨・handleHashChange螳御ｺ・);
        }, 150);
      }, 100);
    } else {
      // 繧ｵ繝悶ち繝悶′縺ｪ縺・ｴ蜷医・縺吶＄縺ｫ繝輔Λ繧ｰ繧偵Μ繧ｻ繝・ヨ
      setTimeout(() => {
        isHandlingHashChange = false;
        log('笨・handleHashChange螳御ｺ・);
      }, 150);
    }
  } else {
    // 荳肴・縺ｪ繧ｿ繝悶・蝣ｴ蜷医・縺吶＄縺ｫ繝輔Λ繧ｰ繧偵Μ繧ｻ繝・ヨ
    isHandlingHashChange = false;
  }
}

// 繝上ャ繧ｷ繝･螟画峩譎ゅ・繝ｪ繧ｹ繝翫・
window.addEventListener('hashchange', handleHashChange);

// ============================================
// ArchiDeck v3.0 譁ｰ讖溯・
// ============================================

// 繧ｰ繝ｭ繝ｼ繝舌Ν螟画焚霑ｽ蜉
let projectTasks = [];
let projectMinutes = [];
let kintoneSettings = null;
let currentTaskSort = 'due';

// 繝・じ繧､繝翫・繧ｫ繝・ざ繝ｪ蛻･蜿門ｾ励・繝ｫ繝代・髢｢謨ｰ
function getDesignersByCategory(category) {
  return designers.filter(d => d.category === category).sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
}
function getSekkeiDesigners() {
  return getDesignersByCategory('險ｭ險・);
}
function getIcDesigners() {
  return getDesignersByCategory('IC');
}
function getExteriorDesigners() {
  return getDesignersByCategory('螟匁ｧ・);
}
function getRealestateDesigners() {
  return getDesignersByCategory('荳榊虚逕｣');
}
function getConstructionDesigners() {
  return getDesignersByCategory('蟾･莠・);
}
function getSalesDesigners() {
  return getDesignersByCategory('蝟ｶ讌ｭ');
}

// 繧ｵ繧､繝峨ヰ繝ｼ縺ｫ驛ｨ鄂ｲ蛻･謚倥ｊ縺溘◆縺ｿ讖溯・繧定ｿｽ蜉・亥・閨ｷ遞ｮ蟇ｾ蠢懶ｼ・
const originalRenderSidebar = renderSidebar;

// 繧ｵ繧､繝峨ヰ繝ｼ謚倥ｊ縺溘◆縺ｿ迥ｶ諷狗ｮ｡逅・
function getSidebarCollapseState() {
  const saved = localStorage.getItem('archideck_sidebar_collapse');
  return saved ? JSON.parse(saved) : {};
}

function setSidebarCollapseState(category, collapsed) {
  const state = getSidebarCollapseState();
  state[category] = collapsed;
  localStorage.setItem('archideck_sidebar_collapse', JSON.stringify(state));
}

function toggleSidebarSection(category) {
  const state = getSidebarCollapseState();
  const newState = !state[category];
  setSidebarCollapseState(category, newState);
  renderSidebar();
}

// 蛻晄悄陦ｨ遉ｺ縺ｧ繝ｭ繧ｰ繧､繝ｳ繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ閨ｷ遞ｮ繧帝幕縺・
function getInitialExpandedCategories() {
  const state = getSidebarCollapseState();
  // 譌｢縺ｫlocalStorage縺ｫ迥ｶ諷九′縺ゅｋ蝣ｴ蜷医・縺昴ｌ繧剃ｽｿ逕ｨ
  if (Object.keys(state).length > 0) return state;

  // 蛻晏屓: 繝ｭ繧ｰ繧､繝ｳ繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ閨ｷ遞ｮ繧帝幕縺・
  const defaultState = { '險ｭ險・: true, 'IC': true, '螟匁ｧ・: true, '荳榊虚逕｣': true, '蟾･莠・: true, '蝟ｶ讌ｭ': true };
  if (currentUserCategory && currentUserCategory !== 'admin') {
    // 閾ｪ蛻・・閨ｷ遞ｮ莉･螟悶・髢峨§繧・
    Object.keys(defaultState).forEach(cat => {
      defaultState[cat] = (cat !== currentUserCategory);
    });
  } else {
    // 邂｡逅・・・蜈ｨ縺ｦ髢九￥
    Object.keys(defaultState).forEach(cat => defaultState[cat] = false);
  }
  return defaultState;
}

renderSidebar = function() {
  const container = document.getElementById('sidebarContent');
  if (!container) return;

  const sekkeiDesigners = getSekkeiDesigners();
  const icDesigners = getIcDesigners();
  const exteriorDesigners = getExteriorDesigners();
  const realestateDesigners = getRealestateDesigners();
  const constructionDesigners = getConstructionDesigners();
  const salesDesigners = getSalesDesigners();
  const allCount = projects.filter(p => p.status !== 'completed' && !p.is_archived).length;
  const archivedCount = projects.filter(p => p.is_archived).length;

  const collapseState = getSidebarCollapseState();
  const initialState = getInitialExpandedCategories();

  // 謚倥ｊ縺溘◆縺ｿ迥ｶ諷九ｒ豎ｺ螳夲ｼ・ocalStorage縺ｫ辟｡縺代ｌ縺ｰ蛻晄悄迥ｶ諷九ｒ菴ｿ逕ｨ・・
  const isCollapsed = (cat) => {
    if (collapseState[cat] !== undefined) return collapseState[cat];
    return initialState[cat] || false;
  };

  let html = `
    <div class="sidebar-section">
      <div class="sidebar-item ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="selectDesigner('ALL')">
        <span class="sidebar-item-label">蜈ｨ譯井ｻｶ</span>
        <span class="sidebar-item-count">${allCount}</span>
      </div>
      <div class="sidebar-item ${currentDesignerTab === 'ARCHIVED' ? 'active' : ''}" onclick="selectDesigner('ARCHIVED')" style="background: ${currentDesignerTab === 'ARCHIVED' ? 'var(--success-bg)' : 'transparent'};">
        <span class="sidebar-item-label" style="color: var(--success-color);">笨・螳御ｺ・ｸ・/span>
        <span class="sidebar-item-count" style="background: var(--success-color); color: white;">${archivedCount}</span>
      </div>
    </div>
  `;

  // 繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ逕滓・繝倥Ν繝代・・域｡井ｻｶ謨ｰ縺ｨ繧ｿ繧ｹ繧ｯ謨ｰ繧定｡ｨ遉ｺ・・
  function renderSection(category, icon, designersList, getProjectCount, getTaskCount) {
    if (designersList.length === 0) return '';

    const collapsed = isCollapsed(category);

    // 繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ蜈ｨ菴薙・繧ｿ繧ｹ繧ｯ謨ｰ繧定ｨ育ｮ・
    // 驛ｨ鄂ｲ繧ｿ繧､繝医Ν讓ｪ縺ｮ繧ｿ繧ｹ繧ｯ謨ｰ陦ｨ遉ｺ縺ｯ荳崎ｦ・ｼ亥炎髯､貂医∩・・
    const sectionTaskBadge = '';

    let sectionHtml = `<div class="sidebar-section sidebar-collapsible ${collapsed ? 'collapsed' : ''}">
      <div class="sidebar-section-title" onclick="toggleSidebarSection('${category}')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <span>${icon} ${category}諡・ｽ・{sectionTaskBadge}</span>
        <span class="sidebar-collapse-icon" style="font-size: 10px; transition: transform 0.2s;">${collapsed ? '笆ｶ' : '笆ｼ'}</span>
      </div>
      <div class="sidebar-section-items" style="${collapsed ? 'display: none;' : ''}">`;

    designersList.forEach(designer => {
      const count = getProjectCount(designer);
      const taskInfo = getTaskCount ? getTaskCount(designer) : { total: 0, completed: 0 };
      const incompleteTasks = taskInfo.total - taskInfo.completed;

      // 濶ｲ蛻・￠繝ｭ繧ｸ繝・け
      let countClass = 'count-blue';
      let nameClass = '';
      if (count >= 7) {
        nameClass = 'name-red';
        countClass = 'count-yellow';
      } else if (count >= 5) {
        countClass = 'count-yellow';
      }

      sectionHtml += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label ${nameClass}">${designer.name}</span>
          <button class="sidebar-task-btn" onclick="event.stopPropagation(); openStaffTasksModal('${designer.name}')" title="繧ｿ繧ｹ繧ｯ荳隕ｧ">搭</button>
          <span class="sidebar-item-count ${countClass}">${count}</span>
        </div>
      `;
    });

    sectionHtml += '</div></div>';
    return sectionHtml;
  }

  // 繧ｿ繧ｹ繧ｯ謨ｰ險育ｮ励・繝ｫ繝代・・域球蠖楢・・蜈ｨ譯井ｻｶ縺ｮ繧ｿ繧ｹ繧ｯ螳御ｺ・憾豕・ｼ・
  function calculateTaskCount(designerName, category) {
    let total = 0;
    let completed = 0;

    projects.filter(p => !p.is_archived && p.status !== 'completed').forEach(p => {
      let isAssigned = false;
      let taskList = [];

      if (category === '險ｭ險・ && (p.assigned_to || '').trim() === designerName) {
        isAssigned = true;
        taskList = tasksV2.filter(t => t.category === '險ｭ險・);
      } else if (category === 'IC' && (p.ic_assignee || '').trim() === designerName && p.layout_confirmed_date) {
        // IC諡・ｽ薙・髢灘叙遒ｺ螳壽ｸ医∩縺ｮ譯井ｻｶ縺ｮ縺ｿ
        isAssigned = true;
        taskList = tasksV2.filter(t => t.category === 'IC');
      } else if (category === '螟匁ｧ・ && (p.exterior_assignee || '').trim() === designerName) {
        isAssigned = true;
        taskList = getTasksForCategory('螟匁ｧ・);
      } else if (category === '荳榊虚逕｣' && (p.realestate_assignee || '').trim() === designerName) {
        isAssigned = true;
        taskList = getTasksForCategory('荳榊虚逕｣');
      } else if (category === '蟾･莠・ && (p.construction_assignee || '').trim() === designerName) {
        isAssigned = true;
        taskList = getTasksForCategory('蟾･莠・);
      }

      if (isAssigned && taskList.length > 0) {
        const progressData = p.progress || {};
        taskList.forEach(taskDef => {
          total++;
          const task = progressData[taskDef.task_key] || {};
          const stateOptions = getTaskStateOptions(taskDef.task_key);
          const lastOption = stateOptions && stateOptions.length > 0 ? stateOptions[stateOptions.length - 1] : null;
          if (task.state === lastOption) {
            completed++;
          }
        });
      }
    });

    return { total, completed };
  }

  // 險ｭ險域球蠖薙そ繧ｯ繧ｷ繝ｧ繝ｳ
  html += renderSection('險ｭ險・, '盗', sekkeiDesigners, (designer) => {
    return projects.filter(p => {
      const assigned = (p.assigned_to || '').trim();
      return assigned === designer.name.trim() && p.status !== 'completed' && !p.is_archived;
    }).length;
  }, (designer) => calculateTaskCount(designer.name.trim(), '險ｭ險・));

  // IC諡・ｽ薙そ繧ｯ繧ｷ繝ｧ繝ｳ・磯俣蜿也｢ｺ螳壽ｸ医∩縺ｮ縺ｿ・・
  html += renderSection('IC', '耳', icDesigners, (designer) => {
    return projects.filter(p => {
      const icAssigned = (p.ic_assignee || '').trim();
      // 髢灘叙遒ｺ螳壽ｸ医∩縺ｮ譯井ｻｶ縺ｮ縺ｿ陦ｨ遉ｺ
      return icAssigned === designer.name.trim() && p.status !== 'completed' && !p.is_archived && p.layout_confirmed_date;
    }).length;
  }, (designer) => calculateTaskCount(designer.name.trim(), 'IC'));

  // 螟匁ｧ区球蠖薙そ繧ｯ繧ｷ繝ｧ繝ｳ
  html += renderSection('螟匁ｧ・, '元', exteriorDesigners, (designer) => {
    return projects.filter(p => {
      const exteriorAssigned = (p.exterior_assignee || '').trim();
      return exteriorAssigned === designer.name.trim() && p.status !== 'completed' && !p.is_archived;
    }).length;
  }, (designer) => calculateTaskCount(designer.name.trim(), '螟匁ｧ・));

  // 荳榊虚逕｣諡・ｽ薙そ繧ｯ繧ｷ繝ｧ繝ｳ
  html += renderSection('荳榊虚逕｣', '匠', realestateDesigners, (designer) => {
    return projects.filter(p => {
      const realestateAssigned = (p.realestate_assignee || '').trim();
      return realestateAssigned === designer.name.trim() && p.status !== 'completed' && !p.is_archived;
    }).length;
  }, (designer) => calculateTaskCount(designer.name.trim(), '荳榊虚逕｣'));

  // 蟾･莠区球蠖薙そ繧ｯ繧ｷ繝ｧ繝ｳ
  html += renderSection('蟾･莠・, '畑', constructionDesigners, (designer) => {
    return projects.filter(p => {
      const constructionAssigned = (p.construction_assignee || '').trim();
      return constructionAssigned === designer.name.trim() && p.status !== 'completed' && !p.is_archived;
    }).length;
  }, (designer) => calculateTaskCount(designer.name.trim(), '蟾･莠・));

  // 蝟ｶ讌ｭ諡・ｽ薙そ繧ｯ繧ｷ繝ｧ繝ｳ
  html += renderSection('蝟ｶ讌ｭ', '直', salesDesigners, (designer) => {
    return projects.filter(p => {
      const salesAssigned = (p.sales_assignee || '').trim();
      return salesAssigned === designer.name.trim() && p.status !== 'completed' && !p.is_archived;
    }).length;
  }, null); // 蝟ｶ讌ｭ縺ｫ縺ｯ繧ｿ繧ｹ繧ｯ荳隕ｧ縺ｪ縺・

  container.innerHTML = html;
};

// 諡・ｽ楢・ち繧ｹ繧ｯ荳隕ｧ繝｢繝ｼ繝繝ｫ
let currentStaffForTasks = null;

function openStaffTasksModal(staffName) {
  currentStaffForTasks = staffName;
  document.getElementById('staffTasksModalTitle').textContent = `${staffName} 縺ｮ繧ｿ繧ｹ繧ｯ荳隕ｧ`;
  renderStaffTasksList();
  ModalManager.open(document.getElementById('staffTasksModal'));
}

function closeStaffTasksModal() {
  ModalManager.close(document.getElementById('staffTasksModal'));
  currentStaffForTasks = null;
}

function sortTasksBy(sortType) {
  currentTaskSort = sortType;
  document.getElementById('sortByDueBtn').classList.toggle('btn-primary', sortType === 'due');
  document.getElementById('sortByDueBtn').classList.toggle('btn-ghost', sortType !== 'due');
  document.getElementById('sortByProjectBtn').classList.toggle('btn-primary', sortType === 'project');
  document.getElementById('sortByProjectBtn').classList.toggle('btn-ghost', sortType !== 'project');
  renderStaffTasksList();
}

async function renderStaffTasksList() {
  const container = document.getElementById('staffTasksList');
  if (!container || !currentStaffForTasks) return;

  // 諡・ｽ楢・・譯井ｻｶ繧貞叙蠕暦ｼ・C諡・ｽ薙・髢灘叙遒ｺ螳壽ｸ医∩縺ｮ縺ｿ・・
  const staffProjects = projects.filter(p => {
    const assigned = (p.assigned_to || '').trim();
    const icAssigned = (p.ic_assignee || '').trim();
    const exteriorAssigned = (p.exterior_assignee || '').trim();
    // IC諡・ｽ薙→縺励※繝槭ャ繝√☆繧九↓縺ｯ髢灘叙遒ｺ螳壹′蠢・ｦ・
    const icMatches = icAssigned === currentStaffForTasks && p.layout_confirmed_date;
    return (assigned === currentStaffForTasks || icMatches || exteriorAssigned === currentStaffForTasks) &&
           p.status !== 'completed' && !p.is_archived;
  });

  // project_tasks縺九ｉ繧ｿ繧ｹ繧ｯ繧貞叙蠕・
  const { data: tasks } = await supabase
    .from('project_tasks')
    .select('*')
    .in('project_id', staffProjects.map(p => p.id))
    .eq('is_completed', false)
    .order('due_date');

  if (!tasks || tasks.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>譛ｪ螳御ｺ・・繧ｿ繧ｹ繧ｯ縺ｯ縺ゅｊ縺ｾ縺帙ｓ</p></div>';
    return;
  }

  // 繧ｽ繝ｼ繝・
  let sortedTasks = [...tasks];
  if (currentTaskSort === 'due') {
    sortedTasks.sort((a, b) => {
      if (!a.due_date) return 1;
      if (!b.due_date) return -1;
      return new Date(a.due_date) - new Date(b.due_date);
    });
  } else {
    sortedTasks.sort((a, b) => {
      const projectA = staffProjects.find(p => p.id === a.project_id);
      const projectB = staffProjects.find(p => p.id === b.project_id);
      return (projectA?.customer || '').localeCompare(projectB?.customer || '');
    });
  }

  // 陦ｨ遉ｺ
  let html = '';
  const today = new Date().toISOString().split('T')[0];

  if (currentTaskSort === 'project') {
    // 驍ｸ蜷阪＃縺ｨ縺ｫ繧ｰ繝ｫ繝ｼ繝怜喧
    const grouped = {};
    sortedTasks.forEach(task => {
      const project = staffProjects.find(p => p.id === task.project_id);
      const key = project?.customer || '荳肴・';
      if (!grouped[key]) grouped[key] = [];
      grouped[key].push(task);
    });

    for (const [customer, customerTasks] of Object.entries(grouped)) {
      html += `<div class="task-list-group"><div class="task-list-group-title">${escapeHtml(customer)}</div>`;
      customerTasks.forEach(task => {
        const isOverdue = task.due_date && task.due_date < today;
        html += `
          <div class="project-task-item">
            <input type="checkbox" class="project-task-checkbox" onchange="toggleProjectTask('${task.id}', '${task.project_id}', this.checked)">
            <span class="project-task-name">${escapeHtml(task.task_name)}</span>
            ${task.due_date ? `<span class="project-task-due ${isOverdue ? 'overdue' : ''}">${escapeHtml(task.due_date)}</span>` : ''}
          </div>
        `;
      });
      html += '</div>';
    }
  } else {
    // 譛滄剞鬆・
    sortedTasks.forEach(task => {
      const project = staffProjects.find(p => p.id === task.project_id);
      const isOverdue = task.due_date && task.due_date < today;
      html += `
        <div class="project-task-item">
          <input type="checkbox" class="project-task-checkbox" onchange="toggleProjectTask('${task.id}', '${task.project_id}', this.checked)">
          <span class="project-task-name">${escapeHtml(task.task_name)}</span>
          <span style="font-size: 12px; color: var(--text-muted);">${escapeHtml(project?.customer || '')}</span>
          ${task.due_date ? `<span class="project-task-due ${isOverdue ? 'overdue' : ''}">${escapeHtml(task.due_date)}</span>` : ''}
        </div>
      `;
    });
  }

  container.innerHTML = html;
}

// 譯井ｻｶ繧ｿ繧ｹ繧ｯ荳隕ｧ隱ｭ縺ｿ霎ｼ縺ｿ
async function loadProjectTasksList(projectId) {
  const container = document.getElementById(`projectTasksList_${projectId}`);
  if (!container) return;

  try {
    const { data: tasks, error } = await supabase
      .from('project_tasks')
      .select('*')
      .eq('project_id', projectId)
      .order('due_date', { ascending: true, nullsFirst: false });

    if (error) {
      logError('Load tasks error:', error);
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">繧ｿ繧ｹ繧ｯ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆</div>';
      updateTaskBadge(projectId, 0);
      return;
    }

    // 譛ｪ隗｣豎ｺ繧ｿ繧ｹ繧ｯ謨ｰ繧定ｨ育ｮ励＠縺ｦ繝舌ャ繧ｸ譖ｴ譁ｰ
    const unresolvedCount = tasks ? tasks.filter(t => !t.is_completed).length : 0;
    updateTaskBadge(projectId, unresolvedCount);

    if (!tasks || tasks.length === 0) {
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">繧ｿ繧ｹ繧ｯ縺ｯ縺ゅｊ縺ｾ縺帙ｓ</div>';
      return;
    }

    container.innerHTML = tasks.map(t => `
      <div class="task-item" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: ${t.is_completed ? 'var(--success-light)' : 'var(--bg-secondary)'}; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${t.is_completed ? 'var(--success-color)' : 'var(--primary-color)'};">
        <input type="checkbox" ${t.is_completed ? 'checked' : ''} onchange="toggleProjectTask('${t.id}', '${projectId}', this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
        <div style="flex: 1; min-width: 0;">
          <div style="font-size: 13px; font-weight: 500; ${t.is_completed ? 'text-decoration: line-through; color: var(--text-muted);' : ''}">${escapeHtml(t.task_name)}</div>
          ${t.due_date ? `<div style="font-size: 11px; color: ${isOverdue(t.due_date) && !t.is_completed ? 'var(--danger-color)' : 'var(--text-muted)'}; margin-top: 2px;">譛滄剞: ${formatDate(t.due_date)}</div>` : ''}
        </div>
        <button class="btn btn-small btn-ghost" onclick="deleteProjectTask('${t.id}', '${projectId}')" style="flex-shrink: 0; padding: 4px 8px; font-size: 12px; color: var(--danger-color);">蜑企勁</button>
      </div>
    `).join('');
  } catch (error) {
    logError('Load tasks error:', error);
    container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">繧ｿ繧ｹ繧ｯ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆</div>';
    updateTaskBadge(projectId, 0);
  }
}

// 繧ｿ繧ｹ繧ｯ繝舌ャ繧ｸ繧呈峩譁ｰ
function updateTaskBadge(projectId, count) {
  const badge = document.getElementById(`taskBadge_${projectId}`);
  if (badge) {
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = 'inline-flex';
    } else {
      badge.style.display = 'none';
    }
  }
}

// 繝舌ャ繧ｸ縺ｮ縺ｿ譖ｴ譁ｰ・医き繝ｼ繝臥畑・・
async function loadBadgeCounts(projectId) {
  try {
    // 繧ｿ繧ｹ繧ｯ謨ｰ繧貞叙蠕・
    const { data: tasks, error: taskError } = await supabase
      .from('project_tasks')
      .select('id, is_completed')
      .eq('project_id', projectId);

    if (!taskError && tasks) {
      const unresolvedCount = tasks.filter(t => !t.is_completed).length;
      updateTaskBadge(projectId, unresolvedCount);
    }

    // 隴ｰ莠矩鹸謨ｰ繧貞叙蠕・
    const { data: minutes, error: minError } = await supabase
      .from('project_minutes')
      .select('id')
      .eq('project_id', projectId);

    if (!minError && minutes) {
      updateMinutesBadge(projectId, minutes.length);
    }

    // 蠑慕ｶ呎嶌繝舌ャ繧ｸ繧貞叙蠕暦ｼ医ユ繝ｼ繝悶Ν縺悟ｭ伜惠縺励↑縺・ｴ蜷医ｂ縺ゅｋ縺溘ａ縲√お繝ｩ繝ｼ縺ｯ辟｡隕厄ｼ・
    try {
      const { data: handovers, error: handoverError } = await supabase
        .from('project_handovers')
        .select('content')
        .eq('project_id', projectId);

      // 繧ｨ繝ｩ繝ｼ縺後↑縺上√ョ繝ｼ繧ｿ縺後≠繧句ｴ蜷医・縺ｿ蜃ｦ逅・
      if (!handoverError && handovers && handovers.length > 0) {
        const handover = handovers[0];
        let hasContent = false;
        try {
          const handoverData = JSON.parse(handover.content);
          hasContent = Object.values(handoverData).some(v => v && v.trim());
        } catch (e) {
          hasContent = !!(handover.content && handover.content.trim());
        }
        updateHandoverBadge(projectId, hasContent);
      }
    } catch (handoverErr) {
      // 蠑慕ｶ呎嶌繝・・繝悶Ν繧ｨ繝ｩ繝ｼ縺ｯ辟｡隕厄ｼ医ユ繝ｼ繝悶Ν譛ｪ菴懈・縺ｮ迺ｰ蠅・髄縺托ｼ・
    }
  } catch (e) {
    // 繧ｨ繝ｩ繝ｼ縺ｯ髱吶°縺ｫ辟｡隕・
  }
}

// 譛滄剞蛻・ｌ繝√ぉ繝・け
function isOverdue(dateStr) {
  if (!dateStr) return false;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const dueDate = new Date(dateStr);
  return dueDate < today;
}

// 繧ｿ繧ｹ繧ｯ螳御ｺ・憾諷九ｒ蛻・ｊ譖ｿ縺・
async function toggleProjectTask(taskId, projectId, isCompleted) {
  const { error } = await supabase
    .from('project_tasks')
    .update({ is_completed: isCompleted, updated_at: new Date().toISOString() })
    .eq('id', taskId);

  if (error) {
    showToast('譖ｴ譁ｰ縺ｫ螟ｱ謨励＠縺ｾ縺励◆', 'error');
    return;
  }

  // 譯井ｻｶ繧ｫ繝ｼ繝牙・縺ｮ繧ｿ繧ｹ繧ｯ繝ｪ繧ｹ繝医ｒ譖ｴ譁ｰ
  await loadProjectTasksList(projectId);
  // 繝舌ャ繧ｸ繧ｫ繧ｦ繝ｳ繝医ｒ譖ｴ譁ｰ
  await loadBadgeCounts(projectId);
  // 諡・ｽ灘挨繧ｿ繧ｹ繧ｯ荳隕ｧ繧よ峩譁ｰ
  renderStaffTasksList();
}

// 繧ｿ繧ｹ繧ｯ蜑企勁
async function deleteProjectTask(taskId, projectId) {
  if (!confirm('縺薙・繧ｿ繧ｹ繧ｯ繧貞炎髯､縺励∪縺吶°・・)) return;

  const { error } = await supabase
    .from('project_tasks')
    .delete()
    .eq('id', taskId);

  if (error) {
    showToast('蜑企勁縺ｫ螟ｱ謨励＠縺ｾ縺励◆', 'error');
    return;
  }

  showToast('繧ｿ繧ｹ繧ｯ繧貞炎髯､縺励∪縺励◆', 'success');
  await loadProjectTasksList(projectId);
  // 繝舌ャ繧ｸ繧ｫ繧ｦ繝ｳ繝医ｒ譖ｴ譁ｰ
  await loadBadgeCounts(projectId);
}

// 譯井ｻｶ縺ｫ繧ｿ繧ｹ繧ｯ繧定ｿｽ蜉
async function addProjectTask(projectId, taskName, dueDate) {
  if (!taskName.trim()) {
    showToast('繧ｿ繧ｹ繧ｯ蜷阪ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  const project = projects.find(p => p.id === projectId);

  try {
    const { data, error } = await supabase
      .from('project_tasks')
      .insert({
        project_id: projectId,
        task_name: taskName.trim(),
        due_date: dueDate || null,
        assigned_to: project?.assigned_to || '',
        is_completed: false
      })
      .select();

    if (error) {
      logError('繧ｿ繧ｹ繧ｯ霑ｽ蜉繧ｨ繝ｩ繝ｼ:', error);
      if (error.code === '42501') {
        showToast('繧ｿ繧ｹ繧ｯ霑ｽ蜉縺ｮ讓ｩ髯舌′縺ゅｊ縺ｾ縺帙ｓ縲らｮ｡逅・・↓騾｣邨｡縺励※縺上□縺輔＞縲・, 'error');
      } else if (error.code === '42P01') {
        showToast('繧ｿ繧ｹ繧ｯ繝・・繝悶Ν縺悟ｭ伜惠縺励∪縺帙ｓ縲ゅョ繝ｼ繧ｿ繝吶・繧ｹ繧堤｢ｺ隱阪＠縺ｦ縺上□縺輔＞縲・, 'error');
      } else {
        showToast(`繧ｿ繧ｹ繧ｯ霑ｽ蜉縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ${error.message}`, 'error');
      }
      return;
    }

    // 蜈･蜉帶ｬ・ｒ繧ｯ繝ｪ繧｢
    const taskNameEl = document.getElementById(`newTaskName_${projectId}`);
    const taskDueEl = document.getElementById(`newTaskDue_${projectId}`);
    if (taskNameEl) taskNameEl.value = '';
    if (taskDueEl) taskDueEl.value = '';

    showToast('繧ｿ繧ｹ繧ｯ繧定ｿｽ蜉縺励∪縺励◆', 'success');

    // 繧ｿ繧ｹ繧ｯ繝ｪ繧ｹ繝域峩譁ｰ・医お繝ｩ繝ｼ縺後≠縺｣縺ｦ繧らｶ夊｡鯉ｼ・
    try {
      await loadProjectTasksList(projectId);
    } catch (e) {
      console.warn('繧ｿ繧ｹ繧ｯ繝ｪ繧ｹ繝域峩譁ｰ繧ｨ繝ｩ繝ｼ:', e);
    }

    // 繝舌ャ繧ｸ繧ｫ繧ｦ繝ｳ繝医ｒ譖ｴ譁ｰ・医お繝ｩ繝ｼ縺後≠縺｣縺ｦ繧らｶ夊｡鯉ｼ・
    try {
      await loadBadgeCounts(projectId);
    } catch (e) {
      console.warn('繝舌ャ繧ｸ繧ｫ繧ｦ繝ｳ繝域峩譁ｰ繧ｨ繝ｩ繝ｼ:', e);
    }
  } catch (err) {
    logError('繧ｿ繧ｹ繧ｯ霑ｽ蜉萓句､・', err);
    showToast('繧ｿ繧ｹ繧ｯ霑ｽ蜉荳ｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆', 'error');
  }
}

// 荳ｻ隕√ち繧ｹ繧ｯ縺ｮ繧ｹ繝・・繧ｿ繧ｹ繧貞虚逧・↓蜿門ｾ暦ｼ医Ξ繝昴・繝育畑・・
// category: '險ｭ險・ or 'IC' - 陦ｨ遉ｺ縺吶ｋ繧ｫ繝・ざ繝ｪ
function getMainTaskStatuses(progressData, category = '險ｭ險・) {
  const statuses = [];

  // 繧ｫ繝・ざ繝ｪ蛻･縺ｮ荳ｻ隕√く繝ｼ繝ｯ繝ｼ繝・
  const mainKeywords = category === 'IC'
    ? ['繧ｭ繝・メ繝ｳ', '縺企｢ｨ蜻・, '豢鈴擇', '繝医う繝ｬ', '辣ｧ譏・, '莉墓ｧ俶嶌', '螳滓命蝗ｳ', '遒ｺ螳壼峙']
    : ['螟ｪ髯ｽ蜈・, '邨ｦ謗呈ｰｴ', '謠帶ｰ・, '繧ｵ繝・す', '讒矩', '繧ｨ繝懊Ν繝・, 'evoltz'];

  tasksV2.filter(t => t.category === category).forEach(task => {
    if (task.task_name && task.has_state) {
      const isMain = mainKeywords.some(k => task.task_name.includes(k));
      if (isMain && progressData[task.task_key]?.state) {
        // 繧ｿ繧ｹ繧ｯ蜷阪ｒ遏ｭ邵ｮ
        let shortName = task.task_name
          .replace(/萓晞ｼ$/, '')
          .replace(/菴懈・$/, '')
          .replace(/繝励Λ繝ｳ$/, '');
        statuses.push(`${shortName}:${progressData[task.task_key].state}`);
      }
    }
  });

  return statuses;
}

// 逕ｳ隲季O譚｡莉ｶ繝√ぉ繝・け・亥虚逧・↓繧ｿ繧ｹ繧ｯ繧呈､懃ｴ｢・・
function getApplicationGoRequiredTasks() {
  // 繧ｿ繧ｹ繧ｯ蜷阪・繧ｭ繝ｼ繝ｯ繝ｼ繝峨〒蠢・ｦ√↑繧ｿ繧ｹ繧ｯ繧呈､懃ｴ｢
  const keywords = ['螟ｪ髯ｽ蜈・, '邨ｦ謗呈ｰｴ', '謠帶ｰ・, '繧ｵ繝・す'];
  const requiredTasks = [];

  keywords.forEach(keyword => {
    const task = tasksV2.find(t => t.task_name && t.task_name.includes(keyword) && t.has_state);
    if (task) {
      // state_options繧偵ヱ繝ｼ繧ｹ・域枚蟄怜・縺ｮ蝣ｴ蜷茨ｼ・
      let options = task.state_options;
      if (typeof options === 'string') {
        try {
          options = JSON.parse(options);
        } catch (e) {
          options = [];
        }
      }
      // 譛邨ら憾諷具ｼ・tate_options縺ｮ譛蠕後・蛟､・峨ｒ蜿門ｾ・
      const finalState = Array.isArray(options) && options.length > 0
        ? options[options.length - 1]
        : '菫晏ｭ俶ｸ・;
      requiredTasks.push({
        task_key: task.task_key,
        task_name: task.task_name,
        finalState: finalState
      });
    }
  });

  return requiredTasks;
}

function canPressApplicationGo(project) {
  const progressData = project.progress || {};
  const requiredTasks = getApplicationGoRequiredTasks();

  // 蠢・ｦ√↑繧ｿ繧ｹ繧ｯ縺瑚ｦ九▽縺九ｉ縺ｪ縺・ｴ蜷医・譌ｧ繝ｭ繧ｸ繝・け縺ｫ繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ
  if (requiredTasks.length === 0) {
    log('笞・・逕ｳ隲季O: tasksV2縺九ｉ繧ｿ繧ｹ繧ｯ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ縲よ立繝ｭ繧ｸ繝・け繧剃ｽｿ逕ｨ');
    const solarOk = progressData['solar']?.state === '蝟ｶ讌ｭ蜈ｱ譛画ｸ・;
    const plumbingOk = progressData['plumbing']?.state === '菫晏ｭ俶ｸ・;
    const ventilationOk = progressData['ventilation']?.state === '菫晏ｭ俶ｸ・;
    const sashOk = progressData['sash']?.state === '菫晏ｭ俶ｸ・;
    return solarOk && plumbingOk && ventilationOk && sashOk;
  }

  // 蜈ｨ縺ｦ縺ｮ蠢・ｦ√ち繧ｹ繧ｯ縺梧怙邨ら憾諷九°繝√ぉ繝・け
  const results = requiredTasks.map(req => {
    const currentState = progressData[req.task_key]?.state || '-';
    const ok = currentState === req.finalState;
    log(`搭 逕ｳ隲季O譚｡莉ｶ: ${req.task_name} (${req.task_key}) = "${currentState}" / 蠢・ｦ・ "${req.finalState}" 竊・${ok ? '笨・ : '笨・}`);
    return ok;
  });

  const allOk = results.every(r => r);
  log(`搭 逕ｳ隲季O蛻､螳・ ${allOk ? '譚｡莉ｶOK' : '譚｡莉ｶ譛ｪ驕・}`);
  return allOk;
}

// 逕ｳ隲季O遒ｺ隱阪Δ繝ｼ繝繝ｫ
let applicationGoProjectId = null;

function confirmApplicationGo(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  applicationGoProjectId = projectId;
  const progressData = project.progress || {};
  const requiredTasks = getApplicationGoRequiredTasks();

  // 譚｡莉ｶ陦ｨ遉ｺ・亥虚逧・↓逕滓・・・
  let conditions;
  if (requiredTasks.length > 0) {
    conditions = requiredTasks.map(req => ({
      label: req.task_name,
      ok: progressData[req.task_key]?.state === req.finalState,
      value: progressData[req.task_key]?.state || '-',
      required: req.finalState
    }));
  } else {
    // 繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ
    conditions = [
      { label: '螟ｪ髯ｽ蜈我ｾ晞ｼ', ok: progressData['solar']?.state === '蝟ｶ讌ｭ蜈ｱ譛画ｸ・, value: progressData['solar']?.state || '-', required: '蝟ｶ讌ｭ蜈ｱ譛画ｸ・ },
      { label: '邨ｦ謗呈ｰｴ蝗ｳ萓晞ｼ', ok: progressData['plumbing']?.state === '菫晏ｭ俶ｸ・, value: progressData['plumbing']?.state || '-', required: '菫晏ｭ俶ｸ・ },
      { label: '謠帶ｰ怜峙萓晞ｼ', ok: progressData['ventilation']?.state === '菫晏ｭ俶ｸ・, value: progressData['ventilation']?.state || '-', required: '菫晏ｭ俶ｸ・ },
      { label: '繧ｵ繝・す萓晞ｼ', ok: progressData['sash']?.state === '菫晏ｭ俶ｸ・, value: progressData['sash']?.state || '-', required: '菫晏ｭ俶ｸ・ }
    ];
  }

  document.getElementById('applicationGoProjectName').textContent = project.customer;
  document.getElementById('applicationGoConditions').innerHTML = conditions.map(c =>
    `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
      <span style="color: ${c.ok ? '#10b981' : '#ef4444'};">${c.ok ? '笨・ : '笨・}</span>
      <span>${c.label}:</span>
      <span style="font-weight: 500; color: ${c.ok ? '#10b981' : 'var(--text-secondary)'};">${c.value}</span>
    </div>`
  ).join('');

  ModalManager.open(document.getElementById('applicationGoModal'));
}

function closeApplicationGoModal() {
  ModalManager.close(document.getElementById('applicationGoModal'));
  applicationGoProjectId = null;
}

async function executeApplicationGo() {
  // 莠碁㍾繧ｯ繝ｪ繝・け髦ｲ豁｢
  if (SaveGuard.isLocked('executeApplicationGo')) return;
  if (!applicationGoProjectId) return;

  const project = projects.find(p => p.id === applicationGoProjectId);
  if (!project) return;

  // 譚｡莉ｶ繧貞・繝√ぉ繝・け・医Δ繝ｼ繝繝ｫ陦ｨ遉ｺ蠕後↓譚｡莉ｶ縺悟､峨ｏ縺｣縺ｦ縺・ｋ蜿ｯ閭ｽ諤ｧ縺後≠繧九◆繧・ｼ・
  if (!canPressApplicationGo(project)) {
    showToast('譚｡莉ｶ縺梧ｺ縺溘＆繧後※縺・∪縺帙ｓ縲ゅち繧ｹ繧ｯ縺ｮ迥ｶ諷九ｒ遒ｺ隱阪＠縺ｦ縺上□縺輔＞縲・, 'error');
    closeApplicationGoModal();
    return;
  }

  await SaveGuard.run('executeApplicationGo', async () => {
    // 逕ｳ隲九ち繧ｹ繧ｯ繧貞ｮ御ｺ・→縺励※繝槭・繧ｯ
    const progressData = project.progress || {};
    if (!progressData['application']) progressData['application'] = {};
    progressData['application'].completed = true;
    progressData['application'].date = new Date().toISOString().split('T')[0];

    showStatus('菫晏ｭ倅ｸｭ...', 'saving');
    const { error } = await supabase
      .from('projects')
      .update({
        is_archived: true,
        progress: progressData,
        updated_at: new Date().toISOString()
      })
      .eq('id', applicationGoProjectId);

    if (error) {
      showStatus('繧ｨ繝ｩ繝ｼ', 'error');
      showToast('螳御ｺ・・逅・↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
      return;
    }

    project.is_archived = true;
    project.progress = progressData;
    project.updated_at = new Date().toISOString();

    closeApplicationGoModal();
    renderProjects();
    updateSidebar();
    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast(`${project.customer} 繧貞ｮ御ｺ・ｸ医∩縺ｫ遘ｻ蜍輔＠縺ｾ縺励◆`, 'success');
  });
}

// 繧ｫ繝ｼ繝峨Δ繝ｼ繝繝ｫ讖溯・
function openCardModal(projectId, type) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  let title = '';
  let content = '';

  switch(type) {
    case 'tasks':
      title = `笨・繧ｿ繧ｹ繧ｯ - ${project.customer}`;
      content = `
        <div id="modalTasksList_${projectId}" class="project-task-list"></div>
        <div class="add-task-form" style="margin-top:16px;display:flex;gap:8px;">
          <input type="text" id="modalNewTaskName_${projectId}" placeholder="繧ｿ繧ｹ繧ｯ蜷・ style="flex:1;padding:10px;border:1px solid var(--border-color);border-radius:6px;">
          <input type="date" id="modalNewTaskDue_${projectId}" style="padding:10px;border:1px solid var(--border-color);border-radius:6px;">
          <button class="btn btn-primary" onclick="addProjectTaskFromModal('${projectId}')">霑ｽ蜉</button>
        </div>
      `;
      break;
    case 'memo':
      title = `統 繝｡繝｢ - ${project.customer}`;
      content = `
        <textarea class="shared-memo-area" id="modalSharedMemo_${projectId}" placeholder="繝｡繝｢繧貞・蜉・.." style="width:100%;min-height:200px;padding:12px;border:1px solid var(--border-color);border-radius:8px;resize:vertical;">${escapeHtml(project.shared_memo || '')}</textarea>
        <button class="btn btn-primary" style="margin-top:12px;" onclick="saveSharedMemoFromModal('${projectId}')">繝｡繝｢繧剃ｿ晏ｭ・/button>
      `;
      break;
    case 'minutes':
      title = `塘 隴ｰ莠矩鹸 - ${project.customer}`;
      content = `
        <div id="modalMinutesList_${projectId}" class="minutes-list" style="margin-bottom:16px;"></div>
        <div class="minutes-upload-area" style="padding:24px;border:2px dashed var(--border-color);border-radius:8px;text-align:center;cursor:pointer;" ondragover="handleMinutesDragOver(event)" ondragleave="handleMinutesDragLeave(event)" ondrop="handleDropWithDateModal(event, '${projectId}')" onclick="document.getElementById('modalMinutesUpload_${projectId}').click()">
          <input type="file" id="modalMinutesUpload_${projectId}" style="display:none" accept=".pdf,.doc,.docx,.xls,.xlsx" onchange="uploadMinutesWithDateModal('${projectId}', this.files[0])">
          <span style="font-size:24px;">刀</span>
          <div style="margin-top:8px;">繧ｯ繝ｪ繝・け縺ｾ縺溘・繝峨Λ繝・げ&繝峨Ο繝・・</div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">PDF, Word, Excel蟇ｾ蠢・/div>
        </div>
      `;
      break;
    case 'handover':
      title = `搭 蠑慕ｶ呎嶌 - ${project.customer}`;
      content = `
        <div class="handover-sections">
          <div class="handover-section">
            <label class="handover-label">匠 險ｭ險・/label>
            <textarea class="handover-textarea" id="modalHandover_design_${projectId}" placeholder="險ｭ險医°繧峨・蠑慕ｶ吩ｺ矩・.." rows="3"></textarea>
          </div>
          <div class="handover-section">
            <label class="handover-label">耳 IC</label>
            <textarea class="handover-textarea" id="modalHandover_ic_${projectId}" placeholder="IC縺九ｉ縺ｮ蠑慕ｶ吩ｺ矩・.." rows="3"></textarea>
          </div>
          <div class="handover-section">
            <label class="handover-label">元 螟匁ｧ・/label>
            <textarea class="handover-textarea" id="modalHandover_exterior_${projectId}" placeholder="螟匁ｧ九°繧峨・蠑慕ｶ吩ｺ矩・.." rows="3"></textarea>
          </div>
          <div class="handover-section">
            <label class="handover-label">召 荳榊虚逕｣</label>
            <textarea class="handover-textarea" id="modalHandover_realestate_${projectId}" placeholder="荳榊虚逕｣縺九ｉ縺ｮ蠑慕ｶ吩ｺ矩・.." rows="3"></textarea>
          </div>
          <div class="handover-section">
            <label class="handover-label">肌 蟾･莠・/label>
            <textarea class="handover-textarea" id="modalHandover_construction_${projectId}" placeholder="蟾･莠九°繧峨・蠑慕ｶ吩ｺ矩・.." rows="3"></textarea>
          </div>
        </div>
        <button class="btn btn-primary" style="margin-top:12px;" onclick="saveHandoverFromModal('${projectId}')">蠑慕ｶ呎嶌繧剃ｿ晏ｭ・/button>
      `;
      break;
  }

  // 繝｢繝ｼ繝繝ｫHTML菴懈・
  const modalHtml = `
    <div class="card-modal-overlay" onclick="closeCardModal(event)">
      <div class="card-modal" onclick="event.stopPropagation()">
        <div class="card-modal-header">
          <span class="card-modal-title">${title}</span>
          <button class="card-modal-close" onclick="closeCardModal()">&times;</button>
        </div>
        <div class="card-modal-body">${content}</div>
      </div>
    </div>
  `;

  // 譌｢蟄倥Δ繝ｼ繝繝ｫ繧貞炎髯､
  const existing = document.querySelector('.card-modal-overlay');
  if (existing) existing.remove();

  // 繝｢繝ｼ繝繝ｫ繧定ｿｽ蜉
  document.body.insertAdjacentHTML('beforeend', modalHtml);

  // 繝・・繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ
  if (type === 'tasks') {
    loadModalTasksList(projectId);
  } else if (type === 'minutes') {
    loadModalMinutesList(projectId);
  } else if (type === 'handover') {
    loadHandoverContent(projectId);
  }
}

function closeCardModal(event) {
  if (event && event.target !== event.currentTarget) return;
  const modal = document.querySelector('.card-modal-overlay');
  if (modal) modal.remove();
}

// 繝｢繝ｼ繝繝ｫ逕ｨ繧ｿ繧ｹ繧ｯ隱ｭ縺ｿ霎ｼ縺ｿ
async function loadModalTasksList(projectId) {
  const container = document.getElementById(`modalTasksList_${projectId}`);
  if (!container) return;

  try {
    const { data: tasks, error } = await supabase
      .from('project_tasks')
      .select('*')
      .eq('project_id', projectId)
      .order('due_date', { ascending: true, nullsFirst: false });

    if (error || !tasks || tasks.length === 0) {
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px; padding: 20px; text-align: center;">繧ｿ繧ｹ繧ｯ縺ｯ縺ゅｊ縺ｾ縺帙ｓ</div>';
      return;
    }

    container.innerHTML = tasks.map(t => `
      <div class="task-item" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: ${t.is_completed ? 'var(--success-light)' : 'var(--bg-secondary)'}; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${t.is_completed ? 'var(--success-color)' : 'var(--primary-color)'};">
        <input type="checkbox" ${t.is_completed ? 'checked' : ''} onchange="toggleProjectTaskModal('${t.id}', '${projectId}', this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
        <div style="flex: 1;">
          <div style="font-size: 14px; font-weight: 500; ${t.is_completed ? 'text-decoration: line-through; color: var(--text-muted);' : ''}">${escapeHtml(t.task_name)}</div>
          ${t.due_date ? `<div style="font-size: 12px; color: ${isOverdue(t.due_date) && !t.is_completed ? 'var(--danger-color)' : 'var(--text-muted)'}; margin-top: 4px;">譛滄剞: ${formatDate(t.due_date)}</div>` : ''}
        </div>
        <button class="btn btn-small btn-ghost" onclick="deleteProjectTaskModal('${t.id}', '${projectId}')" style="color: var(--danger-color);">蜑企勁</button>
      </div>
    `).join('');
  } catch (error) {
    container.innerHTML = '<div style="color: var(--text-muted);">隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆</div>';
  }
}

async function addProjectTaskFromModal(projectId) {
  const taskName = document.getElementById(`modalNewTaskName_${projectId}`).value.trim();
  const dueDate = document.getElementById(`modalNewTaskDue_${projectId}`).value;
  if (!taskName) { showToast('繧ｿ繧ｹ繧ｯ蜷阪ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞', 'error'); return; }
  await addProjectTask(projectId, taskName, dueDate);
  document.getElementById(`modalNewTaskName_${projectId}`).value = '';
  document.getElementById(`modalNewTaskDue_${projectId}`).value = '';
  loadModalTasksList(projectId);
}

async function toggleProjectTaskModal(taskId, projectId, isCompleted) {
  await toggleProjectTask(taskId, projectId, isCompleted);
  loadModalTasksList(projectId);
  await loadBadgeCounts(projectId);
}

async function deleteProjectTaskModal(taskId, projectId) {
  if (!confirm('縺薙・繧ｿ繧ｹ繧ｯ繧貞炎髯､縺励∪縺吶°・・)) return;
  await supabase.from('project_tasks').delete().eq('id', taskId);
  showToast('繧ｿ繧ｹ繧ｯ繧貞炎髯､縺励∪縺励◆', 'success');
  loadModalTasksList(projectId);
  loadProjectTasksList(projectId);
  await loadBadgeCounts(projectId);
}

// 繝｢繝ｼ繝繝ｫ逕ｨ繝｡繝｢菫晏ｭ・
async function saveSharedMemoFromModal(projectId) {
  const memo = document.getElementById(`modalSharedMemo_${projectId}`).value;
  const { error } = await supabase.from('projects').update({ shared_memo: memo, updated_at: new Date().toISOString() }).eq('id', projectId);
  if (error) { showToast('繝｡繝｢菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', 'error'); return; }
  const project = projects.find(p => p.id === projectId);
  if (project) project.shared_memo = memo;
  showToast('繝｡繝｢繧剃ｿ晏ｭ倥＠縺ｾ縺励◆', 'success');
  closeCardModal();
  renderProjects();
}

// 繝｢繝ｼ繝繝ｫ逕ｨ隴ｰ莠矩鹸隱ｭ縺ｿ霎ｼ縺ｿ
async function loadModalMinutesList(projectId) {
  const container = document.getElementById(`modalMinutesList_${projectId}`);
  if (!container) return;

  try {
    const { data: minutes, error } = await supabase
      .from('project_minutes')
      .select('*')
      .eq('project_id', projectId)
      .order('created_at', { ascending: false });

    if (error || !minutes || minutes.length === 0) {
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px; padding: 16px; text-align: center;">繧｢繝・・繝ｭ繝ｼ繝峨＆繧後◆隴ｰ莠矩鹸縺ｯ縺ゅｊ縺ｾ縺帙ｓ</div>';
      return;
    }

    // 隴ｰ莠矩鹸繧貞屓謨ｰ縺斐→縺ｫ繧ｰ繝ｫ繝ｼ繝怜喧・・eeting_date蜆ｪ蜈医√↑縺代ｌ縺ｰcreated_at繧剃ｽｿ逕ｨ・・
    const sortedByDate = [...minutes].sort((a, b) => {
      const dateA = a.meeting_date || a.created_at.split('T')[0];
      const dateB = b.meeting_date || b.created_at.split('T')[0];
      return new Date(dateA) - new Date(dateB);
    });
    const dateGroups = {};
    sortedByDate.forEach(m => {
      const dateKey = m.meeting_date || m.created_at.split('T')[0]; // meeting_date蜆ｪ蜈・
      if (!dateGroups[dateKey]) {
        dateGroups[dateKey] = [];
      }
      dateGroups[dateKey].push(m);
    });

    // 繧ｰ繝ｫ繝ｼ繝励↓蝗樊焚繧貞牡繧雁ｽ薙※・亥商縺・律莉倥°繧・蝗樒岼縲・蝗樒岼...・・
    const groupKeys = Object.keys(dateGroups).sort();
    const groupedHtml = groupKeys.map((dateKey, index) => {
      const meetingNumber = index + 1;
      const groupMinutes = dateGroups[dateKey];
      const formattedDate = new Date(dateKey).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
      const firstMinuteId = groupMinutes[0].id; // 繧ｰ繝ｫ繝ｼ繝励・莉｣陦ｨID
      // 繧ｫ繧ｹ繧ｿ繝蜷咲ｧｰ縺後≠繧後・陦ｨ遉ｺ・・eeting_name繝輔ぅ繝ｼ繝ｫ繝峨ｒ菴ｿ逕ｨ・・
      const customName = groupMinutes[0].meeting_name || '';
      const displayTitle = customName ? `搭 ${customName}・・{formattedDate}・荏 : `搭 隨ｬ${meetingNumber}蝗樊遠蜷医○・・{formattedDate}・荏;

      return `
        <div class="minutes-group" style="margin-bottom: 16px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
          <div style="background: var(--bg-tertiary); padding: 10px 14px; font-weight: 600; font-size: 13px; color: var(--text-primary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between;">
            <span>${displayTitle}</span>
            <div style="display: flex; gap: 4px;">
              <button class="btn btn-small btn-ghost" onclick="editMinuteName('${firstMinuteId}', '${escapeHtml(customName)}', '${dateKey}', '${projectId}')" style="padding: 2px 8px; font-size: 11px;" title="蜷咲ｧｰ繧堤ｷｨ髮・>統</button>
              <button class="btn btn-small btn-ghost" onclick="editMinuteDate('${firstMinuteId}', '${dateKey}', '${projectId}')" style="padding: 2px 8px; font-size: 11px;" title="譌･莉倥ｒ邱ｨ髮・>套</button>
            </div>
          </div>
          <div style="padding: 8px;">
            ${groupMinutes.map(m => `
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">
                <a href="${m.file_url}" target="_blank" style="color: var(--primary-color); text-decoration: none; font-size: 13px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">塘 ${escapeHtml(m.file_name)}</a>
                <div style="display: flex; gap: 4px;">
                  <button class="btn btn-small btn-ghost" onclick="editSingleMinuteDate('${m.id}', '${m.meeting_date || dateKey}', '${projectId}')" style="padding: 4px 8px; font-size: 11px;" title="縺薙・隴ｰ莠矩鹸縺ｮ譌･莉倥ｒ螟画峩">套</button>
                  <button class="btn btn-small btn-ghost" onclick="deleteMinuteModal('${m.id}', '${projectId}')" style="color: var(--danger-color); padding: 4px 8px;">蜑企勁</button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }).reverse().join(''); // 譁ｰ縺励＞蝗槭°繧芽｡ｨ遉ｺ

    container.innerHTML = groupedHtml;
  } catch (error) {
    container.innerHTML = '<div style="color: var(--text-muted);">隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆</div>';
  }
}

// 隴ｰ莠矩鹸繧ｰ繝ｫ繝ｼ繝励・譌･莉倥ｒ邱ｨ髮・ｼ医げ繝ｫ繝ｼ繝怜・蜈ｨ縺ｦ縺ｮ隴ｰ莠矩鹸繧呈峩譁ｰ・・
async function editMinuteDate(minuteId, currentDate, projectId) {
  const newDate = prompt('謇灘粋縺帶律繧貞・蜉帙＠縺ｦ縺上□縺輔＞・・YYY-MM-DD蠖｢蠑擾ｼ・', currentDate);
  if (!newDate || newDate === currentDate) return;

  // 譌･莉伜ｽ｢蠑上メ繧ｧ繝・け
  if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
    showToast('譌･莉伜ｽ｢蠑上′豁｣縺励￥縺ゅｊ縺ｾ縺帙ｓ・井ｾ・ 2026-01-08・・, 'error');
    return;
  }

  showStatus('譖ｴ譁ｰ荳ｭ...', 'saving');

  // 蜷後§譌･莉倥・隴ｰ莠矩鹸繧貞・縺ｦ譖ｴ譁ｰ
  const { error } = await supabase
    .from('project_minutes')
    .update({ meeting_date: newDate })
    .eq('project_id', projectId)
    .or(`meeting_date.eq.${currentDate},meeting_date.is.null`);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('譖ｴ譁ｰ縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('謇灘粋縺帶律繧呈峩譁ｰ縺励∪縺励◆', 'success');
  await loadModalMinutesList(projectId);
}

// 隴ｰ莠矩鹸繧ｰ繝ｫ繝ｼ繝励・蜷咲ｧｰ繧堤ｷｨ髮・
async function editMinuteName(minuteId, currentName, currentDate, projectId) {
  const newName = prompt('謇灘粋縺帙・蜷咲ｧｰ繧貞・蜉帙＠縺ｦ縺上□縺輔＞・井ｾ・ 髢灘叙繧顔｢ｺ螳壽遠蜷医○・・', currentName || '');
  if (newName === null) return; // 繧ｭ繝｣繝ｳ繧ｻ繝ｫ

  showStatus('譖ｴ譁ｰ荳ｭ...', 'saving');

  // 蜷後§譌･莉倥・隴ｰ莠矩鹸繧貞・縺ｦ譖ｴ譁ｰ
  const { error } = await supabase
    .from('project_minutes')
    .update({ meeting_name: newName || null })
    .eq('project_id', projectId)
    .eq('meeting_date', currentDate);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('譖ｴ譁ｰ縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast(newName ? '蜷咲ｧｰ繧呈峩譁ｰ縺励∪縺励◆' : '蜷咲ｧｰ繧偵Μ繧ｻ繝・ヨ縺励∪縺励◆', 'success');
  await loadModalMinutesList(projectId);
}

// 蛟句挨縺ｮ隴ｰ莠矩鹸縺ｮ譌･莉倥ｒ邱ｨ髮・
async function editSingleMinuteDate(minuteId, currentDate, projectId) {
  const newDate = prompt('縺薙・隴ｰ莠矩鹸縺ｮ謇灘粋縺帶律繧貞・蜉帙＠縺ｦ縺上□縺輔＞・・YYY-MM-DD蠖｢蠑擾ｼ・', currentDate);
  if (!newDate || newDate === currentDate) return;

  // 譌･莉伜ｽ｢蠑上メ繧ｧ繝・け
  if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
    showToast('譌･莉伜ｽ｢蠑上′豁｣縺励￥縺ゅｊ縺ｾ縺帙ｓ・井ｾ・ 2026-01-08・・, 'error');
    return;
  }

  showStatus('譖ｴ譁ｰ荳ｭ...', 'saving');

  const { error } = await supabase
    .from('project_minutes')
    .update({ meeting_date: newDate })
    .eq('id', minuteId);

  if (error) {
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('譖ｴ譁ｰ縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
    return;
  }

  showStatus('菫晏ｭ俶ｸ医∩', 'saved');
  showToast('謇灘粋縺帶律繧呈峩譁ｰ縺励∪縺励◆', 'success');
  await loadModalMinutesList(projectId);
}

async function uploadMinutesWithDateModal(projectId, file) {
  // 謇灘粋縺帶律縺ｯ莉頑律縺ｮ譌･莉倥ｒ閾ｪ蜍戊ｨｭ螳・
  await uploadMinutesWithDate(projectId, file);
  loadModalMinutesList(projectId);
}

function handleDropWithDateModal(event, projectId) {
  event.preventDefault();
  event.stopPropagation();
  const file = event.dataTransfer.files[0];
  if (file) uploadMinutesWithDateModal(projectId, file);
}

async function deleteMinuteModal(minuteId, projectId) {
  if (!confirm('縺薙・隴ｰ莠矩鹸繧貞炎髯､縺励∪縺吶°・・)) return;
  await supabase.from('project_minutes').delete().eq('id', minuteId);
  showToast('隴ｰ莠矩鹸繧貞炎髯､縺励∪縺励◆', 'success');
  loadModalMinutesList(projectId);
  loadMinutesList(projectId);
}

// 繝｢繝ｼ繝繝ｫ逕ｨ蠑慕ｶ呎嶌隱ｭ縺ｿ霎ｼ縺ｿ
async function loadHandoverContent(projectId) {
  const departments = ['design', 'ic', 'exterior', 'realestate', 'construction'];

  try {
    const { data: handovers, error } = await supabase
      .from('project_handovers')
      .select('content')
      .eq('project_id', projectId);

    // 繧ｨ繝ｩ繝ｼ縺ｾ縺溘・繝・・繧ｿ縺ｪ縺励・蝣ｴ蜷医・邨ゆｺ・
    if (error || !handovers || handovers.length === 0) return;

    const data = handovers[0];
    if (data && data.content) {
      // JSON蠖｢蠑上°縺ｩ縺・°繧貞愛螳・
      let handoverData;
      try {
        handoverData = JSON.parse(data.content);
      } catch (e) {
        // 譌ｧ蠖｢蠑擾ｼ医・繝ｬ繝ｼ繝ｳ繝・く繧ｹ繝茨ｼ峨・蝣ｴ蜷医・險ｭ險医↓蜈･繧後ｋ
        handoverData = { design: data.content };
      }

      // 蜷・Κ鄂ｲ縺ｮ繝・く繧ｹ繝医お繝ｪ繧｢縺ｫ蛟､繧定ｨｭ螳・
      departments.forEach(dept => {
        const textarea = document.getElementById(`modalHandover_${dept}_${projectId}`);
        if (textarea && handoverData[dept]) {
          textarea.value = handoverData[dept];
        }
      });
    }
  } catch (e) {}
}

async function saveHandoverFromModal(projectId) {
  const departments = ['design', 'ic', 'exterior', 'realestate', 'construction'];

  // 蜷・Κ鄂ｲ縺ｮ蜀・ｮｹ繧貞庶髮・
  const handoverData = {};
  departments.forEach(dept => {
    const textarea = document.getElementById(`modalHandover_${dept}_${projectId}`);
    if (textarea && textarea.value.trim()) {
      handoverData[dept] = textarea.value.trim();
    }
  });

  const content = JSON.stringify(handoverData);

  try {
    const { data: existingList } = await supabase
      .from('project_handovers')
      .select('id')
      .eq('project_id', projectId);

    const existing = existingList && existingList.length > 0 ? existingList[0] : null;

    let error;
    if (existing) {
      ({ error } = await supabase.from('project_handovers').update({ content, updated_at: new Date().toISOString() }).eq('id', existing.id));
    } else {
      ({ error } = await supabase.from('project_handovers').insert({ project_id: projectId, content }));
    }

    if (error) { showToast('蠑慕ｶ呎嶌菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', 'error'); return; }
    showToast('蠑慕ｶ呎嶌繧剃ｿ晏ｭ倥＠縺ｾ縺励◆', 'success');
    closeCardModal();
  } catch (e) {
    showToast('蠑慕ｶ呎嶌菫晏ｭ倅ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆', 'error');
  }
}

// 謚倥ｊ縺溘◆縺ｿ讖溯・
function toggleCardSection(element) {
  const section = element.closest('.card-section');
  section.classList.toggle('collapsed');

  // 繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ隴伜挨蟄舌ｒ蜿門ｾ暦ｼ井ｾ具ｼ嗔rojectId_sectionName・・
  const card = section.closest('.project-card');
  if (card) {
    const projectId = card.dataset.projectId;
    const sectionTitle = section.querySelector('.card-section-header h4')?.textContent;
    if (projectId && sectionTitle) {
      const key = `archideck_card_${projectId}_${sectionTitle}`;
      const isCollapsed = section.classList.contains('collapsed');
      localStorage.setItem(key, isCollapsed ? 'collapsed' : 'expanded');
    }
  }
}

// 讌ｭ蜍吝・螳ｹ繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ逕ｨ縺ｮ謗剃ｻ也噪繧｢繧ｳ繝ｼ繝・ぅ繧ｪ繝ｳ・・縺､髢九￥縺ｨ莉悶′髢峨§繧具ｼ・
function toggleBizSection(element, projectId) {
  const clickedSection = element.closest('.card-section.biz-section');
  const card = document.querySelector(`.project-card[data-project-id="${projectId}"]`);
  if (!card || !clickedSection) return;

  // 蜷後§繧ｫ繝ｼ繝牙・縺ｮ蜈ｨ讌ｭ蜍吝・螳ｹ繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ繧貞叙蠕・
  const allBizSections = card.querySelectorAll('.card-section.biz-section');

  // 繧ｯ繝ｪ繝・け縺励◆繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ縺碁哩縺倥※縺・ｋ蝣ｴ蜷医・髢九￥・井ｻ悶・髢峨§繧具ｼ・
  if (clickedSection.classList.contains('collapsed')) {
    // 蜈ｨ縺ｦ髢峨§繧・
    allBizSections.forEach(sec => sec.classList.add('collapsed'));
    // 繧ｯ繝ｪ繝・け縺励◆繧ゅ・縺縺鷹幕縺・
    clickedSection.classList.remove('collapsed');
  } else {
    // 譌｢縺ｫ髢九＞縺ｦ縺・ｋ蝣ｴ蜷医・髢峨§繧・
    clickedSection.classList.add('collapsed');
  }
}

// 繧ｫ繝ｼ繝牙ｱ暮幕迥ｶ諷九ｒ蠕ｩ蜈・
function restoreCardStates(projectId) {
  const card = document.querySelector(`.project-card[data-project-id="${projectId}"]`);
  if (!card) return;

  const sections = card.querySelectorAll('.card-section');
  sections.forEach(section => {
    const sectionTitle = section.querySelector('.card-section-header h4')?.textContent;
    if (sectionTitle) {
      const key = `archideck_card_${projectId}_${sectionTitle}`;
      const savedState = localStorage.getItem(key);
      if (savedState === 'collapsed') {
        section.classList.add('collapsed');
      } else if (savedState === 'expanded') {
        section.classList.remove('collapsed');
      }
    }
  });
}

// 繝峨Λ繝・げ&繝峨Ο繝・・荳ｦ縺ｹ譖ｿ縺・
let draggedCard = null;
let customCardOrder = safeJsonParse(localStorage.getItem('archideck_card_order'), []);

function handleDragStart(event) {
  draggedCard = event.target.closest('.project-card');
  if (!draggedCard) return;
  draggedCard.classList.add('dragging');
  event.dataTransfer.effectAllowed = 'move';
  event.dataTransfer.setData('text/plain', draggedCard.dataset.projectId);
}

function handleDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';

  const targetCard = event.target.closest('.project-card');
  if (!targetCard || targetCard === draggedCard) return;

  const container = document.getElementById('projectsContainer');
  const cards = [...container.querySelectorAll('.project-card:not(.dragging)')];
  const targetIndex = cards.indexOf(targetCard);
  const draggedIndex = cards.indexOf(draggedCard);

  // 隕冶ｦ夂噪繝輔ぅ繝ｼ繝峨ヰ繝・け
  targetCard.classList.add('drag-over');
}

function handleDrop(event) {
  event.preventDefault();
  const targetCard = event.target.closest('.project-card');
  if (!targetCard || targetCard === draggedCard) return;

  const container = document.getElementById('projectsContainer');
  const rect = targetCard.getBoundingClientRect();
  const insertBefore = event.clientY < rect.top + rect.height / 2;

  if (insertBefore) {
    container.insertBefore(draggedCard, targetCard);
  } else {
    container.insertBefore(draggedCard, targetCard.nextSibling);
  }

  // 繧ｫ繧ｹ繧ｿ繝鬆・ｺ上ｒ菫晏ｭ・
  saveCardOrder();
  showToast('荳ｦ縺ｳ鬆・ｒ菫晏ｭ倥＠縺ｾ縺励◆', 'info');
}

function handleDragEnd(event) {
  if (draggedCard) {
    draggedCard.classList.remove('dragging');
  }
  // 蜈ｨ縺ｦ縺ｮdrag-over繧ｯ繝ｩ繧ｹ繧貞炎髯､
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  draggedCard = null;
}

function saveCardOrder() {
  const container = document.getElementById('projectsContainer');
  const cards = container.querySelectorAll('.project-card');
  customCardOrder = [...cards].map(card => card.dataset.projectId);
  localStorage.setItem('archideck_card_order', JSON.stringify(customCardOrder));
}

function getCustomCardOrder() {
  return safeJsonParse(localStorage.getItem('archideck_card_order'), []);
}

function clearCustomCardOrder() {
  localStorage.removeItem('archideck_card_order');
  customCardOrder = [];
  renderProjects();
  showToast('荳ｦ縺ｳ鬆・ｒ繝ｪ繧ｻ繝・ヨ縺励∪縺励◆', 'info');
}

// 繝｢繝舌う繝ｫ繧ｵ繧､繝峨ヰ繝ｼ髢矩哩
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
}

function closeSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
}

// 繝峨Λ繝・げ&繝峨Ο繝・・髢｢謨ｰ・郁ｭｰ莠矩鹸繧｢繝・・繝ｭ繝ｼ繝臥畑・・
function handleMinutesDragOver(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.add('drag-over');
}

function handleMinutesDragLeave(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');
}

function handleMinutesDrop(event, projectId) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');

  const files = event.dataTransfer.files;
  if (files.length > 0) {
    uploadMinutes(projectId, files[0]);
  }
}

// 謇灘粋縺帶律莉倥″繝峨Ο繝・・
function handleDropWithDate(event, projectId) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');

  const files = event.dataTransfer.files;
  if (files.length > 0) {
    uploadMinutesWithDate(projectId, files[0]);
  }
}

// 繝輔ぃ繧､繝ｫ驕ｸ謚槭ヨ繝ｪ繧ｬ繝ｼ
function triggerMinutesUpload(projectId) {
  document.getElementById(`minutesUpload_${projectId}`).click();
}

// 繝輔ぃ繧､繝ｫ蜷阪°繧画遠蜷医○譌･繧剃ｺ域ｸｬ
function predictMeetingDateFromFilename(filename) {
  // 讒倥・↑譌･莉倥ヱ繧ｿ繝ｼ繝ｳ繧定ｪ崎ｭ・
  const patterns = [
    // YYYYMMDD蠖｢蠑・ 20260108, 2026_01_08, 2026-01-08
    /(\d{4})[-_]?(\d{2})[-_]?(\d{2})/,
    // YYMMDD蠖｢蠑・ 260108
    /(?:^|[^\d])(\d{2})(\d{2})(\d{2})(?:[^\d]|$)/,
    // MM譛・D譌･蠖｢蠑・ 1譛・譌･, 01譛・8譌･
    /(\d{1,2})譛・\d{1,2})譌･/,
    // MM-DD蠖｢蠑・ 1-8, 01-08
    /(?:^|[^\d])(\d{1,2})[-\/](\d{1,2})(?:[^\d]|$)/,
    // R6.1.8蠖｢蠑・(莉､蜥・
    /R(\d{1,2})[.\-](\d{1,2})[.\-](\d{1,2})/i,
  ];

  for (const pattern of patterns) {
    const match = filename.match(pattern);
    if (match) {
      let year, month, day;

      if (pattern.source.includes('譛・)) {
        // MM譛・D譌･蠖｢蠑・
        year = new Date().getFullYear();
        month = parseInt(match[1], 10);
        day = parseInt(match[2], 10);
      } else if (pattern.source.includes('R')) {
        // 莉､蜥悟ｽ｢蠑・
        year = 2018 + parseInt(match[1], 10); // 莉､蜥・蟷ｴ=2019蟷ｴ
        month = parseInt(match[2], 10);
        day = parseInt(match[3], 10);
      } else if (match[1].length === 4) {
        // YYYYMMDD蠖｢蠑・
        year = parseInt(match[1], 10);
        month = parseInt(match[2], 10);
        day = parseInt(match[3], 10);
      } else if (match[1].length === 2 && match[2].length === 2 && match[3].length === 2) {
        // YYMMDD蠖｢蠑・
        year = 2000 + parseInt(match[1], 10);
        month = parseInt(match[2], 10);
        day = parseInt(match[3], 10);
      } else {
        // MM-DD蠖｢蠑・
        year = new Date().getFullYear();
        month = parseInt(match[1], 10);
        day = parseInt(match[2], 10);
      }

      // 譌･莉倥・螯･蠖捺ｧ繝√ぉ繝・け
      if (month >= 1 && month <= 12 && day >= 1 && day <= 31 && year >= 2020 && year <= 2030) {
        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      }
    }
  }

  // 莠域ｸｬ縺ｧ縺阪↑縺九▲縺溷ｴ蜷医・莉頑律縺ｮ譌･莉・
  const today = new Date();
  return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
}

// 謇灘粋縺帶律繝ｻ譯井ｻｶ蜷阪・諡・ｽ楢・ｒ蜷ｫ繧隴ｰ莠矩鹸繧｢繝・・繝ｭ繝ｼ繝・
async function uploadMinutesWithDate(projectId, file) {
  if (!file) {
    showToast('繝輔ぃ繧､繝ｫ繧帝∈謚槭＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  const project = projects.find(p => p.id === projectId);
  if (!project) {
    showToast('譯井ｻｶ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ', 'error');
    return;
  }

  // 繝輔ぃ繧､繝ｫ蜷阪°繧画遠蜷医○譌･繧剃ｺ域ｸｬ・井ｺ域ｸｬ縺ｧ縺阪↑縺代ｌ縺ｰ莉頑律縺ｮ譌･莉假ｼ・
  const meetingDate = predictMeetingDateFromFilename(file.name);

  // 繝輔ぃ繧､繝ｫ繧ｵ繧､繧ｺ繝√ぉ繝・け・・0MB荳企剞・・
  const maxSize = 10 * 1024 * 1024;
  if (file.size > maxSize) {
    showToast('繝輔ぃ繧､繝ｫ繧ｵ繧､繧ｺ縺ｯ10MB莉･荳九↓縺励※縺上□縺輔＞', 'error');
    return;
  }

  // 蟇ｾ蠢懊ヵ繧｡繧､繝ｫ蠖｢蠑上メ繧ｧ繝・け
  const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
  if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx|xls|xlsx)$/i)) {
    showToast('PDF, Word, Excel繝輔ぃ繧､繝ｫ縺ｮ縺ｿ蟇ｾ蠢懊＠縺ｦ縺・∪縺・, 'error');
    return;
  }

  // 蜈・・繝輔ぃ繧､繝ｫ蜷阪ｒ邯ｭ謖・ｼ郁｡ｨ遉ｺ逕ｨ・・
  const originalFileName = file.name;
  const ext = file.name.split('.').pop();
  const formattedDate = meetingDate.replace(/-/g, '');

  // 繧ｹ繝医Ξ繝ｼ繧ｸ逕ｨ縺ｮ繝輔ぃ繧､繝ｫ蜷搾ｼ・SCII譁・ｭ励・縺ｿ - Supabase Storage縺ｮ蛻ｶ髯仙ｯｾ蠢懶ｼ・
  const safeFileName = `${Date.now()}_${formattedDate}.${ext}`;

  showToast('繧｢繝・・繝ｭ繝ｼ繝我ｸｭ...', 'info');

  try {
    // Supabase Storage縺ｫ繧｢繝・・繝ｭ繝ｼ繝会ｼ医ヵ繧｡繧､繝ｫ蜷阪・ASCII縺ｮ縺ｿ・・
    const storagePath = `${projectId}/${safeFileName}`;
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('minutes')
      .upload(storagePath, file);

    if (uploadError) {
      logError('Storage upload error:', uploadError);
      if (uploadError.message?.includes('bucket') || uploadError.statusCode === '404') {
        showToast('繧ｹ繝医Ξ繝ｼ繧ｸ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲らｮ｡逅・・↓騾｣邨｡縺励※縺上□縺輔＞縲・, 'error');
      } else if (uploadError.message?.includes('policy')) {
        showToast('繧｢繝・・繝ｭ繝ｼ繝画ｨｩ髯舌′縺ゅｊ縺ｾ縺帙ｓ縲・, 'error');
      } else {
        showToast('繧｢繝・・繝ｭ繝ｼ繝峨↓螟ｱ謨励＠縺ｾ縺励◆: ' + (uploadError.message || 'Unknown error'), 'error');
      }
      return;
    }

    // URL繧貞叙蠕・
    const { data: urlData } = supabase.storage
      .from('minutes')
      .getPublicUrl(storagePath);

    // DB縺ｫ逋ｻ骭ｲ・亥・縺ｮ繝輔ぃ繧､繝ｫ蜷阪ｒ邯ｭ謖・+ 謇灘粋縺帶律繧剃ｺ域ｸｬ・・
    const insertData = {
      project_id: projectId,
      file_name: originalFileName,
      file_url: urlData.publicUrl || '',
      file_size: file.size || 0,
      uploaded_by: currentUser?.email || 'anonymous@archideck.jp',
      meeting_date: meetingDate // 繝輔ぃ繧､繝ｫ蜷阪°繧我ｺ域ｸｬ縺励◆謇灘粋縺帶律
    };

    const { data: insertedData, error: dbError } = await supabase
      .from('project_minutes')
      .insert(insertData)
      .select();

    if (dbError) {
      logError('DB insert error:', dbError);
      console.error('DB insert error details:', JSON.stringify(dbError));
      // 繧ｹ繝医Ξ繝ｼ繧ｸ縺ｫ繧｢繝・・繝ｭ繝ｼ繝画ｸ医∩縺ｮ繝輔ぃ繧､繝ｫ繧貞炎髯､
      await supabase.storage.from('minutes').remove([storagePath]).catch(e => console.warn('繧ｹ繝医Ξ繝ｼ繧ｸ蜑企勁繧ｨ繝ｩ繝ｼ:', e));
      showToast('隴ｰ莠矩鹸逋ｻ骭ｲ縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + (dbError.message || dbError.code || 'Unknown error'), 'error');
      return;
    }

    // 騾夂衍繧帝∽ｿ｡
    const notifyEmails = [];
    if (project.assigned_to) {
      const designer = designers.find(d => d.name === project.assigned_to);
      if (designer?.email) notifyEmails.push(designer.email);
    }
    if (project.ic_assignee) {
      const icDesigner = designers.find(d => d.name === project.ic_assignee);
      if (icDesigner?.email) notifyEmails.push(icDesigner.email);
    }
    if (project.exterior_assignee) {
      const extDesigner = designers.find(d => d.name === project.exterior_assignee);
      if (extDesigner?.email) notifyEmails.push(extDesigner.email);
    }

    for (const email of notifyEmails) {
      await supabase.from('notifications').insert({
        user_email: email,
        title: '譁ｰ縺励＞隴ｰ莠矩鹸縺後い繝・・繝ｭ繝ｼ繝峨＆繧後∪縺励◆',
        message: `${project.customer}讒倥・隴ｰ莠矩鹸縲・{autoTitle}縲阪′繧｢繝・・繝ｭ繝ｼ繝峨＆繧後∪縺励◆`,
        link: `#projects?id=${projectId}`
      }).catch(e => console.warn('騾夂衍騾∽ｿ｡繧ｨ繝ｩ繝ｼ:', e));
    }

    showToast('隴ｰ莠矩鹸繧偵い繝・・繝ｭ繝ｼ繝峨＠縺ｾ縺励◆', 'success');
    await loadMinutesList(projectId);
  } catch (error) {
    logError('Upload error:', error);
    showToast('繧｢繝・・繝ｭ繝ｼ繝峨↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
  }
}

// 蜈ｱ譛峨Γ繝｢菫晏ｭ・
async function saveSharedMemo(projectId) {
  const memo = document.getElementById(`sharedMemo_${projectId}`).value;
  const { error } = await supabase
    .from('projects')
    .update({ shared_memo: memo, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showToast('繝｡繝｢菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
    return;
  }

  const project = projects.find(p => p.id === projectId);
  if (project) project.shared_memo = memo;
  showToast('繝｡繝｢繧剃ｿ晏ｭ倥＠縺ｾ縺励◆', 'success');
}

// 蠑慕ｶ呎嶌菫晏ｭ・
async function saveHandover(projectId) {
  const content = document.getElementById(`handover_${projectId}`).value;

  try {
    // 譌｢蟄倥・蠑慕ｶ呎嶌繧堤｢ｺ隱・
    const { data: existingList } = await supabase
      .from('project_handovers')
      .select('id')
      .eq('project_id', projectId);

    const existing = existingList && existingList.length > 0 ? existingList[0] : null;

    let error;
    if (existing) {
      ({ error } = await supabase
        .from('project_handovers')
        .update({ content, updated_at: new Date().toISOString() })
        .eq('id', existing.id));
    } else {
      ({ error } = await supabase
        .from('project_handovers')
        .insert({ project_id: projectId, content }));
    }

    if (error) {
      showToast('蠑慕ｶ呎嶌菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
      return;
    }

    showToast('蠑慕ｶ呎嶌繧剃ｿ晏ｭ倥＠縺ｾ縺励◆', 'success');
  } catch (e) {
    showToast('蠑慕ｶ呎嶌菫晏ｭ倅ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆', 'error');
  }
}

// 隴ｰ莠矩鹸繧｢繝・・繝ｭ繝ｼ繝・
async function uploadMinutes(projectId, file) {
  if (!file) {
    showToast('繝輔ぃ繧､繝ｫ繧帝∈謚槭＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  // 繝輔ぃ繧､繝ｫ繧ｵ繧､繧ｺ繝√ぉ繝・け・・0MB荳企剞・・
  const maxSize = 10 * 1024 * 1024;
  if (file.size > maxSize) {
    showToast('繝輔ぃ繧､繝ｫ繧ｵ繧､繧ｺ縺ｯ10MB莉･荳九↓縺励※縺上□縺輔＞', 'error');
    return;
  }

  // 蟇ｾ蠢懊ヵ繧｡繧､繝ｫ蠖｢蠑上メ繧ｧ繝・け
  const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
  if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx|xls|xlsx)$/i)) {
    showToast('PDF, Word, Excel繝輔ぃ繧､繝ｫ縺ｮ縺ｿ蟇ｾ蠢懊＠縺ｦ縺・∪縺・, 'error');
    return;
  }

  showToast('繧｢繝・・繝ｭ繝ｼ繝我ｸｭ...', 'info');

  try {
    // Supabase Storage縺ｫ繧｢繝・・繝ｭ繝ｼ繝会ｼ医ヵ繧｡繧､繝ｫ蜷阪・ASCII縺ｮ縺ｿ・・
    const ext = file.name.split('.').pop();
    const safeStoragePath = `${projectId}/${Date.now()}.${ext}`;
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('minutes')
      .upload(safeStoragePath, file);

    if (uploadError) {
      logError('Storage upload error:', uploadError);
      // 繝舌こ繝・ヨ縺悟ｭ伜惠縺励↑縺・ｴ蜷医・繧ｨ繝ｩ繝ｼ繝｡繝・そ繝ｼ繧ｸ
      if (uploadError.message?.includes('bucket') || uploadError.statusCode === '404') {
        showToast('繧ｹ繝医Ξ繝ｼ繧ｸ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲らｮ｡逅・・↓騾｣邨｡縺励※縺上□縺輔＞縲・, 'error');
      } else if (uploadError.message?.includes('policy')) {
        showToast('繧｢繝・・繝ｭ繝ｼ繝画ｨｩ髯舌′縺ゅｊ縺ｾ縺帙ｓ縲・, 'error');
      } else {
        showToast('繧｢繝・・繝ｭ繝ｼ繝峨↓螟ｱ謨励＠縺ｾ縺励◆: ' + (uploadError.message || 'Unknown error'), 'error');
      }
      return;
    }

    // URL繧貞叙蠕・
    const { data: urlData } = supabase.storage
      .from('minutes')
      .getPublicUrl(safeStoragePath);

    // DB縺ｫ逋ｻ骭ｲ
    const insertData = {
      project_id: projectId,
      file_name: file.name,
      file_url: urlData.publicUrl || '',
      file_size: file.size || 0,
      uploaded_by: currentUser?.email || 'anonymous@archideck.jp'
    };

    const { data: insertedData, error: dbError } = await supabase
      .from('project_minutes')
      .insert(insertData)
      .select();

    if (dbError) {
      logError('DB insert error:', dbError);
      console.error('DB insert error details:', JSON.stringify(dbError));
      // 繧ｹ繝医Ξ繝ｼ繧ｸ縺ｫ繧｢繝・・繝ｭ繝ｼ繝画ｸ医∩縺ｮ繝輔ぃ繧､繝ｫ繧貞炎髯､
      await supabase.storage.from('minutes').remove([safeStoragePath]).catch(e => console.warn('繧ｹ繝医Ξ繝ｼ繧ｸ蜑企勁繧ｨ繝ｩ繝ｼ:', e));
      showToast('隴ｰ莠矩鹸逋ｻ骭ｲ縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + (dbError.message || dbError.code || 'Unknown error'), 'error');
      return;
    }

    // 騾夂衍繧帝∽ｿ｡
    const project = projects.find(p => p.id === projectId);
    if (project) {
      const notifyEmails = [];
      if (project.assigned_to) {
        const designer = designers.find(d => d.name === project.assigned_to);
        if (designer?.email) notifyEmails.push(designer.email);
      }
      if (project.ic_assignee) {
        const icDesigner = designers.find(d => d.name === project.ic_assignee);
        if (icDesigner?.email) notifyEmails.push(icDesigner.email);
      }
      if (project.exterior_assignee) {
        const extDesigner = designers.find(d => d.name === project.exterior_assignee);
        if (extDesigner?.email) notifyEmails.push(extDesigner.email);
      }

      // 騾夂衍繧奪B縺ｫ逋ｻ骭ｲ
      for (const email of notifyEmails) {
        await supabase.from('notifications').insert({
          user_email: email,
          title: '譁ｰ縺励＞隴ｰ莠矩鹸縺後い繝・・繝ｭ繝ｼ繝峨＆繧後∪縺励◆',
          message: `${project.customer}讒倥・隴ｰ莠矩鹸縲・{file.name}縲阪′繧｢繝・・繝ｭ繝ｼ繝峨＆繧後∪縺励◆`,
          link: `#projects?id=${projectId}`
        }).catch(e => console.warn('騾夂衍騾∽ｿ｡繧ｨ繝ｩ繝ｼ:', e));
      }
    }

    showToast('隴ｰ莠矩鹸繧偵い繝・・繝ｭ繝ｼ繝峨＠縺ｾ縺励◆', 'success');
    await loadMinutesList(projectId);
  } catch (error) {
    logError('Upload error:', error);
    showToast('繧｢繝・・繝ｭ繝ｼ繝峨↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
  }
}

// 隴ｰ莠矩鹸荳隕ｧ隱ｭ縺ｿ霎ｼ縺ｿ
async function loadMinutesList(projectId) {
  const container = document.getElementById(`minutesList_${projectId}`);
  if (!container) return;

  try {
    const { data: minutes, error } = await supabase
      .from('project_minutes')
      .select('*')
      .eq('project_id', projectId)
      .order('created_at', { ascending: false });

    if (error) {
      logError('Load minutes error:', error);
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">隴ｰ莠矩鹸縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆</div>';
      updateMinutesBadge(projectId, 0);
      return;
    }

    // 隴ｰ莠矩鹸謨ｰ繧偵ヰ繝・ず縺ｫ陦ｨ遉ｺ
    const minutesCount = minutes ? minutes.length : 0;
    updateMinutesBadge(projectId, minutesCount);

    if (!minutes || minutes.length === 0) {
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">繧｢繝・・繝ｭ繝ｼ繝峨＆繧後◆隴ｰ莠矩鹸縺ｯ縺ゅｊ縺ｾ縺帙ｓ</div>';
      return;
    }

    container.innerHTML = minutes.map(m => `
      <div class="minute-item" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 8px;">
        <div style="flex: 1; min-width: 0;">
          <a href="${m.file_url}" target="_blank" style="color: var(--primary-color); text-decoration: none; font-size: 13px; font-weight: 500; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            塘 ${escapeHtml(m.file_name)}
          </a>
          <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
            ${formatFileSize(m.file_size)} 窶｢ ${formatDate(m.created_at)}
          </div>
        </div>
        <button class="btn btn-small btn-ghost" onclick="deleteMinute('${m.id}', '${projectId}')" style="flex-shrink: 0; padding: 4px 8px; font-size: 12px; color: var(--danger-color);">蜑企勁</button>
      </div>
    `).join('');
  } catch (error) {
    logError('Load minutes error:', error);
    container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">隴ｰ莠矩鹸縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆</div>';
    updateMinutesBadge(projectId, 0);
  }
}

// 隴ｰ莠矩鹸繝舌ャ繧ｸ繧呈峩譁ｰ
function updateMinutesBadge(projectId, count) {
  const badge = document.getElementById(`minutesBadge_${projectId}`);
  if (badge) {
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = 'inline-flex';
    } else {
      badge.style.display = 'none';
    }
  }
}

// 蠑慕ｶ呎嶌繝舌ャ繧ｸ繧呈峩譁ｰ
function updateHandoverBadge(projectId, hasContent) {
  const badge = document.getElementById(`handoverBadge_${projectId}`);
  if (badge) {
    badge.style.display = hasContent ? 'inline-flex' : 'none';
  }
}

// 蠑慕ｶ呎嶌繝舌ャ繧ｸ繧定ｪｭ縺ｿ霎ｼ縺ｿ譎ゅ↓譖ｴ譁ｰ
async function loadHandoverBadge(projectId) {
  try {
    const { data: handovers, error } = await supabase
      .from('project_handovers')
      .select('content')
      .eq('project_id', projectId);

    if (error || !handovers || handovers.length === 0) return;

    const data = handovers[0];
    if (data && data.content) {
      let hasContent = false;
      try {
        const handoverData = JSON.parse(data.content);
        hasContent = Object.values(handoverData).some(v => v && v.trim());
      } catch (e) {
        hasContent = !!data.content.trim();
      }
      updateHandoverBadge(projectId, hasContent);
    }
  } catch (e) {}
}

// 隴ｰ莠矩鹸蜑企勁
async function deleteMinute(minuteId, projectId) {
  if (!confirm('縺薙・隴ｰ莠矩鹸繧貞炎髯､縺励∪縺吶°・・)) return;

  try {
    const { error } = await supabase
      .from('project_minutes')
      .delete()
      .eq('id', minuteId);

    if (error) throw error;
    showToast('隴ｰ莠矩鹸繧貞炎髯､縺励∪縺励◆', 'success');
    await loadMinutesList(projectId);
  } catch (error) {
    logError('Delete minute error:', error);
    showToast('蜑企勁縺ｫ螟ｱ謨励＠縺ｾ縺励◆', 'error');
  }
}

// 繝輔ぃ繧､繝ｫ繧ｵ繧､繧ｺ繝輔か繝ｼ繝槭ャ繝・
function formatFileSize(bytes) {
  if (!bytes) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// 譌･莉倥ヵ繧ｩ繝ｼ繝槭ャ繝・
function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
}

// 萓晞ｼ譌･逕ｨ縺ｮ遏ｭ縺・ヵ繧ｩ繝ｼ繝槭ャ繝茨ｼ・/D蠖｢蠑擾ｼ・
function formatDateShort(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return '';
  return `${d.getMonth() + 1}/${d.getDate()}`;
}

// HTML繧ｨ繧ｹ繧ｱ繝ｼ繝・
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

// ============================================
// 繝舌Μ繝・・繧ｷ繝ｧ繝ｳ髢｢謨ｰ
// ============================================
const Validators = {
  // 繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ讀懆ｨｼ
  isValidEmail(email) {
    if (!email) return false;
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  },

  // 繝代せ繝ｯ繝ｼ繝画､懆ｨｼ・・譁・ｭ嶺ｻ･荳翫∬恭謨ｰ蟄玲ｷｷ蝨ｨ・・
  isValidPassword(password) {
    if (!password || password.length < 8) return false;
    return /^(?=.*[a-zA-Z])(?=.*\d).{8,}$/.test(password);
  },

  // 髮ｻ隧ｱ逡ｪ蜿ｷ讀懆ｨｼ
  isValidPhone(phone) {
    if (!phone) return true; // 莉ｻ諢上ヵ繧｣繝ｼ繝ｫ繝・
    return /^[\d\-\+\(\)\s]{10,}$/.test(phone);
  },

  // 譌･莉倥′驕主悉縺ｧ縺ｪ縺・°繝√ぉ繝・け
  isNotPastDate(dateStr) {
    if (!dateStr) return true;
    const inputDate = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return inputDate >= today;
  },

  // 譌･莉倥′譛牙柑縺九メ繧ｧ繝・け
  isValidDate(dateStr) {
    if (!dateStr) return true;
    const date = new Date(dateStr);
    return !isNaN(date.getTime());
  },

  // 蠢・医ヵ繧｣繝ｼ繝ｫ繝峨メ繧ｧ繝・け
  isRequired(value) {
    if (value === null || value === undefined) return false;
    if (typeof value === 'string') return value.trim().length > 0;
    return true;
  },

  // 譁・ｭ玲焚蛻ｶ髯舌メ繧ｧ繝・け
  maxLength(value, max) {
    if (!value) return true;
    return String(value).length <= max;
  },

  // 謨ｰ蛟､遽・峇繝√ぉ繝・け
  inRange(value, min, max) {
    const num = Number(value);
    if (isNaN(num)) return false;
    return num >= min && num <= max;
  }
};

// 繝輔か繝ｼ繝繝舌Μ繝・・繧ｷ繝ｧ繝ｳ邨先棡
function validateForm(rules) {
  const errors = [];
  for (const [fieldName, validations] of Object.entries(rules)) {
    for (const { validate, message, value } of validations) {
      if (!validate(value)) {
        errors.push({ field: fieldName, message });
      }
    }
  }
  return errors;
}

// ============================================
// 繧ｨ繝ｩ繝ｼ繝上Φ繝峨Μ繝ｳ繧ｰ
// ============================================
const ErrorHandler = {
  // 繧ｨ繝ｩ繝ｼ繝｡繝・そ繝ｼ繧ｸ縺ｮ繝槭ャ繝斐Φ繧ｰ
  messages: {
    'Invalid login credentials': '繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ縺ｾ縺溘・繝代せ繝ｯ繝ｼ繝峨′豁｣縺励￥縺ゅｊ縺ｾ縺帙ｓ',
    'Email not confirmed': '繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ縺ｮ遒ｺ隱阪′螳御ｺ・＠縺ｦ縺・∪縺帙ｓ',
    'User already registered': '縺薙・繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ縺ｯ譌｢縺ｫ逋ｻ骭ｲ縺輔ｌ縺ｦ縺・∪縺・,
    'Password should be at least': '繝代せ繝ｯ繝ｼ繝峨・8譁・ｭ嶺ｻ･荳翫〒險ｭ螳壹＠縺ｦ縺上□縺輔＞',
    'Network error': '繝阪ャ繝医Ρ繝ｼ繧ｯ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆縲よ磁邯壹ｒ遒ｺ隱阪＠縺ｦ縺上□縺輔＞',
    'timeout': '繧ｿ繧､繝繧｢繧ｦ繝医＠縺ｾ縺励◆縲ょ・蠎ｦ縺願ｩｦ縺励￥縺縺輔＞',
    'duplicate key': '縺薙・繝・・繧ｿ縺ｯ譌｢縺ｫ逋ｻ骭ｲ縺輔ｌ縺ｦ縺・∪縺・,
    'foreign key constraint': '髢｢騾｣縺吶ｋ繝・・繧ｿ縺悟ｭ伜惠縺吶ｋ縺溘ａ蜑企勁縺ｧ縺阪∪縺帙ｓ',
    'permission denied': '縺薙・謫堺ｽ懊ｒ陦後≧讓ｩ髯舌′縺ゅｊ縺ｾ縺帙ｓ',
  },

  // 繧ｨ繝ｩ繝ｼ繝｡繝・そ繝ｼ繧ｸ繧貞､画鋤
  getUserMessage(error) {
    if (!error) return '莠域悄縺帙〓繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆';

    const errorMsg = error.message || String(error);

    // 繝槭ャ繝斐Φ繧ｰ縺九ｉ讀懃ｴ｢
    for (const [key, userMsg] of Object.entries(this.messages)) {
      if (errorMsg.toLowerCase().includes(key.toLowerCase())) {
        return userMsg;
      }
    }

    // Supabase繧ｨ繝ｩ繝ｼ繧ｳ繝ｼ繝牙ｯｾ蠢・
    if (error.code === 'PGRST116') return '繝・・繧ｿ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ';
    if (error.code === '23505') return '縺薙・繝・・繧ｿ縺ｯ譌｢縺ｫ蟄伜惠縺励∪縺・;
    if (error.code === '23503') return '髢｢騾｣縺吶ｋ繝・・繧ｿ縺悟ｭ伜惠縺励∪縺帙ｓ';
    if (error.code === '42501') return '縺薙・謫堺ｽ懊ｒ陦後≧讓ｩ髯舌′縺ゅｊ縺ｾ縺帙ｓ';

    // 繝・ヵ繧ｩ繝ｫ繝医Γ繝・そ繝ｼ繧ｸ
    return '繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆縲よ凾髢薙ｒ縺翫＞縺ｦ蜀榊ｺｦ縺願ｩｦ縺励￥縺縺輔＞';
  },

  // 繧ｨ繝ｩ繝ｼ繧偵Ο繧ｰ・・夂衍
  handle(error, context = '') {
    logError(`笶・繧ｨ繝ｩ繝ｼ [${context}]:`, error);

    const userMessage = this.getUserMessage(error);
    showToast(userMessage, 'error');

    // 譛ｬ逡ｪ迺ｰ蠅・〒縺ｯ繧ｨ繝ｩ繝ｼ繝ｭ繧ｰ繧帝∽ｿ｡・亥ｰ・擂螳溯｣・ｼ・
    // this.sendErrorLog(error, context);
  }
};

// ============================================
// 蛻・梵繝繝・す繝･繝懊・繝画ｩ溯・
// ============================================

function getProgressBadgeClass(progress) {
  if (progress >= 70) return 'high';
  if (progress >= 40) return 'medium';
  return 'low';
}

function generateWeeklyReport() {
  const today = new Date();
  const weekAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);

  const activeProjects = projects.filter(p => !p.is_archived);
  const completedThisWeek = projects.filter(p => {
    if (!p.is_archived) return false;
    const updated = new Date(p.updated_at);
    return updated >= weekAgo;
  });

  // 莉企ｱ譖ｴ譁ｰ縺輔ｌ縺滓｡井ｻｶ
  const updatedThisWeek = projects.filter(p => {
    const updated = new Date(p.updated_at);
    return updated >= weekAgo;
  });

  // 險ｭ險域球蠖楢・挨縺ｫ繧ｰ繝ｫ繝ｼ繝怜喧
  const designerProjects = {};
  designers.filter(d => d.category === '險ｭ險・).forEach(d => {
    designerProjects[d.name] = activeProjects.filter(p => p.assigned_to === d.name);
  });

  // IC諡・ｽ楢・挨縺ｫ繧ｰ繝ｫ繝ｼ繝怜喧・磯俣蜿也｢ｺ螳壽ｸ医∩縺ｮ縺ｿ・・
  const icProjects = {};
  designers.filter(d => d.category === 'IC').forEach(d => {
    icProjects[d.name] = activeProjects.filter(p => p.ic_assignee === d.name && p.layout_confirmed_date);
  });

  // 螟匁ｧ区球蠖楢・挨縺ｫ繧ｰ繝ｫ繝ｼ繝怜喧
  const exteriorProjects = {};
  designers.filter(d => d.category === '螟匁ｧ・).forEach(d => {
    exteriorProjects[d.name] = activeProjects.filter(p => p.exterior_assignee === d.name);
  });

  // 荳榊虚逕｣諡・ｽ楢・挨縺ｫ繧ｰ繝ｫ繝ｼ繝怜喧
  const realestateProjects = {};
  designers.filter(d => d.category === '荳榊虚逕｣').forEach(d => {
    realestateProjects[d.name] = activeProjects.filter(p => p.realestate_assignee === d.name);
  });

  // 諡・ｽ楢・挨繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ繧堤函謌撰ｼ亥・騾夐未謨ｰ・・
  const generateDesignerSection = (projs, name, categoryLabel, weekAgo) => {
    const projectDetails = projs.map(p => {
      const progress = calculateProgress(p);
      const progressData = p.progress || {};

      // 荳ｻ隕√ち繧ｹ繧ｯ縺ｮ繧ｹ繝・・繧ｿ繧ｹ繧貞叙蠕暦ｼ亥虚逧・ｼ・
      const statuses = getMainTaskStatuses(progressData, categoryLabel === 'IC' ? 'IC' : '險ｭ險・);
      const statusText = statuses.length > 0 ? statuses.join(' / ') : '譛ｪ逹謇・;
      const wasUpdated = new Date(p.updated_at) >= weekAgo;

      return `<div class="report-project-detail ${wasUpdated ? 'updated' : ''}">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
          <span style="font-weight: 600;">${escapeHtml(p.customer)}</span>
          <span class="report-progress-badge ${getProgressBadgeClass(progress)}">${progress}%</span>
        </div>
        <div style="font-size: 12px; color: var(--text-secondary);">${statusText}</div>
        ${wasUpdated ? '<div style="font-size: 11px; color: var(--primary-color); margin-top: 4px;">統 莉企ｱ譖ｴ譁ｰ</div>' : ''}
      </div>`;
    }).join('');

    return `<div class="report-designer-section">
      <div class="report-designer-header">
        <span class="report-designer-name">${escapeHtml(name)}</span>
        <span class="report-designer-count">${projs.length}莉ｶ</span>
      </div>
      ${projectDetails}
    </div>`;
  };

  const designerSections = Object.entries(designerProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateDesignerSection(projs, name, '險ｭ險・, weekAgo))
    .join('');

  const icSections = Object.entries(icProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateDesignerSection(projs, name, 'IC', weekAgo))
    .join('');

  const exteriorSections = Object.entries(exteriorProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateDesignerSection(projs, name, '螟匁ｧ・, weekAgo))
    .join('');

  const realestateSections = Object.entries(realestateProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateDesignerSection(projs, name, '荳榊虚逕｣', weekAgo))
    .join('');

  const report = `
    <div class="report-card">
      <div class="report-header">
        <h2>騾ｱ蝣ｱ</h2>
        <span class="report-period">${weekAgo.toLocaleDateString('ja-JP')} 縲・${today.toLocaleDateString('ja-JP')}</span>
      </div>
      <div class="report-stats-grid">
        <div class="report-stat-item">
          <div class="report-stat-value">${activeProjects.length}</div>
          <div class="report-stat-label">騾ｲ陦御ｸｭ</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${updatedThisWeek.length}</div>
          <div class="report-stat-label">莉企ｱ譖ｴ譁ｰ</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${completedThisWeek.length}</div>
          <div class="report-stat-label">莉企ｱ螳御ｺ・/div>
        </div>
      </div>
      <div class="report-section">
        <div class="report-section-title">盗 險ｭ險域球蠖楢・挨 譯井ｻｶ迥ｶ豕・/div>
        ${designerSections || '<div class="report-empty">騾ｲ陦御ｸｭ縺ｮ譯井ｻｶ縺ｯ縺ゅｊ縺ｾ縺帙ｓ</div>'}
      </div>
      ${icSections ? `
      <div class="report-section">
        <div class="report-section-title">耳 IC諡・ｽ楢・挨 譯井ｻｶ迥ｶ豕・/div>
        ${icSections}
      </div>` : ''}
      ${exteriorSections ? `
      <div class="report-section">
        <div class="report-section-title">元 螟匁ｧ区球蠖楢・挨 譯井ｻｶ迥ｶ豕・/div>
        ${exteriorSections}
      </div>` : ''}
      ${realestateSections ? `
      <div class="report-section">
        <div class="report-section-title">匠 荳榊虚逕｣諡・ｽ楢・挨 譯井ｻｶ迥ｶ豕・/div>
        ${realestateSections}
      </div>` : ''}
      ${completedThisWeek.length > 0 ? `
      <div class="report-section">
        <div class="report-section-title">莉企ｱ縺ｮ螳御ｺ・｡井ｻｶ</div>
        <ul class="report-list">
          ${completedThisWeek.map(p => `<li class="report-list-item">
            <span class="report-project-name">${escapeHtml(p.customer)}</span>
            <span class="report-assignee">${escapeHtml(p.assigned_to || '譛ｪ蜑ｲ蠖・)}</span>
          </li>`).join('')}
        </ul>
      </div>` : ''}
    </div>
  `;

  const preview = document.getElementById('reportPreview');
  preview.style.display = 'block';
  preview.innerHTML = report;
  showToast('騾ｱ蝣ｱ繧堤函謌舌＠縺ｾ縺励◆', 'success');
}

function generateMonthlyReport() {
  const today = new Date();
  const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

  const activeProjects = projects.filter(p => !p.is_archived);
  const completedThisMonth = projects.filter(p => {
    if (!p.is_archived) return false;
    const updated = new Date(p.updated_at);
    return updated >= monthAgo;
  });

  // 莉頑怦譖ｴ譁ｰ縺輔ｌ縺滓｡井ｻｶ
  const updatedThisMonth = projects.filter(p => {
    const updated = new Date(p.updated_at);
    return updated >= monthAgo;
  });

  const completionRate = projects.length > 0 ? Math.round(completedThisMonth.length / projects.length * 100) : 0;

  // 險ｭ險域球蠖楢・挨縺ｫ繧ｰ繝ｫ繝ｼ繝怜喧
  const designerProjects = {};
  designers.filter(d => d.category === '險ｭ險・).forEach(d => {
    designerProjects[d.name] = activeProjects.filter(p => p.assigned_to === d.name);
  });

  // IC諡・ｽ楢・挨縺ｫ繧ｰ繝ｫ繝ｼ繝怜喧・磯俣蜿也｢ｺ螳壽ｸ医∩縺ｮ縺ｿ・・
  const icProjects = {};
  designers.filter(d => d.category === 'IC').forEach(d => {
    icProjects[d.name] = activeProjects.filter(p => p.ic_assignee === d.name && p.layout_confirmed_date);
  });

  // 螟匁ｧ区球蠖楢・挨縺ｫ繧ｰ繝ｫ繝ｼ繝怜喧
  const exteriorProjects = {};
  designers.filter(d => d.category === '螟匁ｧ・).forEach(d => {
    exteriorProjects[d.name] = activeProjects.filter(p => p.exterior_assignee === d.name);
  });

  // 荳榊虚逕｣諡・ｽ楢・挨縺ｫ繧ｰ繝ｫ繝ｼ繝怜喧
  const realestateProjects = {};
  designers.filter(d => d.category === '荳榊虚逕｣').forEach(d => {
    realestateProjects[d.name] = activeProjects.filter(p => p.realestate_assignee === d.name);
  });

  // 諡・ｽ楢・＃縺ｨ縺ｮ繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ逕滓・・亥・騾夐未謨ｰ・・
  const generateMonthlySection = (projs, name, category, monthAgo) => {
    const projectDetails = projs.map(p => {
      const progressData = p.progress || {};
      const updatedAt = new Date(p.updated_at);
      const isUpdated = updatedAt >= monthAgo;

      // 繧ｿ繧ｹ繧ｯ繧ｹ繝・・繧ｿ繧ｹ繧貞庶髮・ｼ亥虚逧・ｼ・
      const statuses = getMainTaskStatuses(progressData, category);

      const statusTags = statuses.map(s =>
        `<span class="report-status-tag active">${s}</span>`
      ).join('');

      return `<div class="report-project-detail ${isUpdated ? 'updated' : ''}">
        <div class="report-project-title">
          <span class="project-name">${escapeHtml(p.customer)}</span>
          ${isUpdated ? '<span class="report-updated-badge">莉頑怦譖ｴ譁ｰ</span>' : ''}
        </div>
        ${statusTags ? `<div class="report-status-list">${statusTags}</div>` : '<div class="report-status-list"><span class="report-status-tag">譛ｪ逹謇・/span></div>'}
      </div>`;
    }).join('');

    return `<div class="report-designer-section">
      <div class="report-designer-header">
        <span class="report-designer-name">${escapeHtml(name)}</span>
        <span class="report-designer-count">${projs.length}莉ｶ</span>
      </div>
      ${projectDetails}
    </div>`;
  };

  const designerSections = Object.entries(designerProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateMonthlySection(projs, name, '險ｭ險・, monthAgo))
    .join('');

  const icSections = Object.entries(icProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateMonthlySection(projs, name, 'IC', monthAgo))
    .join('');

  const exteriorSections = Object.entries(exteriorProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateMonthlySection(projs, name, '螟匁ｧ・, monthAgo))
    .join('');

  const realestateSections = Object.entries(realestateProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateMonthlySection(projs, name, '荳榊虚逕｣', monthAgo))
    .join('');

  const report = `
    <div class="report-card">
      <div class="report-header">
        <h2>譛亥ｱ</h2>
        <span class="report-period">${monthAgo.toLocaleDateString('ja-JP')} 縲・${today.toLocaleDateString('ja-JP')}</span>
      </div>
      <div class="report-stats-grid">
        <div class="report-stat-item">
          <div class="report-stat-value">${projects.length}</div>
          <div class="report-stat-label">邱乗｡井ｻｶ謨ｰ</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${activeProjects.length}</div>
          <div class="report-stat-label">騾ｲ陦御ｸｭ</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${updatedThisMonth.length}</div>
          <div class="report-stat-label">莉頑怦譖ｴ譁ｰ</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${completedThisMonth.length}</div>
          <div class="report-stat-label">莉頑怦螳御ｺ・/div>
        </div>
      </div>
      <div class="report-section">
        <div class="report-section-title">盗 險ｭ險域球蠖楢・挨 譯井ｻｶ迥ｶ豕・/div>
        ${designerSections || '<div class="report-empty">騾ｲ陦御ｸｭ縺ｮ譯井ｻｶ縺ｯ縺ゅｊ縺ｾ縺帙ｓ</div>'}
      </div>
      ${icSections ? `
      <div class="report-section">
        <div class="report-section-title">耳 IC諡・ｽ楢・挨 譯井ｻｶ迥ｶ豕・/div>
        ${icSections}
      </div>` : ''}
      ${exteriorSections ? `
      <div class="report-section">
        <div class="report-section-title">元 螟匁ｧ区球蠖楢・挨 譯井ｻｶ迥ｶ豕・/div>
        ${exteriorSections}
      </div>` : ''}
      ${realestateSections ? `
      <div class="report-section">
        <div class="report-section-title">匠 荳榊虚逕｣諡・ｽ楢・挨 譯井ｻｶ迥ｶ豕・/div>
        ${realestateSections}
      </div>` : ''}
      ${completedThisMonth.length > 0 ? `
      <div class="report-section">
        <div class="report-section-title">莉頑怦縺ｮ螳御ｺ・｡井ｻｶ</div>
        <ul class="report-list">
          ${completedThisMonth.map(p => `<li class="report-list-item">
            <span class="report-project-name">${escapeHtml(p.customer)}</span>
            <span class="report-assignee">${escapeHtml(p.assigned_to || '譛ｪ蜑ｲ蠖・)}</span>
          </li>`).join('')}
        </ul>
      </div>` : ''}
    </div>
  `;

  const preview = document.getElementById('reportPreview');
  preview.style.display = 'block';
  preview.innerHTML = report;
  showToast('譛亥ｱ繧堤函謌舌＠縺ｾ縺励◆', 'success');
}

function exportAnalyticsCSV() {
  const headers = ['譯井ｻｶ蜷・, '險ｭ險域球蠖・, 'IC諡・ｽ・, '螟匁ｧ区球蠖・, '荳榊虚逕｣諡・ｽ・, '蝠・刀', '騾ｲ謐礼紫', '繧ｹ繝・・繧ｿ繧ｹ', '菴懈・譌･'];
  const rows = projects.map(p => [
    p.customer,
    p.assigned_to || '',
    p.ic_assignee || '',
    p.exterior_assignee || '',
    p.realestate_assignee || '',
    p.specifications || '',
    calculateProgress(p) + '%',
    p.is_archived ? '螳御ｺ・ : '騾ｲ陦御ｸｭ',
    p.created_at ? new Date(p.created_at).toLocaleDateString('ja-JP') : ''
  ]);

  const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
  const bom = '\uFEFF';
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `archideck_analytics_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV繧偵ム繧ｦ繝ｳ繝ｭ繝ｼ繝峨＠縺ｾ縺励◆', 'success');
}

// ============================================
// 髻ｳ螢ｰ蜈･蜉帶ｩ溯・
// ============================================
let recognition = null;

function initVoiceInput() {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;
    recognition.interimResults = false;
  }
}

function startVoiceInput(targetInputId) {
  if (!recognition) {
    showToast('髻ｳ螢ｰ蜈･蜉帙・縺薙・繝悶Λ繧ｦ繧ｶ縺ｧ繧ｵ繝昴・繝医＆繧後※縺・∪縺帙ｓ', 'error');
    return;
  }

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    const input = document.getElementById(targetInputId);
    if (input) {
      input.value = transcript;
      showToast('髻ｳ螢ｰ蜈･蜉帛ｮ御ｺ・, 'success');
    }
  };

  recognition.onerror = (event) => {
    showToast('髻ｳ螢ｰ隱崎ｭ倥お繝ｩ繝ｼ: ' + event.error, 'error');
  };

  recognition.start();
  showToast('隧ｱ縺励※縺上□縺輔＞...', 'info');
}

// 蛻晄悄蛹匁凾縺ｫ髻ｳ螢ｰ蜈･蜉帙ｒ繧ｻ繝・ヨ繧｢繝・・
document.addEventListener('DOMContentLoaded', initVoiceInput);

// ============================================
// FC・医ヵ繝ｩ繝ｳ繝√Ε繧､繧ｺ・臥ｮ｡逅・
// ============================================
let fcOrganizations = [];

async function loadFcOrganizations() {
  try {
    const { data, error } = await supabaseWithTimeout(() =>
      supabase.from('fc_organizations').select('*').order('created_at', { ascending: false }),
      10000
    );

    if (error) {
      // 繝・・繝悶Ν縺悟ｭ伜惠縺励↑縺・ｴ蜷医・繧ｹ繧ｭ繝・・
      if (error.code === '42P01') {
        warn('fc_organizations繝・・繝悶Ν縺悟ｭ伜惠縺励∪縺帙ｓ');
        return;
      }
      throw error;
    }

    fcOrganizations = data || [];
    renderFcList();
  } catch (e) {
    warn('FC邨・ｹ碑ｪｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ縺ｾ縺溘・繧ｿ繧､繝繧｢繧ｦ繝・', e);
    fcOrganizations = [];
  }
}

function renderFcList() {
  const container = document.getElementById('fcListContainer');
  if (!container) return;

  if (fcOrganizations.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">宵</div>
        <p>FC縺檎匳骭ｲ縺輔ｌ縺ｦ縺・∪縺帙ｓ<br><small>縲・ FC霑ｽ蜉縲阪・繧ｿ繝ｳ縺九ｉ逋ｻ骭ｲ縺励※縺上□縺輔＞</small></p>
      </div>
    `;
    return;
  }

  const baseUrl = window.location.origin;

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>FC蜷・/th>
            <th>繧ｹ繝ｩ繝・げ</th>
            <th>蟆ら畑URL</th>
            <th>繧ｹ繝・・繧ｿ繧ｹ</th>
            <th>菴懈・譌･</th>
            <th>謫堺ｽ・/th>
          </tr>
        </thead>
        <tbody>
          ${fcOrganizations.map(fc => `
            <tr>
              <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="display: inline-block; width: 16px; height: 16px; border-radius: 4px; background: ${escapeHtml(fc.primary_color || '#2563EB')};"></span>
                  <strong>${escapeHtml(fc.name)}</strong>
                </div>
              </td>
              <td><code style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px;">${escapeHtml(fc.slug)}</code></td>
              <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <a href="${baseUrl}/fc/${escapeHtml(fc.slug)}/" target="_blank" style="font-size: 13px; color: var(--primary-color);">
                    /fc/${escapeHtml(fc.slug)}/
                  </a>
                  <button class="btn btn-ghost btn-small" onclick="copyFcUrl('${escapeHtml(fc.slug)}')" title="URL繧偵さ繝斐・">搭</button>
                </div>
              </td>
              <td>
                ${fc.is_active
                  ? '<span class="badge badge-success">譛牙柑</span>'
                  : '<span class="badge badge-secondary">辟｡蜉ｹ</span>'}
              </td>
              <td style="font-size: 13px; color: var(--text-secondary);">${new Date(fc.created_at).toLocaleDateString('ja-JP')}</td>
              <td>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-ghost btn-small" onclick="editFc('${fc.id}')">邱ｨ髮・/button>
                  <button class="btn btn-danger btn-small" onclick="deleteFc('${fc.id}')">蜑企勁</button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function copyFcUrl(slug) {
  const baseUrl = window.location.origin;
  const url = `${baseUrl}/fc/${slug}/`;
  navigator.clipboard.writeText(url).then(() => {
    showToast('URL繧偵さ繝斐・縺励∪縺励◆', 'success');
  }).catch(() => {
    showToast('繧ｳ繝斐・縺ｫ螟ｱ謨励＠縺ｾ縺励◆', 'error');
  });
}

function openFcModal(fcId = null) {
  const modal = document.getElementById('fcModal');
  const title = document.getElementById('fcModalTitle');

  document.getElementById('fcForm').reset();
  document.getElementById('fcId').value = '';
  document.getElementById('fcColor').value = '#2563EB';
  document.getElementById('fcColorText').value = '#2563EB';
  document.getElementById('fcIsActive').checked = true;

  if (fcId) {
    const fc = fcOrganizations.find(f => f.id === fcId);
    if (!fc) return;

    title.textContent = 'FC邱ｨ髮・;
    document.getElementById('fcId').value = fc.id;
    document.getElementById('fcName').value = fc.name;
    document.getElementById('fcSlug').value = fc.slug;
    document.getElementById('fcEmail').value = fc.contact_email || '';
    document.getElementById('fcTel').value = fc.contact_tel || '';
    document.getElementById('fcColor').value = fc.primary_color || '#2563EB';
    document.getElementById('fcColorText').value = fc.primary_color || '#2563EB';
    document.getElementById('fcLogoUrl').value = fc.logo_url || '';
    document.getElementById('fcIsActive').checked = fc.is_active !== false;
  } else {
    title.textContent = 'FC霑ｽ蜉';
  }

  ModalManager.open(modal, '#fcName');
}

function closeFcModal() {
  ModalManager.close(document.getElementById('fcModal'));
}

async function saveFc() {
  // 莠碁㍾繧ｯ繝ｪ繝・け髦ｲ豁｢
  if (SaveGuard.isLocked('saveFc')) return;

  const id = document.getElementById('fcId').value;
  const name = document.getElementById('fcName').value.trim();
  const slug = document.getElementById('fcSlug').value.trim().toLowerCase();
  const contactEmail = document.getElementById('fcEmail').value.trim();
  const contactTel = document.getElementById('fcTel').value.trim();
  const primaryColor = document.getElementById('fcColor').value;
  const logoUrl = document.getElementById('fcLogoUrl').value.trim();
  const isActive = document.getElementById('fcIsActive').checked;

  if (!name || !slug) {
    showToast('FC蜷阪→繧ｹ繝ｩ繝・げ縺ｯ蠢・医〒縺・, 'error');
    return;
  }

  // 繧ｹ繝ｩ繝・げ縺ｮ蠖｢蠑上メ繧ｧ繝・け
  if (!/^[a-z0-9-]+$/.test(slug)) {
    showToast('繧ｹ繝ｩ繝・げ縺ｯ蜊願ｧ定恭謨ｰ蟄励→繝上う繝輔Φ縺ｮ縺ｿ菴ｿ逕ｨ蜿ｯ閭ｽ縺ｧ縺・, 'error');
    return;
  }

  await SaveGuard.run('saveFc', async () => {
    showStatus('菫晏ｭ倅ｸｭ...', 'saving');

    const fcData = {
      name,
      slug,
      contact_email: contactEmail || null,
      contact_tel: contactTel || null,
      primary_color: primaryColor,
      logo_url: logoUrl || null,
      is_active: isActive,
      updated_at: new Date().toISOString()
    };

    let result;
    if (id) {
      result = await supabase
        .from('fc_organizations')
        .update(fcData)
        .eq('id', id)
        .select();
    } else {
      result = await supabase
        .from('fc_organizations')
        .insert([fcData])
        .select();
    }

    if (result.error) {
      if (result.error.code === '23505') {
        showToast('縺薙・繧ｹ繝ｩ繝・げ縺ｯ譌｢縺ｫ菴ｿ逕ｨ縺輔ｌ縺ｦ縺・∪縺・, 'error');
      } else {
        showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + result.error.message, 'error');
      }
      showStatus('繧ｨ繝ｩ繝ｼ', 'error');
      return;
    }

    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast(id ? 'FC繧呈峩譁ｰ縺励∪縺励◆' : 'FC繧定ｿｽ蜉縺励∪縺励◆', 'success');
    closeFcModal();
    await loadFcOrganizations();
  });
}

function editFc(fcId) {
  openFcModal(fcId);
}

async function deleteFc(fcId) {
  const fc = fcOrganizations.find(f => f.id === fcId);
  if (!fc) return;

  if (!confirm(`FC縲・{fc.name}縲阪ｒ蜑企勁縺励∪縺吶°・歃n\n蜑企勁縺吶ｋ縺ｨ縲：C蟆ら畑URL縺ｫ繧｢繧ｯ繧ｻ繧ｹ縺ｧ縺阪↑縺上↑繧翫∪縺吶Ａ)) {
    return;
  }

  await SaveGuard.run(`deleteFc_${fcId}`, async () => {
    showStatus('蜑企勁荳ｭ...', 'saving');

    const { error } = await supabase
      .from('fc_organizations')
      .delete()
      .eq('id', fcId);

    if (error) {
      showStatus('繧ｨ繝ｩ繝ｼ', 'error');
      showToast('蜑企勁縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
      return;
    }

    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast('FC繧貞炎髯､縺励∪縺励◆', 'success');
    await loadFcOrganizations();
  });
}

// ============================================
// 繧ｫ繧ｹ繧ｿ繝槭う繧ｺ讖溯・・・C蜷代￠繝弱・繧ｳ繝ｼ繝会ｼ・
// ============================================
function loadCustomization() {
  if (!currentOrganization) return;

  document.getElementById('customOrgName').value = currentOrganization.name || '';
  document.getElementById('customLogoUrl').value = currentOrganization.logo_url || '';
  document.getElementById('customPrimaryColor').value = currentOrganization.primary_color || '#2563EB';
  document.getElementById('customPrimaryColorText').value = currentOrganization.primary_color || '#2563EB';
  document.getElementById('customSecondaryColor').value = currentOrganization.secondary_color || '#059669';
  document.getElementById('customSecondaryColorText').value = currentOrganization.secondary_color || '#059669';

  updatePreview();
}

function previewCustomization() {
  const primaryColor = document.getElementById('customPrimaryColor').value;
  const secondaryColor = document.getElementById('customSecondaryColor').value;
  const name = document.getElementById('customOrgName').value;
  const logoUrl = document.getElementById('customLogoUrl').value;

  // CSS繧ｫ繧ｹ繧ｿ繝繝励Ο繝代ユ繧｣繧呈峩譁ｰ
  document.documentElement.style.setProperty('--primary-color', primaryColor);
  document.documentElement.style.setProperty('--secondary-color', secondaryColor);

  // 繧ｿ繧､繝医Ν繧呈峩譁ｰ
  if (name) {
    document.title = `ArchiDeck | ${name}`;
  }

  // 繝励Ξ繝薙Η繝ｼ鬆伜沺繧呈峩譁ｰ
  updatePreview();
  showToast('繝励Ξ繝薙Η繝ｼ繧帝←逕ｨ縺励∪縺励◆', 'success');
}

function updatePreview() {
  const primaryColor = document.getElementById('customPrimaryColor')?.value || '#2563EB';
  const secondaryColor = document.getElementById('customSecondaryColor')?.value || '#1E40AF';
  const name = document.getElementById('customOrgName')?.value || '';
  const logoUrl = document.getElementById('customLogoUrl')?.value || '';

  const previewLogo = document.getElementById('previewLogo');
  const previewTitle = document.getElementById('previewTitle');

  // null 繝√ぉ繝・け
  if (!previewLogo || !previewTitle) return;

  // 繧ｫ繝ｩ繝ｼ蛟､縺ｮ讀懆ｨｼ・・RRGGBB蠖｢蠑上・縺ｿ險ｱ蜿ｯ・・
  const isValidColor = (color) => /^#[0-9A-Fa-f]{6}$/.test(color);
  const safePrimary = isValidColor(primaryColor) ? primaryColor : '#2563EB';
  const safeSecondary = isValidColor(secondaryColor) ? secondaryColor : '#1E40AF';

  if (logoUrl) {
    // XSS蟇ｾ遲・ URL繧偵お繧ｹ繧ｱ繝ｼ繝励＠縲”ttp縺ｾ縺溘・https縺ｮ縺ｿ險ｱ蜿ｯ
    const isValidUrl = /^https?:\/\//i.test(logoUrl);
    if (isValidUrl) {
      const img = document.createElement('img');
      img.src = logoUrl;
      img.style.cssText = 'max-width: 32px; max-height: 32px; object-fit: contain;';
      img.onerror = () => { previewLogo.innerHTML = '匠'; };
      previewLogo.innerHTML = '';
      previewLogo.appendChild(img);
    } else {
      previewLogo.innerHTML = '匠';
    }
  } else {
    previewLogo.innerHTML = '匠';
    previewLogo.style.background = `linear-gradient(135deg, ${safePrimary}, ${safeSecondary})`;
  }

  previewTitle.textContent = name || 'ArchiDeck';
}

async function saveCustomization() {
  if (!currentOrganization) {
    showToast('邨・ｹ疲ュ蝣ｱ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ', 'error');
    return;
  }

  const statusEl = document.getElementById('customizeStatus');
  statusEl.innerHTML = '<span style="color: var(--text-muted);">菫晏ｭ倅ｸｭ...</span>';

  const updates = {
    name: document.getElementById('customOrgName').value,
    logo_url: document.getElementById('customLogoUrl').value,
    primary_color: document.getElementById('customPrimaryColor').value,
    secondary_color: document.getElementById('customSecondaryColor').value,
    updated_at: new Date().toISOString()
  };

  const { error } = await supabase
    .from('organizations')
    .update(updates)
    .eq('id', currentOrganization.id);

  if (error) {
    statusEl.innerHTML = `<span style="color: var(--danger-color);">菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆</span>`;
    logError('繧ｫ繧ｹ繧ｿ繝槭う繧ｺ菫晏ｭ倥お繝ｩ繝ｼ:', error);
    return;
  }

  // 繝ｭ繝ｼ繧ｫ繝ｫ縺ｮ邨・ｹ疲ュ蝣ｱ繧呈峩譁ｰ
  Object.assign(currentOrganization, updates);

  // 逕ｻ髱｢縺ｫ驕ｩ逕ｨ
  applyWhiteLabel(currentOrganization);

  statusEl.innerHTML = '<span style="color: var(--success-color);">菫晏ｭ倥＠縺ｾ縺励◆</span>';
  showToast('繧ｫ繧ｹ繧ｿ繝槭う繧ｺ繧剃ｿ晏ｭ倥＠縺ｾ縺励◆', 'success');

  setTimeout(() => {
    statusEl.innerHTML = '';
  }, 3000);
}

function resetCustomization() {
  document.getElementById('customOrgName').value = '';
  document.getElementById('customLogoUrl').value = '';
  document.getElementById('customPrimaryColor').value = '#2563EB';
  document.getElementById('customPrimaryColorText').value = '#2563EB';
  document.getElementById('customSecondaryColor').value = '#059669';
  document.getElementById('customSecondaryColorText').value = '#059669';

  // CSS繧ｫ繧ｹ繧ｿ繝繝励Ο繝代ユ繧｣繧偵ョ繝輔か繝ｫ繝医↓繝ｪ繧ｻ繝・ヨ
  document.documentElement.style.setProperty('--primary-color', '#2563EB');
  document.documentElement.style.setProperty('--secondary-color', '#059669');
  document.title = 'ArchiDeck | G繝上え繧ｹ 險ｭ險域･ｭ蜍咏ｮ｡逅・す繧ｹ繝・Β';

  updatePreview();
  showToast('繝・ヵ繧ｩ繝ｫ繝郁ｨｭ螳壹↓繝ｪ繧ｻ繝・ヨ縺励∪縺励◆', 'success');
}

// 繧ｫ繝ｩ繝ｼ繝斐ャ繧ｫ繝ｼ縺ｮ蜷梧悄
document.addEventListener('DOMContentLoaded', function() {
  const primaryColorPicker = document.getElementById('customPrimaryColor');
  const primaryColorText = document.getElementById('customPrimaryColorText');
  const secondaryColorPicker = document.getElementById('customSecondaryColor');
  const secondaryColorText = document.getElementById('customSecondaryColorText');

  if (primaryColorPicker && primaryColorText) {
    primaryColorPicker.addEventListener('input', function() {
      primaryColorText.value = this.value;
      updatePreview();
    });
  }

  if (secondaryColorPicker && secondaryColorText) {
    secondaryColorPicker.addEventListener('input', function() {
      secondaryColorText.value = this.value;
      updatePreview();
    });
  }
});

// ============================================
// 閾ｪ蜍輔ヰ繝・け繧｢繝・・讖溯・
// ============================================
let autoBackupEnabled = localStorage.getItem('autoBackupEnabled') !== 'false';

function toggleAutoBackup() {
  const toggle = document.getElementById('autoBackupToggle');
  autoBackupEnabled = toggle.checked;
  localStorage.setItem('autoBackupEnabled', autoBackupEnabled);
  showToast(autoBackupEnabled ? '閾ｪ蜍輔ヰ繝・け繧｢繝・・繧呈怏蜉ｹ蛹悶＠縺ｾ縺励◆' : '閾ｪ蜍輔ヰ繝・け繧｢繝・・繧堤┌蜉ｹ蛹悶＠縺ｾ縺励◆', 'info');
}

function saveAutoBackup() {
  if (!autoBackupEnabled) return;

  try {
    const backup = {
      version: '4.3',
      created_at: new Date().toISOString(),
      data: {
        projects: projects,
        designers: designers,
        tasksV2: tasksV2,
        vendors: vendors,
        emailTemplates: emailTemplates,
        products: products,
        vendorCategories: vendorCategories,
        taskVendorMappings: taskVendorMappings
      }
    };

    const json = JSON.stringify(backup);

    // 繧ｵ繧､繧ｺ繝√ぉ繝・け (5MB蛻ｶ髯・
    if (json.length > 5 * 1024 * 1024) {
      warn('笞・・繝舌ャ繧ｯ繧｢繝・・繧ｵ繧､繧ｺ縺悟､ｧ縺阪☆縺弱∪縺吶ゅΟ繝ｼ繧ｫ繝ｫ菫晏ｭ倥ｒ繧ｹ繧ｭ繝・・縺励∪縺吶・);
      return;
    }

    localStorage.setItem('archideck_auto_backup', json);
    localStorage.setItem('archideck_last_backup', new Date().toISOString());

    // 繝舌ャ繧ｯ繧｢繝・・螻･豁ｴ繧剃ｿ晄戟・域怙螟ｧ3莉ｶ・・
    const history = safeJsonParse(localStorage.getItem('archideck_backup_history'), []);
    history.unshift({
      timestamp: new Date().toISOString(),
      projectCount: projects.length,
      designerCount: designers.length
    });
    if (history.length > 3) history.pop();
    localStorage.setItem('archideck_backup_history', JSON.stringify(history));

    updateBackupUI();
    log('笨・閾ｪ蜍輔ヰ繝・け繧｢繝・・螳御ｺ・', new Date().toLocaleString());
  } catch (e) {
    warn('閾ｪ蜍輔ヰ繝・け繧｢繝・・繧ｨ繝ｩ繝ｼ:', e);
  }
}

function updateBackupUI() {
  const lastBackupEl = document.getElementById('lastBackupTime');
  const countEl = document.getElementById('localBackupCount');
  const toggleEl = document.getElementById('autoBackupToggle');

  if (lastBackupEl) {
    const lastBackup = localStorage.getItem('archideck_last_backup');
    lastBackupEl.textContent = lastBackup ? new Date(lastBackup).toLocaleString('ja-JP') : '-';
  }

  if (countEl) {
    const history = safeJsonParse(localStorage.getItem('archideck_backup_history'), []);
    countEl.textContent = history.length.toString();
  }

  if (toggleEl) {
    toggleEl.checked = autoBackupEnabled;
  }
}

function downloadLocalBackup() {
  const backup = localStorage.getItem('archideck_auto_backup');
  if (!backup) {
    showToast('繝ｭ繝ｼ繧ｫ繝ｫ繝舌ャ繧ｯ繧｢繝・・縺後≠繧翫∪縺帙ｓ', 'warning');
    return;
  }

  const blob = new Blob([backup], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `archideck_local_backup_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url); // 繝｡繝｢繝ｪ隗｣謾ｾ
  showToast('繝ｭ繝ｼ繧ｫ繝ｫ繝舌ャ繧ｯ繧｢繝・・繧偵ム繧ｦ繝ｳ繝ｭ繝ｼ繝峨＠縺ｾ縺励◆', 'success');
}

// 蛻晄悄蛹匁凾縺ｫ繝舌ャ繧ｯ繧｢繝・・UI繧呈峩譁ｰ
setTimeout(updateBackupUI, 1000);

// 螳壽悄逧・↓閾ｪ蜍輔ヰ繝・け繧｢繝・・・・蛻・＃縺ｨ・・
setInterval(() => {
  if (projects.length > 0 || designers.length > 0) {
    saveAutoBackup();
  }
}, 5 * 60 * 1000);

// 繝舌ャ繧ｯ繧｢繝・・菴懈・
async function createBackup() {
  const statusEl = document.getElementById('backupStatus');
  statusEl.innerHTML = '<span style="color: var(--text-muted);">繝舌ャ繧ｯ繧｢繝・・繧剃ｽ懈・荳ｭ...</span>';

  try {
    const backup = {
      version: '4.1',
      created_at: new Date().toISOString(),
      data: {
        projects: projects,
        designers: designers,
        tasksV2: tasksV2,
        vendors: vendors,
        emailTemplates: emailTemplates,
        products: products,
        vendorCategories: vendorCategories,
        taskVendorMappings: taskVendorMappings
      }
    };

    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `archideck_backup_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url); // 繝｡繝｢繝ｪ隗｣謾ｾ

    statusEl.innerHTML = '<span style="color: var(--success-color);">笨・繝舌ャ繧ｯ繧｢繝・・繧剃ｽ懈・縺励∪縺励◆</span>';
    showToast('繝舌ャ繧ｯ繧｢繝・・繝輔ぃ繧､繝ｫ繧偵ム繧ｦ繝ｳ繝ｭ繝ｼ繝峨＠縺ｾ縺励◆', 'success');
  } catch (error) {
    logError('Backup error:', error);
    statusEl.innerHTML = '<span style="color: var(--danger-color);">笶・繝舌ャ繧ｯ繧｢繝・・縺ｮ菴懈・縺ｫ螟ｱ謨励＠縺ｾ縺励◆</span>';
    showToast('繝舌ャ繧ｯ繧｢繝・・縺ｮ菴懈・縺ｫ螟ｱ謨励＠縺ｾ縺励◆', 'error');
  }
}

// 繝舌ャ繧ｯ繧｢繝・・蠕ｩ蜈・
function restoreBackup() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.json';
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!confirm('迴ｾ蝨ｨ縺ｮ繝・・繧ｿ縺御ｸ頑嶌縺阪＆繧後∪縺吶よ悽蠖薙↓蠕ｩ蜈・＠縺ｾ縺吶°・・)) return;

    const statusEl = document.getElementById('backupStatus');
    statusEl.innerHTML = '<span style="color: var(--text-muted);">蠕ｩ蜈・ｸｭ...</span>';

    try {
      const text = await file.text();
      const backup = JSON.parse(text);

      if (!backup.version || !backup.data) {
        throw new Error('辟｡蜉ｹ縺ｪ繝舌ャ繧ｯ繧｢繝・・繝輔ぃ繧､繝ｫ縺ｧ縺・);
      }

      // 蜷・ユ繝ｼ繝悶Ν繧貞ｾｩ蜈・
      const tables = ['projects', 'designers', 'vendors', 'email_templates', 'products', 'vendor_categories'];
      const dataMap = {
        projects: backup.data.projects,
        designers: backup.data.designers,
        vendors: backup.data.vendors,
        email_templates: backup.data.emailTemplates,
        products: backup.data.products,
        vendor_categories: backup.data.vendorCategories
      };

      let totalItems = 0;
      let failedItems = 0;

      for (const table of tables) {
        const data = dataMap[table];
        if (data && data.length > 0) {
          // 譌｢蟄倥ョ繝ｼ繧ｿ繧貞炎髯､縺励※蠕ｩ蜈・
          await supabase.from(table).delete().neq('id', '00000000-0000-0000-0000-000000000000');
          for (const item of data) {
            totalItems++;
            const { error } = await supabase.from(table).insert(item);
            if (error) {
              failedItems++;
              logError(`蠕ｩ蜈・お繝ｩ繝ｼ (${table}):`, error);
            }
          }
        }
      }

      if (failedItems > 0) {
        statusEl.innerHTML = `<span style="color: var(--warning-color);">笞・・蠕ｩ蜈・ｮ御ｺ・ｼ・{failedItems}/${totalItems}莉ｶ螟ｱ謨暦ｼ峨ゅ・繝ｼ繧ｸ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ縺励※縺上□縺輔＞縲・/span>`;
        showToast(`蠕ｩ蜈・ｮ御ｺ・ｼ・{failedItems}莉ｶ螟ｱ謨暦ｼ荏, 'warning');
      } else {
        statusEl.innerHTML = '<span style="color: var(--success-color);">笨・蠕ｩ蜈・′螳御ｺ・＠縺ｾ縺励◆縲ゅ・繝ｼ繧ｸ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ縺励※縺上□縺輔＞縲・/span>';
        showToast('蠕ｩ蜈・′螳御ｺ・＠縺ｾ縺励◆', 'success');
      }
    } catch (error) {
      logError('Restore error:', error);
      statusEl.innerHTML = '<span style="color: var(--danger-color);">笶・蠕ｩ蜈・↓螟ｱ謨励＠縺ｾ縺励◆</span>';
      showToast('蠕ｩ蜈・↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
    }
  };
  fileInput.click();
}

// kintone蟷ｴ蠎ｦ蛻･繧｢繝励Μ邂｡逅・
let kintoneApps = []; // { year: '2025', appId: '123', label: '2025蟷ｴ蠎ｦ' }

// 蟷ｴ蠎ｦ繧｢繝励Μ陦後ｒ霑ｽ蜉
function addKintoneAppRow(year = '', appId = '') {
  const currentYear = new Date().getFullYear();
  if (!year) year = String(currentYear);

  const container = document.getElementById('kintoneAppsList');
  if (!container) return;

  const rowId = 'kintoneApp_' + Date.now();
  const row = document.createElement('div');
  row.id = rowId;
  row.style.cssText = 'display: flex; gap: 8px; align-items: center;';
  row.innerHTML = `
    <input type="text" class="form-input kintone-app-year" placeholder="蟷ｴ蠎ｦ・井ｾ具ｼ・025・・ value="${year}" style="width: 100px;">
    <input type="text" class="form-input kintone-app-id" placeholder="繧｢繝励ΜID" value="${appId}" style="flex: 1;">
    <button class="btn btn-danger btn-small" onclick="removeKintoneAppRow('${rowId}')" style="padding: 6px 10px;">笨・/button>
  `;
  container.appendChild(row);

  updateKintoneImportYearSelect();
}

// 蟷ｴ蠎ｦ繧｢繝励Μ陦後ｒ蜑企勁
function removeKintoneAppRow(rowId) {
  const row = document.getElementById(rowId);
  if (row) row.remove();
  updateKintoneImportYearSelect();
}

// 繧｢繝励Μ荳隕ｧ繧貞叙蠕・
function getKintoneAppsFromUI() {
  const apps = [];
  const rows = document.querySelectorAll('#kintoneAppsList > div');
  rows.forEach(row => {
    const year = row.querySelector('.kintone-app-year')?.value?.trim();
    const appId = row.querySelector('.kintone-app-id')?.value?.trim();
    if (year && appId) {
      apps.push({ year, appId, label: year + '蟷ｴ蠎ｦ' });
    }
  });
  return apps;
}

// 繧｢繝励Μ荳隕ｧ繧旦I縺ｫ謠冗判
function renderKintoneApps(apps) {
  const container = document.getElementById('kintoneAppsList');
  if (!container) return;
  container.innerHTML = '';

  if (apps && apps.length > 0) {
    apps.forEach(app => {
      addKintoneAppRow(app.year, app.appId);
    });
  } else {
    // 繝・ヵ繧ｩ繝ｫ繝医〒莉雁ｹｴ蠎ｦ繧定ｿｽ蜉
    addKintoneAppRow();
  }
}

// 繧､繝ｳ繝昴・繝亥ｹｴ蠎ｦ驕ｸ謚槭ｒ譖ｴ譁ｰ
function updateKintoneImportYearSelect() {
  const container = document.getElementById('kintoneImportYearSelect');
  if (!container) return;

  const apps = getKintoneAppsFromUI();
  if (apps.length === 0) {
    container.innerHTML = '<span style="color: var(--text-muted); font-size: 12px;">蟷ｴ蠎ｦ蛻･繧｢繝励Μ繧定ｨｭ螳壹＠縺ｦ縺上□縺輔＞</span>';
    return;
  }

  container.innerHTML = apps.map(app => `
    <label style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer; font-size: 13px;">
      <input type="checkbox" class="kintone-import-year" value="${app.appId}" data-year="${app.year}" checked>
      ${app.label}
    </label>
  `).join('') + `
    <label style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer; font-size: 13px;">
      <input type="checkbox" id="kintoneImportAllYears" onchange="toggleAllKintoneYears(this.checked)" checked>
      蜈ｨ驕ｸ謚・
    </label>
  `;
}

// 蜈ｨ蟷ｴ蠎ｦ驕ｸ謚・隗｣髯､
function toggleAllKintoneYears(checked) {
  document.querySelectorAll('.kintone-import-year').forEach(cb => {
    cb.checked = checked;
  });
}

// 驕ｸ謚槭＆繧後◆蟷ｴ蠎ｦ縺ｮ繧｢繝励ΜID繧貞叙蠕・
function getSelectedKintoneAppIds() {
  const selected = [];
  document.querySelectorAll('.kintone-import-year:checked').forEach(cb => {
    selected.push({ appId: cb.value, year: cb.dataset.year });
  });
  return selected;
}

// kintone騾｣謳ｺ險ｭ螳壻ｿ晏ｭ・
async function saveKintoneSettings() {
  try {
    // 蟷ｴ蠎ｦ蛻･繧｢繝励Μ繧貞叙蠕・
    const apps = getKintoneAppsFromUI();

    // 蠕梧婿莠呈鋤諤ｧ縺ｮ縺溘ａ縲∵怙蛻昴・繧｢繝励ΜID繧誕pp_id縺ｫ險ｭ螳・
    const primaryAppId = apps.length > 0 ? apps[0].appId : '';
    document.getElementById('kintoneAppId').value = primaryAppId;

    const settings = {
      domain: document.getElementById('kintoneDomain').value,
      app_id: primaryAppId,
      api_token: document.getElementById('kintoneApiToken').value,
      field_sales: document.getElementById('kintoneFieldSales')?.value || '',
      field_design: document.getElementById('kintoneFieldDesign')?.value || '',
      field_ic: document.getElementById('kintoneFieldIC')?.value || '',
      field_construction: document.getElementById('kintoneFieldConstruction')?.value || '',
      apps: apps // 蟷ｴ蠎ｦ蛻･繧｢繝励Μ驟榊・繧定ｿｽ蜉
    };

    // 繝輔ぅ繝ｼ繝ｫ繝峨・繝・ヴ繝ｳ繧ｰ繧値ocalStorage縺ｫ繧ゅヰ繝・け繧｢繝・・菫晏ｭ・
    const fieldMappings = {
      customer: document.getElementById('kintoneFieldCustomer')?.value || '',
      layout: document.getElementById('kintoneFieldLayout')?.value || '',
      permit: document.getElementById('kintoneFieldPermit')?.value || '',
      meeting: document.getElementById('kintoneFieldMeeting')?.value || '',
      product: document.getElementById('kintoneFieldProduct')?.value || '',
      sales: settings.field_sales,
      design: settings.field_design,
      ic: settings.field_ic,
      construction: settings.field_construction,
      exterior: document.getElementById('kintoneFieldExterior')?.value || ''
    };
    localStorage.setItem('kintone_field_mappings', JSON.stringify(fieldMappings));

    // 蟷ｴ蠎ｦ蛻･繧｢繝励Μ繧ＭocalStorage縺ｫ菫晏ｭ・
    localStorage.setItem('kintone_apps', JSON.stringify(apps));

    if (!settings.domain || !settings.api_token) {
      showToast('繝峨Γ繧､繝ｳ縺ｨAPI繝医・繧ｯ繝ｳ縺ｯ蠢・医〒縺・, 'error');
      return;
    }

    if (apps.length === 0) {
      showToast('蟆代↑縺上→繧・縺､縺ｮ蟷ｴ蠎ｦ繧｢繝励Μ繧定ｨｭ螳壹＠縺ｦ縺上□縺輔＞', 'error');
      return;
    }

    // 譌｢蟄倥Ξ繧ｳ繝ｼ繝峨ｒ遒ｺ隱・
    const { data: existing } = await supabase
      .from('kintone_settings')
      .select('id')
      .eq('is_active', true)
      .limit(1);

    // apps驟榊・縺ｯJSON縺ｨ縺励※菫晏ｭ假ｼ医ョ繝ｼ繧ｿ繝吶・繧ｹ縺ｫ縺ｯapps_json縺ｨ縺励※・・
    const dbSettings = {
      domain: settings.domain,
      app_id: settings.app_id,
      api_token: settings.api_token,
      field_sales: settings.field_sales,
      field_design: settings.field_design,
      field_ic: settings.field_ic,
      field_construction: settings.field_construction,
      apps_json: JSON.stringify(apps),
      field_mappings_json: JSON.stringify(fieldMappings)
    };

    let error;
    if (existing && existing.length > 0) {
      // 譌｢蟄倥Ξ繧ｳ繝ｼ繝峨ｒ譖ｴ譁ｰ
      ({ error } = await supabase
        .from('kintone_settings')
        .update({
          ...dbSettings,
          updated_at: new Date().toISOString()
        })
        .eq('id', existing[0].id));
    } else {
      // 譁ｰ隕丈ｽ懈・
      ({ error } = await supabase
        .from('kintone_settings')
        .insert({
          ...dbSettings,
          is_active: true
        }));
    }

    if (error) {
      // apps_json繧ｫ繝ｩ繝縺後↑縺・ｴ蜷医・辟｡隕悶＠縺ｦ邯夊｡・
      if (!error.message.includes('apps_json')) {
        showToast('險ｭ螳壻ｿ晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆: ' + error.message, 'error');
        return;
      }
    }

    kintoneSettings = settings;
    kintoneApps = apps;
    showToast('kintone險ｭ螳壹ｒ菫晏ｭ倥＠縺ｾ縺励◆', 'success');
  } catch (e) {
    console.error('kintone險ｭ螳壻ｿ晏ｭ倥お繝ｩ繝ｼ:', e);
    showToast('險ｭ螳壻ｿ晏ｭ倅ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆', 'error');
  }
}

// kintone謗･邯壹ユ繧ｹ繝茨ｼ・dge Function邨檎罰・・
async function testKintoneConnection() {
  const domain = document.getElementById('kintoneDomain').value;
  const appId = document.getElementById('kintoneAppId').value;
  const apiToken = document.getElementById('kintoneApiToken').value;

  if (!domain || !appId || !apiToken) {
    showToast('縺吶∋縺ｦ縺ｮ鬆・岼繧貞・蜉帙＠縺ｦ縺上□縺輔＞', 'error');
    return;
  }

  // 縺ｾ縺夊ｨｭ螳壹ｒ菫晏ｭ・
  await saveKintoneSettings();

  document.getElementById('kintoneStatus').innerHTML = '<span style="color: var(--text-muted);">謗･邯壹ユ繧ｹ繝井ｸｭ...</span>';

  try {
    const result = await callKintoneProxy('test');

    if (result.success) {
      document.getElementById('kintoneStatus').innerHTML =
        `<span style="color: var(--success-color);">笨・謗･邯壽・蜉滂ｼ√い繝励Μ縲・{result.data?.name || appId}縲阪↓謗･邯壹＠縺ｾ縺励◆</span>`;
      showToast('kintone謗･邯壹↓謌仙粥縺励∪縺励◆', 'success');
    } else {
      // 隧ｳ邏ｰ繧ｨ繝ｩ繝ｼ諠・ｱ繧定｡ｨ遉ｺ
      let errorMsg = result.error || '謗･邯壹↓螟ｱ謨励＠縺ｾ縺励◆';
      if (result.hint) errorMsg += `<br><small style="color: var(--text-muted);">${result.hint}</small>`;
      if (result.details) errorMsg += `<br><small style="color: var(--text-muted);">${result.details}</small>`;
      document.getElementById('kintoneStatus').innerHTML =
        `<span style="color: var(--danger-color);">笶・${errorMsg}</span>`;
      showToast('kintone謗･邯壹↓螟ｱ謨励＠縺ｾ縺励◆: ' + result.error, 'error');
    }
  } catch (e) {
    document.getElementById('kintoneStatus').innerHTML =
      `<span style="color: var(--danger-color);">笶・繧ｨ繝ｩ繝ｼ: ${e.message}</span>`;
    showToast('謗･邯壹ユ繧ｹ繝井ｸｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆', 'error');
  }
}

// kintone Proxy蜻ｼ縺ｳ蜃ｺ縺暦ｼ・dge Function邨檎罰・・
async function callKintoneProxy(action, data = {}) {
  try {
    const response = await supabase.functions.invoke('kintone-proxy', {
      body: { action, data }
    });

    // Edge Function縺九ｉ縺ｮ繧ｨ繝ｩ繝ｼ繝ｬ繧ｹ繝昴Φ繧ｹ
    if (response.error) {
      console.error('Edge Function error:', response.error);
      return { success: false, error: response.error.message || 'Edge Function 繧ｨ繝ｩ繝ｼ' };
    }

    // 繝ｬ繧ｹ繝昴Φ繧ｹ繝・・繧ｿ繧堤｢ｺ隱・
    if (response.data) {
      // Edge Function縺後お繝ｩ繝ｼ繧定ｿ斐＠縺溷ｴ蜷茨ｼ・uccess: false縺ｮ蝣ｴ蜷茨ｼ・
      if (response.data.success === false) {
        console.error('kintone-proxy returned error:', response.data);
        return response.data;
      }
      return response.data;
    }

    return { success: false, error: '繝ｬ繧ｹ繝昴Φ繧ｹ縺檎ｩｺ縺ｧ縺・ };
  } catch (e) {
    console.error('callKintoneProxy exception:', e);
    return { success: false, error: e.message };
  }
}

// kintone縺九ｉ繝ｬ繧ｳ繝ｼ繝牙叙蠕・
async function fetchKintoneRecords(query = '', fields = []) {
  return await callKintoneProxy('getRecords', { query, fields });
}

// kintone縺ｸ繝ｬ繧ｳ繝ｼ繝芽ｿｽ蜉
async function addKintoneRecord(record) {
  return await callKintoneProxy('addRecord', { record });
}

// kintone繝ｬ繧ｳ繝ｼ繝画峩譁ｰ
async function updateKintoneRecord(recordId, record) {
  return await callKintoneProxy('updateRecord', { recordId, record });
}

// kintone繧､繝ｳ繝昴・繝亥燕縺ｮ繝舌Μ繝・・繧ｷ繝ｧ繝ｳ
async function validateKintoneImport() {
  // 1. kintone險ｭ螳壹′菫晏ｭ倥＆繧後※縺・ｋ縺狗｢ｺ隱・
  const { data: settings, error: settingsError } = await supabase
    .from('kintone_settings')
    .select('*')
    .eq('is_active', true)
    .limit(1);

  if (settingsError) {
    return { valid: false, error: `DB謗･邯壹お繝ｩ繝ｼ: ${settingsError.message}` };
  }

  if (!settings || settings.length === 0) {
    return { valid: false, error: 'kintone險ｭ螳壹′菫晏ｭ倥＆繧後※縺・∪縺帙ｓ縲ょ・縺ｫ謗･邯夊ｨｭ螳壹ｒ菫晏ｭ倥＠縺ｦ縺上□縺輔＞縲・ };
  }

  const config = settings[0];

  // 2. 蠢・医ヵ繧｣繝ｼ繝ｫ繝峨・遒ｺ隱・
  if (!config.domain || !config.app_id || !config.api_token) {
    return { valid: false, error: 'kintone謗･邯夊ｨｭ螳壹′荳榊ｮ悟・縺ｧ縺吶ゅラ繝｡繧､繝ｳ縲√い繝励ΜID縲、PI繝医・繧ｯ繝ｳ繧定ｨｭ螳壹＠縺ｦ縺上□縺輔＞縲・ };
  }

  // 3. 繝輔ぅ繝ｼ繝ｫ繝峨・繝・ヴ繝ｳ繧ｰ縺ｮ遒ｺ隱・
  const fieldMappings = safeJsonParse(localStorage.getItem('kintone_field_mappings'), {});
  if (!fieldMappings.customer) {
    return { valid: false, error: '鬘ｧ螳｢蜷阪ヵ繧｣繝ｼ繝ｫ繝峨′險ｭ螳壹＆繧後※縺・∪縺帙ｓ縲ゅヵ繧｣繝ｼ繝ｫ繝峨・繝・ヴ繝ｳ繧ｰ繧定ｨｭ螳壹＠縺ｦ縺上□縺輔＞縲・ };
  }

  // 4. 謗･邯壹ユ繧ｹ繝茨ｼ育ｰ｡譏難ｼ・
  const testResult = await callKintoneProxy('test');
  if (!testResult.success) {
    return { valid: false, error: `kintone謗･邯壹↓螟ｱ謨励＠縺ｾ縺励◆: ${testResult.error}` };
  }

  return { valid: true };
}

// kintone縺九ｉ逶ｴ謗･繧､繝ｳ繝昴・繝・- 螳悟・菫ｮ豁｣迚・v2
async function importFromKintoneDirect() {
  const statusEl = document.getElementById('kintoneImportStatus');
  statusEl.innerHTML = '<span style="color: var(--text-muted);">踏 繧､繝ｳ繝昴・繝域ｺ門ｙ荳ｭ...</span>';

  try {
    // 0. 繧､繝ｳ繝昴・繝亥燕縺ｮ繝舌Μ繝・・繧ｷ繝ｧ繝ｳ
    const validation = await validateKintoneImport();
    if (!validation.valid) {
      statusEl.innerHTML = `<span style="color: var(--danger-color);">笶・${validation.error}</span>`;
      return;
    }

    // 繝・Δ繝・・繧ｿ縺悟ｭ伜惠縺吶ｋ蝣ｴ蜷医・隴ｦ蜻・
    const demoProjects = projects.filter(p => !p.kintone_record_id);
    if (demoProjects.length > 0) {
      const proceed = confirm(
        `笞・・繝・Δ繝・・繧ｿ縺・{demoProjects.length}莉ｶ縺ゅｊ縺ｾ縺兔n\n` +
        `蜷後§鬘ｧ螳｢蜷阪・kintone繝ｬ繧ｳ繝ｼ繝峨′縺ゅｋ蝣ｴ蜷医∵里蟄倥・繝・Δ繝・・繧ｿ縺渓intone騾｣謳ｺ縺ｫ螟画鋤縺輔ｌ縺ｾ縺吶・n\n` +
        `繧､繝ｳ繝昴・繝亥燕縺ｫ繝・Δ繝・・繧ｿ繧貞炎髯､縺吶ｋ縺薙→繧偵♀蜍ｧ繧√＠縺ｾ縺吶・n` +
        `・郁ｨｭ螳・> kintone > 繝・・繧ｿ謨ｴ逅・> 繝・Δ繝・・繧ｿ繧貞炎髯､・噂n\n` +
        `縺薙・縺ｾ縺ｾ邯夊｡後＠縺ｾ縺吶°・歔
      );
      if (!proceed) {
        statusEl.innerHTML = '<span style="color: var(--text-muted);">繧､繝ｳ繝昴・繝医ｒ繧ｭ繝｣繝ｳ繧ｻ繝ｫ縺励∪縺励◆</span>';
        return;
      }
    }

    statusEl.innerHTML = '<span style="color: var(--text-muted);">踏 kintone縺九ｉ繝・・繧ｿ繧貞叙蠕嶺ｸｭ...</span>';

    // 1. 繝輔ぅ繝ｼ繝ｫ繝峨・繝・ヴ繝ｳ繧ｰ繧貞叙蠕・
    const fieldMappings = safeJsonParse(localStorage.getItem('kintone_field_mappings'), {});
    const customerField = fieldMappings.customer || '譁・ｭ誉蝓ｺ譛ｬ諠・ｱ_縺雁ｮ｢讒伜錐_繝｡繧､繝ｳ';
    const salesField = fieldMappings.sales || '繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚枩蝓ｺ譛ｬ諠・ｱ_蝟ｶ讌ｭ';
    const designField = fieldMappings.design || '繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚枩蝓ｺ譛ｬ諠・ｱ_險ｭ險・;
    const icField = fieldMappings.ic || '繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚枩蝓ｺ譛ｬ諠・ｱ_IC';
    const constructionField = fieldMappings.construction || '繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚枩蝓ｺ譛ｬ諠・ｱ_蟾･莠・;
    const exteriorField = fieldMappings.exterior || '';
    // 譌･莉倥ヵ繧｣繝ｼ繝ｫ繝・
    const layoutField = fieldMappings.layout || '';
    const permitField = fieldMappings.permit || '';
    const meetingField = fieldMappings.meeting || '';
    // 蝠・刀繝輔ぅ繝ｼ繝ｫ繝・
    const productField = fieldMappings.product || '';

    console.log('Field mappings:', { customerField, salesField, designField, icField, constructionField, exteriorField, layoutField, permitField, meetingField, productField });

    // 2. kintone縺九ｉ繝ｬ繧ｳ繝ｼ繝牙叙蠕暦ｼ亥・莉ｶ蜿門ｾ・- 500莉ｶ蛻ｶ髯仙屓驕ｿ・・
    const result = await callKintoneProxy('getAllRecords');
    console.log('Kintone result:', result);

    if (!result.success) {
      statusEl.innerHTML = `<span style="color: var(--danger-color);">笶・${result.error}</span>`;
      return;
    }

    const records = result.data?.records || [];
    const hitLimit = result.data?.hitLimit || false;
    const warning = result.data?.warning || null;

    if (records.length === 0) {
      statusEl.innerHTML = '<span style="color: var(--warning-color);">笞・・繝ｬ繧ｳ繝ｼ繝峨′隕九▽縺九ｊ縺ｾ縺帙ｓ縺ｧ縺励◆</span>';
      return;
    }

    // 10,000莉ｶ蛻ｶ髯占ｭｦ蜻・
    if (warning) {
      console.warn('kintone隴ｦ蜻・', warning);
    }

    // 繝・ヰ繝・げ: 繝輔ぅ繝ｼ繝ｫ繝我ｸ隕ｧ・域怙蛻昴・1莉ｶ縺ｮ縺ｿ・・
    if (records.length > 0) {
      console.log('Available fields:', Object.keys(records[0]));
      console.log('Sample record $id:', records[0]['$id']);
      console.log('Sample record 繝ｬ繧ｳ繝ｼ繝臥分蜿ｷ:', records[0]['繝ｬ繧ｳ繝ｼ繝臥分蜿ｷ']);
    }
    console.log('Total records from kintone:', records.length, hitLimit ? '(10,000莉ｶ蛻ｶ髯舌↓蛻ｰ驕・' : '');

    statusEl.innerHTML = `<span style="color: var(--text-muted);">踏 ${records.length}莉ｶ縺ｮ繝ｬ繧ｳ繝ｼ繝峨ｒ蜃ｦ逅・ｸｭ...${hitLimit ? ' (10,000莉ｶ蛻ｶ髯・' : ''}</span>`;

    // 3. 譌｢蟄俶｡井ｻｶ繧談intone_record_id縺ｧ繧､繝ｳ繝・ャ繧ｯ繧ｹ蛹厄ｼ磯ｫ倬滓､懃ｴ｢逕ｨ・・
    const projectsByKintoneId = new Map();
    const projectsByCustomer = new Map();
    for (const p of projects) {
      if (p.kintone_record_id) {
        projectsByKintoneId.set(String(p.kintone_record_id), p);
      }
      // 鬘ｧ螳｢蜷阪〒繧ゅう繝ｳ繝・ャ繧ｯ繧ｹ・・intone_record_id縺後↑縺・ｴ蜷医・繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ逕ｨ・・
      // 縺溘□縺励〔intone繝・・繧ｿ縺ｧ縺ｪ縺・里蟄倥ョ繝ｼ繧ｿ縺ｮ縺ｿ・域ｷｷ蝨ｨ髦ｲ豁｢・・
      if (!p.kintone_record_id && p.customer) {
        projectsByCustomer.set(p.customer, p);
      }
    }
    console.log('Existing projects indexed:', {
      byKintoneId: projectsByKintoneId.size,
      byCustomer: projectsByCustomer.size
    });

    let imported = 0;
    let updated = 0;
    let skipped = 0;
    let skippedNoCustomer = 0;
    let skippedNoRecordId = 0;
    const errors = [];
    const processedKintoneIds = new Set(); // 驥崎､・・逅・亟豁｢

    for (const record of records) {
      try {
        // 4. kintone 繝ｬ繧ｳ繝ｼ繝迂D繧貞叙蠕暦ｼ亥ｿ・茨ｼ・
        const kintoneRecordId = extractKintoneRecordId(record);

        if (!kintoneRecordId) {
          console.warn('kintone_record_id not found in record:', record);
          skipped++;
          skippedNoRecordId++;
          continue;
        }

        // 驥崎､・メ繧ｧ繝・け・亥酔縺鰐intone_record_id縺瑚､・焚蝗槫・逅・＆繧後↑縺・ｈ縺・↓・・
        if (processedKintoneIds.has(kintoneRecordId)) {
          console.warn('Duplicate kintone_record_id:', kintoneRecordId);
          skipped++;
          continue;
        }
        processedKintoneIds.add(kintoneRecordId);

        // 5. 繝輔ぅ繝ｼ繝ｫ繝牙､繧貞ｮ牙・縺ｫ蜿門ｾ・
        const getValue = (field) => {
          if (!field) return null;
          const val = record[field]?.value;
          if (val === undefined || val === null) return null;
          if (Array.isArray(val)) {
            const names = val.map(v => v.name || v.code || String(v)).filter(Boolean);
            return names.length > 0 ? names.join(', ') : null;
          }
          const strVal = String(val).trim();
          return strVal || null;
        };

        const customer = getValue(customerField);
        if (!customer) {
          skipped++;
          skippedNoCustomer++;
          continue;
        }

        // 6. 譌｢蟄俶｡井ｻｶ繧堤｢ｺ隱搾ｼ・intone_record_id繧貞━蜈茨ｼ・
        let existingProject = projectsByKintoneId.get(kintoneRecordId);

        // kintone_record_id縺ｧ繝槭ャ繝√＠縺ｪ縺・ｴ蜷医・｡ｧ螳｢蜷阪〒kintone譛ｪ騾｣謳ｺ縺ｮ譌｢蟄倥ョ繝ｼ繧ｿ繧呈､懃ｴ｢
        // 縺溘□縺励√％繧後・蛻晏屓繧､繝ｳ繝昴・繝域凾縺ｮ縺ｿ譛牙柑・域ｷｷ蝨ｨ髦ｲ豁｢・・
        if (!existingProject) {
          const customerMatch = projectsByCustomer.get(customer);
          if (customerMatch && !customerMatch.kintone_record_id) {
            existingProject = customerMatch;
            // 縺薙・譯井ｻｶ繧談intone騾｣謳ｺ縺ｨ縺励※譖ｴ譁ｰ縺吶ｋ縺溘ａ縲√・繝・・縺九ｉ蜑企勁
            projectsByCustomer.delete(customer);
          }
        }

        // 諡・ｽ楢・ヵ繧｣繝ｼ繝ｫ繝牙､・亥錐蜑阪・繝・メ繝ｳ繧ｰ驕ｩ逕ｨ・・
        const designValRaw = getValue(designField);
        const icValRaw = getValue(icField);
        const salesValRaw = getValue(salesField);
        const constructionValRaw = getValue(constructionField);
        const exteriorValRaw = exteriorField ? getValue(exteriorField) : null;

        // 諡・ｽ楢・錐繧偵す繧ｹ繝・Β蜀・・蜷榊燕縺ｫ繝槭ャ繝√Φ繧ｰ
        const designVal = matchDesignerName(designValRaw, '險ｭ險・);
        const icVal = matchDesignerName(icValRaw, 'IC');
        const salesVal = matchDesignerName(salesValRaw, '蝟ｶ讌ｭ');
        const constructionVal = matchDesignerName(constructionValRaw, '蟾･莠・);
        const exteriorVal = exteriorValRaw ? matchDesignerName(exteriorValRaw, '螟匁ｧ・) : null;

        // 譌･莉倥ヵ繧｣繝ｼ繝ｫ繝牙､・郁､・焚蠖｢蠑丞ｯｾ蠢懶ｼ・
        const layoutDate = parseDateValue(record, layoutField);
        const permitDate = parseDateValue(record, permitField);
        const meetingDate = parseDateValue(record, meetingField);

        // 蝠・刀繝輔ぅ繝ｼ繝ｫ繝牙､
        const productVal = productField ? getValue(productField) : null;

        if (existingProject) {
          // 7. 譖ｴ譁ｰ
          const updateData = {
            updated_at: new Date().toISOString(),
            kintone_record_id: kintoneRecordId // 蠢・★險ｭ螳・
          };

          if (designVal) updateData.assigned_to = designVal;
          if (icVal) updateData.ic_assignee = icVal;
          if (salesVal) updateData.sales_assignee = salesVal;
          if (constructionVal) updateData.construction_assignee = constructionVal;
          if (exteriorVal) updateData.exterior_assignee = exteriorVal;
          if (layoutDate) updateData.layout_confirmed_date = layoutDate;
          if (permitDate) updateData.construction_permit_date = permitDate;
          if (meetingDate) updateData.pre_contract_meeting_date = meetingDate;
          if (productVal) updateData.specifications = productVal;

          const { error } = await supabase
            .from('projects')
            .update(updateData)
            .eq('id', existingProject.id);

          if (error) {
            errors.push({ type: 'update', customer, kintoneRecordId, error: error.message, code: error.code });
            skipped++;
          } else {
            Object.assign(existingProject, updateData);
            // 繧､繝ｳ繝・ャ繧ｯ繧ｹ繧よ峩譁ｰ
            projectsByKintoneId.set(kintoneRecordId, existingProject);
            updated++;
          }
        } else {
          // 8. 譁ｰ隕丈ｽ懈・
          const insertData = {
            customer,
            status: 'active',
            progress: {},
            specifications: productVal || 'LIFE',
            kintone_record_id: kintoneRecordId // 蠢・★險ｭ螳・
          };

          if (designVal) insertData.assigned_to = designVal;
          if (icVal) insertData.ic_assignee = icVal;
          if (salesVal) insertData.sales_assignee = salesVal;
          if (constructionVal) insertData.construction_assignee = constructionVal;
          if (exteriorVal) insertData.exterior_assignee = exteriorVal;
          if (layoutDate) insertData.layout_confirmed_date = layoutDate;
          if (permitDate) insertData.construction_permit_date = permitDate;
          if (meetingDate) insertData.pre_contract_meeting_date = meetingDate;

          const { data: newProject, error } = await supabase
            .from('projects')
            .insert(insertData)
            .select()
            .single();

          if (error) {
            errors.push({ type: 'insert', customer, kintoneRecordId, error: error.message, code: error.code });
            console.error('Insert error:', error, insertData);
            skipped++;
          } else if (newProject) {
            projects.push(newProject);
            projectsByKintoneId.set(kintoneRecordId, newProject);
            imported++;
          }
        }
      } catch (e) {
        console.error('Record processing error:', e, record);
        errors.push({ type: 'exception', error: e.message });
        skipped++;
      }
    }

    // 9. 繧ｨ繝ｩ繝ｼ繝ｭ繧ｰ
    if (errors.length > 0) {
      console.error('Import errors:', errors);
      console.table(errors);
    }

    // 10. 螳御ｺ・｡ｨ遉ｺ
    renderProjects();
    renderSidebar();

    // 隧ｳ邏ｰ縺ｪ繧ｵ繝槭Μ繝ｼ繧剃ｽ懈・
    const total = records.length;
    const skipDetails = [];
    if (skippedNoCustomer > 0) skipDetails.push(`鬘ｧ螳｢蜷阪↑縺・ ${skippedNoCustomer}`);
    if (skippedNoRecordId > 0) skipDetails.push(`繝ｬ繧ｳ繝ｼ繝迂D縺ｪ縺・ ${skippedNoRecordId}`);
    if (errors.length > 0) skipDetails.push(`繧ｨ繝ｩ繝ｼ: ${errors.length}`);
    const skipInfo = skipDetails.length > 0 ? ` (${skipDetails.join(', ')})` : '';

    console.log('Import summary:', {
      total,
      imported,
      updated,
      skipped,
      skippedNoCustomer,
      skippedNoRecordId,
      errors: errors.length,
      hitLimit
    });

    if (imported + updated > 0) {
      let msg = `笨・螳御ｺ・ kintone ${total}莉ｶ荳ｭ 竊・${imported}莉ｶ譁ｰ隕上・{updated}莉ｶ譖ｴ譁ｰ`;
      if (skipped > 0) msg += `縲・{skipped}莉ｶ繧ｹ繧ｭ繝・・${skipInfo}`;
      if (hitLimit) msg += ' 笞・・0,000莉ｶ蛻ｶ髯・;
      statusEl.innerHTML = `<span style="color: var(--success-color);">${msg}</span>`;
      showToast(`kintone縺九ｉ${imported + updated}莉ｶ繧偵う繝ｳ繝昴・繝医＠縺ｾ縺励◆`, 'success');
    } else if (skipped > 0) {
      statusEl.innerHTML = `<span style="color: var(--warning-color);">笞・・${total}莉ｶ荳ｭ${skipped}莉ｶ繧ｹ繧ｭ繝・・${skipInfo}・医さ繝ｳ繧ｽ繝ｼ繝ｫ縺ｧ繧ｨ繝ｩ繝ｼ遒ｺ隱搾ｼ・/span>`;
    } else {
      statusEl.innerHTML = `<span style="color: var(--warning-color);">笞・・繧､繝ｳ繝昴・繝亥ｯｾ雎｡縺後≠繧翫∪縺帙ｓ縺ｧ縺励◆</span>`;
    }

  } catch (e) {
    console.error('Import error:', e);
    statusEl.innerHTML = `<span style="color: var(--danger-color);">笶・繧ｨ繝ｩ繝ｼ: ${e.message}</span>`;
  }
}

// kintone繝ｬ繧ｳ繝ｼ繝迂D繧呈歓蜃ｺ・郁､・焚縺ｮ繝輔ぅ繝ｼ繝ｫ繝牙錐縺ｫ蟇ｾ蠢懶ｼ・
function extractKintoneRecordId(record) {
  // kintone API縺ｯ $id 繝輔ぅ繝ｼ繝ｫ繝峨〒繝ｬ繧ｳ繝ｼ繝迂D繧定ｿ斐☆
  // 繝ｬ繧ｳ繝ｼ繝臥分蜿ｷ繝輔ぅ繝ｼ繝ｫ繝峨ｂ遒ｺ隱・
  const candidates = [
    record['$id']?.value,
    record['繝ｬ繧ｳ繝ｼ繝臥分蜿ｷ']?.value,
    record['Record_number']?.value,
    record['record_id']?.value
  ];

  for (const val of candidates) {
    if (val !== undefined && val !== null && val !== '') {
      const strVal = String(val).trim();
      if (strVal && strVal !== '0') {
        return strVal;
      }
    }
  }

  return null;
}

// 蜷榊燕繧呈ｭ｣隕丞喧・医せ繝壹・繧ｹ髯､蜴ｻ縲∝・蜊願ｧ堤ｵｱ荳・・
function normalizeName(name) {
  if (!name) return '';
  return String(name)
    .trim()
    .replace(/[\s縲]+/g, '') // 蜊願ｧ偵・蜈ｨ隗偵せ繝壹・繧ｹ繧帝勁蜴ｻ
    .replace(/[・｡-・ｺ・・・夲ｼ・・兢/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)) // 蜈ｨ隗定恭謨ｰ蟄励ｒ蜊願ｧ偵↓
    .toLowerCase();
}

// kintone蜷阪°繧嬰esigner蜷阪ｒ繝槭ャ繝√Φ繧ｰ
function matchDesignerName(kintoneNames, category = null) {
  if (!kintoneNames) return null;

  // kintone縺ｮ蜷榊燕繝ｪ繧ｹ繝茨ｼ医き繝ｳ繝槫玄蛻・ｊ縺ｮ蝣ｴ蜷医ｒ蜃ｦ逅・ｼ・
  const names = String(kintoneNames).split(',').map(n => n.trim()).filter(Boolean);
  if (names.length === 0) return null;

  // 蟇ｾ雎｡縺ｮdesigners繝ｪ繧ｹ繝・
  const targetDesigners = category
    ? designers.filter(d => d.category === category)
    : designers;

  for (const kName of names) {
    const normalizedKintone = normalizeName(kName);

    // 1. 螳悟・荳閾ｴ
    const exactMatch = targetDesigners.find(d => d.name === kName);
    if (exactMatch) return exactMatch.name;

    // 2. trim蠕御ｸ閾ｴ
    const trimMatch = targetDesigners.find(d => d.name.trim() === kName.trim());
    if (trimMatch) return trimMatch.name;

    // 3. 豁｣隕丞喧蠕御ｸ閾ｴ
    const normalizedMatch = targetDesigners.find(d => normalizeName(d.name) === normalizedKintone);
    if (normalizedMatch) return normalizedMatch.name;

    // 4. 驛ｨ蛻・ｸ閾ｴ・亥錐蜑阪′蜷ｫ縺ｾ繧後※縺・ｋ・・
    const partialMatch = targetDesigners.find(d => {
      const normalizedDesigner = normalizeName(d.name);
      return normalizedDesigner.includes(normalizedKintone) || normalizedKintone.includes(normalizedDesigner);
    });
    if (partialMatch) return partialMatch.name;

    // 5. 蟋薙・縺ｿ繝槭ャ繝・ｼ・譁・ｭ嶺ｻ･荳翫・蝣ｴ蜷茨ｼ・
    if (normalizedKintone.length >= 2) {
      const lastNameMatch = targetDesigners.find(d => {
        const normalizedDesigner = normalizeName(d.name);
        // 蟋難ｼ域怙蛻昴・2-3譁・ｭ暦ｼ峨〒豈碑ｼ・
        const kSurname = normalizedKintone.substring(0, Math.min(3, normalizedKintone.length));
        const dSurname = normalizedDesigner.substring(0, Math.min(3, normalizedDesigner.length));
        return kSurname === dSurname && normalizedDesigner.length >= 2;
      });
      if (lastNameMatch) return lastNameMatch.name;
    }
  }

  // 繝槭ャ繝√↑縺暦ｼ壼・縺ｮ蛟､繧偵◎縺ｮ縺ｾ縺ｾ霑斐☆・域眠隕乗球蠖楢・→縺励※逋ｻ骭ｲ縺輔ｌ繧句庄閭ｽ諤ｧ・・
  console.log(`笞・・Designer not matched: "${kintoneNames}" (category: ${category || 'any'})`);
  return names[0]; // 譛蛻昴・蜷榊燕繧偵◎縺ｮ縺ｾ縺ｾ霑斐☆
}

// 譌･莉伜､繧偵ヱ繝ｼ繧ｹ・郁､・焚蠖｢蠑丞ｯｾ蠢懶ｼ・
function parseDateValue(record, field) {
  if (!field) return null;
  const val = record[field]?.value;
  if (!val) return null;

  const dateStr = String(val).trim();
  if (!dateStr) return null;

  // YYYY-MM-DD蠖｢蠑擾ｼ域耳螂ｨ・・
  if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
    return dateStr;
  }

  // ISO 8601蠖｢蠑擾ｼ井ｾ・ 2026-01-08T00:00:00Z・・
  const isoMatch = dateStr.match(/^(\d{4}-\d{2}-\d{2})T/);
  if (isoMatch) {
    return isoMatch[1];
  }

  // YYYY/MM/DD蠖｢蠑・
  const slashMatch = dateStr.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
  if (slashMatch) {
    const [, y, m, d] = slashMatch;
    return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
  }

  // 譌･譛ｬ隱槫ｽ｢蠑擾ｼ・YYY蟷ｴMM譛・D譌･・・
  const jpMatch = dateStr.match(/^(\d{4})蟷ｴ(\d{1,2})譛・\d{1,2})譌･$/);
  if (jpMatch) {
    const [, y, m, d] = jpMatch;
    return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
  }

  console.warn('Unknown date format:', dateStr, 'in field:', field);
  return null;
}

// 繝・・繧ｿ迥ｶ豕√ｒ陦ｨ遉ｺ
function showDataStats() {
  const kintoneProjects = projects.filter(p => p.kintone_record_id);
  const demoProjects = projects.filter(p => !p.kintone_record_id);
  const archivedProjects = projects.filter(p => p.is_archived);

  const statsEl = document.getElementById('dataStatsInfo');
  if (statsEl) {
    statsEl.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
        <div style="padding: 8px; background: var(--bg-color); border-radius: 4px; text-align: center;">
          <div style="font-size: 20px; font-weight: 700; color: var(--primary-color);">${projects.length}</div>
          <div style="font-size: 11px; color: var(--text-muted);">邱乗｡井ｻｶ謨ｰ</div>
        </div>
        <div style="padding: 8px; background: var(--bg-color); border-radius: 4px; text-align: center;">
          <div style="font-size: 20px; font-weight: 700; color: var(--success-color);">${kintoneProjects.length}</div>
          <div style="font-size: 11px; color: var(--text-muted);">kintone騾｣謳ｺ</div>
        </div>
        <div style="padding: 8px; background: var(--bg-color); border-radius: 4px; text-align: center;">
          <div style="font-size: 20px; font-weight: 700; color: var(--warning-color);">${demoProjects.length}</div>
          <div style="font-size: 11px; color: var(--text-muted);">謇句虚/繝・Δ</div>
        </div>
        <div style="padding: 8px; background: var(--bg-color); border-radius: 4px; text-align: center;">
          <div style="font-size: 20px; font-weight: 700; color: var(--text-muted);">${archivedProjects.length}</div>
          <div style="font-size: 11px; color: var(--text-muted);">螳御ｺ・ｸ医∩</div>
        </div>
      </div>
    `;
  }
}

// 繝・Δ繝・・繧ｿ蜑企勁遒ｺ隱・
async function clearDemoDataConfirm() {
  const demoProjects = projects.filter(p => !p.kintone_record_id);

  if (demoProjects.length === 0) {
    showToast('蜑企勁蟇ｾ雎｡縺ｮ繝・Δ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ', 'info');
    return;
  }

  const confirmed = confirm(
    `笞・・繝・Δ繝・・繧ｿ繧貞炎髯､\n\n` +
    `${demoProjects.length}莉ｶ縺ｮ繝・Δ/謇句虚霑ｽ蜉繝・・繧ｿ繧貞炎髯､縺励∪縺吶・n` +
    `kintone騾｣謳ｺ貂医∩縺ｮ譯井ｻｶ縺ｯ蜑企勁縺輔ｌ縺ｾ縺帙ｓ縲・n\n` +
    `蜑企勁蟇ｾ雎｡:\n${demoProjects.slice(0, 5).map(p => `  - ${p.customer}`).join('\n')}` +
    (demoProjects.length > 5 ? `\n  ... 莉・{demoProjects.length - 5}莉ｶ` : '') +
    `\n\n縺薙・謫堺ｽ懊・蜿悶ｊ豸医○縺ｾ縺帙ｓ縲らｶ夊｡後＠縺ｾ縺吶°・歔
  );

  if (!confirmed) return;

  // 莠碁㍾遒ｺ隱・
  const doubleConfirmed = confirm(
    `譛ｬ蠖薙↓${demoProjects.length}莉ｶ縺ｮ繝・Δ繝・・繧ｿ繧貞炎髯､縺励∪縺吶°・歃n\n` +
    `縺薙・謫堺ｽ懊・蜿悶ｊ豸医○縺ｾ縺帙ｓ縲Ａ
  );

  if (!doubleConfirmed) return;

  await clearDemoData();
}

// 繝・Δ繝・・繧ｿ繧貞炎髯､
async function clearDemoData() {
  const statusEl = document.getElementById('kintoneImportStatus');
  if (statusEl) {
    statusEl.innerHTML = '<span style="color: var(--text-muted);">卵・・繝・Δ繝・・繧ｿ繧貞炎髯､荳ｭ...</span>';
  }

  try {
    const demoProjects = projects.filter(p => !p.kintone_record_id);
    const demoIds = demoProjects.map(p => p.id);

    if (demoIds.length === 0) {
      if (statusEl) {
        statusEl.innerHTML = '<span style="color: var(--info-color);">蜑企勁蟇ｾ雎｡縺ｮ繝・Δ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</span>';
      }
      return;
    }

    // 髢｢騾｣繝・・繧ｿ繧ょ炎髯､・・roject_tasks, project_minutes, project_handovers・・
    let deletedRelated = 0;

    // project_tasks
    const { error: taskError, count: taskCount } = await supabase
      .from('project_tasks')
      .delete({ count: 'exact' })
      .in('project_id', demoIds);
    if (!taskError && taskCount) deletedRelated += taskCount;

    // project_minutes
    const { error: minuteError, count: minuteCount } = await supabase
      .from('project_minutes')
      .delete({ count: 'exact' })
      .in('project_id', demoIds);
    if (!minuteError && minuteCount) deletedRelated += minuteCount;

    // project_handovers
    const { error: handoverError, count: handoverCount } = await supabase
      .from('project_handovers')
      .delete({ count: 'exact' })
      .in('project_id', demoIds);
    if (!handoverError && handoverCount) deletedRelated += handoverCount;

    // 譯井ｻｶ譛ｬ菴薙ｒ蜑企勁
    const { error, count } = await supabase
      .from('projects')
      .delete({ count: 'exact' })
      .in('id', demoIds);

    if (error) {
      console.error('Delete error:', error);
      if (statusEl) {
        statusEl.innerHTML = `<span style="color: var(--danger-color);">笶・蜑企勁繧ｨ繝ｩ繝ｼ: ${error.message}</span>`;
      }
      return;
    }

    // 繝｡繝｢繝ｪ縺九ｉ繧ょ炎髯､
    projects = projects.filter(p => p.kintone_record_id);

    // 逕ｻ髱｢繧呈峩譁ｰ
    renderProjects();
    renderSidebar();
    showDataStats();

    if (statusEl) {
      statusEl.innerHTML = `<span style="color: var(--success-color);">笨・${count || demoIds.length}莉ｶ縺ｮ繝・Δ繝・・繧ｿ繧貞炎髯､縺励∪縺励◆・磯未騾｣繝・・繧ｿ: ${deletedRelated}莉ｶ・・/span>`;
    }
    showToast(`${count || demoIds.length}莉ｶ縺ｮ繝・Δ繝・・繧ｿ繧貞炎髯､縺励∪縺励◆`, 'success');

  } catch (e) {
    console.error('Clear demo data error:', e);
    if (statusEl) {
      statusEl.innerHTML = `<span style="color: var(--danger-color);">笶・繧ｨ繝ｩ繝ｼ: ${e.message}</span>`;
    }
  }
}

// kintone險ｭ螳夊ｪｭ縺ｿ霎ｼ縺ｿ
async function loadKintoneSettings() {
  try {
    const { data, error } = await supabase
      .from('kintone_settings')
      .select('*')
      .eq('is_active', true)
      .limit(1);

    // DB縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ謌仙粥縺励◆蝣ｴ蜷・
    if (!error && data && data.length > 0) {
      const settings = data[0];
      kintoneSettings = settings;

      const domainEl = document.getElementById('kintoneDomain');
      const appIdEl = document.getElementById('kintoneAppId');
      const apiTokenEl = document.getElementById('kintoneApiToken');

      if (domainEl) domainEl.value = settings.domain || '';
      if (appIdEl) appIdEl.value = settings.app_id || '';
      if (apiTokenEl) apiTokenEl.value = settings.api_token || '';

      // 諡・ｽ楢・ヵ繧｣繝ｼ繝ｫ繝峨・繝・ヴ繝ｳ繧ｰ繧奪B縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ
      const salesEl = document.getElementById('kintoneFieldSales');
      const designEl = document.getElementById('kintoneFieldDesign');
      const icEl = document.getElementById('kintoneFieldIC');
      const constructionEl = document.getElementById('kintoneFieldConstruction');
      if (salesEl && settings.field_sales) salesEl.value = settings.field_sales;
      if (designEl && settings.field_design) designEl.value = settings.field_design;
      if (icEl && settings.field_ic) icEl.value = settings.field_ic;
      if (constructionEl && settings.field_construction) constructionEl.value = settings.field_construction;

      // 蟷ｴ蠎ｦ蛻･繧｢繝励Μ繧奪B縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ・・pps_json繧ｫ繝ｩ繝縺後≠繧句ｴ蜷茨ｼ・
      if (settings.apps_json) {
        try {
          kintoneApps = JSON.parse(settings.apps_json);
        } catch (e) {
          kintoneApps = [];
        }
      }
    }

    // 蟷ｴ蠎ｦ蛻･繧｢繝励Μ繧値ocalStorage縺九ｉ繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ隱ｭ縺ｿ霎ｼ縺ｿ
    if (!kintoneApps || kintoneApps.length === 0) {
      kintoneApps = safeJsonParse(localStorage.getItem('kintone_apps'), []);
    }

    // 蠕梧婿莠呈鋤諤ｧ・啾pp_id縺瑚ｨｭ螳壹＆繧後※縺・※kintoneApps縺檎ｩｺ縺ｮ蝣ｴ蜷医∥pp_id繧談intoneApps縺ｫ霑ｽ蜉
    if (kintoneApps.length === 0 && kintoneSettings?.app_id) {
      const currentYear = new Date().getFullYear();
      kintoneApps = [{ year: String(currentYear), appId: kintoneSettings.app_id, label: currentYear + '蟷ｴ蠎ｦ' }];
    }

    // 蟷ｴ蠎ｦ蛻･繧｢繝励Μ繧旦I縺ｫ謠冗判
    renderKintoneApps(kintoneApps);

    // 蝓ｺ譛ｬ諠・ｱ繝輔ぅ繝ｼ繝ｫ繝峨ｒDB縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ・医ヵ繧ｩ繝ｼ繝ｫ繝舌ャ繧ｯ・嗟ocalStorage・・
    let fieldMappings = {};
    if (kintoneSettings?.field_mappings_json) {
      // DB縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ
      fieldMappings = safeJsonParse(kintoneSettings.field_mappings_json, {});
      // localStorage縺ｫ繧ゆｿ晏ｭ假ｼ亥酔譛溽畑・・
      localStorage.setItem('kintone_field_mappings', kintoneSettings.field_mappings_json);
    } else {
      // 繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ・嗟ocalStorage縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ
      fieldMappings = safeJsonParse(localStorage.getItem('kintone_field_mappings'), {});
    }

    const customerEl = document.getElementById('kintoneFieldCustomer');
    const layoutEl = document.getElementById('kintoneFieldLayout');
    const permitEl = document.getElementById('kintoneFieldPermit');
    const meetingEl = document.getElementById('kintoneFieldMeeting');
    const productEl = document.getElementById('kintoneFieldProduct');
    const exteriorEl = document.getElementById('kintoneFieldExterior');
    const salesEl2 = document.getElementById('kintoneFieldSales');
    const designEl2 = document.getElementById('kintoneFieldDesign');
    const icEl2 = document.getElementById('kintoneFieldIC');
    const constructionEl2 = document.getElementById('kintoneFieldConstruction');

    if (customerEl && fieldMappings.customer) customerEl.value = fieldMappings.customer;
    if (layoutEl && fieldMappings.layout) layoutEl.value = fieldMappings.layout;
    if (permitEl && fieldMappings.permit) permitEl.value = fieldMappings.permit;
    if (meetingEl && fieldMappings.meeting) meetingEl.value = fieldMappings.meeting;
    if (productEl && fieldMappings.product) productEl.value = fieldMappings.product;
    if (exteriorEl && fieldMappings.exterior) exteriorEl.value = fieldMappings.exterior;
    // 諡・ｽ楢・ヵ繧｣繝ｼ繝ｫ繝峨・DB縺九ｉ隱ｭ縺ｿ霎ｼ縺ｿ貂医∩縺縺後√ヵ繧ｩ繝ｼ繝ｫ繝舌ャ繧ｯ縺ｨ縺励※localStorage繧ら｢ｺ隱・
    if (salesEl2 && !salesEl2.value && fieldMappings.sales) salesEl2.value = fieldMappings.sales;
    if (designEl2 && !designEl2.value && fieldMappings.design) designEl2.value = fieldMappings.design;
    if (icEl2 && !icEl2.value && fieldMappings.ic) icEl2.value = fieldMappings.ic;
    if (constructionEl2 && !constructionEl2.value && fieldMappings.construction) constructionEl2.value = fieldMappings.construction;
  } catch (e) {
    // 萓句､也匱逕滓凾繧る撕縺九↓邨ゆｺ・
    console.warn('kintone險ｭ螳夊ｪｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', e);
  }
}

// kintone閾ｪ蜍募酔譛滂ｼ医い繝励Μ襍ｷ蜍墓凾・・
async function autoSyncKintone() {
  try {
    // kintone險ｭ螳壹ｒ遒ｺ隱・
    if (!kintoneSettings || !kintoneSettings.domain || !kintoneSettings.app_id || !kintoneSettings.api_token) {
      log('竢ｭ・・kintone閾ｪ蜍募酔譛溘せ繧ｭ繝・・: 險ｭ螳壽悴螳御ｺ・);
      return;
    }

    log('売 kintone閾ｪ蜍募酔譛滄幕蟋・..');
    showToast('kintone縺ｨ蜷梧悄荳ｭ...', 'info', 2000);

    // 繝輔ぅ繝ｼ繝ｫ繝峨・繝・ヴ繝ｳ繧ｰ繧貞叙蠕・
    const fieldMappings = safeJsonParse(localStorage.getItem('kintone_field_mappings'), {});
    const customerField = fieldMappings.customer || '譁・ｭ誉蝓ｺ譛ｬ諠・ｱ_縺雁ｮ｢讒伜錐_繝｡繧､繝ｳ';
    const salesField = fieldMappings.sales || '繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚枩蝓ｺ譛ｬ諠・ｱ_蝟ｶ讌ｭ';
    const designField = fieldMappings.design || '繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚枩蝓ｺ譛ｬ諠・ｱ_險ｭ險・;
    const icField = fieldMappings.ic || '繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚枩蝓ｺ譛ｬ諠・ｱ_IC';
    const constructionField = fieldMappings.construction || '繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚枩蝓ｺ譛ｬ諠・ｱ_蟾･莠・;
    const exteriorField = fieldMappings.exterior || '';
    const layoutField = fieldMappings.layout || '';
    const permitField = fieldMappings.permit || '';
    const meetingField = fieldMappings.meeting || '';
    const productField = fieldMappings.product || '';

    // kintone縺九ｉ繝ｬ繧ｳ繝ｼ繝牙叙蠕・
    const result = await callKintoneProxy('getAllRecords');

    if (!result.success) {
      log('笶・kintone閾ｪ蜍募酔譛溷､ｱ謨・', result.error);
      return;
    }

    const records = result.data?.records || [];
    if (records.length === 0) {
      log('笞・・kintone繝ｬ繧ｳ繝ｼ繝峨↑縺・);
      return;
    }

    // 譌｢蟄俶｡井ｻｶ繧偵う繝ｳ繝・ャ繧ｯ繧ｹ蛹・
    const projectsByKintoneId = new Map();
    for (const p of projects) {
      if (p.kintone_record_id) {
        projectsByKintoneId.set(String(p.kintone_record_id), p);
      }
    }

    let updated = 0;
    let added = 0;

    for (const record of records) {
      try {
        const kintoneRecordId = extractKintoneRecordId(record);
        if (!kintoneRecordId) continue;

        const getValue = (field) => {
          if (!field) return null;
          const val = record[field]?.value;
          if (val === undefined || val === null) return null;
          if (Array.isArray(val)) {
            const names = val.map(v => v.name || v.code || String(v)).filter(Boolean);
            return names.length > 0 ? names.join(', ') : null;
          }
          const strVal = String(val).trim();
          return strVal || null;
        };

        const customer = getValue(customerField);
        if (!customer) continue;

        const existingProject = projectsByKintoneId.get(kintoneRecordId);

        if (existingProject) {
          // 譌｢蟄俶｡井ｻｶ繧呈峩譁ｰ・域律莉倥ヵ繧｣繝ｼ繝ｫ繝峨・縺ｿ蜷梧悄・・
          const updates = {};
          let hasChanges = false;

          // 髢灘叙遒ｺ螳壽律
          if (layoutField) {
            const layoutDate = getValue(layoutField);
            if (layoutDate && layoutDate !== existingProject.layout_confirmed_date) {
              updates.layout_confirmed_date = layoutDate;
              hasChanges = true;
            }
          }

          // 逹蟾･險ｱ蜿ｯ譌･
          if (permitField) {
            const permitDate = getValue(permitField);
            if (permitDate && permitDate !== existingProject.construction_permit_date) {
              updates.construction_permit_date = permitDate;
              hasChanges = true;
            }
          }

          // 螟画峩螂醍ｴ・燕莨夊ｭｰ譌･
          if (meetingField) {
            const meetingDate = getValue(meetingField);
            if (meetingDate && meetingDate !== existingProject.pre_contract_meeting_date) {
              updates.pre_contract_meeting_date = meetingDate;
              hasChanges = true;
            }
          }

          // 蝠・刀
          if (productField) {
            const product = getValue(productField);
            if (product && product !== existingProject.specifications) {
              updates.specifications = product;
              hasChanges = true;
            }
          }

          // 諡・ｽ楢・峩譁ｰ・亥錐蜑阪・繝・メ繝ｳ繧ｰ驕ｩ逕ｨ・・
          const salesRaw = getValue(salesField);
          const designRaw = getValue(designField);
          const icRaw = getValue(icField);
          const constructionRaw = getValue(constructionField);
          const exteriorRaw = exteriorField ? getValue(exteriorField) : null;

          const sales = matchDesignerName(salesRaw, '蝟ｶ讌ｭ');
          const design = matchDesignerName(designRaw, '險ｭ險・);
          const ic = matchDesignerName(icRaw, 'IC');
          const construction = matchDesignerName(constructionRaw, '蟾･莠・);
          const exterior = exteriorRaw ? matchDesignerName(exteriorRaw, '螟匁ｧ・) : null;

          if (sales && sales !== existingProject.sales_assignee) {
            updates.sales_assignee = sales;
            hasChanges = true;
          }
          if (design && design !== existingProject.assigned_to) {
            updates.assigned_to = design;
            hasChanges = true;
          }
          if (ic && ic !== existingProject.ic_assignee) {
            updates.ic_assignee = ic;
            hasChanges = true;
          }
          if (construction && construction !== existingProject.construction_assignee) {
            updates.construction_assignee = construction;
            hasChanges = true;
          }
          if (exterior && exterior !== existingProject.exterior_assignee) {
            updates.exterior_assignee = exterior;
            hasChanges = true;
          }

          if (hasChanges) {
            const { error } = await supabase
              .from('projects')
              .update(updates)
              .eq('id', existingProject.id);

            if (!error) {
              Object.assign(existingProject, updates);
              updated++;
            }
          }
        } else {
          // 譁ｰ隕乗｡井ｻｶ霑ｽ蜉・亥錐蜑阪・繝・メ繝ｳ繧ｰ驕ｩ逕ｨ・・
          const productValue = productField ? getValue(productField) : null;
          const exteriorValue = exteriorField ? matchDesignerName(getValue(exteriorField), '螟匁ｧ・) : null;
          const newProject = {
            customer: customer,
            kintone_record_id: kintoneRecordId,
            specifications: productValue || 'LIFE',
            status: 'active',
            assigned_to: matchDesignerName(getValue(designField), '險ｭ險・),
            ic_assignee: matchDesignerName(getValue(icField), 'IC'),
            sales_assignee: matchDesignerName(getValue(salesField), '蝟ｶ讌ｭ'),
            construction_assignee: matchDesignerName(getValue(constructionField), '蟾･莠・),
            exterior_assignee: exteriorValue,
            layout_confirmed_date: getValue(layoutField),
            construction_permit_date: getValue(permitField),
            pre_contract_meeting_date: getValue(meetingField),
            progress: {},
            is_archived: false
          };

          const { data, error } = await supabase
            .from('projects')
            .insert(newProject)
            .select()
            .single();

          if (!error && data) {
            projects.push(data);
            projectsByKintoneId.set(kintoneRecordId, data);
            added++;
          }
        }
      } catch (e) {
        // 蛟句挨繝ｬ繧ｳ繝ｼ繝峨・繧ｨ繝ｩ繝ｼ縺ｯ辟｡隕・
      }
    }

    if (updated > 0 || added > 0) {
      log(`笨・kintone閾ｪ蜍募酔譛溷ｮ御ｺ・ 譖ｴ譁ｰ${updated}莉ｶ, 霑ｽ蜉${added}莉ｶ`);
      showToast(`kintone蜷梧悄螳御ｺ・ 譖ｴ譁ｰ${updated}莉ｶ, 霑ｽ蜉${added}莉ｶ`, 'success');
      renderSidebar();
      renderProjects();
    } else {
      log('笨・kintone閾ｪ蜍募酔譛溷ｮ御ｺ・ 螟画峩縺ｪ縺・);
    }
  } catch (e) {
    log('笶・kintone閾ｪ蜍募酔譛溘お繝ｩ繝ｼ:', e);
  }
}

// 謇句虚kintone蜷梧悄・医・繧ｿ繝ｳ縺九ｉ蜻ｼ縺ｳ蜃ｺ縺暦ｼ・
async function manualKintoneSync() {
  const btn = document.getElementById('kintoneRefreshBtn');
  if (btn) {
    btn.disabled = true;
    btn.textContent = '売 蜷梧悄荳ｭ...';
  }

  try {
    // kintone險ｭ螳壹ｒ遒ｺ隱・
    if (!kintoneSettings || !kintoneSettings.domain || !kintoneSettings.app_id || !kintoneSettings.api_token) {
      showToast('kintone騾｣謳ｺ縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ縲りｨｭ螳夂判髱｢縺ｧ險ｭ螳壹＠縺ｦ縺上□縺輔＞縲・, 'error');
      return;
    }

    await autoSyncKintone();
    showToast('kintone蜷梧悄縺悟ｮ御ｺ・＠縺ｾ縺励◆', 'success');
  } catch (e) {
    showToast('kintone蜷梧悄縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + e.message, 'error');
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = '売 kintone';
    }
  }
}

// kintone縺九ｉ繧､繝ｳ繝昴・繝茨ｼ・SV繝吶・繧ｹ・・
async function importFromKintone() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.csv';
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const text = await file.text();
    const lines = text.split('\n');

    // 遨ｺ繝輔ぃ繧､繝ｫ縺ｾ縺溘・繝倥ャ繝繝ｼ縺ｮ縺ｿ縺ｮ繝√ぉ繝・け
    if (!lines || lines.length < 2) {
      showToast('CSV繝輔ぃ繧､繝ｫ縺檎ｩｺ縺九√ョ繝ｼ繧ｿ縺後≠繧翫∪縺帙ｓ', 'error');
      return;
    }

    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

    // 繝輔ぅ繝ｼ繝ｫ繝峨・繝・ヴ繝ｳ繧ｰ繧貞叙蠕・
    const fieldMappings = safeJsonParse(localStorage.getItem('kintone_field_mappings'), {});

    // 繧ｫ繝ｩ繝繧､繝ｳ繝・ャ繧ｯ繧ｹ繧呈､懃ｴ｢・医・繝・ヴ繝ｳ繧ｰ險ｭ螳壹′縺ゅｌ縺ｰ縺昴ｌ繧貞━蜈茨ｼ・
    const findColIdx = (mapping, fallbacks) => {
      if (mapping) {
        const idx = headers.findIndex(h => h === mapping || h.includes(mapping));
        if (idx !== -1) return idx;
      }
      for (const fb of fallbacks) {
        const idx = headers.findIndex(h => h.includes(fb));
        if (idx !== -1) return idx;
      }
      return -1;
    };

    const customerIdx = findColIdx(fieldMappings.customer, ['鬘ｧ螳｢', '驍ｸ蜷・, 'customer']);
    const addressIdx = headers.findIndex(h => h.includes('蟒ｺ遽牙慍') || h.includes('菴乗園') || h.includes('address'));
    const recordIdIdx = headers.findIndex(h => h.includes('繝ｬ繧ｳ繝ｼ繝・) || h.includes('record') || h === '$id');
    const salesIdx = findColIdx(fieldMappings.sales, ['蝟ｶ讌ｭ諡・ｽ・, '蝟ｶ讌ｭ', 'sales']);
    const designIdx = findColIdx(fieldMappings.design, ['險ｭ險域球蠖・, '險ｭ險・, 'design']);
    const icIdx = findColIdx(fieldMappings.ic, ['IC諡・ｽ・, 'IC', 'ic']);
    const constructionIdx = findColIdx(fieldMappings.construction, ['蟾･莠区球蠖・, '蟾･莠・, 'construction']);

    if (customerIdx === -1) {
      showToast('鬘ｧ螳｢蜷・驍ｸ蜷阪き繝ｩ繝縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ', 'error');
      return;
    }

    let importCount = 0;
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
      if (!cols[customerIdx]) continue;

      const customer = cols[customerIdx];
      const address = addressIdx >= 0 ? cols[addressIdx] : '';
      const kintoneRecordId = recordIdIdx >= 0 ? cols[recordIdIdx] : '';
      const salesAssigneeRaw = salesIdx >= 0 ? cols[salesIdx] : '';
      const designAssigneeRaw = designIdx >= 0 ? cols[designIdx] : '';
      const icAssigneeRaw = icIdx >= 0 ? cols[icIdx] : '';
      const constructionAssigneeRaw = constructionIdx >= 0 ? cols[constructionIdx] : '';

      // 蜷榊燕繝槭ャ繝√Φ繧ｰ驕ｩ逕ｨ
      const salesAssignee = matchDesignerName(salesAssigneeRaw, '蝟ｶ讌ｭ');
      const designAssignee = matchDesignerName(designAssigneeRaw, '險ｭ險・);
      const icAssignee = matchDesignerName(icAssigneeRaw, 'IC');
      const constructionAssignee = matchDesignerName(constructionAssigneeRaw, '蟾･莠・);

      // 譌｢蟄倥メ繧ｧ繝・け
      const existing = projects.find(p => p.customer === customer);
      if (existing) continue;

      // 譁ｰ隕丈ｽ懈・
      const { error } = await supabase.from('projects').insert({
        customer,
        building_address: address,
        kintone_record_id: kintoneRecordId,
        sales_assignee: salesAssignee,
        assigned_to: designAssignee || designers.find(d => d.category === '險ｭ險・)?.name || '',
        ic_assignee: icAssignee,
        construction_assignee: constructionAssignee,
        specifications: 'LIFE',
        status: 'active',
        progress: {}
      });

      if (!error) importCount++;
    }

    showToast(`${importCount}莉ｶ縺ｮ譯井ｻｶ繧偵う繝ｳ繝昴・繝医＠縺ｾ縺励◆`, 'success');
    await loadProjects();
    renderProjects();
  };
  fileInput.click();
}

// kintone縺ｸ繧ｨ繧ｯ繧ｹ繝昴・繝茨ｼ・SV・・
function exportToKintone() {
  const headers = ['譯井ｻｶID', 'kintone_record_id', '鬘ｧ螳｢蜷・, '蟒ｺ遽牙慍', '蝟ｶ讌ｭ諡・ｽ・, '險ｭ險域球蠖・, 'IC諡・ｽ・, '螟匁ｧ区球蠖・, '荳榊虚逕｣諡・ｽ・, '蟾･莠区球蠖・, '蝠・刀', '騾ｲ謐礼紫', '髢灘叙遒ｺ螳壽律', '逹蟾･險ｱ蜿ｯ譌･', '螟画峩螂醍ｴ・燕莨夊ｭｰ譌･', '譖ｴ譁ｰ譌･'];
  const rows = projects.map(p => [
    p.id,
    p.kintone_record_id || '',
    p.customer,
    p.building_address || '',
    p.sales_assignee || '',
    p.assigned_to,
    p.ic_assignee || '',
    p.exterior_assignee || '',
    p.realestate_assignee || '',
    p.construction_assignee || '',
    p.specifications,
    calculateProgress(p) + '%',
    p.layout_confirmed_date || '',
    p.construction_permit_date || '',
    p.pre_contract_meeting_date || '',
    p.updated_at
  ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));

  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `archideck_export_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  URL.revokeObjectURL(url); // 繝｡繝｢繝ｪ隗｣謾ｾ
  showToast('CSV繧偵お繧ｯ繧ｹ繝昴・繝医＠縺ｾ縺励◆', 'success');
}

// kintone蜷梧悄蟇ｾ雎｡繝輔ぅ繝ｼ繝ｫ繝峨ｒ譖ｴ譁ｰ
async function syncToKintone(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project || !project.kintone_record_id) {
    showToast('kintone record ID縺瑚ｨｭ螳壹＆繧後※縺・∪縺帙ｓ', 'error');
    return;
  }

  if (!kintoneSettings?.domain || !kintoneSettings?.api_token) {
    showToast('kintone險ｭ螳壹′螳御ｺ・＠縺ｦ縺・∪縺帙ｓ', 'error');
    return;
  }

  // 螳滄圀縺ｮAPI繧ｳ繝ｼ繝ｫ縺ｯCORS蛻ｶ髯舌・縺溘ａ繧ｵ繝ｼ繝舌・繧ｵ繧､繝峨〒螳溯｡後′蠢・ｦ・
  // 縺薙％縺ｧ縺ｯUI繝輔ぅ繝ｼ繝峨ヰ繝・け縺ｮ縺ｿ
  showToast('kintone蜷梧悄繧偵Μ繧ｯ繧ｨ繧ｹ繝医＠縺ｾ縺励◆・医し繝ｼ繝舌・繧ｵ繧､繝牙・逅・ｾ・■・・, 'info');

  // 蜷梧悄繝ｪ繧ｯ繧ｨ繧ｹ繝医ｒDB縺ｫ險倬鹸
  try {
    const { error } = await supabase.from('kintone_sync_queue').insert({
      project_id: projectId,
      kintone_record_id: project.kintone_record_id,
      sync_type: 'push',
      status: 'pending',
      data: {
        layout_confirmed_date: project.layout_confirmed_date,
        construction_permit_date: project.construction_permit_date,
        pre_contract_meeting_date: project.pre_contract_meeting_date
      }
    });
    if (error) {
      console.error('kintone蜷梧悄繧ｭ繝･繝ｼ霑ｽ蜉繧ｨ繝ｩ繝ｼ:', error);
    }
  } catch (e) {
    console.error('kintone蜷梧悄繧ｭ繝･繝ｼ萓句､・', e);
  }
}

// 螟匁ｧ区球蠖薙ラ繝ｭ繝・・繝繧ｦ繝ｳ繧定ｨｭ螳・
function populateExteriorAssigneeDropdown(projectId = null, project = null) {
  const exteriorDesigners = designers.filter(d => d.category === '螟匁ｧ・);
  const exteriorAssigneeSelect = document.getElementById('projectExteriorAssignee');

  if (exteriorAssigneeSelect) {
    exteriorAssigneeSelect.innerHTML = '<option value="">譛ｪ螳・/option>' +
      exteriorDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    if (projectId && project) {
      exteriorAssigneeSelect.value = project.exterior_assignee || '';
    }
  }
}

// 荳榊虚逕｣諡・ｽ薙ラ繝ｭ繝・・繝繧ｦ繝ｳ繧定ｨｭ螳・
function populateRealestateAssigneeDropdown(projectId = null, project = null) {
  const realestateDesigners = designers.filter(d => d.category === '荳榊虚逕｣');
  const realestateAssigneeSelect = document.getElementById('projectRealestateAssignee');

  if (realestateAssigneeSelect) {
    realestateAssigneeSelect.innerHTML = '<option value="">譛ｪ螳・/option>' +
      realestateDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    if (projectId && project) {
      realestateAssigneeSelect.value = project.realestate_assignee || '';
    }
  }
}

// 蟾･莠区球蠖薙ラ繝ｭ繝・・繝繧ｦ繝ｳ繧定ｨｭ螳・
function populateConstructionAssigneeDropdown(projectId = null, project = null) {
  const constructionDesigners = designers.filter(d => d.category === '蟾･莠・);
  const constructionAssigneeSelect = document.getElementById('projectConstructionAssignee');

  if (constructionAssigneeSelect) {
    constructionAssigneeSelect.innerHTML = '<option value="">譛ｪ螳・/option>' +
      constructionDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    if (projectId && project) {
      constructionAssigneeSelect.value = project.construction_assignee || '';
    }
  }
}

// 蝟ｶ讌ｭ諡・ｽ薙ラ繝ｭ繝・・繝繧ｦ繝ｳ繧定ｨｭ螳・
function populateSalesAssigneeDropdown(projectId = null, project = null) {
  const salesDesigners = designers.filter(d => d.category === '蝟ｶ讌ｭ');
  const salesAssigneeSelect = document.getElementById('projectSalesAssignee');

  if (salesAssigneeSelect) {
    salesAssigneeSelect.innerHTML = '<option value="">譛ｪ螳・/option>' +
      salesDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    if (projectId && project) {
      salesAssigneeSelect.value = project.sales_assignee || '';
    }
  }
}

// openProjectModal繧呈僑蠑ｵ
const originalOpenProjectModal = openProjectModal;
openProjectModal = function(projectId = null) {
  originalOpenProjectModal(projectId);

  const project = projectId ? projects.find(p => p.id === projectId) : null;
  populateExteriorAssigneeDropdown(projectId, project);
  populateRealestateAssigneeDropdown(projectId, project);
  populateConstructionAssigneeDropdown(projectId, project);
  populateSalesAssigneeDropdown(projectId, project);
};

// saveProject繧呈僑蠑ｵ
const originalSaveProject = saveProject;
saveProject = async function() {
  const customer = document.getElementById('projectCustomer').value.trim();
  const assignedTo = document.getElementById('projectAssignedTo').value.trim();
  const icAssignee = document.getElementById('projectIcAssignee').value.trim();

  // 譛蠕後↓菴ｿ逕ｨ縺励◆諡・ｽ楢・ｒ險俶・
  if (assignedTo) {
    localStorage.setItem('archideck_last_assignee', assignedTo);
  }
  const exteriorAssignee = document.getElementById('projectExteriorAssignee')?.value.trim() || '';
  const realestateAssignee = document.getElementById('projectRealestateAssignee')?.value.trim() || '';
  const constructionAssignee = document.getElementById('projectConstructionAssignee')?.value.trim() || '';
  const salesAssignee = document.getElementById('projectSalesAssignee')?.value.trim() || '';
  const specifications = document.getElementById('projectSpecifications').value;

  if (!customer || !assignedTo) {
    showToast('縺雁ｮ｢讒伜錐縺ｨ諡・ｽ難ｼ郁ｨｭ險茨ｼ峨・蠢・医〒縺・, 'error');
    return;
  }

  showStatus('菫晏ｭ倅ｸｭ...', 'saving');

  const projectData = {
    customer,
    assigned_to: assignedTo,
    ic_assignee: icAssignee || null,
    exterior_assignee: exteriorAssignee || null,
    realestate_assignee: realestateAssignee || null,
    construction_assignee: constructionAssignee || null,
    sales_assignee: salesAssignee || null,
    specifications,
    updated_at: new Date().toISOString()
  };

  try {
    if (editingProjectId) {
      const { error } = await supabase
        .from('projects')
        .update(projectData)
        .eq('id', editingProjectId);

      if (error) throw error;

      const idx = projects.findIndex(p => p.id === editingProjectId);
      if (idx !== -1) {
        projects[idx] = { ...projects[idx], ...projectData };
      }
    } else {
      const uid = 'P-' + Date.now();
      projectData.uid = uid;
      projectData.progress = {};
      projectData.status = 'active';

      const { data, error } = await supabase
        .from('projects')
        .insert(projectData)
        .select()
        .single();

      if (error) throw error;
      projects.push(data);
    }

    showStatus('菫晏ｭ俶ｸ医∩', 'saved');
    showToast(editingProjectId ? '譯井ｻｶ繧呈峩譁ｰ縺励∪縺励◆' : '譯井ｻｶ繧定ｿｽ蜉縺励∪縺励◆', 'success');
    closeProjectModal();
    renderSidebar();
    renderProjects();
  } catch (error) {
    logError('菫晏ｭ倥お繝ｩ繝ｼ:', error);
    showStatus('繧ｨ繝ｩ繝ｼ', 'error');
    showToast('菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆', 'error');
  }
};

// ============================================
// 繝壹・繧ｸ隱ｭ縺ｿ霎ｼ縺ｿ譎・
// ============================================
window.addEventListener('DOMContentLoaded', () => {
  initDarkMode(); // 繝繝ｼ繧ｯ繝｢繝ｼ繝牙・譛溷喧
  checkAuth();
  // URL逶ｴ謗･繧｢繧ｯ繧ｻ繧ｹ縺ｮ蜃ｦ逅・・checkAuth() 竊・init()螳御ｺ・ｾ後↓閾ｪ蜍募ｮ溯｡後＆繧後ｋ

  // Service Worker螳悟・辟｡蜉ｹ蛹厄ｼ医く繝｣繝・す繝･蝠城｡後・諱剃ｹ・ｯｾ遲厄ｼ・
  if ('serviceWorker' in navigator) {
    (async () => {
      try {
        // 1. 蜈ｨ縺ｦ縺ｮService Worker繧堤匳骭ｲ隗｣髯､
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (const registration of registrations) {
          await registration.unregister();
          log('卵・・Service Worker逋ｻ骭ｲ隗｣髯､螳御ｺ・);
        }

        // 2. 蜈ｨ繧ｭ繝｣繝・す繝･繧貞炎髯､
        const cacheNames = await caches.keys();
        for (const cacheName of cacheNames) {
          await caches.delete(cacheName);
          log('卵・・繧ｭ繝｣繝・す繝･蜑企勁:', cacheName);
        }
      } catch (err) {
        logError('笶・Service Worker蜃ｦ逅・お繝ｩ繝ｼ:', err);
      }
    })();
  }

  // 繝励ャ繧ｷ繝･騾夂衍縺ｮ險ｱ蜿ｯ繝ｪ繧ｯ繧ｨ繧ｹ繝・
  if ('Notification' in window && Notification.permission === 'default') {
    // 3遘貞ｾ後↓騾夂衍險ｱ蜿ｯ繧呈ｱゅａ繧・
    setTimeout(() => {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          log('笨・Push notifications enabled');
        }
      });
    }, 3000);
  }
});

// 繝輔Ο繝ｼ繝・ぅ繝ｳ繧ｰ繧｢繧ｯ繧ｷ繝ｧ繝ｳ繝懊ち繝ｳ
const FAB = {
  container: null,
  button: null,
  menu: null,
  isOpen: false,

  init() {
    this.container = document.getElementById('fabContainer');
    this.button = document.getElementById('fabButton');
    this.menu = document.getElementById('fabMenu');

    // 螟夜Κ繧ｯ繝ｪ繝・け縺ｧ髢峨§繧・
    document.addEventListener('click', (e) => {
      if (this.isOpen && !this.container?.contains(e.target)) {
        this.close();
      }
    });
  },

  toggle() {
    this.isOpen = !this.isOpen;
    this.button?.classList.toggle('active', this.isOpen);
    this.menu?.classList.toggle('show', this.isOpen);
  },

  close() {
    this.isOpen = false;
    this.button?.classList.remove('active');
    this.menu?.classList.remove('show');
  },

  action(type) {
    this.close();
    switch (type) {
      case 'new':
        createNewProject();
        break;
      case 'refresh':
        forceReloadData();
        break;
      case 'export':
        exportToCSV();
        break;
      case 'print':
        BatchReportGenerator.generateAndPrint('險ｭ險・);
        break;
      case 'help':
        showShortcutHelp();
        break;
    }
  }
};

// FAB蛻晄悄蛹・
document.addEventListener('DOMContentLoaded', () => FAB.init());
</script>

<!-- 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ繧ｪ繝ｼ繝舌・繝ｬ繧､ -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-card">
    <div class="loading-spinner large"></div>
    <div class="loading-text" id="loadingText">隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...</div>
  </div>
</div>

<!-- 繝輔Ο繝ｼ繝・ぅ繝ｳ繧ｰ繧｢繧ｯ繧ｷ繝ｧ繝ｳ繝懊ち繝ｳ -->
<div class="fab-container" id="fabContainer">
  <div class="fab-menu" id="fabMenu">
    <div class="fab-menu-item" onclick="FAB.action('new')">
      <span class="icon">筐・/span>
      <span>譁ｰ隕乗｡井ｻｶ菴懈・</span>
    </div>
    <div class="fab-menu-item" onclick="FAB.action('refresh')">
      <span class="icon">売</span>
      <span>繝・・繧ｿ蜀崎ｪｭ縺ｿ霎ｼ縺ｿ</span>
    </div>
    <div class="fab-menu-item" onclick="FAB.action('export')">
      <span class="icon">投</span>
      <span>CSV蜃ｺ蜉・/span>
    </div>
    <div class="fab-menu-item" onclick="FAB.action('print')">
      <span class="icon">蜜・・/span>
      <span>繝ｬ繝昴・繝亥魂蛻ｷ</span>
    </div>
    <div class="fab-menu-item" onclick="FAB.action('help')">
      <span class="icon">竚ｨ・・/span>
      <span>繧ｷ繝ｧ繝ｼ繝医き繝・ヨ</span>
    </div>
  </div>
  <button class="fab-button" id="fabButton" onclick="FAB.toggle()" title="繧ｯ繧､繝・け繧｢繧ｯ繧ｷ繝ｧ繝ｳ">
    筐・
  </button>
</div>
</body>
</html>
