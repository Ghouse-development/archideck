<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2563EB">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ArchiDeck">
<meta name="description" content="‰ΩèÂÆÖË®≠Ë®àÊ•≠Âãô„ÇíÈù©Êñ∞ÁöÑ„Å´ÂäπÁéáÂåñ„Åô„Çã„Çø„Çπ„ÇØÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†">
<link rel="manifest" href="/archideck/manifest.json">
<title>ArchiDeck | G„Éè„Ç¶„Çπ Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üè†</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232563EB' width='100' height='100' rx='20'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white'>A</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.87.1/dist/umd/supabase.min.js" integrity="sha256-mgB0KFXEH7op01hbCXulq3TZjSqvaCMD35XeKkoTqL8=" crossorigin="anonymous"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  /* Primary - Deep Ocean Blue */
  --primary-color: #2563EB;
  --primary-hover: #1D4ED8;
  --primary-light: #DBEAFE;
  --primary-dark: #1E40AF;

  /* Secondary - Emerald Green */
  --secondary-color: #059669;
  --secondary-hover: #047857;
  --secondary-light: #D1FAE5;

  /* Accent - Violet */
  --accent-color: #7C3AED;
  --accent-light: #EDE9FE;

  /* Status Colors */
  --danger-color: #DC2626;
  --danger-light: #FEE2E2;
  --danger-bg: #FEE2E2;
  --warning-color: #D97706;
  --warning-light: #FEF3C7;
  --warning-bg: #FEF3C7;
  --success-color: #16A34A;
  --success-light: #DCFCE7;
  --success-bg: #DCFCE7;
  --info-color: #0891B2;
  --info-light: #CFFAFE;

  /* Text Colors */
  --text-primary: #0F172A;
  --text-secondary: #475569;
  --text-muted: #94A3B8;
  --text-light: #CBD5E1;

  /* Background Colors */
  --bg-primary: #FFFFFF;
  --bg-secondary: #F8FAFC;
  --bg-tertiary: #F1F5F9;
  --bg-hover: #E2E8F0;

  /* Border Colors */
  --border-color: #E2E8F0;
  --border-light: #F1F5F9;
  --border-focus: #93C5FD;

  /* Shadows - More refined */
  --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -2px rgba(0,0,0,0.04);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.03);
  --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.08), 0 8px 10px -6px rgba(0,0,0,0.03);
  --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,0.15);
  --shadow-inner: inset 0 2px 4px rgba(0,0,0,0.04);
  --shadow-glow: 0 0 20px rgba(37, 99, 235, 0.15);

  /* Border Radius */
  --radius-xs: 4px;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --radius-2xl: 20px;
  --radius-full: 9999px;

  /* Transitions */
  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-normal: 200ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-bounce: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);

  /* Spacing */
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-2xl: 48px;
}

/* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
[data-theme="dark"] {
  --primary-color: #60A5FA;
  --primary-hover: #3B82F6;
  --primary-light: #1E3A5F;
  --primary-dark: #93C5FD;

  --secondary-color: #34D399;
  --secondary-hover: #10B981;
  --secondary-light: #064E3B;

  --accent-color: #A78BFA;
  --accent-light: #2E1065;

  --danger-color: #F87171;
  --danger-light: #450A0A;
  --danger-bg: #450A0A;
  --warning-color: #FBBF24;
  --warning-light: #451A03;
  --warning-bg: #451A03;
  --success-color: #4ADE80;
  --success-light: #052E16;
  --success-bg: #052E16;
  --info-color: #22D3EE;
  --info-light: #083344;

  --text-primary: #F1F5F9;
  --text-secondary: #CBD5E1;
  --text-muted: #64748B;
  --text-light: #475569;

  --bg-primary: #0F172A;
  --bg-secondary: #1E293B;
  --bg-tertiary: #334155;
  --bg-hover: #475569;

  --border-color: #334155;
  --border-light: #1E293B;
  --border-focus: #60A5FA;

  --shadow-xs: 0 1px 2px rgba(0,0,0,0.3);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.4), 0 1px 2px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.4), 0 2px 4px -2px rgba(0,0,0,0.3);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.4), 0 4px 6px -4px rgba(0,0,0,0.2);
  --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.4), 0 8px 10px -6px rgba(0,0,0,0.2);
  --shadow-glow: 0 0 20px rgba(96, 165, 250, 0.2);
}


/* data-table „Çπ„Çø„Ç§„É´ÔºàÂàÜÊûêÁîªÈù¢Áî®Ôºâ */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.data-table th,
.data-table td {
  padding: 12px 16px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.data-table th {
  background: var(--bg-secondary);
  font-weight: 600;
  color: var(--text-primary);
}

.data-table td {
  color: var(--text-primary);
}

.data-table tr:hover td {
  background: var(--bg-hover);
}

body {
  font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-secondary);
  color: var(--text-primary);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Global Scrollbar Styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

/* Focus Visible - Accessibility */
:focus-visible {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

/* Selection Styling */
::selection {
  background: var(--primary-light);
  color: var(--primary-dark);
}

/* Utility Classes */
.text-primary { color: var(--text-primary); }
.text-secondary { color: var(--text-secondary); }
.text-muted { color: var(--text-muted); }
.text-success { color: var(--success-color); }
.text-danger { color: var(--danger-color); }
.text-warning { color: var(--warning-color); }

.bg-primary { background: var(--primary-light); }
.bg-success { background: var(--success-light); }
.bg-danger { background: var(--danger-light); }
.bg-warning { background: var(--warning-light); }

.font-medium { font-weight: 500; }
.font-semibold { font-weight: 600; }
.font-bold { font-weight: 700; }

.rounded { border-radius: var(--radius-md); }
.rounded-lg { border-radius: var(--radius-lg); }
.rounded-full { border-radius: var(--radius-full); }

.shadow-sm { box-shadow: var(--shadow-sm); }
.shadow-md { box-shadow: var(--shadow-md); }
.shadow-lg { box-shadow: var(--shadow-lg); }

/* Animation Classes */
.animate-fade-in {
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.animate-slide-up {
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-scale-in {
  animation: scaleIn 0.2s ease-out;
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ - Premium Design */
.login-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--bg-secondary) 0%, #E8F4FE 100%);
  padding: 20px;
  position: relative;
  overflow: hidden;
}

.login-container::before {
  content: '';
  position: absolute;
  width: 600px;
  height: 600px;
  background: radial-gradient(circle, rgba(37, 99, 235, 0.08) 0%, transparent 70%);
  top: -200px;
  right: -200px;
  pointer-events: none;
}

.login-container::after {
  content: '';
  position: absolute;
  width: 400px;
  height: 400px;
  background: radial-gradient(circle, rgba(5, 150, 105, 0.06) 0%, transparent 70%);
  bottom: -100px;
  left: -100px;
  pointer-events: none;
}

.login-card {
  background: var(--bg-primary);
  border: 1px solid rgba(255,255,255,0.8);
  border-radius: var(--radius-2xl);
  padding: 48px;
  box-shadow: var(--shadow-xl), 0 0 40px rgba(37, 99, 235, 0.06);
  max-width: 440px;
  width: 100%;
  text-align: center;
  position: relative;
  z-index: 1;
}

.login-logo {
  width: 64px;
  height: 64px;
  margin: 0 auto 20px;
  background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);
}

.login-card h1 {
  font-size: 26px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
  letter-spacing: -0.02em;
}

.login-card p {
  color: var(--text-secondary);
  margin-bottom: 32px;
  font-size: 14px;
  line-height: 1.5;
}

/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä */
.main-container {
  display: none;
  max-width: 1800px;
  margin: 0 auto;
  background: var(--bg-secondary);
  min-height: 100vh;
}

.main-container.show {
  display: block;
}

/* „Éò„ÉÉ„ÉÄ„Éº - Premium Design */
.header {
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  padding: 0 32px;
  height: 64px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 32px;
}

.sidebar-toggle {
  display: none;
}

.logo {
  font-size: 22px;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
  letter-spacing: -0.02em;
}

.logo-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
}

.logo-text {
  background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* „Éò„ÉÉ„ÉÄ„ÉºÂÜÖ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
.header-nav {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-left: 16px;
}

.header-nav-btn {
  padding: 8px 14px;
  background: transparent;
  border: none;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  white-space: nowrap;
}

.header-nav-btn:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.header-nav-btn.active {
  background: var(--primary-color);
  color: white;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-action-btn {
  width: 40px;
  height: 40px;
  border: none;
  background: transparent;
  border-radius: var(--radius-md);
  cursor: pointer;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-fast);
}

.header-action-btn:hover {
  background: var(--bg-secondary);
  color: var(--primary-color);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 6px 12px 6px 6px;
  background: var(--bg-secondary);
  border-radius: var(--radius-full);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.user-info:hover {
  background: var(--bg-hover);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  font-weight: 600;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

.user-role {
  font-size: 11px;
  color: var(--text-muted);
}

/* „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„Åà„É°„Éã„É•„Éº */
.category-switch-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  min-width: 180px;
}

.category-switch-menu button {
  display: block;
  width: 100%;
  padding: 12px 16px;
  text-align: left;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-primary);
  transition: background 0.2s;
}

.category-switch-menu button:hover {
  background: var(--bg-secondary);
}

.category-switch-menu button:first-child {
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.category-switch-menu button:last-child {
  border-radius: 0 0 var(--radius-md) var(--radius-md);
}

/* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
.tabs-nav {
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  padding: 0 32px;
  display: flex;
  gap: 8px;
}

.tab-nav-btn {
  padding: 16px 24px;
  border: none;
  background: transparent;
  font-size: 15px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.tab-nav-btn:hover {
  color: var(--text-primary);
  background: var(--bg-secondary);
}

.tab-nav-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
}

/* „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
.tab-panel {
  display: none;
  flex: 1;
  overflow-y: auto;
}

.tab-panel.active {
  display: flex;
  flex-direction: column;
}

/* „ÉÑ„Éº„É´„Éê„Éº */
.toolbar {
  background: var(--bg-primary);
  padding: 20px 32px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.toolbar-left {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  flex: 1;
}

.toolbar-right {
  display: flex;
  gap: 12px;
}

/* „Ç≥„É≥„Éë„ÇØ„Éà„ÉÑ„Éº„É´„Éê„Éº */
.compact-toolbar {
  padding: 12px 20px;
  flex-direction: column;
  gap: 8px;
}

.toolbar-main {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
}

.toolbar-spacer {
  flex: 1;
}

.select-compact {
  padding: 6px 10px;
  font-size: 12px;
  min-width: auto;
}

.filter-panel {
  width: 100%;
  padding-top: 8px;
  border-top: 1px solid var(--border-light);
}

.filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}

@media (max-width: 768px) {
  .toolbar-main {
    flex-wrap: wrap;
  }
  .filter-row {
    flex-direction: column;
    align-items: stretch;
  }
  .filter-row .select-compact {
    width: 100%;
  }
}

/* „Éá„Ç∂„Ç§„Éä„Éº„Çø„Éñ */
.designer-tabs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.designer-tab {
  padding: 8px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.designer-tab:hover {
  background: var(--bg-tertiary);
}

.designer-group-label {
  width: 100%;
  padding: 8px 12px;
  margin-top: 12px;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border-radius: 8px;
  border-left: 3px solid var(--primary-color);
}

.designer-tab.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* „Éú„Çø„É≥ - Premium Design */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 11px 22px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-normal);
  white-space: nowrap;
  position: relative;
  overflow: hidden;
  letter-spacing: 0.01em;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.12) 0%, transparent 50%);
  pointer-events: none;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2), 0 1px 2px rgba(37, 99, 235, 0.12);
}

.btn-primary:hover {
  background: var(--primary-hover);
  box-shadow: 0 8px 16px rgba(37, 99, 235, 0.25), 0 3px 6px rgba(37, 99, 235, 0.15);
  transform: translateY(-1px);
}

.btn-primary:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
}

.btn-secondary {
  background: var(--secondary-color);
  color: white;
  box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2);
}

.btn-secondary:hover {
  background: var(--secondary-hover);
  box-shadow: 0 8px 16px rgba(5, 150, 105, 0.25);
  transform: translateY(-1px);
}

.btn-ghost {
  background: transparent;
  border: 1.5px solid var(--border-color);
  color: var(--text-primary);
}

.btn-ghost::before {
  display: none;
}

.btn-ghost:hover {
  background: var(--bg-secondary);
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.btn-outline {
  background: transparent;
  border: 1.5px solid var(--primary-color);
  color: var(--primary-color);
}

.btn-outline::before {
  display: none;
}

.btn-outline:hover {
  background: var(--primary-light);
}

.btn-danger {
  background: var(--danger-color);
  color: white;
  box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
}

.btn-danger:hover {
  background: #B91C1C;
  box-shadow: 0 8px 16px rgba(220, 38, 38, 0.25);
  transform: translateY(-1px);
}

.btn-soft {
  background: var(--primary-light);
  color: var(--primary-color);
  border: none;
}

.btn-soft::before {
  display: none;
}

.btn-soft:hover {
  background: var(--border-focus);
}

.btn-small {
  padding: 7px 14px;
  font-size: 13px;
}

.btn-large {
  padding: 14px 28px;
  font-size: 16px;
}

.btn-icon {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: var(--radius-md);
}

.btn-icon.btn-small {
  width: 32px;
  height: 32px;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ - Premium Design */
.input, .select {
  padding: 11px 16px;
  border: 1.5px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  background: var(--bg-primary);
  transition: all var(--transition-normal);
  color: var(--text-primary);
}

.input:hover, .select:hover {
  border-color: var(--text-muted);
}

.input:focus, .select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  background: #FAFBFF;
}

.input::placeholder {
  color: var(--text-muted);
}

.input {
  min-width: 200px;
}

.input-group {
  position: relative;
}

.input-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  pointer-events: none;
}

.input-group .input {
  padding-left: 42px;
}

/* „Ç´„Éº„Éâ„Ç∞„É™„ÉÉ„Éâ */
.cards-container {
  padding: 32px;
}

.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
  gap: 24px;
}

/* „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„Éº„Éâ - Premium Design */
.project-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-xl);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: all var(--transition-slow);
  position: relative;
  overflow: hidden;
}

.project-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--secondary-color));
  opacity: 0;
  transition: opacity var(--transition-normal);
}

.project-card:hover {
  box-shadow: var(--shadow-lg), var(--shadow-glow);
  transform: translateY(-2px);
  border-color: transparent;
}

.project-card:hover::before {
  opacity: 1;
}

/* ÈÅ∏Êäû‰∏≠„Ç´„Éº„Éâ */
.project-card.selected {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px var(--primary-light);
}

/* „Éê„ÉÉ„ÉÅÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ */
.batch-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
  margin-top: 2px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border-light);
}

.card-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 12px;
  line-height: 1.3;
  letter-spacing: -0.02em;
}

.card-title:hover {
  color: var(--primary-color);
}

/* Áâ©‰ª∂Âêç„ÅÆËÉåÊôØ„Éè„Ç§„É©„Ç§„Éà */
.customer-name {
  background: linear-gradient(135deg, #DBEAFE 0%, #EFF6FF 100%);
  padding: 4px 12px;
  border-radius: 6px;
  color: #1E40AF;
}

.card-title:hover .customer-name {
  background: linear-gradient(135deg, #BFDBFE 0%, #DBEAFE 100%);
}

.card-subtitle {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.card-subtitle::before {
  content: '';
  display: inline-block;
  width: 4px;
  height: 4px;
  background: var(--text-muted);
  border-radius: 50%;
}

/* „Éê„ÉÉ„Ç∏ - Premium Design */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  border-radius: var(--radius-full);
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.02em;
  border: none;
}

.badge-primary {
  background: var(--primary-light);
  color: var(--primary-color);
}

.badge-success {
  background: var(--success-light);
  color: var(--success-color);
}

.badge-warning {
  background: var(--warning-light);
  color: var(--warning-color);
}

.badge-danger {
  background: var(--danger-light);
  color: var(--danger-color);
}

.badge-secondary {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
}

.badge-info {
  background: var(--info-light);
  color: var(--info-color);
}

.badge-accent {
  background: var(--accent-light);
  color: var(--accent-color);
}

/* „Éà„Ç∞„É´„Çπ„Ç§„ÉÉ„ÉÅ */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 26px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.3s;
  border-radius: 26px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: var(--primary-color);
}

input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

/* „Éü„Çπ„ÉªÊºè„ÇåÈò≤Ê≠¢: Ë≠¶Âëä„Éê„ÉÉ„Ç∏ */
.project-warnings {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.warning-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  animation: pulse-warning 2s ease-in-out infinite;
}

.warning-badge.warning-danger {
  background: linear-gradient(135deg, #FEE2E2, #FECACA);
  color: #DC2626;
  border: 1px solid #FCA5A5;
}

.warning-badge.warning-warning {
  background: linear-gradient(135deg, #FEF3C7, #FDE68A);
  color: #D97706;
  border: 1px solid #FCD34D;
}

.warning-icon {
  font-size: 14px;
}

@keyframes pulse-warning {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* „Ç¢„É©„Éº„Éà„Çµ„Éû„É™„Éº */
.alert-summary {
  background: linear-gradient(135deg, #FEF2F2, #FEE2E2);
  border: 2px solid #FCA5A5;
  border-radius: 12px;
  padding: 16px 20px;
  margin-bottom: 20px;
  animation: slide-down 0.3s ease-out;
}

@keyframes slide-down {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.alert-summary-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}

.alert-summary-icon {
  font-size: 20px;
}

.alert-summary-title {
  font-size: 16px;
  font-weight: 700;
  color: #DC2626;
}

.alert-summary-count {
  background: #DC2626;
  color: white;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.alert-summary-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.alert-item {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--bg-primary);
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  color: #991B1B;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid #FECACA;
}

.alert-item:hover {
  background: #FEF2F2;
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15);
}

/* „Ç´„Éº„Éâ„Éè„Ç§„É©„Ç§„Éà */
.project-card.highlight-card {
  animation: highlight-pulse 0.5s ease-out 3;
  box-shadow: 0 0 0 3px var(--primary-color), var(--shadow-lg);
}

@keyframes highlight-pulse {
  0%, 100% { box-shadow: 0 0 0 3px var(--primary-color), var(--shadow-lg); }
  50% { box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.3), var(--shadow-lg); }
}

.badge-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
}

/* Ê•≠ËÄÖ„Ç´„Éº„Éâ */
.vendor-card {
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.vendor-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
  border-color: var(--primary-color);
}

.vendor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--bg-secondary);
}

.vendor-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.vendor-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
  font-size: 14px;
  color: var(--text-secondary);
}

.vendor-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* Áµ±Ë®à„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ */
.stats-dashboard {
  background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-color);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 16px;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: var(--bg-primary);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-color);
  transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.stat-card.stat-warning {
  border-color: var(--warning-color);
  background: var(--warning-light);
}

.stat-icon {
  font-size: 28px;
}

.stat-content {
  display: flex;
  flex-direction: column;
}

.stat-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1.2;
}

.stat-label {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 2px;
}

.stats-toggle-btn {
  margin-top: 12px;
  padding: 6px 12px;
  background: transparent;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 12px;
  color: var(--text-muted);
  transition: all 0.2s;
}

.stats-toggle-btn:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

/* ÊúüÈôêÂàá„Çå„ÉªÊúüÈôêÈñìËøë„ÅÆ„Ç´„Éº„Éâ„Çπ„Çø„Ç§„É´ */
.project-card.overdue {
  border-left: 4px solid var(--danger-color);
  background: linear-gradient(90deg, var(--danger-light) 0%, var(--bg-primary) 8%);
  animation: overdueGlow 2s ease-in-out infinite;
}

.project-card.due-soon {
  border-left: 4px solid var(--warning-color);
  background: linear-gradient(90deg, var(--warning-light) 0%, var(--bg-primary) 8%);
}

@keyframes overdueGlow {
  0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
  50% { box-shadow: 0 0 8px 2px rgba(220, 38, 38, 0.3); }
}

/* „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Çπ„Çø„Ç§„É´ */
.project-card.dragging {
  opacity: 0.5;
  transform: scale(1.02);
  box-shadow: var(--shadow-xl);
  cursor: grabbing;
}

.project-card.drag-over {
  border: 2px dashed var(--primary-color);
  background: var(--primary-light);
}

.project-card[draggable="true"] {
  cursor: grab;
}

.project-card[draggable="true"]:active {
  cursor: grabbing;
}

/* „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */
.fab-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 1000;
}

.fab-button {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  border: none;
  box-shadow: var(--shadow-lg);
  cursor: pointer;
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-normal);
}

.fab-button:hover {
  background: var(--primary-hover);
  transform: scale(1.1);
  box-shadow: var(--shadow-xl);
}

.fab-button.active {
  transform: rotate(45deg);
}

.fab-menu {
  position: absolute;
  bottom: 70px;
  right: 0;
  display: none;
  flex-direction: column;
  gap: 8px;
}

.fab-menu.show {
  display: flex;
}

.fab-menu-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  cursor: pointer;
  white-space: nowrap;
  font-size: 14px;
  color: var(--text-primary);
  transition: all var(--transition-fast);
  animation: fabItemIn 0.2s ease-out forwards;
  opacity: 0;
  transform: translateX(20px);
}

.fab-menu-item:nth-child(1) { animation-delay: 0ms; }
.fab-menu-item:nth-child(2) { animation-delay: 50ms; }
.fab-menu-item:nth-child(3) { animation-delay: 100ms; }
.fab-menu-item:nth-child(4) { animation-delay: 150ms; }
.fab-menu-item:nth-child(5) { animation-delay: 200ms; }

@keyframes fabItemIn {
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.fab-menu-item:hover {
  background: var(--bg-secondary);
  transform: translateX(-4px);
}

.fab-menu-item span.icon {
  font-size: 18px;
}

/* Âº∑Âåñ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó */
[data-tooltip] {
  position: relative;
}

[data-tooltip]::before,
[data-tooltip]::after {
  position: absolute;
  visibility: hidden;
  opacity: 0;
  transition: all 0.2s ease;
  pointer-events: none;
  z-index: 1000;
}

[data-tooltip]::before {
  content: attr(data-tooltip);
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%) translateY(4px);
  padding: 8px 12px;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  font-size: 12px;
  white-space: nowrap;
  max-width: 250px;
  text-overflow: ellipsis;
  overflow: hidden;
}

[data-tooltip]::after {
  content: '';
  bottom: calc(100% + 2px);
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: var(--bg-tertiary);
}

[data-tooltip]:hover::before,
[data-tooltip]:hover::after {
  visibility: visible;
  opacity: 1;
}

[data-tooltip]:hover::before {
  transform: translateX(-50%) translateY(0);
}

/* ‰∏ãÂêë„Åç„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó */
[data-tooltip-pos="bottom"]::before {
  bottom: auto;
  top: calc(100% + 8px);
  transform: translateX(-50%) translateY(-4px);
}

[data-tooltip-pos="bottom"]::after {
  bottom: auto;
  top: calc(100% + 2px);
  border-top-color: transparent;
  border-bottom-color: var(--bg-tertiary);
}

[data-tooltip-pos="bottom"]:hover::before {
  transform: translateX(-50%) translateY(0);
}

/* „É≠„Éº„Éá„Ç£„É≥„Ç∞„Çπ„Éî„Éä„Éº */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--border-color);
  border-top-color: var(--primary-color);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

.loading-spinner.large {
  width: 40px;
  height: 40px;
  border-width: 3px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s ease;
}

.loading-overlay.show {
  opacity: 1;
  visibility: visible;
}

.loading-card {
  background: var(--bg-primary);
  padding: 32px 48px;
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-2xl);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

.loading-text {
  font-size: 14px;
  color: var(--text-secondary);
}

/* „Çπ„Ç±„É´„Éà„É≥„É≠„Éº„Éá„Ç£„É≥„Ç∞ */
.skeleton {
  background: linear-gradient(90deg, var(--bg-tertiary) 0%, var(--bg-hover) 50%, var(--bg-tertiary) 100%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s ease-in-out infinite;
  border-radius: var(--radius-sm);
}

@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.skeleton-card {
  height: 200px;
  border-radius: var(--radius-lg);
}

.skeleton-text {
  height: 16px;
  width: 60%;
}

.skeleton-text.short {
  width: 30%;
}

/* „Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
.project-card.keyboard-focused {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
  box-shadow: var(--shadow-glow);
}

.project-card.keyboard-focused .card-header {
  background: var(--primary-light);
}

/* „Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø„Éº */
.category-filter-btn {
  padding: 8px 16px;
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
}

.category-filter-btn:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  background: var(--bg-secondary);
}

.category-filter-btn.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„É©„Éô„É´ */
.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
}

.checkbox-label input[type="checkbox"] {
  cursor: pointer;
  width: 18px;
  height: 18px;
}

.checkbox-label span {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

/* ÈÄ≤Êçó„Éê„Éº - Premium Design */
.progress-section {
  margin-bottom: 20px;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.progress-label {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
}

.progress-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--primary-color);
  display: flex;
  align-items: baseline;
  gap: 2px;
}

.progress-value-unit {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-muted);
}

.progress-bar {
  height: 8px;
  background: var(--bg-hover);
  border-radius: var(--radius-full);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: var(--radius-full);
  position: relative;
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
  animation: shimmer 2s ease-in-out infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.progress-fill.complete {
  background: var(--success-color);
}

/* „Çø„Çπ„ÇØ„É™„Çπ„Éà - Premium Design */
.tasks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 10px;
  margin-bottom: 20px;
}

.task-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--bg-primary);
  border-radius: var(--radius-md);
  font-size: 14px;
  transition: all var(--transition-fast);
  border: 1px solid var(--border-light);
}

.task-item:hover {
  background: var(--bg-secondary);
  border-color: var(--border-color);
  box-shadow: var(--shadow-sm);
}

/* „Çø„Çπ„ÇØÊúüÈôê„ÉªÈÅÖÂª∂Ë°®Á§∫ */
.task-item.overdue {
  border-left: 3px solid var(--danger-color);
  background: #FEF2F2;
}

.task-item.due-soon {
  border-left: 3px solid var(--warning-color);
  background: #FFFBEB;
}

.task-due-date {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
  margin-left: auto;
  white-space: nowrap;
}

.task-due-date.overdue {
  background: var(--danger-light);
  color: var(--danger-color);
  font-weight: 600;
}

.task-due-date.due-soon {
  background: var(--warning-light);
  color: #92400E;
}

.task-due-date.normal {
  background: var(--bg-tertiary);
  color: var(--text-muted);
}

.task-due-input {
  width: 110px;
  padding: 4px 8px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 12px;
  flex-shrink: 0;
}

.task-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
  border-radius: var(--radius-xs);
}

.task-state-select {
  height: 32px;
  padding: 0 10px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  background: var(--bg-primary);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--transition-fast);
  min-width: 90px;
  flex-shrink: 0;
}

.task-state-select:hover {
  border-color: var(--primary-color);
}

.task-state-select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
}

.task-state-select.state-yellow {
  background: var(--warning-light);
  border-color: #F59E0B;
  color: #92400E;
}

.task-state-select.state-blue {
  background: var(--primary-light);
  border-color: #3B82F6;
  color: #1E40AF;
}

.task-label {
  flex: 1;
  color: var(--text-primary);
  font-weight: 500;
  font-size: 13px;
}

.task-email-btn {
  width: 32px;
  height: 32px;
  padding: 0;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.task-email-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
}

/* ‰æùÈ†ºÊó•„Éê„ÉÉ„Ç∏ */
.request-date-badge {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: var(--radius-full);
  background: #e3f2fd;
  color: #1976d2;
  white-space: nowrap;
  cursor: help;
}

/* Áî≥Ë´ãGo„Ç≥„É≥„ÉÜ„ÉäÔºà„Éï„É´„ÉØ„Ç§„ÉâÔºâ */
.application-go-container {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 16px 24px;
  border-radius: 12px;
  margin-top: 8px;
  transition: all 0.3s ease;
}

.application-go-icon {
  font-size: 24px;
}

.application-go-text {
  font-size: 16px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.application-go-arrow {
  font-size: 20px;
  font-weight: 700;
  animation: pulse-arrow 1.5s infinite;
}

@keyframes pulse-arrow {
  0%, 100% { opacity: 1; transform: translateX(0); }
  50% { opacity: 0.6; transform: translateX(4px); }
}

.application-go-status {
  font-size: 12px;
  padding: 4px 12px;
  background: rgba(0,0,0,0.1);
  border-radius: 12px;
}

/* Êù°‰ª∂ÈÅîÊàêÊôÇÔºö„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ */
.application-go-ready {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
}

.application-go-ready:hover {
  background: linear-gradient(135deg, #059669, #047857);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
}

/* ÂÆå‰∫ÜÊ∏à„Åø */
.application-go-completed {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}

.application-go-completed .application-go-icon {
  background: white;
  color: #10b981;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
}

/* Êù°‰ª∂Êú™ÈÅî */
.application-go-disabled {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 2px dashed var(--border-color);
}

.application-go-disabled .application-go-icon {
  opacity: 0.5;
}

/* Áî≥Ë´ãGo „É¢„Éê„Ç§„É´ÂØæÂøú */
@media (max-width: 768px) {
  .application-go-container {
    padding: 14px 16px;
    gap: 10px;
  }

  .application-go-icon {
    font-size: 20px;
  }

  .application-go-text {
    font-size: 14px;
  }

  .application-go-arrow {
    font-size: 16px;
  }
}

.template-select-btn {
  width: 100%;
  padding: 16px;
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}

.template-select-btn:hover {
  border-color: var(--primary-color);
  background: var(--bg-secondary);
  transform: translateX(4px);
}

/* „É¢„Éº„ÉÄ„É´ - Premium Design */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.6);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(8px);
  padding: 20px;
}

.modal.show {
  display: flex;
  animation: modalBgFadeIn 0.2s ease-out;
}

@keyframes modalBgFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: var(--bg-primary);
  border-radius: var(--radius-2xl);
  width: min(800px, 100%);
  max-height: calc(100vh - 40px);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-2xl), 0 0 60px rgba(0, 0, 0, 0.15);
  animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-24px) scale(0.96);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  padding: 24px 28px;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg-primary);
  flex-shrink: 0;
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.02em;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.modal-title-icon {
  width: 36px;
  height: 36px;
  background: var(--primary-light);
  color: var(--primary-color);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

.close {
  width: 36px;
  height: 36px;
  border: none;
  background: var(--bg-secondary);
  color: var(--text-secondary);
  font-size: 20px;
  cursor: pointer;
  border-radius: var(--radius-md);
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
}

.close:hover {
  background: var(--danger-light);
  color: var(--danger-color);
}

.modal-body {
  padding: 28px;
  overflow-y: auto;
  flex: 1;
}

.modal-body::-webkit-scrollbar {
  width: 6px;
}

.modal-body::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 3px;
}

.modal-footer {
  padding: 20px 28px;
  border-top: 1px solid var(--border-light);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  background: var(--bg-secondary);
  flex-shrink: 0;
}

/* „Éï„Ç©„Éº„É† - Premium Design */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.form-label-required {
  color: var(--danger-color);
  font-size: 12px;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 12px 16px;
  border: 1.5px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  transition: all var(--transition-fast);
  background: var(--bg-primary);
  color: var(--text-primary);
}

.form-input:hover, .form-select:hover, .form-textarea:hover {
  border-color: var(--text-muted);
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  background: #FAFBFF;
}

.form-input::placeholder {
  color: var(--text-muted);
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
  line-height: 1.5;
}

.form-hint {
  margin-top: 6px;
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 4px;
}

.state-options-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.state-option-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.state-option-item input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
}

.state-option-item .btn-remove {
  padding: 4px 8px;
  background: var(--danger);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.state-option-item .btn-remove:hover {
  opacity: 0.8;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.form-divider {
  height: 1px;
  background: var(--border-light);
  margin: 24px 0;
}

.form-section-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* „Çπ„ÉÜ„Éº„Çø„Çπ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 600;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.status-saving {
  background: #FFF4E6;
  color: var(--warning-color);
}

.status-saving .status-dot {
  background: var(--warning-color);
  animation: pulse 1.5s infinite;
}

.status-saved {
  background: #E6F9F0;
  color: var(--success-color);
}

.status-saved .status-dot {
  background: var(--success-color);
}

.status-error {
  background: #FFE6E6;
  color: var(--danger-color);
}

.status-error .status-dot {
  background: var(--danger-color);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* „ÉÜ„Éº„Éñ„É´ */
.table-container {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table thead {
  background: linear-gradient(180deg, #f8f9fa, #f0f1f3);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
}

.table th {
  padding: 18px 20px;
  text-align: left;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table td {
  padding: 16px 20px;
  border-top: 1px solid var(--border-color);
  font-size: 14px;
  color: var(--text-primary);
}

.table tbody tr:nth-child(even) {
  background: #fafbfc;
}

.table tbody tr:hover {
  background: #f0f7ff;
  box-shadow: inset 0 0 0 1px rgba(74, 144, 226, 0.1);
  transition: all 0.2s;
}

/* Á©∫Áä∂ÊÖã */
.empty-state {
  padding: 80px 40px;
  text-align: center;
  color: var(--text-secondary);
}

.empty-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.empty-description {
  font-size: 14px;
  margin-bottom: 24px;
}

/* „É°„Éº„É´Âá∫Âäõ */
.email-output {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: 20px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.8;
  white-space: pre-wrap;
  margin: 16px 0;
  max-height: 400px;
  overflow-y: auto;
}

/* „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó */
.minutes-upload-area.drag-over {
  background: var(--bg-tertiary);
  border-color: var(--primary-color);
  transform: scale(1.02);
}

/* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
@media (max-width: 1200px) {
  .cards-grid {
    grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
  }
}

@media (max-width: 768px) {
  .header {
    padding: 12px 16px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .header-left {
    gap: 8px;
    flex-wrap: wrap;
  }

  .logo {
    font-size: 18px;
  }

  .header-nav {
    gap: 2px;
    margin-left: 0;
    order: 3;
    width: 100%;
    justify-content: center;
    margin-top: 4px;
  }

  .header-nav-btn {
    padding: 6px 10px;
    font-size: 12px;
  }

  .tabs-nav {
    padding: 0 12px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .tab-nav-btn {
    padding: 12px 16px;
    font-size: 14px;
    white-space: nowrap;
  }

  .toolbar {
    padding: 12px 16px;
    flex-direction: column;
    align-items: stretch;
  }

  .toolbar-left {
    flex-direction: column;
  }

  .toolbar-right {
    justify-content: center;
  }

  .cards-container {
    padding: 12px;
  }

  .cards-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .project-card {
    padding: 16px;
  }

  .card-header {
    flex-direction: column;
    gap: 12px;
  }

  .card-title {
    font-size: 18px;
    flex-wrap: wrap;
  }

  .tasks-grid {
    grid-template-columns: 1fr;
  }

  .task-item {
    flex-wrap: wrap;
    gap: 8px;
  }

  .task-state-select {
    width: 100%;
    margin-top: 4px;
  }

  .modal-content {
    width: 95vw;
    max-height: 90vh;
  }

  .modal-body {
    padding: 16px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-input, .form-select, .select {
    font-size: 16px;
    padding: 12px;
  }

  .btn {
    padding: 12px 16px;
    font-size: 14px;
    min-height: 44px;
  }

  .btn-small {
    padding: 10px 14px;
    min-height: 40px;
  }

  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 1000;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    width: 280px;
  }

  .sidebar.open {
    transform: translateX(0);
  }

  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
  }

  .sidebar-overlay.show {
    display: block;
  }

  .sidebar-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: none;
    background: var(--primary-color);
    color: white;
    border-radius: 8px;
    font-size: 20px;
    cursor: pointer;
    margin-right: 8px;
  }

  .add-task-form {
    flex-direction: column;
  }

  .add-task-form input {
    width: 100%;
  }

  .designer-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 8px;
  }

  .designer-tab {
    flex-shrink: 0;
  }
}

@media (max-width: 480px) {
  .login-card {
    padding: 24px 20px;
  }

  .login-card h1 {
    font-size: 24px;
  }

  .header-right {
    gap: 8px;
  }

  .user-info {
    padding: 6px 10px;
    font-size: 13px;
  }

  .badge {
    padding: 4px 8px;
    font-size: 11px;
  }
}

/* „É≠„Éº„Éá„Ç£„É≥„Ç∞„Çπ„Éî„Éä„Éº */
.spinner {
  border: 3px solid var(--bg-secondary);
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 40px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó */
.draggable-row {
  cursor: move;
  transition: all 0.2s;
}

.draggable-row:hover {
  background: var(--bg-secondary);
}

.draggable-row.dragging {
  opacity: 0.5;
  background: var(--bg-hover);
}

.draggable-row.drag-over {
  border-top: 3px solid var(--primary-color);
}

.drag-handle {
  cursor: grab;
  color: var(--text-secondary);
  font-size: 18px;
  padding: 0 8px;
  user-select: none;
}

.drag-handle:active {
  cursor: grabbing;
}

/* „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº */
.context-menu {
  position: fixed;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  min-width: 180px;
  z-index: 10000;
  display: none;
  padding: 8px 0;
}
.context-menu.show { display: block; }
.context-menu-item {
  padding: 10px 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  color: var(--text-primary);
  transition: background 0.15s;
}
.context-menu-item:hover { background: var(--bg-secondary); }
.context-menu-item.danger { color: var(--error-color); }
.context-menu-divider { height: 1px; background: var(--border-color); margin: 4px 0; }

/* „Éà„Éº„Çπ„ÉàÈÄöÁü• - Premium Design */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  padding: 16px 20px;
  box-shadow: var(--shadow-xl);
  display: none;
  align-items: center;
  gap: 12px;
  z-index: 2000;
  max-width: 400px;
  border: 1px solid var(--border-color);
}

.toast.show {
  display: flex;
  animation: toastSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes toastSlideIn {
  from {
    transform: translateX(120%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 14px;
}

.toast-success {
  border-left: 4px solid var(--success-color);
}

.toast-success .toast-icon {
  background: var(--success-light);
  color: var(--success-color);
}

.toast-error {
  border-left: 4px solid var(--danger-color);
}

.toast-error .toast-icon {
  background: var(--danger-light);
  color: var(--danger-color);
}

.toast-warning {
  border-left: 4px solid var(--warning-color);
}

.toast-warning .toast-icon {
  background: var(--warning-light);
  color: var(--warning-color);
}

.toast-message {
  font-size: 14px;
  color: var(--text-primary);
  font-weight: 500;
  line-height: 1.4;
}

/* „Çµ„Ç§„Éâ„Éê„Éº„É¨„Ç§„Ç¢„Ç¶„Éà - Premium Design */
.app-layout {
  display: flex;
  height: calc(100vh - 64px);
  overflow: hidden;
}

.sidebar {
  width: 280px;
  background: linear-gradient(180deg, white 0%, var(--bg-secondary) 100%);
  border-right: 1px solid var(--border-color);
  overflow-y: auto;
  flex-shrink: 0;
}

.sidebar::-webkit-scrollbar {
  width: 6px;
}

.sidebar::-webkit-scrollbar-track {
  background: transparent;
}

.sidebar::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 3px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

.sidebar-header {
  padding: 20px 16px;
  border-bottom: 1px solid var(--border-light);
}

.sidebar-section {
  padding: 16px;
  border-bottom: 1px solid var(--border-light);
}

.sidebar-section:last-child {
  border-bottom: none;
}

.sidebar-section-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 12px;
  padding-left: 4px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--transition-fast);
  margin-bottom: 2px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
}

.sidebar-item:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.sidebar-item.active {
  background: var(--primary-color);
  color: white;
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25);
}

.sidebar-item-label {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-item-icon {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.7;
}

.sidebar-item.active .sidebar-item-icon {
  opacity: 1;
}

.sidebar-item-count {
  font-size: 11px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: var(--radius-full);
  background: var(--bg-tertiary);
  color: var(--text-secondary);
}

.sidebar-item.active .sidebar-item-count {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

.sidebar-item-count.warning {
  background: var(--warning-light);
  color: var(--warning-color);
}

.sidebar-item-count.danger {
  background: var(--danger-light);
  color: var(--danger-color);
}

.sidebar-counts {
  display: flex;
  align-items: center;
  gap: 4px;
}

.sidebar-archived-count {
  font-size: 10px;
  font-weight: 500;
  padding: 2px 6px;
  border-radius: var(--radius-full);
  background: var(--success-bg);
  color: var(--success-color);
  cursor: pointer;
  transition: all 0.15s ease;
}

.sidebar-archived-count:hover {
  background: var(--success-color);
  color: white;
  transform: scale(1.05);
}

.sidebar-item.active .sidebar-archived-count {
  background: rgba(255, 255, 255, 0.15);
  color: rgba(255, 255, 255, 0.8);
}

.sidebar-item.active .sidebar-archived-count:hover {
  background: rgba(255, 255, 255, 0.3);
  color: white;
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* „Çµ„Éñ„Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ - Premium Design */
.sub-tabs-nav {
  display: flex;
  gap: 4px;
  padding: 12px 24px 0 24px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  overflow-x: auto;
}

.sub-tabs-nav::-webkit-scrollbar {
  height: 4px;
}

.sub-tabs-nav::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 2px;
}

.sub-tab-btn {
  padding: 12px 20px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  border-bottom: 2px solid transparent;
  transition: all var(--transition-fast);
  white-space: nowrap;
  position: relative;
}

.sub-tab-btn:hover {
  color: var(--primary-color);
  background: var(--primary-light);
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.sub-tab-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
  background: var(--primary-light);
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.sub-tab-panel {
  display: none;
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  max-height: calc(100vh - 180px);
}

.sub-tab-panel.active {
  display: block;
}

.table-container {
  overflow-y: auto;
  max-height: calc(100vh - 350px);
}

.cards-grid {
  overflow-y: auto;
  max-height: calc(100vh - 300px);
}

/* Ê•≠ËÄÖ„Ç´„Éº„Éâ */
.vendor-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.vendor-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
  border-color: var(--primary-color);
}

.vendor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--bg-secondary);
}

.vendor-header h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.vendor-info {
  margin-bottom: 16px;
}

.vendor-info > div {
  padding: 6px 0;
  font-size: 14px;
  color: var(--text-secondary);
}

.vendor-info strong {
  color: var(--text-primary);
  font-weight: 600;
  min-width: 80px;
  display: inline-block;
}

.vendor-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* ===== „Ç´„É¨„É≥„ÉÄ„Éº ===== */
.calendar-container {
  padding: 12px;
  max-width: 100%;
  margin: 0;
  height: calc(100vh - 120px);
  display: flex;
  flex-direction: column;
}

.calendar-header {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 24px;
  margin-bottom: 8px;
  padding: 8px 0;
}

.calendar-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  min-width: 140px;
  text-align: center;
}

.calendar-legend {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 8px;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  color: var(--text-muted);
}

.legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.legend-design { background: #4A90E2; }
.legend-ic { background: #9C27B0; }
.legend-exterior { background: #4CAF50; }
.legend-construction { background: #FF9800; }
.legend-task { background: #F44336; }

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  background: var(--border-color);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  overflow: hidden;
  flex: 1;
}

.calendar-day-header {
  background: var(--bg-tertiary);
  padding: 6px;
  text-align: center;
  font-weight: 600;
  font-size: 12px;
  color: var(--text-muted);
}

.calendar-day {
  background: var(--bg-primary);
  min-height: 80px;
  padding: 4px;
  position: relative;
  transition: background 0.15s;
}

.calendar-day:hover {
  background: var(--bg-secondary);
}

.calendar-day.other-month {
  background: var(--bg-secondary);
  opacity: 0.4;
}

.calendar-day.today {
  background: #E3F2FD;
}

.calendar-day-number {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 2px;
}

.calendar-day.today .calendar-day-number {
  background: var(--primary-color);
  color: white;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
}

.calendar-events {
  display: flex;
  flex-direction: column;
  gap: 1px;
  max-height: calc(100% - 26px);
  overflow-y: auto;
}

.calendar-event {
  font-size: 10px;
  padding: 2px 4px;
  border-radius: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
  border-left: 3px solid;
  background: white;
}

.calendar-event.design { border-color: #1565C0; color: #1565C0; }
.calendar-event.ic { border-color: #7B1FA2; color: #7B1FA2; }
.calendar-event.exterior { border-color: #388E3C; color: #388E3C; }
.calendar-event.construction { border-color: #E65100; color: #E65100; }
.calendar-event.task { border-color: #C62828; color: #C62828; }

.calendar-event:hover {
  background: var(--bg-secondary);
}

/* ===== ÂàÜÊûê„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ ===== */
.analytics-container {
  padding: 24px;
  max-width: 1400px;
  margin: 0 auto;
}

.analytics-section {
  background: var(--bg-primary);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--border-light);
}

/* „É¨„Éù„Éº„Éà */
.report-buttons {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.report-preview {
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 24px;
}

.report-card {
  background: var(--bg-primary);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  border: 1px solid var(--border-color);
  color: #000000;
}

.report-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--primary);
}

.report-header h2 {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0;
  color: #000000;
}

.report-period {
  font-size: 0.875rem;
  color: #333333;
  background: var(--bg-secondary);
  padding: 4px 12px;
  border-radius: 20px;
}

.report-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.report-stat-item {
  background: var(--bg-secondary);
  padding: 16px;
  border-radius: 10px;
  text-align: center;
}

.report-stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary);
}

.report-stat-label {
  font-size: 0.75rem;
  color: #333333;
  margin-top: 4px;
}

.report-section {
  margin-top: 20px;
}

.report-section-title {
  font-size: 1rem;
  font-weight: 600;
  color: #000000;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.report-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.report-list-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-radius: 8px;
  margin-bottom: 8px;
}

.report-list-item:last-child {
  margin-bottom: 0;
}

.report-project-name {
  font-weight: 500;
  color: #000000;
}

.report-project-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.875rem;
}

.report-progress-badge {
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

.report-progress-badge.high { background: #dcfce7; color: #166534; }
.report-progress-badge.medium { background: #fef9c3; color: #854d0e; }
.report-progress-badge.low { background: #fee2e2; color: #991b1b; }

.report-assignee {
  color: #333333;
}

.report-empty {
  text-align: center;
  padding: 20px;
  color: #333333;
  font-style: italic;
}

/* ÊãÖÂΩìËÄÖÂà•„É¨„Éù„Éº„Éà„Çπ„Çø„Ç§„É´ */
.report-designer-section {
  background: var(--bg-primary);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid var(--border-color);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
}

.report-designer-section:last-child {
  margin-bottom: 0;
}

.report-designer-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-bottom: 12px;
  margin-bottom: 12px;
  border-bottom: 1px solid var(--border-color);
}

.report-designer-name {
  font-weight: 600;
  font-size: 1rem;
  color: #000000;
}

.report-designer-count {
  background: #e0e7ff;
  color: #000000;
  font-size: 0.75rem;
  padding: 2px 10px;
  border-radius: 12px;
}

.report-project-detail {
  background: var(--bg-secondary);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  border-left: 3px solid var(--primary);
}

.report-project-detail:last-child {
  margin-bottom: 0;
}

.report-project-detail.updated {
  border-left-color: var(--success-color);
  background: linear-gradient(90deg, rgba(16, 185, 129, 0.05), var(--bg-primary));
}

.report-project-title {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.report-project-title .project-name {
  font-weight: 600;
  color: #000000;
}

.report-updated-badge {
  background: #d1fae5;
  color: #000000;
  font-size: 0.65rem;
  padding: 2px 6px;
  border-radius: 8px;
}

.report-status-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.report-status-tag {
  font-size: 0.75rem;
  padding: 3px 8px;
  border-radius: 6px;
  background: var(--bg-primary);
  color: #000000;
  border: 1px solid var(--border-color);
}

.report-status-tag.active {
  background: #e0e7ff;
  color: #000000;
  border-color: var(--primary);
}

/* ===== „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„ÉÑ„Ç¢„Éº ===== */
.tour-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 9998;
  pointer-events: none;
}

.tour-highlight {
  position: relative;
  z-index: 9999 !important;
  box-shadow: 0 0 0 4px var(--primary), 0 0 20px rgba(37, 99, 235, 0.5);
  border-radius: 8px;
  pointer-events: auto;
}

.tour-tooltip {
  position: fixed;
  z-index: 10000;
  background: white;
  border-radius: 12px;
  padding: 20px;
  max-width: 360px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  animation: tourFadeIn 0.3s ease;
}

@keyframes tourFadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.tour-tooltip::before {
  content: '';
  position: absolute;
  width: 12px;
  height: 12px;
  background: white;
  transform: rotate(45deg);
}

.tour-tooltip.arrow-top::before { top: -6px; left: 24px; }
.tour-tooltip.arrow-bottom::before { bottom: -6px; left: 24px; }
.tour-tooltip.arrow-left::before { left: -6px; top: 24px; }
.tour-tooltip.arrow-right::before { right: -6px; top: 24px; }

.tour-step-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 12px;
}

.tour-step-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #E2E8F0;
}

.tour-step-dot.active {
  background: var(--primary);
  width: 24px;
  border-radius: 4px;
}

.tour-step-dot.completed {
  background: var(--success-color);
}

.tour-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.tour-content {
  font-size: 0.9rem;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 16px;
}

.tour-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}

.tour-btn {
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.tour-btn-skip {
  background: transparent;
  color: var(--text-secondary);
}

.tour-btn-skip:hover {
  color: var(--text-primary);
}

.tour-btn-prev {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.tour-btn-prev:hover {
  background: #E2E8F0;
}

.tour-btn-next {
  background: var(--primary);
  color: white;
}

.tour-btn-next:hover {
  background: #1D4ED8;
}

.tour-welcome {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10000;
  background: white;
  border-radius: 16px;
  padding: 32px;
  max-width: 420px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: tourFadeIn 0.3s ease;
}

.tour-welcome-icon {
  font-size: 3rem;
  margin-bottom: 16px;
}

.tour-welcome h2 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.tour-welcome p {
  color: var(--text-secondary);
  margin-bottom: 24px;
  line-height: 1.6;
}

.tour-welcome-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
}

/* ===== ArchiDeck v3.0 Êñ∞Ê©üËÉΩ„Çπ„Çø„Ç§„É´ ===== */

/* 5ÈÉ®ÊßãÊàê„Ç´„Éº„Éâ„Çª„ÇØ„Ç∑„Éß„É≥ - Premium Design */
.card-section {
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  margin-bottom: 12px;
  overflow: hidden;
  background: var(--bg-primary);
  transition: all var(--transition-fast);
}

.card-section:hover {
  border-color: var(--border-color);
}

.card-section:last-child {
  margin-bottom: 0;
}

.card-section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  background: var(--bg-secondary);
  cursor: pointer;
  user-select: none;
  transition: all var(--transition-fast);
  border-bottom: 1px solid transparent;
}

.card-section-header:hover {
  background: var(--bg-tertiary);
}

.card-section:not(.collapsed) .card-section-header {
  border-bottom-color: var(--border-light);
}

.card-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-section-icon {
  width: 28px;
  height: 28px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  background: var(--primary-light);
  color: var(--primary-color);
}

.card-section:nth-child(2) .card-section-icon {
  background: var(--accent-light);
  color: var(--accent-color);
}

.card-section:nth-child(3) .card-section-icon {
  background: var(--warning-light);
  color: var(--warning-color);
}

.card-section:nth-child(4) .card-section-icon {
  background: var(--info-light);
  color: var(--info-color);
}

.card-section:nth-child(5) .card-section-icon {
  background: var(--success-light);
  color: var(--success-color);
}

.card-section-toggle {
  font-size: 10px;
  color: var(--text-muted);
  transition: transform var(--transition-fast);
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-sm);
}

.card-section-header:hover .card-section-toggle {
  background: var(--bg-hover);
}

.card-section.collapsed .card-section-toggle {
  transform: rotate(-90deg);
}

.card-section-content {
  padding: 18px;
  display: block;
  background: var(--bg-primary);
}

.card-section.collapsed .card-section-content {
  display: none;
}

/* Ê®™‰∏¶„Å≥3„Ç´„É©„É†„É¨„Ç§„Ç¢„Ç¶„ÉàÔºà„Çø„Çπ„ÇØ„Éª„É°„É¢„ÉªË≠∞‰∫ãÈå≤Ôºâ */
.card-sections-row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 12px;
}

.card-sections-row .card-section {
  margin-bottom: 0;
}

/* „Çª„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´ÂÜÖ„ÅÆ„Éê„ÉÉ„Ç∏ */
.section-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px;
  height: 20px;
  padding: 0 6px;
  border-radius: var(--radius-full);
  font-size: 11px;
  font-weight: 600;
  margin-left: 8px;
}

.section-badge.badge-primary {
  background: var(--primary-color);
  color: white;
}

.section-badge.badge-warning {
  background: var(--warning-color);
  color: white;
}

.section-badge.badge-success {
  background: var(--success-color);
  color: white;
}

.section-badge.badge-info {
  background: var(--info-color);
  color: white;
}

.section-badge.badge-muted {
  background: var(--bg-tertiary);
  color: var(--text-muted);
}

@media (max-width: 768px) {
  .card-sections-row {
    grid-template-columns: 1fr;
  }
  .card-quick-actions {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥Ôºà4„Ç´„É©„É†Ê®™‰∏¶„Å≥Ôºâ */
.card-quick-actions {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-bottom: 12px;
}

.quick-action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  font-size: 12px;
  font-weight: 500;
  color: var(--text-primary);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.quick-action-btn:hover {
  background: var(--bg-tertiary);
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.quick-action-btn .section-badge {
  font-size: 10px;
  min-width: 16px;
  height: 16px;
  padding: 0 4px;
}

/* „Ç´„Éº„Éâ„É¢„Éº„ÉÄ„É´ */
.card-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 20px;
}

.card-modal {
  background: var(--bg-primary);
  border-radius: var(--radius-xl);
  width: 100%;
  max-width: 600px;
  max-height: 80vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-2xl);
}

.card-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-light);
  background: var(--bg-secondary);
}

.card-modal-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
}

.card-modal-close {
  background: none;
  border: none;
  font-size: 20px;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: var(--radius-sm);
}

.card-modal-close:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

.card-modal-body {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}

/* „Çø„Çπ„ÇØÊ©üËÉΩ */
.project-task-list {
  margin-top: 12px;
}

.project-task-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  transition: all 0.2s;
}

.project-task-item.completed {
  opacity: 0.5;
  background: #f5f5f5;
}

.project-task-item.completed .project-task-name {
  text-decoration: line-through;
  color: var(--text-muted);
}

.project-task-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
}

.project-task-name {
  flex: 1;
  font-size: 14px;
}

.project-task-due {
  font-size: 12px;
  color: var(--text-muted);
  padding: 2px 8px;
  background: var(--bg-tertiary);
  border-radius: 12px;
}

.project-task-due.overdue {
  background: #ffe5e5;
  color: var(--danger-color);
}

.add-task-form {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.add-task-form input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 13px;
}

/* ÂÖ±Êúâ„É°„É¢Ê¨Ñ */
.shared-memo-area {
  width: 100%;
  min-height: 80px;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 14px;
  resize: vertical;
  font-family: inherit;
}

/* Ë≠∞‰∫ãÈå≤„Çª„ÇØ„Ç∑„Éß„É≥ */
.minutes-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.minutes-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
}

.minutes-item-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.minutes-upload-area {
  border: 2px dashed var(--border-color);
  border-radius: var(--radius-md);
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.minutes-upload-area:hover {
  border-color: var(--primary-color);
  background: #f8fbff;
}

/* ÂºïÁ∂ôÊõ∏„Çª„ÇØ„Ç∑„Éß„É≥ */
.handover-content {
  width: 100%;
  min-height: 120px;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 14px;
  resize: vertical;
  font-family: inherit;
}

/* ÂºïÁ∂ôÊõ∏ ÈÉ®ÁΩ≤Âà•ÂÖ•Âäõ„Éú„ÉÉ„ÇØ„Çπ */
.handover-sections {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.handover-section {
  border: 1px solid var(--border-color);
  border-radius: 8px;
  overflow: hidden;
}

.handover-label {
  display: block;
  padding: 8px 12px;
  background: var(--bg-tertiary);
  font-weight: 600;
  font-size: 13px;
  color: var(--text-primary);
  border-bottom: 1px solid var(--border-color);
}

.handover-textarea {
  width: 100%;
  padding: 10px 12px;
  border: none;
  font-size: 13px;
  font-family: inherit;
  resize: vertical;
  min-height: 60px;
}

.handover-textarea:focus {
  outline: none;
  background: var(--bg-secondary);
}

/* „Çµ„Ç§„Éâ„Éê„ÉºÊãÖÂΩìËÄÖËâ≤ÂàÜ„Åë */
.sidebar-item-count.count-blue {
  background: #e3f2fd;
  color: #1976d2;
}

.sidebar-item-count.count-yellow {
  background: #fff8e1;
  color: #f57c00;
}

.sidebar-item-label.name-red {
  color: #d32f2f;
  font-weight: 700;
}

/* „Çø„Çπ„ÇØ‰∏ÄË¶ß„Éú„Çø„É≥ */
.sidebar-task-btn {
  padding: 4px 8px;
  font-size: 11px;
  background: var(--bg-tertiary);
  border: none;
  border-radius: 12px;
  cursor: pointer;
  margin-left: 8px;
}

.sidebar-task-btn:hover {
  background: var(--primary-color);
  color: white;
}

/* „Çø„Çπ„ÇØ‰∏ÄË¶ß„É¢„Éº„ÉÄ„É´ */
.task-list-modal {
  max-height: 70vh;
  overflow-y: auto;
}

.task-list-group {
  margin-bottom: 24px;
}

.task-list-group-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-color);
}

/* Áî≥Ë´ãGO„Éú„Çø„É≥ÁÑ°ÂäπÂåñ */
.task-item-btn.disabled {
  opacity: 0.4;
  cursor: not-allowed;
  pointer-events: none;
}

.task-item-btn.disabled:hover {
  transform: none;
}

/* kintoneÈÄ£Êê∫Ë°®Á§∫ */
.kintone-info {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.kintone-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: #e8f5e9;
  color: #2e7d32;
  border-radius: 12px;
  font-size: 12px;
}

/* ÈÄöÁü•„Éê„ÉÉ„Ç∏ */
.notification-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--danger-color);
  color: white;
  font-size: 10px;
  font-weight: 700;
  min-width: 18px;
  height: 18px;
  border-radius: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
}


/* ============================================
   „Çπ„Ç±„É´„Éà„É≥„É≠„Éº„Éá„Ç£„É≥„Ç∞
   ============================================ */
.skeleton-line,
.skeleton-circle {
  background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-hover) 50%, var(--bg-tertiary) 75%);
  background-size: 200% 100%;
  animation: skeleton-shimmer 1.5s infinite;
  border-radius: 4px;
}

.skeleton-circle {
  border-radius: 50%;
}

@keyframes skeleton-shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.skeleton-card {
  padding: 20px;
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-color);
}

.animate-pulse {
  animation: pulse-opacity 2s ease-in-out infinite;
}

@keyframes pulse-opacity {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ============================================
   „É¢„Éê„Ç§„É´ËøΩÂä†ÊîπÂñÑ
   ============================================ */
@media (max-width: 768px) {
  /* „Çø„ÉÉ„ÉÅ„Çø„Éº„Ç≤„ÉÉ„ÉàÊúÄÈÅ©Âåñ */
  .btn, button, a.btn {
    min-height: 44px;
    min-width: 44px;
  }

  /* „Éï„Ç©„Éº„É†ÂÖ•ÂäõÊã°Â§ß */
  input, select, textarea {
    font-size: 16px !important; /* iOS zoomÈò≤Ê≠¢ */
  }

  /* „É¢„Éº„ÉÄ„É´ÂÖ®ÁîªÈù¢Âåñ */
  .modal-content {
    width: 100vw;
    height: 100vh;
    max-height: 100vh;
    border-radius: 0;
    margin: 0;
  }

  .modal {
    padding: 0;
  }

  /* „Ç´„Éº„ÉâÂÜÖ„Éú„Çø„É≥ÈÖçÁΩÆ */
  .card-actions {
    flex-direction: column;
    width: 100%;
  }

  .card-actions .btn {
    width: 100%;
    justify-content: center;
  }

  /* „ÉÜ„Éº„Éñ„É´„Çπ„ÇØ„É≠„Éº„É´ */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Ê§úÁ¥¢„Éê„Éº */
  .search-box {
    width: 100%;
  }

  /* „Éú„Éà„É†„Éä„ÉìÁî®„Çπ„Éö„Éº„Çπ */
  .main-content {
    padding-bottom: 80px;
  }

  /* „Çø„Çπ„ÇØ„Ç¢„Ç§„ÉÜ„É†ÊîπÂñÑ */
  .task-item {
    padding: 12px;
    gap: 8px;
  }

  .task-label {
    font-size: 14px;
    flex: 1;
    min-width: 0;
  }

  .task-state-select {
    font-size: 13px;
    min-width: 100px;
  }

  .task-email-btn {
    min-width: 36px;
    min-height: 36px;
  }

  /* Êó•‰ªòÂÖ•ÂäõÊîπÂñÑ */
  .task-due-input {
    min-width: 130px;
  }

  /* ÊúàÂ†±„É¢„Éê„Ç§„É´ÂØæÂøú */
  .report-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .report-header h2 {
    font-size: 1.25rem;
  }

  .report-stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .report-stat-value {
    font-size: 1.5rem;
  }

  .report-designer-section {
    padding: 12px;
  }

  .report-designer-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .report-project-title {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }

  .report-project-title .project-name {
    word-break: break-word;
  }

  .report-status-list {
    gap: 4px;
  }

  .report-status-tag {
    font-size: 0.65rem;
    padding: 2px 6px;
  }

  .report-list-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
}

/* Ë∂ÖÂ∞èÁîªÈù¢ÂØæÂøú */
@media (max-width: 360px) {
  .header {
    padding: 8px 12px;
  }

  .logo {
    font-size: 18px;
  }

  .tab-nav-btn {
    padding: 10px 12px;
    font-size: 13px;
  }

  .project-card {
    padding: 12px;
  }

  .card-title {
    font-size: 16px;
  }
}

/* „Çø„ÉÉ„ÉÅ„Éá„Éê„Ç§„ÇπÂêë„Åë„Éõ„Éê„ÉºÁÑ°ÂäπÂåñ */
@media (hover: none) {
  .btn:hover,
  .project-card:hover,
  .task-item:hover {
    transform: none;
    box-shadow: inherit;
  }
}

/* ============================================
   „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£ - Accessibility
   ============================================ */

/* „Çπ„ÇØ„É™„Éº„É≥„É™„Éº„ÉÄ„ÉºÂ∞ÇÁî® */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* „Çπ„Ç≠„ÉÉ„Éó„É™„É≥„ÇØ */
.skip-link {
  position: fixed;
  top: -100px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--primary-color);
  color: white;
  padding: 12px 24px;
  border-radius: var(--radius-md);
  z-index: 10001;
  font-weight: 600;
  text-decoration: none;
  transition: top 0.3s ease;
}

.skip-link:focus {
  top: 10px;
  outline: 3px solid var(--warning-color);
  outline-offset: 2px;
}

/* „Éï„Ç©„Éº„Ç´„ÇπË°®Á§∫„ÅÆÂº∑Âåñ */
:focus-visible {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
}

button:focus-visible,
a:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
  box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
}

/* È´ò„Ç≥„É≥„Éà„É©„Çπ„Éà„É¢„Éº„ÉâÂØæÂøú */
@media (prefers-contrast: high) {
  :root {
    --text-primary: #000000;
    --text-secondary: #1a1a1a;
    --border-color: #000000;
  }

  .btn {
    border: 2px solid currentColor;
  }
}

/* Âãï„Åç„ÇíÊ∏õ„Çâ„Åô„É¢„Éº„Éâ */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }

  .loading-spinner {
    animation: none;
    border-color: var(--primary-color);
  }
}

/* ============================================
   Âç∞Âà∑„Çπ„Çø„Ç§„É´ - Print Styles
   ============================================ */
@media print {
  /* ÈùûË°®Á§∫Ë¶ÅÁ¥† */
  .header,
  .sidebar,
  .tabs-nav,
  .btn,
  button,
  .modal-overlay,
  .skip-link,
  .status-indicator,
  .toast-container {
    display: none !important;
  }

  /* Âü∫Êú¨„Çπ„Çø„Ç§„É´ */
  body {
    background: var(--bg-primary) !important;
    color: black !important;
    font-size: 12pt;
    line-height: 1.4;
  }

  /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
  .main-container,
  .app-layout,
  .main-content {
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* „Ç´„Éº„Éâ„Éª„Éó„É≠„Ç∏„Çß„ÇØ„Éà */
  .project-card {
    break-inside: avoid;
    page-break-inside: avoid;
    border: 1px solid #ccc !important;
    box-shadow: none !important;
    margin-bottom: 16pt !important;
  }

  /* „Çø„Çπ„ÇØ„É™„Çπ„Éà */
  .task-item {
    border-bottom: 1px solid #eee;
    padding: 8pt 0;
  }

  /* „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏„ÇíÁôΩÈªí„Åß */
  .status-badge {
    border: 1px solid black !important;
    background: var(--bg-primary) !important;
    color: black !important;
  }

  /* „É™„É≥„ÇØ„Å´URL„ÇíË°®Á§∫ */
  a[href^="http"]:after {
    content: " (" attr(href) ")";
    font-size: 10pt;
    color: #666;
  }

  /* „Éö„Éº„Ç∏Ë®≠ÂÆö */
  @page {
    margin: 2cm;
    size: A4;
  }

  /* „Éò„ÉÉ„ÉÄ„Éº„Éª„Éï„ÉÉ„Çø„Éº */
  .print-header {
    display: block !important;
    text-align: center;
    margin-bottom: 20pt;
    font-size: 18pt;
    font-weight: bold;
  }

  .print-footer {
    display: block !important;
    text-align: center;
    margin-top: 20pt;
    font-size: 10pt;
    color: #666;
  }
}
</style>
</head>
<body>

<!-- „Çπ„Ç≠„ÉÉ„Éó„É™„É≥„ÇØÔºà„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£Ôºâ -->
<a href="#mainContent" class="skip-link">„É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Å∏„Çπ„Ç≠„ÉÉ„Éó</a>

<!-- „É©„Ç§„Éñ„É™„Éº„Ç∏„Éß„É≥Ôºà„Çπ„ÇØ„É™„Éº„É≥„É™„Éº„ÉÄ„ÉºÁî®Ôºâ -->
<div id="liveRegion" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
<div id="loginContainer" class="login-container">
  <div class="login-card">
    <h1>ArchiDeck</h1>
    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">G„Éè„Ç¶„Çπ Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</p>
    <p>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
    <form onsubmit="signIn(); return false;" style="margin-bottom: 20px;">
      <input type="email" class="form-input" id="loginEmail" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ" style="width: 100%; margin-bottom: 12px;" inputmode="email">
      <input type="password" class="form-input" id="loginPassword" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" style="width: 100%; margin-bottom: 12px;">
      <div style="text-align: right; margin-bottom: 16px;">
        <a href="#" onclick="showForgotPassword(); return false;" style="font-size: 13px; color: var(--primary-color);">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÊñπ</a>
      </div>
      <button type="submit" class="btn btn-primary" style="width: 100%;">„É≠„Ç∞„Ç§„É≥</button>
    </form>
    <div id="forgotPasswordSection" style="display: none; margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="font-size: 13px; margin-bottom: 12px;">ÁôªÈå≤Ê∏à„Åø„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Éë„Çπ„ÉØ„Éº„ÉâÂÜçË®≠ÂÆöÁî®„ÅÆ„É™„É≥„ÇØ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô„ÄÇ</p>
      <input type="email" class="form-input" id="forgotEmail" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ" style="width: 100%; margin-bottom: 12px;">
      <button class="btn btn-primary" style="width: 100%; margin-bottom: 8px;" onclick="sendPasswordReset()">ÂÜçË®≠ÂÆö„É°„Éº„É´„ÇíÈÄÅ‰ø°</button>
      <button class="btn btn-ghost" style="width: 100%;" onclick="hideForgotPassword()">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
      <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">ÈñãÁô∫‰∏≠„ÅÆ„Åü„ÇÅ„Éë„Çπ„ÉØ„Éº„ÉâÁÑ°„Åó„Åß„É≠„Ç∞„Ç§„É≥ÂèØËÉΩ</p>
      <button class="btn btn-ghost" style="width: 100%;" onclick="enterDemoMode()">„Éë„Çπ„ÉØ„Éº„ÉâÁÑ°„Åó„ÅßÂÖ•„Çã</button>
    </div>
  </div>
</div>

<!-- „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ -->
<div id="mainContainer" class="main-container">
  <!-- „Éò„ÉÉ„ÉÄ„Éº -->
  <header class="header" role="banner" aria-label="„Çµ„Ç§„Éà„Éò„ÉÉ„ÉÄ„Éº">
    <div class="header-left">
      <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
      <div class="logo">ArchiDeck</div>
      <!-- „Éò„ÉÉ„ÉÄ„ÉºÂÜÖ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
      <nav class="header-nav">
        <button class="header-nav-btn active" onclick="switchMainTab('projects', this)">üìã Ê°à‰ª∂ÁÆ°ÁêÜ</button>
        <button class="header-nav-btn" onclick="switchMainTab('calendar', this)">üìÖ „Ç´„É¨„É≥„ÉÄ„Éº</button>
        <button class="header-nav-btn" onclick="switchMainTab('analytics', this)">üìä ÂàÜÊûê</button>
        <button class="header-nav-btn" onclick="switchMainTab('settings', this)">‚öôÔ∏è Ë®≠ÂÆö</button>
      </nav>
    </div>
    <div class="header-right">
      <div class="status-indicator status-saved" id="statusIndicator">
        <span class="status-dot"></span>
        <span id="statusText">‰øùÂ≠òÊ∏à„Åø</span>
      </div>
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="" alt="">
        <span id="userName" class="user-name"></span>
      </div>
      <div style="position: relative;">
        <button class="btn btn-ghost btn-small" onclick="toggleCategorySwitcher()" id="categorySwitchBtn" style="display: none;">
          <span id="currentCategoryLabel">üìê Ë®≠Ë®à</span> ‚ñº
        </button>
        <div id="categorySwitchMenu" class="category-switch-menu" style="display: none;">
          <button onclick="switchCategory('Ë®≠Ë®à')">üìê Ë®≠Ë®àÊãÖÂΩì</button>
          <button onclick="switchCategory('IC')">üé® ICÊãÖÂΩì</button>
          <button onclick="switchCategory('Â§ñÊßã')">üå≥ Â§ñÊßãÊãÖÂΩì</button>
          <button onclick="switchCategory('‰∏çÂãïÁî£')">üè† ‰∏çÂãïÁî£ÊãÖÂΩì</button>
          <button onclick="switchCategory('admin')">üëë ÁÆ°ÁêÜËÄÖ</button>
        </div>
      </div>
      <button class="btn btn-ghost btn-small" onclick="UndoManager.undo()" title="ÂÖÉ„Å´Êàª„Åô (Ctrl+Z)" id="undoBtn" disabled>‚Ü©Ô∏è</button>
      <button class="btn btn-ghost btn-small" onclick="UndoManager.redo()" title="„ÇÑ„ÇäÁõ¥„Åô (Ctrl+Y)" id="redoBtn" disabled>‚Ü™Ô∏è</button>
      <button class="btn btn-ghost btn-small" onclick="forceReloadData()" title="„Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø">üîÑ</button>
      <button class="btn btn-ghost btn-small" onclick="showDebugInfo()" title="„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±">üîç</button>
      <button class="btn btn-ghost btn-small" onclick="signOut()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
    </div>
  </header>

  <!-- „Ç¢„Éó„É™„É¨„Ç§„Ç¢„Ç¶„Éà -->
  <div class="app-layout">
    <!-- „Çµ„Ç§„Éâ„Éê„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§Ôºà„É¢„Éê„Ç§„É´Áî®Ôºâ -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="„Çµ„Ç§„Éâ„Éê„Éº„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥">
      <div id="sidebarContent"></div>
    </aside>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <main class="main-content" id="mainContent" role="main" aria-label="„É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ">
      <!-- Ê°à‰ª∂ÁÆ°ÁêÜ„Çø„Éñ -->
      <div id="projectsTab" class="tab-panel active">
        <div class="toolbar compact-toolbar">
          <div class="toolbar-main">
            <input type="text" class="input" id="searchQuery" placeholder="Ê§úÁ¥¢... (Ctrl+K)" oninput="debouncedRenderProjects()" onfocus="updateSearchSuggestions()" list="searchSuggestions" aria-label="Ê°à‰ª∂„ÇíÊ§úÁ¥¢" autocomplete="off" style="flex:1;max-width:280px;">
            <datalist id="searchSuggestions"></datalist>
            <select class="select select-compact" id="archiveFilter" onchange="renderProjects()">
              <option value="active">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</option>
              <option value="all">„Åô„Åπ„Å¶</option>
              <option value="archived">ÂÆå‰∫ÜÊ∏à</option>
            </select>
            <button class="btn btn-ghost btn-small" onclick="toggleFilterPanel()" id="filterToggleBtn" title="„Éï„Ç£„É´„Çø„ÉºÂ±ïÈñã">üîΩ ÁµûËæº</button>
            <button class="btn btn-ghost btn-small" onclick="resetAllFilters()" title="„É™„Çª„ÉÉ„Éà">üîÑ</button>
            <div class="toolbar-spacer"></div>
            <button class="btn btn-ghost btn-small" onclick="DataImporter.showModal()" title="ÂèñËæº">üì•</button>
            <button class="btn btn-ghost btn-small" onclick="exportCSV()" title="Âá∫Âäõ">üì§</button>
            <button class="btn btn-primary btn-small" onclick="openProjectModal()">+ ËøΩÂä†</button>
          </div>
          <div class="filter-panel" id="filterPanel" style="display:none;">
            <div class="filter-row">
              <select class="select select-compact" id="specFilter" onchange="renderProjects()">
                <option value="">ÂïÜÂìÅ: „Åô„Åπ„Å¶</option>
                <option>LIFE</option>
                <option>LIFE+</option>
                <option>HOURS</option>
                <option>LACIE</option>
                <option>LIFE Limited</option>
                <option>LIFE+ Limited</option>
              </select>
              <select class="select select-compact" id="icProgressFilter" onchange="renderProjects()">
                <option value="">ICÈÄ≤Êçó: „Åô„Åπ„Å¶</option>
                <option value="not_started">ICÊú™ÁùÄÊâã</option>
                <option value="in_progress">ICÈÄ≤Ë°å‰∏≠</option>
                <option value="completed">ICÂÆå‰∫Ü</option>
                <option value="no_ic">ICÊãÖÂΩì„Å™„Åó</option>
              </select>
              <select class="select select-compact" id="icAssigneeFilter" onchange="renderProjects()">
                <option value="">ICÊãÖÂΩì: „Åô„Åπ„Å¶</option>
              </select>
              <select class="select select-compact" id="exteriorAssigneeFilter" onchange="renderProjects()">
                <option value="">Â§ñÊßã: „Åô„Åπ„Å¶</option>
              </select>
              <select class="select select-compact" id="realestateAssigneeFilter" onchange="renderProjects()">
                <option value="">‰∏çÂãïÁî£: „Åô„Åπ„Å¶</option>
              </select>
              <select class="select select-compact" id="sortOrder" onchange="renderProjects()">
                <option value="custom">„Ç´„Çπ„Çø„É†È†Ü</option>
                <option value="updated_desc">Êõ¥Êñ∞Êó•‚Üì</option>
                <option value="updated_asc">Êõ¥Êñ∞Êó•‚Üë</option>
                <option value="progress_desc">ÈÄ≤Êçó‚Üì</option>
                <option value="progress_asc">ÈÄ≤Êçó‚Üë</option>
                <option value="customer_asc">È°ßÂÆ¢ÂêçA-Z</option>
                <option value="created_desc">‰ΩúÊàêÊó•‚Üì</option>
              </select>
              <div style="position: relative;">
                <button class="btn btn-ghost btn-small" onclick="FilterPresets.toggleMenu()" title="„Éó„É™„Çª„ÉÉ„Éà">üìã</button>
                <div id="presetMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 280px; z-index: 100;">
                  <div style="padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600; font-size: 14px;">„Éï„Ç£„É´„Çø„Éº„Éó„É™„Çª„ÉÉ„Éà</span>
                    <button class="btn btn-primary btn-small" onclick="FilterPresets.showSaveModal(); document.getElementById('presetMenu').style.display='none';">+ ‰øùÂ≠ò</button>
                  </div>
                  <div id="presetDropdown" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
              </div>
              <button class="btn btn-ghost btn-small" onclick="BatchOperations.selectAll()" title="ÂÖ®ÈÅ∏Êäû">‚òë</button>
            </div>
          </div>
        </div>
    <!-- Áµ±Ë®à„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
    <div id="statsDashboard" class="stats-dashboard" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-content">
            <div class="stat-value" id="statTotalProjects">0</div>
            <div class="stat-label">„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊ°à‰ª∂</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìê</div>
          <div class="stat-content">
            <div class="stat-value" id="statDesignProgress">0%</div>
            <div class="stat-label">Âπ≥ÂùáË®≠Ë®àÈÄ≤Êçó</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üé®</div>
          <div class="stat-content">
            <div class="stat-value" id="statICProgress">0%</div>
            <div class="stat-label">Âπ≥ÂùáICÈÄ≤Êçó</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-content">
            <div class="stat-value" id="statCompletedThisMonth">0</div>
            <div class="stat-label">‰ªäÊúàÂÆå‰∫Ü</div>
          </div>
        </div>
        <div class="stat-card stat-warning" id="statOverdueCard" style="display: none;">
          <div class="stat-icon">‚ö†Ô∏è</div>
          <div class="stat-content">
            <div class="stat-value" id="statOverdue">0</div>
            <div class="stat-label">ÊúüÈôêË∂ÖÈÅé</div>
          </div>
        </div>
      </div>
      <button class="stats-toggle-btn" onclick="toggleStatsDashboard()">Áµ±Ë®à„ÇíÈùûË°®Á§∫</button>
    </div>
    <div class="cards-container">
      <div class="cards-grid" id="projectsGrid"></div>
      <div class="empty-state" id="emptyProjects" style="display: none;">
        <div class="empty-icon">üìã</div>
        <div class="empty-title">Ê°à‰ª∂„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        <div class="empty-description">„ÄåÊ°à‰ª∂ËøΩÂä†„Äç„Éú„Çø„É≥„Åã„ÇâÊñ∞„Åó„ÅÑÊ°à‰ª∂„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        <button class="btn btn-primary" onclick="openProjectModal()">+ Ê°à‰ª∂ËøΩÂä†</button>
      </div>
    </div>
  </div>

      <!-- „Ç´„É¨„É≥„ÉÄ„Éº„Çø„Éñ -->
      <div id="calendarTab" class="tab-panel">
        <div class="calendar-container">
          <div class="calendar-header">
            <button class="btn btn-ghost" onclick="navigateCalendar(-1)">‚óÄ ÂâçÊúà</button>
            <h2 id="calendarTitle" class="calendar-title"></h2>
            <button class="btn btn-ghost" onclick="navigateCalendar(1)">Ê¨°Êúà ‚ñ∂</button>
          </div>
          <div class="calendar-legend">
            <span class="legend-item"><span class="legend-dot legend-design"></span>Ë®≠Ë®à</span>
            <span class="legend-item"><span class="legend-dot legend-ic"></span>IC</span>
            <span class="legend-item"><span class="legend-dot legend-exterior"></span>Â§ñÊßã</span>
            <span class="legend-item"><span class="legend-dot legend-construction"></span>Â∑•‰∫ã</span>
            <span class="legend-item"><span class="legend-dot legend-task"></span>„Çø„Çπ„ÇØ</span>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
      </div>

      <!-- ÂàÜÊûê„Çø„Éñ -->
      <div id="analyticsTab" class="tab-panel">
        <div class="analytics-container">
          <!-- Ëá™Âãï„É¨„Éù„Éº„ÉàÁîüÊàê -->
          <div class="analytics-section">
            <h3 class="section-title">üìù Ëá™Âãï„É¨„Éù„Éº„ÉàÁîüÊàê</h3>
            <div class="report-buttons">
              <button class="btn btn-primary" onclick="generateWeeklyReport()">üìä ÈÄ±Â†±„ÇíÁîüÊàê</button>
              <button class="btn btn-ghost" onclick="generateMonthlyReport()">üìà ÊúàÂ†±„ÇíÁîüÊàê</button>
              <button class="btn btn-ghost" onclick="exportAnalyticsCSV()">üìÅ CSVÂá∫Âäõ</button>
            </div>
            <div id="reportPreview" class="report-preview" style="display: none;"></div>
          </div>
        </div>
      </div>

      <!-- Ë®≠ÂÆö„Çø„Éñ -->
      <div id="settingsTab" class="tab-panel">
        <!-- „Çµ„Éñ„Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <nav class="sub-tabs-nav">
          <button class="sub-tab-btn active" onclick="switchSubTab('staff', this)">üë• „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('vendors', this)">üè¢ Ê•≠ËÄÖ„Éª„É°„Éº„É´ÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('categories', this)">üè∑Ô∏è „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('tasks', this)">üìê Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('icTasks', this)">üé® ICÊ•≠ÂãôÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('exteriorTasks', this)">üå≥ Â§ñÊßãÊ•≠ÂãôÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('realestateTasks', this)">üè¢ ‰∏çÂãïÁî£Ê•≠ÂãôÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('constructionTasks', this)">üî® Â∑•‰∫ãÊ•≠ÂãôÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('products', this)">üì¶ ÂïÜÂìÅÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('customize', this)">üé® „Ç´„Çπ„Çø„Éû„Ç§„Ç∫</button>
          <button class="sub-tab-btn" onclick="switchSubTab('kintone', this)">üîó kintoneÈÄ£Êê∫</button>
          <button class="sub-tab-btn" onclick="switchSubTab('backup', this)">üíæ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</button>
          <button class="sub-tab-btn" onclick="switchSubTab('fcManagement', this)">üè™ FCÁÆ°ÁêÜ</button>
        </nav>

        <!-- „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ -->
        <div id="staffPanel" class="sub-tab-panel active">
          <div style="max-width: 1000px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">„Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ</h2>
            <div class="form-group">
              <label class="form-label">Êñ∞„Åó„ÅÑ„Çπ„Çø„ÉÉ„Éï„ÇíËøΩÂä†</label>
              <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px;">
                <input type="text" class="form-input" id="newDesignerNameInline" placeholder="„Çπ„Çø„ÉÉ„ÉïÂêç">
                <select class="form-select" id="newDesignerCategoryInline" style="width: 150px;">
                  <option value="Ë®≠Ë®à">Ë®≠Ë®àÊãÖÂΩì</option>
                  <option value="IC">ICÊãÖÂΩì</option>
                  <option value="Â§ñÊßã">Â§ñÊßãÊãÖÂΩì</option>
                  <option value="‰∏çÂãïÁî£">‰∏çÂãïÁî£ÊãÖÂΩì</option>
                  <option value="Â∑•‰∫ã">Â∑•‰∫ãÊãÖÂΩì</option>
                </select>
                <button class="btn btn-primary" onclick="addDesignerInline()">ËøΩÂä†</button>
              </div>
            </div>
            <div id="designerListInline" style="margin-top: 24px;"></div>
          </div>
        </div>

        <!-- Ê•≠ËÄÖÁÆ°ÁêÜ -->
        <div id="vendorsPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <div id="categoryFilters"></div>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openVendorModalV2()">+ Ê•≠ËÄÖËøΩÂä†</button>
            </div>
          </div>
          <div id="vendorsGrid" class="cards-grid"></div>
        </div>

        <!-- „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ -->
        <div id="categoriesPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">Ê•≠ËÄÖ„Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">Ê•≠ËÄÖ„ÇíÂàÜÈ°û„Åô„Çã„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†„ÉªÁ∑®ÈõÜ„ÉªÂâäÈô§„Åß„Åç„Åæ„Åô„ÄÇ</p>
            <div class="form-group">
              <label class="form-label">Êñ∞„Åó„ÅÑ„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†</label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="newCategoryNameInline" placeholder="„Ç´„ÉÜ„Ç¥„É™ÂêçÔºà‰æãÔºöÈõªÊ∞óÂ∑•‰∫ãÔºâ" style="flex: 1;">
                <button class="btn btn-primary" onclick="addCategoryInline()">ËøΩÂä†</button>
              </div>
            </div>
            <div id="categoriesGrid" style="margin-top: 32px;"></div>
          </div>
        </div>

        <!-- Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ -->
        <div id="tasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">üìê Ë®≠Ë®à„Çø„Çπ„ÇØÁÆ°ÁêÜ</h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openTaskModal('Ë®≠Ë®à')">+ Ë®≠Ë®à„Çø„Çπ„ÇØËøΩÂä†</button>
            </div>
          </div>
          <p style="margin-bottom: 16px; color: var(--text-secondary);">Ë®≠Ë®àÊãÖÂΩìËÄÖ„Åå‰ΩøÁî®„Åô„Çã„Çø„Çπ„ÇØ„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
          <div id="tasksGrid"></div>
        </div>

        <!-- ICÊ•≠ÂãôÁÆ°ÁêÜ -->
        <div id="icTasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">üé® IC„Çø„Çπ„ÇØÁÆ°ÁêÜ</h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-warning" onclick="runICTasksMigration()" title="21È†ÖÁõÆ„ÅÆIC„Çø„Çπ„ÇØ„Å´Êõ¥Êñ∞">üîÑ 21È†ÖÁõÆ„Å´Êõ¥Êñ∞</button>
              <button class="btn btn-primary" onclick="openTaskModal('IC')">+ IC„Çø„Çπ„ÇØËøΩÂä†</button>
            </div>
          </div>
          <p style="margin-bottom: 16px; color: var(--text-secondary);">ICÊãÖÂΩìËÄÖ„Åå‰ΩøÁî®„Åô„Çã„Çø„Çπ„ÇØ„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
          <div id="icMigrationNotice" style="display: none; margin-bottom: 16px; padding: 12px; background: var(--warning-light); border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
            <p style="margin: 0; font-size: 13px; color: var(--warning-color);">
              ‚ö†Ô∏è <strong>IC„Çø„Çπ„ÇØ„ÅåÂè§„ÅÑÂΩ¢Âºè„Åß„Åô</strong>: „Äå21È†ÖÁõÆ„Å´Êõ¥Êñ∞„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÄÅÊñ∞„Åó„ÅÑ21È†ÖÁõÆ„ÅÆIC„Çø„Çπ„ÇØ„Å´Êõ¥Êñ∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            </p>
          </div>
          <div style="margin-bottom: 16px; padding: 12px; background: var(--primary-light); border-radius: var(--radius-md); border-left: 4px solid var(--primary-color);">
            <p style="margin: 0; font-size: 13px; color: var(--primary-color);">
              üí° <strong>„É°„Éº„É´ÈÄÅ‰ø°Ê©üËÉΩ„ÅÆË®≠ÂÆö</strong>: „Ç≠„ÉÉ„ÉÅ„É≥„Éª„ÅäÈ¢®ÂëÇ„ÉªÊ¥óÈù¢„Éª„Éà„Ç§„É¨„ÉªÁÖßÊòé„Éó„É©„É≥„ÅÆ„É°„Éº„Ç´„ÉºÈÅ∏Êäû„Å´ÂØæÂøú„Åó„Åü„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åô„Çã„Å´„ÅØ„ÄÅ„Äåüè¢ Ê•≠ËÄÖ„Éª„É°„Éº„É´ÁÆ°ÁêÜ„Äç„Çø„Éñ„ÅßÂêÑ„É°„Éº„Ç´„Éº„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            </p>
          </div>
          <div id="icTasksGrid"></div>
        </div>

        <!-- Â§ñÊßãÊ•≠ÂãôÁÆ°ÁêÜ -->
        <div id="exteriorTasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">üå≥ Â§ñÊßãÊ•≠Âãô„Çø„Çπ„ÇØÁÆ°ÁêÜ</h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openExteriorTaskModal()">+ Â§ñÊßã„Çø„Çπ„ÇØËøΩÂä†</button>
            </div>
          </div>
          <p style="margin-bottom: 24px; color: var(--text-secondary);">Â§ñÊßãË®≠Ë®à„ÅÆÊ•≠Âãô„Éï„É≠„Éº„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
          <div id="exteriorTasksGrid"></div>
        </div>

        <!-- ‰∏çÂãïÁî£Ê•≠ÂãôÁÆ°ÁêÜ -->
        <div id="realestateTasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">üè¢ ‰∏çÂãïÁî£Ê•≠Âãô„Çø„Çπ„ÇØÁÆ°ÁêÜ</h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openRealestateTaskModal()">+ ‰∏çÂãïÁî£„Çø„Çπ„ÇØËøΩÂä†</button>
            </div>
          </div>
          <p style="margin-bottom: 24px; color: var(--text-secondary);">‰∏çÂãïÁî£Èñ¢ÈÄ£„ÅÆÊ•≠Âãô„Éï„É≠„Éº„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
          <div id="realestateTasksGrid"></div>
        </div>

        <!-- Â∑•‰∫ãÊ•≠ÂãôÁÆ°ÁêÜ -->
        <div id="constructionTasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">üî® Â∑•‰∫ãÊ•≠Âãô„Çø„Çπ„ÇØÁÆ°ÁêÜ</h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openConstructionTaskModal()">+ Â∑•‰∫ã„Çø„Çπ„ÇØËøΩÂä†</button>
            </div>
          </div>
          <p style="margin-bottom: 24px; color: var(--text-secondary);">Â∑•‰∫ãÈñ¢ÈÄ£„ÅÆÊ•≠Âãô„Éï„É≠„Éº„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
          <div id="constructionTasksGrid"></div>
        </div>

        <!-- ÂïÜÂìÅÁÆ°ÁêÜ -->
        <div id="productsPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">ÂïÜÂìÅ„Éû„Çπ„ÇøÁÆ°ÁêÜ</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">Ê°à‰ª∂„ÅßÈÅ∏Êäû„Åß„Åç„ÇãÂïÜÂìÅ„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
            <div class="form-group">
              <label class="form-label">Êñ∞„Åó„ÅÑÂïÜÂìÅ„ÇíËøΩÂä†</label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="newProductNameInline" placeholder="ÂïÜÂìÅÂêçÔºà‰æãÔºöLIFE„ÄÅLIFE+„ÄÅHOURSÔºâ" style="flex: 1;">
                <button class="btn btn-primary" onclick="addProductInline()">ËøΩÂä†</button>
              </div>
            </div>
            <div id="productsGrid" style="margin-top: 32px;"></div>
          </div>
        </div>

        <!-- „Ç´„Çπ„Çø„Éû„Ç§„Ç∫ -->
        <div id="customizePanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">Â§ñË¶≥„Ç´„Çπ„Çø„Éû„Ç§„Ç∫</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">‰ºöÁ§æ„ÅÆ„Éñ„É©„É≥„Éâ„Å´Âêà„Çè„Åõ„Å¶„Ç∑„Çπ„ÉÜ„É†„ÅÆÂ§ñË¶≥„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åß„Åç„Åæ„Åô„ÄÇ„Ç≥„Éº„Éá„Ç£„É≥„Ç∞‰∏çË¶Å„ÅßÁ∞°Âçò„Å´Â§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ</p>

            <div style="display: grid; grid-template-columns: 1fr 300px; gap: 32px;">
              <div>
                <div class="form-group">
                  <label class="form-label">‰ºöÁ§æÂêç</label>
                  <input type="text" class="form-input" id="customOrgName" placeholder="‰æãÔºöÊ†™Âºè‰ºöÁ§æ„Çµ„É≥„Éó„É´Â∑•ÂãôÂ∫ó" style="width: 100%;">
                  <div class="form-hint">„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Çø„Ç§„Éà„É´„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>
                </div>

                <div class="form-group">
                  <label class="form-label">„É≠„Ç¥URL</label>
                  <input type="text" class="form-input" id="customLogoUrl" placeholder="https://example.com/logo.png" style="width: 100%;">
                  <div class="form-hint">Êé®Â•®„Çµ„Ç§„Ç∫: 150x40pxÔºàPNG/SVGÂΩ¢ÂºèÔºâ</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div class="form-group">
                    <label class="form-label">„É°„Ç§„É≥„Ç´„É©„Éº</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input type="color" id="customPrimaryColor" value="#2563EB" style="width: 50px; height: 40px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); cursor: pointer;">
                      <input type="text" class="form-input" id="customPrimaryColorText" value="#2563EB" style="flex: 1;" oninput="document.getElementById('customPrimaryColor').value = this.value">
                    </div>
                    <div class="form-hint">„Éú„Çø„É≥„ÇÑ„É™„É≥„ÇØ„ÅÆËâ≤</div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">„Ç¢„ÇØ„Çª„É≥„Éà„Ç´„É©„Éº</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input type="color" id="customSecondaryColor" value="#059669" style="width: 50px; height: 40px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); cursor: pointer;">
                      <input type="text" class="form-input" id="customSecondaryColorText" value="#059669" style="flex: 1;" oninput="document.getElementById('customSecondaryColor').value = this.value">
                    </div>
                    <div class="form-hint">ÊàêÂäüÁä∂ÊÖã„ÇÑ„Çµ„Éñ„Éú„Çø„É≥„ÅÆËâ≤</div>
                  </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                  <button class="btn btn-primary" onclick="saveCustomization()">„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Çí‰øùÂ≠ò</button>
                  <button class="btn btn-ghost" onclick="previewCustomization()">„Éó„É¨„Éì„É•„Éº</button>
                  <button class="btn btn-ghost" onclick="resetCustomization()">„É™„Çª„ÉÉ„Éà</button>
                </div>

                <div id="customizeStatus" style="margin-top: 16px;"></div>
              </div>

              <div style="padding: 20px; background: var(--bg-secondary); border-radius: var(--radius-lg); height: fit-content;">
                <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">„Éó„É¨„Éì„É•„Éº</h3>
                <div id="customizePreview" style="padding: 16px; background: var(--bg-primary); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <div id="previewLogo" style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">üè†</div>
                    <span id="previewTitle" style="font-weight: 600; font-size: 14px;">ArchiDeck</span>
                  </div>
                  <button class="btn btn-primary btn-small" style="margin-right: 8px;">„É°„Ç§„É≥„Éú„Çø„É≥</button>
                  <button class="btn btn-secondary btn-small">„Çµ„Éñ„Éú„Çø„É≥</button>
                </div>
              </div>
            </div>

            <div style="margin-top: 32px; padding: 16px; background: var(--primary-light); border-radius: var(--radius-md); border-left: 4px solid var(--primary-color);">
              <h4 style="font-size: 14px; font-weight: 600; color: var(--primary-color); margin-bottom: 8px;">„Éí„É≥„Éà</h4>
              <ul style="font-size: 13px; color: var(--text-secondary); margin: 0; padding-left: 20px;">
                <li>„É≠„Ç¥„ÅØURL„ÇíÂÖ•Âäõ„Åô„Çã„Åã„ÄÅÁîªÂÉè„Çí„Éõ„Çπ„ÉÜ„Ç£„É≥„Ç∞„Çµ„Éº„Éì„Çπ„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                <li>„Ç´„É©„Éº„ÅØ‰ºöÁ§æ„ÅÆ„Éñ„É©„É≥„Éâ„Ç´„É©„Éº„Å´Âêà„Çè„Åõ„Çã„Åì„Å®„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô</li>
                <li>Â§âÊõ¥„ÅØ„Äå„Éó„É¨„Éì„É•„Éº„Äç„ÅßÁ¢∫Ë™ç„Åó„Å¶„Åã„Çâ‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- kintoneÈÄ£Êê∫ -->
        <div id="kintonePanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">kintoneÈÄ£Êê∫Ë®≠ÂÆö</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">kintone„Å®ÈÄ£Êê∫„Åó„Å¶„ÄÅÈÇ∏Âêç„ÉªÈñìÂèñÁ¢∫ÂÆöÊó•„ÉªÁùÄÂ∑•Ë®±ÂèØ„ÉªÂ§âÊõ¥Â•ëÁ¥ÑÂâç‰ºöË≠∞„ÅÆÊÉÖÂ†±„ÇíÂêåÊúü„Åó„Åæ„Åô„ÄÇ</p>

            <div class="form-group">
              <label class="form-label">kintone „Éâ„É°„Ç§„É≥</label>
              <input type="text" class="form-input" id="kintoneDomain" placeholder="‰æãÔºöyour-company.cybozu.com" style="width: 100%;">
            </div>

            <div class="form-group">
              <label class="form-label">„Ç¢„Éó„É™ID</label>
              <input type="text" class="form-input" id="kintoneAppId" placeholder="‰æãÔºö123" style="width: 100%;">
            </div>

            <div class="form-group">
              <label class="form-label">API„Éà„Éº„ÇØ„É≥</label>
              <input type="password" class="form-input" id="kintoneApiToken" placeholder="API„Éà„Éº„ÇØ„É≥„ÇíÂÖ•Âäõ" style="width: 100%;">
              <div class="form-hint" style="font-size: 11px; margin-top: 4px;">kintone„Ç¢„Éó„É™„ÅÆË®≠ÂÆö„Åã„ÇâAPI„Éà„Éº„ÇØ„É≥„ÇíÁô∫Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            </div>

            <div style="margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
              <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">„Éï„Ç£„Éº„É´„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞ÔºàÂü∫Êú¨ÊÉÖÂ†±Ôºâ</h3>
              <div class="form-hint" style="font-size: 11px; margin-bottom: 12px;">kintone„ÅÆ„Éï„Ç£„Éº„É´„Éâ„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">‚ë†ÈÇ∏ÂêçÔºà„ÅäÂÆ¢ÊßòÂêçÔºâ</label>
                  <input type="text" class="form-input" id="kintoneFieldCustomer" placeholder="ÊñáÂ≠ó_Âü∫Êú¨ÊÉÖÂ†±_„ÅäÂÆ¢ÊßòÂêç_„É°„Ç§„É≥" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">‚ë•„Éó„É©„É≥Á¢∫ÂÆöÊó•</label>
                  <input type="text" class="form-input" id="kintoneFieldLayout" placeholder="Êó•‰ªò_Ë®≠Ë®à_„Éó„É©„É≥Á¢∫ÂÆö_‰∫àÂÆöÊâãÂÖ•Âäõ" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">‚ëßÁùÄÂ∑•Ë®±ÂèØÊó•</label>
                  <input type="text" class="form-input" id="kintoneFieldPermit" placeholder="Êó•‰ªò_Ë®≠Ë®à_ÁùÄÂ∑•Ë®±ÂèØ_‰∫àÂÆöÊâãÂÖ•Âäõ" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">‚ë¶Â§âÊõ¥Â•ëÁ¥ÑÂâç‰ºöË≠∞Êó•</label>
                  <input type="text" class="form-input" id="kintoneFieldMeeting" placeholder="Êó•‰ªò_IC_Â§âÊõ¥Â•ëÁ¥ÑÂâç‰ºöË≠∞_‰∫àÂÆöÊâãÂÖ•Âäõ" style="width: 100%;">
                </div>
              </div>
            </div>

            <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
              <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">„Éï„Ç£„Éº„É´„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞ÔºàÊãÖÂΩìËÄÖÔºâ</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">‚ë°Âñ∂Ê•≠ÊãÖÂΩì</label>
                  <input type="text" class="form-input" id="kintoneFieldSales" placeholder="„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû_Âü∫Êú¨ÊÉÖÂ†±_Âñ∂Ê•≠" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">‚ë¢Ë®≠Ë®àÊãÖÂΩì</label>
                  <input type="text" class="form-input" id="kintoneFieldDesign" placeholder="„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû_Âü∫Êú¨ÊÉÖÂ†±_Ë®≠Ë®à" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">‚ë£ICÊãÖÂΩì</label>
                  <input type="text" class="form-input" id="kintoneFieldIC" placeholder="„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû_Âü∫Êú¨ÊÉÖÂ†±_IC" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">‚ë§Â∑•‰∫ãÊãÖÂΩì</label>
                  <input type="text" class="form-input" id="kintoneFieldConstruction" placeholder="„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû_Âü∫Êú¨ÊÉÖÂ†±_Â∑•‰∫ã" style="width: 100%;">
                </div>
              </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button class="btn btn-primary" onclick="saveKintoneSettings()">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
              <button class="btn btn-ghost" onclick="testKintoneConnection()">Êé•Á∂ö„ÉÜ„Çπ„Éà</button>
            </div>

            <div id="kintoneStatus" style="margin-top: 16px;"></div>

            <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border-color);">
              <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">„Éá„Éº„ÇøÈÄ£Êê∫</h3>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="importFromKintoneDirect()">üì• kintone„Åã„ÇâÁõ¥Êé•„Ç§„É≥„Éù„Éº„Éà</button>
                <button class="btn btn-ghost" onclick="importFromKintone()">üì• CSV„Ç§„É≥„Éù„Éº„Éà</button>
                <button class="btn btn-ghost" onclick="exportToKintone()">üì§ CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
              </div>
              <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">
                kintone„Åã„ÇâÁõ¥Êé•„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶„Ç§„É≥„Éù„Éº„Éà„Åß„Åç„Åæ„Åô„ÄÇ
              </p>
              <div id="kintoneImportStatus" style="margin-top: 12px;"></div>
            </div>
          </div>
        </div>

        <!-- „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó -->
        <div id="backupPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">„Éá„Éº„Çø„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">„Ç∑„Çπ„ÉÜ„É†ÂÖ®‰Ωì„ÅÆ„Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÉªÂæ©ÂÖÉ„Åß„Åç„Åæ„Åô„ÄÇËá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇÇÂà©Áî®ÂèØËÉΩ„Åß„Åô„ÄÇ</p>

            <!-- Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóË®≠ÂÆö -->
            <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #e0f2fe, #dbeafe); border-radius: var(--radius-md);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <div>
                  <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 4px;">üîÑ Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</h3>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">„Éá„Éº„ÇøÂ§âÊõ¥ÊôÇ„Å´Ëá™Âãï„Åß„É≠„Éº„Ç´„É´„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰øùÂ≠ò„Åó„Åæ„Åô</p>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px;">
                <div>ÊúÄÁµÇ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó: <strong id="lastBackupTime">-</strong></div>
                <div>„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ª∂Êï∞: <strong id="localBackupCount">0</strong>‰ª∂</div>
                <button class="btn btn-secondary btn-small" onclick="downloadLocalBackup()">„É≠„Éº„Ç´„É´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
              <div style="padding: 24px; background: var(--bg-secondary); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">ÂÖ®„Éá„Éº„Çø„ÇíJSON„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô</p>
                <button class="btn btn-primary" onclick="createBackup()">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê</button>
              </div>

              <div style="padding: 24px; background: var(--bg-secondary); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">üì•</div>
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂæ©ÂÖÉ</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">JSON„Éï„Ç°„Ç§„É´„Åã„Çâ„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô</p>
                <button class="btn btn-ghost" onclick="restoreBackup()">Âæ©ÂÖÉ„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</button>
              </div>
            </div>

            <div style="margin-top: 32px; padding: 16px; background: rgba(245, 166, 35, 0.1); border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
              <h4 style="font-size: 14px; font-weight: 600; color: var(--warning-color); margin-bottom: 8px;">‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ†Ö</h4>
              <ul style="font-size: 13px; color: var(--text-secondary); margin: 0; padding-left: 20px;">
                <li>Âæ©ÂÖÉ„ÇíË°å„ÅÜ„Å®Êó¢Â≠ò„Éá„Éº„Çø„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô</li>
                <li>Âæ©ÂÖÉÂâç„Å´ÂøÖ„ÅöÁèæÂú®„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                <li>„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„ÅØÂÆâÂÖ®„Å™Â†¥ÊâÄ„Å´‰øùÁÆ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                <li>Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅØ„Éñ„É©„Ç¶„Ç∂„ÅÆ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„ÅôÔºàÊúÄÂ§ß5MBÔºâ</li>
              </ul>
            </div>

            <div id="backupStatus" style="margin-top: 24px;"></div>
          </div>
        </div>

        <!-- FCÁÆ°ÁêÜ -->
        <div id="fcManagementPanel" class="sub-tab-panel">
          <div style="max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <div>
                <h2 style="margin: 0; font-size: 24px; font-weight: 700;">üè™ FCÔºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫ÔºâÁÆ°ÁêÜ</h2>
                <p style="margin: 8px 0 0; color: var(--text-secondary);">FCÂÖà„Å´„Éõ„ÉØ„Ç§„Éà„É©„Éô„É´Áâà„ÇíÁô∫Ë°å„ÉªÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô„ÄÇ</p>
              </div>
              <button class="btn btn-primary" onclick="openFcModal()">+ FCËøΩÂä†</button>
            </div>

            <div class="card" style="margin-bottom: 24px; padding: 20px;">
              <h3 style="margin: 0 0 12px; font-size: 16px;">FCÂ∞ÇÁî®URL„Å´„Å§„ÅÑ„Å¶</h3>
              <p style="margin: 0; color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
                FCÂÖà„Å´„ÅØÂ∞ÇÁî®„ÅÆURL„ÅåÁô∫Ë°å„Åï„Çå„Åæ„Åô„ÄÇ<br>
                ‰æã: <code style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px;">https://nandemo-nu.vercel.app/fc/tokyo-fc/</code><br>
                FCÂ∞ÇÁî®URL„Åß„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Å®„ÄÅG„Éè„Ç¶„Çπ„ÅÆ„Éñ„É©„É≥„Éá„Ç£„É≥„Ç∞„ÅåÈùûË°®Á§∫„Å´„Å™„Çä„ÄÅË®≠ÂÆö„Åó„Åü„Ç´„Çπ„Çø„É†„É≠„Ç¥„Éª„Ç´„É©„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ
              </p>
            </div>

            <div id="fcListContainer">
              <div class="empty-state">
                <div class="empty-icon">üè™</div>
                <p>FC„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì<br><small>„Äå+ FCËøΩÂä†„Äç„Éú„Çø„É≥„Åã„ÇâÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´ÔºöÊ°à‰ª∂ËøΩÂä†/Á∑®ÈõÜ -->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="projectModalTitle">Ê°à‰ª∂ËøΩÂä†</h2>
      <button class="close" onclick="closeProjectModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">„ÅäÂÆ¢ÊßòÂêç *</label>
        <input type="text" class="form-input" id="projectCustomer" placeholder="‰æãÔºöÁî∞‰∏≠Â§™ÈÉéÊßò">
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
        <div class="form-group">
          <label class="form-label">ÊãÖÂΩìÔºàË®≠Ë®àÔºâ *</label>
          <select class="form-select" id="projectAssignedTo"></select>
        </div>
        <div class="form-group">
          <label class="form-label">ÊãÖÂΩìÔºàICÔºâ</label>
          <select class="form-select" id="projectIcAssignee">
            <option value="">Êú™ÂÆö</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ÊãÖÂΩìÔºàÂ§ñÊßãÔºâ</label>
          <select class="form-select" id="projectExteriorAssignee">
            <option value="">Êú™ÂÆö</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ÊãÖÂΩìÔºà‰∏çÂãïÁî£Ôºâ</label>
          <select class="form-select" id="projectRealestateAssignee">
            <option value="">Êú™ÂÆö</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ÊãÖÂΩìÔºàÂ∑•‰∫ãÔºâ</label>
          <select class="form-select" id="projectConstructionAssignee">
            <option value="">Êú™ÂÆö</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ÊãÖÂΩìÔºàÂñ∂Ê•≠Ôºâ</label>
          <select class="form-select" id="projectSalesAssignee">
            <option value="">Êú™ÂÆö</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ÂïÜÂìÅ</label>
        <select class="form-select" id="projectSpecifications"></select>
      </div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: space-between;">
      <div id="templateButtons" style="display: none;">
        <button class="btn btn-ghost btn-small" onclick="TemplateManager.createFromProject(editingProjectId)" title="ÁèæÂú®„ÅÆË®≠ÂÆö„Çí„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å®„Åó„Å¶‰øùÂ≠ò">üìã „ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò</button>
        <button class="btn btn-ghost btn-small" onclick="TemplateManager.showSelectModal(editingProjectId)" title="‰øùÂ≠òÊ∏à„Åø„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ©Áî®">üìã „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ©Áî®</button>
      </div>
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-ghost" onclick="closeProjectModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn btn-primary" onclick="saveProject()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´Ôºö„É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„ÉàËøΩÂä†/Á∑®ÈõÜ -->
<div id="templateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="templateModalTitle">„ÉÜ„É≥„Éó„É¨„Éº„ÉàËøΩÂä†</h2>
      <button class="close" onclick="closeTemplateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">„ÉÜ„É≥„Éó„É¨„Éº„ÉàID *</label>
        <input type="text" class="form-input" id="templateId" placeholder="‰æãÔºönew-template">
        <div class="form-hint">Ëã±Êï∞Â≠ó„Å®„Éè„Ç§„Éï„É≥„ÅÆ„Åø‰ΩøÁî®ÂèØËÉΩ</div>
      </div>
      <div class="form-group">
        <label class="form-label">Ë°®Á§∫Âêç *</label>
        <input type="text" class="form-input" id="templateDisplayName" placeholder="‰æãÔºöÊñ∞‰ºöÁ§æÂêçÔºà‰ΩúÊ•≠ÂÜÖÂÆπÔºâ">
      </div>
      <div class="form-group">
        <label class="form-label">„Ç´„ÉÜ„Ç¥„É™ *</label>
        <select class="form-select" id="templateCategory">
          <option value="Ë®≠Ë®à">Ë®≠Ë®à</option>
          <option value="IC">IC</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">‰ºöÁ§æÂêç *</label>
        <input type="text" class="form-input" id="templateCompany" placeholder="‰æãÔºöÊ†™Âºè‰ºöÁ§æ„Äá„Äá">
      </div>
      <div class="form-group">
        <label class="form-label">ÂÆõÂÖàÂêç</label>
        <input type="text" class="form-input" id="templateContact" placeholder="‰æãÔºöÁî∞‰∏≠Êßò">
      </div>
      <div class="form-group">
        <label class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
        <input type="text" class="form-input" id="templateEmail" placeholder="‰æãÔºötanaka@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">‰ª∂Âêç„Éï„Ç©„Éº„Éû„ÉÉ„Éà *</label>
        <input type="text" class="form-input" id="templateSubjectFormat" placeholder="‰æãÔºö{customerName}Êßò Êñ∞Ë¶è„Äá„Äá‰ΩúÊàê‰æùÈ†º„ÄÄÊúüÊó•{dueDate}">
        <div class="form-hint">‰ΩøÁî®ÂèØËÉΩÔºö{customerName}, {dueDate}, {staffName}</div>
      </div>
      <div class="form-group">
        <label class="form-label">„É°„Éº„É´Êú¨Êñá *</label>
        <textarea class="form-textarea" id="templateText" rows="10" placeholder="‰æã:&#10;{company}&#10;{contact}&#10;&#10;„ÅÑ„Å§„ÇÇ„Åä‰∏ñË©±„Å´„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ"></textarea>
        <div class="form-hint">‰ΩøÁî®ÂèØËÉΩÔºö{company}, {contact}, {customerName}, {dueDate}, {staffName}, {specialContent}</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTemplateModal()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary" onclick="saveTemplate()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´Ôºö„Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ -->
<div id="designerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">„Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ</h2>
      <button class="close" onclick="closeDesignerModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Êñ∞„Åó„ÅÑ„Çπ„Çø„ÉÉ„Éï„ÇíËøΩÂä†</label>
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px;">
          <input type="text" class="form-input" id="newDesignerName" placeholder="„Çπ„Çø„ÉÉ„ÉïÂêç">
          <select class="form-select" id="newDesignerCategory" style="width: 150px;">
            <option value="Ë®≠Ë®à">Ë®≠Ë®àÊãÖÂΩì</option>
            <option value="IC">ICÊãÖÂΩì</option>
          </select>
          <button class="btn btn-primary" onclick="addDesigner()">ËøΩÂä†</button>
        </div>
      </div>
      <div id="designerList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeDesignerModal()">ÂÆå‰∫Ü</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´Ôºö„É°„Éº„É´‰ΩúÊàê -->
<div id="emailModal" class="modal">
  <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
      <h2 class="modal-title">üìß „É°„Éº„É´‰ΩúÊàê</h2>
      <button class="close" onclick="closeEmailModal()">&times;</button>
    </div>
    <div class="modal-body" id="emailComposerContent"></div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´ÔºöÊ•≠ËÄÖËøΩÂä†/Á∑®ÈõÜV2 -->
<div id="vendorModalV2" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title" id="vendorModalTitle">Ê•≠ËÄÖËøΩÂä†</h2>
      <button class="close" onclick="closeVendorModalV2()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="vendorForm">
        <input type="hidden" id="vendorId">

        <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Âü∫Êú¨ÊÉÖÂ†±</h3>

        <div class="form-group">
          <label class="form-label">‰ºöÁ§æÂêç *</label>
          <input type="text" class="form-input" id="vendorCompany" placeholder="‰æãÔºöÊ†™Âºè‰ºöÁ§æ„Äá„Äá" required>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">ÊãÖÂΩìËÄÖÂêç</label>
            <input type="text" class="form-input" id="vendorContact" placeholder="‰æãÔºöÁî∞‰∏≠Êßò">
          </div>

          <div class="form-group">
            <label class="form-label">ÈõªË©±Áï™Âè∑</label>
            <input type="text" class="form-input" id="vendorTel" placeholder="‰æãÔºö090-1234-5678">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
            <input type="email" class="form-input" id="vendorEmail" placeholder="‰æãÔºötanaka@example.com">
          </div>

          <div class="form-group">
            <label class="form-label">„Ç´„ÉÜ„Ç¥„É™</label>
            <select class="form-select" id="vendorCategory"></select>
          </div>
        </div>

        <h3 style="margin: 24px 0 16px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">„É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà</h3>

        <div class="form-group">
          <label class="form-label">‰ª∂Âêç„Éï„Ç©„Éº„Éû„ÉÉ„Éà</label>
          <input type="text" class="form-input" id="vendorSubject" placeholder="‰æãÔºö{customerName}Êßò Êñ∞Ë¶è„Äá„Äá‰ΩúÊàê‰æùÈ†º„ÄÄÊúüÊó•{dueDate}">
          <div class="form-hint">‰ΩøÁî®ÂèØËÉΩÔºö{customerName}, {dueDate}, {staffName}</div>
        </div>

        <div class="form-group">
          <label class="form-label">„É°„Éº„É´Êú¨Êñá</label>
          <textarea class="form-textarea" id="vendorTemplate" rows="8" placeholder="‰æã:&#10;{company}&#10;{contact}&#10;&#10;„ÅÑ„Å§„ÇÇ„Åä‰∏ñË©±„Å´„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ"></textarea>
          <div class="form-hint">‰ΩøÁî®ÂèØËÉΩÔºö{company}, {contact}, {customerName}, {dueDate}, {staffName}</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeVendorModalV2()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary" onclick="saveVendorV2()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´ÔºöÊãÖÂΩìËÄÖ„Çø„Çπ„ÇØ‰∏ÄË¶ß -->
<div id="staffTasksModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="staffTasksModalTitle">„Çø„Çπ„ÇØ‰∏ÄË¶ß</h2>
      <button class="close" onclick="closeStaffTasksModal()">&times;</button>
    </div>
    <div class="modal-body task-list-modal">
      <div style="margin-bottom: 16px; display: flex; gap: 8px;">
        <button class="btn btn-small btn-ghost" id="sortByDueBtn" onclick="sortTasksBy('due')">ÊúüÈôêÈ†Ü</button>
        <button class="btn btn-small btn-ghost" id="sortByProjectBtn" onclick="sortTasksBy('project')">ÈÇ∏ÂêçÈ†Ü</button>
      </div>
      <div id="staffTasksList"></div>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´Ôºö„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†/Á∑®ÈõÜ -->
<div id="categoryModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="categoryModalTitle">„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†</h2>
      <button class="close" onclick="closeCategoryModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="categoryForm">
        <input type="hidden" id="categoryId">

        <div class="form-group">
          <label class="form-label">„Ç´„ÉÜ„Ç¥„É™Âêç *</label>
          <input type="text" class="form-input" id="categoryName" placeholder="‰æãÔºöË®≠ÂÇô" required>
        </div>

        <div class="form-group">
          <label class="form-label">Ë°®Á§∫È†Ü</label>
          <input type="number" class="form-input" id="categoryOrder" placeholder="1" min="1">
          <div class="form-hint">Â∞è„Åï„ÅÑÊï∞Â≠ó„Åª„Å©ÂÖà„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeCategoryModal()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary" onclick="saveCategory()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´Ôºö„Çø„Çπ„ÇØËøΩÂä†/Á∑®ÈõÜ -->
<div id="taskModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="taskModalTitle">„Çø„Çπ„ÇØËøΩÂä†</h2>
      <button class="close" onclick="closeTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="taskForm">
        <input type="hidden" id="taskId">
        <input type="hidden" id="taskKey">

        <div class="form-group">
          <label class="form-label">„Çø„Çπ„ÇØÂêç *</label>
          <input type="text" class="form-input" id="taskName" placeholder="‰æãÔºö0ÂõûÁõÆÊâìÂêà„Åõ" required>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">„Ç´„ÉÜ„Ç¥„É™ *</label>
            <select class="form-select" id="taskCategory" required>
              <option value="Ë®≠Ë®à">Ë®≠Ë®à</option>
              <option value="IC">IC</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Ë°®Á§∫È†Ü</label>
            <input type="number" class="form-input" id="taskOrder" placeholder="1" min="1">
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="taskHasState" onchange="toggleTaskState()">
            <span>Áä∂ÊÖãÁÆ°ÁêÜ„ÇíÊúâÂäπ„Å´„Åô„Çã</span>
          </label>
          <div class="form-hint">„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Å®„Äå‰æùÈ†ºÊ∏à„Äç„Äå‰øùÂ≠òÊ∏à„Äç„Å™„Å©„ÅÆÁä∂ÊÖã„ÇíÈÅ∏ÊäûÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô</div>
        </div>

        <div id="stateOptionsGroup" style="display: none;">
          <div class="form-group">
            <label class="form-label">Áä∂ÊÖã„Ç™„Éó„Ç∑„Éß„É≥</label>
            <div id="stateOptionsList" class="state-options-list">
              <!-- ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
            </div>
            <button type="button" class="btn btn-ghost btn-small" onclick="addStateOption()" style="margin-top: 8px;">+ „Ç™„Éó„Ç∑„Éß„É≥ËøΩÂä†</button>
            <div class="form-hint">ÂêÑ„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÁ©∫Ê¨ÑÔºà-Ôºâ„ÅØËá™Âãï„ÅßÂÖàÈ†≠„Å´ËøΩÂä†„Åï„Çå„Åæ„Åô</div>
            <input type="hidden" id="taskStateOptions">
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="taskHasEmailButton">
            <span>üìß „É°„Éº„É´‰ΩúÊàê„Éú„Çø„É≥„ÇíË°®Á§∫„Åô„Çã</span>
          </label>
          <div class="form-hint">„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Å®Ê°à‰ª∂„Ç´„Éº„Éâ„ÅÆ„Çø„Çπ„ÇØ„Å´üìß„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>
        </div>

        <div class="form-group">
          <label class="form-label">Á¥ê„Å•„ÅëÊ•≠ËÄÖÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</label>
          <div id="taskVendorSelection" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
            <!-- „Éô„É≥„ÉÄ„Éº„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
          </div>
          <div class="form-hint">„Åì„ÅÆ„Çø„Çπ„ÇØ„Åã„ÇâÁõ¥Êé•„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åô„ÇãÊ•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTaskModal()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary" onclick="saveTask()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´ÔºöFCËøΩÂä†/Á∑®ÈõÜ -->
<div id="fcModal" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title" id="fcModalTitle">FCËøΩÂä†</h2>
      <button class="close" onclick="closeFcModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="fcForm">
        <input type="hidden" id="fcId">

        <div class="form-group">
          <label class="form-label">FCÂêç *</label>
          <input type="text" class="form-input" id="fcName" placeholder="‰æãÔºöÊù±‰∫¨„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫" required>
        </div>

        <div class="form-group">
          <label class="form-label">URL„Çπ„É©„ÉÉ„Ç∞ *</label>
          <input type="text" class="form-input" id="fcSlug" placeholder="‰æãÔºötokyo-fc" required pattern="[a-z0-9-]+" title="ÂçäËßíËã±Êï∞Â≠ó„Å®„Éè„Ç§„Éï„É≥„ÅÆ„Åø‰ΩøÁî®ÂèØËÉΩ">
          <div class="form-hint">ÂçäËßíËã±Êï∞Â≠ó„Å®„Éè„Ç§„Éï„É≥„ÅÆ„Åø„ÄÇ‰æã: tokyo-fc ‚Üí /fc/tokyo-fc/ „Åß„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">ÈÄ£Áµ°ÂÖà„É°„Éº„É´</label>
            <input type="email" class="form-input" id="fcEmail" placeholder="contact@example.com">
          </div>
          <div class="form-group">
            <label class="form-label">ÈÄ£Áµ°ÂÖàÈõªË©±</label>
            <input type="tel" class="form-input" id="fcTel" placeholder="03-1234-5678">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">„Éñ„É©„É≥„Éâ„Ç´„É©„Éº</label>
          <div style="display: flex; gap: 12px; align-items: center;">
            <input type="color" id="fcColor" value="#2563EB" style="width: 50px; height: 36px; border: none; border-radius: 4px; cursor: pointer;" oninput="document.getElementById('fcColorText').value = this.value">
            <input type="text" class="form-input" id="fcColorText" value="#2563EB" style="width: 120px;" oninput="document.getElementById('fcColor').value = this.value">
          </div>
          <div class="form-hint">FCÂ∞ÇÁî®ÁîªÈù¢„Åß‰ΩøÁî®„Åï„Çå„Çã„É°„Ç§„É≥„Ç´„É©„Éº</div>
        </div>

        <div class="form-group">
          <label class="form-label">„Ç´„Çπ„Çø„É†„É≠„Ç¥URL</label>
          <input type="url" class="form-input" id="fcLogoUrl" placeholder="https://example.com/logo.png">
          <div class="form-hint">Á©∫ÁôΩ„ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Ç¢„Ç§„Ç≥„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="fcIsActive" checked>
            <span>ÊúâÂäπ</span>
          </label>
          <div class="form-hint">ÁÑ°Âäπ„Å´„Åô„Çã„Å®FCÂ∞ÇÁî®URL„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Å™„Åè„Å™„Çä„Åæ„Åô</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeFcModal()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary" onclick="saveFc()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´Ôºö„Çπ„Çø„ÉÉ„ÉïË™çË®ºË®≠ÂÆö -->
<div id="designerAuthModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h2 class="modal-title">üîë „Çπ„Çø„ÉÉ„ÉïË™çË®ºË®≠ÂÆö</h2>
      <button class="close" onclick="closeDesignerAuthModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="designerAuthForm">
        <input type="hidden" id="authDesignerId">

        <div class="form-group">
          <label class="form-label">„Çπ„Çø„ÉÉ„ÉïÂêç</label>
          <input type="text" class="form-input" id="authDesignerName" disabled>
        </div>

        <div class="form-group">
          <label class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÔºà„É≠„Ç∞„Ç§„É≥IDÔºâ *</label>
          <input type="email" class="form-input" id="authDesignerEmail" placeholder="‰æãÔºöyamada@ghouse.jp" required>
          <div class="form-hint">„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åß„É≠„Ç∞„Ç§„É≥„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô</div>
        </div>

        <div class="form-group">
          <label class="form-label">„Éë„Çπ„ÉØ„Éº„Éâ *</label>
          <input type="password" class="form-input" id="authDesignerPassword" placeholder="8ÊñáÂ≠ó‰ª•‰∏ä" required>
          <div class="form-hint">8ÊñáÂ≠ó‰ª•‰∏ä„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        </div>

        <div class="form-group">
          <label class="form-label">„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ *</label>
          <input type="password" class="form-input" id="authDesignerPasswordConfirm" placeholder="„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÂÖ•Âäõ">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeDesignerAuthModal()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary" onclick="saveDesignerAuth()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´ÔºöÁî≥Ë´ãGoÁ¢∫Ë™ç -->
<div id="applicationGoModal" class="modal">
  <div class="modal-content" style="max-width: 450px;">
    <div class="modal-header">
      <h2 class="modal-title">Á¢∫Ë™çÁî≥Ë´ã</h2>
      <button class="close" onclick="closeApplicationGoModal()">&times;</button>
    </div>
    <div class="modal-body" style="text-align: center; padding: 30px;">
      <div style="font-size: 48px; margin-bottom: 16px;">üìã</div>
      <p id="applicationGoProjectName" style="font-size: 18px; font-weight: 600; margin-bottom: 8px;"></p>
      <p style="color: var(--text-secondary); margin-bottom: 24px;">„Åì„ÅÆÊ°à‰ª∂„ÇíÂÆå‰∫ÜÊ∏à„Åø„Å´ÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü</p>
      <div class="application-go-checklist" style="text-align: left; background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <div style="font-weight: 600; margin-bottom: 8px;">Êù°‰ª∂Á¢∫Ë™ç:</div>
        <div id="applicationGoConditions"></div>
      </div>
    </div>
    <div class="modal-footer" style="justify-content: center; gap: 12px;">
      <button class="btn btn-ghost" onclick="closeApplicationGoModal()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-success" onclick="executeApplicationGo()" style="background: linear-gradient(135deg, #10b981, #059669);">ÂÆå‰∫ÜÊ∏à„Åø„Å´„Åô„Çã</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´ÔºöÂÆå‰∫ÜÊ∏à„ÅøÁ¢∫Ë™ç -->
<div id="archiveConfirmModal" class="modal">
  <div class="modal-content" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title">ÂÆå‰∫ÜÊ∏à„Åø„Å´ÁßªÂãï</h2>
      <button class="close" onclick="closeArchiveConfirmModal()">&times;</button>
    </div>
    <div class="modal-body" style="text-align: center; padding: 30px;">
      <div style="font-size: 48px; margin-bottom: 16px;">üì¶</div>
      <p id="archiveConfirmProjectName" style="font-size: 18px; font-weight: 600; margin-bottom: 8px;"></p>
      <p style="color: var(--text-secondary); margin-bottom: 16px;">„Åì„ÅÆÊ°à‰ª∂„ÇíÂÆå‰∫ÜÊ∏à„Åø„Å´ÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü</p>
      <p style="color: var(--text-muted); font-size: 12px;">ÂÆå‰∫ÜÊ∏à„Åø„ÅÆÊ°à‰ª∂„ÅØ„ÄåÂÆå‰∫ÜÊ∏à„Äç„Éï„Ç£„É´„Çø„Éº„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ</p>
    </div>
    <div class="modal-footer" style="justify-content: center; gap: 12px;">
      <button class="btn btn-ghost" onclick="closeArchiveConfirmModal()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-success" onclick="executeArchive()" style="background: linear-gradient(135deg, #10b981, #059669);">ÂÆå‰∫ÜÊ∏à„Åø„Å´„Åô„Çã</button>
    </div>
  </div>
</div>

<!-- „Éà„Éº„Çπ„ÉàÈÄöÁü• -->
<div id="toast" class="toast"></div>
<div id="contextMenu" class="context-menu">
  <div class="context-menu-item" onclick="ContextMenu.edit()">‚úèÔ∏è Á∑®ÈõÜ</div>
  <div class="context-menu-item" onclick="ContextMenu.toggleSelect()">‚òëÔ∏è ÈÅ∏Êäû</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="ContextMenu.archive()">üì¶ ÂÆå‰∫ÜÊ∏à„Åø„Å´ÁßªÂãï</div>
  <div class="context-menu-item danger" onclick="ContextMenu.delete()">üóëÔ∏è ÂâäÈô§</div>
</div>

<script>
// ============================================
// „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâË®≠ÂÆö
// ============================================
const DEBUG_MODE = false; // Êú¨Áï™Áí∞Â¢É„Åß„ÅØ false
const log = DEBUG_MODE ? console.log.bind(console) : () => {};
const warn = DEBUG_MODE ? console.warn.bind(console) : () => {};
const logError = DEBUG_MODE ? console.error.bind(console) : () => {};

// ============================================
// „Éê„Éº„Ç∏„Éß„É≥ÁÆ°ÁêÜ & „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢
// ============================================
const APP_VERSION = '4.12.0-' + Date.now();
if (DEBUG_MODE) log('üöÄ ArchiDeck „Éê„Éº„Ç∏„Éß„É≥:', APP_VERSION);

// Ëµ∑ÂãïÊôÇ„Å´„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂº∑Âà∂„ÇØ„É™„Ç¢
(async function forceClearCache() {
  try {
    // Service Worker „ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
    const cacheNames = await caches.keys();
    for (const name of cacheNames) {
      await caches.delete(name);
      log('üóëÔ∏è „Ç≠„É£„ÉÉ„Ç∑„É•ÂâäÈô§:', name);
    }

    // Service Worker „ÇíÊõ¥Êñ∞
    if ('serviceWorker' in navigator) {
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const reg of registrations) {
        await reg.update();
        log('üîÑ Service Worker Êõ¥Êñ∞');
      }
    }
    log('‚úÖ „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ÂÆå‰∫Ü');
  } catch (e) {
    log('„Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢„Ç®„É©„ÉºÔºàÁÑ°Ë¶ñÂèØÔºâ:', e);
  }
})();

// ============================================
// „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
// ============================================

// „Éá„Éê„Ç¶„É≥„ÇπÈñ¢Êï∞ - ÈÄ£Á∂öÂëº„Å≥Âá∫„Åó„ÇíÂà∂Èôê
function debounce(func, wait = 300) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// „Çπ„É≠„ÉÉ„Éà„É´Èñ¢Êï∞ - ‰∏ÄÂÆöÈñìÈöî„ÅßÂÆüË°å„ÇíÂà∂Èôê
function throttle(func, limit = 100) {
  let inThrottle;
  return function(...args) {
    if (!inThrottle) {
      func.apply(this, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}

// ‰∫åÈáç„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢„Éò„É´„Éë„Éº
const SaveGuard = {
  _locks: new Set(),

  // ‰øùÂ≠òÂá¶ÁêÜ„Çí„É≠„ÉÉ„ÇØÔºà‰∫åÈáçÂÆüË°åÈò≤Ê≠¢Ôºâ
  async run(key, asyncFn) {
    if (this._locks.has(key)) {
      return false;
    }
    this._locks.add(key);
    try {
      return await asyncFn();
    } finally {
      this._locks.delete(key);
    }
  },

  // „É≠„ÉÉ„ÇØÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
  isLocked(key) {
    return this._locks.has(key);
  }
};

// ÂÆâÂÖ®„Å™JSON„Éë„Éº„ÇπÔºà„Ç®„É©„ÉºÊôÇ„ÅØ„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíËøî„ÅôÔºâ
function safeJsonParse(str, defaultValue = null) {
  if (!str) return defaultValue;
  try {
    return JSON.parse(str);
  } catch (e) {
    warn('JSON.parse„Ç®„É©„Éº:', e.message);
    return defaultValue;
  }
}

// „É¢„Éº„ÉÄ„É´ÁÆ°ÁêÜ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
const ModalManager = {
  activeModal: null,
  previousFocus: null,

  // „É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅèÔºà„Éï„Ç©„Éº„Ç´„ÇπÁÆ°ÁêÜ‰ªò„ÅçÔºâ
  open(modalElement, firstFocusSelector = 'input:not([type="hidden"]), select, textarea, button') {
    if (!modalElement) return;

    // Êó¢Â≠ò„ÅÆEscape„Éè„É≥„Éâ„É©„Åå„ÅÇ„Çå„Å∞ÂÖà„Å´Ëß£Èô§ÔºàËìÑÁ©çÈò≤Ê≠¢Ôºâ
    if (this._escapeHandler) {
      document.removeEventListener('keydown', this._escapeHandler);
      this._escapeHandler = null;
    }

    // ÁèæÂú®„ÅÆ„Éï„Ç©„Éº„Ç´„ÇπË¶ÅÁ¥†„Çí‰øùÂ≠ò
    this.previousFocus = document.activeElement;
    this.activeModal = modalElement;

    // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    modalElement.classList.add('show');

    // ÊúÄÂàù„ÅÆÂÖ•ÂäõË¶ÅÁ¥†„Å´„Éï„Ç©„Éº„Ç´„Çπ
    setTimeout(() => {
      const firstFocusable = modalElement.querySelector(firstFocusSelector);
      if (firstFocusable) {
        firstFocusable.focus();
      }
    }, 100);

    // Escape„Ç≠„Éº„Åß„ÅÆ„ÇØ„É≠„Éº„Ç∫„ÇíË®≠ÂÆö
    this._escapeHandler = (e) => {
      if (e.key === 'Escape' && this.activeModal === modalElement) {
        this.close(modalElement);
      }
    };
    document.addEventListener('keydown', this._escapeHandler);
  },

  // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
  close(modalElement) {
    if (!modalElement) return;

    modalElement.classList.remove('show');

    // Escape„Éè„É≥„Éâ„É©„ÇíËß£Èô§
    if (this._escapeHandler) {
      document.removeEventListener('keydown', this._escapeHandler);
      this._escapeHandler = null;
    }

    // Ââç„ÅÆ„Éï„Ç©„Éº„Ç´„ÇπË¶ÅÁ¥†„Å´Êàª„Åô
    if (this.previousFocus && typeof this.previousFocus.focus === 'function') {
      this.previousFocus.focus();
    }

    this.activeModal = null;
    this.previousFocus = null;
  }
};

// „É™„ÇØ„Ç®„Çπ„Éà„Ç¢„Ç§„Éâ„É´„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÔºà„Éù„É™„Éï„Ç£„É´‰ªò„ÅçÔºâ
const requestIdleCallback = window.requestIdleCallback || function(cb) {
  const start = Date.now();
  return setTimeout(() => {
    cb({
      didTimeout: false,
      timeRemaining: () => Math.max(0, 50 - (Date.now() - start))
    });
  }, 1);
};

// „Éá„Éê„Ç¶„É≥„ÇπÊ∏à„ÅøÊ§úÁ¥¢Èñ¢Êï∞
const debouncedRenderProjects = debounce(() => {
  renderProjects();
  // Ê§úÁ¥¢Â±•Ê≠¥„Çí‰øùÂ≠ò
  const query = document.getElementById('searchQuery')?.value.trim();
  if (query && query.length >= 2) {
    saveSearchHistory(query);
  }
}, 250);

// „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„ÉºÊ©üËÉΩ
const ContextMenu = {
  currentProjectId: null,
  menu: null,

  init() {
    this.menu = document.getElementById('contextMenu');
    // Ê°à‰ª∂„Ç´„Éº„Éâ„ÅÆÂè≥„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„Çí„Éá„É™„Ç≤„Éº„Éà
    document.addEventListener('contextmenu', (e) => {
      const card = e.target.closest('[data-project-id]');
      if (card && document.getElementById('projectsTab').contains(card)) {
        e.preventDefault();
        this.show(e.clientX, e.clientY, card.dataset.projectId);
      }
    });
    // „ÇØ„É™„ÉÉ„ÇØ„Åß„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
    document.addEventListener('click', () => this.hide());
  },

  show(x, y, projectId) {
    this.currentProjectId = projectId;
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    // „É°„Éã„É•„ÉºÈ†ÖÁõÆ„ÇíÂãïÁöÑ„Å´Êõ¥Êñ∞
    const archiveItem = this.menu.querySelector('.context-menu-item:nth-child(5)');
    if (archiveItem) {
      archiveItem.innerHTML = project.is_archived ? 'üìÇ Âæ©ÂÖÉ' : 'üì¶ ÂÆå‰∫ÜÊ∏à„Åø„Å´ÁßªÂãï';
    }

    // ÁîªÈù¢Â§ñ„Å´„ÅØ„ÅøÂá∫„Åï„Å™„ÅÑ„Çà„ÅÜ„Å´‰ΩçÁΩÆË™øÊï¥
    this.menu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
    this.menu.style.top = Math.min(y, window.innerHeight - 250) + 'px';
    this.menu.classList.add('show');
  },

  hide() {
    if (this.menu) this.menu.classList.remove('show');
    this.currentProjectId = null;
  },

  edit() {
    if (this.currentProjectId) openProjectModal(this.currentProjectId);
    this.hide();
  },

  toggleSelect() {
    if (this.currentProjectId) BatchOperations.toggle(this.currentProjectId);
    this.hide();
  },

  archive() {
    if (this.currentProjectId) toggleArchive(this.currentProjectId);
    this.hide();
  },

  delete() {
    if (this.currentProjectId) deleteProject(this.currentProjectId);
    this.hide();
  }
};

// Ê§úÁ¥¢„Ç™„Éº„Éà„Ç≥„É≥„Éó„É™„Éº„ÉàÊ©üËÉΩ
function getSearchHistory() {
  return safeJsonParse(localStorage.getItem('archideck_search_history'), []);
}

function saveSearchHistory(query) {
  let history = getSearchHistory();
  // ÈáçË§á„ÇíÂâäÈô§„Åó„Å¶ÂÖàÈ†≠„Å´ËøΩÂä†
  history = history.filter(h => h.toLowerCase() !== query.toLowerCase());
  history.unshift(query);
  // ÊúÄÂ§ß20‰ª∂„Åæ„Åß‰øùÊåÅ
  history = history.slice(0, 20);
  localStorage.setItem('archideck_search_history', JSON.stringify(history));
}

function updateSearchSuggestions() {
  const datalist = document.getElementById('searchSuggestions');
  if (!datalist) return;

  const history = getSearchHistory();
  // È°ßÂÆ¢Âêç‰∏ÄË¶ß„ÇíÂèñÂæóÔºàÈáçË§á„Å™„ÅóÔºâ
  const customers = [...new Set(projects.map(p => p.customer).filter(Boolean))];

  // Â±•Ê≠¥„Å®È°ßÂÆ¢Âêç„ÇíÁµ±ÂêàÔºàÂ±•Ê≠¥ÂÑ™ÂÖàÔºâ
  const suggestions = [...new Set([...history, ...customers])].slice(0, 15);

  datalist.innerHTML = suggestions.map(s => `<option value="${escapeHtml(s)}">`).join('');
}

// ============================================
// Undo/Redo ÁÆ°ÁêÜ
// ============================================
const UndoManager = {
  history: [],
  redoStack: [],
  maxHistory: 50,
  isUndoing: false,

  // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË®òÈå≤
  record(action) {
    if (this.isUndoing) return;

    this.history.push({
      ...action,
      timestamp: Date.now()
    });

    // Â±•Ê≠¥„ÅÆ‰∏äÈôê„ÇíË∂Ö„Åà„Åü„ÇâÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂâäÈô§
    if (this.history.length > this.maxHistory) {
      this.history.shift();
    }

    // Êñ∞„Åó„ÅÑ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅåË®òÈå≤„Åï„Çå„Åü„ÇâRedo„Çπ„Çø„ÉÉ„ÇØ„Çí„ÇØ„É™„Ç¢
    this.redoStack = [];

    this.updateUI();
    log(`üìù Êìç‰ΩúË®òÈå≤: ${action.description}`, action);
  },

  // ÂÖÉ„Å´Êàª„Åô
  async undo() {
    if (this.history.length === 0) {
      showToast('ÂÖÉ„Å´Êàª„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'info');
      return;
    }

    this.isUndoing = true;

    try {
      const action = this.history.pop();
      this.redoStack.push(action);

      await this.revert(action);

      showToast(`‚Ü©Ô∏è ÂÖÉ„Å´Êàª„Åó„Åæ„Åó„Åü: ${action.description}`, 'success');
      announceToScreenReader(`ÂÖÉ„Å´Êàª„Åó„Åæ„Åó„Åü: ${action.description}`);
    } catch (error) {
      logError('UndoÂ§±Êïó:', error);
      showToast('ÂÖÉ„Å´Êàª„ÅôÊìç‰Ωú„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    } finally {
      this.isUndoing = false;
      this.updateUI();
    }
  },

  // „ÇÑ„ÇäÁõ¥„Åô
  async redo() {
    if (this.redoStack.length === 0) {
      showToast('„ÇÑ„ÇäÁõ¥„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'info');
      return;
    }

    this.isUndoing = true;

    try {
      const action = this.redoStack.pop();
      this.history.push(action);

      await this.apply(action);

      showToast(`‚Ü™Ô∏è „ÇÑ„ÇäÁõ¥„Åó„Åæ„Åó„Åü: ${action.description}`, 'success');
      announceToScreenReader(`„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åó„Åü: ${action.description}`);
    } catch (error) {
      logError('RedoÂ§±Êïó:', error);
      showToast('„ÇÑ„ÇäÁõ¥„ÅôÊìç‰Ωú„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    } finally {
      this.isUndoing = false;
      this.updateUI();
    }
  },

  // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÖÉ„Å´Êàª„Åô
  async revert(action) {
    switch (action.type) {
      case 'UPDATE_PROJECT': {
        const { error } = await supabase
          .from('projects')
          .update(action.oldValue)
          .eq('id', action.projectId);
        if (error) throw new Error(`„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞Â§±Êïó: ${error.message}`);
        // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
        const projectIdx = projects.findIndex(p => p.id === action.projectId);
        if (projectIdx !== -1) {
          Object.assign(projects[projectIdx], action.oldValue);
        }
        renderProjects();
        break;
      }

      case 'UPDATE_TASK': {
        const proj = projects.find(p => p.id === action.projectId);
        if (proj && proj.tasks) {
          proj.tasks[action.taskKey] = { ...action.oldValue };
          const { error } = await supabase
            .from('projects')
            .update({ tasks: proj.tasks })
            .eq('id', action.projectId);
          if (error) throw new Error(`„Çø„Çπ„ÇØÊõ¥Êñ∞Â§±Êïó: ${error.message}`);
        }
        renderProjects();
        break;
      }

      case 'CREATE_PROJECT': {
        const { error } = await supabase.from('projects').delete().eq('id', action.projectId);
        if (error) throw new Error(`„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§Â§±Êïó: ${error.message}`);
        projects = projects.filter(p => p.id !== action.projectId);
        renderProjects();
        renderSidebar();
        break;
      }

      case 'DELETE_PROJECT': {
        const { data, error } = await supabase
          .from('projects')
          .insert(action.oldValue)
          .select()
          .single();
        if (error) throw new Error(`„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂæ©ÂÖÉÂ§±Êïó: ${error.message}`);
        if (data) {
          projects.push(data);
        }
        renderProjects();
        renderSidebar();
        break;
      }

      case 'ARCHIVE_PROJECT': {
        const { error } = await supabase
          .from('projects')
          .update({ is_archived: action.oldValue })
          .eq('id', action.projectId);
        if (error) throw new Error(`„Ç¢„Éº„Ç´„Ç§„ÉñÊõ¥Êñ∞Â§±Êïó: ${error.message}`);
        const archiveIdx = projects.findIndex(p => p.id === action.projectId);
        if (archiveIdx !== -1) {
          projects[archiveIdx].is_archived = action.oldValue;
        }
        renderProjects();
        renderSidebar();
        break;
      }

      default:
        warn('Êú™ÂØæÂøú„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éó:', action.type);
    }
  },

  // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÜçÈÅ©Áî®
  async apply(action) {
    switch (action.type) {
      case 'UPDATE_PROJECT': {
        const { error } = await supabase
          .from('projects')
          .update(action.newValue)
          .eq('id', action.projectId);
        if (error) throw new Error(`„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞Â§±Êïó: ${error.message}`);
        const projectIdx = projects.findIndex(p => p.id === action.projectId);
        if (projectIdx !== -1) {
          Object.assign(projects[projectIdx], action.newValue);
        }
        renderProjects();
        break;
      }

      case 'UPDATE_TASK': {
        const proj = projects.find(p => p.id === action.projectId);
        if (proj && proj.tasks) {
          proj.tasks[action.taskKey] = { ...action.newValue };
          const { error } = await supabase
            .from('projects')
            .update({ tasks: proj.tasks })
            .eq('id', action.projectId);
          if (error) throw new Error(`„Çø„Çπ„ÇØÊõ¥Êñ∞Â§±Êïó: ${error.message}`);
        }
        renderProjects();
        break;
      }

      case 'CREATE_PROJECT': {
        const { data, error } = await supabase
          .from('projects')
          .insert(action.newValue)
          .select()
          .single();
        if (error) throw new Error(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàêÂ§±Êïó: ${error.message}`);
        if (data) {
          projects.push(data);
        }
        renderProjects();
        renderSidebar();
        break;
      }

      case 'DELETE_PROJECT': {
        const { error } = await supabase.from('projects').delete().eq('id', action.projectId);
        if (error) throw new Error(`„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§Â§±Êïó: ${error.message}`);
        projects = projects.filter(p => p.id !== action.projectId);
        renderProjects();
        renderSidebar();
        break;
      }

      case 'ARCHIVE_PROJECT': {
        const { error } = await supabase
          .from('projects')
          .update({ is_archived: action.newValue })
          .eq('id', action.projectId);
        if (error) throw new Error(`„Ç¢„Éº„Ç´„Ç§„ÉñÊõ¥Êñ∞Â§±Êïó: ${error.message}`);
        const archiveIdx = projects.findIndex(p => p.id === action.projectId);
        if (archiveIdx !== -1) {
          projects[archiveIdx].is_archived = action.newValue;
        }
        renderProjects();
        renderSidebar();
        break;
      }

      default:
        warn('Êú™ÂØæÂøú„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éó:', action.type);
    }
  },

  // UIÊõ¥Êñ∞
  updateUI() {
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');

    if (undoBtn) {
      undoBtn.disabled = this.history.length === 0;
      undoBtn.title = this.history.length > 0
        ? `ÂÖÉ„Å´Êàª„Åô: ${this.history[this.history.length - 1].description}`
        : 'ÂÖÉ„Å´Êàª„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
    }

    if (redoBtn) {
      redoBtn.disabled = this.redoStack.length === 0;
      redoBtn.title = this.redoStack.length > 0
        ? `„ÇÑ„ÇäÁõ¥„Åô: ${this.redoStack[this.redoStack.length - 1].description}`
        : '„ÇÑ„ÇäÁõ¥„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
    }
  },

  // Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢
  clear() {
    this.history = [];
    this.redoStack = [];
    this.updateUI();
  },

  // Êìç‰ΩúÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  canUndo() {
    return this.history.length > 0;
  },

  canRedo() {
    return this.redoStack.length > 0;
  }
};

// ============================================
// SupabaseÂàùÊúüÂåñ
// ============================================
const SUPABASE_URL = 'https://twzsirpfudqwboeyakta.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3enNpcnBmdWRxd2JvZXlha3RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MzM4NjgsImV4cCI6MjA3NzAwOTg2OH0.E_8GxfsO6Scjc0dDoEoyxq3i4lfvNxYZvnSL1OlSDSM';

// Supabase CDN„ÅÆ„É≠„Éº„ÉâÁ¢∫Ë™ç
if (!window.supabase) {
  logError('‚ùå Supabase CDN „ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºÅ');
  alert('Supabase CDN „ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
}

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
log('‚úÖ SupabaseÂàùÊúüÂåñÂÆå‰∫Ü:', SUPABASE_URL);

// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
let currentUser = null;
let currentDesigner = null;
let currentUserCategory = null; // 'admin' | 'Ë®≠Ë®à' | 'IC'
let projects = [];
let designers = [];

// ICÈñ¢ÈÄ£ÂÆöÊï∞
const IC_MAKER_TASKS = ['ic_kitchen', 'ic_bath', 'ic_washroom', 'ic_toilet', 'ic_lighting', 'ic_tategu', 'ic_curtain', 'ic_zousaku', 'ic_furniture'];
const INTERNAL_STATUSES = ['„Ç™„É™„Ç∏„Éä„É´', 'GRAFTECT', '-', '']; // Á§æÂÜÖÂØæÂøú„Çπ„ÉÜ„Éº„Çø„ÇπÔºà„É°„Éº„É´‰∏çË¶ÅÔºâ
let emailTemplates = [];
let vendors = [];
let taskMappings = {};
let currentDesignerTab = 'ALL';
let editingProjectId = null;
let editingTemplateId = null;
let editingVendorId = null;

// Êñ∞„Ç∑„Çπ„ÉÜ„É†Áî®Â§âÊï∞
let vendorCategories = [];
let tasksV2 = [];
let vendorsV2 = [];
let taskVendorMappings = [];
let products = [];

// „Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÂØæÂøúÔºàSaaSÁâàÔºâ
let currentOrganization = null;
let currentSubscription = null;

// FC„É¢„Éº„ÉâÔºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫Âêë„Åë„Éõ„ÉØ„Ç§„Éà„É©„Éô„É´Ôºâ
let isFCMode = false;
let fcSlug = null;
let organizationSettings = null;

// ÁµÑÁπîÊÉÖÂ†±„ÇíË™≠„ÅøËæº„ÇÄ
async function loadOrganization() {
  try {
    const { data: memberData } = await supabase
      .from('organization_members')
      .select('organization_id')
      .eq('user_id', currentUser.id)
      .eq('status', 'active')
      .single();

    if (memberData) {
      const { data: orgData } = await supabase
        .from('organizations')
        .select('*')
        .eq('id', memberData.organization_id)
        .single();

      if (orgData) {
        currentOrganization = orgData;
        applyWhiteLabel(orgData);

        // „Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥ÊÉÖÂ†±
        const { data: subData } = await supabase
          .from('subscriptions')
          .select('*')
          .eq('organization_id', orgData.id)
          .single();

        currentSubscription = subData;
        checkSubscriptionStatus(subData);
      }
    }
  } catch (error) {
    log('ÁµÑÁπîÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºà„ÉÜ„Éº„Éñ„É´Êú™‰ΩúÊàê„ÅÆÂèØËÉΩÊÄßÔºâ');
  }
}

// „Éõ„ÉØ„Ç§„Éà„É©„Éô„É´ÈÅ©Áî®
function applyWhiteLabel(org) {
  if (!org) return;

  // „É≠„Ç¥Â§âÊõ¥
  if (org.logo_url) {
    const logoElements = document.querySelectorAll('.logo, .sidebar-logo');
    logoElements.forEach(el => {
      if (el.tagName === 'IMG') {
        el.src = org.logo_url;
      }
    });
  }

  // „Ç´„É©„ÉºÂ§âÊõ¥
  if (org.primary_color) {
    document.documentElement.style.setProperty('--primary-color', org.primary_color);
  }
  if (org.secondary_color) {
    document.documentElement.style.setProperty('--secondary-color', org.secondary_color);
  }

  // „Çø„Ç§„Éà„É´Â§âÊõ¥
  if (org.name) {
    document.title = `ArchiDeck | ${org.name}`;
  }
}

// „Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
function checkSubscriptionStatus(sub) {
  if (!sub) return;

  if (sub.status === 'trial') {
    const trialEnd = new Date(sub.trial_ends_at);
    const now = new Date();
    const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));

    if (daysLeft <= 3 && daysLeft > 0) {
      showToast(`„Éà„É©„Ç§„Ç¢„É´ÊúüÈñì„Åå„ÅÇ„Å®${daysLeft}Êó•„ÅßÁµÇ‰∫Ü„Åó„Åæ„Åô`, 'warning');
    } else if (daysLeft <= 0) {
      showToast('„Éà„É©„Ç§„Ç¢„É´ÊúüÈñì„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„Éó„É©„É≥„Çí„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
    }
  } else if (sub.status === 'past_due') {
    showToast('„ÅäÊîØÊâï„ÅÑ„ÅåÈÅÖÂª∂„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÁÆ°ÁêÜÁîªÈù¢„ÅßÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
  }
}

// ÁÑ°Èôê„É´„Éº„ÉóÈò≤Ê≠¢„Éï„É©„Ç∞
let isHandlingHashChange = false;

// ÊãÖÂΩìËÄÖ„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´Âøú„Åò„Åü„Çø„Çπ„ÇØ„É™„Çπ„Éà„ÇíÂèñÂæóÔºàÊñ∞„Ç∑„Çπ„ÉÜ„É†Ôºâ
function getTasksForAssignee(assigneeName) {
  const designer = designers.find(d => d.name === assigneeName);
  const category = designer?.category || 'Ë®≠Ë®à';

  // tasksV2„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÁ©∫ÈÖçÂàó„ÇíËøî„Åô
  if (!tasksV2 || tasksV2.length === 0) {
    warn('‚ö†Ô∏è tasksV2„ÉÜ„Éº„Éñ„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇmigration_customizable_system.sql„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    return [];
  }

  return tasksV2.filter(t => t.category === category).sort((a, b) => a.display_order - b.display_order);
}

// „Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆ„Çø„Çπ„ÇØÂÆöÁæ©„ÇíÂèñÂæóÔºàSupabase + localStorageÁµ±ÂêàÔºâ
function getTasksForCategory(category) {
  // „Åæ„ÅötasksV2ÔºàSupabaseÔºâ„Åã„ÇâÂèñÂæó
  const supabaseTasks = tasksV2.filter(t => t.category === category).sort((a, b) => a.display_order - b.display_order);
  if (supabaseTasks.length > 0) {
    return supabaseTasks;
  }

  // Supabase„Å´„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅlocalStorage„Åã„ÇâÂèñÂæóÔºàÂ§ñÊßã„Éª‰∏çÂãïÁî£„ÉªÂ∑•‰∫ãÔºâ
  let localTasks = [];
  if (category === 'Â§ñÊßã' && typeof exteriorTasks !== 'undefined' && Array.isArray(exteriorTasks)) {
    localTasks = exteriorTasks;
  } else if (category === '‰∏çÂãïÁî£' && typeof realestateTasks !== 'undefined' && Array.isArray(realestateTasks)) {
    localTasks = realestateTasks;
  } else if (category === 'Â∑•‰∫ã' && typeof constructionTasks !== 'undefined' && Array.isArray(constructionTasks)) {
    localTasks = constructionTasks;
  }

  // localStorage„ÅÆ„Çø„Çπ„ÇØ„ÇítasksV2‰∫íÊèõ„ÅÆÂΩ¢Âºè„Å´Â§âÊèõ
  return localTasks.map((t, index) => ({
    id: t.id,
    task_key: t.id,
    task_name: t.name,
    category: category,
    display_order: t.order || index + 1,
    has_state: true,
    state_options: t.states,
    has_email_button: false
  }));
}

// „Çø„Çπ„ÇØ„ÅÆÁä∂ÊÖã„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂèñÂæóÔºàÊñ∞„Ç∑„Çπ„ÉÜ„É†Ôºâ
function getTaskStateOptions(taskKey) {
  // „Åæ„ÅötasksV2ÔºàSupabaseÔºâ„Åã„ÇâÊé¢„Åô
  const task = tasksV2.find(t => t.task_key === taskKey);
  if (task && task.has_state && task.state_options) {
    // JSONÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØ„Éë„Éº„Çπ
    let options = task.state_options;
    if (typeof options === 'string') {
      try {
        options = JSON.parse(options);
      } catch (e) {
        return null;
      }
    }
    return options;
  }

  // localStorage„Éô„Éº„Çπ„ÅÆ„Çø„Çπ„ÇØÔºàÂ§ñÊßã„Éª‰∏çÂãïÁî£„ÉªÂ∑•‰∫ãÔºâ„Åã„Çâ„ÇÇÊé¢„Åô
  if (typeof exteriorTasks !== 'undefined' && Array.isArray(exteriorTasks)) {
    const exteriorTask = exteriorTasks.find(t => t.id === taskKey);
    if (exteriorTask && exteriorTask.states) return exteriorTask.states;
  }

  if (typeof realestateTasks !== 'undefined' && Array.isArray(realestateTasks)) {
    const realestateTask = realestateTasks.find(t => t.id === taskKey);
    if (realestateTask && realestateTask.states) return realestateTask.states;
  }

  if (typeof constructionTasks !== 'undefined' && Array.isArray(constructionTasks)) {
    const constructionTask = constructionTasks.find(t => t.id === taskKey);
    if (constructionTask && constructionTask.states) return constructionTask.states;
  }

  return null;
}

// ============================================
// Ë™çË®ºÂá¶ÁêÜ
// ============================================

// „É¶„Éº„Ç∂„ÉºÂêç„Éª„Ç¢„Éê„Çø„ÉºË°®Á§∫„ÅÆÂÖ±ÈÄöÈñ¢Êï∞
function updateUserDisplay(displayName) {
  const userNameEl = document.getElementById('userName');
  const userAvatarEl = document.getElementById('userAvatar');
  if (userNameEl) userNameEl.textContent = displayName;
  if (userAvatarEl) userAvatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=4A90E2&color=fff&size=32`;
}

// „Éá„É¢„É¢„Éº„Éâ„Éï„É©„Ç∞
let isDemoMode = false;

// „Éá„É¢„É¢„Éº„ÉâÔºà„Éë„Çπ„ÉØ„Éº„ÉâÁÑ°„Åó„Åß„É≠„Ç∞„Ç§„É≥Ôºâ
async function enterDemoMode() {
  log('üé≠ „Éá„É¢„É¢„Éº„Éâ„ÅßÂÖ•Â†¥...');
  document.getElementById('loginContainer').style.display = 'none';
  isDemoMode = true;
  // ÁÆ°ÁêÜËÄÖ„É¢„Éº„Éâ„ÅßÁõ¥Êé•„É°„Ç§„É≥ÁîªÈù¢„Å∏
  await selectAccountType('admin');
}

// „Éë„Çπ„ÉØ„Éº„ÉâÂÜçË®≠ÂÆöUIË°®Á§∫
function showForgotPassword() {
  document.getElementById('forgotPasswordSection').style.display = 'block';
  document.getElementById('forgotEmail').value = document.getElementById('loginEmail').value;
  document.getElementById('forgotEmail').focus();
}

function hideForgotPassword() {
  document.getElementById('forgotPasswordSection').style.display = 'none';
}

// „Éë„Çπ„ÉØ„Éº„ÉâÂÜçË®≠ÂÆö„É°„Éº„É´ÈÄÅ‰ø°
async function sendPasswordReset() {
  const email = document.getElementById('forgotEmail').value.trim();

  if (!email) {
    showToast('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (!window.supabase) {
    showToast('„Ç®„É©„Éº: „Ç∑„Çπ„ÉÜ„É†„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return;
  }

  try {
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.origin + '/archideck/index.html#reset-password'
    });

    if (error) {
      logError('„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
      showToast('„É°„Éº„É´ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    showToast('„Éë„Çπ„ÉØ„Éº„ÉâÂÜçË®≠ÂÆöÁî®„ÅÆ„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ', 'success', 5000);
    hideForgotPassword();
  } catch (e) {
    logError('„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà‰æãÂ§ñ:', e);
    showToast('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
  }
}

async function signIn() {
  log('üîê „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜÈñãÂßã...');

  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  log('üìß ÂÖ•Âäõ„Åï„Çå„Åü„É°„Éº„É´:', email);

  // „Éë„Çπ„ÉØ„Éº„Éâ„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØ„Éá„É¢„É¢„Éº„Éâ„ÅßÂÖ•„Çã
  if (!password && email) {
    log('üé≠ „Éë„Çπ„ÉØ„Éº„ÉâÁÑ°„Åó - „Éá„É¢„É¢„Éº„Éâ„ÅßÁ∂öË°å');
    enterDemoMode();
    return;
  }

  if (!email) {
    logError('‚ùå „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåÁ©∫„Åß„Åô');
    showToast('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (!window.supabase) {
    logError('‚ùå Supabase CDN„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
    showToast('„Ç®„É©„Éº: Supabase„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
    return;
  }

  try {
    log('üîÑ SupabaseË™çË®º„É™„ÇØ„Ç®„Çπ„ÉàÈÄÅ‰ø°‰∏≠...');
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });

    if (error) {
      logError('‚ùå SupabaseË™çË®º„Ç®„É©„Éº:', error);
      throw error;
    }

    log('‚úÖ „É≠„Ç∞„Ç§„É≥ÊàêÂäü:', data.user.email);
    // „É≠„Ç∞„Ç§„É≥ÊàêÂäü - onAuthStateChange„ÅßÂá¶ÁêÜ„Åï„Çå„Çã„ÅÆ„Åßreload„ÅØ‰∏çË¶Å
  } catch (error) {
    logError('‚ùå „É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
    showToast('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
  }
}

async function signOut() {
  try {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
    location.reload();
  } catch (error) {
    logError('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
    showToast('„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
}

async function checkAuth() {
  log('üîç Ë™çË®ºÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠...');
  const { data: { session } } = await supabase.auth.getSession();

  if (session) {
    log('‚úÖ „Çª„ÉÉ„Ç∑„Éß„É≥Ê§úÂá∫:', session.user.email);
    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';

    // admin@ghouse.jp„ÅÆÂ†¥Âêà„ÅØÁÆ°ÁêÜËÄÖ„É¢„Éº„Éâ„ÅßÁõ¥Êé•„É°„Ç§„É≥ÁîªÈù¢„Å∏
    if (currentUser.email === 'admin@ghouse.jp') {
      log('üëë ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥ - ÂÖ®Ê®©Èôê„É¢„Éº„Éâ');
      await selectAccountType('admin');
      return;
    }

    // „Åù„ÅÆ‰ªñ„ÅÆÂ†¥Âêà„ÅØ„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶category„ÇíÂà§ÂÆö
    const { data: designerData } = await supabase
      .from('designers')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    if (designerData) {
      currentDesigner = designerData;
      currentUserCategory = designerData.category;
      log('‚úÖ „Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±ÂèñÂæó:', currentDesigner.name, '/', currentUserCategory);
    } else {
      warn('‚ö†Ô∏è „Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', currentUser.email);
    }

    // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä„ÇíË°®Á§∫
    document.getElementById('mainContainer').classList.add('show');

    // „É¶„Éº„Ç∂„ÉºÂêç„Éª„Ç¢„Éê„Çø„Éº„ÇíË°®Á§∫
    updateUserDisplay(currentUser.email.split('@')[0]);

    await init();

    // ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„Å´URLÁõ¥Êé•„Ç¢„ÇØ„Çª„Çπ„ÅÆÂá¶ÁêÜ„ÇíÂÆüË°åÔºà1Âõû„Å†„ÅëÔºâ
    if (!window.location.hash || window.location.hash === '#') {
      window.location.hash = 'projects';
    }
  } else {
    log('‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó - „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÇíË°®Á§∫');
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('mainContainer').classList.remove('show');
  }
}

// Ë™çË®ºÂá¶ÁêÜ‰∏≠„Éï„É©„Ç∞
let isAuthProcessing = false;

// Ë™çË®ºÁä∂ÊÖãÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
supabase.auth.onAuthStateChange(async (event, session) => {
  log('üîî Ë™çË®º„Ç§„Éô„É≥„Éà:', event, 'currentUser:', currentUser?.email, 'processing:', isAuthProcessing);

  if (event === 'SIGNED_IN' && !currentUser && !isAuthProcessing) {
    isAuthProcessing = true;
    log('‚úÖ SIGNED_IN „Ç§„Éô„É≥„ÉàÂá¶ÁêÜÈñãÂßã:', session.user.email);

    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';

    // admin@ghouse.jp„ÅÆÂ†¥Âêà„ÅØÁÆ°ÁêÜËÄÖ„É¢„Éº„Éâ„ÅßÁõ¥Êé•„É°„Ç§„É≥ÁîªÈù¢„Å∏
    if (currentUser.email === 'admin@ghouse.jp') {
      log('üëë ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥ - ÂÖ®Ê®©Èôê„É¢„Éº„Éâ');
      await selectAccountType('admin');
      isAuthProcessing = false;
      return;
    }

    // „Åù„ÅÆ‰ªñ„ÅÆÂ†¥Âêà„ÅØ„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶category„ÇíÂà§ÂÆö
    const { data: designerData } = await supabase
      .from('designers')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    if (designerData) {
      currentDesigner = designerData;
      currentUserCategory = designerData.category;
      log('‚úÖ „Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±ÂèñÂæó:', currentDesigner.name, '/', currentUserCategory);
    } else {
      warn('‚ö†Ô∏è „Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', currentUser.email);
    }

    // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä„ÇíË°®Á§∫
    document.getElementById('mainContainer').classList.add('show');

    // „É¶„Éº„Ç∂„ÉºÂêç„Éª„Ç¢„Éê„Çø„Éº„ÇíË°®Á§∫
    updateUserDisplay(currentUser.email.split('@')[0]);

    await init();
    isAuthProcessing = false;
  } else if (event === 'SIGNED_OUT') {
    log('üëã SIGNED_OUT „Ç§„Éô„É≥„Éà');
    location.reload();
  } else {
    log('‚è≠Ô∏è „Ç§„Éô„É≥„Éà„Çí„Çπ„Ç≠„ÉÉ„Éó');
  }
});

// „Ç¢„Ç´„Ç¶„É≥„Éà„Çø„Ç§„ÉóÈÅ∏Êäû
async function selectAccountType(category) {
  log('üéØ „Ç¢„Ç´„Ç¶„É≥„Éà„Çø„Ç§„ÉóÈÅ∏Êäû:', category);
  currentUserCategory = category;
  document.getElementById('mainContainer').classList.add('show');

  // „É¶„Éº„Ç∂„ÉºÂêç„Éª„Ç¢„Éê„Çø„Éº„ÇíË°®Á§∫Ôºà„Éá„É¢„É¢„Éº„ÉâÂØæÂøúÔºâ
  const displayName = currentUser?.email ? currentUser.email.split('@')[0] : 'demo';
  updateUserDisplay(displayName);

  // Âàá„ÇäÊõø„Åà„Éú„Çø„É≥„ÇíË°®Á§∫
  updateCategorySwitchButton();

  await init();

  // ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„Å´„Éá„Éï„Ç©„É´„Éà„Çø„Éñ„ÇíË®≠ÂÆöÔºà1Âõû„Å†„ÅëÔºâ
  if (!window.location.hash || window.location.hash === '#') {
    window.location.hash = 'projects';
  }

  log('‚úÖ „Ç¢„Ç´„Ç¶„É≥„Éà„Çø„Ç§„ÉóÈÅ∏ÊäûÂÆå‰∫Ü');
}

// „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„Åà„Éú„Çø„É≥„ÅÆË°®Á§∫Êõ¥Êñ∞
function updateCategorySwitchButton() {
  const btn = document.getElementById('categorySwitchBtn');
  const label = document.getElementById('currentCategoryLabel');

  if (currentUserCategory === 'Ë®≠Ë®à') {
    label.textContent = 'üìê Ë®≠Ë®à';
  } else if (currentUserCategory === 'IC') {
    label.textContent = 'üé® IC';
  } else if (currentUserCategory === 'Â§ñÊßã') {
    label.textContent = 'üå≥ Â§ñÊßã';
  } else if (currentUserCategory === '‰∏çÂãïÁî£') {
    label.textContent = 'üè† ‰∏çÂãïÁî£';
  } else if (currentUserCategory === 'admin') {
    label.textContent = 'üëë ÁÆ°ÁêÜËÄÖ';
  }

  btn.style.display = 'block';
}

// „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„Åà„É°„Éã„É•„Éº„ÅÆÈñãÈñâ
function toggleCategorySwitcher() {
  const menu = document.getElementById('categorySwitchMenu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// „É°„Éã„É•„ÉºÂ§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
document.addEventListener('click', function(e) {
  const menu = document.getElementById('categorySwitchMenu');
  const btn = document.getElementById('categorySwitchBtn');
  if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
    menu.style.display = 'none';
  }
});

// „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„Åà
async function switchCategory(category) {
  log('üîÑ „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„Åà:', category);

  // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
  document.getElementById('categorySwitchMenu').style.display = 'none';

  // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
  if (currentUserCategory === category) {
    log('‚è≠Ô∏è Âêå„Åò„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
    return;
  }

  // „Ç´„ÉÜ„Ç¥„É™„ÇíÊõ¥Êñ∞
  currentUserCategory = category;

  // „Éú„Çø„É≥Ë°®Á§∫„ÇíÊõ¥Êñ∞
  updateCategorySwitchButton();

  // „Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
  showStatus('Ë™≠„ÅøËæº„Åø‰∏≠...', 'saving');
  await init();

  showToast(`${category === 'admin' ? 'ÁÆ°ÁêÜËÄÖ' : category + 'ÊãÖÂΩì'}ÁîªÈù¢„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü`, 'success');
  log('‚úÖ „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„ÅàÂÆå‰∫Ü');
}

// ============================================
// FC„É¢„Éº„ÉâÔºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫Âêë„Åë„Éõ„ÉØ„Ç§„Éà„É©„Éô„É´Ôºâ
// ============================================
function detectFCMode() {
  // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâFC„Çπ„É©„ÉÉ„Ç∞„ÇíÂèñÂæó
  const urlParams = new URLSearchParams(window.location.search);
  const fcParam = urlParams.get('fc');

  // localStorage„Åã„ÇâFC„É¢„Éº„ÉâÊÉÖÂ†±„ÇíÂèñÂæó
  const fcModeData = localStorage.getItem('fc_mode');

  if (fcParam) {
    isFCMode = true;
    fcSlug = fcParam;
    log('üè™ FC„É¢„Éº„ÉâÊ§úÂá∫ÔºàURL„Éë„É©„É°„Éº„ÇøÔºâ:', fcSlug);
  } else if (fcModeData) {
    try {
      const fcConfig = JSON.parse(fcModeData);
      // 24ÊôÇÈñì‰ª•ÂÜÖ„ÅÆË®≠ÂÆö„ÅÆ„ÅøÊúâÂäπ
      if (fcConfig.timestamp && (Date.now() - fcConfig.timestamp < 24 * 60 * 60 * 1000)) {
        isFCMode = true;
        fcSlug = fcConfig.slug;
        log('üè™ FC„É¢„Éº„ÉâÊ§úÂá∫ÔºàlocalStorageÔºâ:', fcSlug);
      }
    } catch (e) {
      warn('FCË®≠ÂÆö„ÅÆËß£Êûê„Å´Â§±Êïó:', e);
    }
  }

  // FC„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØUIË™øÊï¥ÔºàÈùûÂêåÊúü„ÅßÂÆüË°åÔºâ
  if (isFCMode) {
    applyFCMode().catch(e => warn('FC„É¢„Éº„ÉâÈÅ©Áî®„Ç®„É©„Éº:', e));
  }
}

async function applyFCMode() {
  log('üé® FC„É¢„Éº„ÉâUIÈÅ©Áî®‰∏≠...');

  // ÁÆ°ÁêÜËÄÖ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´„Åô„ÇãCSSËøΩÂä†
  const fcStyle = document.createElement('style');
  fcStyle.id = 'fc-mode-styles';
  fcStyle.textContent = `
    /* FC„É¢„Éº„Éâ: ÁÆ°ÁêÜËÄÖÈñ¢ÈÄ£„ÇíÈùûË°®Á§∫ */
    .fc-hide { display: none !important; }

    /* „Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢„ÅÆÁÆ°ÁêÜËÄÖ„Éú„Çø„É≥ */
    button[onclick="selectAccountType('admin')"] { display: none !important; }

    /* „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„Åà„ÅÆÁÆ°ÁêÜËÄÖ„Éú„Çø„É≥ */
    button[onclick="switchCategory('admin')"] { display: none !important; }

    /* Ë®≠ÂÆöÁîªÈù¢„ÅÆÁÆ°ÁêÜËÄÖÂ∞ÇÁî®„Çª„ÇØ„Ç∑„Éß„É≥ */
    .admin-only-section { display: none !important; }

    /* „Éò„ÉÉ„ÉÄ„Éº„ÅÆG„Éè„Ç¶„Çπ„É≠„Ç¥ */
    .header-logo-text .ghouse-text { display: none !important; }
  `;
  document.head.appendChild(fcStyle);

  // FCÁµÑÁπîÊÉÖÂ†±„ÇíDB„Åã„ÇâË™≠„ÅøËæº„Åø
  let fcOrg = null;
  try {
    const { data, error } = await supabase
      .from('fc_organizations')
      .select('*')
      .eq('slug', fcSlug)
      .eq('is_active', true)
      .single();

    if (!error && data) {
      fcOrg = data;
      log('üì¶ FCÁµÑÁπîÊÉÖÂ†±ÂèñÂæó:', fcOrg.name);
    }
  } catch (e) {
    warn('FCÁµÑÁπîÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº:', e);
  }

  // FCÁµÑÁπî„ÅÆ„Ç´„Çπ„Çø„É†Ë®≠ÂÆö„ÇíÈÅ©Áî®
  if (fcOrg) {
    // „Çø„Ç§„Éà„É´Ë®≠ÂÆö
    document.title = fcOrg.name + ' | Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†';

    // „Éó„É©„Ç§„Éû„É™„Ç´„É©„Éº„ÇíÈÅ©Áî®
    if (fcOrg.primary_color) {
      document.documentElement.style.setProperty('--primary-color', fcOrg.primary_color);
    }

    // „É≠„Ç¥„ÇíÈÅ©Áî®Ôºà„Éò„ÉÉ„ÉÄ„ÉºÔºâ
    setTimeout(() => {
      const headerLogo = document.querySelector('.header-logo-text');
      if (headerLogo) {
        if (fcOrg.logo_url) {
          headerLogo.innerHTML = `<img src="${escapeHtml(fcOrg.logo_url)}" alt="${escapeHtml(fcOrg.name)}" style="height: 32px; vertical-align: middle;">`;
        } else {
          headerLogo.innerHTML = `<span style="color: var(--primary-color);">${escapeHtml(fcOrg.name)}</span>`;
        }
      }

      // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆ„É≠„Ç¥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂ§âÊõ¥
      const loginLogoText = document.querySelector('.login-logo-text');
      if (loginLogoText) {
        if (fcOrg.logo_url) {
          loginLogoText.innerHTML = `<img src="${escapeHtml(fcOrg.logo_url)}" alt="${escapeHtml(fcOrg.name)}" style="height: 48px;">`;
        } else {
          loginLogoText.innerHTML = `<span style="color: var(--primary-color);">${escapeHtml(fcOrg.name)}</span>`;
        }
      }

      // Ë®≠ÂÆöÁîªÈù¢„ÅßÁµÑÁπîÂêç„ÇíË°®Á§∫
      const orgNameDisplay = document.getElementById('orgNameDisplay');
      if (orgNameDisplay) {
        orgNameDisplay.textContent = fcOrg.name;
      }
    }, 100);
  } else {
    // FCÁµÑÁπî„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
    document.title = 'Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†';

    // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆG„Éè„Ç¶„ÇπË°®Á§∫„ÇíÈùûË°®Á§∫
    const loginBranding = document.querySelector('#loginContainer p[style*="color: var(--text-muted)"]');
    if (loginBranding && loginBranding.textContent.includes('G„Éè„Ç¶„Çπ')) {
      loginBranding.style.display = 'none';
    }

    // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆ„É≠„Ç¥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂ§âÊõ¥
    const loginLogoText = document.querySelector('.login-logo-text');
    if (loginLogoText) {
      loginLogoText.innerHTML = '<span style="color: var(--primary-color);">Ë®≠Ë®àÊ•≠Âãô</span>ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†';
    }

    setTimeout(() => {
      const headerLogo = document.querySelector('.header-logo-text');
      if (headerLogo && headerLogo.innerHTML.includes('G„Éè„Ç¶„Çπ')) {
        headerLogo.innerHTML = '<span style="color: var(--primary-color);">Archi</span>Deck';
      }

      const orgNameDisplay = document.getElementById('orgNameDisplay');
      if (orgNameDisplay && fcSlug) {
        orgNameDisplay.textContent = fcSlug + ' Â∞ÇÁî®„Ç∑„Çπ„ÉÜ„É†';
      }
    }, 100);
  }

  log('‚úÖ FC„É¢„Éº„ÉâUIÈÅ©Áî®ÂÆå‰∫Ü');
}

function exitFCMode() {
  localStorage.removeItem('fc_mode');
  isFCMode = false;
  fcSlug = null;
  // URL„Éë„É©„É°„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶„É™„É≠„Éº„Éâ
  const url = new URL(window.location);
  url.searchParams.delete('fc');
  window.location.href = url.toString();
}

// ============================================
// „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
// ============================================
function initKeyboardShortcuts() {
  document.addEventListener('keydown', handleKeyboardShortcut);
}

function handleKeyboardShortcut(e) {
  // „É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆEscape„Ç≠„Éº
  if (e.key === 'Escape') {
    // .show „ÇØ„É©„Çπ„ÅÆ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    const openModals = document.querySelectorAll('.modal.show');
    openModals.forEach(modal => modal.classList.remove('show'));
    // „Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñâ„Åò„Çã
    closeSidebar();
    return;
  }

  // Ctrl/Cmd + „Ç≠„Éº „ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
  if (e.ctrlKey || e.metaKey) {
    switch (e.key.toLowerCase()) {
      case 'n':
        // Êñ∞Ë¶èÊ°à‰ª∂‰ΩúÊàê
        if (!isLoginScreen()) {
          e.preventDefault();
          showNewProjectModal();
        }
        break;
      case 's':
        // ‰øùÂ≠òÔºàÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíÂêåÊúüÔºâ
        e.preventDefault();
        forceReloadData();
        showToast('„Éá„Éº„Çø„ÇíÂêåÊúü„Åó„Åæ„Åó„Åü', 'success');
        break;
      case 'k':
        // „ÇØ„Ç§„ÉÉ„ÇØÊ§úÁ¥¢
        e.preventDefault();
        const searchInput = document.querySelector('#searchQuery');
        if (searchInput) {
          searchInput.focus();
        }
        break;
      case 'z':
        // ÂÖÉ„Å´Êàª„Åô / „ÇÑ„ÇäÁõ¥„Åô
        e.preventDefault();
        if (e.shiftKey) {
          // Ctrl+Shift+Z = „ÇÑ„ÇäÁõ¥„Åô
          UndoManager.redo();
        } else {
          // Ctrl+Z = ÂÖÉ„Å´Êàª„Åô
          UndoManager.undo();
        }
        break;
      case 'y':
        // Ctrl+Y = „ÇÑ„ÇäÁõ¥„ÅôÔºàWindowsÊ®ôÊ∫ñÔºâ
        e.preventDefault();
        UndoManager.redo();
        break;
      case 'e':
        // Ctrl+E = CSVÂá∫Âäõ
        if (!isLoginScreen()) {
          e.preventDefault();
          exportToCSV();
        }
        break;
      case 'a':
        // Ctrl+A = ÂÖ®ÈÅ∏ÊäûÔºà„ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ‰∏≠„Åß„Å™„ÅÑÂ†¥ÂêàÔºâ
        if (!isLoginScreen() && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
          e.preventDefault();
          BatchOperations.selectAll();
        }
        break;
      case 'd':
        // Ctrl+Shift+D = „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        if (e.shiftKey) {
          e.preventDefault();
          toggleDarkMode();
        }
        break;
    }
  }

  // Shift + „Ç≠„Éº „ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
  if (e.shiftKey && !e.ctrlKey && !e.metaKey) {
    switch (e.key) {
      case '?':
        // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Éò„É´„Éó„ÇíË°®Á§∫
        showShortcutHelp();
        break;
    }
  }

  // Êï∞Â≠ó„Ç≠„Éº„Åß„Çø„ÉñÂàá„ÇäÊõø„ÅàÔºàÂÖ•Âäõ‰∏≠„Åß„Å™„ÅÑÂ†¥ÂêàÔºâ
  if (!e.ctrlKey && !e.metaKey && !e.shiftKey && !e.altKey) {
    if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'SELECT') {
      switch (e.key) {
        case '1':
          switchTab('projects');
          break;
        case '2':
          switchTab('analytics');
          break;
        case '3':
          switchTab('settings');
          break;
        case 'r':
          // „Éï„Ç£„É´„Çø„Éº„É™„Çª„ÉÉ„Éà
          e.preventDefault();
          resetAllFilters();
          break;
        case 'd':
          // Áµ±Ë®à„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÂàá„ÇäÊõø„Åà
          e.preventDefault();
          toggleStatsDashboard();
          break;
        case 'j':
          // Ê¨°„ÅÆ„Ç´„Éº„Éâ„Å∏ÁßªÂãï
          e.preventDefault();
          CardNavigation.next();
          break;
        case 'k':
          // Ââç„ÅÆ„Ç´„Éº„Éâ„Å∏ÁßªÂãï
          e.preventDefault();
          CardNavigation.prev();
          break;
        case 'Enter':
          // ÈÅ∏Êäû„Ç´„Éº„ÉâÁ∑®ÈõÜ
          if (CardNavigation.currentIndex >= 0) {
            e.preventDefault();
            CardNavigation.edit();
          }
          break;
        case 'x':
          // „Ç´„Éº„ÉâÈÅ∏Êäû„Éà„Ç∞„É´
          e.preventDefault();
          CardNavigation.toggleSelect();
          break;
      }
    }
  }
}

// „Ç´„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
const CardNavigation = {
  currentIndex: -1,

  getCards() {
    return [...document.querySelectorAll('#projectsContainer .project-card')];
  },

  highlightCard(index) {
    const cards = this.getCards();
    cards.forEach((card, i) => {
      card.classList.remove('keyboard-focused');
      if (i === index) {
        card.classList.add('keyboard-focused');
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
    this.currentIndex = index;
  },

  next() {
    const cards = this.getCards();
    if (cards.length === 0) return;
    const newIndex = this.currentIndex < cards.length - 1 ? this.currentIndex + 1 : 0;
    this.highlightCard(newIndex);
  },

  prev() {
    const cards = this.getCards();
    if (cards.length === 0) return;
    const newIndex = this.currentIndex > 0 ? this.currentIndex - 1 : cards.length - 1;
    this.highlightCard(newIndex);
  },

  edit() {
    const cards = this.getCards();
    if (this.currentIndex >= 0 && this.currentIndex < cards.length) {
      const projectId = cards[this.currentIndex].dataset.projectId;
      if (projectId) editProject(projectId);
    }
  },

  toggleSelect() {
    const cards = this.getCards();
    if (this.currentIndex >= 0 && this.currentIndex < cards.length) {
      const projectId = cards[this.currentIndex].dataset.projectId;
      if (projectId) BatchOperations.toggle(projectId);
    }
  },

  reset() {
    this.currentIndex = -1;
    this.getCards().forEach(card => card.classList.remove('keyboard-focused'));
  }
};

// „Éï„Ç£„É´„Çø„Éº„Éë„Éç„É´Ë°®Á§∫Âàá„ÇäÊõø„Åà
function toggleFilterPanel() {
  const panel = document.getElementById('filterPanel');
  const btn = document.getElementById('filterToggleBtn');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    btn.innerHTML = 'üîº ÁµûËæº';
  } else {
    panel.style.display = 'none';
    btn.innerHTML = 'üîΩ ÁµûËæº';
  }
}

// „Éï„Ç£„É´„Çø„Éº„É™„Çª„ÉÉ„Éà
function resetAllFilters() {
  const specFilter = document.getElementById('specFilter');
  const archiveFilter = document.getElementById('archiveFilter');
  const icProgressFilter = document.getElementById('icProgressFilter');
  const icAssigneeFilter = document.getElementById('icAssigneeFilter');
  const exteriorAssigneeFilter = document.getElementById('exteriorAssigneeFilter');
  const realestateAssigneeFilter = document.getElementById('realestateAssigneeFilter');
  const sortOrder = document.getElementById('sortOrder');
  const searchQuery = document.getElementById('searchQuery');

  if (specFilter) specFilter.value = '';
  if (archiveFilter) archiveFilter.value = 'active';
  if (icProgressFilter) icProgressFilter.value = '';
  if (icAssigneeFilter) icAssigneeFilter.value = '';
  if (exteriorAssigneeFilter) exteriorAssigneeFilter.value = '';
  if (realestateAssigneeFilter) realestateAssigneeFilter.value = '';
  if (sortOrder) sortOrder.value = 'updated_desc';
  if (searchQuery) searchQuery.value = '';

  renderProjects();
  showToast('„Éï„Ç£„É´„Çø„Éº„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü', 'info');
}

// „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
function toggleDarkMode() {
  const html = document.documentElement;
  const currentTheme = html.dataset.theme;
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

  html.dataset.theme = newTheme;
  localStorage.setItem('archideck_theme', newTheme);

  // „Éú„Çø„É≥„Ç¢„Ç§„Ç≥„É≥Êõ¥Êñ∞
  const darkModeBtn = document.getElementById('darkModeBtn');
  if (darkModeBtn) {
    darkModeBtn.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  }

  showToast(newTheme === 'dark' ? '„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ„ÇíÊúâÂäπÂåñ„Åó„Åæ„Åó„Åü' : '„É©„Ç§„Éà„É¢„Éº„Éâ„Å´Êàª„Åó„Åæ„Åó„Åü', 'info');
}

// „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàùÊúüÂåñ
function initDarkMode() {
  const savedTheme = localStorage.getItem('archideck_theme');
  if (savedTheme === 'dark') {
    document.documentElement.dataset.theme = 'dark';
    const darkModeBtn = document.getElementById('darkModeBtn');
    if (darkModeBtn) {
      darkModeBtn.textContent = '‚òÄÔ∏è';
    }
  }
}

function isLoginScreen() {
  const loginContainer = document.getElementById('loginContainer');
  return loginContainer && loginContainer.style.display !== 'none';
}

function showShortcutHelp() {
  const helpContent = `
    <div style="padding: 20px; max-height: 80vh; overflow-y: auto;">
      <h3 style="margin-bottom: 16px; font-size: 18px;">‚å®Ô∏è „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà</h3>
      <div style="display: grid; gap: 8px;">
        <div style="font-weight: 600; color: var(--primary-color); margin-top: 8px;">Âü∫Êú¨Êìç‰Ωú</div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + N</span><span>Êñ∞Ë¶èÊ°à‰ª∂‰ΩúÊàê</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + S</span><span>„Éá„Éº„ÇøÂêåÊúü</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + K</span><span>Ê§úÁ¥¢„Å´„Éï„Ç©„Éº„Ç´„Çπ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Escape</span><span>„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã</span>
        </div>
        <div style="font-weight: 600; color: var(--primary-color); margin-top: 8px;">„Çø„ÉñÂàá„ÇäÊõø„Åà</div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>1</span><span>Ê°à‰ª∂„Çø„Éñ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>2</span><span>ÂàÜÊûê„Çø„Éñ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>3</span><span>Ë®≠ÂÆö„Çø„Éñ</span>
        </div>
        <div style="font-weight: 600; color: var(--primary-color); margin-top: 8px;">„Éï„Ç£„É´„Çø„Éº„ÉªË°®Á§∫</div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>R</span><span>„Éï„Ç£„É´„Çø„Éº„É™„Çª„ÉÉ„Éà</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>D</span><span>Áµ±Ë®à„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÂàá„ÇäÊõø„Åà</span>
        </div>
        <div style="font-weight: 600; color: var(--primary-color); margin-top: 8px;">Á∑®ÈõÜ„ÉªÈÅ∏Êäû</div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + Z</span><span>ÂÖÉ„Å´Êàª„ÅôÔºàUndoÔºâ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + Shift + Z</span><span>„ÇÑ„ÇäÁõ¥„ÅôÔºàRedoÔºâ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + A</span><span>ÂÖ®Ê°à‰ª∂ÈÅ∏Êäû</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + E</span><span>CSVÂá∫Âäõ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + Shift + D</span><span>„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Shift + ?</span><span>„Åì„ÅÆ„Éò„É´„Éó„ÇíË°®Á§∫</span>
        </div>
        <div style="font-weight: 600; color: var(--primary-color); margin-top: 8px;">„Ç´„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥</div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>J</span><span>Ê¨°„ÅÆ„Ç´„Éº„Éâ„Å∏ÁßªÂãï</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>K</span><span>Ââç„ÅÆ„Ç´„Éº„Éâ„Å∏ÁßªÂãï</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Enter</span><span>„Ç´„Éº„Éâ„ÇíÁ∑®ÈõÜ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>X</span><span>„Ç´„Éº„ÉâÈÅ∏Êäû„Éà„Ç∞„É´</span>
        </div>
      </div>
    </div>
  `;

  // Á∞°Êòì„É¢„Éº„ÉÄ„É´„ÅßË°®Á§∫
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
  modal.innerHTML = `
    <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 400px; width: 90%;">
      ${helpContent}
      <div style="padding: 0 20px 20px; text-align: right;">
        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  `;
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });
  document.body.appendChild(modal);
}

// ============================================
// ÂàùÊúüÂåñ
// ============================================
async function init() {
  log('üöÄ ÂàùÊúüÂåñÈñãÂßã...');
  showStatus('Ë™≠„ÅøËæº„Åø‰∏≠...', 'saving');

  // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÂàùÊúüÂåñ
  initKeyboardShortcuts();

  // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„ÉºÂàùÊúüÂåñ
  ContextMenu.init();

  // „Çª„ÉÉ„Ç∑„Éß„É≥„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÂàùÊúüÂåñ
  SessionManager.init();

  // FC„É¢„Éº„ÉâÊ§úÂá∫
  detectFCMode();

  try {
    // „Éû„É´„ÉÅ„ÉÜ„Éä„É≥„Éà: ÁµÑÁπîÊÉÖÂ†±„ÇíÂÖà„Å´Ë™≠„ÅøËæº„ÇÄ
    await loadOrganization();

    log('üì¶ „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã...');
    const results = await Promise.allSettled([
      loadDesigners(),
      loadCurrentDesigner(),
      loadProjects(),
      loadEmailTemplates(),
      loadVendors(),
      loadTaskMappings(),
      loadVendorCategories(),
      loadTasksV2(),
      loadVendorsV2(),
      loadTaskVendorMappings(),
      loadProducts(),
      loadFcOrganizations()
    ]);

    // ÂêÑÁµêÊûú„ÇíÁ¢∫Ë™ç
    results.forEach((result, index) => {
      const names = ['„Çπ„Çø„ÉÉ„Éï', 'ÁèæÂú®„ÅÆ„Çπ„Çø„ÉÉ„Éï', 'Ê°à‰ª∂', '„ÉÜ„É≥„Éó„É¨„Éº„Éà', 'Ê•≠ËÄÖ', '„Çø„Çπ„ÇØË®≠ÂÆö', '„Ç´„ÉÜ„Ç¥„É™', '„Çø„Çπ„ÇØV2', 'Ê•≠ËÄÖV2', '„Çø„Çπ„ÇØÊ•≠ËÄÖÁ¥ê„Å•„Åë', 'ÂïÜÂìÅ', 'FCÁµÑÁπî'];
      if (result.status === 'rejected') {
        logError(`‚ùå ${names[index]}„ÅÆË™≠„ÅøËæº„ÅøÂ§±Êïó:`, result.reason);
      } else {
        log(`‚úÖ ${names[index]}„ÅÆË™≠„ÅøËæº„ÅøÊàêÂäü`);
      }
    });

    // Â§±Êïó„Åó„Åü„ÇÇ„ÅÆ„Åå„ÅÇ„Çå„Å∞„Ç®„É©„Éº„ÇíË°®Á§∫
    const failedCount = results.filter(r => r.status === 'rejected').length;
    if (failedCount > 0) {
      warn(`‚ö†Ô∏è ${failedCount}‰ª∂„ÅÆ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü`);
      showToast(`${failedCount}‰ª∂„ÅÆ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`, 'error');
    }

    // Ê•≠ËÄÖ„Éá„Éº„Çø„Å®„Ç´„ÉÜ„Ç¥„É™„Éá„Éº„Çø„Çí„Éû„Éº„Ç∏Ôºà‰∏°Êñπ„ÅÆË™≠„ÅøËæº„Åø„ÅåÂÆå‰∫Ü„Åó„ÅüÂæå„Å´ÂÆüË°åÔºâ
    mergeVendorCategories();

    // IC„Çø„Çπ„ÇØËá™Âãï„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥Ôºà21È†ÖÁõÆÊú™Ê∫Ä„ÅÆÂ†¥ÂêàÔºâ
    await autoMigrateICTasks();

    log('üé® ÁîªÈù¢ÊèèÁîªÈñãÂßã...');
    renderSidebar();
    renderProjects();
    renderTemplates();
    renderVendorsV2();

    // Êñ∞„Ç∑„Çπ„ÉÜ„É†„ÅÆUIÂàùÊúüÂåñ
    populateVendorCategoryDropdown();
    populateProductDropdown();

    // Êñ∞„Ç∑„Çπ„ÉÜ„É†„ÅÆÂêÑÁÆ°ÁêÜÁîªÈù¢„ÅÆÂàùÊúüÊèèÁîª
    log('üé® Êñ∞„Ç∑„Çπ„ÉÜ„É†ÊèèÁîªÈñãÂßã:', {
      vendorsV2Length: vendorsV2.length,
      vendorCategoriesLength: vendorCategories.length,
      tasksV2Length: tasksV2.length,
      taskVendorMappingsLength: taskVendorMappings.length
    });

    renderDesignerListInline();  // „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ
    renderCategoryFilters();      // „Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø„Éº
    populateAssigneeFilters();    // ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Éº
    renderVendorsV2();            // Ê•≠ËÄÖÁÆ°ÁêÜ
    renderCategoriesList();       // „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ
    renderTasksManagement();      // „Çø„Çπ„ÇØÁÆ°ÁêÜ
    renderProductsList();         // ÂïÜÂìÅÁÆ°ÁêÜ

    // „É¢„Éê„Ç§„É´„Çπ„ÉØ„Ç§„Éó„Ç∏„Çß„Çπ„ÉÅ„É£„ÉºÂàùÊúüÂåñ
    MobileGestures.init();

    // ÊúüÈôê„É™„Éû„Ç§„É≥„ÉÄ„Éº„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÔºà3ÁßíÂæå„Å´ÂÆüË°åÔºâ
    setTimeout(() => {
      DeadlineManager.checkReminders();
    }, 3000);

    log('‚úÖ ÂàùÊúüÂåñÂÆå‰∫Ü');
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');

    // ÂàùÂõûË®™ÂïèÊôÇ„ÅØ„ÉÑ„Ç¢„Éº„ÇíË°®Á§∫
    AppTour.checkFirstVisit();
  } catch (error) {
    logError('‚ùå ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
  }
}

// ============================================
// „Éá„Éº„ÇøÂº∑Âà∂„É™„É≠„Éº„Éâ
// ============================================
let isReloading = false;

async function forceReloadData() {
  // ÈáçË§áÂÆüË°åÈò≤Ê≠¢
  if (isReloading) {
    showToast('ÂÜçË™≠„ÅøËæº„Åø‰∏≠„Åß„Åô...', 'info');
    return;
  }

  isReloading = true;

  // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
  const reloadBtns = document.querySelectorAll('[onclick*="forceReloadData"]');
  reloadBtns.forEach(btn => {
    btn.disabled = true;
    btn.style.opacity = '0.5';
  });

  try {
    showStatus('„Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢‰∏≠...', 'saving');

    // „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
    try {
      const cacheNames = await caches.keys();
      for (const name of cacheNames) {
        await caches.delete(name);
      }
    } catch (e) {
      warn('„Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢„Ç®„É©„Éº:', e);
    }

    showStatus('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...', 'saving');

    // „Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
    await init();

    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(`„Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Åæ„Åó„Åü„ÄÇÊ°à‰ª∂Êï∞: ${projects.length}‰ª∂`, 'success');
  } catch (error) {
    logError('ÂÜçË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ÂÜçË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'danger');
  } finally {
    isReloading = false;
    // „Éú„Çø„É≥„ÇíÂÜçÊúâÂäπÂåñ
    reloadBtns.forEach(btn => {
      btn.disabled = false;
      btn.style.opacity = '1';
    });
  }
}

// ============================================
// „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Ë°®Á§∫Ôºà„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÔºâ
// ============================================
async function showDebugInfo() {
  // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´Áõ¥Êé•„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶‰ª∂Êï∞„ÇíÁ¢∫Ë™ç
  let dbProjectsCount = 'ÂèñÂæó‰∏≠...';
  let dbDesignersCount = 'ÂèñÂæó‰∏≠...';
  let dbError = null;

  try {
    const projectsResult = await supabase.from('projects').select('id', { count: 'exact', head: true });
    const designersResult = await supabase.from('designers').select('id', { count: 'exact', head: true });

    dbProjectsCount = projectsResult.count ?? `„Ç®„É©„Éº: ${projectsResult.error?.message}`;
    dbDesignersCount = designersResult.count ?? `„Ç®„É©„Éº: ${designersResult.error?.message}`;

    if (projectsResult.error) dbError = projectsResult.error;
    if (designersResult.error) dbError = designersResult.error;
  } catch (e) {
    dbError = e;
  }

  const info = `
ArchiDeck „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
========================
„Éê„Éº„Ç∏„Éß„É≥: ${APP_VERSION}
„É¶„Éº„Ç∂„Éº: ${currentUser?.email || 'Êú™„É≠„Ç∞„Ç§„É≥'}
„Ç´„ÉÜ„Ç¥„É™: ${currentUserCategory || 'Êú™ÈÅ∏Êäû'}
ÊãÖÂΩì„Çø„Éñ: ${currentDesignerTab}

„É°„É¢„É™‰∏ä„ÅÆ„Éá„Éº„Çø
----------------
Ê°à‰ª∂Êï∞: ${projects.length}‰ª∂
„Çπ„Çø„ÉÉ„ÉïÊï∞: ${designers.length}‰∫∫
„Çø„Çπ„ÇØÊï∞: ${tasksV2.length}‰ª∂
Ê•≠ËÄÖÊï∞: ${vendorsV2.length}‰ª∂

„Éá„Éº„Çø„Éô„Éº„ÇπÁõ¥Êé•Á¢∫Ë™ç
--------------------
DBÊ°à‰ª∂Êï∞: ${dbProjectsCount}‰ª∂
DB„Çπ„Çø„ÉÉ„ÉïÊï∞: ${dbDesignersCount}‰∫∫
${dbError ? `DB„Ç®„É©„Éº: ${dbError.message || dbError}` : ''}

Ê°à‰ª∂Ë©≥Á¥∞
--------
${projects.slice(0, 5).map(p => `„Éª${p.customer} (Ë®≠Ë®à:${p.assigned_to || 'Êú™Ââ≤ÂΩì'}, IC:${p.ic_assignee || 'Êú™Ââ≤ÂΩì'})`).join('\n')}
${projects.length > 5 ? `...‰ªñ${projects.length - 5}‰ª∂` : ''}
${projects.length === 0 ? 'ÔºàÊ°à‰ª∂„Éá„Éº„Çø„Å™„ÅóÔºâ' : ''}

„Çπ„Çø„ÉÉ„ÉïË©≥Á¥∞
----------
${designers.slice(0, 5).map(d => `„Éª${d.name} (${d.category})`).join('\n')}
${designers.length > 5 ? `...‰ªñ${designers.length - 5}‰∫∫` : ''}
${designers.length === 0 ? 'Ôºà„Çπ„Çø„ÉÉ„Éï„Éá„Éº„Çø„Å™„ÅóÔºâ' : ''}

„Ç¢„Éº„Ç´„Ç§„ÉñÁä∂Ê≥Å
--------------
„Ç¢„ÇØ„ÉÜ„Ç£„Éñ: ${projects.filter(p => !p.is_archived).length}‰ª∂
ÂÆå‰∫ÜÊ∏à„Åø: ${projects.filter(p => p.is_archived).length}‰ª∂

„Éï„Ç£„É´„Çø„Éº
----------
„Ç¢„Éº„Ç´„Ç§„Éñ„Éï„Ç£„É´„Çø„Éº: ${document.getElementById('archiveFilter')?.value || '‰∏çÊòé'}
Ê§úÁ¥¢: ${document.getElementById('searchQuery')?.value || '„Å™„Åó'}
ÂïÜÂìÅ: ${document.getElementById('specFilter')?.value || 'ÂÖ®„Å¶'}

RLSÊ≥®ÊÑè
-------
„Éá„Éº„Çø„Éô„Éº„Çπ„Å´Êï∞„Åå„ÅÇ„Å£„Å¶„ÇÇ„É°„É¢„É™„Åå0„ÅÆÂ†¥Âêà„ÄÅ
RLS(Row Level Security)„Åå„Éá„Éº„Çø„Çí„Éñ„É≠„ÉÉ„ÇØ„Åó„Å¶„ÅÑ„Çã
ÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇSupabaseÁÆ°ÁêÜÁîªÈù¢„ÅßRLSË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
  `.trim();

  alert(info);
  log(info);

  // „Éá„Éº„Çø„Åå0‰ª∂„ÅÆÂ†¥Âêà„ÅØË≠¶Âëä„ÇíË°®Á§∫
  if (projects.length === 0 || designers.length === 0) {
    logError('üö® „Éá„Éº„ÇøÊ∂àÂ§±ÂïèÈ°åÊ§úÂá∫ÔºÅ');
    logError('Supabase„ÅÆ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Åß‰ª•‰∏ã„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
    logError('1. projects„ÉÜ„Éº„Éñ„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çã„Åã');
    logError('2. designers„ÉÜ„Éº„Éñ„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çã„Åã');
    logError('3. RLS„Éù„É™„Ç∑„Éº„ÅåÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åã');
    logError('4. anon key„Å´ÈÅ©Âàá„Å™Ê®©Èôê„Åå„ÅÇ„Çã„Åã');
  }
}

// ============================================
// „Éá„Éê„ÉÉ„Ç∞Áî®„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
// ============================================
// „Ç≥„É≥„ÇΩ„Éº„É´„Åß debug() „ÇíÂÆüË°å„Åô„Çã„Å®„ÄÅÂÖ®„Éá„Éº„Çø„ÅÆË©≥Á¥∞„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
window.debug = function() {
  log('='.repeat(80));
  log('üîç „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±');
  log('='.repeat(80));

  log('\nüìä Âü∫Êú¨ÊÉÖÂ†±:');
  log('  - „Çπ„Çø„ÉÉ„ÉïÊï∞:', designers.length);
  log('  - Ê°à‰ª∂Êï∞:', projects.length);
  log('  - „Çø„Çπ„ÇØÊï∞:', tasksV2.length);
  log('  - Ê•≠ËÄÖÊï∞:', vendorsV2.length);

  log('\nüë• „Çπ„Çø„ÉÉ„Éï‰∏ÄË¶ß:');
  designers.forEach(d => {
    log(`  - [${d.category}] ${d.name} (${d.email})`);
  });

  log('\nüìã Ê°à‰ª∂‰∏ÄË¶ß:');
  projects.forEach(p => {
    log(`  - ${p.customer}`);
    log(`    Ë®≠Ë®à: "${p.assigned_to}" (trim: "${(p.assigned_to || '').trim()}")`);
    log(`    IC: "${p.ic_assignee}" (trim: "${(p.ic_assignee || '').trim()}")`);
    log(`    status: ${p.status}, is_archived: ${p.is_archived}`);
  });

  log('\n' + '='.repeat(80));
  return '„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÂá∫Âäõ„Åó„Åæ„Åó„Åü„ÄÇ‰∏äË®ò„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
};

// „Ç≥„É≥„ÇΩ„Éº„É´„Åß checkAssignment('ÊãÖÂΩìËÄÖÂêç', 'Ê°à‰ª∂Âêç') „ÇíÂÆüË°å„Åô„Çã„Å®„ÄÅË©≥Á¥∞„ÉÅ„Çß„ÉÉ„ÇØ„Åå„Åß„Åç„Åæ„Åô
window.checkAssignment = function(designerName, projectName) {
  log('='.repeat(80));
  log(`üîç Ââ≤„ÇäÂΩì„Å¶„ÉÅ„Çß„ÉÉ„ÇØ: ${designerName} ‚Üí ${projectName}`);
  log('='.repeat(80));

  const designer = designers.find(d => d.name.includes(designerName));
  if (!designer) {
    logError(`‚ùå „Çπ„Çø„ÉÉ„Éï "${designerName}" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
    log('ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã„Çπ„Çø„ÉÉ„Éï:', designers.map(d => d.name));
    return;
  }

  const project = projects.find(p => p.customer.includes(projectName));
  if (!project) {
    logError(`‚ùå Ê°à‰ª∂ "${projectName}" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
    log('ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÊ°à‰ª∂:', projects.map(p => p.customer));
    return;
  }

  log('\n‚úÖ „Éá„Éº„ÇøÁ¢∫Ë™ç:');
  log('„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±:', {
    name: designer.name,
    nameLength: designer.name.length,
    nameTrimmed: designer.name.trim(),
    category: designer.category,
    email: designer.email
  });

  log('\nÊ°à‰ª∂ÊÉÖÂ†±:', {
    customer: project.customer,
    assigned_to: `"${project.assigned_to}"`,
    assigned_to_length: project.assigned_to?.length,
    assigned_to_trimmed: `"${(project.assigned_to || '').trim()}"`,
    ic_assignee: `"${project.ic_assignee}"`,
    ic_assignee_length: project.ic_assignee?.length,
    ic_assignee_trimmed: `"${(project.ic_assignee || '').trim()}"`,
    status: project.status,
    is_archived: project.is_archived
  });

  log('\nüîç „Éû„ÉÉ„ÉÅ„É≥„Ç∞ÁµêÊûú:');
  const designerNameTrimmed = designer.name.trim();
  const assignedToTrimmed = (project.assigned_to || '').trim();
  const icAssigneeTrimmed = (project.ic_assignee || '').trim();

  const matchAssigned = assignedToTrimmed === designerNameTrimmed;
  const matchIC = icAssigneeTrimmed === designerNameTrimmed;
  const statusOK = project.status !== 'completed';
  const archivedOK = !project.is_archived;
  const finalMatch = (matchAssigned || matchIC) && statusOK && archivedOK;

  log(`  - assigned_to‰∏ÄËá¥: ${matchAssigned ? '‚úÖ' : '‚ùå'} ("${assignedToTrimmed}" === "${designerNameTrimmed}")`);
  log(`  - ic_assignee‰∏ÄËá¥: ${matchIC ? '‚úÖ' : '‚ùå'} ("${icAssigneeTrimmed}" === "${designerNameTrimmed}")`);
  log(`  - status„ÉÅ„Çß„ÉÉ„ÇØ: ${statusOK ? '‚úÖ' : '‚ùå'} (status !== "completed")`);
  log(`  - archived„ÉÅ„Çß„ÉÉ„ÇØ: ${archivedOK ? '‚úÖ' : '‚ùå'} (!is_archived)`);
  log(`  - ÊúÄÁµÇÂà§ÂÆö: ${finalMatch ? '‚úÖ „Ç´„Ç¶„É≥„Éà„Åï„Çå„Çã' : '‚ùå „Ç´„Ç¶„É≥„Éà„Åï„Çå„Å™„ÅÑ'}`);

  if (!finalMatch) {
    log('\nüí° „Ç´„Ç¶„É≥„Éà„Åï„Çå„Å™„ÅÑÁêÜÁî±:');
    if (!matchAssigned && !matchIC) {
      log('  - ÊãÖÂΩìËÄÖÂêç„Åå‰∏ÄËá¥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
      if (assignedToTrimmed !== designerNameTrimmed) {
        log(`    Ë®≠Ë®à: "${assignedToTrimmed}" ‚â† "${designerNameTrimmed}"`);
      }
      if (icAssigneeTrimmed !== designerNameTrimmed) {
        log(`    IC: "${icAssigneeTrimmed}" ‚â† "${designerNameTrimmed}"`);
      }
    }
    if (!statusOK) {
      log(`  - status„Åå "completed" „Åß„Åô`);
    }
    if (!archivedOK) {
      log(`  - is_archived „Åå true „Åß„Åô`);
    }
  }

  log('\n' + '='.repeat(80));
  return finalMatch ? '„Åì„ÅÆÊ°à‰ª∂„ÅØ„Ç´„Ç¶„É≥„Éà„Åï„Çå„Åæ„Åô ‚úÖ' : '„Åì„ÅÆÊ°à‰ª∂„ÅØ„Ç´„Ç¶„É≥„Éà„Åï„Çå„Åæ„Åõ„Çì ‚ùå';
};

log('üí° „Éá„Éê„ÉÉ„Ç∞Èñ¢Êï∞„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô:');
log('  - debug() : ÂÖ®„Éá„Éº„Çø„ÅÆË©≥Á¥∞„ÇíË°®Á§∫');
log('  - checkAssignment("ÊãÖÂΩìËÄÖÂêç", "Ê°à‰ª∂Âêç") : Ââ≤„ÇäÂΩì„Å¶„ÉÅ„Çß„ÉÉ„ÇØ');

// ============================================
// „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
// ============================================
async function loadDesigners() {
  log('üîÑ „Çπ„Çø„ÉÉ„Éï„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã...');

  try {
    const { data, error, count } = await supabase
      .from('designers')
      .select('*', { count: 'exact' })
      .order('display_order');

    log('üì° Supabase„É¨„Çπ„Éù„É≥„Çπ:', {
      success: !error,
      dataLength: data?.length || 0,
      count: count,
      error: error,
      rawDataSample: data?.slice(0, 3)
    });

    if (error) {
      logError('‚ùå „Çπ„Çø„ÉÉ„Éï„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      logError('„Ç®„É©„ÉºË©≥Á¥∞:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      designers = [];
      return;
    }

    designers = data || [];

    // „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„ÅÆÂÜÖË®≥„ÇíË°®Á§∫
    const byCategory = designers.reduce((acc, d) => {
      const cat = d.category || '(„Å™„Åó)';
      acc[cat] = (acc[cat] || 0) + 1;
      return acc;
    }, {});

    log('‚úÖ „Çπ„Çø„ÉÉ„Éï„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', {
      'Á∑èÊï∞': designers.length,
      '„Ç´„ÉÜ„Ç¥„É™Âà•': byCategory,
      '„Çµ„É≥„Éó„É´': designers.slice(0, 3).map(d => ({ name: d.name, category: d.category, email: d.email }))
    });

    if (designers.length === 0) {
      warn('‚ö†Ô∏è Ë≠¶Âëä: „Çπ„Çø„ÉÉ„Éï„Éá„Éº„Çø„Åå0‰ª∂„Åß„ÅôÔºÅSupabase„ÅÆ„ÉÜ„Éº„Éñ„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    }
  } catch (err) {
    logError('‚ùå loadDesigners()„Åß‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº:', err);
    designers = [];
  }
}

async function loadCurrentDesigner() {
  if (!currentUser || !currentUser.email) return;

  // admin@ghouse.jp„ÅÆÂ†¥Âêà„ÅØ„Çπ„Çø„ÉÉ„Éï„ÇíÁâπÂÆö„Åó„Å™„ÅÑÔºàÂÖ®Ê°à‰ª∂Èñ≤Ë¶ßÂèØËÉΩÔºâ
  if (currentUser.email === 'admin@ghouse.jp') {
    currentDesigner = null;
    return;
  }

  const { data, error } = await supabase
    .from('designers')
    .select('*')
    .eq('email', currentUser.email)
    .single();

  if (error) {
    warn('„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó:', error);
    currentDesigner = null;
    return;
  }

  currentDesigner = data;
  log('ÁèæÂú®„ÅÆ„Çπ„Çø„ÉÉ„Éï:', currentDesigner);
}

async function loadProjects() {
  log('üîÑ Ê°à‰ª∂„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...');
  try {
    const { data, error } = await supabase
      .from('projects')
      .select('*')
      .order('created_at', { ascending: false });
    if (error) {
      logError('‚ùå Ê°à‰ª∂„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      projects = [];
      return;
    }
    projects = data || [];
    log('‚úÖ Ê°à‰ª∂„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', projects.length, '‰ª∂');
    log('üìã Ë™≠„ÅøËæº„Çì„Å†Ê°à‰ª∂„ÅÆË©≥Á¥∞:');
    projects.forEach(p => {
      log(`  - ${p.customer}: assigned_to="${p.assigned_to}", ic_assignee="${p.ic_assignee}"`);
    });

    // Êó¢Â≠ò„Éá„Éº„Çø„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó: assigned_to„Å®ic_assignee„ÅÆÂâçÂæå„ÅÆÁ©∫ÁôΩ„ÇíÂâäÈô§
    await cleanupProjectAssignees();
  } catch (err) {
    logError('‚ùå loadProjects()„Åß‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº:', err);
    projects = [];
  }
}

async function cleanupProjectAssignees() {
  log('üßπ Ê°à‰ª∂„ÅÆÊãÖÂΩìËÄÖ„Éá„Éº„Çø„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó‰∏≠...');
  let updatedCount = 0;

  for (const project of projects) {
    // "null"„Å®„ÅÑ„ÅÜÊñáÂ≠óÂàó„ÇÇnull„Å®„Åó„Å¶Êâ±„ÅÜ
    let assigned = (project.assigned_to || '').trim();
    let icAssigned = (project.ic_assignee || '').trim();
    let exteriorAssigned = (project.exterior_assignee || '').trim();
    let realestateAssigned = (project.realestate_assignee || '').trim();

    if (assigned === 'null' || assigned === 'undefined') assigned = '';
    if (icAssigned === 'null' || icAssigned === 'undefined') icAssigned = '';
    if (exteriorAssigned === 'null' || exteriorAssigned === 'undefined') exteriorAssigned = '';
    if (realestateAssigned === 'null' || realestateAssigned === 'undefined') realestateAssigned = '';

    let needsUpdate = false;

    // trim()„Åó„ÅüÁµêÊûú„ÅåÂÖÉ„ÅÆÂÄ§„Å®ÈÅï„ÅÜÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØ"null"ÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØÊõ¥Êñ∞
    if (project.assigned_to !== assigned ||
        project.ic_assignee !== icAssigned ||
        project.exterior_assignee !== exteriorAssigned ||
        project.realestate_assignee !== realestateAssigned ||
        project.assigned_to === 'null' ||
        project.ic_assignee === 'null' ||
        project.exterior_assignee === 'null' ||
        project.realestate_assignee === 'null') {
      needsUpdate = true;
    }

    if (needsUpdate) {
      log(`üîß „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó: ${project.customer}`);

      const { error } = await supabase
        .from('projects')
        .update({
          assigned_to: assigned || null,
          ic_assignee: icAssigned || null,
          exterior_assignee: exteriorAssigned || null,
          realestate_assignee: realestateAssigned || null
        })
        .eq('id', project.id);

      if (!error) {
        project.assigned_to = assigned || null;
        project.ic_assignee = icAssigned || null;
        project.exterior_assignee = exteriorAssigned || null;
        project.realestate_assignee = realestateAssigned || null;
        updatedCount++;
      } else {
        logError('‚ùå „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂ§±Êïó:', project.customer, error);
      }
    }
  }

  if (updatedCount > 0) {
    log(`‚úÖ ${updatedCount}‰ª∂„ÅÆÊ°à‰ª∂„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Åó„Åæ„Åó„Åü`);
  } else {
    log('‚úÖ „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó‰∏çË¶ÅÔºàÂÖ®Ê°à‰ª∂Ê≠£Â∏∏Ôºâ');
  }
}

async function loadEmailTemplates() {
  log('üîÑ „É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...');
  try {
    const { data, error } = await supabase
      .from('email_templates')
      .select('*')
      .order('display_name');
    if (error) {
      logError('‚ùå „É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      emailTemplates = [];
      return;
    }
    emailTemplates = data || [];
    log('‚úÖ „É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', emailTemplates.length, '‰ª∂');
  } catch (err) {
    logError('‚ùå loadEmailTemplates()„Åß‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº:', err);
    emailTemplates = [];
  }
}

async function loadVendors() {
  log('üîÑ Ê•≠ËÄÖ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...');
  try {
    const { data, error } = await supabase
      .from('template_vendors')
      .select('*')
      .order('company');
    if (error) {
      logError('‚ùå Ê•≠ËÄÖ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      vendors = [];
      return;
    }
    vendors = data || [];
    log('‚úÖ Ê•≠ËÄÖ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', vendors.length, '‰ª∂');
  } catch (err) {
    logError('‚ùå loadVendors()„Åß‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº:', err);
    vendors = [];
  }
}

async function loadTaskMappings() {
  log('üîÑ „Çø„Çπ„ÇØ„Éû„ÉÉ„Éî„É≥„Ç∞„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...');
  try {
    const { data, error } = await supabase
      .from('task_template_mappings')
      .select('*');
    if (error) {
      logError('‚ùå „Çø„Çπ„ÇØ„Éû„ÉÉ„Éî„É≥„Ç∞„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      taskMappings = {};
      return;
    }
    taskMappings = {};
    (data || []).forEach(mapping => {
      taskMappings[mapping.task_key] = mapping.template_id;
    });
    log('‚úÖ „Çø„Çπ„ÇØ„Éû„ÉÉ„Éî„É≥„Ç∞„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', Object.keys(taskMappings).length, '‰ª∂');
  } catch (err) {
    logError('‚ùå loadTaskMappings()„Åß‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº:', err);
    taskMappings = {};
  }
}

// Êñ∞„Ç∑„Çπ„ÉÜ„É†Áî®„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
async function loadVendorCategories() {
  const { data, error } = await supabase
    .from('vendor_categories')
    .select('*')
    .order('display_order');

  if (error) {
    logError('‚ùå Ê•≠ËÄÖ„Ç´„ÉÜ„Ç¥„É™Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
    vendorCategories = [];
    return;
  }

  vendorCategories = data || [];
  log('‚úÖ Ê•≠ËÄÖ„Ç´„ÉÜ„Ç¥„É™Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', vendorCategories.length, '‰ª∂');
}

async function loadTasksV2() {
  const { data, error } = await supabase
    .from('tasks')
    .select('*')
    .order('display_order');

  if (error) {
    logError('‚ùå „Çø„Çπ„ÇØË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
    tasksV2 = [];
    return;
  }

  tasksV2 = data || [];
  log('‚úÖ „Çø„Çπ„ÇØË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', tasksV2.length, '‰ª∂');

  // IC„Çø„Çπ„ÇØ„Åå21È†ÖÁõÆÊú™Ê∫Ä„ÅÆÂ†¥Âêà„ÅØË≠¶ÂëäË°®Á§∫
  const icTasks = tasksV2.filter(t => t.category === 'IC');
  const notice = document.getElementById('icMigrationNotice');
  if (notice) {
    notice.style.display = icTasks.length < 21 ? 'block' : 'none';
  }
}

// IC„Çø„Çπ„ÇØ21È†ÖÁõÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å
async function runICTasksMigration() {
  if (!confirm('IC„Çø„Çπ„ÇØ„Çí21È†ÖÁõÆ„Å´Êõ¥Êñ∞„Åó„Åæ„Åô„ÄÇÊó¢Â≠ò„ÅÆIC„Çø„Çπ„ÇØ„ÅØÁΩÆ„ÅçÊèõ„Åà„Çâ„Çå„Åæ„Åô„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü')) {
    return;
  }

  showToast('üîÑ IC„Çø„Çπ„ÇØ„ÇíÊõ¥Êñ∞‰∏≠...', 'info');

  try {
    // „Çπ„ÉÜ„ÉÉ„Éó0: has_email_button„Ç´„É©„É†„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç„Åó„ÄÅ„Å™„Åë„Çå„Å∞ËøΩÂä†
    // Supabase„Åß„ÅØÁõ¥Êé•ALTER TABLE„Åß„Åç„Å™„ÅÑ„Åü„ÇÅ„ÄÅRPCÁµåÁî±„ÅßÂÆüË°å

    // „Çπ„ÉÜ„ÉÉ„Éó1: Êó¢Â≠òIC„Çø„Çπ„ÇØ„ÇíÂâäÈô§
    const { error: deleteError } = await supabase
      .from('tasks')
      .delete()
      .eq('category', 'IC');

    if (deleteError) {
      throw new Error('Êó¢Â≠òIC„Çø„Çπ„ÇØÂâäÈô§„Ç®„É©„Éº: ' + deleteError.message);
    }
    log('‚úÖ Êó¢Â≠òIC„Çø„Çπ„ÇØÂâäÈô§ÂÆå‰∫Ü');

    // „Çπ„ÉÜ„ÉÉ„Éó2: Ê•≠ËÄÖ„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†
    const newCategories = [
      { name: '„Ç≠„ÉÉ„ÉÅ„É≥', display_order: 10 },
      { name: '„ÅäÈ¢®ÂëÇ', display_order: 11 },
      { name: 'Ê¥óÈù¢', display_order: 12 },
      { name: '„Éà„Ç§„É¨', display_order: 13 },
      { name: 'ÁÖßÊòé', display_order: 14 },
      { name: 'Âª∫ÂÖ∑', display_order: 15 },
      { name: '„Ç´„Éº„ÉÜ„É≥', display_order: 16 },
      { name: 'ÈÄ†‰Ωú', display_order: 17 },
      { name: 'ÂÆ∂ÂÖ∑', display_order: 18 }
    ];

    for (const cat of newCategories) {
      await supabase.from('vendor_categories').upsert(cat, { onConflict: 'name' });
    }
    log('‚úÖ Ê•≠ËÄÖ„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†ÂÆå‰∫Ü');

    // „Çπ„ÉÜ„ÉÉ„Éó3: Êñ∞„Åó„ÅÑIC„Çø„Çπ„ÇØ21È†ÖÁõÆ„ÇíÊåøÂÖ•
    const newICTasks = [
      { task_key: 'ic_funding_check', task_name: 'Ë≥áÈáëË®àÁîª„ÉªÂºïÁ∂ôÊõ∏Á¢∫Ë™ç', category: 'IC', display_order: 1, has_state: true, state_options: '["-", "Á¢∫Ë™çÊ∏à"]', has_email_button: false },
      { task_key: 'ic_kitchen', task_name: '„Ç≠„ÉÉ„ÉÅ„É≥„Éª„Ç´„ÉÉ„Éó„Éú„Éº„Éâ', category: 'IC', display_order: 2, has_state: true, state_options: '["-", "GRAFTECT", "„Ç™„É™„Ç∏„Éä„É´", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_bath', task_name: '„ÅäÈ¢®ÂëÇ', category: 'IC', display_order: 3, has_state: true, state_options: '["-", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_washroom_1f', task_name: 'Ê¥óÈù¢1Èöé', category: 'IC', display_order: 4, has_state: true, state_options: '["-", "ÁÑ°„Åó", "TOTO", "AICA", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_washroom_2f', task_name: 'Ê¥óÈù¢2Èöé', category: 'IC', display_order: 5, has_state: true, state_options: '["-", "ÁÑ°„Åó", "TOTO", "AICA", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_toilet_1f', task_name: '„Éà„Ç§„É¨1Èöé', category: 'IC', display_order: 6, has_state: true, state_options: '["-", "ÁÑ°„Åó", "TOTO", "Lixil", "Panasonic"]', has_email_button: true },
      { task_key: 'ic_toilet_2f', task_name: '„Éà„Ç§„É¨2Èöé', category: 'IC', display_order: 7, has_state: true, state_options: '["-", "ÁÑ°„Åó", "TOTO", "Lixil", "Panasonic"]', has_email_button: true },
      { task_key: 'ic_lighting', task_name: 'ÁÖßÊòé„Éó„É©„É≥', category: 'IC', display_order: 8, has_state: true, state_options: '["-", "ODELIC", "DAIKO", "KOIZUMI", "Panasonic"]', has_email_button: true },
      { task_key: 'ic_spec_doc', task_name: '‰ªïÊßòÊõ∏‰ΩúÊàê', category: 'IC', display_order: 9, has_state: true, state_options: '["-", "‰ΩúÊàêÊ∏à"]', has_email_button: false },
      { task_key: 'ic_longterm_doc', task_name: 'Èï∑ÊúüË≥áÊñôÈÄÅ‰ªò', category: 'IC', display_order: 10, has_state: true, state_options: '["-", "ÈÄÅ‰ªòÊ∏à"]', has_email_button: false },
      { task_key: 'ic_execution_drawing', task_name: 'ÂÆüÊñΩÂõ≥', category: 'IC', display_order: 11, has_state: true, state_options: '["-", "‰øÆÊ≠£‰æùÈ†ºÊ∏à", "Âõ≥Èù¢„ÉÅ„Çß„ÉÉ„ÇØÊ∏à"]', has_email_button: false },
      { task_key: 'ic_exterior_pres', task_name: 'Â§ñË£Ö„Éó„É¨„Çº„É≥‰ΩúÊàê', category: 'IC', display_order: 12, has_state: true, state_options: '["-", "‰ΩúÊàêÊ∏à"]', has_email_button: false },
      { task_key: 'ic_interior_pres', task_name: 'ÂÜÖË£Ö„Éó„É¨„Çº„É≥‰ΩúÊàê', category: 'IC', display_order: 13, has_state: true, state_options: '["-", "‰ΩúÊàêÊ∏à"]', has_email_button: false },
      { task_key: 'ic_tategu', task_name: 'Âª∫ÂÖ∑„Éó„É¨„Çº„É≥‰æùÈ†º', category: 'IC', display_order: 14, has_state: true, state_options: '["-", "‰æùÈ†ºÊ∏à", "‰øùÂ≠òÊ∏à"]', has_email_button: true },
      { task_key: 'ic_tile_pres', task_name: '„Çø„Ç§„É´„Éó„É¨„Çº„É≥‰ΩúÊàê', category: 'IC', display_order: 15, has_state: true, state_options: '["-", "ÁÑ°", "‰ΩúÊàêÊ∏à"]', has_email_button: false },
      { task_key: 'ic_exterior_meeting', task_name: 'Â§ñÊßã„Å∏„ÅÆÊâìÂêà„Åõ‰æùÈ†º', category: 'IC', display_order: 16, has_state: true, state_options: '["-", "‰æùÈ†ºÊ∏à"]', has_email_button: false },
      { task_key: 'ic_curtain', task_name: '„Ç´„Éº„ÉÜ„É≥Á¥π‰ªã', category: 'IC', display_order: 17, has_state: true, state_options: '["-", "ÁÑ°„Åó", "‰æùÈ†ºÊ∏à"]', has_email_button: true },
      { task_key: 'ic_zousaku', task_name: 'ÈÄ†‰ΩúÊ•≠ËÄÖÁ¥π‰ªã', category: 'IC', display_order: 18, has_state: true, state_options: '["-", "ÁÑ°„Åó", "‰æùÈ†ºÊ∏à"]', has_email_button: true },
      { task_key: 'ic_furniture', task_name: 'ÂÆ∂ÂÖ∑Ë¶ãÁ©ç‰æùÈ†º', category: 'IC', display_order: 19, has_state: true, state_options: '["-", "ÁÑ°„Åó", "‰æùÈ†ºÊ∏à"]', has_email_button: true },
      { task_key: 'ic_iron', task_name: '„Ç¢„Ç§„Ç¢„É≥', category: 'IC', display_order: 20, has_state: true, state_options: '["-", "ÁÑ°„Åó", "‰æùÈ†ºÊ∏à"]', has_email_button: true },
      { task_key: 'ic_final_checklist', task_name: 'Á¢∫ÂÆöÂõ≥„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà', category: 'IC', display_order: 21, has_state: true, state_options: '["-", "ÂÆüÊñΩÊ∏à"]', has_email_button: false },
      { task_key: 'ic_op_check', task_name: 'OPË¶ãÁ©ç„ÉÅ„Çß„ÉÉ„ÇØ', category: 'IC', display_order: 22, has_state: true, state_options: '["-", "‰æùÈ†ºÊ∏à", "‰øùÂ≠òÊ∏à"]', has_email_button: false },
      { task_key: 'ic_meeting_followup', task_name: '‰ºöË≠∞ÂæåÁ¢∫Ë™ç‰∫ãÈ†ÖÈÄÅ‰ªò', category: 'IC', display_order: 23, has_state: true, state_options: '["-", "ÈÄÅ‰ªòÊ∏à"]', has_email_button: false },
      { task_key: 'ic_final_approval', task_name: 'Á¢∫ÂÆöÂõ≥ÊâøË™ç', category: 'IC', display_order: 24, has_state: true, state_options: '["-", "‰æùÈ†º‰∏≠", "„ÉÄ„É≥„Éâ„É™„ÉØ„Éº„ÇØ‰øùÂ≠òÊ∏à"]', has_email_button: false }
    ];

    const { error: insertError } = await supabase
      .from('tasks')
      .upsert(newICTasks, { onConflict: 'task_key' });

    if (insertError) {
      throw new Error('IC„Çø„Çπ„ÇØÊåøÂÖ•„Ç®„É©„Éº: ' + insertError.message);
    }
    log('‚úÖ 21È†ÖÁõÆ„ÅÆIC„Çø„Çπ„ÇØËøΩÂä†ÂÆå‰∫Ü');

    // „Éá„Éº„ÇøÂÜçË™≠„ÅøËæº„Åø
    await loadTasksV2();
    await loadVendorCategories();
    renderTasksManagement();

    showToast('‚úÖ IC„Çø„Çπ„ÇØ„Çí21È†ÖÁõÆ„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ', 'success');

    // Ë≠¶Âëä„ÇíÈùûË°®Á§∫
    const notice = document.getElementById('icMigrationNotice');
    if (notice) notice.style.display = 'none';

  } catch (error) {
    logError('IC„Çø„Çπ„ÇØ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Ç®„É©„Éº:', error);
    showToast('‚ùå IC„Çø„Çπ„ÇØÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
  }
}

// IC„Çø„Çπ„ÇØËá™Âãï„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÔºàËµ∑ÂãïÊôÇ„Å´21È†ÖÁõÆÊú™Ê∫Ä„Å™„ÇâËá™ÂãïÂÆüË°åÔºâ
async function autoMigrateICTasks() {
  const icTasks = tasksV2.filter(t => t.category === 'IC');

  // Êó¢„Å´21È†ÖÁõÆ‰ª•‰∏ä„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
  if (icTasks.length >= 21) {
    log('‚úÖ IC„Çø„Çπ„ÇØ„ÅØÊó¢„Å´21È†ÖÁõÆ‰ª•‰∏ä„ÅÇ„Çä„Åæ„Åô:', icTasks.length);
    return;
  }

  log('üîÑ IC„Çø„Çπ„ÇØËá™Âãï„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÈñãÂßã... (ÁèæÂú®:', icTasks.length, 'È†ÖÁõÆ)');

  try {
    // Êó¢Â≠òIC„Çø„Çπ„ÇØ„ÇíÂâäÈô§
    const { error: deleteError } = await supabase
      .from('tasks')
      .delete()
      .eq('category', 'IC');

    if (deleteError) {
      throw new Error('Êó¢Â≠òIC„Çø„Çπ„ÇØÂâäÈô§„Ç®„É©„Éº: ' + deleteError.message);
    }

    // Ê•≠ËÄÖ„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†
    const newCategories = [
      { name: '„Ç≠„ÉÉ„ÉÅ„É≥', display_order: 10 },
      { name: '„ÅäÈ¢®ÂëÇ', display_order: 11 },
      { name: 'Ê¥óÈù¢', display_order: 12 },
      { name: '„Éà„Ç§„É¨', display_order: 13 },
      { name: 'ÁÖßÊòé', display_order: 14 },
      { name: 'Âª∫ÂÖ∑', display_order: 15 },
      { name: '„Ç´„Éº„ÉÜ„É≥', display_order: 16 },
      { name: 'ÈÄ†‰Ωú', display_order: 17 },
      { name: 'ÂÆ∂ÂÖ∑', display_order: 18 }
    ];

    for (const cat of newCategories) {
      await supabase.from('vendor_categories').upsert(cat, { onConflict: 'name' });
    }

    // 21È†ÖÁõÆ„ÅÆIC„Çø„Çπ„ÇØ„ÇíÊåøÂÖ•
    const newICTasks = [
      { task_key: 'ic_funding_check', task_name: 'Ë≥áÈáëË®àÁîª„ÉªÂºïÁ∂ôÊõ∏Á¢∫Ë™ç', category: 'IC', display_order: 1, has_state: true, state_options: '["-", "Á¢∫Ë™çÊ∏à"]', has_email_button: false },
      { task_key: 'ic_kitchen', task_name: '„Ç≠„ÉÉ„ÉÅ„É≥„Éª„Ç´„ÉÉ„Éó„Éú„Éº„Éâ', category: 'IC', display_order: 2, has_state: true, state_options: '["-", "GRAFTECT", "„Ç™„É™„Ç∏„Éä„É´", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_bath', task_name: '„ÅäÈ¢®ÂëÇ', category: 'IC', display_order: 3, has_state: true, state_options: '["-", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_washroom_1f', task_name: 'Ê¥óÈù¢1Èöé', category: 'IC', display_order: 4, has_state: true, state_options: '["-", "ÁÑ°„Åó", "TOTO", "AICA", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_washroom_2f', task_name: 'Ê¥óÈù¢2Èöé', category: 'IC', display_order: 5, has_state: true, state_options: '["-", "ÁÑ°„Åó", "TOTO", "AICA", "Lixil", "Panasonic", "Takarastandard"]', has_email_button: true },
      { task_key: 'ic_toilet_1f', task_name: '„Éà„Ç§„É¨1Èöé', category: 'IC', display_order: 6, has_state: true, state_options: '["-", "ÁÑ°„Åó", "TOTO", "Lixil", "Panasonic"]', has_email_button: true },
      { task_key: 'ic_toilet_2f', task_name: '„Éà„Ç§„É¨2Èöé', category: 'IC', display_order: 7, has_state: true, state_options: '["-", "ÁÑ°„Åó", "TOTO", "Lixil", "Panasonic"]', has_email_button: true },
      { task_key: 'ic_lighting', task_name: 'ÁÖßÊòé„Éó„É©„É≥', category: 'IC', display_order: 8, has_state: true, state_options: '["-", "ODELIC", "DAIKO", "KOIZUMI", "Panasonic"]', has_email_button: true },
      { task_key: 'ic_spec_doc', task_name: '‰ªïÊßòÊõ∏‰ΩúÊàê', category: 'IC', display_order: 9, has_state: true, state_options: '["-", "‰ΩúÊàêÊ∏à"]', has_email_button: false },
      { task_key: 'ic_longterm_doc', task_name: 'Èï∑ÊúüË≥áÊñôÈÄÅ‰ªò', category: 'IC', display_order: 10, has_state: true, state_options: '["-", "ÈÄÅ‰ªòÊ∏à"]', has_email_button: false },
      { task_key: 'ic_execution_drawing', task_name: 'ÂÆüÊñΩÂõ≥', category: 'IC', display_order: 11, has_state: true, state_options: '["-", "‰øÆÊ≠£‰æùÈ†ºÊ∏à", "Âõ≥Èù¢„ÉÅ„Çß„ÉÉ„ÇØÊ∏à"]', has_email_button: false },
      { task_key: 'ic_exterior_pres', task_name: 'Â§ñË£Ö„Éó„É¨„Çº„É≥‰ΩúÊàê', category: 'IC', display_order: 12, has_state: true, state_options: '["-", "‰ΩúÊàêÊ∏à"]', has_email_button: false },
      { task_key: 'ic_interior_pres', task_name: 'ÂÜÖË£Ö„Éó„É¨„Çº„É≥‰ΩúÊàê', category: 'IC', display_order: 13, has_state: true, state_options: '["-", "‰ΩúÊàêÊ∏à"]', has_email_button: false },
      { task_key: 'ic_tategu', task_name: 'Âª∫ÂÖ∑„Éó„É¨„Çº„É≥‰æùÈ†º', category: 'IC', display_order: 14, has_state: true, state_options: '["-", "‰æùÈ†ºÊ∏à", "‰øùÂ≠òÊ∏à"]', has_email_button: true },
      { task_key: 'ic_tile_pres', task_name: '„Çø„Ç§„É´„Éó„É¨„Çº„É≥‰ΩúÊàê', category: 'IC', display_order: 15, has_state: true, state_options: '["-", "ÁÑ°", "‰ΩúÊàêÊ∏à"]', has_email_button: false },
      { task_key: 'ic_exterior_meeting', task_name: 'Â§ñÊßã„Å∏„ÅÆÊâìÂêà„Åõ‰æùÈ†º', category: 'IC', display_order: 16, has_state: true, state_options: '["-", "‰æùÈ†ºÊ∏à"]', has_email_button: false },
      { task_key: 'ic_curtain', task_name: '„Ç´„Éº„ÉÜ„É≥Á¥π‰ªã', category: 'IC', display_order: 17, has_state: true, state_options: '["-", "ÁÑ°„Åó", "‰æùÈ†ºÊ∏à"]', has_email_button: true },
      { task_key: 'ic_zousaku', task_name: 'ÈÄ†‰ΩúÊ•≠ËÄÖÁ¥π‰ªã', category: 'IC', display_order: 18, has_state: true, state_options: '["-", "ÁÑ°„Åó", "‰æùÈ†ºÊ∏à"]', has_email_button: true },
      { task_key: 'ic_furniture', task_name: 'ÂÆ∂ÂÖ∑Ë¶ãÁ©ç‰æùÈ†º', category: 'IC', display_order: 19, has_state: true, state_options: '["-", "ÁÑ°„Åó", "‰æùÈ†ºÊ∏à"]', has_email_button: true },
      { task_key: 'ic_iron', task_name: '„Ç¢„Ç§„Ç¢„É≥', category: 'IC', display_order: 20, has_state: true, state_options: '["-", "ÁÑ°„Åó", "‰æùÈ†ºÊ∏à"]', has_email_button: true },
      { task_key: 'ic_final_checklist', task_name: 'Á¢∫ÂÆöÂõ≥„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà', category: 'IC', display_order: 21, has_state: true, state_options: '["-", "ÂÆüÊñΩÊ∏à"]', has_email_button: false },
      { task_key: 'ic_op_check', task_name: 'OPË¶ãÁ©ç„ÉÅ„Çß„ÉÉ„ÇØ', category: 'IC', display_order: 22, has_state: true, state_options: '["-", "‰æùÈ†ºÊ∏à", "‰øùÂ≠òÊ∏à"]', has_email_button: false },
      { task_key: 'ic_meeting_followup', task_name: '‰ºöË≠∞ÂæåÁ¢∫Ë™ç‰∫ãÈ†ÖÈÄÅ‰ªò', category: 'IC', display_order: 23, has_state: true, state_options: '["-", "ÈÄÅ‰ªòÊ∏à"]', has_email_button: false },
      { task_key: 'ic_final_approval', task_name: 'Á¢∫ÂÆöÂõ≥ÊâøË™ç', category: 'IC', display_order: 24, has_state: true, state_options: '["-", "‰æùÈ†º‰∏≠", "„ÉÄ„É≥„Éâ„É™„ÉØ„Éº„ÇØ‰øùÂ≠òÊ∏à"]', has_email_button: false }
    ];

    const { error: insertError } = await supabase
      .from('tasks')
      .upsert(newICTasks, { onConflict: 'task_key' });

    if (insertError) {
      throw new Error('IC„Çø„Çπ„ÇØÊåøÂÖ•„Ç®„É©„Éº: ' + insertError.message);
    }

    // „Çø„Çπ„ÇØ„Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
    await loadTasksV2();
    await loadVendorCategories();

    log('‚úÖ IC„Çø„Çπ„ÇØËá™Âãï„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü (21È†ÖÁõÆ)');
    showToast('‚úÖ IC„Çø„Çπ„ÇØ„Çí21È†ÖÁõÆ„Å´Ëá™ÂãïÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');

  } catch (error) {
    logError('IC„Çø„Çπ„ÇØËá™Âãï„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Ç®„É©„Éº:', error);
    // „Ç®„É©„Éº„Åß„ÇÇÁ∂öË°åÔºàÊó¢Â≠òÊ©üËÉΩ„Å´ÂΩ±Èüø„Åï„Åõ„Å™„ÅÑÔºâ
  }
}

async function loadVendorsV2() {
  log('üîÑ Ê•≠ËÄÖ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã...', {
    timestamp: new Date().toISOString()
  });

  const { data, error } = await supabase
    .from('vendors_v2')
    .select('*')
    .order('company');

  log('üì° loadVendorsV2 Supabase„É¨„Çπ„Éù„É≥„Çπ:', {
    success: !error,
    dataLength: data?.length || 0,
    error: error,
    rawData: data
  });

  if (error) {
    logError('‚ùå Ê•≠ËÄÖË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
    showToast('Ê•≠ËÄÖ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + error.message, 'error');
    vendorsV2 = [];
    return;
  }

  if (!data || data.length === 0) {
    logError('‚ö†Ô∏è CRITICAL: vendors_v2„ÉÜ„Éº„Éñ„É´„Å´„Éá„Éº„Çø„Åå0‰ª∂„Åß„ÅôÔºÅ');
    warn('vendors_v2„ÉÜ„Éº„Éñ„É´„Å´„Éá„Éº„Çø„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
    vendorsV2 = [];
    return;
  }

  vendorsV2 = data || [];
  log('‚úÖ Ê•≠ËÄÖË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', vendorsV2.length, '‰ª∂');
  log('‚úÖ Ê•≠ËÄÖ„Éá„Éº„ÇøË©≥Á¥∞:', vendorsV2);
}

function mergeVendorCategories() {
  log('üîó mergeVendorCategories() ÈñãÂßã:', {
    vendorsV2Length: vendorsV2.length,
    vendorCategoriesLength: vendorCategories.length,
    vendorCategories: vendorCategories
  });

  // „Ç´„ÉÜ„Ç¥„É™ÊÉÖÂ†±„ÇíÊ•≠ËÄÖ„Éá„Éº„Çø„Å´„Éû„Éº„Ç∏ÔºàPromise.allSettledÂÆå‰∫ÜÂæå„Å´Âëº„Å≥Âá∫„ÅôÔºâ
  if (vendorsV2.length > 0 && vendorCategories.length > 0) {
    vendorsV2 = vendorsV2.map(vendor => {
      const category = vendorCategories.find(c => c.id === vendor.category_id);
      return {
        ...vendor,
        vendor_categories: category ? { name: category.name } : null
      };
    });
    log('‚úÖ Ê•≠ËÄÖ-„Ç´„ÉÜ„Ç¥„É™„Éû„Éº„Ç∏ÂÆå‰∫Ü:', vendorsV2.slice(0, 2));
  } else {
    warn('‚ö†Ô∏è „Éû„Éº„Ç∏„Çπ„Ç≠„ÉÉ„Éó:', {
      vendorsV2Empty: vendorsV2.length === 0,
      vendorCategoriesEmpty: vendorCategories.length === 0
    });
  }
}

async function loadTaskVendorMappings() {
  const { data, error } = await supabase
    .from('task_vendor_mappings_v2')
    .select('*');

  if (error) {
    logError('‚ùå „Çø„Çπ„ÇØ-Ê•≠ËÄÖÁ¥ê„Å•„ÅëË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
    taskVendorMappings = [];
    return;
  }

  taskVendorMappings = data || [];
  log('‚úÖ „Çø„Çπ„ÇØ-Ê•≠ËÄÖÁ¥ê„Å•„ÅëË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', taskVendorMappings.length, '‰ª∂');
}

async function loadProducts() {
  const { data, error } = await supabase
    .from('products')
    .select('*')
    .order('display_order');
  if (!error && data) {
    products = data;
  } else {
    // „ÉÜ„Éº„Éñ„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
    products = [
      { id: '1', name: 'LIFE', display_order: 1 },
      { id: '2', name: 'LIFE+', display_order: 2 },
      { id: '3', name: 'HOURS', display_order: 3 },
      { id: '4', name: 'LACIE', display_order: 4 },
      { id: '5', name: 'LIFE Limited', display_order: 5 },
      { id: '6', name: 'LIFE+ Limited', display_order: 6 }
    ];
  }
  log('‚úÖ ÂïÜÂìÅË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', products.length, '‰ª∂');
}

// ============================================
// Ê•≠ËÄÖÁÆ°ÁêÜV2
// ============================================
let currentCategoryFilter = 'ALL';

function renderVendorsV2() {
  log('üìû renderVendorsV2() Âëº„Å≥Âá∫„ÅóÈñãÂßã');
  log('üìä vendorsV2ÈÖçÂàó„ÅÆÁä∂ÊÖã:', {
    length: vendorsV2.length,
    data: vendorsV2.slice(0, 3),
    'ÂÖ®„Éá„Éº„Çø': vendorsV2
  });

  const container = document.getElementById('vendorsGrid');
  log('üéØ vendorsGridË¶ÅÁ¥†:', container ? 'found ‚úì' : 'NOT FOUND ‚úó');

  if (!container) {
    logError('‚ùå CRITICAL: vendorsGridË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„ÇìÔºÅ');
    log('üìç ÁèæÂú®„ÅÆDOMÁä∂ÊÖã:', document.getElementById('vendorsPanel'));
    return;
  }

  log('üîç renderVendorsV2():', {
    totalVendors: vendorsV2.length,
    currentFilter: currentCategoryFilter,
    vendors: vendorsV2
  });

  const filtered = currentCategoryFilter === 'ALL'
    ? vendorsV2
    : vendorsV2.filter(v => v.category_id === currentCategoryFilter);

  log('üîç „Éï„Ç£„É´„Çø„ÉºÂæå„ÅÆÊ•≠ËÄÖÊï∞:', filtered.length);

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><p>Ê•≠ËÄÖ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì<br><small>„Äå+ Ê•≠ËÄÖËøΩÂä†„Äç„Éú„Çø„É≥„Åã„ÇâÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small></p></div>';
    return;
  }

  container.innerHTML = filtered.map(vendor => {
    const categoryName = vendor.vendor_categories?.name || 'Êú™ÂàÜÈ°û';
    return `
      <div class="vendor-card">
        <div class="vendor-header">
          <h3>${escapeHtml(vendor.company)}</h3>
          <span class="badge badge-primary">${escapeHtml(categoryName)}</span>
        </div>
        <div class="vendor-info">
          <div><strong>ÊãÖÂΩìËÄÖ:</strong> ${escapeHtml(vendor.contact || '-')}</div>
          <div><strong>TEL:</strong> ${escapeHtml(vendor.tel || '-')}</div>
          <div><strong>Email:</strong> ${escapeHtml(vendor.email || '-')}</div>
        </div>
        <div class="vendor-actions">
          <button class="btn btn-secondary btn-small" onclick="editVendorV2('${vendor.id}')">Á∑®ÈõÜ</button>
          <button class="btn btn-danger btn-small" onclick="deleteVendorV2('${vendor.id}')">ÂâäÈô§</button>
        </div>
      </div>
    `;
  }).join('');
}

function setCategoryFilter(categoryId, e) {
  currentCategoryFilter = categoryId;
  document.querySelectorAll('.category-filter-btn').forEach(btn => btn.classList.remove('active'));
  if (e && e.target) {
    e.target.classList.add('active');
  }
  renderVendorsV2();
}

function openVendorModalV2(vendorId = null) {
  const modal = document.getElementById('vendorModalV2');
  const title = document.getElementById('vendorModalTitle');

  // „Ç´„ÉÜ„Ç¥„É™„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞
  populateVendorCategoryDropdown();

  if (vendorId) {
    const vendor = vendorsV2.find(v => v.id === vendorId);
    if (!vendor) return;

    title.textContent = 'Ê•≠ËÄÖÁ∑®ÈõÜ';
    document.getElementById('vendorId').value = vendor.id;
    document.getElementById('vendorCompany').value = vendor.company;
    document.getElementById('vendorContact').value = vendor.contact || '';
    document.getElementById('vendorTel').value = vendor.tel || '';
    document.getElementById('vendorEmail').value = vendor.email || '';
    document.getElementById('vendorCategory').value = vendor.category_id || '';
    document.getElementById('vendorSubject').value = vendor.subject_format || '';
    document.getElementById('vendorTemplate').value = vendor.template_text || '';
  } else {
    title.textContent = 'Ê•≠ËÄÖËøΩÂä†';
    document.getElementById('vendorForm').reset();
    document.getElementById('vendorId').value = '';
  }

  ModalManager.open(modal, '#vendorCompany');
}

function closeVendorModalV2() {
  ModalManager.close(document.getElementById('vendorModalV2'));
}

async function saveVendorV2() {
  // ‰∫åÈáç„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢
  if (SaveGuard.isLocked('saveVendorV2')) return;

  const id = document.getElementById('vendorId').value;
  const company = document.getElementById('vendorCompany').value.trim();
  const contact = document.getElementById('vendorContact').value.trim();
  const tel = document.getElementById('vendorTel').value.trim();
  const email = document.getElementById('vendorEmail').value.trim();
  const categoryId = document.getElementById('vendorCategory').value;
  const subjectFormat = document.getElementById('vendorSubject').value.trim();
  const templateText = document.getElementById('vendorTemplate').value.trim();

  if (!company) {
    showToast('‰ºöÁ§æÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (!categoryId) {
    showToast('„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  await SaveGuard.run('saveVendorV2', async () => {
    showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

    const vendorData = {
      company,
      contact: contact || null,
      tel: tel || null,
      email: email || null,
      category_id: categoryId || null,
      subject_format: subjectFormat || null,
      template_text: templateText || null
    };

    let result;
    if (id) {
      result = await supabase
        .from('vendors_v2')
        .update(vendorData)
        .eq('id', id)
        .select('*, vendor_categories(name)');
    } else {
      result = await supabase
        .from('vendors_v2')
        .insert([vendorData])
        .select('*, vendor_categories(name)');
    }

    if (result.error) {
      showStatus('‰øùÂ≠òÂ§±Êïó', 'error');
      showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error.message, 'error');
      return;
    }

    showStatus('‰øùÂ≠òÂÆå‰∫Ü', 'success');
    showToast(id ? 'Ê•≠ËÄÖ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü' : 'Ê•≠ËÄÖ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
    closeVendorModalV2();
    await loadVendorsV2();
    mergeVendorCategories(); // „Ç´„ÉÜ„Ç¥„É™ÊÉÖÂ†±„Çí„Éû„Éº„Ç∏
    renderVendorsV2();
  });
}

function editVendorV2(vendorId) {
  openVendorModalV2(vendorId);
}

async function deleteVendorV2(vendorId) {
  const vendor = vendorsV2.find(v => v.id === vendorId);
  if (!vendor) return;

  if (!confirm(`„Äå${vendor.company}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

  await SaveGuard.run(`deleteVendor_${vendorId}`, async () => {
    showStatus('ÂâäÈô§‰∏≠...', 'saving');

    const { error } = await supabase
      .from('vendors_v2')
      .delete()
      .eq('id', vendorId);

    if (error) {
      showStatus('ÂâäÈô§Â§±Êïó', 'error');
      showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    showStatus('ÂâäÈô§ÂÆå‰∫Ü', 'success');
    showToast('Ê•≠ËÄÖ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
    await loadVendorsV2();
    renderVendorsV2();
  });
}

// ============================================
// „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ
// ============================================
function renderCategoriesList() {
  const container = document.getElementById('categoriesGrid');
  if (!container) return;

  if (vendorCategories.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üè∑Ô∏è</div><p>„Ç´„ÉÜ„Ç¥„É™„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p></div>';
    return;
  }

  // Ë°®Á§∫È†Ü„Åß„ÇΩ„Éº„Éà
  const sortedCategories = [...vendorCategories].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>„Ç´„ÉÜ„Ç¥„É™Âêç</th>
            <th style="width: 100px;">Ê•≠ËÄÖÊï∞</th>
            <th style="width: 180px;">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody>
          ${sortedCategories.map(cat => {
            const count = vendorsV2.filter(v => v.category_id === cat.id).length;
            return `
              <tr draggable="true" ondragstart="handleCategoryDragStart(event, '${cat.id}')" ondragover="handleCategoryDragOver(event)" ondrop="handleCategoryDrop(event, '${cat.id}')" style="cursor: move;">
                <td><span style="color: var(--text-muted);">‚ãÆ‚ãÆ</span></td>
                <td><strong>${cat.name}</strong></td>
                <td>${count}Á§æ</td>
                <td>
                  <button class="btn btn-secondary btn-small" onclick="editCategory('${cat.id}')">Á∑®ÈõÜ</button>
                  <button class="btn btn-danger btn-small" onclick="deleteCategory('${cat.id}')">ÂâäÈô§</button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function openCategoryModal(categoryId = null) {
  const modal = document.getElementById('categoryModal');
  const title = document.getElementById('categoryModalTitle');

  if (categoryId) {
    const category = vendorCategories.find(c => c.id === categoryId);
    if (!category) return;

    title.textContent = '„Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ';
    document.getElementById('categoryId').value = category.id;
    document.getElementById('categoryName').value = category.name;
    document.getElementById('categoryOrder').value = category.display_order;
  } else {
    title.textContent = '„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†';
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryId').value = '';
    document.getElementById('categoryOrder').value = vendorCategories.length + 1;
  }

  ModalManager.open(modal, '#categoryName');
}

function closeCategoryModal() {
  ModalManager.close(document.getElementById('categoryModal'));
}

async function saveCategory() {
  if (SaveGuard.isLocked('saveCategory')) return;

  const id = document.getElementById('categoryId').value;
  const name = document.getElementById('categoryName').value.trim();
  const order = parseInt(document.getElementById('categoryOrder').value) || 0;

  if (!name) {
    showToast('„Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  await SaveGuard.run('saveCategory', async () => {
    showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

    const categoryData = {
      name,
      display_order: order
    };

    let result;
    if (id) {
      result = await supabase
        .from('vendor_categories')
        .update(categoryData)
        .eq('id', id)
        .select();
    } else {
      result = await supabase
        .from('vendor_categories')
        .insert([categoryData])
        .select();
    }

    if (result.error) {
      showStatus('‰øùÂ≠òÂ§±Êïó', 'error');
      showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error.message, 'error');
      return;
    }

    showStatus('‰øùÂ≠òÂÆå‰∫Ü', 'success');
    showToast(id ? '„Ç´„ÉÜ„Ç¥„É™„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü' : '„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
    closeCategoryModal();
    await loadVendorCategories();
    renderCategoriesList();
    renderCategoryFilters();
  });
}

function editCategory(categoryId) {
  openCategoryModal(categoryId);
}

async function deleteCategory(categoryId) {
  const category = vendorCategories.find(c => c.id === categoryId);
  if (!category) return;

  const vendorCount = vendorsV2.filter(v => v.category_id === categoryId).length;
  if (vendorCount > 0) {
    showToast(`„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´„ÅØ${vendorCount}Á§æ„ÅÆÊ•≠ËÄÖ„ÅåÁ¥ê„Å•„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇÂÖà„Å´Ê•≠ËÄÖ„ÇíÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`, 'error');
    return;
  }

  if (!confirm(`„Ç´„ÉÜ„Ç¥„É™„Äå${category.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

  await SaveGuard.run(`deleteCategory_${categoryId}`, async () => {
    showStatus('ÂâäÈô§‰∏≠...', 'saving');

    const { error } = await supabase
      .from('vendor_categories')
      .delete()
      .eq('id', categoryId);

    if (error) {
      showStatus('ÂâäÈô§Â§±Êïó', 'error');
      showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    showStatus('ÂâäÈô§ÂÆå‰∫Ü', 'success');
    showToast('„Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
    await loadVendorCategories();
    renderCategoriesList();
    renderCategoryFilters();
  });
}

// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åß„Ç´„ÉÜ„Ç¥„É™„ÅÆË°®Á§∫È†Ü„ÇíÂ§âÊõ¥
let draggedCategoryId = null;

function handleCategoryDragStart(event, categoryId) {
  draggedCategoryId = categoryId;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.5';
}

function handleCategoryDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  return false;
}

async function handleCategoryDrop(event, targetCategoryId) {
  event.preventDefault();
  event.stopPropagation();

  if (!draggedCategoryId || draggedCategoryId === targetCategoryId) {
    resetCategoryDragState();
    return;
  }

  const draggedCategory = vendorCategories.find(c => c.id === draggedCategoryId);
  const targetCategory = vendorCategories.find(c => c.id === targetCategoryId);

  if (!draggedCategory || !targetCategory) {
    resetCategoryDragState();
    return;
  }

  // Ë°®Á§∫È†Ü„ÇíÂÖ•„ÇåÊõø„Åà
  const draggedOrder = draggedCategory.display_order;
  const targetOrder = targetCategory.display_order;

  showStatus('‰∏¶„Å≥Êõø„Åà‰∏≠...', 'saving');

  // ‰∏°Êñπ„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅÆË°®Á§∫È†Ü„ÇíÊõ¥Êñ∞
  const updates = [
    supabase.from('vendor_categories').update({ display_order: targetOrder }).eq('id', draggedCategoryId),
    supabase.from('vendor_categories').update({ display_order: draggedOrder }).eq('id', targetCategoryId)
  ];

  const results = await Promise.all(updates);

  if (results.some(r => r.error)) {
    showStatus('‰∏¶„Å≥Êõø„ÅàÂ§±Êïó', 'error');
    showToast('‰∏¶„Å≥Êõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    resetCategoryDragState();
    return;
  }

  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
  draggedCategory.display_order = targetOrder;
  targetCategory.display_order = draggedOrder;

  // ÂÜçÊèèÁîª
  renderCategoriesList();
  renderCategoryFilters();
  showStatus('‰∏¶„Å≥Êõø„ÅàÂÆå‰∫Ü', 'success');
  showToast('Ë°®Á§∫È†Ü„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü', 'success');
  resetCategoryDragState();
}

function resetCategoryDragState() {
  draggedCategoryId = null;
  // „Åô„Åπ„Å¶„ÅÆË°å„ÅÆÈÄèÊòéÂ∫¶„Çí„É™„Çª„ÉÉ„Éà
  document.querySelectorAll('#categoriesGrid tr[draggable]').forEach(tr => {
    tr.style.opacity = '1';
  });
}

function renderCategoryFilters() {
  const container = document.getElementById('categoryFilters');
  if (!container) return;

  let html = `<button class="category-filter-btn ${currentCategoryFilter === 'ALL' ? 'active' : ''}" onclick="setCategoryFilter('ALL', event)">ÂÖ®„Å¶ (${vendorsV2.length})</button>`;

  vendorCategories.forEach(cat => {
    const count = vendorsV2.filter(v => v.category_id === cat.id).length;
    html += `<button class="category-filter-btn ${currentCategoryFilter === cat.id ? 'active' : ''}" onclick="setCategoryFilter('${cat.id}', event)">${escapeHtml(cat.name)} (${count})</button>`;
  });

  container.innerHTML = html;
}

// ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Éº„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÂàùÊúüÂåñ
function populateAssigneeFilters() {
  // ICÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Éº
  const icFilter = document.getElementById('icAssigneeFilter');
  if (icFilter) {
    const icAssignees = [...new Set(projects.map(p => p.ic_assignee).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ja'));
    icFilter.innerHTML = '<option value="">ICÊãÖÂΩì: „Åô„Åπ„Å¶</option>' + icAssignees.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
  }

  // Â§ñÊßãÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Éº
  const exteriorFilter = document.getElementById('exteriorAssigneeFilter');
  if (exteriorFilter) {
    const exteriorAssignees = [...new Set(projects.map(p => p.exterior_assignee).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ja'));
    exteriorFilter.innerHTML = '<option value="">Â§ñÊßãÊãÖÂΩì: „Åô„Åπ„Å¶</option>' + exteriorAssignees.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
  }

  // ‰∏çÂãïÁî£ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Éº
  const realestateFilter = document.getElementById('realestateAssigneeFilter');
  if (realestateFilter) {
    const realestateAssignees = [...new Set(projects.map(p => p.realestate_assignee).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ja'));
    realestateFilter.innerHTML = '<option value="">‰∏çÂãïÁî£ÊãÖÂΩì: „Åô„Åπ„Å¶</option>' + realestateAssignees.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
  }
}

// ============================================
// ÂïÜÂìÅÁÆ°ÁêÜ
// ============================================
function renderProductsList() {
  const container = document.getElementById('productsGrid');
  if (!container) return;

  if (products.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><p>ÂïÜÂìÅ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p></div>';
    return;
  }

  // Ë°®Á§∫È†Ü„Åß„ÇΩ„Éº„Éà
  const sortedProducts = [...products].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));

  container.innerHTML = '<div class="table-container"><table class="table"><thead><tr><th style="width: 60px;"></th><th>ÂïÜÂìÅÂêç</th><th style="width: 100px;">Êìç‰Ωú</th></tr></thead><tbody>' +
    sortedProducts.map(product => `
      <tr draggable="true" ondragstart="handleProductDragStart(event, '${product.id}')" ondragover="handleProductDragOver(event)" ondrop="handleProductDrop(event, '${product.id}')" style="cursor: move;">
        <td><span style="color: var(--text-muted);">‚ãÆ‚ãÆ</span></td>
        <td><strong>${escapeHtml(product.name)}</strong></td>
        <td><button class="btn btn-danger btn-small" onclick="deleteProductInline('${product.id}')">ÂâäÈô§</button></td>
      </tr>
    `).join('') +
    '</tbody></table></div>';
}

async function addProductInline() {
  const name = document.getElementById('newProductNameInline').value.trim();

  if (!name) {
    showToast('ÂïÜÂìÅÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (products.find(p => p.name === name)) {
    showToast('Êó¢„Å´Â≠òÂú®„Åô„ÇãÂïÜÂìÅÂêç„Åß„Åô', 'error');
    return;
  }

  showStatus('ËøΩÂä†‰∏≠...', 'saving');

  const maxDisplayOrder = products.length > 0 ? Math.max(...products.map(p => p.display_order || 0)) : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('products')
    .insert([{ name, display_order: newDisplayOrder }])
    .select();

  if (error) {
    // „ÉÜ„Éº„Éñ„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÄÅ„É≠„Éº„Ç´„É´„Å´ËøΩÂä†
    products.push({ id: Date.now().toString(), name, display_order: newDisplayOrder });
    document.getElementById('newProductNameInline').value = '';
    renderProductsList();
    populateProductDropdown();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast('ÂïÜÂìÅ„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºà„É≠„Éº„Ç´„É´„ÅÆ„ÅøÔºâ', 'success');
    return;
  }

  products.push(data[0]);
  document.getElementById('newProductNameInline').value = '';
  renderProductsList();
  populateProductDropdown();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('ÂïÜÂìÅ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
}

async function deleteProductInline(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;

  if (!confirm(`ÂïÜÂìÅ„Äå${product.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

  showStatus('ÂâäÈô§‰∏≠...', 'saving');

  const { error } = await supabase
    .from('products')
    .delete()
    .eq('id', productId);

  if (error && !error.message.includes('does not exist')) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  products = products.filter(p => p.id !== productId);
  renderProductsList();
  populateProductDropdown();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('ÂïÜÂìÅ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÂïÜÂìÅ„ÅÆË°®Á§∫È†Ü„ÇíÂ§âÊõ¥
let draggedProductId = null;

function handleProductDragStart(event, productId) {
  draggedProductId = productId;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.5';
}

function handleProductDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  return false;
}

async function handleProductDrop(event, targetProductId) {
  event.preventDefault();
  event.stopPropagation();

  if (!draggedProductId || draggedProductId === targetProductId) {
    resetProductDragState();
    return;
  }

  const draggedProduct = products.find(p => p.id === draggedProductId);
  const targetProduct = products.find(p => p.id === targetProductId);

  if (!draggedProduct || !targetProduct) {
    resetProductDragState();
    return;
  }

  // Ë°®Á§∫È†Ü„ÇíÂÖ•„ÇåÊõø„Åà
  const draggedOrder = draggedProduct.display_order;
  const targetOrder = targetProduct.display_order;

  showStatus('‰∏¶„Å≥Êõø„Åà‰∏≠...', 'saving');

  // ‰∏°Êñπ„ÅÆÂïÜÂìÅ„ÅÆË°®Á§∫È†Ü„ÇíÊõ¥Êñ∞
  const updates = [
    supabase.from('products').update({ display_order: targetOrder }).eq('id', draggedProductId),
    supabase.from('products').update({ display_order: draggedOrder }).eq('id', targetProductId)
  ];

  const results = await Promise.all(updates);

  if (results.some(r => r.error)) {
    // „Ç®„É©„Éº„Åå„ÅÇ„Å£„Å¶„ÇÇ„É≠„Éº„Ç´„É´„ÅßÊõ¥Êñ∞
    draggedProduct.display_order = targetOrder;
    targetProduct.display_order = draggedOrder;
    renderProductsList();
    populateProductDropdown();
    showStatus('‰∏¶„Å≥Êõø„ÅàÂÆå‰∫Ü', 'success');
    showToast('Ë°®Á§∫È†Ü„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„ÅüÔºà„É≠„Éº„Ç´„É´„ÅÆ„ÅøÔºâ', 'success');
    resetProductDragState();
    return;
  }

  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
  draggedProduct.display_order = targetOrder;
  targetProduct.display_order = draggedOrder;

  // ÂÜçÊèèÁîª
  renderProductsList();
  populateProductDropdown();
  showStatus('‰∏¶„Å≥Êõø„ÅàÂÆå‰∫Ü', 'success');
  showToast('Ë°®Á§∫È†Ü„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü', 'success');
  resetProductDragState();
}

function resetProductDragState() {
  draggedProductId = null;
  // „Åô„Åπ„Å¶„ÅÆË°å„ÅÆÈÄèÊòéÂ∫¶„Çí„É™„Çª„ÉÉ„Éà
  document.querySelectorAll('#productsGrid tr[draggable]').forEach(tr => {
    tr.style.opacity = '1';
  });
}

function populateProductDropdown() {
  const select = document.getElementById('projectSpecifications');
  if (!select) return;

  const currentValue = select.value;
  select.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' +
    products.map(p => `<option value="${escapeHtml(p.name)}">${escapeHtml(p.name)}</option>`).join('');

  if (currentValue) select.value = currentValue;
}

// ============================================
// „Çø„Çπ„ÇØÁÆ°ÁêÜÔºàË®≠Ë®à„ÉªICÂàÜÈõ¢Ôºâ
// ============================================
function renderTasksManagement() {
  const container = document.getElementById('tasksGrid');
  if (!container) return;

  const sekkeiTasks = tasksV2.filter(t => t.category === 'Ë®≠Ë®à');

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>„Çø„Çπ„ÇØÂêç</th>
            <th style="width: 100px;">Áä∂ÊÖãÁÆ°ÁêÜ</th>
            <th style="width: 120px;">üìß„Éú„Çø„É≥</th>
            <th>Á¥ê„Å•„ÅëÊ•≠ËÄÖ</th>
            <th style="width: 180px;">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody id="sekkeiTasksBody">
          ${sekkeiTasks.map(task => renderTaskRow(task)).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
        üìê Ë®≠Ë®à„Çø„Çπ„ÇØ: ${sekkeiTasks.length}‰ª∂ÁôªÈå≤Ê∏à„Åø
      </p>
    </div>
  `;
}

function renderIcTasksManagement() {
  const container = document.getElementById('icTasksGrid');
  if (!container) return;

  const icTasks = tasksV2.filter(t => t.category === 'IC');

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>„Çø„Çπ„ÇØÂêç</th>
            <th style="width: 100px;">Áä∂ÊÖãÁÆ°ÁêÜ</th>
            <th style="width: 120px;">üìß„Éú„Çø„É≥</th>
            <th>Á¥ê„Å•„ÅëÊ•≠ËÄÖ</th>
            <th style="width: 180px;">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody id="icTasksBody">
          ${icTasks.map(task => renderTaskRow(task)).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
        üé® IC„Çø„Çπ„ÇØ: ${icTasks.length}‰ª∂ÁôªÈå≤Ê∏à„Åø
      </p>
    </div>
  `;
}

function renderTaskRow(task) {
  const mappings = taskVendorMappings.filter(m => m.task_id === task.id);
  const vendorNames = mappings.map(m => {
    const vendor = vendorsV2.find(v => v.id === m.vendor_id);
    return vendor ? vendor.company : '‰∏çÊòé';
  }).join(', ');

  const stateInfo = task.has_state ?
    `<span class="badge badge-success">„ÅÇ„Çä</span>` :
    `<span class="badge badge-secondary">„Å™„Åó</span>`;

  const emailButtonInfo = task.has_email_button ?
    `<span class="badge badge-success">Ë°®Á§∫</span>` :
    `<span class="badge badge-secondary">ÈùûË°®Á§∫</span>`;

  return `
    <tr draggable="true" ondragstart="handleTaskDragStart(event, '${task.id}')" ondragover="handleTaskDragOver(event)" ondrop="handleTaskDrop(event, '${task.id}')" style="cursor: move;">
      <td><span style="color: var(--text-muted);">‚ãÆ‚ãÆ</span></td>
      <td><strong>${escapeHtml(task.task_name)}</strong></td>
      <td>${stateInfo}</td>
      <td>${emailButtonInfo}</td>
      <td>${escapeHtml(vendorNames || '-')}</td>
      <td>
        <button class="btn btn-secondary btn-small" onclick="editTask('${task.id}')">Á∑®ÈõÜ</button>
        <button class="btn btn-danger btn-small" onclick="deleteTask('${task.id}')">ÂâäÈô§</button>
      </td>
    </tr>
  `;
}

// ============================================
// Â§ñÊßãÊ•≠ÂãôÁÆ°ÁêÜ
// ============================================
// Â§ñÊßã„Çø„Çπ„ÇØ„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂÆöÁæ©
const defaultExteriorTasks = [
  { id: 'ext_hearing', name: '„Éí„Ç¢„É™„É≥„Ç∞', order: 1, states: ['Êú™ÁùÄÊâã', 'ÂÆå‰∫Ü'] },
  { id: 'ext_site_survey', name: 'ÁèæÂú∞Ë™øÊüª', order: 2, states: ['Êú™ÁùÄÊâã', 'Ë™øÊüªÊ∏à', 'Â†±ÂëäÊ∏à'] },
  { id: 'ext_first_proposal', name: 'ÂàùÂõûÊèêÊ°à', order: 3, states: ['Êú™ÁùÄÊâã', '‰ΩúÊàê‰∏≠', 'ÊèêÂá∫Ê∏à', 'ÊâøË™ç'] },
  { id: 'ext_estimate', name: 'Ë¶ãÁ©ç‰ΩúÊàê', order: 4, states: ['Êú™ÁùÄÊâã', '‰ΩúÊàê‰∏≠', 'ÊèêÂá∫Ê∏à', 'ÊâøË™ç'] },
  { id: 'ext_final_design', name: 'ÊúÄÁµÇË®≠Ë®à', order: 5, states: ['Êú™ÁùÄÊâã', '‰ΩúÊàê‰∏≠', 'Á¢∫ÂÆö'] },
  { id: 'ext_material_order', name: 'Ë≥áÊùêÁô∫Ê≥®', order: 6, states: ['Êú™ÁùÄÊâã', 'Áô∫Ê≥®Ê∏à', 'Á¥çÂìÅÊ∏à'] },
  { id: 'ext_construction', name: 'ÊñΩÂ∑•', order: 7, states: ['Êú™ÁùÄÊâã', 'ÁùÄÂ∑•', 'ÈÄ≤Ë°å‰∏≠', 'ÂÆåÂ∑•'] },
  { id: 'ext_inspection', name: 'ÂÆå‰∫ÜÊ§úÊüª', order: 8, states: ['Êú™ÁùÄÊâã', 'Ê§úÊüªÊ∏à', 'ÂºïÊ∏°ÂÆå‰∫Ü'] }
];

// Â§ñÊßã„Çø„Çπ„ÇØ„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„Åø
let exteriorTasks = safeJsonParse(localStorage.getItem('exteriorTasks'), defaultExteriorTasks);

function renderExteriorTasksManagement() {
  const container = document.getElementById('exteriorTasksGrid');
  if (!container) return;

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>„Çø„Çπ„ÇØÂêç</th>
            <th>„Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éó„Ç∑„Éß„É≥</th>
            <th style="width: 180px;">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody>
          ${exteriorTasks.map(task => `
            <tr>
              <td><span style="color: var(--text-muted);">‚ãÆ‚ãÆ</span></td>
              <td><strong>${task.name}</strong></td>
              <td>
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                  ${task.states.map(s => `<span class="badge badge-secondary">${s}</span>`).join('')}
                </div>
              </td>
              <td>
                <button class="btn btn-secondary btn-small" onclick="editExteriorTask('${task.id}')">Á∑®ÈõÜ</button>
                <button class="btn btn-danger btn-small" onclick="deleteExteriorTask('${task.id}')">ÂâäÈô§</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
        üí° Â§ñÊßãÊ•≠Âãô„Çø„Çπ„ÇØ„ÅØÊ°à‰ª∂„Ç´„Éº„Éâ„ÅÆ„ÄåÂ§ñÊßã‰æùÈ†º„Äç„Çª„ÇØ„Ç∑„Éß„É≥„Åß‰ΩøÁî®„Åï„Çå„Åæ„Åô„ÄÇ
        ÂêÑ„Çø„Çπ„ÇØ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíË®≠ÂÆö„Åó„Å¶„ÄÅÂ§ñÊßãË®≠Ë®à„ÅÆÈÄ≤Êçó„ÇíÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô„ÄÇ
      </p>
    </div>
  `;
}

function openExteriorTaskModal(taskId = null) {
  const name = taskId ? exteriorTasks.find(t => t.id === taskId)?.name : '';
  const states = taskId ? exteriorTasks.find(t => t.id === taskId)?.states.join(', ') : 'Êú™ÁùÄÊâã, ÂÆå‰∫Ü';

  const newName = prompt('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ:', name);
  if (!newName) return;

  const newStates = prompt('„Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éó„Ç∑„Éß„É≥Ôºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ:', states);
  if (!newStates) return;

  const statesArray = newStates.split(',').map(s => s.trim()).filter(s => s);

  if (taskId) {
    const task = exteriorTasks.find(t => t.id === taskId);
    if (task) {
      task.name = newName;
      task.states = statesArray;
    }
  } else {
    exteriorTasks.push({
      id: 'ext_' + Date.now(),
      name: newName,
      order: exteriorTasks.length + 1,
      states: statesArray
    });
  }

  localStorage.setItem('exteriorTasks', JSON.stringify(exteriorTasks));
  renderExteriorTasksManagement();
  showToast('Â§ñÊßã„Çø„Çπ„ÇØ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

function editExteriorTask(taskId) {
  openExteriorTaskModal(taskId);
}

function deleteExteriorTask(taskId) {
  if (!confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  exteriorTasks = exteriorTasks.filter(t => t.id !== taskId);
  localStorage.setItem('exteriorTasks', JSON.stringify(exteriorTasks));
  renderExteriorTasksManagement();
  showToast('„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

// ‰∏çÂãïÁî£„Éá„Éï„Ç©„É´„Éà„Çø„Çπ„ÇØÂÆöÁæ©
const defaultRealestateTasks = [
  { id: 'real_hearing', name: '„Éí„Ç¢„É™„É≥„Ç∞', order: 1, states: ['Êú™ÁùÄÊâã', 'ÂÆüÊñΩ‰∏≠', 'ÂÆå‰∫Ü'] },
  { id: 'real_search', name: 'Áâ©‰ª∂Ê§úÁ¥¢', order: 2, states: ['Êú™ÁùÄÊâã', 'Ê§úÁ¥¢‰∏≠', 'ÂÄôË£ú„ÅÇ„Çä', 'ÂÆå‰∫Ü'] },
  { id: 'real_inspection', name: 'Áâ©‰ª∂ÂÜÖË¶ã', order: 3, states: ['Êú™ÁùÄÊâã', 'Êó•Á®ãË™øÊï¥‰∏≠', 'ÂÜÖË¶ãÊ∏à', 'ÂÆå‰∫Ü'] },
  { id: 'real_proposal', name: 'ÊèêÊ°à', order: 4, states: ['Êú™ÁùÄÊâã', 'Ë≥áÊñô‰ΩúÊàê‰∏≠', 'ÊèêÊ°àÊ∏à', 'ÊâøË™ç'] },
  { id: 'real_negotiation', name: '‰∫§Ê∏â', order: 5, states: ['Êú™ÁùÄÊâã', '‰∫§Ê∏â‰∏≠', 'ÂêàÊÑè', 'ÂÆå‰∫Ü'] },
  { id: 'real_contract', name: 'Â•ëÁ¥Ñ', order: 6, states: ['Êú™ÁùÄÊâã', 'Êõ∏È°ûÊ∫ñÂÇô', 'Â•ëÁ¥ÑÊ∏à', 'ÂÆå‰∫Ü'] },
  { id: 'real_loan', name: '„É≠„Éº„É≥ÊâãÁ∂ö„Åç', order: 7, states: ['Êú™ÁùÄÊâã', 'Áî≥Ëæº‰∏≠', 'ÂØ©Êüª‰∏≠', 'ÊâøË™ç', 'ÂÆå‰∫Ü'] },
  { id: 'real_settlement', name: 'Ê±∫Ê∏à„ÉªÂºïÊ∏°', order: 8, states: ['Êú™ÁùÄÊâã', 'Ê∫ñÂÇô‰∏≠', 'Ê±∫Ê∏àÂÆå‰∫Ü', 'ÂºïÊ∏°ÂÆå‰∫Ü'] }
];

// ‰∏çÂãïÁî£„Çø„Çπ„ÇØ„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„Åø
let realestateTasks = safeJsonParse(localStorage.getItem('realestateTasks'), defaultRealestateTasks);

// Â∑•‰∫ã„Éá„Éï„Ç©„É´„Éà„Çø„Çπ„ÇØÂÆöÁæ©
const defaultConstructionTasks = [
  { id: 'const_hearing', name: '„Éí„Ç¢„É™„É≥„Ç∞', order: 1, states: ['Êú™ÁùÄÊâã', 'ÂÆüÊñΩ‰∏≠', 'ÂÆå‰∫Ü'] },
  { id: 'const_survey', name: 'ÁèæÂú∞Ë™øÊüª', order: 2, states: ['Êú™ÁùÄÊâã', 'Ë™øÊüªÊ∏à', 'Â†±ÂëäÊ∏à'] },
  { id: 'const_estimate', name: 'Ë¶ãÁ©ç‰ΩúÊàê', order: 3, states: ['Êú™ÁùÄÊâã', '‰ΩúÊàê‰∏≠', 'ÊèêÂá∫Ê∏à', 'ÊâøË™ç'] },
  { id: 'const_contract', name: 'Â∑•‰∫ãÂ•ëÁ¥Ñ', order: 4, states: ['Êú™ÁùÄÊâã', 'Ë™øÊï¥‰∏≠', 'Â•ëÁ¥ÑÊ∏à'] },
  { id: 'const_permit', name: 'Â±äÂá∫„ÉªË®±ÂèØ', order: 5, states: ['Êú™ÁùÄÊâã', 'Áî≥Ë´ã‰∏≠', 'Ë®±ÂèØÊ∏à'] },
  { id: 'const_order', name: 'Ë≥áÊùêÁô∫Ê≥®', order: 6, states: ['Êú™ÁùÄÊâã', 'Áô∫Ê≥®Ê∏à', 'Á¥çÂìÅÊ∏à'] },
  { id: 'const_start', name: 'ÁùÄÂ∑•', order: 7, states: ['Êú™ÁùÄÊâã', 'Ê∫ñÂÇô‰∏≠', 'ÁùÄÂ∑•Ê∏à'] },
  { id: 'const_progress', name: 'ÊñΩÂ∑•', order: 8, states: ['Êú™ÁùÄÊâã', 'Âü∫Á§éÂ∑•‰∫ã', 'Ë∫Ø‰ΩìÂ∑•‰∫ã', '‰ªï‰∏äÂ∑•‰∫ã', 'ÂÆå‰∫Ü'] },
  { id: 'const_inspection', name: 'ÂÆå‰∫ÜÊ§úÊüª', order: 9, states: ['Êú™ÁùÄÊâã', 'Ê§úÊüª‰∫àÁ¥Ñ', 'Ê§úÊüªÊ∏à', 'ÊòØÊ≠£ÂÆå‰∫Ü'] },
  { id: 'const_handover', name: 'ÂºïÊ∏°„Åó', order: 10, states: ['Êú™ÁùÄÊâã', 'ÊúÄÁµÇÁ¢∫Ë™ç', 'ÂºïÊ∏°ÂÆå‰∫Ü'] }
];

// Â∑•‰∫ã„Çø„Çπ„ÇØ„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„Åø
let constructionTasks = safeJsonParse(localStorage.getItem('constructionTasks'), defaultConstructionTasks);

// ‰∏çÂãïÁî£Ê•≠ÂãôÁÆ°ÁêÜ
function renderRealestateTasksManagement() {
  const container = document.getElementById('realestateTasksGrid');
  if (!container) return;

  container.innerHTML = `
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th style="width: 40px;">È†ÜÂ∫è</th>
            <th>„Çø„Çπ„ÇØÂêç</th>
            <th>„Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éó„Ç∑„Éß„É≥</th>
            <th style="width: 150px;">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody>
          ${realestateTasks.map((task, index) => `
            <tr>
              <td>${index + 1}</td>
              <td><strong>${task.name}</strong></td>
              <td>
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                  ${task.states.map(s => `<span class="badge badge-secondary">${s}</span>`).join('')}
                </div>
              </td>
              <td>
                <button class="btn btn-secondary btn-small" onclick="editRealestateTask('${task.id}')">Á∑®ÈõÜ</button>
                <button class="btn btn-danger btn-small" onclick="deleteRealestateTask('${task.id}')">ÂâäÈô§</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
        üí° ‰∏çÂãïÁî£Ê•≠Âãô„Çø„Çπ„ÇØ„ÅØÊ°à‰ª∂„Ç´„Éº„Éâ„ÅÆ„Äå‰∏çÂãïÁî£Ê•≠ÂãôÂÜÖÂÆπ„Äç„Çª„ÇØ„Ç∑„Éß„É≥„Åß‰ΩøÁî®„Åï„Çå„Åæ„Åô„ÄÇ
      </p>
    </div>
  `;
}

function openRealestateTaskModal(taskId = null) {
  const name = taskId ? realestateTasks.find(t => t.id === taskId)?.name : '';
  const states = taskId ? realestateTasks.find(t => t.id === taskId)?.states.join(', ') : 'Êú™ÁùÄÊâã, ÂÆå‰∫Ü';

  const newName = prompt('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ:', name);
  if (!newName) return;

  const newStates = prompt('„Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éó„Ç∑„Éß„É≥Ôºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ:', states);
  if (!newStates) return;

  const statesArray = newStates.split(',').map(s => s.trim()).filter(s => s);

  if (taskId) {
    const task = realestateTasks.find(t => t.id === taskId);
    if (task) {
      task.name = newName;
      task.states = statesArray;
    }
  } else {
    realestateTasks.push({
      id: 're_' + Date.now(),
      name: newName,
      order: realestateTasks.length + 1,
      states: statesArray
    });
  }

  localStorage.setItem('realestateTasks', JSON.stringify(realestateTasks));
  renderRealestateTasksManagement();
  showToast('‰∏çÂãïÁî£„Çø„Çπ„ÇØ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

function editRealestateTask(taskId) {
  openRealestateTaskModal(taskId);
}

function deleteRealestateTask(taskId) {
  if (!confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  realestateTasks = realestateTasks.filter(t => t.id !== taskId);
  localStorage.setItem('realestateTasks', JSON.stringify(realestateTasks));
  renderRealestateTasksManagement();
  showToast('„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

// Â∑•‰∫ãÊ•≠ÂãôÁÆ°ÁêÜ
function renderConstructionTasksManagement() {
  const container = document.getElementById('constructionTasksGrid');
  if (!container) return;

  container.innerHTML = `
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th style="width: 40px;">È†ÜÂ∫è</th>
            <th>„Çø„Çπ„ÇØÂêç</th>
            <th>„Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éó„Ç∑„Éß„É≥</th>
            <th style="width: 150px;">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody>
          ${constructionTasks.map((task, index) => `
            <tr>
              <td>${index + 1}</td>
              <td><strong>${task.name}</strong></td>
              <td>
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                  ${task.states.map(s => `<span class="badge badge-secondary">${s}</span>`).join('')}
                </div>
              </td>
              <td>
                <button class="btn btn-secondary btn-small" onclick="editConstructionTask('${task.id}')">Á∑®ÈõÜ</button>
                <button class="btn btn-danger btn-small" onclick="deleteConstructionTask('${task.id}')">ÂâäÈô§</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
        üí° Â∑•‰∫ãÊ•≠Âãô„Çø„Çπ„ÇØ„ÅØÊ°à‰ª∂„Ç´„Éº„Éâ„ÅÆ„ÄåÂ∑•‰∫ãÊ•≠ÂãôÂÜÖÂÆπ„Äç„Çª„ÇØ„Ç∑„Éß„É≥„Åß‰ΩøÁî®„Åï„Çå„Åæ„Åô„ÄÇ
      </p>
    </div>
  `;
}

function openConstructionTaskModal(taskId = null) {
  const name = taskId ? constructionTasks.find(t => t.id === taskId)?.name : '';
  const states = taskId ? constructionTasks.find(t => t.id === taskId)?.states.join(', ') : 'Êú™ÁùÄÊâã, ÂÆå‰∫Ü';

  const newName = prompt('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ:', name);
  if (!newName) return;

  const newStates = prompt('„Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éó„Ç∑„Éß„É≥Ôºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ:', states);
  if (!newStates) return;

  const statesArray = newStates.split(',').map(s => s.trim()).filter(s => s);

  if (taskId) {
    const task = constructionTasks.find(t => t.id === taskId);
    if (task) {
      task.name = newName;
      task.states = statesArray;
    }
  } else {
    constructionTasks.push({
      id: 'con_' + Date.now(),
      name: newName,
      order: constructionTasks.length + 1,
      states: statesArray
    });
  }

  localStorage.setItem('constructionTasks', JSON.stringify(constructionTasks));
  renderConstructionTasksManagement();
  showToast('Â∑•‰∫ã„Çø„Çπ„ÇØ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

function editConstructionTask(taskId) {
  openConstructionTaskModal(taskId);
}

function deleteConstructionTask(taskId) {
  if (!confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  constructionTasks = constructionTasks.filter(t => t.id !== taskId);
  localStorage.setItem('constructionTasks', JSON.stringify(constructionTasks));
  renderConstructionTasksManagement();
  showToast('„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

function openTaskModal(taskIdOrCategory = null) {
  const modal = document.getElementById('taskModal');
  const title = document.getElementById('taskModalTitle');

  // „Ç´„ÉÜ„Ç¥„É™Âêç„ÅåÊ∏°„Åï„Çå„ÅüÂ†¥ÂêàÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ
  const isCategory = taskIdOrCategory === 'Ë®≠Ë®à' || taskIdOrCategory === 'IC';

  if (taskIdOrCategory && !isCategory) {
    // Á∑®ÈõÜ„É¢„Éº„ÉâÔºàtaskId„ÅåÊ∏°„Åï„Çå„ÅüÔºâ
    const task = tasksV2.find(t => t.id === taskIdOrCategory);
    if (!task) return;

    title.textContent = '„Çø„Çπ„ÇØÁ∑®ÈõÜ';
    document.getElementById('taskId').value = task.id;
    document.getElementById('taskKey').value = task.task_key;
    document.getElementById('taskName').value = task.task_name;
    document.getElementById('taskCategory').value = task.category;
    document.getElementById('taskOrder').value = task.display_order;
    document.getElementById('taskHasState').checked = task.has_state;
    renderStateOptions(task.state_options || []);
    document.getElementById('taskHasEmailButton').checked = task.has_email_button !== false;
    toggleTaskState();
    populateTaskVendorSelection(taskIdOrCategory);
  } else {
    // Êñ∞Ë¶èËøΩÂä†„É¢„Éº„Éâ
    const category = isCategory ? taskIdOrCategory : 'Ë®≠Ë®à';
    title.textContent = `${category}„Çø„Çπ„ÇØËøΩÂä†`;
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
    document.getElementById('taskCategory').value = category;
    document.getElementById('taskOrder').value = tasksV2.filter(t => t.category === category).length + 1;
    document.getElementById('taskHasState').checked = false;
    document.getElementById('taskHasEmailButton').checked = true;
    renderStateOptions([]);
    toggleTaskState();
    populateTaskVendorSelection(null);
  }

  ModalManager.open(modal, '#taskKey');
}

function populateTaskVendorSelection(taskId) {
  const container = document.getElementById('taskVendorSelection');
  if (!container) return;

  // ÁèæÂú®„ÅÆ„Çø„Çπ„ÇØ„Å´Á¥ê„Å•„ÅÑ„Å¶„ÅÑ„ÇãÊ•≠ËÄÖID„É™„Çπ„Éà„ÇíÂèñÂæó
  const currentMappings = taskId ? taskVendorMappings.filter(m => m.task_id === taskId).map(m => m.vendor_id) : [];

  // „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ„Åó„Å¶Ë°®Á§∫
  const categories = [...new Set(vendorsV2.map(v => v.vendor_categories?.name || 'Êú™ÂàÜÈ°û'))].sort();

  container.innerHTML = categories.map(category => {
    const categoryVendors = vendorsV2.filter(v => (v.vendor_categories?.name || 'Êú™ÂàÜÈ°û') === category);

    return `
      <div style="margin-bottom: 12px;">
        <div style="font-weight: 600; color: #4A90E2; margin-bottom: 4px; font-size: 12px;">${category}</div>
        ${categoryVendors.map(vendor => `
          <label style="display: block; padding: 4px 0; cursor: pointer;">
            <input type="checkbox"
                   value="${vendor.id}"
                   ${currentMappings.includes(vendor.id) ? 'checked' : ''}
                   style="margin-right: 8px;">
            ${escapeHtml(vendor.company)}
          </label>
        `).join('')}
      </div>
    `;
  }).join('');
}

function closeTaskModal() {
  ModalManager.close(document.getElementById('taskModal'));
}

function toggleTaskState() {
  const hasState = document.getElementById('taskHasState').checked;
  const stateGroup = document.getElementById('stateOptionsGroup');
  stateGroup.style.display = hasState ? 'block' : 'none';
}

function renderStateOptions(options = []) {
  const container = document.getElementById('stateOptionsList');
  if (!container) return;

  // Á©∫„ÅÆ„Äå-„Äç„ÅØÈô§Â§ñ„Åó„Å¶Ë°®Á§∫
  const filteredOptions = options.filter(opt => opt && opt !== '-' && opt !== '');

  if (filteredOptions.length === 0) {
    // „Éá„Éï„Ç©„É´„Éà„Åß1„Å§Á©∫„ÅÆÂÖ•ÂäõÊ¨Ñ„ÇíË°®Á§∫
    filteredOptions.push('');
  }

  container.innerHTML = filteredOptions.map((opt, index) => `
    <div class="state-option-item">
      <input type="text" class="state-option-input" value="${escapeHtml(opt)}" placeholder="‰æãÔºö‰æùÈ†ºÊ∏à">
      <button type="button" class="btn-remove" onclick="removeStateOption(${index})">ÂâäÈô§</button>
    </div>
  `).join('');
}

function addStateOption() {
  const container = document.getElementById('stateOptionsList');
  if (!container) return;

  const newItem = document.createElement('div');
  newItem.className = 'state-option-item';
  newItem.innerHTML = `
    <input type="text" class="state-option-input" value="" placeholder="‰æãÔºö‰æùÈ†ºÊ∏à">
    <button type="button" class="btn-remove" onclick="this.parentElement.remove()">ÂâäÈô§</button>
  `;
  container.appendChild(newItem);
  newItem.querySelector('input').focus();
}

function removeStateOption(index) {
  const container = document.getElementById('stateOptionsList');
  if (!container) return;

  const items = container.querySelectorAll('.state-option-item');
  if (items[index]) {
    items[index].remove();
  }
}

function collectStateOptions() {
  const container = document.getElementById('stateOptionsList');
  if (!container) return [];

  const inputs = container.querySelectorAll('.state-option-input');
  const options = ['-']; // ÂÖàÈ†≠„Å´Á©∫„ÅÆÈÅ∏ÊäûËÇ¢„ÇíËøΩÂä†

  inputs.forEach(input => {
    const value = input.value.trim();
    if (value && value !== '-') {
      options.push(value);
    }
  });

  return options;
}

async function saveTask() {
  if (SaveGuard.isLocked('saveTask')) return;

  const id = document.getElementById('taskId').value;
  const taskName = document.getElementById('taskName').value.trim();
  const category = document.getElementById('taskCategory').value;
  const order = parseInt(document.getElementById('taskOrder').value) || 0;
  const hasState = document.getElementById('taskHasState').checked;
  const hasEmailButton = document.getElementById('taskHasEmailButton').checked;

  if (!taskName) {
    showToast('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  // „Çø„Çπ„ÇØ„Ç≠„Éº„ÇíËá™ÂãïÁîüÊàêÔºàÁ∑®ÈõÜÊôÇ„ÅØÊó¢Â≠ò„ÅÆ„Ç≠„Éº„Çí‰ΩøÁî®Ôºâ
  let taskKey = document.getElementById('taskKey').value;
  if (!taskKey) {
    // Êñ∞Ë¶è‰ΩúÊàêÊôÇÔºö„Çø„Çπ„ÇØÂêç„Åã„ÇâËá™ÂãïÁîüÊàêÔºàÊó•Êú¨Ë™û„ÇíÂâäÈô§„Åó„ÄÅ„Çπ„Éö„Éº„Çπ„Çí„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„Å´Â§âÊèõÔºâ
    taskKey = 'task_' + taskName.replace(/[\u3000-\u9FFF]/g, '').replace(/\s+/g, '_').toLowerCase() + '_' + Date.now();
    // ÂÆâÂÖ®„ÅÆ„Åü„ÇÅ„ÄÅËã±Êï∞Â≠ó„Å®„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„ÅÆ„Åø„Å´Âà∂Èôê
    taskKey = taskKey.replace(/[^a-z0-9_]/g, '_');
  }

  // Áä∂ÊÖã„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂãïÁöÑ„É™„Çπ„Éà„Åã„ÇâÂèéÈõÜ
  let stateOptions = null;
  if (hasState) {
    stateOptions = collectStateOptions();
  }

  await SaveGuard.run('saveTask', async () => {
    showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

    const taskData = {
      task_key: taskKey,
      task_name: taskName,
      category,
      display_order: order,
      has_state: hasState,
      state_options: stateOptions,
      has_email_button: hasEmailButton
    };

    let result;
    if (id) {
      result = await supabase
        .from('tasks')
        .update(taskData)
        .eq('id', id)
        .select();
    } else {
      result = await supabase
        .from('tasks')
        .insert([taskData])
        .select();
    }

    if (result.error) {
      showStatus('‰øùÂ≠òÂ§±Êïó', 'error');
      showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error.message, 'error');
      return;
    }

    // Ê•≠ËÄÖÁ¥ê„Å•„Åë„ÅÆ‰øùÂ≠ò
    const savedTaskId = id || result.data[0].id;
    await saveTaskVendorMappings(savedTaskId);

    showStatus('‰øùÂ≠òÂÆå‰∫Ü', 'success');
    showToast(id ? '„Çø„Çπ„ÇØ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü' : '„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
    closeTaskModal();
    await loadTasksV2();
    await loadTaskVendorMappings();
    renderTasksManagement();
  });
}

async function saveTaskVendorMappings(taskId) {
  // ÈÅ∏Êäû„Åï„Çå„ÅüÊ•≠ËÄÖID„ÇíÂèñÂæó
  const checkboxes = document.querySelectorAll('#taskVendorSelection input[type="checkbox"]:checked');
  const selectedVendorIds = Array.from(checkboxes).map(cb => cb.value);

  // Êó¢Â≠ò„ÅÆÁ¥ê„Å•„Åë„ÇíÂÖ®ÂâäÈô§
  const { error: deleteError } = await supabase
    .from('task_vendor_mappings_v2')
    .delete()
    .eq('task_id', taskId);

  if (deleteError) {
    logError('Ê•≠ËÄÖÁ¥ê„Å•„ÅëÂâäÈô§„Ç®„É©„Éº:', deleteError);
    showToast('Êó¢Â≠ò„ÅÆÁ¥ê„Å•„ÅëÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return;
  }

  // Êñ∞„Åó„ÅÑÁ¥ê„Å•„Åë„Çí‰ΩúÊàê
  if (selectedVendorIds.length > 0) {
    const mappings = selectedVendorIds.map(vendorId => ({
      task_id: taskId,
      vendor_id: vendorId
    }));

    const { error } = await supabase
      .from('task_vendor_mappings_v2')
      .insert(mappings);

    if (error) {
      logError('Ê•≠ËÄÖÁ¥ê„Å•„Åë‰øùÂ≠ò„Ç®„É©„Éº:', error);
      showToast('Ê•≠ËÄÖÁ¥ê„Å•„Åë„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    }
  }
}

function editTask(taskId) {
  openTaskModal(taskId);
}

async function deleteTask(taskId) {
  const task = tasksV2.find(t => t.id === taskId);
  if (!task) return;

  if (!confirm(`„Çø„Çπ„ÇØ„Äå${task.task_name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

  await SaveGuard.run(`deleteTask_${taskId}`, async () => {
    showStatus('ÂâäÈô§‰∏≠...', 'saving');

    const { error } = await supabase
      .from('tasks')
      .delete()
      .eq('id', taskId);

    if (error) {
      showStatus('ÂâäÈô§Â§±Êïó', 'error');
      showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    showStatus('ÂâäÈô§ÂÆå‰∫Ü', 'success');
    showToast('„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
    await loadTasksV2();
    renderTasksManagement();
  });
}

// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åß„Çø„Çπ„ÇØ„ÅÆË°®Á§∫È†Ü„ÇíÂ§âÊõ¥
let draggedTaskId = null;

function handleTaskDragStart(event, taskId) {
  draggedTaskId = taskId;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.5';
}

function handleTaskDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  return false;
}

async function handleTaskDrop(event, targetTaskId) {
  event.preventDefault();
  event.stopPropagation();

  if (!draggedTaskId || draggedTaskId === targetTaskId) {
    resetDragState();
    return;
  }

  const draggedTask = tasksV2.find(t => t.id === draggedTaskId);
  const targetTask = tasksV2.find(t => t.id === targetTaskId);

  if (!draggedTask || !targetTask) {
    resetDragState();
    return;
  }

  // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™ÂÜÖ„Åß„ÅÆ„Åø‰∏¶„Å≥Êõø„ÅàÂèØËÉΩ
  if (draggedTask.category !== targetTask.category) {
    showToast('Âêå„Åò„Ç´„ÉÜ„Ç¥„É™ÂÜÖ„Åß„ÅÆ„Åø‰∏¶„Å≥Êõø„ÅàÂèØËÉΩ„Åß„Åô', 'error');
    resetDragState();
    return;
  }

  // Ë°®Á§∫È†Ü„ÇíÂÖ•„ÇåÊõø„Åà
  const draggedOrder = draggedTask.display_order;
  const targetOrder = targetTask.display_order;

  showStatus('‰∏¶„Å≥Êõø„Åà‰∏≠...', 'saving');

  // ‰∏°Êñπ„ÅÆ„Çø„Çπ„ÇØ„ÅÆË°®Á§∫È†Ü„ÇíÊõ¥Êñ∞
  const updates = [
    supabase.from('tasks').update({ display_order: targetOrder }).eq('id', draggedTaskId),
    supabase.from('tasks').update({ display_order: draggedOrder }).eq('id', targetTaskId)
  ];

  const results = await Promise.all(updates);

  if (results.some(r => r.error)) {
    showStatus('‰∏¶„Å≥Êõø„ÅàÂ§±Êïó', 'error');
    showToast('‰∏¶„Å≥Êõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    resetDragState();
    return;
  }

  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
  draggedTask.display_order = targetOrder;
  targetTask.display_order = draggedOrder;

  // ÂÜçÊèèÁîª
  renderTasksManagement();
  showStatus('‰∏¶„Å≥Êõø„ÅàÂÆå‰∫Ü', 'success');
  showToast('Ë°®Á§∫È†Ü„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü', 'success');
  resetDragState();
}

function resetDragState() {
  draggedTaskId = null;
  // „Åô„Åπ„Å¶„ÅÆË°å„ÅÆÈÄèÊòéÂ∫¶„Çí„É™„Çª„ÉÉ„Éà
  document.querySelectorAll('#tasksGrid tr[draggable]').forEach(tr => {
    tr.style.opacity = '1';
  });
}

// ============================================
// UIÂà∂Âæ°
// ============================================
// „Çµ„Ç§„Éâ„Éê„ÉºÊèèÁîª
function renderSidebar() {
  const container = document.getElementById('sidebarContent');
  if (!container) return;

  const sekkeiDesigners = getSekkeiDesigners();
  const icDesigners = getIcDesigners();
  const allCount = projects.filter(p => p.status !== 'completed').length;

  // ÂÆå‰∫ÜÊ∏à„ÅÆ‰ª∂Êï∞
  const archivedCount = projects.filter(p => p.is_archived).length;

  let html = `
    <div class="sidebar-section">
      <div class="sidebar-item ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="selectDesigner('ALL')">
        <span class="sidebar-item-label">ÂÖ®Ê°à‰ª∂</span>
        <span class="sidebar-item-count">${allCount}</span>
      </div>
      <div class="sidebar-item ${currentDesignerTab === 'ARCHIVED' ? 'active' : ''}" onclick="selectDesigner('ARCHIVED')" style="background: ${currentDesignerTab === 'ARCHIVED' ? 'var(--success-bg)' : 'transparent'};">
        <span class="sidebar-item-label" style="color: var(--success-color);">‚úì ÂÆå‰∫ÜÊ∏à</span>
        <span class="sidebar-item-count" style="background: var(--success-color); color: white;">${archivedCount}</span>
      </div>
    </div>
  `;

  // ‰ª∂Êï∞„Å´„Çà„ÇãËâ≤ÂàÜ„Åë„Éò„É´„Éë„ÉºÈñ¢Êï∞
  function getCountStyle(count) {
    if (count >= 7) {
      return 'color: #dc2626; font-weight: 700;'; // Ëµ§Ëâ≤ÔºàÂç±Èô∫Ôºâ
    } else if (count >= 5) {
      return 'color: #d97706; font-weight: 600;'; // ÈªÑËâ≤ÔºàÊ≥®ÊÑèÔºâ
    }
    return ''; // ÈÄöÂ∏∏Ôºà4‰ª∂‰ª•‰∏ãÔºâ
  }

  function getCountBadgeClass(count) {
    if (count >= 7) return 'badge-danger';
    if (count >= 5) return 'badge-warning';
    return 'badge-primary';
  }

  if (sekkeiDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">üìê Ë®≠Ë®àÊãÖÂΩì</div>';
    sekkeiDesigners.forEach(designer => {
      const designerName = designer.name.trim();
      const count = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        return assigned === designerName && p.status !== 'completed' && !p.is_archived;
      }).length;
      const archivedCountForDesigner = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        return assigned === designerName && p.is_archived;
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-counts">
            <span class="sidebar-item-count ${badgeClass}">${count}</span>
            ${archivedCountForDesigner > 0 ? `<span class="sidebar-archived-count" onclick="event.stopPropagation(); selectDesignerArchived('${designer.name}')" title="ÂÆå‰∫ÜÊ∏à„ÇíË°®Á§∫">‚úì${archivedCountForDesigner}</span>` : ''}
          </span>
        </div>
      `;
    });
    html += '</div>';
  }

  if (icDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">üé® ICÊãÖÂΩì</div>';
    icDesigners.forEach(designer => {
      const designerName = designer.name.trim();
      // ICÊãÖÂΩìËÄÖ„ÅÆÂ†¥Âêà„ÄÅÁî≥Ë´ãGOÊ∏à„ÅøÔºàis_archivedÔºâ„Åß„ÇÇICÈÄ≤Êçó100%Êú™Ê∫Ä„ÅØ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å®„Åó„Å¶Êâ±„ÅÜ
      const count = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const icAssigned = (p.ic_assignee || '').trim();
        const isMyProject = assigned === designerName || icAssigned === designerName;
        if (!isMyProject) return false;
        if (p.status === 'completed') return false;
        // Áî≥Ë´ãGOÊ∏à„Åø„ÅÆÂ†¥Âêà„ÄÅICÈÄ≤Êçó100%„Å™„ÇâÂÆå‰∫ÜÊâ±„ÅÑ„ÄÅÊú™Ê∫Ä„Å™„Çâ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊâ±„ÅÑ
        if (p.is_archived) {
          const icProgress = calculateICProgress(p);
          return icProgress !== null && icProgress < 100;
        }
        return true;
      }).length;
      // ICÊãÖÂΩìËÄÖ„ÅÆÂÆå‰∫ÜÊ°à‰ª∂: Áî≥Ë´ãGOÊ∏à„Åø„Åã„Å§ICÈÄ≤Êçó100%
      const archivedCountForDesigner = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const icAssigned = (p.ic_assignee || '').trim();
        const isMyProject = assigned === designerName || icAssigned === designerName;
        if (!isMyProject) return false;
        if (!p.is_archived) return false;
        const icProgress = calculateICProgress(p);
        return icProgress === null || icProgress === 100; // ICÊãÖÂΩì„Å™„Åó„ÄÅ„Åæ„Åü„ÅØICÈÄ≤Êçó100%
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-counts">
            <span class="sidebar-item-count ${badgeClass}">${count}</span>
            ${archivedCountForDesigner > 0 ? `<span class="sidebar-archived-count" onclick="event.stopPropagation(); selectDesignerArchived('${designer.name}')" title="ÂÆå‰∫ÜÊ∏à„ÇíË°®Á§∫">‚úì${archivedCountForDesigner}</span>` : ''}
          </span>
        </div>
      `;
    });
    html += '</div>';
  }

  // Â§ñÊßãÊãÖÂΩì
  const exteriorDesigners = getExteriorDesigners();
  if (exteriorDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">üè° Â§ñÊßãÊãÖÂΩì</div>';
    exteriorDesigners.forEach(designer => {
      const designerName = designer.name.trim();
      const count = projects.filter(p => {
        const exteriorAssigned = (p.exterior_assignee || '').trim();
        return exteriorAssigned === designerName && p.status !== 'completed' && !p.is_archived;
      }).length;
      const archivedCountForDesigner = projects.filter(p => {
        const exteriorAssigned = (p.exterior_assignee || '').trim();
        return exteriorAssigned === designerName && p.is_archived;
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-counts">
            <span class="sidebar-item-count ${badgeClass}">${count}</span>
            ${archivedCountForDesigner > 0 ? `<span class="sidebar-archived-count" onclick="event.stopPropagation(); selectDesignerArchived('${designer.name}')" title="ÂÆå‰∫ÜÊ∏à„ÇíË°®Á§∫">‚úì${archivedCountForDesigner}</span>` : ''}
          </span>
        </div>
      `;
    });
    html += '</div>';
  }

  // ‰∏çÂãïÁî£ÊãÖÂΩì
  const realestateDesigners = getRealestateDesigners();
  if (realestateDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">üè¢ ‰∏çÂãïÁî£ÊãÖÂΩì</div>';
    realestateDesigners.forEach(designer => {
      const designerName = designer.name.trim();
      const count = projects.filter(p => {
        const realestateAssigned = (p.realestate_assignee || '').trim();
        return realestateAssigned === designerName && p.status !== 'completed' && !p.is_archived;
      }).length;
      const archivedCountForDesigner = projects.filter(p => {
        const realestateAssigned = (p.realestate_assignee || '').trim();
        return realestateAssigned === designerName && p.is_archived;
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-counts">
            <span class="sidebar-item-count ${badgeClass}">${count}</span>
            ${archivedCountForDesigner > 0 ? `<span class="sidebar-archived-count" onclick="event.stopPropagation(); selectDesignerArchived('${designer.name}')" title="ÂÆå‰∫ÜÊ∏à„ÇíË°®Á§∫">‚úì${archivedCountForDesigner}</span>` : ''}
          </span>
        </div>
      `;
    });
    html += '</div>';
  }

  // Â∑•‰∫ãÊãÖÂΩì
  const constructionDesigners = getConstructionDesigners();
  if (constructionDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">üî® Â∑•‰∫ãÊãÖÂΩì</div>';
    constructionDesigners.forEach(designer => {
      const designerName = designer.name.trim();
      const count = projects.filter(p => {
        const constructionAssigned = (p.construction_assignee || '').trim();
        return constructionAssigned === designerName && p.status !== 'completed' && !p.is_archived;
      }).length;
      const archivedCountForDesigner = projects.filter(p => {
        const constructionAssigned = (p.construction_assignee || '').trim();
        return constructionAssigned === designerName && p.is_archived;
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-counts">
            <span class="sidebar-item-count ${badgeClass}">${count}</span>
            ${archivedCountForDesigner > 0 ? `<span class="sidebar-archived-count" onclick="event.stopPropagation(); selectDesignerArchived('${designer.name}')" title="ÂÆå‰∫ÜÊ∏à„ÇíË°®Á§∫">‚úì${archivedCountForDesigner}</span>` : ''}
          </span>
        </div>
      `;
    });
    html += '</div>';
  }

  container.innerHTML = html;
}

function selectDesigner(name) {
  currentDesignerTab = name;

  // URL„ÇíÊõ¥Êñ∞
  updateURLWithDesigner(name);

  renderSidebar();
  renderProjects();
}

// ÊãÖÂΩìËÄÖ„ÅÆÂÆå‰∫ÜÊ∏àÊ°à‰ª∂„ÇíË°®Á§∫
function selectDesignerArchived(name) {
  currentDesignerTab = name;

  // „Ç¢„Éº„Ç´„Ç§„Éñ„Éï„Ç£„É´„Çø„Éº„ÇíÂÆå‰∫ÜÊ∏à„Å´Ë®≠ÂÆö
  const archiveFilter = document.getElementById('archiveFilter');
  if (archiveFilter) {
    archiveFilter.value = 'archived';
  }

  // URL„ÇíÊõ¥Êñ∞
  updateURLWithDesigner(name);

  renderSidebar();
  renderProjects();
}

// „É°„Ç§„É≥„Çø„ÉñÂàá„ÇäÊõø„Åà
function switchMainTab(tabName, element) {
  log('üìë switchMainTab ÈñãÂßã:', {
    tabName: tabName,
    isHandlingHashChange: isHandlingHashChange,
    currentHash: window.location.hash,
    timestamp: new Date().toISOString()
  });

  // „Éò„ÉÉ„ÉÄ„Éº„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
  document.querySelectorAll('.header-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) element.classList.add('active');

  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');

  // URL„ÇíÊõ¥Êñ∞ÔºàhandleHashChangeÂá¶ÁêÜ‰∏≠„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
  if (!isHandlingHashChange && window.location.hash !== '#' + tabName) {
    log('üîó switchMainTab: URL„ÇíÊõ¥Êñ∞:', tabName);
    window.location.hash = tabName;
  } else {
    log('‚è∏Ô∏è switchMainTab: URLÊõ¥Êñ∞„Çí„Çπ„Ç≠„ÉÉ„Éó (isHandlingHashChange=' + isHandlingHashChange + ')');
  }

  // „Ç´„É¨„É≥„ÉÄ„Éº„Çø„Éñ„ÅÆÂ†¥Âêà„ÅØÊèèÁîª
  if (tabName === 'calendar') {
    renderCalendar();
  }
}

// ===== „Ç´„É¨„É≥„ÉÄ„ÉºÊ©üËÉΩ =====
let calendarCurrentDate = new Date();

function navigateCalendar(direction) {
  calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + direction);
  renderCalendar();
}

function renderCalendar() {
  const grid = document.getElementById('calendarGrid');
  const title = document.getElementById('calendarTitle');
  if (!grid || !title) return;

  const year = calendarCurrentDate.getFullYear();
  const month = calendarCurrentDate.getMonth();

  // „Çø„Ç§„Éà„É´Êõ¥Êñ∞
  title.textContent = `${year}Âπ¥${month + 1}Êúà`;

  // Êúà„ÅÆÊúÄÂàù„Å®ÊúÄÂæå„ÅÆÊó•
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDayOfWeek = firstDay.getDay();

  // ÊúüÈôê‰ªò„Åç„Çø„Çπ„ÇØ„ÇíÂèéÈõÜ
  const events = collectCalendarEvents();

  // „Ç´„É¨„É≥„ÉÄ„Éº„Ç∞„É™„ÉÉ„ÉâÁîüÊàê
  let html = '';

  // ÊõúÊó•„Éò„ÉÉ„ÉÄ„Éº
  const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
  dayNames.forEach(name => {
    html += `<div class="calendar-day-header">${name}</div>`;
  });

  // ‰ªäÊó•„ÅÆÊó•‰ªò
  const today = new Date();
  const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

  // ÂâçÊúà„ÅÆÊó•„ÇíÂüã„ÇÅ„Çã
  const prevMonthLastDay = new Date(year, month, 0).getDate();
  for (let i = startDayOfWeek - 1; i >= 0; i--) {
    const day = prevMonthLastDay - i;
    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    html += `<div class="calendar-day other-month">
      <div class="calendar-day-number">${day}</div>
    </div>`;
  }

  // ÂΩìÊúà„ÅÆÊó•
  for (let day = 1; day <= lastDay.getDate(); day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const isToday = dateStr === todayStr;
    const dayEvents = events.filter(e => e.date === dateStr);

    html += `<div class="calendar-day ${isToday ? 'today' : ''}">
      <div class="calendar-day-number">${day}</div>
      <div class="calendar-events">
        ${dayEvents.slice(0, 3).map(e => `<div class="calendar-event ${e.category}" title="${escapeHtml(e.customer)}: ${escapeHtml(e.taskName)}">${escapeHtml(e.customer.slice(0, 4))}</div>`).join('')}
        ${dayEvents.length > 3 ? `<div class="calendar-event" style="background:#ddd;color:#666;">+${dayEvents.length - 3}‰ª∂</div>` : ''}
      </div>
    </div>`;
  }

  // ÁøåÊúà„ÅÆÊó•„ÇíÂüã„ÇÅ„ÇãÔºà6ÈÄ±ÂàÜ„Å´„Å™„Çã„Åæ„ÅßÔºâ
  const totalCells = startDayOfWeek + lastDay.getDate();
  const remainingCells = (7 - (totalCells % 7)) % 7;
  for (let day = 1; day <= remainingCells; day++) {
    html += `<div class="calendar-day other-month">
      <div class="calendar-day-number">${day}</div>
    </div>`;
  }

  grid.innerHTML = html;
}

function collectCalendarEvents() {
  const events = [];

  projects.forEach(project => {
    if (project.is_archived) return;

    const progressData = project.progress || {};

    // Ë®≠Ë®à„Çø„Çπ„ÇØ„ÅÆÊúüÈôê„Å®‰æùÈ†ºÊó•
    tasksV2.filter(t => t.category === 'Ë®≠Ë®à').forEach(task => {
      const taskData = progressData[task.task_key];
      if (taskData?.due_date) {
        events.push({
          date: taskData.due_date,
          customer: project.customer,
          taskName: task.task_name + '(ÊúüÈôê)',
          category: 'design',
          projectId: project.id
        });
      }
      if (taskData?.request_date) {
        events.push({
          date: taskData.request_date,
          customer: project.customer,
          taskName: task.task_name + '(‰æùÈ†º)',
          category: 'task',
          projectId: project.id
        });
      }
    });

    // IC„Çø„Çπ„ÇØ„ÅÆÊúüÈôê„Å®‰æùÈ†ºÊó•
    tasksV2.filter(t => t.category === 'IC').forEach(task => {
      const taskData = progressData[task.task_key];
      if (taskData?.due_date) {
        events.push({
          date: taskData.due_date,
          customer: project.customer,
          taskName: task.task_name + '(ÊúüÈôê)',
          category: 'ic',
          projectId: project.id
        });
      }
      if (taskData?.request_date) {
        events.push({
          date: taskData.request_date,
          customer: project.customer,
          taskName: task.task_name + '(‰æùÈ†º)',
          category: 'task',
          projectId: project.id
        });
      }
    });

    // Â§ñÊßã„Çø„Çπ„ÇØ„ÅÆ‰æùÈ†ºÊó•
    tasksV2.filter(t => t.category === 'Â§ñÊßã').forEach(task => {
      const taskData = progressData[task.task_key];
      if (taskData?.request_date) {
        events.push({
          date: taskData.request_date,
          customer: project.customer,
          taskName: task.task_name + '(‰æùÈ†º)',
          category: 'exterior',
          projectId: project.id
        });
      }
    });

    // Â∑•‰∫ã„Çø„Çπ„ÇØ„ÅÆ‰æùÈ†ºÊó•
    tasksV2.filter(t => t.category === 'Â∑•‰∫ã').forEach(task => {
      const taskData = progressData[task.task_key];
      if (taskData?.request_date) {
        events.push({
          date: taskData.request_date,
          customer: project.customer,
          taskName: task.task_name + '(‰æùÈ†º)',
          category: 'construction',
          projectId: project.id
        });
      }
    });

    // ‰∏ªË¶Å„Å™Êó•Á®ã
    if (project.layout_confirmed_date) {
      events.push({
        date: project.layout_confirmed_date,
        customer: project.customer,
        taskName: 'ÈñìÂèñÁ¢∫ÂÆö',
        category: 'design',
        projectId: project.id
      });
    }

    if (project.construction_permit_date) {
      events.push({
        date: project.construction_permit_date,
        customer: project.customer,
        taskName: 'Âª∫ÁØâÁ¢∫Ë™ç',
        category: 'construction',
        projectId: project.id
      });
    }

    if (project.pre_contract_meeting_date) {
      events.push({
        date: project.pre_contract_meeting_date,
        customer: project.customer,
        taskName: 'Â§âÊõ¥Â•ëÁ¥ÑÂâç‰ºöË≠∞',
        category: 'design',
        projectId: project.id
      });
    }
  });

  return events;
}

// „Çµ„Éñ„Çø„ÉñÂàá„ÇäÊõø„Åà
function switchSubTab(panelName, element) {
  log('üìë switchSubTab ÈñãÂßã:', {
    panelName: panelName,
    isHandlingHashChange: isHandlingHashChange,
    currentHash: window.location.hash,
    timestamp: new Date().toISOString()
  });

  document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
  if (element) element.classList.add('active');

  document.querySelectorAll('.sub-tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(panelName + 'Panel').classList.add('active');

  // URL„ÇíÊõ¥Êñ∞ÔºàhandleHashChangeÂá¶ÁêÜ‰∏≠„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
  if (!isHandlingHashChange && window.location.hash !== `#settings/${panelName}`) {
    log('üîó switchSubTab: URL„ÇíÊõ¥Êñ∞:', panelName);
    window.location.hash = `settings/${panelName}`;
  } else {
    log('‚è∏Ô∏è switchSubTab: URLÊõ¥Êñ∞„Çí„Çπ„Ç≠„ÉÉ„Éó (isHandlingHashChange=' + isHandlingHashChange + ')');
  }

  // „Çµ„Éñ„Çø„ÉñÂàá„ÇäÊõø„ÅàÊôÇ„Å´ÂØæÂøú„Åô„ÇãÊèèÁîªÈñ¢Êï∞„ÇíÂÆüË°å
  switch(panelName) {
    case 'staff':
      renderDesignerListInline();
      break;
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
    case 'icTasks':
      renderIcTasksManagement();
      break;
    case 'exteriorTasks':
      renderExteriorTasksManagement();
      break;
    case 'realestateTasks':
      renderRealestateTasksManagement();
      break;
    case 'constructionTasks':
      renderConstructionTasksManagement();
      break;
    case 'products':
      renderProductsList();
      break;
    case 'kintone':
      loadKintoneSettings();
      break;
  }
}

// ÊóßswitchTabÈñ¢Êï∞Ôºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
function switchTab(tabName, element) {
  document.querySelectorAll('.header-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) {
    element.classList.add('active');
  } else {
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºötabName„Å´Âü∫„Å•„ÅÑ„Å¶„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éú„Çø„É≥„ÇíË¶ã„Å§„Åë„Çã
    const buttons = document.querySelectorAll('.header-nav-btn');
    buttons.forEach((btn, index) => {
      const tabs = ['projects', 'analytics', 'settings'];
      if (tabs[index] === tabName) {
        btn.classList.add('active');
      }
    });
  }
  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');

  // „Çø„ÉñÂàá„ÇäÊõø„ÅàÊôÇ„Å´ÂØæÂøú„Åô„ÇãÊèèÁîªÈñ¢Êï∞„ÇíÂÆüË°å
  switch(tabName) {
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
  }
}

// „Ç´„ÉÜ„Ç¥„É™„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÂãïÁöÑ„Å´ÁîüÊàê
function populateVendorCategoryDropdown() {
  const dropdown = document.getElementById('vendorCategory');
  if (!dropdown) return;

  dropdown.innerHTML = '<option value="">„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû...</option>' +
    vendorCategories.map(cat => `<option value="${escapeHtml(cat.id)}">${escapeHtml(cat.name)}</option>`).join('');
}

let statusClearTimeout = null;
function showStatus(message, type) {
  const indicator = document.getElementById('statusIndicator');
  const text = document.getElementById('statusText');
  indicator.className = 'status-indicator status-' + type;
  text.textContent = message;

  // ‰øùÂ≠òÂÆå‰∫ÜÂæå„ÅØ3Áßí„ÅßÈÄöÂ∏∏Áä∂ÊÖã„Å´Êàª„Åô
  if (statusClearTimeout) clearTimeout(statusClearTimeout);
  if (type === 'saved' || type === 'success') {
    statusClearTimeout = setTimeout(() => {
      indicator.className = 'status-indicator';
      text.textContent = '';
    }, 3000);
  }
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.className = 'toast toast-' + type + ' show';
  toast.textContent = message;

  // „Çπ„ÇØ„É™„Éº„É≥„É™„Éº„ÉÄ„Éº„Å´„ÇÇÈÄöÁü•
  announceToScreenReader(message);

  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// „Çπ„ÇØ„É™„Éº„É≥„É™„Éº„ÉÄ„ÉºÁî®„Ç¢„Éä„Ç¶„É≥„Çπ
function announceToScreenReader(message, priority = 'polite') {
  const liveRegion = document.getElementById('liveRegion');
  if (liveRegion) {
    liveRegion.setAttribute('aria-live', priority);
    liveRegion.textContent = message;
    // Âêå„Åò„É°„ÉÉ„Çª„Éº„Ç∏„Åß„ÇÇÂÜçÈÄöÁü•„Åô„Çã„Åü„ÇÅ„Å´‰∏ÄÂ∫¶„ÇØ„É™„Ç¢
    setTimeout(() => {
      liveRegion.textContent = '';
    }, 1000);
  }
}

// „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§
function showLoading(message = 'Ë™≠„ÅøËæº„Åø‰∏≠...') {
  const overlay = document.getElementById('loadingOverlay');
  const text = document.getElementById('loadingText');
  if (overlay) {
    if (text) text.textContent = message;
    overlay.classList.add('show');
  }
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.classList.remove('show');
  }
}

// „Éó„É≠„Ç∞„É¨„Çπ‰ªò„Åç„É≠„Éº„Éá„Ç£„É≥„Ç∞
let loadingProgress = 0;
function showLoadingProgress(message, current, total) {
  const overlay = document.getElementById('loadingOverlay');
  const text = document.getElementById('loadingText');
  if (overlay && text) {
    const percent = Math.round((current / total) * 100);
    text.textContent = `${message} (${percent}%)`;
    overlay.classList.add('show');
  }
}

// ============================================
// „Éñ„É©„Ç¶„Ç∂ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†
// ============================================
const NotificationSystem = {
  permission: 'default',
  soundEnabled: localStorage.getItem('notificationSound') !== 'false',

  async init() {
    if ('Notification' in window) {
      this.permission = Notification.permission;
      log('üîî ÈÄöÁü•Ê®©Èôê:', this.permission);
    }
  },

  async requestPermission() {
    if (!('Notification' in window)) {
      showToast('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈÄöÁü•„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', 'warning');
      return false;
    }

    try {
      const permission = await Notification.requestPermission();
      this.permission = permission;

      if (permission === 'granted') {
        showToast('ÈÄöÁü•„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„Åü', 'success');
        return true;
      } else {
        showToast('ÈÄöÁü•„ÅåË®±ÂèØ„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü', 'warning');
        return false;
      }
    } catch (error) {
      logError('ÈÄöÁü•Ê®©Èôê„É™„ÇØ„Ç®„Çπ„Éà„Ç®„É©„Éº:', error);
      return false;
    }
  },

  async send(title, options = {}) {
    if (this.permission !== 'granted') {
      log('ÈÄöÁü•Ê®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
      return null;
    }

    const defaultOptions = {
      icon: '/archideck/icon-192.png',
      badge: '/archideck/badge.png',
      tag: 'archideck-notification',
      requireInteraction: false,
      ...options
    };

    try {
      // „Çµ„Ç¶„É≥„ÉâÂÜçÁîü
      if (this.soundEnabled && options.sound !== false) {
        this.playSound();
      }

      const notification = new Notification(title, defaultOptions);

      notification.onclick = () => {
        window.focus();
        notification.close();
        if (options.onClick) options.onClick();
      };

      return notification;
    } catch (error) {
      logError('ÈÄöÁü•ÈÄÅ‰ø°„Ç®„É©„Éº:', error);
      return null;
    }
  },

  playSound() {
    try {
      // „Ç∑„É≥„Éó„É´„Å™ÈÄöÁü•Èü≥„ÇíÁîüÊàê
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = 800;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    } catch (e) {
      log('ÈÄöÁü•Èü≥ÂÜçÁîü„Ç®„É©„ÉºÔºàÁÑ°Ë¶ñÂèØÔºâ:', e);
    }
  },

  toggleSound() {
    this.soundEnabled = !this.soundEnabled;
    localStorage.setItem('notificationSound', this.soundEnabled);
    showToast(this.soundEnabled ? 'ÈÄöÁü•Èü≥„Çí„Ç™„É≥„Å´„Åó„Åæ„Åó„Åü' : 'ÈÄöÁü•Èü≥„Çí„Ç™„Éï„Å´„Åó„Åæ„Åó„Åü', 'info');
    return this.soundEnabled;
  },

  // ÊúüÈôêÈñìËøë„ÅÆÊ°à‰ª∂„ÇíÈÄöÁü•
  async checkDeadlines() {
    const today = new Date();
    const threeDaysLater = new Date(today);
    threeDaysLater.setDate(today.getDate() + 3);

    const upcomingDeadlines = projects.filter(p => {
      if (!p.tasks || p.status === 'completed' || p.is_archived) return false;

      return Object.entries(p.tasks).some(([key, task]) => {
        if (!task.due_date || task.status === 'completed') return false;
        const dueDate = new Date(task.due_date);
        return dueDate >= today && dueDate <= threeDaysLater;
      });
    });

    if (upcomingDeadlines.length > 0) {
      await this.send('ÊúüÈôêÈñìËøë„ÅÆ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô', {
        body: `${upcomingDeadlines.length}‰ª∂„ÅÆÊ°à‰ª∂„Å´ÊúüÈôê„ÅåËøë„ÅÑ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô`,
        tag: 'deadline-warning'
      });
    }
  }
};

// ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', () => {
  NotificationSystem.init();
});

// ============================================
// Ê°à‰ª∂ÁÆ°ÁêÜ
// ============================================
function renderDesignerTabs() {
  const container = document.getElementById('designerTabs');
  if (!container) {
    warn('‚ö†Ô∏è designerTabsË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
    return;
  }

  log('üé® ÊãÖÂΩìËÄÖ„Çø„ÉñÊèèÁîª:', {
    'Á∑è„Çπ„Çø„ÉÉ„ÉïÊï∞': designers.length,
    'Ë®≠Ë®àÊãÖÂΩì': designers.filter(d => d.category === 'Ë®≠Ë®à').length,
    'ICÊãÖÂΩì': designers.filter(d => d.category === 'IC').length,
    'Ê°à‰ª∂Êï∞': projects.length
  });

  const activeCount = projects.filter(p => p.status !== 'completed').length;

  let html = `<button class="designer-tab ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="setDesignerTab('ALL')">ÂÖ®Ê°à‰ª∂ (${activeCount})</button>`;

  // Ë®≠Ë®àÊãÖÂΩì
  const sekkeiDesigners = designers.filter(d => d.category === 'Ë®≠Ë®à');
  log('üìê Ë®≠Ë®àÊãÖÂΩì:', sekkeiDesigners.map(d => d.name));
  if (sekkeiDesigners.length > 0) {
    html += '<div class="designer-group-label">Ë®≠Ë®àÊãÖÂΩì</div>';
    sekkeiDesigners.forEach(designer => {
      const designerProjects = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const designerName = designer.name.trim();
        return assigned === designerName && p.status !== 'completed' && !p.is_archived;
      });
      const count = designerProjects.length;

      html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
    });
  } else {
    warn('‚ö†Ô∏è Ë®≠Ë®àÊãÖÂΩì„Åå0Âêç„Åß„Åô');
  }

  // ICÊãÖÂΩì
  const icDesigners = designers.filter(d => d.category === 'IC');
  log('üé® ICÊãÖÂΩì:', icDesigners.map(d => d.name));
  if (icDesigners.length > 0) {
    html += '<div class="designer-group-label">ICÊãÖÂΩì</div>';
    icDesigners.forEach(designer => {
      const designerProjects = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const icAssigned = (p.ic_assignee || '').trim();
        const designerName = designer.name.trim();
        return (assigned === designerName || icAssigned === designerName) && p.status !== 'completed' && !p.is_archived;
      });
      const count = designerProjects.length;

      html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
    });
  }

  container.innerHTML = html;
}

function setDesignerTab(name) {
  currentDesignerTab = name;

  // URL„ÇíÊõ¥Êñ∞
  updateURLWithDesigner(name);

  renderDesignerTabs();
  renderProjects();
}

function renderProjects() {
  const container = document.getElementById('projectsGrid');
  const emptyState = document.getElementById('emptyProjects');

  log('üé® renderProjects() ÈñãÂßã');
  log('üìä ÁèæÂú®„ÅÆ„Çø„Éñ:', currentDesignerTab);
  log('üìä ÂÖ®Ê°à‰ª∂Êï∞:', projects.length);
  log('üìä ÂÖ®Ê°à‰ª∂:', projects.map(p => ({ customer: p.customer, assigned_to: p.assigned_to, ic_assignee: p.ic_assignee })));

  let filtered = projects.filter(p => {
    // ÂÆå‰∫ÜÊ∏à„Çø„Éñ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
    if (currentDesignerTab === 'ARCHIVED') {
      // ÂÆå‰∫ÜÊ∏àÊ°à‰ª∂„ÅÆ„ÅøË°®Á§∫
      if (!p.is_archived) return false;

      // Ê§úÁ¥¢„ÇØ„Ç®„É™„Éï„Ç£„É´„Çø„Éº
      const query = document.getElementById('searchQuery').value.toLowerCase();
      if (query && !p.customer.toLowerCase().includes(query) && !(p.memo || '').toLowerCase().includes(query)) return false;

      return true;
    }

    // ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„ÉºÔºàË®≠Ë®à/IC/Â§ñÊßã/‰∏çÂãïÁî£ÊãÖÂΩìÔºâ
    if (currentDesignerTab !== 'ALL') {
      const assigned = (p.assigned_to || '').trim();
      const icAssigned = (p.ic_assignee || '').trim();
      const exteriorAssigned = (p.exterior_assignee || '').trim();
      const realestateAssigned = (p.realestate_assignee || '').trim();
      const currentTab = currentDesignerTab.trim();

      if (assigned !== currentTab && icAssigned !== currentTab && exteriorAssigned !== currentTab && realestateAssigned !== currentTab) {
        log(`‚ùå „Éï„Ç£„É´„Çø„ÅßÈô§Â§ñ: ${p.customer} (assigned_to: "${assigned}", ic: "${icAssigned}", Â§ñÊßã: "${exteriorAssigned}", ‰∏çÂãïÁî£: "${realestateAssigned}", currentTab: "${currentTab}")`);
        return false;
      }
    }

    // „Ç¢„Éº„Ç´„Ç§„Éñ„Éï„Ç£„É´„Çø„ÉºÔºàÈÄöÂ∏∏ÊôÇ„ÅØÂÆå‰∫ÜÊ∏à„ÇíÈô§Â§ñÔºâ
    const archiveFilter = document.getElementById('archiveFilter').value;
    const isArchived = p.is_archived || false;

    // ICÊãÖÂΩìËÄÖ„Å®„Åó„Å¶ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÁî≥Ë´ãGOÊ∏à„Åø„Åß„ÇÇICÈÄ≤Êçó100%Êú™Ê∫Ä„ÅØ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊâ±„ÅÑ
    const isICDesigner = designers.some(d => d.category === 'IC' && d.name.trim() === currentDesignerTab.trim());
    if (isICDesigner) {
      const icProgress = calculateICProgress(p);
      const isICComplete = icProgress === null || icProgress === 100;
      if (archiveFilter === 'active') {
        // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñË°®Á§∫: Êú™„Ç¢„Éº„Ç´„Ç§„Éñ„ÄÅ„Åæ„Åü„ÅØ„Ç¢„Éº„Ç´„Ç§„ÉñÊ∏à„Åø„Å†„ÅåICÊú™ÂÆå‰∫Ü
        if (isArchived && isICComplete) return false;
      } else if (archiveFilter === 'archived') {
        // ÂÆå‰∫ÜÊ∏àË°®Á§∫: „Ç¢„Éº„Ç´„Ç§„ÉñÊ∏à„Åø„Åã„Å§ICÂÆå‰∫Ü
        if (!isArchived || !isICComplete) return false;
      }
    } else {
      // ÈÄöÂ∏∏„ÅÆÊãÖÂΩìËÄÖ: ÂæìÊù•„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ
      if (archiveFilter === 'active' && isArchived) return false;
      if (archiveFilter === 'archived' && !isArchived) return false;
    }
    const query = document.getElementById('searchQuery').value.toLowerCase();
    if (query && !p.customer.toLowerCase().includes(query) && !(p.memo || '').toLowerCase().includes(query)) return false;

    const specFilter = document.getElementById('specFilter').value;
    if (specFilter && p.specifications !== specFilter) return false;

    // ICÈÄ≤Êçó„Éï„Ç£„É´„Çø„Éº
    const icProgressFilter = document.getElementById('icProgressFilter')?.value || '';
    if (icProgressFilter) {
      const icProgress = calculateICProgress(p);
      if (icProgressFilter === 'no_ic' && p.ic_assignee) return false;
      if (icProgressFilter === 'no_ic' && !p.ic_assignee) return true;
      if (!p.ic_assignee) return false;
      if (icProgressFilter === 'not_started' && icProgress !== 0) return false;
      if (icProgressFilter === 'in_progress' && (icProgress === 0 || icProgress === 100)) return false;
      if (icProgressFilter === 'completed' && icProgress !== 100) return false;
    }

    // ICÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Éº
    const icAssigneeFilter = document.getElementById('icAssigneeFilter')?.value || '';
    if (icAssigneeFilter && (p.ic_assignee || '') !== icAssigneeFilter) return false;

    // Â§ñÊßãÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Éº
    const exteriorAssigneeFilter = document.getElementById('exteriorAssigneeFilter')?.value || '';
    if (exteriorAssigneeFilter && (p.exterior_assignee || '') !== exteriorAssigneeFilter) return false;

    // ‰∏çÂãïÁî£ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Éº
    const realestateAssigneeFilter = document.getElementById('realestateAssigneeFilter')?.value || '';
    if (realestateAssigneeFilter && (p.realestate_assignee || '') !== realestateAssigneeFilter) return false;

    return true;
  });

  log('‚úÖ „Éï„Ç£„É´„ÇøÂæå„ÅÆÊ°à‰ª∂Êï∞:', filtered.length);
  log('‚úÖ „Éï„Ç£„É´„ÇøÂæå„ÅÆÊ°à‰ª∂:', filtered.map(p => ({ customer: p.customer, assigned_to: p.assigned_to })));

  // „ÇΩ„Éº„ÉàÂá¶ÁêÜ
  const sortOrder = document.getElementById('sortOrder')?.value || 'updated_desc';
  filtered.sort((a, b) => {
    switch (sortOrder) {
      case 'custom':
        // „Ç´„Çπ„Çø„É†È†ÜÂ∫èÔºà„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åß‰øùÂ≠ò„Åó„ÅüÈ†ÜÂ∫èÔºâ
        const customOrder = getCustomCardOrder();
        const aIdx = customOrder.indexOf(a.id);
        const bIdx = customOrder.indexOf(b.id);
        // ‰∏°Êñπ„Åå„Ç´„Çπ„Çø„É†È†ÜÂ∫è„Å´„ÅÇ„ÇãÂ†¥Âêà
        if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
        // ÁâáÊñπ„Å†„Åë„Ç´„Çπ„Çø„É†È†ÜÂ∫è„Å´„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Ç´„Çπ„Çø„É†È†Ü„ÇíÂÑ™ÂÖà
        if (aIdx !== -1) return -1;
        if (bIdx !== -1) return 1;
        // „Å©„Å°„Çâ„ÇÇ„Ç´„Çπ„Çø„É†È†ÜÂ∫è„Å´„Å™„ÅÑÂ†¥Âêà„ÅØÊõ¥Êñ∞Êó•È†Ü
        return new Date(b.updated_at || 0) - new Date(a.updated_at || 0);
      case 'updated_desc':
        return new Date(b.updated_at || 0) - new Date(a.updated_at || 0);
      case 'updated_asc':
        return new Date(a.updated_at || 0) - new Date(b.updated_at || 0);
      case 'progress_desc':
        return calculateProgress(b) - calculateProgress(a);
      case 'progress_asc':
        return calculateProgress(a) - calculateProgress(b);
      case 'customer_asc':
        return (a.customer || '').localeCompare(b.customer || '', 'ja');
      case 'customer_desc':
        return (b.customer || '').localeCompare(a.customer || '', 'ja');
      case 'created_desc':
        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
      default:
        return new Date(b.updated_at || 0) - new Date(a.updated_at || 0);
    }
  });

  if (filtered.length === 0) {
    container.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  container.style.display = 'grid';
  emptyState.style.display = 'none';
  container.innerHTML = filtered.map(project => renderProjectCard(project)).join('');

  // „Ç´„Éº„ÉâÂ±ïÈñãÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
  filtered.forEach(project => restoreCardStates(project.id));

  // „Ç´„Éº„ÉâÊèèÁîªÂæå„Å´„Çø„Çπ„ÇØ„Å®Ë≠∞‰∫ãÈå≤„ÇíË™≠„ÅøËæº„ÇÄÔºà„Éê„ÉÉ„ÉÅÂá¶ÁêÜ„ÅßN+1ÂïèÈ°å„ÇíÂõûÈÅøÔºâ
  // „Éê„ÉÉ„Ç∏„Ç´„Ç¶„É≥„ÉàË™≠„ÅøËæº„ÅøÔºà„Çø„Çπ„ÇØÊï∞„ÉªË≠∞‰∫ãÈå≤Êï∞Ôºâ
  setTimeout(async () => {
    const BATCH_SIZE = 5; // ÂêåÊôÇ„Å´5‰ª∂„Åæ„Åß
    for (let i = 0; i < filtered.length; i += BATCH_SIZE) {
      const batch = filtered.slice(i, i + BATCH_SIZE);
      await Promise.all(batch.map(project => loadBadgeCounts(project.id)));
    }
  }, 100);

  // Áµ±Ë®à„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊõ¥Êñ∞
  updateStatsDashboard();
}

// ============================================
// Áµ±Ë®à„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊ©üËÉΩ
// ============================================
let statsVisible = localStorage.getItem('statsVisible') !== 'false';

function toggleStatsDashboard() {
  statsVisible = !statsVisible;
  localStorage.setItem('statsVisible', statsVisible);
  const dashboard = document.getElementById('statsDashboard');
  if (dashboard) {
    dashboard.style.display = statsVisible ? 'block' : 'none';
    dashboard.querySelector('.stats-toggle-btn').textContent = statsVisible ? 'Áµ±Ë®à„ÇíÈùûË°®Á§∫' : 'Áµ±Ë®à„ÇíË°®Á§∫';
  }
}

function updateStatsDashboard() {
  const dashboard = document.getElementById('statsDashboard');
  if (!dashboard) return;

  // Ë°®Á§∫/ÈùûË°®Á§∫
  dashboard.style.display = statsVisible ? 'block' : 'none';

  // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊ°à‰ª∂Êï∞
  const activeProjects = projects.filter(p => !p.is_archived);
  document.getElementById('statTotalProjects').textContent = activeProjects.length;

  // Âπ≥ÂùáË®≠Ë®àÈÄ≤Êçó
  if (activeProjects.length > 0) {
    const avgDesignProgress = Math.round(activeProjects.reduce((sum, p) => sum + calculateProgress(p), 0) / activeProjects.length);
    document.getElementById('statDesignProgress').textContent = avgDesignProgress + '%';
  } else {
    document.getElementById('statDesignProgress').textContent = '0%';
  }

  // Âπ≥ÂùáICÈÄ≤Êçó
  const projectsWithIC = activeProjects.filter(p => p.ic_assignee);
  if (projectsWithIC.length > 0) {
    const avgICProgress = Math.round(projectsWithIC.reduce((sum, p) => sum + (calculateICProgress(p) || 0), 0) / projectsWithIC.length);
    document.getElementById('statICProgress').textContent = avgICProgress + '%';
  } else {
    document.getElementById('statICProgress').textContent = '-';
  }

  // ‰ªäÊúàÂÆå‰∫ÜÊï∞
  const now = new Date();
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();
  const completedThisMonth = projects.filter(p => {
    if (!p.is_archived) return false;
    const archivedDate = new Date(p.updated_at);
    return archivedDate.getMonth() === thisMonth && archivedDate.getFullYear() === thisYear;
  }).length;
  document.getElementById('statCompletedThisMonth').textContent = completedThisMonth;

  // ÊúüÈôêË∂ÖÈÅéÔºàÊúüÈôê„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å¶Ë∂ÖÈÅé„Åó„Å¶„ÅÑ„Çã„ÇÇ„ÅÆÔºâ
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const overdueProjects = activeProjects.filter(p => {
    const deadline = DeadlineManager.getDeadline(p.id);
    if (!deadline) return false;
    return new Date(deadline) < today;
  });
  const overdueCard = document.getElementById('statOverdueCard');
  if (overdueProjects.length > 0) {
    overdueCard.style.display = 'flex';
    document.getElementById('statOverdue').textContent = overdueProjects.length;
  } else {
    overdueCard.style.display = 'none';
  }
}

// Ê°à‰ª∂„Ç´„Éº„Éâ„Å´„Çπ„ÇØ„É≠„Éº„É´
function scrollToProject(projectId) {
  const card = document.querySelector(`[data-project-id="${projectId}"]`);
  if (card) {
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    card.classList.add('highlight-card');
    setTimeout(() => card.classList.remove('highlight-card'), 2000);
  }
}

// „Ç´„Éº„ÉâÂçò‰Ωç„ÅßÂÜçÊèèÁîªÔºà„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÈñãÈñâÁä∂ÊÖã„Çí‰øùÊåÅÔºâ
function updateSingleProjectCard(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const cardElement = document.querySelector(`[data-project-id="${projectId}"]`);
  if (!cardElement) return;

  // „Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÈñãÈñâÁä∂ÊÖã„Çí‰øùÊåÅ
  const sectionStates = [];
  cardElement.querySelectorAll('.card-section').forEach((section, idx) => {
    sectionStates[idx] = !section.classList.contains('collapsed');
  });

  // „Ç´„Éº„Éâ„ÇíÂÜçÊèèÁîª
  const newCard = document.createElement('div');
  newCard.innerHTML = renderProjectCard(project);
  const newCardElement = newCard.firstElementChild;

  // „Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÈñãÈñâÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
  newCardElement.querySelectorAll('.card-section').forEach((section, idx) => {
    if (sectionStates[idx]) {
      section.classList.remove('collapsed');
    }
  });

  cardElement.replaceWith(newCardElement);

  // „Éê„ÉÉ„Ç∏„Ç´„Ç¶„É≥„ÉàÂÜç„É≠„Éº„Éâ
  loadBadgeCounts(projectId);
}

function renderProjectCard(project) {
  const progress = calculateProgress(project);
  const icProgress = calculateICProgress(project);
  const exteriorProgress = calculateExteriorProgress(project);
  const realestateProgress = calculateRealestateProgress(project);
  const constructionProgress = calculateConstructionProgress(project);
  const progressData = project.progress || {};
  const staleDays = getProjectStaleDays(project);
  const tasks = getTasksForAssignee(project.assigned_to);

  // „Çµ„Ç§„Éâ„Éê„Éº„ÅßÈÅ∏Êäû‰∏≠„ÅÆÊãÖÂΩìËÄÖ„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÂèñÂæóÔºàICÈÅ∏ÊäûÊôÇ„ÅØICÊ•≠Âãô„ÅÆ„ÅøË°®Á§∫Á≠âÔºâ
  const selectedDesignerCategory = currentDesignerTab && currentDesignerTab !== 'ALL' && currentDesignerTab !== 'ARCHIVED'
    ? designers.find(d => d.name.trim() === currentDesignerTab.trim())?.category || null
    : null;
  // Ë°®Á§∫„Ç´„ÉÜ„Ç¥„É™Ôºà„Çµ„Ç§„Éâ„Éê„ÉºÈÅ∏ÊäûÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÅÆ„Ç´„ÉÜ„Ç¥„É™Ôºâ
  const viewCategory = selectedDesignerCategory || currentUserCategory;

  // ÂÖ®„Çø„Çπ„ÇØÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
  const canArchive = tasks.every(taskDef => {
    const task = progressData[taskDef.task_key] || { completed: false, state: '' };
    if (!task.completed) return false;
    if (taskDef.has_state && task.state !== '‰øùÂ≠òÊ∏à') return false;
    return true;
  });

  // Áî≥Ë´ãGOÊù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
  const applicationGoEnabled = canPressApplicationGo(project);


  const tasksHtml = tasks.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '', due_date: '' };
    const isApplicationGo = key === 'application';

    // Áî≥Ë´ãGo„ÅÆÂ†¥Âêà„ÅØÁâπÂà•„Å™„Éï„É´„ÉØ„Ç§„ÉâË°®Á§∫
    if (isApplicationGo) {
      if (task.completed) {
        // Êó¢„Å´ÂÆå‰∫ÜÊ∏à„Åø„ÅÆÂ†¥Âêà
        return `<div class="application-go-container application-go-completed">
          <div class="application-go-icon">‚úì</div>
          <div class="application-go-text">${taskDef.task_name} ÂÆå‰∫Ü</div>
        </div>`;
      } else if (applicationGoEnabled) {
        // Êù°‰ª∂„ÅåÊèÉ„Å£„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºö„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å™„Éú„Çø„É≥
        return `<div class="application-go-container application-go-ready" onclick="confirmApplicationGo('${project.id}')">
          <div class="application-go-icon">üöÄ</div>
          <div class="application-go-text">${taskDef.task_name}</div>
          <div class="application-go-arrow">‚Üí</div>
        </div>`;
      } else {
        // Êù°‰ª∂„ÅåÊèÉ„Å£„Å¶„ÅÑ„Å™„ÅÑÂ†¥ÂêàÔºöÁÑ°ÂäπË°®Á§∫ÔºàÂãïÁöÑ„Å´„ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÁîüÊàêÔºâ
        const requiredTasks = getApplicationGoRequiredTasks();
        const tooltip = requiredTasks.length > 0
          ? requiredTasks.map(r => `${r.task_name}:${r.finalState}`).join('„ÄÅ') + ' „ÅåÂøÖË¶Å'
          : 'Â§™ÈôΩÂÖâ:‰øùÂ≠òÊ∏à„ÄÅÁµ¶ÊéíÊ∞¥:‰øùÂ≠òÊ∏à„ÄÅÊèõÊ∞ó:‰øùÂ≠òÊ∏à„ÄÅ„Çµ„ÉÉ„Ç∑:‰øùÂ≠òÊ∏à „ÅåÂøÖË¶Å';
        return `<div class="application-go-container application-go-disabled" title="${tooltip}">
          <div class="application-go-icon">üîí</div>
          <div class="application-go-text">${taskDef.task_name}</div>
          <div class="application-go-status">Êù°‰ª∂Êú™ÈÅî</div>
        </div>`;
      }
    }

    // „É°„Éº„É´„Éú„Çø„É≥Ë°®Á§∫Êù°‰ª∂: „Çø„Çπ„ÇØË®≠ÂÆö„Åß„É°„Éº„É´ÊúâÂäπÔºàhas_email_button=trueÔºâ„ÅÆÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
    // Á§æÂÜÖÂØæÂøú„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÂ†¥Âêà„ÅØÈùûË°®Á§∫
    // Â§™ÈôΩÂÖâ‰æùÈ†º„ÅØÁâπÂà•„Å™Â§ñÈÉ®„É™„É≥„ÇØ„Éú„Çø„É≥„ÇíË°®Á§∫
    const isInternalStatus = INTERNAL_STATUSES.includes(task.state);
    const showEmailButton = taskDef.has_email_button === true && !isInternalStatus;
    let emailBtn = '';
    if (key === 'solar') {
      // Â§™ÈôΩÂÖâ‰æùÈ†º„ÅØÂ§ñÈÉ®„Çµ„Ç§„Éà„Å∏„ÅÆ„É™„É≥„ÇØ„Éú„Çø„É≥
      emailBtn = `<a href="https://bmp-shop.com/nextsolar/wp/wp-login.php" target="_blank" class="task-email-btn" title="Â§™ÈôΩÂÖâ„Çµ„Ç§„Éà„ÇíÈñã„Åè" style="text-decoration:none;">üîó</a>`;
    } else if (showEmailButton) {
      emailBtn = `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="„É°„Éº„É´‰ΩúÊàê">üìß</button>`;
    }

    let stateSelect = '';
    const stateOptions = getTaskStateOptions(key);
    if (stateOptions && Array.isArray(stateOptions)) {
      // „Çπ„ÉÜ„Éº„Çø„ÇπËâ≤ÂàÜ„Åë: ÊúÄÂæå„ÅÆÈÅ∏ÊäûËÇ¢=Èùí„ÄÅÁ©∫/-=ÁôΩ„ÄÅ„Åù„ÅÆ‰ªñ=ÈªÑ„ÄÅIC„Çø„Çπ„ÇØÁâπÂà•Âá¶ÁêÜ„ÅÇ„Çä
      const lastOption = stateOptions[stateOptions.length - 1];
      let stateClass = getStateColorClass(task.state, lastOption, key);
      // „É°„Éº„Ç´„ÉºÈÅ∏ÊäûÊôÇ„ÅÆ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíÁîüÊàê
      let tooltip = '';
      if (IC_MAKER_TASKS.includes(key) && task.state && task.state !== '-') {
        if (!INTERNAL_STATUSES.includes(task.state)) {
          tooltip = ` title="üìß ${task.state}„Å´„É°„Éº„É´ÈÄÅ‰ø°ÂèØËÉΩ"`;
        }
      }
      stateSelect = `<select class="task-state-select ${stateClass}" data-last-option="${lastOption}"${tooltip} onchange="updateTaskStateWithColor(this, '${project.id}', '${key}')">${stateOptions.map(state => `<option value="${state}" ${task.state === state ? 'selected' : ''}>${state || '-'}</option>`).join('')}</select>`;
    }

    // ‰æùÈ†ºÊó•„Éê„ÉÉ„Ç∏
    const requestDateBadge = task.request_date
      ? `<span class="request-date-badge" title="‰æùÈ†ºÊó•: ${task.request_date}">${formatDateShort(task.request_date)}</span>`
      : '';

    return `<div class="task-item">
      <span class="task-label">${taskDef.task_name}</span>${stateSelect}${requestDateBadge}${emailBtn}</div>`;
  }).join('');

  // ICÊ•≠ÂãôÂÜÖÂÆπ„ÇíÁîüÊàêÔºàICÊãÖÂΩìËÄÖ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
  const icTasks = tasksV2.filter(t => t.category === 'IC').sort((a, b) => a.display_order - b.display_order);
  const icTasksHtml = icTasks.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '', due_date: '' };

    const hasVendor = taskVendorMappings.some(m => m.task_id === taskDef.id);
    const isInternalStatus = INTERNAL_STATUSES.includes(task.state);
    const showEmailButton = taskDef.has_email_button !== false && hasVendor && !isInternalStatus;
    const emailBtn = showEmailButton ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="„É°„Éº„É´‰ΩúÊàê">üìß</button>` : '';

    let stateSelect = '';
    const stateOptions = getTaskStateOptions(key);
    if (stateOptions && Array.isArray(stateOptions)) {
      const lastOption = stateOptions[stateOptions.length - 1];
      let stateClass = getStateColorClass(task.state, lastOption, key);
      let tooltip = '';
      if (IC_MAKER_TASKS.includes(key) && task.state && task.state !== '-') {
        if (!INTERNAL_STATUSES.includes(task.state)) {
          tooltip = ` title="üìß ${task.state}„Å´„É°„Éº„É´ÈÄÅ‰ø°ÂèØËÉΩ"`;
        }
      }
      stateSelect = `<select class="task-state-select ${stateClass}" data-last-option="${lastOption}"${tooltip} onchange="updateTaskStateWithColor(this, '${project.id}', '${key}')">${stateOptions.map(state => `<option value="${state}" ${task.state === state ? 'selected' : ''}>${state || '-'}</option>`).join('')}</select>`;
    }

    // ‰æùÈ†ºÊó•„Éê„ÉÉ„Ç∏
    const requestDateBadge = task.request_date
      ? `<span class="request-date-badge" title="‰æùÈ†ºÊó•: ${task.request_date}">${formatDateShort(task.request_date)}</span>`
      : '';

    // Á¢∫ÂÆöÂõ≥„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà„Å´ÊúüÈôêÂÖ•Âäõ„ÇíËøΩÂä†
    const dueDateInput = key === 'ic_final_checklist'
      ? `<input type="date" class="task-due-input" value="${task.due_date || ''}" onchange="updateTaskDueDate('${project.id}', '${key}', this.value)" title="ÊúüÈôê„ÇíË®≠ÂÆö">`
      : '';

    return `<div class="task-item">
      <span class="task-label">${taskDef.task_name}</span>${stateSelect}${dueDateInput}${requestDateBadge}${emailBtn}</div>`;
  }).join('');

  // Â§ñÊßãÊ•≠ÂãôÂÜÖÂÆπ„ÇíÁîüÊàê
  const exteriorTasksList = getTasksForCategory('Â§ñÊßã');
  const exteriorTasksHtml = exteriorTasksList.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '', due_date: '' };

    const hasVendor = taskVendorMappings.some(m => m.task_id === taskDef.id);
    const isInternalStatus = INTERNAL_STATUSES.includes(task.state);
    const showEmailButton = taskDef.has_email_button !== false && hasVendor && !isInternalStatus;
    const emailBtn = showEmailButton ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="„É°„Éº„É´‰ΩúÊàê">üìß</button>` : '';

    let stateSelect = '';
    const stateOptions = getTaskStateOptions(key);
    if (stateOptions && Array.isArray(stateOptions)) {
      const lastOption = stateOptions[stateOptions.length - 1];
      let stateClass = getStateColorClass(task.state, lastOption, key);
      stateSelect = `<select class="task-state-select ${stateClass}" data-last-option="${lastOption}" onchange="updateTaskStateWithColor(this, '${project.id}', '${key}')">${stateOptions.map(state => `<option value="${state}" ${task.state === state ? 'selected' : ''}>${state || '-'}</option>`).join('')}</select>`;
    }

    // ‰æùÈ†ºÊó•„Éê„ÉÉ„Ç∏
    const requestDateBadge = task.request_date
      ? `<span class="request-date-badge" title="‰æùÈ†ºÊó•: ${task.request_date}">${formatDateShort(task.request_date)}</span>`
      : '';

    return `<div class="task-item">
      <span class="task-label">${taskDef.task_name}</span>${stateSelect}${requestDateBadge}${emailBtn}</div>`;
  }).join('');

  // ‰∏çÂãïÁî£Ê•≠ÂãôÂÜÖÂÆπ„ÇíÁîüÊàê
  const realestateTasksList = getTasksForCategory('‰∏çÂãïÁî£');
  const realestateTasksHtml = realestateTasksList.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '', due_date: '' };

    const hasVendor = taskVendorMappings.some(m => m.task_id === taskDef.id);
    const isInternalStatus = INTERNAL_STATUSES.includes(task.state);
    const showEmailButton = taskDef.has_email_button !== false && hasVendor && !isInternalStatus;
    const emailBtn = showEmailButton ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="„É°„Éº„É´‰ΩúÊàê">üìß</button>` : '';

    let stateSelect = '';
    const stateOptions = getTaskStateOptions(key);
    if (stateOptions && Array.isArray(stateOptions)) {
      const lastOption = stateOptions[stateOptions.length - 1];
      let stateClass = getStateColorClass(task.state, lastOption, key);
      stateSelect = `<select class="task-state-select ${stateClass}" data-last-option="${lastOption}" onchange="updateTaskStateWithColor(this, '${project.id}', '${key}')">${stateOptions.map(state => `<option value="${state}" ${task.state === state ? 'selected' : ''}>${state || '-'}</option>`).join('')}</select>`;
    }

    // ‰æùÈ†ºÊó•„Éê„ÉÉ„Ç∏
    const requestDateBadge = task.request_date
      ? `<span class="request-date-badge" title="‰æùÈ†ºÊó•: ${task.request_date}">${formatDateShort(task.request_date)}</span>`
      : '';

    return `<div class="task-item">
      <span class="task-label">${taskDef.task_name}</span>${stateSelect}${requestDateBadge}${emailBtn}</div>`;
  }).join('');

  // Â∑•‰∫ãÊ•≠ÂãôÂÜÖÂÆπ„ÇíÁîüÊàê
  const constructionTasksList = getTasksForCategory('Â∑•‰∫ã');
  const constructionTasksHtml = constructionTasksList.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '', due_date: '' };

    const hasVendor = taskVendorMappings.some(m => m.task_id === taskDef.id);
    const isInternalStatus = INTERNAL_STATUSES.includes(task.state);
    const showEmailButton = taskDef.has_email_button !== false && hasVendor && !isInternalStatus;
    const emailBtn = showEmailButton ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="„É°„Éº„É´‰ΩúÊàê">üìß</button>` : '';

    let stateSelect = '';
    const stateOptions = getTaskStateOptions(key);
    if (stateOptions && Array.isArray(stateOptions)) {
      const lastOption = stateOptions[stateOptions.length - 1];
      let stateClass = getStateColorClass(task.state, lastOption, key);
      stateSelect = `<select class="task-state-select ${stateClass}" data-last-option="${lastOption}" onchange="updateTaskStateWithColor(this, '${project.id}', '${key}')">${stateOptions.map(state => `<option value="${state}" ${task.state === state ? 'selected' : ''}>${state || '-'}</option>`).join('')}</select>`;
    }

    // ‰æùÈ†ºÊó•„Éê„ÉÉ„Ç∏
    const requestDateBadge = task.request_date
      ? `<span class="request-date-badge" title="‰æùÈ†ºÊó•: ${task.request_date}">${formatDateShort(task.request_date)}</span>`
      : '';

    return `<div class="task-item">
      <span class="task-label">${taskDef.task_name}</span>${stateSelect}${requestDateBadge}${emailBtn}</div>`;
  }).join('');

  const isSelected = BatchOperations.isSelected(project.id);

  // ÊúüÈôêË∂ÖÈÅé„ÉÅ„Çß„ÉÉ„ÇØ
  const deadline = DeadlineManager.getDeadline(project.id);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const isOverdue = deadline && new Date(deadline) < today && !project.is_archived;
  const isDueSoon = deadline && !isOverdue && (new Date(deadline) - today) <= 3 * 24 * 60 * 60 * 1000 && !project.is_archived;

  return `<div class="project-card ${isSelected ? 'selected' : ''} ${isOverdue ? 'overdue' : ''} ${isDueSoon ? 'due-soon' : ''}" data-project-id="${project.id}" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" ondragend="handleDragEnd(event)">
    <div class="card-header">
      <div style="display: flex; align-items: flex-start; gap: 8px;">
        <input type="checkbox" class="batch-checkbox" data-project-id="${project.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); BatchOperations.toggle('${project.id}')" title="ÈÅ∏Êäû">
        <div>
          <div class="card-title"><span class="customer-name">${escapeHtml(project.customer)}</span><span class="badge badge-primary">${escapeHtml(project.specifications || 'LIFE')}</span>${project.is_archived ? '<span class="badge badge-success">ÂÆå‰∫ÜÊ∏à„Åø</span>' : ''}${!project.is_archived && staleDays >= 7 ? `<span class="badge badge-warning" title="${staleDays}Êó•ÈñìÊú™Êõ¥Êñ∞">‚ö†Ô∏è ${staleDays}Êó•</span>` : ''}</div>
          <div class="card-subtitle"><span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this)" style="cursor: pointer; text-decoration: underline dotted;" title="„ÇØ„É™„ÉÉ„ÇØ„ÅßÊãÖÂΩìËÄÖÂ§âÊõ¥">Ë®≠Ë®àÔºö${escapeHtml(project.assigned_to || 'Êú™Ââ≤ÂΩì')}</span>${project.ic_assignee ? `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'ic_assignee')" style="cursor: pointer; text-decoration: underline dotted;" title="„ÇØ„É™„ÉÉ„ÇØ„ÅßICÊãÖÂΩìËÄÖÂ§âÊõ¥"> | ICÔºö${escapeHtml(project.ic_assignee)}</span>` : `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'ic_assignee')" style="cursor: pointer; color: var(--text-muted); font-size: 11px;" title="ICÊãÖÂΩìËÄÖ„ÇíËøΩÂä†"> | +IC</span>`}${project.exterior_assignee ? `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'exterior_assignee')" style="cursor: pointer; text-decoration: underline dotted;" title="„ÇØ„É™„ÉÉ„ÇØ„ÅßÂ§ñÊßãÊãÖÂΩìËÄÖÂ§âÊõ¥"> | Â§ñÊßãÔºö${escapeHtml(project.exterior_assignee)}</span>` : `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'exterior_assignee')" style="cursor: pointer; color: var(--text-muted); font-size: 11px;" title="Â§ñÊßãÊãÖÂΩìËÄÖ„ÇíËøΩÂä†"> | +Â§ñÊßã</span>`}${project.realestate_assignee ? `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'realestate_assignee')" style="cursor: pointer; text-decoration: underline dotted;" title="„ÇØ„É™„ÉÉ„ÇØ„Åß‰∏çÂãïÁî£ÊãÖÂΩìËÄÖÂ§âÊõ¥"> | ‰∏çÂãïÁî£Ôºö${escapeHtml(project.realestate_assignee)}</span>` : `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'realestate_assignee')" style="cursor: pointer; color: var(--text-muted); font-size: 11px;" title="‰∏çÂãïÁî£ÊãÖÂΩìËÄÖ„ÇíËøΩÂä†"> | +‰∏çÂãïÁî£</span>`}${project.construction_assignee ? `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'construction_assignee')" style="cursor: pointer; text-decoration: underline dotted;" title="„ÇØ„É™„ÉÉ„ÇØ„ÅßÂ∑•‰∫ãÊãÖÂΩìËÄÖÂ§âÊõ¥"> | Â∑•‰∫ãÔºö${escapeHtml(project.construction_assignee)}</span>` : `<span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this, 'construction_assignee')" style="cursor: pointer; color: var(--text-muted); font-size: 11px;" title="Â∑•‰∫ãÊãÖÂΩìËÄÖ„ÇíËøΩÂä†"> | +Â∑•‰∫ã</span>`}${(() => { const ds = DeadlineManager.getStatus(project.id); return ds ? ` <span style="background: ${ds.color}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 8px;" onclick="event.stopPropagation(); DeadlineManager.showModal('${project.id}')" title="ÊúüÈôê„ÇíÂ§âÊõ¥">üìÖ ${ds.label}</span>` : ` <span style="color: var(--text-muted); font-size: 11px; cursor: pointer;" onclick="event.stopPropagation(); DeadlineManager.showModal('${project.id}')" title="ÊúüÈôê„ÇíË®≠ÂÆö">üìÖ ÊúüÈôêË®≠ÂÆö</span>`; })()}</div>
        </div>
      </div>
      <div style="display: flex; gap: 8px; align-items: center;">
        ${project.is_archived ? `
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; background: var(--success-color); color: white; padding: 4px 12px; border-radius: 6px; font-size: 13px;">
            <input type="checkbox" checked onchange="restoreFromArchive('${project.id}')" style="width: 16px; height: 16px; cursor: pointer;">
            ÂÆå‰∫ÜÊ∏à
          </label>
        ` : ''}
        <button class="btn btn-ghost btn-small" onclick="quickEmail('${project.id}')" title="„É°„Éº„É´‰ΩúÊàê">üìß</button>
        <button class="btn btn-ghost btn-small" onclick="editProject('${project.id}')">Á∑®ÈõÜ</button>
      </div>
    </div>
    ${(() => {
      // ÈÄ≤ÊçóÁéá„Å´Âøú„Åò„ÅüËâ≤„ÇíÂèñÂæó
      const getProgressColor = (pct) => {
        if (pct >= 80) return 'var(--success-color)';
        if (pct >= 50) return 'var(--primary-color)';
        if (pct >= 25) return 'var(--warning-color)';
        return 'var(--danger-color)';
      };
      const designColor = getProgressColor(progress);
      const icColor = icProgress !== null ? getProgressColor(icProgress) : 'var(--info-color)';
      const extColor = exteriorProgress !== null ? getProgressColor(exteriorProgress) : 'var(--info-color)';
      const reColor = realestateProgress !== null ? getProgressColor(realestateProgress) : 'var(--info-color)';
      const conColor = constructionProgress !== null ? getProgressColor(constructionProgress) : 'var(--info-color)';

      // ÈÉ®ÁΩ≤Âà•ÈÄ≤ÊçóË°®Á§∫
      if (viewCategory === 'admin' || !viewCategory) {
        // ÁÆ°ÁêÜËÄÖ: „Åô„Åπ„Å¶„ÅÆÈÄ≤Êçó„ÇíË°®Á§∫ÔºàÊãÖÂΩìËÄÖ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„ÅÆ„ÅøÔºâ
        let html = `<div class="progress-section"><div class="progress-header"><span class="progress-label">Ë®≠Ë®àÈÄ≤Êçó</span><span class="progress-value" style="color: ${designColor}">${progress}%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${progress}%; background: ${designColor}"></div></div>`;
        if (icProgress !== null) {
          html += `<div class="progress-header" style="margin-top:8px"><span class="progress-label">ICÈÄ≤Êçó</span><span class="progress-value" style="color: ${icColor}">${icProgress}%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${icProgress}%; background: ${icColor}"></div></div>`;
        }
        if (exteriorProgress !== null) {
          html += `<div class="progress-header" style="margin-top:8px"><span class="progress-label">Â§ñÊßãÈÄ≤Êçó</span><span class="progress-value" style="color: ${extColor}">${exteriorProgress}%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${exteriorProgress}%; background: ${extColor}"></div></div>`;
        }
        if (realestateProgress !== null) {
          html += `<div class="progress-header" style="margin-top:8px"><span class="progress-label">‰∏çÂãïÁî£ÈÄ≤Êçó</span><span class="progress-value" style="color: ${reColor}">${realestateProgress}%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${realestateProgress}%; background: ${reColor}"></div></div>`;
        }
        if (constructionProgress !== null) {
          html += `<div class="progress-header" style="margin-top:8px"><span class="progress-label">Â∑•‰∫ãÈÄ≤Êçó</span><span class="progress-value" style="color: ${conColor}">${constructionProgress}%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${constructionProgress}%; background: ${conColor}"></div></div>`;
        }
        html += '</div>';
        return html;
      } else if (viewCategory === 'Ë®≠Ë®à') {
        // Ë®≠Ë®àÊãÖÂΩì: Ë®≠Ë®àÈÄ≤Êçó„ÅÆ„Åø
        return `<div class="progress-section"><div class="progress-header"><span class="progress-label">Ë®≠Ë®àÈÄ≤Êçó</span><span class="progress-value" style="color: ${designColor}">${progress}%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${progress}%; background: ${designColor}"></div></div></div>`;
      } else if (viewCategory === 'IC') {
        // ICÊãÖÂΩì: ICÈÄ≤Êçó„ÅÆ„Åø
        return icProgress !== null ? `<div class="progress-section"><div class="progress-header"><span class="progress-label">ICÈÄ≤Êçó</span><span class="progress-value" style="color: ${icColor}">${icProgress}%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${icProgress}%; background: ${icColor}"></div></div></div>` : '<div class="progress-section"><p style="color: var(--text-muted); font-size: 13px;">ICÊãÖÂΩìËÄÖ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p></div>';
      } else if (viewCategory === 'Â§ñÊßã') {
        // Â§ñÊßãÊãÖÂΩì: Â§ñÊßãÈÄ≤Êçó„ÅÆ„Åø
        return exteriorProgress !== null ? `<div class="progress-section"><div class="progress-header"><span class="progress-label">Â§ñÊßãÈÄ≤Êçó</span><span class="progress-value" style="color: ${extColor}">${exteriorProgress}%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${exteriorProgress}%; background: ${extColor}"></div></div></div>` : '<div class="progress-section"><p style="color: var(--text-muted); font-size: 13px;">Â§ñÊßã„Çø„Çπ„ÇØ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p></div>';
      } else if (viewCategory === '‰∏çÂãïÁî£') {
        // ‰∏çÂãïÁî£ÊãÖÂΩì: ‰∏çÂãïÁî£ÈÄ≤Êçó„ÅÆ„Åø
        return realestateProgress !== null ? `<div class="progress-section"><div class="progress-header"><span class="progress-label">‰∏çÂãïÁî£ÈÄ≤Êçó</span><span class="progress-value" style="color: ${reColor}">${realestateProgress}%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${realestateProgress}%; background: ${reColor}"></div></div></div>` : '<div class="progress-section"><p style="color: var(--text-muted); font-size: 13px;">‰∏çÂãïÁî£„Çø„Çπ„ÇØ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p></div>';
      } else if (viewCategory === 'Â∑•‰∫ã') {
        // Â∑•‰∫ãÊãÖÂΩì: Â∑•‰∫ãÈÄ≤Êçó„ÅÆ„Åø
        return constructionProgress !== null ? `<div class="progress-section"><div class="progress-header"><span class="progress-label">Â∑•‰∫ãÈÄ≤Êçó</span><span class="progress-value" style="color: ${conColor}">${constructionProgress}%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${constructionProgress}%; background: ${conColor}"></div></div></div>` : '<div class="progress-section"><p style="color: var(--text-muted); font-size: 13px;">Â∑•‰∫ã„Çø„Çπ„ÇØ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p></div>';
      } else {
        // „Åù„ÅÆ‰ªñ: ÈÄ≤Êçó„Å™„Åó
        return '<div class="progress-section"><p style="color: var(--text-muted); font-size: 13px;">ÈÄ≤ÊçóÁÆ°ÁêÜ„ÅØÁèæÂú®Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p></div>';
      }
    })()}

    <div class="card-quick-actions">
      <button class="quick-action-btn" onclick="openCardModal('${project.id}', 'tasks')">‚úÖ „Çø„Çπ„ÇØ<span class="section-badge badge-warning" id="taskBadge_${project.id}" style="display:none">0</span></button>
      <button class="quick-action-btn" onclick="openCardModal('${project.id}', 'memo')">üìù „É°„É¢<span class="section-badge badge-success" id="memoBadge_${project.id}" style="display:${project.shared_memo ? 'inline-flex' : 'none'}">1</span></button>
      <button class="quick-action-btn" onclick="openCardModal('${project.id}', 'minutes')">üìÑ Ë≠∞‰∫ãÈå≤<span class="section-badge badge-primary" id="minutesBadge_${project.id}" style="display:none">0</span></button>
      <button class="quick-action-btn" onclick="openCardModal('${project.id}', 'handover')">üìã ÂºïÁ∂ôÊõ∏<span class="section-badge badge-info" id="handoverBadge_${project.id}" style="display:none">1</span></button>
    </div>

    ${(() => {
      // ÈÉ®ÁΩ≤Âà•Ê•≠ÂãôÂÜÖÂÆπË°®Á§∫
      // ÁÆ°ÁêÜËÄÖ: Êéí‰ªñÁöÑ„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥Ôºà1„Å§Èñã„Åè„Å®‰ªñ„ÅåÈñâ„Åò„ÇãÔºâ
      // ÈùûÁÆ°ÁêÜËÄÖ: Ëá™ÂàÜ„ÅÆÈÉ®ÁΩ≤„ÅÆ„Åø„ÄÅ„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„Å™„Åó„ÅßÁõ¥Êé•Ë°®Á§∫

      // ÂêÑ„Ç´„ÉÜ„Ç¥„É™„ÅÆÂÆå‰∫Ü„ÉªÊú™ÂÆå‰∫Ü„Çø„Çπ„ÇØÊï∞„ÇíË®àÁÆó
      const countTasks = (taskList) => {
        const total = taskList.length;
        const completed = taskList.filter(t => {
          const task = progressData[t.task_key] || {};
          const stateOptions = getTaskStateOptions(t.task_key);
          const lastOption = stateOptions && stateOptions.length > 0 ? stateOptions[stateOptions.length - 1] : null;
          return task.state === lastOption;
        }).length;
        return { completed, total, incomplete: total - completed };
      };

      const designTaskList = tasksV2.filter(t => t.category === 'Ë®≠Ë®à').sort((a, b) => a.display_order - b.display_order);
      const designCount = countTasks(designTaskList);
      const icCount = countTasks(icTasks);
      const exteriorCount = countTasks(exteriorTasksList);
      const realestateCount = countTasks(realestateTasksList);
      const constructionCount = countTasks(constructionTasksList);

      // ÁÆ°ÁêÜËÄÖÂêë„Åë: „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ÔºàÂàùÊúüÁä∂ÊÖã„ÅØÈñâ„Åò„Çã„ÄÅÊú™ÂÆå‰∫Ü/ÂÖ®„Çø„Çπ„ÇØÊï∞„ÇíË°®Á§∫Ôºâ
      const getBizContent = (title, icon, content, count) => {
        const countBadge = count.total > 0 ? `<span class="biz-task-count" style="margin-left:8px;font-size:12px;color:${count.incomplete > 0 ? 'var(--warning-color)' : 'var(--success-color)'};">${count.incomplete}/${count.total}</span>` : '';
        return `<div class="card-section biz-section collapsed"><div class="card-section-header" onclick="toggleBizSection(this, '${project.id}')"><span class="card-section-title">${icon} ${title}${countBadge}</span><span class="card-section-toggle">‚ñº</span></div><div class="card-section-content">${content}</div></div>`;
      };

      // ÈùûÁÆ°ÁêÜËÄÖÂêë„Åë: „Ç∑„É≥„Éó„É´„Å™„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„ÅÇ„Çä„ÄÅÂàùÊúüÁä∂ÊÖã„ÅØÈñâ„Åò„Çã„ÄÅÊú™ÂÆå‰∫Ü/ÂÖ®„Çø„Çπ„ÇØÊï∞„ÇíË°®Á§∫Ôºâ
      const getSimpleBizContent = (title, icon, content, count) => {
        const countBadge = count.total > 0 ? `<span class="biz-task-count" style="margin-left:8px;font-size:12px;color:${count.incomplete > 0 ? 'var(--warning-color)' : 'var(--success-color)'};">${count.incomplete}/${count.total}</span>` : '';
        return `<div class="card-section biz-section collapsed"><div class="card-section-header" onclick="toggleBizSection(this, '${project.id}')"><span class="card-section-title">${icon} ${title}${countBadge}</span><span class="card-section-toggle">‚ñº</span></div><div class="card-section-content">${content}</div></div>`;
      };

      if (viewCategory === 'admin' || !viewCategory) {
        // ÁÆ°ÁêÜËÄÖ/ALL: „Åô„Åπ„Å¶„ÅÆÊ•≠ÂãôÂÜÖÂÆπ„ÇíË°®Á§∫ÔºàÊéí‰ªñÁöÑ„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ÔºâÈ†ÜÂ∫è: ‰∏çÂãïÁî£‚ÜíË®≠Ë®à‚ÜíIC‚ÜíÂ∑•‰∫ã‚ÜíÂ§ñÊßã
        return `<div class="biz-sections-group">
    ${getBizContent('‰∏çÂãïÁî£Ê•≠ÂãôÂÜÖÂÆπ', 'üè¢', realestateTasksList.length > 0 ? `<div class="tasks-grid">${realestateTasksHtml}</div>` : '<p style="color: var(--text-muted); font-size: 13px;">‰∏çÂãïÁî£„Çø„Çπ„ÇØ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>', realestateCount)}
    ${getBizContent('Ë®≠Ë®àÊ•≠ÂãôÂÜÖÂÆπ', 'üìê', `<div class="tasks-grid">${tasksHtml}</div>`, designCount)}
    ${getBizContent('ICÊ•≠ÂãôÂÜÖÂÆπ', 'üé®', icTasks.length > 0 ? `<div class="tasks-grid">${icTasksHtml}</div>` : '<p style="color: var(--text-muted); font-size: 13px;">IC„Çø„Çπ„ÇØ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>', icCount)}
    ${getBizContent('Â∑•‰∫ãÊ•≠ÂãôÂÜÖÂÆπ', 'üî®', constructionTasksList.length > 0 ? `<div class="tasks-grid">${constructionTasksHtml}</div>` : '<p style="color: var(--text-muted); font-size: 13px;">Â∑•‰∫ã„Çø„Çπ„ÇØ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>', constructionCount)}
    ${getBizContent('Â§ñÊßãÊ•≠ÂãôÂÜÖÂÆπ', 'üè°', exteriorTasksList.length > 0 ? `<div class="tasks-grid">${exteriorTasksHtml}</div>` : '<p style="color: var(--text-muted); font-size: 13px;">Â§ñÊßã„Çø„Çπ„ÇØ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>', exteriorCount)}</div>`;
      } else if (viewCategory === 'Ë®≠Ë®à') {
        // Ë®≠Ë®àÊãÖÂΩì: Ë®≠Ë®àÊ•≠ÂãôÂÜÖÂÆπ„ÅÆ„Åø„ÄÅ„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„Å™„Åó
        return getSimpleBizContent('Ë®≠Ë®àÊ•≠ÂãôÂÜÖÂÆπ', 'üìê', `<div class="tasks-grid">${tasksHtml}</div>`, designCount);
      } else if (viewCategory === 'IC') {
        // ICÊãÖÂΩì: ICÊ•≠ÂãôÂÜÖÂÆπ„ÅÆ„Åø„ÄÅ„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„Å™„Åó
        return getSimpleBizContent('ICÊ•≠ÂãôÂÜÖÂÆπ', 'üé®', icTasks.length > 0 ? `<div class="tasks-grid">${icTasksHtml}</div>` : '<p style="color: var(--text-muted); font-size: 13px;">IC„Çø„Çπ„ÇØ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>', icCount);
      } else if (viewCategory === 'Â§ñÊßã') {
        // Â§ñÊßãÊãÖÂΩì: Â§ñÊßãÊ•≠ÂãôÂÜÖÂÆπ„ÅÆ„Åø„ÄÅ„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„Å™„Åó
        return getSimpleBizContent('Â§ñÊßãÊ•≠ÂãôÂÜÖÂÆπ', 'üè°', exteriorTasksList.length > 0 ? `<div class="tasks-grid">${exteriorTasksHtml}</div>` : '<p style="color: var(--text-muted); font-size: 13px;">Â§ñÊßã„Çø„Çπ„ÇØ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>', exteriorCount);
      } else if (viewCategory === '‰∏çÂãïÁî£') {
        // ‰∏çÂãïÁî£ÊãÖÂΩì: ‰∏çÂãïÁî£Ê•≠ÂãôÂÜÖÂÆπ„ÅÆ„Åø„ÄÅ„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„Å™„Åó
        return getSimpleBizContent('‰∏çÂãïÁî£Ê•≠ÂãôÂÜÖÂÆπ', 'üè¢', realestateTasksList.length > 0 ? `<div class="tasks-grid">${realestateTasksHtml}</div>` : '<p style="color: var(--text-muted); font-size: 13px;">‰∏çÂãïÁî£„Çø„Çπ„ÇØ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>', realestateCount);
      } else if (viewCategory === 'Â∑•‰∫ã') {
        // Â∑•‰∫ãÊãÖÂΩì: Â∑•‰∫ãÊ•≠ÂãôÂÜÖÂÆπ„ÅÆ„Åø„ÄÅ„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„Å™„Åó
        return getSimpleBizContent('Â∑•‰∫ãÊ•≠ÂãôÂÜÖÂÆπ', 'üî®', constructionTasksList.length > 0 ? `<div class="tasks-grid">${constructionTasksHtml}</div>` : '<p style="color: var(--text-muted); font-size: 13px;">Â∑•‰∫ã„Çø„Çπ„ÇØ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>', constructionCount);
      } else {
        return '';
      }
    })()}

    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--bg-secondary);display:flex;justify-content:space-between;align-items:center"><span style="font-size:13px;color:var(--text-muted)">Êõ¥Êñ∞: ${formatDateTime(project.updated_at)}</span><button class="btn btn-danger btn-small" onclick="deleteProject('${project.id}')">ÂâäÈô§</button></div>
  </div>`;
}

function calculateProgress(project) {
  const progressData = project.progress || {};
  const tasks = getTasksForAssignee(project.assigned_to);
  if (tasks.length === 0) return 0;
  const completed = tasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / tasks.length) * 100);
}

// Ê°à‰ª∂„ÅÆÊú™Êõ¥Êñ∞Êó•Êï∞„ÇíË®àÁÆó
function getProjectStaleDays(project) {
  if (!project.updated_at) return 0;
  const lastUpdate = new Date(project.updated_at);
  const now = new Date();
  const diffMs = now - lastUpdate;
  return Math.floor(diffMs / (1000 * 60 * 60 * 24));
}

// ICÊãÖÂΩìËÄÖÁî®„ÅÆÈÄ≤ÊçóÁéáË®àÁÆóÔºàIC„Çø„Çπ„ÇØ„Éô„Éº„ÇπÔºâ
function calculateICProgress(project) {
  if (!project.ic_assignee) return null;
  const progressData = project.progress || {};
  // IC„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Çø„Çπ„ÇØ„ÇíÂèñÂæó
  const icTasks = tasksV2.filter(t => t.category === 'IC').sort((a, b) => a.display_order - b.display_order);
  if (icTasks.length === 0) return null;
  const completed = icTasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / icTasks.length) * 100);
}

// Â§ñÊßãÊãÖÂΩìËÄÖÁî®„ÅÆÈÄ≤ÊçóÁéáË®àÁÆóÔºàÂ§ñÊßã„Çø„Çπ„ÇØ„Éô„Éº„ÇπÔºâ
function calculateExteriorProgress(project) {
  if (!project.exterior_assignee) return null;
  const progressData = project.progress || {};
  // Â§ñÊßã„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Çø„Çπ„ÇØ„ÇíÂèñÂæóÔºàSupabase + localStorageÁµ±ÂêàÔºâ
  const extTasks = getTasksForCategory('Â§ñÊßã');
  if (extTasks.length === 0) return null;
  const completed = extTasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / extTasks.length) * 100);
}

// ‰∏çÂãïÁî£ÊãÖÂΩìËÄÖÁî®„ÅÆÈÄ≤ÊçóÁéáË®àÁÆóÔºà‰∏çÂãïÁî£„Çø„Çπ„ÇØ„Éô„Éº„ÇπÔºâ
function calculateRealestateProgress(project) {
  if (!project.realestate_assignee) return null;
  const progressData = project.progress || {};
  // ‰∏çÂãïÁî£„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Çø„Çπ„ÇØ„ÇíÂèñÂæóÔºàSupabase + localStorageÁµ±ÂêàÔºâ
  const realTasks = getTasksForCategory('‰∏çÂãïÁî£');
  if (realTasks.length === 0) return null;
  const completed = realTasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / realTasks.length) * 100);
}

// Â∑•‰∫ãÊãÖÂΩìËÄÖÁî®„ÅÆÈÄ≤ÊçóÁéáË®àÁÆóÔºàÂ∑•‰∫ã„Çø„Çπ„ÇØ„Éô„Éº„ÇπÔºâ
function calculateConstructionProgress(project) {
  if (!project.construction_assignee) return null;
  const progressData = project.progress || {};
  // Â∑•‰∫ã„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Çø„Çπ„ÇØ„ÇíÂèñÂæóÔºàSupabase + localStorageÁµ±ÂêàÔºâ
  const constTasks = getTasksForCategory('Â∑•‰∫ã');
  if (constTasks.length === 0) return null;
  const completed = constTasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / constTasks.length) * 100);
}

// ÂÖ®„Çø„Çπ„ÇØÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Å®Ëá™Âãï„Ç¢„Éº„Ç´„Ç§„Éñ
async function checkAndAutoArchive(project) {
  if (project.is_archived) return; // Êó¢„Å´„Ç¢„Éº„Ç´„Ç§„ÉñÊ∏à„Åø„Å™„Çâ„Çπ„Ç≠„ÉÉ„Éó

  const progressData = project.progress || {};
  let allCompleted = true;
  let hasAnyAssignee = false;

  // Ë®≠Ë®àÊãÖÂΩì„ÅÆ„Çø„Çπ„ÇØ„ÉÅ„Çß„ÉÉ„ÇØ
  if (project.assigned_to) {
    hasAnyAssignee = true;
    const designTasks = tasksV2.filter(t => t.category === 'Ë®≠Ë®à');
    if (designTasks.length > 0) {
      const designCompleted = designTasks.every(t => progressData[t.task_key]?.completed);
      if (!designCompleted) allCompleted = false;
    }
  }

  // ICÊãÖÂΩì„ÅÆ„Çø„Çπ„ÇØ„ÉÅ„Çß„ÉÉ„ÇØ
  if (project.ic_assignee) {
    hasAnyAssignee = true;
    const icTasks = tasksV2.filter(t => t.category === 'IC');
    if (icTasks.length > 0) {
      const icCompleted = icTasks.every(t => progressData[t.task_key]?.completed);
      if (!icCompleted) allCompleted = false;
    }
  }

  // Â§ñÊßãÊãÖÂΩì„ÅÆ„Çø„Çπ„ÇØ„ÉÅ„Çß„ÉÉ„ÇØ
  if (project.exterior_assignee) {
    hasAnyAssignee = true;
    const extTasks = getTasksForCategory('Â§ñÊßã');
    if (extTasks.length > 0) {
      const extCompleted = extTasks.every(t => progressData[t.task_key]?.completed);
      if (!extCompleted) allCompleted = false;
    }
  }

  // ‰∏çÂãïÁî£ÊãÖÂΩì„ÅÆ„Çø„Çπ„ÇØ„ÉÅ„Çß„ÉÉ„ÇØ
  if (project.realestate_assignee) {
    hasAnyAssignee = true;
    const reTasks = getTasksForCategory('‰∏çÂãïÁî£');
    if (reTasks.length > 0) {
      const reCompleted = reTasks.every(t => progressData[t.task_key]?.completed);
      if (!reCompleted) allCompleted = false;
    }
  }

  // Â∑•‰∫ãÊãÖÂΩì„ÅÆ„Çø„Çπ„ÇØ„ÉÅ„Çß„ÉÉ„ÇØ
  if (project.construction_assignee) {
    hasAnyAssignee = true;
    const conTasks = getTasksForCategory('Â∑•‰∫ã');
    if (conTasks.length > 0) {
      const conCompleted = conTasks.every(t => progressData[t.task_key]?.completed);
      if (!conCompleted) allCompleted = false;
    }
  }

  // ÊãÖÂΩìËÄÖ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å¶ÂÖ®„Çø„Çπ„ÇØÂÆå‰∫Ü„Å™„ÇâËá™Âãï„Ç¢„Éº„Ç´„Ç§„Éñ
  if (hasAnyAssignee && allCompleted) {
    // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
    const confirmed = await showConfirmDialog(
      'ÂÖ®„Çø„Çπ„ÇØÂÆå‰∫Ü',
      `„Äå${project.customer}„Äç„ÅÆÂÖ®„Çø„Çπ„ÇØ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ\nÊ°à‰ª∂„ÇíÂÆå‰∫ÜÊ∏à„Åø„Å´ÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü`
    );

    if (confirmed) {
      const { error } = await supabase
        .from('projects')
        .update({ is_archived: true, updated_at: new Date().toISOString() })
        .eq('id', project.id);

      if (!error) {
        project.is_archived = true;
        showToast(`„Äå${project.customer}„Äç„ÇíÂÆå‰∫ÜÊ∏à„Åø„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü`, 'success');
        renderProjects();
        renderSidebar();
      }
    }
  }
}

// Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞ÔºàPromiseÁâàÔºâ
function showConfirmDialog(title, message) {
  return new Promise((resolve) => {
    const result = confirm(`${title}\n\n${message}`);
    resolve(result);
  });
}

function formatDateTime(dateStr) {
  if (!dateStr) return '‚Äî';
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return '‚Äî';
  return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
}

async function updateTaskStatus(projectId, taskKey, completed) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // UndoÁî®„Å´Â§âÊõ¥Ââç„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠ò
  const oldProgress = JSON.parse(JSON.stringify(project.progress || {}));

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].completed = completed;
  if (completed && !progressData[taskKey].date) {
    progressData[taskKey].date = new Date().toISOString().split('T')[0];
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  // UndoË®òÈå≤
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  UndoManager.record({
    type: 'UPDATE_PROJECT',
    projectId: projectId,
    description: `${project.customer} - ${taskDef?.task_name || taskKey}„Çí${completed ? 'ÂÆå‰∫Ü' : 'Êú™ÂÆå‰∫Ü'}„Å´Â§âÊõ¥`,
    oldValue: { progress: oldProgress },
    newValue: { progress: progressData }
  });

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  renderProjects();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
}

// „Çø„Çπ„ÇØÊúüÈôê„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂà§ÂÆö
function getTaskDueStatus(dueDate, completed) {
  if (!dueDate || completed) {
    return { class: '', badgeClass: 'normal', label: '' };
  }

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const due = new Date(dueDate);
  due.setHours(0, 0, 0, 0);
  const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

  if (diffDays < 0) {
    return { class: 'overdue', badgeClass: 'overdue', label: `${Math.abs(diffDays)}Êó•ÈÅÖÂª∂` };
  } else if (diffDays === 0) {
    return { class: 'due-soon', badgeClass: 'overdue', label: 'Êú¨Êó•ÊúüÈôê' };
  } else if (diffDays <= 3) {
    return { class: 'due-soon', badgeClass: 'due-soon', label: `„ÅÇ„Å®${diffDays}Êó•` };
  } else {
    const m = due.getMonth() + 1;
    const d = due.getDate();
    return { class: '', badgeClass: 'normal', label: `${m}/${d}` };
  }
}

// „Çø„Çπ„ÇØÊúüÈôê„ÅÆÊõ¥Êñ∞
async function updateTaskDueDate(projectId, taskKey, dueDate) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // ÈÅéÂéªÊó•‰ªò„ÉÅ„Çß„ÉÉ„ÇØÔºàË≠¶Âëä„ÅÆ„Åø„ÄÅ‰øùÂ≠ò„ÅØË®±ÂèØÔºâ
  if (dueDate && !Validators.isNotPastDate(dueDate)) {
    const confirmPast = confirm('ÈÅéÂéª„ÅÆÊó•‰ªò„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åì„ÅÆÊó•‰ªò„Åß‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü');
    if (!confirmPast) {
      renderProjects();
      return;
    }
  }

  // UndoÁî®„Å´Â§âÊõ¥Ââç„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠ò
  const oldProgress = JSON.parse(JSON.stringify(project.progress || {}));
  const oldDueDate = oldProgress[taskKey]?.due_date || '';

  // Êó¢Â≠ò„ÅÆprogress„Éá„Éº„Çø„ÇíÂÆåÂÖ®„Å´„Ç≥„Éî„Éº„Åó„Å¶Êñ∞„Åó„ÅÑ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê
  const progressData = JSON.parse(JSON.stringify(project.progress || {}));
  // Êó¢Â≠ò„ÅÆ„Çø„Çπ„ÇØ„Éá„Éº„Çø„Çí‰øùÊåÅ„Åó„Å™„Åå„Çâdue_date„ÅÆ„ÅøÊõ¥Êñ∞
  if (!progressData[taskKey]) {
    progressData[taskKey] = { completed: false, date: '', state: '', due_date: '' };
  }
  progressData[taskKey].due_date = dueDate;

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    ErrorHandler.handle(error, 'ÊúüÈôê‰øùÂ≠ò');
    return;
  }

  // UndoË®òÈå≤
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  UndoManager.record({
    type: 'UPDATE_PROJECT',
    projectId: projectId,
    description: `${project.customer} - ${taskDef?.task_name || taskKey}„ÅÆÊúüÈôê„Çí${dueDate || 'Ëß£Èô§'}„Å´Â§âÊõ¥`,
    oldValue: { progress: oldProgress },
    newValue: { progress: progressData }
  });

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  renderProjects();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  if (dueDate) {
    showToast('ÊúüÈôê„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü', 'success');
  }
}

// „Çπ„ÉÜ„Éº„Çø„ÇπËâ≤ÂàÜ„Åë„ÅÆ„ÇØ„É©„Çπ„ÇíÂèñÂæó
// taskKey: „Ç™„Éó„Ç∑„Éß„É≥„ÄÇIC„Çø„Çπ„ÇØ„ÅÆÁâπÂà•„Å™Ëâ≤ÂàÜ„Åë„Å´‰ΩøÁî®
function getStateColorClass(state, lastOption, taskKey = '') {
  // Á©∫„ÄÅ-„ÄÅnull ‚Üí Ëâ≤„Å™„ÅóÔºàÁôΩÔºâ
  if (!state || state === '-' || state === '') {
    return '';
  }

  // IC„É°„Éº„Ç´„Éº„Çø„Çπ„ÇØ: ÂÆå‰∫ÜÁä∂ÊÖãÔºàÊúÄÂæå„ÅÆÈÅ∏ÊäûËÇ¢Ôºâ„ÅÆ„ÅøÈùíËâ≤„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØÈªÑËâ≤
  if (IC_MAKER_TASKS.includes(taskKey)) {
    // ÊúÄÂæå„ÅÆÈÅ∏ÊäûËÇ¢Ôºà‰øùÂ≠òÊ∏à„Å™„Å©Ôºâ‚Üí Èùí
    if (state === lastOption) {
      return 'state-blue';
    }
    // „Åù„Çå‰ª•Â§ñÔºà‰æùÈ†ºÊ∏à„Å™„Å©Ôºâ‚Üí ÈªÑ
    return 'state-yellow';
  }

  // IC„Çø„Çπ„ÇØÁâπÂà•Âá¶ÁêÜ: ÈÄ†‰ΩúÊ•≠ËÄÖÁ¥π‰ªã„ÉªÂÆ∂ÂÖ∑Ë¶ãÁ©ç‰æùÈ†º„Éª„Çø„Ç§„É´„Éó„É¨„Çº„É≥„ÅØ„ÄåÁÑ°„Äç„ÄåÁÑ°„Åó„Äç„ÇÇÈùíËâ≤
  if (taskKey === 'ic_zousaku' || taskKey === 'ic_furniture' || taskKey === 'ic_tile_pres') {
    if (state === 'ÁÑ°' || state === 'ÁÑ°„Åó' || state === '‰æùÈ†ºÊ∏à' || state === '‰ΩúÊàêÊ∏à') {
      return 'state-blue';
    }
  }

  // ÊúÄÂæå„ÅÆÈÅ∏ÊäûËÇ¢ÔºàÂÆå‰∫ÜÁä∂ÊÖãÔºâ‚Üí Èùí
  if (state === lastOption) {
    return 'state-blue';
  }
  // „Åù„ÅÆ‰ªñÔºàÈÄ≤Ë°å‰∏≠Ôºâ‚Üí ÈªÑ
  return 'state-yellow';
}

// „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÊôÇ„Å´Ëâ≤„ÇÇÊõ¥Êñ∞
function updateTaskStateWithColor(selectEl, projectId, taskKey) {
  const state = selectEl.value;
  const lastOption = selectEl.dataset.lastOption || '';

  // CSS„ÇØ„É©„Çπ„ÇíÊõ¥Êñ∞
  selectEl.classList.remove('state-blue', 'state-yellow');
  const newClass = getStateColorClass(state, lastOption, taskKey);
  if (newClass) {
    selectEl.classList.add(newClass);
  }

  // „É°„Éº„É´„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂãïÁöÑ„Å´Êõ¥Êñ∞
  const taskItem = selectEl.closest('.task-item');
  const isInternalStatus = INTERNAL_STATUSES.includes(state);
  if (taskItem) {
    const emailBtn = taskItem.querySelector('.task-email-btn');
    if (emailBtn) {
      emailBtn.style.display = isInternalStatus ? 'none' : '';
    }
  }

  // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíÊõ¥Êñ∞Ôºà„É°„Éº„Ç´„ÉºÈÅ∏Êäû„Çø„Çπ„ÇØÔºâ
  if (IC_MAKER_TASKS.includes(taskKey)) {
    if (state && !isInternalStatus) {
      selectEl.title = `üìß ${state}„Å´„É°„Éº„É´ÈÄÅ‰ø°ÂèØËÉΩ`;
    } else {
      selectEl.removeAttribute('title');
    }
  }

  // „Éá„Éº„Çø„Çí‰øùÂ≠ò
  updateTaskState(projectId, taskKey, state);
}

async function updateTaskState(projectId, taskKey, state) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // UndoÁî®„Å´Â§âÊõ¥Ââç„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠ò
  const oldProgress = JSON.parse(JSON.stringify(project.progress || {}));
  const oldState = oldProgress[taskKey]?.state || '';

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].state = state;

  // ‰æùÈ†ºÊó•„ÅÆË®òÈå≤Ôºà„Äå‰æùÈ†º„Äç„ÇíÂê´„ÇÄ„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Â§âÊõ¥„Åï„Çå„ÅüÊôÇÁÇπ„ÅßË®òÈå≤Ôºâ
  if (state && state.includes('‰æùÈ†º') && !progressData[taskKey].request_date) {
    progressData[taskKey].request_date = new Date().toISOString().split('T')[0];
  }
  // „Çπ„ÉÜ„Éº„Çø„Çπ„Åå„Äå-„Äç„Å´Êàª„Åï„Çå„Åü„Çâ‰æùÈ†ºÊó•„Çí„ÇØ„É™„Ç¢
  if (state === '-' || state === '') {
    progressData[taskKey].request_date = null;
  }

  // „Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÊúÄÁµÇÁä∂ÊÖã„Å´„Å™„Å£„Åü„Çâcompleted„Çítrue„Å´„Åô„Çã
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  if (taskDef && taskDef.state_options) {
    try {
      const options = typeof taskDef.state_options === 'string'
        ? JSON.parse(taskDef.state_options)
        : taskDef.state_options;
      const lastOption = options[options.length - 1];
      progressData[taskKey].completed = (state === lastOption);
    } catch (e) {
      console.warn('„Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éó„Ç∑„Éß„É≥„ÅÆ„Éë„Éº„Çπ„Å´Â§±Êïó:', e);
    }
  }

  // Áî≥Ë´ãGo„ÅåÂÆå‰∫ÜÊ∏à„Åø„ÅÆÂ†¥Âêà„ÄÅÊù°‰ª∂„ÇíÂÜç„ÉÅ„Çß„ÉÉ„ÇØ
  let applicationGoCleared = false;
  if (progressData['application']?.completed) {
    // ‰∏ÄÊôÇÁöÑ„Å´progress„ÇíÊõ¥Êñ∞„Åó„Å¶Êù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
    const tempProject = { ...project, progress: progressData };
    if (!canPressApplicationGo(tempProject)) {
      // Êù°‰ª∂„Åã„ÇâÂ§ñ„Çå„Åü„ÅÆ„ÅßÁî≥Ë´ãGo„Çí„ÇØ„É™„Ç¢
      progressData['application'].completed = false;
      progressData['application'].date = null;
      applicationGoCleared = true;
    }
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  // Áî≥Ë´ãGo„Åå„ÇØ„É™„Ç¢„Åï„Çå„ÅüÂ†¥Âêà„ÄÅis_archived„ÇÇfalse„Å´Êàª„Åô
  const updateData = {
    progress: progressData,
    updated_at: new Date().toISOString()
  };
  if (applicationGoCleared) {
    updateData.is_archived = false;
  }

  const { error } = await supabase
    .from('projects')
    .update(updateData)
    .eq('id', projectId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  // UndoË®òÈå≤
  UndoManager.record({
    type: 'UPDATE_PROJECT',
    projectId: projectId,
    description: `${project.customer} - ${taskDef?.task_name || taskKey}„Çí„Äå${state || 'Êú™Ë®≠ÂÆö'}„Äç„Å´Â§âÊõ¥`,
    oldValue: { progress: oldProgress },
    newValue: { progress: progressData }
  });

  project.progress = progressData;
  project.updated_at = new Date().toISOString();

  // ÂÖ®„Çø„Çπ„ÇØÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØÔºàË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÊãÖÂΩìËÄÖ„ÅÆ„Çø„Çπ„ÇØ„Åå„Åô„Åπ„Å¶ÂÆå‰∫Ü„Åó„Åü„ÇâËá™Âãï„Ç¢„Éº„Ç´„Ç§„ÉñÔºâ
  checkAndAutoArchive(project);

  // Áî≥Ë´ãGO„ÅÆÁä∂ÊÖã„ÅåÂ§â„Çè„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅÂ∏∏„Å´UI„ÇíÊõ¥Êñ∞
  // Ë©≤ÂΩì„ÅÆÊ°à‰ª∂„Ç´„Éº„Éâ„ÅÆ„Åø„ÇíÊõ¥Êñ∞Ôºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©ÂåñÔºâ
  const projectCard = document.querySelector(`.project-card[data-project-id="${projectId}"]`);
  if (projectCard) {
    const applicationGoEnabled = canPressApplicationGo(project);
    const applicationGoContainer = projectCard.querySelector('.application-go-container');
    if (applicationGoContainer) {
      const taskDef = tasksV2.find(t => t.task_key === 'application');
      const applicationGoData = progressData['application'] || {};

      if (applicationGoData.completed) {
        // ÂÆå‰∫ÜÊ∏à„Åø
        applicationGoContainer.outerHTML = `<div class="application-go-container application-go-completed">
          <div class="application-go-icon">‚úì</div>
          <div class="application-go-text">${taskDef?.task_name || 'Áî≥Ë´ãGO'} ÂÆå‰∫Ü</div>
        </div>`;
      } else if (applicationGoEnabled) {
        // Êù°‰ª∂„ÅåÊèÉ„Å£„Å¶„ÅÑ„ÇãÔºö„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ
        applicationGoContainer.outerHTML = `<div class="application-go-container application-go-ready" onclick="confirmApplicationGo('${projectId}')">
          <div class="application-go-icon">üöÄ</div>
          <div class="application-go-text">${taskDef?.task_name || 'Áî≥Ë´ãGO'}</div>
          <div class="application-go-arrow">‚Üí</div>
        </div>`;
      } else {
        // Êù°‰ª∂Êú™ÈÅî
        const requiredTasks = getApplicationGoRequiredTasks();
        const tooltip = requiredTasks.length > 0
          ? requiredTasks.map(r => `${r.task_name}:${r.finalState}`).join('„ÄÅ') + ' „ÅåÂøÖË¶Å'
          : 'Â§™ÈôΩÂÖâ:‰øùÂ≠òÊ∏à„ÄÅÁµ¶ÊéíÊ∞¥:‰øùÂ≠òÊ∏à„ÄÅÊèõÊ∞ó:‰øùÂ≠òÊ∏à„ÄÅ„Çµ„ÉÉ„Ç∑:‰øùÂ≠òÊ∏à „ÅåÂøÖË¶Å';
        applicationGoContainer.outerHTML = `<div class="application-go-container application-go-disabled" title="${tooltip}">
          <div class="application-go-icon">üîí</div>
          <div class="application-go-text">${taskDef?.task_name || 'Áî≥Ë´ãGO'}</div>
          <div class="application-go-status">Êù°‰ª∂Êú™ÈÅî</div>
        </div>`;
      }
    }
  }

  if (applicationGoCleared) {
    project.is_archived = false;
    renderProjects();
    renderSidebar();
    showToast('Áî≥Ë´ãGoÊù°‰ª∂„Åã„ÇâÂ§ñ„Çå„Åü„Åü„ÇÅ„ÄÅÂÆå‰∫ÜÁä∂ÊÖã„ÇíËß£Èô§„Åó„Åæ„Åó„Åü', 'warning');
  }
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
}

function openProjectModal(projectId = null) {
  log('üìù openProjectModal() Âëº„Å≥Âá∫„Åó:', projectId);
  log('üë• designersÈÖçÂàó:', designers);

  editingProjectId = projectId;
  const modal = document.getElementById('projectModal');
  const title = document.getElementById('projectModalTitle');

  log('üéØ modalË¶ÅÁ¥†:', modal);
  log('üéØ titleË¶ÅÁ¥†:', title);

  let project = null;
  if (projectId) {
    project = projects.find(p => p.id === projectId);
    if (!project) {
      showToast('Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }
    title.textContent = 'Ê°à‰ª∂Á∑®ÈõÜ';
    document.getElementById('projectCustomer').value = project.customer;
    document.getElementById('projectSpecifications').value = project.specifications || 'LIFE';
  } else {
    title.textContent = 'Ê°à‰ª∂ËøΩÂä†';
    document.getElementById('projectCustomer').value = '';
    document.getElementById('projectSpecifications').value = 'LIFE';
  }

  // Ë®≠Ë®àÊãÖÂΩìËÄÖÔºàË®≠Ë®à„Ç´„ÉÜ„Ç¥„É™„ÅÆ„ÅøÔºâ„ÇíÂüã„ÇÅ„Çã
  log('üîß Ë®≠Ë®àÊãÖÂΩìËÄÖ„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞‰∏≠...');
  const sekkeiDesigners = designers.filter(d => d.category === 'Ë®≠Ë®à');
  log('‚úÖ Ë®≠Ë®àÊãÖÂΩìËÄÖ:', sekkeiDesigners);

  const assignedToSelect = document.getElementById('projectAssignedTo');
  log('üéØ assignedToSelectË¶ÅÁ¥†:', assignedToSelect);

  if (assignedToSelect) {
    assignedToSelect.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' +
      sekkeiDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    // ÂÄ§„ÇíË®≠ÂÆöÔºàinnerHTMLÂæå„Å´ÂÆüË°åÔºâ
    if (projectId && project) {
      // Á∑®ÈõÜÊôÇ: Êó¢Â≠ò„ÅÆÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû
      assignedToSelect.value = project.assigned_to;
    } else if (currentDesignerTab !== 'ALL' && currentDesignerTab !== 'ARCHIVED') {
      // Êñ∞Ë¶èÊ°à‰ª∂„ÅÆÂ†¥Âêà„ÄÅÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„Çø„Éñ„ÅÆÊãÖÂΩìËÄÖ„ÇíËá™ÂãïÈÅ∏Êäû
      const currentDesigner = sekkeiDesigners.find(d => d.name === currentDesignerTab);
      if (currentDesigner) {
        assignedToSelect.value = currentDesigner.name;
      }
    } else {
      // „ÄåÂÖ®Ê°à‰ª∂„Äç„Çø„Éñ„ÅÆÂ†¥Âêà„ÄÅÊúÄÂæå„Å´‰ΩøÁî®„Åó„ÅüÊãÖÂΩìËÄÖ„ÇíËá™ÂãïÈÅ∏Êäû
      const lastAssignee = localStorage.getItem('archideck_last_assignee');
      if (lastAssignee && sekkeiDesigners.find(d => d.name === lastAssignee)) {
        assignedToSelect.value = lastAssignee;
      }
    }
  }

  // ICÊãÖÂΩìËÄÖÔºàIC„Ç´„ÉÜ„Ç¥„É™„ÅÆ„ÅøÔºâ„ÇíÂüã„ÇÅ„Çã
  log('üîß ICÊãÖÂΩìËÄÖ„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞‰∏≠...');
  const icDesigners = designers.filter(d => d.category === 'IC');
  log('‚úÖ ICÊãÖÂΩìËÄÖ:', icDesigners);

  const icAssigneeSelect = document.getElementById('projectIcAssignee');
  log('üéØ icAssigneeSelectË¶ÅÁ¥†:', icAssigneeSelect);

  if (icAssigneeSelect) {
    icAssigneeSelect.innerHTML = '<option value="">Êú™ÂÆö</option>' +
      icDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    // ÂÄ§„ÇíË®≠ÂÆöÔºàinnerHTMLÂæå„Å´ÂÆüË°åÔºâ
    if (projectId && project) {
      // Á∑®ÈõÜÊôÇ: Êó¢Â≠ò„ÅÆICÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû
      icAssigneeSelect.value = project.ic_assignee || '';
    }
  }

  // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°ÔºàÁ∑®ÈõÜÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ
  const templateButtons = document.getElementById('templateButtons');
  if (templateButtons) {
    templateButtons.style.display = projectId ? 'block' : 'none';
  }

  log('üé¨ „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫„Åó„Åæ„Åô...');
  ModalManager.open(modal, '#projectCustomer');
  log('‚úÖ openProjectModal() ÂÆå‰∫Ü');
}

function closeProjectModal() {
  ModalManager.close(document.getElementById('projectModal'));
  editingProjectId = null;
}

async function saveProject() {
  // ‰∫åÈáç„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢
  if (SaveGuard.isLocked('saveProject')) {
    return;
  }

  const customer = document.getElementById('projectCustomer').value.trim();
  const assignedTo = document.getElementById('projectAssignedTo').value.trim(); // trim()ËøΩÂä†
  const icAssignee = document.getElementById('projectIcAssignee').value.trim(); // trim()ËøΩÂä†
  const specifications = document.getElementById('projectSpecifications').value;

  log('üíæ saveProjectÈñãÂßã:', { customer, assignedTo, icAssignee, specifications });

  if (!customer || !assignedTo) {
    showToast('„ÅäÂÆ¢ÊßòÂêç„Å®Ë®≠Ë®àÊãÖÂΩì„ÅØÂøÖÈ†à„Åß„Åô', 'error');
    return;
  }

  await SaveGuard.run('saveProject', async () => {
    showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

    // Ë®≠Ë®àÊãÖÂΩì„ÅÆID„ÇíÂèñÂæó
    const designer = designers.find(d => d.name.trim() === assignedTo);
    const designerId = designer ? designer.id : null;

    // ICÊãÖÂΩìËÄÖ„ÅÆID„ÇíÂèñÂæóÔºàÁ©∫ÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØnullÔºâ
    const icDesigner = icAssignee ? designers.find(d => d.name.trim() === icAssignee) : null;
    const icDesignerId = icDesigner ? icDesigner.id : null;

    const blankProgress = {};
    tasksV2.forEach(task => {
      blankProgress[task.task_key] = { completed: false, date: '', state: '' };
    });

    if (editingProjectId) {
      const project = projects.find(p => p.id === editingProjectId);
      const { error } = await supabase
        .from('projects')
        .update({
          customer,
          assigned_to: assignedTo,
          designer_id: designerId,
          ic_assignee: icAssignee || null,
          ic_designer_id: icDesignerId,
          specifications,
          updated_at: new Date().toISOString()
        })
        .eq('id', editingProjectId);

      if (error) {
        showStatus('„Ç®„É©„Éº', 'error');
        showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
        return;
      }

      Object.assign(project, {
        customer,
        assigned_to: assignedTo,
        ic_assignee: icAssignee || null,
        ic_designer_id: icDesignerId,
        specifications,
        memo,
        updated_at: new Date().toISOString()
      });
    } else {
      const newProject = {
        uid: 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        customer,
        assigned_to: assignedTo,
        designer_id: designerId,
        ic_assignee: icAssignee || null,
        ic_designer_id: icDesignerId,
        specifications,
        memo,
        status: 'active',
        progress: blankProgress,
        created_by: currentUser?.id || null
      };

      const { data, error } = await supabase
        .from('projects')
        .insert([newProject])
        .select();

      if (error) {
        showStatus('„Ç®„É©„Éº', 'error');
        showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
        return;
      }

      log('‚úÖ Êñ∞Ë¶èÊ°à‰ª∂‰øùÂ≠òÊàêÂäü:', data[0]);
      log('üìä assigned_to:', data[0].assigned_to);
      log('üìä ic_assignee:', data[0].ic_assignee);
      projects.unshift(data[0]);
    }

    log('üîÑ renderDesignerTabs()„Å®renderProjects()„ÇíÂÆüË°å„Åó„Åæ„Åô');
    log('üìä ÁèæÂú®„ÅÆprojectsÊï∞:', projects.length);
    closeProjectModal();
    renderDesignerTabs();
    renderProjects();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast('Ê°à‰ª∂„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
  });
}

function editProject(projectId) {
  openProjectModal(projectId);
}

async function deleteProject(projectId) {
  if (!confirm('„Åì„ÅÆÊ°à‰ª∂„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  await SaveGuard.run(`deleteProject_${projectId}`, async () => {
    showStatus('ÂâäÈô§‰∏≠...', 'saving');
    const { error } = await supabase
      .from('projects')
      .delete()
      .eq('id', projectId);

    if (error) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    projects = projects.filter(p => p.id !== projectId);
    renderDesignerTabs();
    renderProjects();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast('Ê°à‰ª∂„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
  });
}

let archiveConfirmProjectId = null;

// ÂÆå‰∫ÜÊ∏à„ÅøÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
async function openArchiveConfirmModal(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç
  const { data: incompleteTasks } = await supabase
    .from('project_tasks')
    .select('id')
    .eq('project_id', projectId)
    .eq('is_completed', false);

  if (incompleteTasks && incompleteTasks.length > 0) {
    showToast(`Êú™ÂÆå‰∫Ü„ÅÆ„Çø„Çπ„ÇØ„Åå${incompleteTasks.length}‰ª∂„ÅÇ„Çä„Åæ„Åô„ÄÇ„Çø„Çπ„ÇØ„ÇíÂÆå‰∫Ü„Åó„Å¶„Åã„ÇâÂÆå‰∫ÜÊ∏à„Åø„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`, 'warning');
    return;
  }

  archiveConfirmProjectId = projectId;
  document.getElementById('archiveConfirmProjectName').textContent = project.customer;
  ModalManager.open(document.getElementById('archiveConfirmModal'));
}

function closeArchiveConfirmModal() {
  ModalManager.close(document.getElementById('archiveConfirmModal'));
  archiveConfirmProjectId = null;
}

// ÂÆå‰∫ÜÊ∏à„Åø„Å´ÁßªÂãï„ÇíÂÆüË°å
async function executeArchive() {
  if (!archiveConfirmProjectId) return;

  const project = projects.find(p => p.id === archiveConfirmProjectId);
  if (!project) return;

  showStatus('Êõ¥Êñ∞‰∏≠...', 'saving');

  const updateData = {
    is_archived: true,
    archived_at: new Date().toISOString()
  };

  const { error } = await supabase
    .from('projects')
    .update(updateData)
    .eq('id', archiveConfirmProjectId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    closeArchiveConfirmModal();
    return;
  }

  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
  project.is_archived = true;
  project.archived_at = updateData.archived_at;

  closeArchiveConfirmModal();
  renderProjects();
  renderSidebar();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('Ê°à‰ª∂„ÇíÂÆå‰∫ÜÊ∏à„Åø„Å´„Åó„Åæ„Åó„Åü', 'success');
}

async function toggleArchive(projectId, isArchived) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // ÂÆå‰∫ÜÊ∏à„Åø„Å´„Åô„ÇãÂ†¥Âêà„ÅØ„É¢„Éº„ÉÄ„É´„ÅßÁ¢∫Ë™ç
  if (isArchived) {
    openArchiveConfirmModal(projectId);
    return;
  }

  // Âæ©ÂÖÉ„ÅÆÂ†¥Âêà„ÅØÂæìÊù•ÈÄö„Çäconfirm„ÅßÁ¢∫Ë™ç
  if (!confirm('Ê°à‰ª∂„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü')) return;

  showStatus('Êõ¥Êñ∞‰∏≠...', 'saving');

  const updateData = {
    is_archived: false,
    archived_at: null
  };

  const { error } = await supabase
    .from('projects')
    .update(updateData)
    .eq('id', projectId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
  project.is_archived = false;
  project.archived_at = null;

  renderProjects();
  renderSidebar();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('Ê°à‰ª∂„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü', 'success');
}

// ÂÆå‰∫ÜÊ∏à„Åã„ÇâÂæ©ÂÖÉÔºà„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπËß£Èô§ÊôÇÔºâ
async function restoreFromArchive(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  if (!confirm(`„Äå${project.customer}„Äç„ÇíÊãÖÂΩìËÄÖÔºà${project.assigned_to || 'Êú™Ââ≤ÂΩì'}Ôºâ„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü`)) {
    // „Ç≠„É£„É≥„Çª„É´„Åï„Çå„ÅüÂ†¥Âêà„ÄÅ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÊàª„Åô
    renderProjects();
    return;
  }

  showStatus('Âæ©ÂÖÉ‰∏≠...', 'saving');

  const { error } = await supabase
    .from('projects')
    .update({
      is_archived: false,
      archived_at: null,
      updated_at: new Date().toISOString()
    })
    .eq('id', projectId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('Âæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    renderProjects(); // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÊàª„Åô
    return;
  }

  project.is_archived = false;
  project.archived_at = null;
  project.updated_at = new Date().toISOString();

  // ÊãÖÂΩìËÄÖ„ÅÆ„Çø„Éñ„Å´Âàá„ÇäÊõø„Åà
  if (project.assigned_to) {
    currentDesignerTab = project.assigned_to;
  } else {
    currentDesignerTab = 'ALL';
  }

  renderSidebar();
  renderProjects();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast(`${project.customer} „ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü`, 'success');
}

// ============================================
// „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜÊ©üËÉΩ
// ============================================
function openDesignerModal() {
  renderDesignerList();
  ModalManager.open(document.getElementById('designerModal'));
}

function closeDesignerModal() {
  ModalManager.close(document.getElementById('designerModal'));
}

function renderDesignerList() {
  const container = document.getElementById('designerList');

  // „Ç´„ÉÜ„Ç¥„É™„Åß‰∏¶„Å≥Êõø„ÅàÔºàË®≠Ë®à‚ÜíICÔºâ
  const sortedDesigners = [...designers].sort((a, b) => {
    if (a.category === 'Ë®≠Ë®à' && b.category === 'IC') return -1;
    if (a.category === 'IC' && b.category === 'Ë®≠Ë®à') return 1;
    return (a.display_order || 999) - (b.display_order || 999);
  });

  container.innerHTML = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">ÁôªÈå≤Ê∏à„Åø„Çπ„Çø„ÉÉ„ÉïÔºà' + designers.length + 'ÂêçÔºâ</h3>' +
    '<div class="table-container"><table class="table"><thead><tr><th>„Çπ„Çø„ÉÉ„ÉïÂêç</th><th>„Ç´„ÉÜ„Ç¥„É™</th><th>ÊãÖÂΩìÊ°à‰ª∂Êï∞</th><th>Êìç‰Ωú</th></tr></thead><tbody>' +
    sortedDesigners.map(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name).length;
      const categoryLabel = designer.category === 'Ë®≠Ë®à' ? 'Ë®≠Ë®àÊãÖÂΩì' : 'ICÊãÖÂΩì';
      return `
        <tr>
          <td><strong>${designer.name}</strong></td>
          <td><span class="badge ${designer.category === 'Ë®≠Ë®à' ? 'badge-primary' : 'badge-success'}">${categoryLabel}</span></td>
          <td>${count}‰ª∂</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteDesigner('${designer.id}')">ÂâäÈô§</button></td>
        </tr>
      `;
    }).join('') +
    '</tbody></table></div>';
}

async function addDesigner() {
  const name = document.getElementById('newDesignerName').value.trim();
  const category = document.getElementById('newDesignerCategory').value;

  if (!name) {
    showToast('„Çπ„Çø„ÉÉ„ÉïÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('Êó¢„Å´Â≠òÂú®„Åô„Çã„Çπ„Çø„ÉÉ„ÉïÂêç„Åß„Åô', 'error');
    return;
  }

  showStatus('ËøΩÂä†‰∏≠...', 'saving');

  // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™„ÅÆÊúÄÂ§ßdisplay_order„ÇíÂèñÂæó„Åó„Å¶+1
  const sameCategoryDesigners = designers.filter(d => d.category === category);
  const maxDisplayOrder = sameCategoryDesigners.length > 0
    ? Math.max(...sameCategoryDesigners.map(d => d.display_order || 0))
    : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('designers')
    .insert([{ name, category, email: `${name.replace(/\s/g, '')}@temp.local`, created_by: currentUser?.id, display_order: newDisplayOrder }])
    .select();

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerName').value = '';
  renderDesignerList();
  renderDesignerTabs();
  renderSidebar();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„Çπ„Çø„ÉÉ„Éï„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
}

async function deleteDesigner(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('„Åì„ÅÆ„Çπ„Çø„ÉÉ„Éï„ÅØÊ°à‰ª∂„Å´Ââ≤ÂΩì„Å¶„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÊ°à‰ª∂„ÅÆÊãÖÂΩì„ÇíÂ§âÊõ¥„Åó„Å¶„Åã„ÇâÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
    return;
  }

  if (!confirm(`${designer.name}„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

  await SaveGuard.run(`deleteDesigner_${designerId}`, async () => {
    showStatus('ÂâäÈô§‰∏≠...', 'saving');
    const { error } = await supabase
      .from('designers')
      .delete()
      .eq('id', designerId);

    if (error) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    designers = designers.filter(d => d.id !== designerId);
    renderDesignerList();
    renderDesignerListInline();
    renderSidebar();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast('„Çπ„Çø„ÉÉ„Éï„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
  });
}

// „Ç§„É≥„É©„Ç§„É≥Áâà„Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜÈñ¢Êï∞
function renderDesignerListInline() {
  const container = document.getElementById('designerListInline');
  if (!container) return;

  const sekkeiDesigners = [...designers].filter(d => d.category === 'Ë®≠Ë®à').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const icDesigners = [...designers].filter(d => d.category === 'IC').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const exteriorDesigners = [...designers].filter(d => d.category === 'Â§ñÊßã').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));

  let html = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">ÁôªÈå≤Ê∏à„Åø„Çπ„Çø„ÉÉ„ÉïÔºà' + designers.length + 'ÂêçÔºâ</h3>';
  html += '<p style="color: var(--text-secondary); margin-bottom: 16px;">üí° Ë°å„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åó„Å¶Ë°®Á§∫È†ÜÂ∫è„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô</p>';

  // „Çπ„Çø„ÉÉ„ÉïË°å„ÇíÁîüÊàê„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
  function renderDesignerRow(designer, category, countField) {
    const count = projects.filter(p => p[countField] === designer.name).length;
    const emailDisplay = designer.email && !designer.email.includes('@temp.local') ? designer.email : '<span style="color: var(--text-muted);">Êú™Ë®≠ÂÆö</span>';
    const canManageAuth = currentUserCategory === 'admin' || designer.id === currentDesigner?.id;
    const authButton = canManageAuth ? `<button class="btn btn-secondary btn-small" onclick="openDesignerAuthModal('${designer.id}')" style="margin-right: 4px;">üîë</button>` : '';
    return `
      <tr class="draggable-row" draggable="true" data-designer-id="${designer.id}" data-category="${category}">
        <td><span class="drag-handle">‚â°</span></td>
        <td><strong>${designer.name}</strong></td>
        <td>${emailDisplay}</td>
        <td>${count}‰ª∂</td>
        <td>
          <button class="btn btn-ghost btn-small" onclick="openEditDesignerModal('${designer.id}')" style="margin-right: 4px;">‚úèÔ∏è Á∑®ÈõÜ</button>
          ${authButton}
          <button class="btn btn-danger btn-small" onclick="deleteDesignerInline('${designer.id}')">ÂâäÈô§</button>
        </td>
      </tr>
    `;
  }

  // Ë®≠Ë®àÊãÖÂΩì
  if (sekkeiDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--primary-color);">üìê Ë®≠Ë®àÊãÖÂΩì</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>„Çπ„Çø„ÉÉ„ÉïÂêç</th><th>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th><th>ÊãÖÂΩìÊ°à‰ª∂Êï∞</th><th>Êìç‰Ωú</th></tr></thead><tbody id="sekkeiTbody">';
    sekkeiDesigners.forEach(designer => {
      html += renderDesignerRow(designer, 'Ë®≠Ë®à', 'assigned_to');
    });
    html += '</tbody></table></div>';
  }

  // ICÊãÖÂΩì
  if (icDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--success-color);">üé® ICÊãÖÂΩì</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>„Çπ„Çø„ÉÉ„ÉïÂêç</th><th>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th><th>ÊãÖÂΩìÊ°à‰ª∂Êï∞</th><th>Êìç‰Ωú</th></tr></thead><tbody id="icTbody">';
    icDesigners.forEach(designer => {
      html += renderDesignerRow(designer, 'IC', 'ic_assignee');
    });
    html += '</tbody></table></div>';
  }

  // Â§ñÊßãÊãÖÂΩì
  if (exteriorDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--secondary-color);">üå≥ Â§ñÊßãÊãÖÂΩì</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>„Çπ„Çø„ÉÉ„ÉïÂêç</th><th>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th><th>ÊãÖÂΩìÊ°à‰ª∂Êï∞</th><th>Êìç‰Ωú</th></tr></thead><tbody id="exteriorTbody">';
    exteriorDesigners.forEach(designer => {
      html += renderDesignerRow(designer, 'Â§ñÊßã', 'exterior_assignee');
    });
    html += '</tbody></table></div>';
  }

  // ‰∏çÂãïÁî£ÊãÖÂΩì
  const realestateDesigners = [...designers].filter(d => d.category === '‰∏çÂãïÁî£').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  if (realestateDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: #8B4513;">üè† ‰∏çÂãïÁî£ÊãÖÂΩì</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>„Çπ„Çø„ÉÉ„ÉïÂêç</th><th>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th><th>ÊãÖÂΩìÊ°à‰ª∂Êï∞</th><th>Êìç‰Ωú</th></tr></thead><tbody id="realestateTbody">';
    realestateDesigners.forEach(designer => {
      html += renderDesignerRow(designer, '‰∏çÂãïÁî£', 'realestate_assignee');
    });
    html += '</tbody></table></div>';
  }

  container.innerHTML = html;

  // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Ç§„Éô„É≥„ÉàË®≠ÂÆö
  setupDragAndDrop();
}

// „Çπ„Çø„ÉÉ„ÉïÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´
function openEditDesignerModal(designerId) {
  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.id = 'editDesignerModal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">„Çπ„Çø„ÉÉ„ÉïÁ∑®ÈõÜ</h2>
        <button class="close" onclick="closeEditDesignerModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editDesignerId" value="${designer.id}">
        <div class="form-group">
          <label class="form-label">„Çπ„Çø„ÉÉ„ÉïÂêç *</label>
          <input type="text" class="form-input" id="editDesignerName" value="${designer.name}" style="width: 100%;">
        </div>
        <div class="form-group">
          <label class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
          <input type="email" class="form-input" id="editDesignerEmail" value="${designer.email && !designer.email.includes('@temp.local') ? designer.email : ''}" placeholder="‰æã: staff@example.com" style="width: 100%;">
        </div>
        <div class="form-group">
          <label class="form-label">„Ç´„ÉÜ„Ç¥„É™</label>
          <select class="form-input" id="editDesignerCategory" style="width: 100%;">
            <option value="Ë®≠Ë®à" ${designer.category === 'Ë®≠Ë®à' ? 'selected' : ''}>Ë®≠Ë®àÊãÖÂΩì</option>
            <option value="IC" ${designer.category === 'IC' ? 'selected' : ''}>ICÊãÖÂΩì</option>
            <option value="Â§ñÊßã" ${designer.category === 'Â§ñÊßã' ? 'selected' : ''}>Â§ñÊßãÊãÖÂΩì</option>
            <option value="‰∏çÂãïÁî£" ${designer.category === '‰∏çÂãïÁî£' ? 'selected' : ''}>‰∏çÂãïÁî£ÊãÖÂΩì</option>
            <option value="Â∑•‰∫ã" ${designer.category === 'Â∑•‰∫ã' ? 'selected' : ''}>Â∑•‰∫ãÊãÖÂΩì</option>
            <option value="Âñ∂Ê•≠" ${designer.category === 'Âñ∂Ê•≠' ? 'selected' : ''}>Âñ∂Ê•≠ÊãÖÂΩì</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeEditDesignerModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn btn-primary" onclick="saveEditDesigner()">‰øùÂ≠ò</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function closeEditDesignerModal() {
  const modal = document.getElementById('editDesignerModal');
  if (modal) modal.remove();
}

async function saveEditDesigner() {
  const designerId = document.getElementById('editDesignerId').value;
  const name = document.getElementById('editDesignerName').value.trim();
  const email = document.getElementById('editDesignerEmail').value.trim();
  const category = document.getElementById('editDesignerCategory').value;

  if (!name) {
    showToast('„Çπ„Çø„ÉÉ„ÉïÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  // ÂêçÂâç„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
  if (name !== designer.name && designers.find(d => d.name === name && d.id !== designerId)) {
    showToast('Êó¢„Å´Â≠òÂú®„Åô„Çã„Çπ„Çø„ÉÉ„ÉïÂêç„Åß„Åô', 'error');
    return;
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  const oldName = designer.name;
  const updateData = {
    name,
    category,
    email: email || `${name.replace(/\s/g, '')}@temp.local`
  };

  const { error } = await supabase
    .from('designers')
    .update(updateData)
    .eq('id', designerId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  // ÂêçÂâç„ÅåÂ§â„Çè„Å£„ÅüÂ†¥Âêà„ÄÅÈñ¢ÈÄ£„Åô„ÇãÊ°à‰ª∂„ÅÆÊãÖÂΩìËÄÖÂêç„ÇÇÊõ¥Êñ∞
  if (oldName !== name) {
    const fieldsToUpdate = {
      'Ë®≠Ë®à': 'assigned_to',
      'IC': 'ic_assignee',
      'Â§ñÊßã': 'exterior_assignee'
    };
    const field = fieldsToUpdate[designer.category];
    if (field) {
      const relatedProjects = projects.filter(p => p[field] === oldName);
      for (const project of relatedProjects) {
        await supabase.from('projects').update({ [field]: name }).eq('id', project.id);
        project[field] = name;
      }
    }
  }

  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
  Object.assign(designer, updateData);

  closeEditDesignerModal();
  renderDesignerListInline();
  renderDesignerTabs();
  renderSidebar();
  renderProjects();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
}

async function addDesignerInline() {
  const name = document.getElementById('newDesignerNameInline').value.trim();
  const category = document.getElementById('newDesignerCategoryInline').value;

  if (!name) {
    showToast('„Çπ„Çø„ÉÉ„ÉïÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('Êó¢„Å´Â≠òÂú®„Åô„Çã„Çπ„Çø„ÉÉ„ÉïÂêç„Åß„Åô', 'error');
    return;
  }

  showStatus('ËøΩÂä†‰∏≠...', 'saving');

  // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™„ÅÆÊúÄÂ§ßdisplay_order„ÇíÂèñÂæó„Åó„Å¶+1
  const sameCategoryDesigners = designers.filter(d => d.category === category);
  const maxDisplayOrder = sameCategoryDesigners.length > 0
    ? Math.max(...sameCategoryDesigners.map(d => d.display_order || 0))
    : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('designers')
    .insert([{ name, category, email: `${name.replace(/\s/g, '')}@temp.local`, created_by: currentUser?.id, display_order: newDisplayOrder }])
    .select();

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerNameInline').value = '';
  renderDesignerListInline();
  renderSidebar();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„Çπ„Çø„ÉÉ„Éï„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
}

async function deleteDesignerInline(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('„Åì„ÅÆ„Çπ„Çø„ÉÉ„Éï„ÅØÊ°à‰ª∂„Å´Ââ≤ÂΩì„Å¶„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÊ°à‰ª∂„ÅÆÊãÖÂΩì„ÇíÂ§âÊõ¥„Åó„Å¶„Åã„ÇâÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
    return;
  }

  if (!confirm(`${designer.name}„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

  showStatus('ÂâäÈô§‰∏≠...', 'saving');
  const { error } = await supabase
    .from('designers')
    .delete()
    .eq('id', designerId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  designers = designers.filter(d => d.id !== designerId);
  renderDesignerListInline();
  renderSidebar();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„Çπ„Çø„ÉÉ„Éï„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

// ============================================
// „Çπ„Çø„ÉÉ„ÉïË™çË®ºË®≠ÂÆö
// ============================================
function openDesignerAuthModal(designerId) {
  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  document.getElementById('authDesignerId').value = designer.id;
  document.getElementById('authDesignerName').value = designer.name;
  document.getElementById('authDesignerEmail').value = designer.email && !designer.email.includes('@temp.local') ? designer.email : '';
  document.getElementById('authDesignerPassword').value = '';
  document.getElementById('authDesignerPasswordConfirm').value = '';

  ModalManager.open(document.getElementById('designerAuthModal'), '#authDesignerEmail');
}

function closeDesignerAuthModal() {
  ModalManager.close(document.getElementById('designerAuthModal'));
}

async function saveDesignerAuth() {
  const designerId = document.getElementById('authDesignerId').value;
  const email = document.getElementById('authDesignerEmail').value.trim();
  const password = document.getElementById('authDesignerPassword').value;
  const passwordConfirm = document.getElementById('authDesignerPasswordConfirm').value;

  // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
  if (!email) {
    showToast('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (!password) {
    showToast('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (password.length < 8) {
    showToast('„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ8ÊñáÂ≠ó‰ª•‰∏ä„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (password !== passwordConfirm) {
    showToast('„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì', 'error');
    return;
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  try {
    const designer = designers.find(d => d.id === designerId);
    const oldEmail = designer.email;

    log('üîê „É¶„Éº„Ç∂„Éº„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàêÈñãÂßã:', { email, designerId });

    // 1. Supabase Auth„Å´„É¶„Éº„Ç∂„Éº„Çí‰ΩúÊàê
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email: email,
      password: password,
      options: {
        data: {
          name: designer.name,
          designer_id: designerId
        },
        emailRedirectTo: window.location.origin
      }
    });

    log('üîê signUpÁµêÊûú:', { authData, authError });

    if (authError) {
      // „É¶„Éº„Ç∂„Éº„ÅåÊó¢„Å´Â≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Éë„Çπ„ÉØ„Éº„Éâ„Å†„Åë„ÇíÊõ¥Êñ∞„Åß„Åç„Å™„ÅÑ„ÅÆ„ÅßË≠¶Âëä
      if (authError.message.includes('already registered')) {
        showToast('‚ö†Ô∏è „Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éë„Çπ„ÉØ„Éº„Éâ„ÅÆÂ§âÊõ¥„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ„ÄÅ„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆ„Äå„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„Åü„Äç„Åã„ÇâÂ§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      } else {
        throw authError;
      }
    } else {
      log('‚úÖ Supabase Auth„Å´„É¶„Éº„Ç∂„Éº‰ΩúÊàêÂÆå‰∫Ü:', authData.user?.id);
    }

    // 2. designers„ÉÜ„Éº„Éñ„É´„ÅÆemail„ÇíÊõ¥Êñ∞
    const { error: updateError } = await supabase
      .from('designers')
      .update({ email: email })
      .eq('id', designerId);

    if (updateError) {
      logError('‚ùå designersÊõ¥Êñ∞„Ç®„É©„Éº:', updateError);
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + updateError.message, 'error');
      return;
    }

    log('‚úÖ designers„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞ÂÆå‰∫Ü');

    // 3. „Éá„Ç∂„Ç§„Éä„ÉºÈÖçÂàó„ÇíÊõ¥Êñ∞
    const designerIndex = designers.findIndex(d => d.id === designerId);
    if (designerIndex !== -1) {
      designers[designerIndex].email = email;
    }

    closeDesignerAuthModal();
    renderDesignerListInline();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');

    if (authError && authError.message.includes('already registered')) {
      showToast('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºà„Ç¢„Ç´„Ç¶„É≥„Éà„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„ÅôÔºâ', 'success');
    } else {
      showToast('‚úÖ „É≠„Ç∞„Ç§„É≥„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„Åß„É≠„Ç∞„Ç§„É≥„Åß„Åç„Åæ„Åô„ÄÇ', 'success', 5000);
    }

  } catch (error) {
    logError('‚ùå Ë™çË®ºË®≠ÂÆö„Ç®„É©„Éº:', error);
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('Ë™çË®ºË®≠ÂÆö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
  }
}

// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÂá¶ÁêÜ
let draggedElement = null;

function setupDragAndDrop() {
  const draggableRows = document.querySelectorAll('.draggable-row');

  draggableRows.forEach(row => {
    row.addEventListener('dragstart', handleDesignerDragStart);
    row.addEventListener('dragover', handleDesignerDragOver);
    row.addEventListener('drop', handleDesignerDrop);
    row.addEventListener('dragend', handleDesignerDragEnd);
    row.addEventListener('dragleave', handleDesignerDragLeave);
  });
}

function handleDesignerDragStart(e) {
  draggedElement = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDesignerDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }

  // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™ÂÜÖ„Åß„ÅÆ„Åø„Éâ„É≠„ÉÉ„ÉóÂèØËÉΩ
  const draggedCategory = draggedElement.dataset.category;
  const targetCategory = this.dataset.category;

  if (draggedCategory === targetCategory && this !== draggedElement) {
    this.classList.add('drag-over');
  }

  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDesignerDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }

  const draggedCategory = draggedElement.dataset.category;
  const targetCategory = this.dataset.category;

  // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™ÂÜÖ„Åß„ÅÆ„Åø„Éâ„É≠„ÉÉ„ÉóÂÆüË°å
  if (draggedCategory === targetCategory && draggedElement !== this) {
    const draggedId = draggedElement.dataset.designerId;
    const targetId = this.dataset.designerId;

    // È†ÜÂ∫è„ÇíÂÖ•„ÇåÊõø„Åà
    updateDesignerOrder(draggedId, targetId, draggedCategory);
  }

  this.classList.remove('drag-over');
  return false;
}

function handleDesignerDragEnd(e) {
  this.classList.remove('dragging');

  const allRows = document.querySelectorAll('.draggable-row');
  allRows.forEach(row => {
    row.classList.remove('drag-over');
  });
}

function handleDesignerDragLeave(e) {
  this.classList.remove('drag-over');
}

async function updateDesignerOrder(draggedId, targetId, category) {
  showStatus('‰∏¶„Å≥Êõø„Åà‰∏≠...', 'saving');

  // Ë©≤ÂΩì„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Çπ„Çø„ÉÉ„Éï„ÇíÂèñÂæó
  const categoryDesigners = designers.filter(d => d.category === category);

  // „Éâ„É©„ÉÉ„Ç∞„Åï„Çå„Åü„Çπ„Çø„ÉÉ„Éï„Å®„Çø„Éº„Ç≤„ÉÉ„Éà„Çπ„Çø„ÉÉ„Éï„ÇíË¶ã„Å§„Åë„Çã
  const draggedIndex = categoryDesigners.findIndex(d => d.id === draggedId);
  const targetIndex = categoryDesigners.findIndex(d => d.id === targetId);

  // ÈÖçÂàó„Çí‰∏¶„Å≥Êõø„Åà
  const [draggedDesigner] = categoryDesigners.splice(draggedIndex, 1);
  categoryDesigners.splice(targetIndex, 0, draggedDesigner);

  // display_order„ÇíÂÜçË®àÁÆó
  const updates = [];
  for (let i = 0; i < categoryDesigners.length; i++) {
    const designer = categoryDesigners[i];
    const newOrder = i + 1;

    if (designer.display_order !== newOrder) {
      updates.push({
        id: designer.id,
        display_order: newOrder
      });

      // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
      const localDesigner = designers.find(d => d.id === designer.id);
      if (localDesigner) {
        localDesigner.display_order = newOrder;
      }
    }
  }

  // Supabase„Å´‰∏ÄÊã¨Êõ¥Êñ∞
  for (const update of updates) {
    const { error } = await supabase
      .from('designers')
      .update({ display_order: update.display_order })
      .eq('id', update.id);

    if (error) {
      logError('‰∏¶„Å≥Êõø„Åà„Ç®„É©„Éº:', error);
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('‰∏¶„Å≥Êõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }
  }

  // UIÊõ¥Êñ∞
  renderDesignerListInline();
  renderSidebar();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('‰∏¶„Å≥Êõø„Åà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

// „Ç§„É≥„É©„Ç§„É≥Áâà„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†
async function addCategoryInline() {
  const name = document.getElementById('newCategoryNameInline').value.trim();

  if (!name) {
    showToast('„Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (vendorCategories.find(c => c.name === name)) {
    showToast('Êó¢„Å´Â≠òÂú®„Åô„Çã„Ç´„ÉÜ„Ç¥„É™Âêç„Åß„Åô', 'error');
    return;
  }

  showStatus('ËøΩÂä†‰∏≠...', 'saving');
  const { data, error } = await supabase
    .from('vendor_categories')
    .insert([{ name, display_order: vendorCategories.length + 1 }])
    .select();

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  vendorCategories.push(data[0]);
  document.getElementById('newCategoryNameInline').value = '';
  renderCategoriesList();
  renderCategoryFilters();
  populateVendorCategoryDropdown();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
}

// ============================================
// „É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ
// ============================================
function renderTemplates() {
  const container = document.getElementById('templatesTable');
  if (!container) return; // Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

  const categoryFilterEl = document.getElementById('categoryFilter');
  const categoryFilter = categoryFilterEl ? categoryFilterEl.value : null;

  let filtered = emailTemplates;

  // currentUserCategory„Å´Âøú„Åò„Å¶„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÁÆ°ÁêÜËÄÖ‰ª•Â§ñÔºâ
  if (currentUserCategory && currentUserCategory !== 'admin') {
    filtered = emailTemplates.filter(t => t.category === currentUserCategory);
  }

  // „Åï„Çâ„Å´„Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
  if (categoryFilter) {
    filtered = filtered.filter(t => t.category === categoryFilter);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìß</div><div class="empty-title">„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div><div class="empty-description">„É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíËøΩÂä†„Åó„Å¶„ÄÅÊ°à‰ª∂„Åã„Çâ„ÉØ„É≥„ÇØ„É™„ÉÉ„ÇØ„Åß„É°„Éº„É´„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô</div><button class="btn btn-primary" onclick="openTemplateModal()">+ „ÉÜ„É≥„Éó„É¨„Éº„ÉàËøΩÂä†</button></div>';
    return;
  }

  container.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>Ë°®Á§∫Âêç</th>
          <th>„Ç´„ÉÜ„Ç¥„É™</th>
          <th>‰ºöÁ§æÂêç</th>
          <th>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th>
          <th>Êìç‰Ωú</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(template => `
          <tr>
            <td><strong>${template.display_name}</strong></td>
            <td><span class="badge ${template.category === 'IC' ? 'badge-success' : 'badge-primary'}">${template.category}</span></td>
            <td>${template.company}</td>
            <td>${template.email || '‚Äî'}</td>
            <td>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-ghost btn-small" onclick="editTemplate('${template.id}')">Á∑®ÈõÜ</button>
                <button class="btn btn-danger btn-small" onclick="deleteTemplate('${template.id}')">ÂâäÈô§</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function openTemplateModal(templateId = null) {
  editingTemplateId = templateId;
  const modal = document.getElementById('templateModal');
  const title = document.getElementById('templateModalTitle');

  if (templateId) {
    const template = emailTemplates.find(t => t.id === templateId);
    title.textContent = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ';
    document.getElementById('templateId').value = template.template_id;
    document.getElementById('templateId').disabled = true;
    document.getElementById('templateDisplayName').value = template.display_name;
    document.getElementById('templateCategory').value = template.category;
    document.getElementById('templateCompany').value = template.company;
    document.getElementById('templateContact').value = template.contact || '';
    document.getElementById('templateEmail').value = template.email || '';
    document.getElementById('templateSubjectFormat').value = template.subject_format || '';
    document.getElementById('templateText').value = template.template_text || '';
  } else {
    title.textContent = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàËøΩÂä†';
    document.getElementById('templateId').value = '';
    document.getElementById('templateId').disabled = false;
    document.getElementById('templateDisplayName').value = '';
    document.getElementById('templateCategory').value = 'Ë®≠Ë®à';
    document.getElementById('templateCompany').value = '';
    document.getElementById('templateContact').value = '';
    document.getElementById('templateEmail').value = '';
    document.getElementById('templateSubjectFormat').value = '';
    document.getElementById('templateText').value = '';
  }

  ModalManager.open(modal, '#templateId');
}

function closeTemplateModal() {
  ModalManager.close(document.getElementById('templateModal'));
  editingTemplateId = null;
}

async function saveTemplate() {
  if (SaveGuard.isLocked('saveTemplate')) return;

  const templateId = document.getElementById('templateId').value.trim();
  const displayName = document.getElementById('templateDisplayName').value.trim();
  const category = document.getElementById('templateCategory').value;
  const company = document.getElementById('templateCompany').value.trim();
  const contact = document.getElementById('templateContact').value.trim();
  const email = document.getElementById('templateEmail').value.trim();
  const subjectFormat = document.getElementById('templateSubjectFormat').value.trim();
  const templateText = document.getElementById('templateText').value.trim();

  if (!templateId || !displayName || !company || !subjectFormat || !templateText) {
    showToast('ÂøÖÈ†àÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  await SaveGuard.run('saveTemplate', async () => {
    showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

    const templateData = {
      template_id: templateId,
      display_name: displayName,
      category,
      company,
      contact,
      email,
      subject_format: subjectFormat,
      template_text: templateText,
      has_special_content: false,
      has_sub_options: false,
      created_by: currentUser.id
    };

    if (editingTemplateId) {
      const { error } = await supabase
        .from('email_templates')
        .update(templateData)
        .eq('id', editingTemplateId);

      if (error) {
        showStatus('„Ç®„É©„Éº', 'error');
        showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
        return;
      }

      const template = emailTemplates.find(t => t.id === editingTemplateId);
      Object.assign(template, templateData);
    } else {
      const { data, error } = await supabase
        .from('email_templates')
        .insert([templateData])
        .select();

      if (error) {
        showStatus('„Ç®„É©„Éº', 'error');
        showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
        return;
      }

      emailTemplates.push(data[0]);
    }

    closeTemplateModal();
    renderTemplates();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast('„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
  });
}

function editTemplate(templateId) {
  openTemplateModal(templateId);
}

async function deleteTemplate(templateId) {
  if (!confirm('„Åì„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  showStatus('ÂâäÈô§‰∏≠...', 'saving');
  const { error } = await supabase
    .from('email_templates')
    .delete()
    .eq('id', templateId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  emailTemplates = emailTemplates.filter(t => t.id !== templateId);
  renderTemplates();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

// ============================================
// „Çø„Çπ„ÇØ„Åã„Çâ„ÅÆ„É°„Éº„É´‰ΩúÊàêÊ©üËÉΩÔºà„É¢„Éº„ÉÄ„É´Á¢∫Ë™çÂæå„Å´GmailÈñã„ÅèÔºâ
// ============================================
async function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) {
    showToast('Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  // „Çø„Çπ„ÇØÂÆöÁæ©„ÇíÂèñÂæó
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  if (!taskDef) {
    showToast('„Çø„Çπ„ÇØÂÆöÁæ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  // „Çø„Çπ„ÇØ„Å´Á¥ê„Å•„ÅÑ„ÅüÊ•≠ËÄÖ„ÇíÂèñÂæó
  const mappings = taskVendorMappings.filter(m => m.task_id === taskDef.id);
  if (mappings.length === 0) {
    showToast('„Åì„ÅÆ„Çø„Çπ„ÇØ„Å´Ê•≠ËÄÖ„ÅåÁ¥ê„Å•„Åë„Çâ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return;
  }

  // Ê•≠ËÄÖÊÉÖÂ†±„ÇíÂèñÂæó
  let taskVendors = mappings
    .map(m => vendorsV2.find(v => v.id === m.vendor_id))
    .filter(v => v != null);

  if (taskVendors.length === 0) {
    showToast('Ê•≠ËÄÖÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  // IC„Çø„Çπ„ÇØ„ÅÆÂ†¥Âêà: ÈÅ∏Êäû‰∏≠„ÅÆ„É°„Éº„Ç´„ÉºÂêç„Å´ÂØæÂøú„Åó„ÅüÊ•≠ËÄÖ„ÇíÂÑ™ÂÖàÁöÑ„Å´ÈÅ∏Êäû
  if (IC_MAKER_TASKS.includes(taskKey)) {
    const progressData = project.progress || {};
    const selectedMaker = progressData[taskKey]?.state || '';

    if (selectedMaker && selectedMaker !== '-') {
      // ÈÅ∏Êäû‰∏≠„ÅÆ„É°„Éº„Ç´„ÉºÂêç„Å´‰∏ÄËá¥„Åô„ÇãÊ•≠ËÄÖ„ÇíÂÖàÈ†≠„Å´‰∏¶„Å≥Êõø„Åà
      const matchingVendor = taskVendors.find(v =>
        v.company.toLowerCase().includes(selectedMaker.toLowerCase()) ||
        v.company === selectedMaker
      );
      if (matchingVendor) {
        taskVendors = [matchingVendor, ...taskVendors.filter(v => v.id !== matchingVendor.id)];
      }
    }
  }

  // ÊãÖÂΩìËÄÖÊÉÖÂ†±„ÇíÂèñÂæó
  const designer = designers.find(d => d.id === project.designer_id);
  const staffName = designer ? designer.name : '';

  // ÁèæÂú®Êó•‰ªò„Åã„ÇâÊúüÊó•„ÇíË®≠ÂÆöÔºà„Éá„Éï„Ç©„É´„ÉàÔºö7Êó•ÂæåÔºâ
  const today = new Date();
  const dueDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
  const dueDateStr = dueDate.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' }).replace('/', 'Êúà') + 'Êó•';

  // ÈÅ∏Êäû‰∏≠„ÅÆ„É°„Éº„Ç´„Éº„Å´ÂØæÂøú„Åó„ÅüÊ•≠ËÄÖÔºà„Åæ„Åü„ÅØÊúÄÂàù„ÅÆÊ•≠ËÄÖÔºâ„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩøÁî®
  const vendor = taskVendors[0];

  // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁΩÆÊèõ
  const replacePlaceholders = (text) => {
    if (!text) return '';
    return text
      .replace(/\{customerName\}/g, project.customer)
      .replace(/\{dueDate\}/g, dueDateStr)
      .replace(/\{staffName\}/g, staffName)
      .replace(/\{company\}/g, vendor.company)
      .replace(/\{contact\}/g, vendor.contact || '„ÅîÊãÖÂΩìËÄÖÊßò');
  };

  // ÂàùÊúü„ÅÆ‰ª∂Âêç„Å®Êú¨Êñá„ÇíÁîüÊàê
  const initialSubject = replacePlaceholders(vendor.subject_format || `${project.customer}ÊßòÈÇ∏ ${taskDef.task_name}`);
  const initialBody = replacePlaceholders(vendor.template_text || '');

  // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
  showEmailModal(project, taskDef, taskVendors, initialSubject, initialBody);
}

// „ÇØ„Ç§„ÉÉ„ÇØ„É°„Éº„É´Ê©üËÉΩ - „ÉØ„É≥„ÇØ„É™„ÉÉ„ÇØ„Åß„É°„Éº„É´‰ΩúÊàêÁîªÈù¢„ÇíÈñã„Åè
function quickEmail(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // ÊúÄ„ÇÇ„Çà„Åè‰Ωø„ÅÜ„Çø„Çπ„ÇØÔºàÊßãÈÄ†‰æùÈ†º„Å™„Å©Ôºâ„ÇíÂèñÂæó„ÄÅ„Åæ„Åü„ÅØ„Ç´„Çπ„Çø„É†„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË°®Á§∫
  const quickModal = document.createElement('div');
  quickModal.id = 'quickEmailModal';
  quickModal.className = 'modal-overlay';
  quickModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

  // „Çø„Çπ„ÇØ„É™„Çπ„Éà„ÇíÂèñÂæó
  const tasks = getTasksForAssignee(project.assigned_to);
  const tasksWithVendors = tasks.filter(t => taskVendorMappings.some(m => m.task_id === t.id));

  const taskOptions = tasksWithVendors.map(t =>
    `<button class="quick-email-btn" onclick="openEmailFromTask('${projectId}', '${t.task_key}'); document.getElementById('quickEmailModal').remove();" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; width: 100%; text-align: left; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-light)'; this.style.borderColor='var(--primary-color)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.borderColor='var(--border-color)'">
      <span style="font-size: 20px;">üìß</span>
      <span style="font-weight: 500;">${escapeHtml(t.task_name)}</span>
    </button>`
  ).join('');

  quickModal.innerHTML = `
    <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 500px; width: 90%;">
      <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
        <h3 style="font-size: 18px; font-weight: 600; margin: 0;">üìß „ÇØ„Ç§„ÉÉ„ÇØ„É°„Éº„É´ - ${escapeHtml(project.customer)}</h3>
      </div>
      <div class="modal-body" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
        <p style="margin-bottom: 16px; color: var(--text-secondary);">„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åô„Çã„Çø„Çπ„ÇØ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          ${taskOptions || '<p style="color: var(--text-muted);">„É°„Éº„É´ÈÄÅ‰ø°ÂèØËÉΩ„Å™„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>'}
        </div>
      </div>
      <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
        <button class="btn btn-ghost" onclick="document.getElementById('quickEmailModal').remove()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  `;
  quickModal.addEventListener('click', (e) => {
    if (e.target === quickModal) quickModal.remove();
  });
  document.body.appendChild(quickModal);
}

function showEmailModal(project, taskDef, vendors, initialSubject, initialBody) {
  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  // Ê•≠ËÄÖÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆHTMLÔºàXSSÂØæÁ≠ñ: escapeHtmlÈÅ©Áî®Ôºâ
  const vendorCheckboxes = vendors.map((v, idx) => `
    <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md); cursor: pointer;">
      <input type="checkbox"
        id="vendor_${escapeHtml(v.id)}"
        value="${escapeHtml(v.id)}"
        ${idx === 0 ? 'checked' : ''}
        onchange="updateEmailPreview()"
        style="width: 18px; height: 18px; cursor: pointer;">
      <div style="flex: 1;">
        <div style="font-weight: 600; margin-bottom: 2px;">${escapeHtml(v.company)}</div>
        <div style="font-size: 13px; color: var(--text-secondary);">${escapeHtml(v.contact || '')} - ${escapeHtml(v.email || '')}</div>
      </div>
    </label>
  `).join('');

  content.innerHTML = `
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <div>
        <h3 style="margin: 0 0 8px 0; font-size: 18px;">üìß ${escapeHtml(taskDef.task_name)} - „É°„Éº„É´‰ΩúÊàê</h3>
        <div style="font-size: 14px; color: var(--text-secondary);">Ê°à‰ª∂: ${escapeHtml(project.customer)}</div>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">ÂÆõÂÖàÊ•≠ËÄÖ„ÇíÈÅ∏Êäû</label>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${vendorCheckboxes}
        </div>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">‰ª∂Âêç</label>
        <input type="text" id="emailSubject" class="form-input" value="${escapeHtml(initialSubject)}">
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Êú¨Êñá</label>
        <textarea id="emailBody" class="form-textarea" rows="15" style="font-family: inherit; line-height: 1.8;">${escapeHtml(initialBody)}</textarea>
      </div>

      <div style="display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="closeEmailModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn btn-secondary" onclick="copyEmailToClipboard()">üìã „Ç≥„Éî„Éº</button>
        <button class="btn btn-secondary" onclick="openOutlookFromModal()">üì® Outlook</button>
        <button class="btn btn-primary" onclick="openGmailFromModal()">üìß Gmail</button>
      </div>
    </div>
  `;

  // „Ç∞„É≠„Éº„Éê„É´„Å´‰øùÂ≠òÔºàopenGmailFromModal„Åß‰ΩøÁî®Ôºâ
  window.__emailModalData = { project, taskDef, vendors };

  modal.classList.add('show');
}

function updateEmailPreview() {
  // ÂøÖË¶Å„Å´Âøú„Åò„Å¶‰ª∂Âêç„ÉªÊú¨Êñá„ÅÆ„Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞Âá¶ÁêÜ„ÇíËøΩÂä†
}

// „É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÂèñÂæóÂÖ±ÈÄöÈñ¢Êï∞
function getSelectedEmailAddresses() {
  const { vendors } = window.__emailModalData || {};
  if (!vendors) return { addresses: '', vendors: [] };

  const selectedVendorIds = vendors
    .filter(v => document.getElementById(`vendor_${v.id}`)?.checked)
    .map(v => v.id);

  if (selectedVendorIds.length === 0) {
    showToast('Ê•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return { addresses: '', vendors: [] };
  }

  const selectedVendors = vendors.filter(v => selectedVendorIds.includes(v.id));
  const emailAddresses = selectedVendors.map(v => v.email).filter(e => e).join(',');

  if (!emailAddresses) {
    showToast('ÈÅ∏Êäû„Åï„Çå„ÅüÊ•≠ËÄÖ„Å´„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return { addresses: '', vendors: [] };
  }

  return { addresses: emailAddresses, vendors: selectedVendors };
}

function openGmailFromModal() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  const { addresses } = getSelectedEmailAddresses();

  if (!addresses) return;

  // Gmail URL„ÇíÁîüÊàê
  const gmailUrl = `https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(addresses)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  // Gmail„ÇíÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè
  window.open(gmailUrl, '_blank');

  // ÈÄÅ‰ø°Â±•Ê≠¥„ÇíË®òÈå≤
  logEmailSent('gmail', addresses, subject);

  // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
  closeEmailModal();

  // „Éà„Éº„Çπ„Éà„ÅßÈÄöÁü•
  showToast('Gmail„ÇíÈñã„Åç„Åæ„Åó„Åü', 'success');
}

function openOutlookFromModal() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  const { addresses } = getSelectedEmailAddresses();

  if (!addresses) return;

  // Outlook Web URL„ÇíÁîüÊàê
  const outlookUrl = `https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(addresses)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  // Outlook„ÇíÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè
  window.open(outlookUrl, '_blank');

  // ÈÄÅ‰ø°Â±•Ê≠¥„ÇíË®òÈå≤
  logEmailSent('outlook', addresses, subject);

  // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
  closeEmailModal();

  showToast('Outlook„ÇíÈñã„Åç„Åæ„Åó„Åü', 'success');
}

function copyEmailToClipboard() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  const { addresses } = getSelectedEmailAddresses();

  if (!addresses) return;

  const emailText = `ÂÆõÂÖà: ${addresses}\n‰ª∂Âêç: ${subject}\n\n${body}`;

  navigator.clipboard.writeText(emailText).then(() => {
    showToast('„É°„Éº„É´ÂÜÖÂÆπ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
  }).catch(() => {
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
    const textarea = document.createElement('textarea');
    textarea.value = emailText;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast('„É°„Éº„É´ÂÜÖÂÆπ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
  });
}

// „É°„Éº„É´ÈÄÅ‰ø°Â±•Ê≠¥„ÇíË®òÈå≤
async function logEmailSent(method, to, subject) {
  const { project, taskDef } = window.__emailModalData || {};
  if (!project || !taskDef) return;

  log(`üìß „É°„Éº„É´ÈÄÅ‰ø°Ë®òÈå≤: ${method} -> ${to}, ‰ª∂Âêç: ${subject}`);

  // Â∞ÜÊù•: Supabase„Å´ÈÄÅ‰ø°Â±•Ê≠¥„Çí‰øùÂ≠ò
  // try {
  //   await supabase.from('email_logs').insert({
  //     project_id: project.id,
  //     task_key: taskDef.task_key,
  //     method,
  //     recipients: to,
  //     subject,
  //     sent_at: new Date().toISOString()
  //   });
  // } catch (e) {
  //   logError('„É°„Éº„É´Â±•Ê≠¥‰øùÂ≠òÂ§±Êïó:', e);
  // }
}

// „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫
function showTemplateSelector(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  const currentTaskNames = getTaskNames();
  const taskName = currentTaskNames[taskKey];

  // ÁèæÂú®„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´Âøú„Åò„Åü„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí„Éï„Ç£„É´„Çø
  const availableTemplates = emailTemplates.filter(t => t.category === currentUserCategory);

  let html = `
    <div class="form-section">
      <h3 style="margin-bottom: 8px; color: var(--text-primary);">„É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû</h3>
      <p style="margin-bottom: 24px; color: var(--text-secondary); font-size: 14px;">
        Ê°à‰ª∂Ôºö${project.customer} Ôºè „Çø„Çπ„ÇØÔºö${taskName}
      </p>

      <div style="display: grid; gap: 12px;">
        ${availableTemplates.map(template => `
          <button class="template-select-btn" onclick="selectTemplateForTask('${projectId}', '${taskKey}', '${template.template_id}')">
            <div style="font-weight: 600; margin-bottom: 4px;">${template.display_name}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">${template.company}</div>
          </button>
        `).join('')}
      </div>

      ${availableTemplates.length === 0 ? '<p style="text-align: center; padding: 32px; color: var(--text-muted);">Âà©Áî®ÂèØËÉΩ„Å™„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>' : ''}
    </div>
  `;

  document.getElementById('emailComposerContent').innerHTML = html;
  ModalManager.open(document.getElementById('emailModal'));
}

// „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÂæå„Å´„É°„Éº„É´‰ΩúÊàêÁîªÈù¢„ÇíË°®Á§∫
function selectTemplateForTask(projectId, taskKey, templateId) {
  const project = projects.find(p => p.id === projectId);
  const template = emailTemplates.find(t => t.template_id === templateId);
  const designer = designers.find(d => d.id === project.designer_id);
  const staffName = designer ? designer.name : '';

  const composerHTML = createEmailComposer(project, template, staffName, taskKey);
  document.getElementById('emailComposerContent').innerHTML = composerHTML;
}

function createEmailComposer(project, template, staffName, taskKey) {
  const hasSubOptions = template.has_sub_options;
  const hasSpecialContent = template.has_special_content;

  let html = `
    <div class="form-section">
      <h3 style="margin-bottom: 16px; color: var(--text-primary);">${template.display_name}</h3>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div class="form-group">
          <label class="form-label">„ÅäÂÆ¢ÊßòÂêç:</label>
          <input type="text" class="form-input" id="modalCustomerName" value="${project.customer}" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label class="form-label">ÊãÖÂΩìËÄÖÂêç:</label>
          <input type="text" class="form-input" id="modalStaffName" value="${staffName}" oninput="updateModalEmail()">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ÊúüÊó•:</label>
        <input type="date" class="form-input" id="modalDueDate" oninput="updateModalEmail()">
      </div>
  `;

  if (hasSpecialContent) {
    const defaultContent = template.default_special_content || '';
    html += `
      <div class="form-group">
        <label class="form-label">ÁâπË®ò‰∫ãÈ†Ö:</label>
        <textarea class="form-textarea" id="modalSpecialContent" rows="4" oninput="updateModalEmail()">${defaultContent}</textarea>
      </div>
    `;
  }

  if (hasSubOptions) {
    const templateVendors = vendors.filter(v => v.template_id === template.template_id);
    html += `
      <div class="form-group">
        <label class="form-label">Ê•≠ËÄÖÈÅ∏Êäû:</label>
        <select class="form-select" id="modalVendorSelect" onchange="updateModalEmail()">
          <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
          ${templateVendors.map(v => `<option value="${escapeHtml(v.vendor_id)}">${escapeHtml(v.company)}</option>`).join('')}
        </select>
      </div>
    `;
  }

  html += `
    </div>

    <div style="margin-top: 24px;">
      <h3 style="margin-bottom: 12px; color: var(--text-primary);">üì¨ ÁîüÊàê„Åï„Çå„Åü„É°„Éº„É´</h3>

      <div class="form-group">
        <label class="form-label">‰ª∂Âêç:</label>
        <div id="modalEmailSubject" style="padding: 12px; background: #f8f9fa; border-radius: 8px; font-weight: 500;"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailSubject')" style="margin-top: 8px;">üìã ‰ª∂Âêç„Çí„Ç≥„Éî„Éº</button>
      </div>

      <div class="form-group">
        <label class="form-label">ÈÄÅ‰ø°ÂÖà:</label>
        <div id="modalEmailAddress" style="padding: 12px; background: #f8f9fa; border-radius: 8px; color: var(--primary-color);"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailAddress')" style="margin-top: 8px;">üìã „Ç¢„Éâ„É¨„Çπ„Çí„Ç≥„Éî„Éº</button>
      </div>

      <div class="form-group">
        <label class="form-label">Êú¨Êñá:</label>
        <div id="modalEmailBody" style="padding: 16px; background: #f8f9fa; border-radius: 8px; white-space: pre-wrap; line-height: 1.8; min-height: 200px;"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailBody')" style="margin-top: 8px;">üìã Êú¨Êñá„Çí„Ç≥„Éî„Éº</button>
      </div>
    </div>

    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
      <button class="btn btn-secondary" onclick="closeEmailModal()">Èñâ„Åò„Çã</button>
      <button class="btn btn-primary" onclick="markTaskAsRequested('${project.id}', '${taskKey}')">‰æùÈ†ºÊ∏à„Åø„Å´„Åô„Çã</button>
    </div>
  `;

  // „Éá„Éº„Çø„Çí‰øùÂ≠òÔºàupdateModalEmail„Åß‰ΩøÁî®Ôºâ
  window.__currentEmailData = {
    project,
    template,
    staffName,
    taskKey
  };

  // ÂàùÂõû„É°„Éº„É´ÁîüÊàê
  setTimeout(() => updateModalEmail(), 100);

  return html;
}

function updateModalEmail() {
  if (!window.__currentEmailData) return;

  const { project, template } = window.__currentEmailData;

  const customerName = document.getElementById('modalCustomerName')?.value || project.customer;
  const staffName = document.getElementById('modalStaffName')?.value || '';
  const dueDate = document.getElementById('modalDueDate')?.value || '';
  const specialContent = document.getElementById('modalSpecialContent')?.value || template.default_special_content || '';
  const vendorSelect = document.getElementById('modalVendorSelect');
  const selectedVendorId = vendorSelect?.value || '';

  let subject = template.subject_format || '';
  let body = template.template_text || '';
  let email = template.email || '';
  let company = template.company || '';
  let contact = template.contact || '';

  // „Çµ„Éñ„Ç™„Éó„Ç∑„Éß„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊ•≠ËÄÖÊÉÖÂ†±„Çí‰ΩøÁî®
  if (template.has_sub_options && selectedVendorId) {
    const vendor = vendors.find(v => v.template_id === template.template_id && v.vendor_id === selectedVendorId);
    if (vendor) {
      company = vendor.company;
      contact = vendor.contact || '„ÅîÊãÖÂΩìËÄÖÊßò';
      email = vendor.email || '';
    }
  }

  // Â§âÊï∞„ÇíÁΩÆÊèõ
  subject = subject
    .replace(/\{customerName\}/g, customerName)
    .replace(/\{dueDate\}/g, dueDate);

  body = body
    .replace(/\{company\}/g, company)
    .replace(/\{contact\}/g, contact)
    .replace(/\{customerName\}/g, customerName)
    .replace(/\{staffName\}/g, staffName)
    .replace(/\{dueDate\}/g, dueDate)
    .replace(/\{specialContent\}/g, specialContent);

  // Ë°®Á§∫„ÇíÊõ¥Êñ∞
  const subjectEl = document.getElementById('modalEmailSubject');
  const addressEl = document.getElementById('modalEmailAddress');
  const bodyEl = document.getElementById('modalEmailBody');

  if (subjectEl) subjectEl.textContent = subject;
  if (addressEl) addressEl.textContent = email;
  if (bodyEl) bodyEl.textContent = body;
}

function copyModalText(elementId) {
  const text = document.getElementById(elementId)?.textContent;
  if (!text || text.includes('{') || text.includes('ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ')) {
    showToast('„Ç≥„Éî„Éº„Åß„Åç„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
  }).catch(err => {
    logError('„Ç≥„Éî„Éº„Å´Â§±Êïó:', err);
    showToast('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  });
}

async function markTaskAsRequested(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].state = '‰æùÈ†ºÊ∏à';

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    logError('Êõ¥Êñ∞„Ç®„É©„Éº:', error);
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return;
  }

  project.progress = progressData;
  renderProjects();
  closeEmailModal();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('‰æùÈ†ºÊ∏à„Åø„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
}

function closeEmailModal() {
  ModalManager.close(document.getElementById('emailModal'));
  window.__currentEmailData = null;
}

// ============================================
// Áã¨Á´ã„Åó„Åü„É°„Éº„É´‰ΩúÊàêÊ©üËÉΩÔºàÂâäÈô§‰∫àÂÆöÔºâ
// ============================================
function updateStandaloneEmail() {
  const templateSelect = document.getElementById('standaloneTemplateSelect');
  const templateId = templateSelect.value;

  if (!templateId) {
    // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊú™ÈÅ∏ÊäûÊôÇ„ÅØ„ÇØ„É™„Ç¢
    document.getElementById('standaloneEmailSubject').textContent = '';
    document.getElementById('standaloneEmailAddress').textContent = '';
    document.getElementById('standaloneEmailBody').textContent = '';
    document.getElementById('standaloneVendorGroup').style.display = 'none';
    document.getElementById('standaloneSpecialContentGroup').style.display = 'none';
    return;
  }

  const template = emailTemplates.find(t => t.template_id === templateId);
  if (!template) return;

  // ÁâπË®ò‰∫ãÈ†Ö„Éï„Ç£„Éº„É´„Éâ„ÅÆË°®Á§∫/ÈùûË°®Á§∫
  if (template.has_special_content) {
    document.getElementById('standaloneSpecialContentGroup').style.display = 'block';
  } else {
    document.getElementById('standaloneSpecialContentGroup').style.display = 'none';
  }

  // ÂÖ•ÂäõÂÄ§„ÇíÂèñÂæó
  const customerName = document.getElementById('standaloneCustomerName').value.trim();
  const staffName = document.getElementById('standaloneStaffName').value.trim();
  const dueDate = document.getElementById('standaloneDueDate').value;
  const specialContent = document.getElementById('standaloneSpecialContent').value.trim();

  // „Çµ„Éñ„Ç™„Éó„Ç∑„Éß„É≥ÔºàÊ•≠ËÄÖÈÅ∏ÊäûÔºâ„Åå„ÅÇ„Çã„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂ†¥Âêà
  if (template.has_sub_options) {
    document.getElementById('standaloneVendorGroup').style.display = 'block';
    const vendorSelect = document.getElementById('standaloneVendorSelect');
    const selectedVendorId = vendorSelect.value;

    // Ê•≠ËÄÖÈÅ∏Êäû„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞
    if (vendorSelect.options.length === 0) {
      const templateVendors = vendors.filter(v => v.template_id === templateId);
      vendorSelect.innerHTML = '<option value="">Ê•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' +
        templateVendors.map(v =>
          `<option value="${escapeHtml(v.vendor_id)}">${escapeHtml(v.company)}</option>`
        ).join('');
    }

    if (!selectedVendorId) {
      // Ê•≠ËÄÖÊú™ÈÅ∏ÊäûÊôÇ„ÅØ„É°„Éº„É´ÁîüÊàê„Åó„Å™„ÅÑ
      document.getElementById('standaloneEmailSubject').textContent = 'Ê•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      document.getElementById('standaloneEmailAddress').textContent = '';
      document.getElementById('standaloneEmailBody').textContent = '';
      return;
    }

    const vendor = vendors.find(v => v.template_id === templateId && v.vendor_id === selectedVendorId);
    if (!vendor) return;

    // Ê•≠ËÄÖÊÉÖÂ†±„ÅßÂ§âÊï∞„ÇíÁΩÆÊèõ
    let subject = template.subject_format || '';
    let body = template.template_text || '';

    subject = subject
      .replace(/\{customerName\}/g, customerName || '{„ÅäÂÆ¢ÊßòÂêç}')
      .replace(/\{dueDate\}/g, dueDate || '{ÊúüÊó•}');

    body = body
      .replace(/\{company\}/g, vendor.company)
      .replace(/\{contact\}/g, vendor.contact || '„ÅîÊãÖÂΩìËÄÖÊßò')
      .replace(/\{customerName\}/g, customerName || '{„ÅäÂÆ¢ÊßòÂêç}')
      .replace(/\{staffName\}/g, staffName || '{ÊãÖÂΩìËÄÖÂêç}')
      .replace(/\{dueDate\}/g, dueDate || '{ÊúüÊó•}')
      .replace(/\{specialContent\}/g, specialContent || template.default_special_content || '');

    document.getElementById('standaloneEmailSubject').textContent = subject;
    document.getElementById('standaloneEmailAddress').textContent = vendor.email || '';
    document.getElementById('standaloneEmailBody').textContent = body;
  } else {
    // „Çµ„Éñ„Ç™„Éó„Ç∑„Éß„É≥„Å™„Åó„ÉÜ„É≥„Éó„É¨„Éº„Éà
    document.getElementById('standaloneVendorGroup').style.display = 'none';

    let subject = template.subject_format || '';
    let body = template.template_text || '';

    subject = subject
      .replace(/\{customerName\}/g, customerName || '{„ÅäÂÆ¢ÊßòÂêç}')
      .replace(/\{dueDate\}/g, dueDate || '{ÊúüÊó•}');

    body = body
      .replace(/\{company\}/g, template.company)
      .replace(/\{contact\}/g, template.contact || '„ÅîÊãÖÂΩìËÄÖÊßò')
      .replace(/\{customerName\}/g, customerName || '{„ÅäÂÆ¢ÊßòÂêç}')
      .replace(/\{staffName\}/g, staffName || '{ÊãÖÂΩìËÄÖÂêç}')
      .replace(/\{dueDate\}/g, dueDate || '{ÊúüÊó•}')
      .replace(/\{specialContent\}/g, specialContent || template.default_special_content || '');

    document.getElementById('standaloneEmailSubject').textContent = subject;
    document.getElementById('standaloneEmailAddress').textContent = template.email || '';
    document.getElementById('standaloneEmailBody').textContent = body;
  }
}

function copyStandaloneText(elementId) {
  const text = document.getElementById(elementId).textContent;
  if (!text || text.includes('{') || text.includes('ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ')) {
    showToast('„Ç≥„Éî„Éº„Åß„Åç„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
  }).catch(err => {
    logError('„Ç≥„Éî„Éº„Å´Â§±Êïó:', err);
    showToast('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  });
}

function populateStandaloneTemplateSelect() {
  const select = document.getElementById('standaloneTemplateSelect');
  if (!select) return;

  // currentUserCategory„Å´Âøú„Åò„Å¶„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
  let filtered = emailTemplates;
  if (currentUserCategory && currentUserCategory !== 'admin') {
    filtered = emailTemplates.filter(t => t.category === currentUserCategory);
  }

  select.innerHTML = '<option value="">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' +
    filtered.map(t =>
      `<option value="${escapeHtml(t.template_id)}">${escapeHtml(t.display_name)}</option>`
    ).join('');
}

// ============================================
// „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ
// ============================================
const ExportManager = {
  // „Ç®„ÇØ„Çπ„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
  showModal() {
    const modal = document.createElement('div');
    modal.id = 'exportModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 500px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">üìÅ „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂΩ¢Âºè</label>
            <div style="display: grid; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="exportFormat" value="csv" checked> CSVÔºàExcelÂØæÂøúÔºâ
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="exportFormat" value="json"> JSON
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="exportFormat" value="print"> Âç∞Âà∑Áî®„É¨„Éù„Éº„Éà
              </label>
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂØæË±°</label>
            <div style="display: grid; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exportProjects" checked> Ê°à‰ª∂„Éá„Éº„ÇøÔºà${projects.length}‰ª∂Ôºâ
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exportWithTasks" checked> „Çø„Çπ„ÇØË©≥Á¥∞„ÇíÂê´„ÇÅ„Çã
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exportOnlyActive" checked> „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ê°à‰ª∂„ÅÆ„Åø
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('exportModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="btn btn-primary" onclick="ExportManager.execute()">„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  },

  execute() {
    const format = document.querySelector('input[name="exportFormat"]:checked').value;
    const includeProjects = document.getElementById('exportProjects').checked;
    const includeTasks = document.getElementById('exportWithTasks').checked;
    const onlyActive = document.getElementById('exportOnlyActive').checked;

    document.getElementById('exportModal').remove();

    let dataToExport = projects;
    if (onlyActive) {
      dataToExport = dataToExport.filter(p => p.status !== 'completed' && !p.is_archived);
    }

    switch (format) {
      case 'csv':
        this.exportCSV(dataToExport, includeTasks);
        break;
      case 'json':
        this.exportJSON(dataToExport, includeTasks);
        break;
      case 'print':
        this.exportPrint(dataToExport, includeTasks);
        break;
    }
  },

  exportCSV(data, includeTasks) {
    if (data.length === 0) {
      showToast('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÊ°à‰ª∂„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }

    let headers, rows;

    if (includeTasks) {
      headers = ['È°ßÂÆ¢Âêç', 'ÊãÖÂΩìËÄÖ', 'ICÊãÖÂΩì', 'ÂïÜÂìÅ', 'ÈÄ≤ÊçóÁéá', '„Çø„Çπ„ÇØÂêç', '„Çø„Çπ„ÇØÁä∂ÊÖã', 'ÊúüÈôê', '„É°„É¢', '‰ΩúÊàêÊó•'];
      rows = [];
      data.forEach(p => {
        const progress = calculateProgress(p);
        const tasks = p.tasks || {};
        const taskEntries = Object.entries(tasks);

        if (taskEntries.length === 0) {
          rows.push([
            this.csvEscape(p.customer),
            this.csvEscape(p.assigned_to),
            this.csvEscape(p.ic_assignee),
            this.csvEscape(p.specifications || 'LIFE'),
            `${progress}%`,
            '', '', '',
            this.csvEscape(p.memo),
            p.created_at || ''
          ].join(','));
        } else {
          taskEntries.forEach(([key, task], idx) => {
            const taskDef = tasksV2.find(t => t.task_key === key);
            rows.push([
              idx === 0 ? this.csvEscape(p.customer) : '',
              idx === 0 ? this.csvEscape(p.assigned_to) : '',
              idx === 0 ? this.csvEscape(p.ic_assignee) : '',
              idx === 0 ? this.csvEscape(p.specifications || 'LIFE') : '',
              idx === 0 ? `${progress}%` : '',
              this.csvEscape(taskDef?.task_name || key),
              this.csvEscape(task.status || ''),
              task.due_date || '',
              idx === 0 ? this.csvEscape(p.memo) : '',
              idx === 0 ? (p.created_at || '') : ''
            ].join(','));
          });
        }
      });
    } else {
      headers = ['È°ßÂÆ¢Âêç', 'ÊãÖÂΩìËÄÖ', 'ICÊãÖÂΩì', 'ÂïÜÂìÅ', 'ÈÄ≤ÊçóÁéá', '„É°„É¢', '‰ΩúÊàêÊó•', 'Êõ¥Êñ∞Êó•'];
      rows = data.map(p => {
        const progress = calculateProgress(p);
        return [
          this.csvEscape(p.customer),
          this.csvEscape(p.assigned_to),
          this.csvEscape(p.ic_assignee),
          this.csvEscape(p.specifications || 'LIFE'),
          `${progress}%`,
          this.csvEscape(p.memo),
          p.created_at || '',
          p.updated_at || ''
        ].join(',');
      });
    }

    const csvContent = [headers.join(','), ...rows].join('\n');
    this.download(csvContent, 'csv', 'projects');
    showToast(`${data.length}‰ª∂„ÅÆÊ°à‰ª∂„ÇíCSV„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`, 'success');
  },

  exportJSON(data, includeTasks) {
    if (data.length === 0) {
      showToast('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÊ°à‰ª∂„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }

    const exportData = data.map(p => {
      const base = {
        customer: p.customer,
        assigned_to: p.assigned_to,
        ic_assignee: p.ic_assignee,
        specifications: p.specifications,
        progress: calculateProgress(p),
        status: p.status,
        memo: p.memo,
        created_at: p.created_at,
        updated_at: p.updated_at
      };

      if (includeTasks && p.tasks) {
        base.tasks = Object.entries(p.tasks).map(([key, task]) => {
          const taskDef = tasksV2.find(t => t.task_key === key);
          return {
            task_key: key,
            task_name: taskDef?.task_name || key,
            status: task.status,
            due_date: task.due_date,
            completed_at: task.completed_at
          };
        });
      }

      return base;
    });

    const jsonContent = JSON.stringify({
      exported_at: new Date().toISOString(),
      version: APP_VERSION,
      count: exportData.length,
      projects: exportData
    }, null, 2);

    this.download(jsonContent, 'json', 'projects');
    showToast(`${data.length}‰ª∂„ÅÆÊ°à‰ª∂„ÇíJSON„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`, 'success');
  },

  exportPrint(data, includeTasks) {
    if (data.length === 0) {
      showToast('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÊ°à‰ª∂„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }

    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      showToast('„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„ÄÇË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      return;
    }

    const html = `
      <!DOCTYPE html>
      <html lang="ja">
      <head>
        <meta charset="UTF-8">
        <title>ArchiDeck - Ê°à‰ª∂„É¨„Éù„Éº„Éà</title>
        <style>
          body { font-family: 'Noto Sans JP', sans-serif; padding: 20mm; color: #333; }
          h1 { text-align: center; border-bottom: 2px solid #2563EB; padding-bottom: 10px; }
          .meta { text-align: right; color: #666; margin-bottom: 20px; }
          table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background: #f5f5f5; font-weight: 600; }
          .project-section { margin-bottom: 30px; page-break-inside: avoid; }
          .project-title { background: #2563EB; color: white; padding: 10px; margin-bottom: 10px; }
          .tasks-table { font-size: 12px; }
          .progress { font-weight: bold; color: #2563EB; }
          @media print {
            body { padding: 10mm; }
            .project-section { page-break-inside: avoid; }
          }
        </style>
      </head>
      <body>
        <h1>ArchiDeck Ê°à‰ª∂„É¨„Éù„Éº„Éà</h1>
        <div class="meta">
          Âá∫ÂäõÊó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}<br>
          Ê°à‰ª∂Êï∞: ${data.length}‰ª∂
        </div>
        ${data.map(p => {
          const progress = calculateProgress(p);
          const taskRows = includeTasks && p.tasks ? Object.entries(p.tasks).map(([key, task]) => {
            const taskDef = tasksV2.find(t => t.task_key === key);
            return `<tr>
              <td>${this.escapeHtml(taskDef?.task_name || key)}</td>
              <td>${this.escapeHtml(task.status || 'Êú™ÁùÄÊâã')}</td>
              <td>${task.due_date || '-'}</td>
            </tr>`;
          }).join('') : '';

          return `
            <div class="project-section">
              <div class="project-title">${this.escapeHtml(p.customer)} - ${this.escapeHtml(p.specifications || 'LIFE')}</div>
              <table>
                <tr><th>ÊãÖÂΩìËÄÖ</th><td>${this.escapeHtml(p.assigned_to || '-')}</td><th>ICÊãÖÂΩì</th><td>${this.escapeHtml(p.ic_assignee || '-')}</td></tr>
                <tr><th>ÈÄ≤Êçó</th><td class="progress">${progress}%</td><th>‰ΩúÊàêÊó•</th><td>${p.created_at?.split('T')[0] || '-'}</td></tr>
                ${p.memo ? `<tr><th>„É°„É¢</th><td colspan="3">${this.escapeHtml(p.memo)}</td></tr>` : ''}
              </table>
              ${includeTasks && taskRows ? `
                <table class="tasks-table">
                  <thead><tr><th>„Çø„Çπ„ÇØ</th><th>Áä∂ÊÖã</th><th>ÊúüÈôê</th></tr></thead>
                  <tbody>${taskRows}</tbody>
                </table>
              ` : ''}
            </div>
          `;
        }).join('')}
      </body>
      </html>
    `;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.onload = () => printWindow.print();
    showToast('Âç∞Âà∑Áî®„É¨„Éù„Éº„Éà„ÇíÁîüÊàê„Åó„Åæ„Åó„Åü', 'success');
  },

  csvEscape(str) {
    if (!str) return '""';
    return `"${String(str).replace(/"/g, '""')}"`;
  },

  escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  },

  download(content, type, prefix) {
    const mimeTypes = {
      csv: 'text/csv;charset=utf-8;',
      json: 'application/json;charset=utf-8;'
    };
    const extensions = { csv: 'csv', json: 'json' };

    const bom = type === 'csv' ? new Uint8Array([0xEF, 0xBB, 0xBF]) : new Uint8Array([]);
    const blob = new Blob([bom, content], { type: mimeTypes[type] });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${prefix}_${new Date().toISOString().split('T')[0]}.${extensions[type]}`;
    link.click();
    URL.revokeObjectURL(url);
  }
};

// ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊóßÈñ¢Êï∞„ÇíÊÆã„Åô
function exportCSV() {
  ExportManager.showModal();
}

// ============================================
// „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„ÉàÊ©üËÉΩ
// ============================================
const DataImporter = {
  showModal() {
    const modal = document.createElement('div');
    modal.id = 'importModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 500px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">üì• „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">„Ç§„É≥„Éù„Éº„ÉàÂΩ¢Âºè</label>
            <select id="importFormat" class="form-input" style="width: 100%; padding: 10px;">
              <option value="csv">CSVÔºàExcelÂá∫Âäõ„Éï„Ç°„Ç§„É´Ôºâ</option>
              <option value="json">JSONÔºà„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´Ôºâ</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">„Éï„Ç°„Ç§„É´ÈÅ∏Êäû</label>
            <input type="file" id="importFile" accept=".csv,.json" style="width: 100%;">
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
              CSV: È°ßÂÆ¢Âêç,ÊãÖÂΩìËÄÖ,ICÊãÖÂΩì,ÂïÜÂìÅ,„É°„É¢ „ÅÆÂΩ¢Âºè<br>
              JSON: „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åü„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´
            </p>
          </div>
          <div id="importPreview" style="display: none; margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">„Éó„É¨„Éì„É•„Éº</label>
            <div id="importPreviewContent" style="max-height: 200px; overflow-y: auto; background: var(--bg-secondary); padding: 12px; border-radius: 8px; font-size: 13px;"></div>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="importSkipDuplicates" checked>
              <span>ÈáçË§á„Åô„ÇãÈ°ßÂÆ¢Âêç„ÅØ„Çπ„Ç≠„ÉÉ„Éó</span>
            </label>
          </div>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('importModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="btn btn-primary" id="importExecuteBtn" onclick="DataImporter.execute()" disabled>„Ç§„É≥„Éù„Éº„Éà</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);

    // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆ„Éó„É¨„Éì„É•„Éº
    document.getElementById('importFile').addEventListener('change', (e) => {
      this.previewFile(e.target.files[0]);
    });
  },

  async previewFile(file) {
    if (!file) return;

    const format = document.getElementById('importFormat').value;
    const previewDiv = document.getElementById('importPreview');
    const previewContent = document.getElementById('importPreviewContent');
    const executeBtn = document.getElementById('importExecuteBtn');

    try {
      const text = await file.text();
      let data;

      if (format === 'csv') {
        data = this.parseCSV(text);
      } else {
        data = this.parseJSON(text);
      }

      if (data.length === 0) {
        previewContent.innerHTML = '<p style="color: var(--danger-color);">„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</p>';
        executeBtn.disabled = true;
        previewDiv.style.display = 'block';
        return;
      }

      // „Éó„É¨„Éì„É•„ÉºË°®Á§∫ÔºàÊúÄÂ§ß5‰ª∂Ôºâ
      const previewItems = data.slice(0, 5);
      previewContent.innerHTML = `
        <p style="margin-bottom: 8px; font-weight: 500;">${data.length}‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíÊ§úÂá∫</p>
        ${previewItems.map(item => `
          <div style="padding: 8px; background: var(--bg-primary); border-radius: 4px; margin-bottom: 4px;">
            ${escapeHtml(item.customer || item.È°ßÂÆ¢Âêç || '(È°ßÂÆ¢Âêç„Å™„Åó)')} - ${escapeHtml(item.specifications || item.ÂïÜÂìÅ || 'LIFE')}
          </div>
        `).join('')}
        ${data.length > 5 ? `<p style="color: var(--text-muted);">...‰ªñ ${data.length - 5}‰ª∂</p>` : ''}
      `;

      this.pendingData = data;
      executeBtn.disabled = false;
      previewDiv.style.display = 'block';

    } catch (error) {
      previewContent.innerHTML = `<p style="color: var(--danger-color);">„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${escapeHtml(error.message || 'Unknown error')}</p>`;
      executeBtn.disabled = true;
      previewDiv.style.display = 'block';
    }
  },

  parseCSV(text) {
    const lines = text.split('\n').filter(line => line.trim());
    if (lines.length < 2) return [];

    // „Éò„ÉÉ„ÉÄ„ÉºËß£Êûê
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const data = [];

    for (let i = 1; i < lines.length; i++) {
      const values = this.parseCSVLine(lines[i]);
      if (values.length === 0) continue;

      const row = {};
      headers.forEach((header, idx) => {
        row[header] = values[idx] || '';
      });

      // È°ßÂÆ¢Âêç„Åå„ÅÇ„Çå„Å∞ÊúâÂäπ„Å™„Éá„Éº„Çø„Å®„Åó„Å¶ËøΩÂä†
      if (row['È°ßÂÆ¢Âêç'] || row['customer']) {
        data.push({
          customer: row['È°ßÂÆ¢Âêç'] || row['customer'] || '',
          assigned_to: row['ÊãÖÂΩìËÄÖ'] || row['assigned_to'] || '',
          ic_assignee: row['ICÊãÖÂΩì'] || row['ic_assignee'] || '',
          specifications: row['ÂïÜÂìÅ'] || row['specifications'] || 'LIFE',
          memo: row['„É°„É¢'] || row['memo'] || ''
        });
      }
    }

    return data;
  },

  parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === ',' && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    result.push(current.trim());
    return result;
  },

  parseJSON(text) {
    const json = JSON.parse(text);
    // „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂΩ¢Âºè„ÅÆÂ†¥Âêà
    if (json.projects && Array.isArray(json.projects)) {
      return json.projects;
    }
    // ÈÖçÂàó„ÅÆÂ†¥Âêà
    if (Array.isArray(json)) {
      return json;
    }
    return [];
  },

  async execute() {
    if (!this.pendingData || this.pendingData.length === 0) {
      showToast('„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }

    const skipDuplicates = document.getElementById('importSkipDuplicates').checked;
    const existingCustomers = new Set(projects.map(p => p.customer?.toLowerCase()));

    let imported = 0;
    let skipped = 0;

    showStatus('„Ç§„É≥„Éù„Éº„Éà‰∏≠...', 'saving');

    for (const item of this.pendingData) {
      // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
      if (skipDuplicates && existingCustomers.has(item.customer?.toLowerCase())) {
        skipped++;
        continue;
      }

      try {
        const newProject = {
          customer: item.customer,
          assigned_to: item.assigned_to || null,
          ic_assignee: item.ic_assignee || null,
          specifications: item.specifications || 'LIFE',
          memo: item.memo || '',
          status: 'active',
          progress: {},
          tasks: {}
        };

        const { data, error } = await supabase
          .from('projects')
          .insert(newProject)
          .select()
          .single();

        if (!error && data) {
          projects.push(data);
          existingCustomers.add(item.customer?.toLowerCase());
          imported++;
        }
      } catch (e) {
        logError('„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', e);
      }
    }

    document.getElementById('importModal').remove();
    renderProjects();
    renderSidebar();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');

    let message = `${imported}‰ª∂„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`;
    if (skipped > 0) {
      message += `Ôºà${skipped}‰ª∂„ÅØÈáçË§á„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„ÉóÔºâ`;
    }
    showToast(message, 'success');

    this.pendingData = null;
  },

  pendingData: null
};

// ============================================
// „Éê„ÉÉ„ÉÅÊìç‰Ωú
// ============================================
const BatchOperations = {
  selected: new Set(),

  toggle(projectId) {
    if (this.selected.has(projectId)) {
      this.selected.delete(projectId);
    } else {
      this.selected.add(projectId);
    }
    this.updateUI();
  },

  selectAll() {
    const visibleCards = document.querySelectorAll('.project-card[data-project-id]');
    visibleCards.forEach(card => {
      this.selected.add(card.dataset.projectId);
    });
    this.updateUI();
    renderProjects();
  },

  deselectAll() {
    this.selected.clear();
    this.updateUI();
    renderProjects();
  },

  isSelected(projectId) {
    return this.selected.has(projectId);
  },

  updateUI() {
    const toolbar = document.getElementById('batchToolbar');
    const count = this.selected.size;

    if (count > 0) {
      if (!toolbar) {
        this.showToolbar();
      }
      document.getElementById('batchCount').textContent = `${count}‰ª∂ÈÅ∏Êäû‰∏≠`;
    } else {
      if (toolbar) toolbar.remove();
    }

    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    document.querySelectorAll('.batch-checkbox').forEach(cb => {
      cb.checked = this.selected.has(cb.dataset.projectId);
    });
  },

  showToolbar() {
    const toolbar = document.createElement('div');
    toolbar.id = 'batchToolbar';
    toolbar.style.cssText = `
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--bg-primary); border: 1px solid var(--border-color);
      padding: 12px 20px; border-radius: 12px; box-shadow: var(--shadow-lg);
      display: flex; align-items: center; gap: 16px; z-index: 1000;
    `;
    toolbar.innerHTML = `
      <span id="batchCount" style="font-weight: 600;">0‰ª∂ÈÅ∏Êäû‰∏≠</span>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.showAssignModal()">üë§ ÊãÖÂΩìÂ§âÊõ¥</button>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.showICTaskModal()">üé® IC‰∏ÄÊã¨Êõ¥Êñ∞</button>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.showDeadlineModal()">üìÖ ÊúüÈôêË®≠ÂÆö</button>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.deselectAll()">‚úï ÈÅ∏ÊäûËß£Èô§</button>
    `;
    document.body.appendChild(toolbar);
  },

  showDeadlineModal() {
    if (this.selected.size === 0) return;

    const modal = document.createElement('div');
    modal.id = 'batchDeadlineModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 400px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">üìÖ ‰∏ÄÊã¨ÊúüÈôêË®≠ÂÆö</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <p style="margin-bottom: 16px; color: var(--text-secondary);">${this.selected.size}‰ª∂„ÅÆÊ°à‰ª∂„Å´ÊúüÈôê„ÇíË®≠ÂÆö„Åó„Åæ„Åô</p>
          <input type="date" id="batchDeadline" class="form-input" style="width: 100%;">
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('batchDeadlineModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="btn btn-primary" onclick="BatchOperations.applyDeadline()">Ë®≠ÂÆö</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  },

  async applyDeadline() {
    const deadline = document.getElementById('batchDeadline').value;
    if (!deadline) {
      showToast('ÊúüÈôê„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
      return;
    }

    document.getElementById('batchDeadlineModal').remove();
    showStatus('Âá¶ÁêÜ‰∏≠...', 'saving');
    let count = 0;

    for (const projectId of this.selected) {
      DeadlineManager.setDeadline(projectId, deadline);
      count++;
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(`${count}‰ª∂„Å´ÊúüÈôê„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü`, 'success');
  },

  async deleteSelected() {
    if (this.selected.size === 0) return;

    const confirmed = confirm(`${this.selected.size}‰ª∂„ÅÆÊ°à‰ª∂„ÇíÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ`);
    if (!confirmed) return;

    const doubleConfirm = confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü');
    if (!doubleConfirm) return;

    showStatus('Âá¶ÁêÜ‰∏≠...', 'saving');
    let count = 0;

    for (const projectId of this.selected) {
      const { error } = await supabase
        .from('projects')
        .delete()
        .eq('id', projectId);

      if (!error) {
        projects = projects.filter(p => p.id !== projectId);
        count++;
      }
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    renderSidebar();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(`${count}‰ª∂„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
  },

  async archiveSelected() {
    if (this.selected.size === 0) return;

    // Áî≥Ë´ãGOÊù°‰ª∂„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    const projectsToArchive = [];
    const failedProjects = [];
    for (const projectId of this.selected) {
      const project = projects.find(p => p.id === projectId);
      if (project && canPressApplicationGo(project)) {
        projectsToArchive.push(project);
      } else if (project) {
        failedProjects.push(project.customer);
      }
    }

    if (failedProjects.length > 0) {
      showToast(`‰ª•‰∏ã„ÅÆÊ°à‰ª∂„ÅØÁî≥Ë´ãGOÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì: ${failedProjects.join(', ')}`, 'warning');
    }

    if (projectsToArchive.length === 0) {
      showToast('ÂÆå‰∫ÜÂèØËÉΩ„Å™Ê°à‰ª∂„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }

    const confirmed = confirm(`${projectsToArchive.length}‰ª∂„ÅÆÊ°à‰ª∂„ÇíÂÆå‰∫ÜÊ∏à„Åø„Å´„Åó„Åæ„Åô„ÅãÔºü${failedProjects.length > 0 ? `\nÔºà${failedProjects.length}‰ª∂„ÅØÊù°‰ª∂Êú™ÈÅî„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„ÉóÔºâ` : ''}`);
    if (!confirmed) return;

    showStatus('Âá¶ÁêÜ‰∏≠...', 'saving');
    let count = 0;

    for (const project of projectsToArchive) {
      const { error } = await supabase
        .from('projects')
        .update({ is_archived: true, updated_at: new Date().toISOString() })
        .eq('id', project.id);

      if (!error) {
        project.is_archived = true;
        count++;
      }
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    renderSidebar();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(`${count}‰ª∂„ÇíÂÆå‰∫ÜÊ∏à„Åø„Å´„Åó„Åæ„Åó„Åü`, 'success');
  },

  showAssignModal() {
    if (this.selected.size === 0) return;

    const modal = document.createElement('div');
    modal.id = 'batchAssignModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    const designerOptions = designers
      .filter(d => d.category === 'Ë®≠Ë®à')
      .map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`)
      .join('');

    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 400px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">üë§ ‰∏ÄÊã¨ÊãÖÂΩìËÄÖÂ§âÊõ¥</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <p style="margin-bottom: 16px; color: var(--text-secondary);">${this.selected.size}‰ª∂„ÅÆÊ°à‰ª∂„ÅÆÊãÖÂΩìËÄÖ„ÇíÂ§âÊõ¥„Åó„Åæ„Åô</p>
          <select id="batchAssignee" class="form-input" style="width: 100%;">
            <option value="">ÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû</option>
            ${designerOptions}
          </select>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('batchAssignModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="btn btn-primary" onclick="BatchOperations.applyAssign()">Â§âÊõ¥</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  },

  async applyAssign() {
    const assignee = document.getElementById('batchAssignee').value;
    if (!assignee) {
      showToast('ÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
      return;
    }

    document.getElementById('batchAssignModal').remove();
    showStatus('Âá¶ÁêÜ‰∏≠...', 'saving');
    let count = 0;

    for (const projectId of this.selected) {
      const { error } = await supabase
        .from('projects')
        .update({ assigned_to: assignee, updated_at: new Date().toISOString() })
        .eq('id', projectId);

      if (!error) {
        const project = projects.find(p => p.id === projectId);
        if (project) project.assigned_to = assignee;
        count++;
      }
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    renderSidebar();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(`${count}‰ª∂„ÅÆÊãÖÂΩìËÄÖ„Çí${assignee}„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'success');
  },

  showICTaskModal() {
    if (this.selected.size === 0) return;

    const icTasks = tasksV2.filter(t => t.category === 'IC').sort((a, b) => a.display_order - b.display_order);
    if (icTasks.length === 0) {
      showToast('IC„Çø„Çπ„ÇØ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
      return;
    }

    const taskOptions = icTasks.map(t => `<option value="${t.task_key}">${escapeHtml(t.task_name)}</option>`).join('');

    const modal = document.createElement('div');
    modal.id = 'batchICModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 450px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">üé® IC„Çø„Çπ„ÇØ‰∏ÄÊã¨Êõ¥Êñ∞</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <p style="margin-bottom: 16px; color: var(--text-secondary);">${this.selected.size}‰ª∂„ÅÆÊ°à‰ª∂„ÅÆIC„Çø„Çπ„ÇØ„Çí‰∏ÄÊã¨Êõ¥Êñ∞„Åó„Åæ„Åô</p>
          <div style="margin-bottom: 16px;">
            <label class="form-label">„Çø„Çπ„ÇØ</label>
            <select id="batchICTask" class="form-input" style="width: 100%;" onchange="BatchOperations.updateICStateOptions()">
              <option value="">„Çø„Çπ„ÇØ„ÇíÈÅ∏Êäû</option>
              ${taskOptions}
            </select>
          </div>
          <div style="margin-bottom: 16px;">
            <label class="form-label">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
            <select id="batchICState" class="form-input" style="width: 100%;" disabled>
              <option value="">„Çø„Çπ„ÇØ„ÇíÂÖà„Å´ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            </select>
          </div>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('batchICModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="btn btn-primary" onclick="BatchOperations.applyICTask()">‰∏ÄÊã¨Êõ¥Êñ∞</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  },

  updateICStateOptions() {
    const taskKey = document.getElementById('batchICTask').value;
    const stateSelect = document.getElementById('batchICState');

    if (!taskKey) {
      stateSelect.innerHTML = '<option value="">„Çø„Çπ„ÇØ„ÇíÂÖà„Å´ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
      stateSelect.disabled = true;
      return;
    }

    const stateOptions = getTaskStateOptions(taskKey);
    if (stateOptions && Array.isArray(stateOptions)) {
      stateSelect.innerHTML = stateOptions.map(state => `<option value="${state}">${state || '-'}</option>`).join('');
      stateSelect.disabled = false;
    } else {
      stateSelect.innerHTML = '<option value="">„Çπ„ÉÜ„Éº„Çø„Çπ„Å™„Åó</option>';
      stateSelect.disabled = true;
    }
  },

  async applyICTask() {
    const taskKey = document.getElementById('batchICTask').value;
    const state = document.getElementById('batchICState').value;

    if (!taskKey) {
      showToast('„Çø„Çπ„ÇØ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
      return;
    }

    document.getElementById('batchICModal').remove();
    showStatus('Âá¶ÁêÜ‰∏≠...', 'saving');
    let count = 0;

    for (const projectId of this.selected) {
      const project = projects.find(p => p.id === projectId);
      if (!project) continue;

      const progressData = project.progress || {};
      if (!progressData[taskKey]) progressData[taskKey] = {};
      progressData[taskKey].state = state;

      const { error } = await supabase
        .from('projects')
        .update({ progress: progressData, updated_at: new Date().toISOString() })
        .eq('id', projectId);

      if (!error) {
        project.progress = progressData;
        project.updated_at = new Date().toISOString();
        count++;
      }
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');

    const taskDef = tasksV2.find(t => t.task_key === taskKey);
    showToast(`${count}‰ª∂„ÅÆ„Äå${taskDef?.task_name || taskKey}„Äç„Çí„Äå${state || '-'}„Äç„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`, 'success');
  }
};

// ============================================
// „Éï„Ç£„É´„Çø„Éº„Éó„É™„Çª„ÉÉ„ÉàÁÆ°ÁêÜ
// ============================================
const FilterPresets = {
  presets: safeJsonParse(localStorage.getItem('filterPresets'), []),

  save() {
    localStorage.setItem('filterPresets', JSON.stringify(this.presets));
  },

  getCurrentFilter() {
    return {
      designer: currentDesignerTab,
      archive: document.getElementById('archiveFilter')?.value || 'active',
      search: document.getElementById('searchQuery')?.value || '',
      spec: document.getElementById('specFilter')?.value || ''
    };
  },

  addPreset(name) {
    if (!name || !name.trim()) {
      showToast('„Éó„É™„Çª„ÉÉ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
      return false;
    }

    const filter = this.getCurrentFilter();
    const preset = {
      id: Date.now().toString(),
      name: name.trim(),
      filter: filter,
      createdAt: new Date().toISOString()
    };

    this.presets.unshift(preset);
    this.save();
    this.renderDropdown();
    showToast(`„Äå${name}„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`, 'success');
    return true;
  },

  deletePreset(id) {
    const preset = this.presets.find(p => p.id === id);
    if (preset && confirm(`„Äå${preset.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
      this.presets = this.presets.filter(p => p.id !== id);
      this.save();
      this.renderDropdown();
      showToast('„Éó„É™„Çª„ÉÉ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'info');
    }
  },

  applyPreset(id) {
    const preset = this.presets.find(p => p.id === id);
    if (!preset) return;

    const { filter } = preset;

    // ÊãÖÂΩìËÄÖ„Çø„Éñ„ÇíÂàá„ÇäÊõø„Åà
    if (filter.designer) {
      currentDesignerTab = filter.designer;
      renderDesignerTabs();
    }

    // „Éï„Ç£„É´„Çø„ÉºÂÄ§„ÇíË®≠ÂÆö
    const archiveFilter = document.getElementById('archiveFilter');
    const searchQuery = document.getElementById('searchQuery');
    const specFilter = document.getElementById('specFilter');

    if (archiveFilter) archiveFilter.value = filter.archive || 'active';
    if (searchQuery) searchQuery.value = filter.search || '';
    if (specFilter) specFilter.value = filter.spec || '';

    renderProjects();
    showToast(`„Äå${preset.name}„Äç„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü`, 'success');
  },

  showSaveModal() {
    const filter = this.getCurrentFilter();
    const filterDesc = this.describeFilter(filter);

    const modal = document.createElement('div');
    modal.id = 'presetSaveModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">„Éï„Ç£„É´„Çø„Éº„Çí‰øùÂ≠ò</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
            <strong>ÁèæÂú®„ÅÆ„Éï„Ç£„É´„Çø„Éº:</strong><br>${filterDesc}
          </div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">„Éó„É™„Çª„ÉÉ„ÉàÂêç</label>
          <input type="text" id="presetName" class="form-input" style="width: 100%;" placeholder="‰æã: Áî∞‰∏≠„Åï„Çì„ÅÆÈÄ≤Ë°å‰∏≠Ê°à‰ª∂" autofocus>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('presetSaveModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="btn btn-primary" onclick="FilterPresets.confirmSave()">‰øùÂ≠ò</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);

    // Enter„Ç≠„Éº„Åß‰øùÂ≠ò
    document.getElementById('presetName').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') FilterPresets.confirmSave();
    });
  },

  confirmSave() {
    const name = document.getElementById('presetName').value;
    if (this.addPreset(name)) {
      document.getElementById('presetSaveModal').remove();
    }
  },

  describeFilter(filter) {
    const parts = [];
    if (filter.designer && filter.designer !== 'ALL') {
      parts.push(`ÊãÖÂΩì: ${filter.designer}`);
    }
    if (filter.archive && filter.archive !== 'active') {
      const labels = { all: 'ÂÖ®„Å¶', archived: 'ÂÆå‰∫ÜÊ∏à„Åø' };
      parts.push(labels[filter.archive] || filter.archive);
    }
    if (filter.search) {
      parts.push(`Ê§úÁ¥¢: "${filter.search}"`);
    }
    if (filter.spec) {
      parts.push(`‰ªïÊßò: ${filter.spec}`);
    }
    return parts.length > 0 ? parts.join('„ÄÅ') : '„Éï„Ç£„É´„Çø„Éº„Å™„Åó';
  },

  renderDropdown() {
    const container = document.getElementById('presetDropdown');
    if (!container) return;

    if (this.presets.length === 0) {
      container.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); font-size: 13px;">‰øùÂ≠òÊ∏à„Åø„Éó„É™„Çª„ÉÉ„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      return;
    }

    container.innerHTML = this.presets.map(preset => `
      <div class="preset-item" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid var(--border-color); cursor: pointer;"
           onmouseenter="this.style.background='var(--bg-secondary)'"
           onmouseleave="this.style.background='white'">
        <div style="flex: 1;" onclick="FilterPresets.applyPreset('${preset.id}'); document.getElementById('presetMenu').style.display='none';">
          <div style="font-weight: 500; font-size: 14px;">${preset.name}</div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${this.describeFilter(preset.filter)}</div>
        </div>
        <button class="btn btn-ghost btn-small" style="padding: 4px 8px; font-size: 12px;" onclick="event.stopPropagation(); FilterPresets.deletePreset('${preset.id}')">ÂâäÈô§</button>
      </div>
    `).join('');
  },

  toggleMenu() {
    const menu = document.getElementById('presetMenu');
    if (!menu) return;

    if (menu.style.display === 'none' || !menu.style.display) {
      this.renderDropdown();
      menu.style.display = 'block';
      // Â§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
      setTimeout(() => {
        document.addEventListener('click', this.closeMenuOnClickOutside);
      }, 10);
    } else {
      menu.style.display = 'none';
      document.removeEventListener('click', this.closeMenuOnClickOutside);
    }
  },

  closeMenuOnClickOutside(e) {
    const menu = document.getElementById('presetMenu');
    const btn = document.getElementById('presetBtn');
    if (menu && !menu.contains(e.target) && !btn.contains(e.target)) {
      menu.style.display = 'none';
      document.removeEventListener('click', FilterPresets.closeMenuOnClickOutside);
    }
  }
};

// ============================================
// „ÇØ„Ç§„ÉÉ„ÇØÁ∑®ÈõÜ
// ============================================
const QuickEdit = {
  showAssigneeDropdown(projectId, element, assigneeType = 'assigned_to') {
    // Êó¢Â≠ò„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÂâäÈô§
    document.querySelectorAll('.quick-edit-dropdown').forEach(el => el.remove());

    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const rect = element.getBoundingClientRect();

    // ÊãÖÂΩìËÄÖ„Çø„Ç§„Éó„Å´Âøú„Åò„Å¶„Éï„Ç£„É´„Çø
    const categoryMap = {
      'assigned_to': 'Ë®≠Ë®à',
      'ic_assignee': 'IC',
      'exterior_assignee': 'Â§ñÊßã',
      'realestate_assignee': '‰∏çÂãïÁî£'
    };
    const labelMap = {
      'assigned_to': 'Ë®≠Ë®àÊãÖÂΩìËÄÖ',
      'ic_assignee': 'ICÊãÖÂΩìËÄÖ',
      'exterior_assignee': 'Â§ñÊßãÊãÖÂΩìËÄÖ',
      'realestate_assignee': '‰∏çÂãïÁî£ÊãÖÂΩìËÄÖ'
    };
    const category = categoryMap[assigneeType] || 'Ë®≠Ë®à';
    const label = labelMap[assigneeType] || 'ÊãÖÂΩìËÄÖ';
    const designerList = designers.filter(d => d.category === category);
    const currentAssignee = project[assigneeType] || '';

    const dropdown = document.createElement('div');
    dropdown.className = 'quick-edit-dropdown';
    dropdown.style.cssText = `position: fixed; top: ${rect.bottom + 4}px; left: ${rect.left}px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; min-width: 150px; max-height: 300px; overflow-y: auto;`;

    dropdown.innerHTML = `
      <div style="padding: 8px 12px; border-bottom: 1px solid var(--border-color); font-size: 12px; color: var(--text-secondary);">${label}„ÇíÂ§âÊõ¥</div>
      <div class="quick-edit-option" style="padding: 10px 12px; cursor: pointer; font-size: 14px; ${!currentAssignee ? 'background: var(--primary-light); font-weight: 500;' : ''}"
           onmouseenter="this.style.background='var(--bg-secondary)'"
           onmouseleave="this.style.background='${!currentAssignee ? 'var(--primary-light)' : ''}'"
           onclick="QuickEdit.changeAssignee('${projectId}', '', '${assigneeType}')">ÔºàÊú™Ë®≠ÂÆöÔºâ</div>
      ${designerList.map(d => `
        <div class="quick-edit-option" style="padding: 10px 12px; cursor: pointer; font-size: 14px; ${currentAssignee === d.name ? 'background: var(--primary-light); font-weight: 500;' : ''}"
             onmouseenter="this.style.background='var(--bg-secondary)'"
             onmouseleave="this.style.background='${currentAssignee === d.name ? 'var(--primary-light)' : ''}'"
             onclick="QuickEdit.changeAssignee('${projectId}', '${d.name}', '${assigneeType}')">${d.name}</div>
      `).join('')}
    `;

    document.body.appendChild(dropdown);

    // Â§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    setTimeout(() => {
      document.addEventListener('click', QuickEdit.closeDropdown);
    }, 10);
  },

  closeDropdown(e) {
    if (!e.target.closest('.quick-edit-dropdown') && !e.target.closest('.quick-edit-trigger')) {
      document.querySelectorAll('.quick-edit-dropdown').forEach(el => el.remove());
      document.removeEventListener('click', QuickEdit.closeDropdown);
    }
  },

  async changeAssignee(projectId, assignee, assigneeType = 'assigned_to') {
    document.querySelectorAll('.quick-edit-dropdown').forEach(el => el.remove());

    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const labelMap = {
      'assigned_to': 'Ë®≠Ë®àÊãÖÂΩìËÄÖ',
      'ic_assignee': 'ICÊãÖÂΩìËÄÖ',
      'exterior_assignee': 'Â§ñÊßãÊãÖÂΩìËÄÖ',
      'realestate_assignee': '‰∏çÂãïÁî£ÊãÖÂΩìËÄÖ'
    };
    const label = labelMap[assigneeType] || 'ÊãÖÂΩìËÄÖ';
    const oldAssignee = project[assigneeType];
    showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

    const updateData = { updated_at: new Date().toISOString() };
    updateData[assigneeType] = assignee || null;

    const { error } = await supabase
      .from('projects')
      .update(updateData)
      .eq('id', projectId);

    if (error) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('Â§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
      return;
    }

    UndoManager.record({
      type: 'UPDATE_PROJECT',
      projectId,
      description: `${project.customer} - ${label}„Çí${oldAssignee || 'Êú™Ë®≠ÂÆö'}„Åã„Çâ${assignee || 'Êú™Ë®≠ÂÆö'}„Å´Â§âÊõ¥`,
      oldValue: { [assigneeType]: oldAssignee },
      newValue: { [assigneeType]: assignee || null }
    });

    project[assigneeType] = assignee || null;
    project.updated_at = new Date().toISOString();
    renderProjects();
    renderSidebar();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(`${label}„Çí${assignee || 'Êú™Ë®≠ÂÆö'}„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'success');
  }
};

// ============================================
// ÊúüÈôê„Éª„É™„Éû„Ç§„É≥„ÉÄ„ÉºÁÆ°ÁêÜ
// ============================================
const DeadlineManager = {
  reminders: safeJsonParse(localStorage.getItem('projectReminders'), {}),

  setDeadline(projectId, deadline) {
    this.reminders[projectId] = { deadline, notified: false };
    this.save();
  },

  getDeadline(projectId) {
    return this.reminders[projectId]?.deadline || null;
  },

  save() {
    localStorage.setItem('projectReminders', JSON.stringify(this.reminders));
  },

  checkReminders() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    projects.forEach(project => {
      const reminder = this.reminders[project.id];
      if (!reminder || reminder.notified || project.is_archived) return;

      const deadline = new Date(reminder.deadline);
      deadline.setHours(0, 0, 0, 0);
      const diffDays = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));

      if (diffDays <= 3 && diffDays >= 0) {
        const msg = diffDays === 0 ? 'Êú¨Êó•„ÅåÊúüÈôê„Åß„Åô' : `„ÅÇ„Å®${diffDays}Êó•„ÅßÊúüÈôê„Åß„Åô`;
        showToast(`üìÖ ${project.customer}: ${msg}`, 'warning');
        this.reminders[project.id].notified = true;
        this.save();
      } else if (diffDays < 0) {
        showToast(`‚ö†Ô∏è ${project.customer}: ÊúüÈôê„Çí${Math.abs(diffDays)}Êó•ÈÅé„Åé„Å¶„ÅÑ„Åæ„Åô`, 'error');
        this.reminders[project.id].notified = true;
        this.save();
      }
    });
  },

  getStatus(projectId) {
    const deadline = this.getDeadline(projectId);
    if (!deadline) return null;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const due = new Date(deadline);
    due.setHours(0, 0, 0, 0);
    const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

    if (diffDays < 0) return { class: 'overdue', label: `${Math.abs(diffDays)}Êó•Ë∂ÖÈÅé`, color: '#EF4444' };
    if (diffDays === 0) return { class: 'today', label: 'Êú¨Êó•', color: '#F59E0B' };
    if (diffDays <= 3) return { class: 'soon', label: `„ÅÇ„Å®${diffDays}Êó•`, color: '#F59E0B' };
    return { class: 'normal', label: `${due.getMonth() + 1}/${due.getDate()}`, color: '#6B7280' };
  },

  showModal(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const currentDeadline = this.getDeadline(projectId) || '';

    const modal = document.createElement('div');
    modal.id = 'deadlineModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 360px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">ÊúüÈôê„ÇíË®≠ÂÆö</h3>
          <p style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;">${escapeHtml(project.customer)}</p>
        </div>
        <div style="padding: 20px;">
          <input type="date" id="deadlineInput" class="form-input" style="width: 100%;" value="${currentDeadline}">
          <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">ÊúüÈôê„ÅÆ3Êó•Ââç„Åã„ÇâÈÄöÁü•„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between;">
          <button class="btn btn-ghost" onclick="DeadlineManager.clearDeadline('${projectId}')">„ÇØ„É™„Ç¢</button>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-ghost" onclick="document.getElementById('deadlineModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
            <button class="btn btn-primary" onclick="DeadlineManager.saveFromModal('${projectId}')">‰øùÂ≠ò</button>
          </div>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  },

  saveFromModal(projectId) {
    const deadline = document.getElementById('deadlineInput').value;
    if (deadline) {
      this.setDeadline(projectId, deadline);
      showToast('ÊúüÈôê„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü', 'success');
    }
    document.getElementById('deadlineModal').remove();
    renderProjects();
  },

  clearDeadline(projectId) {
    delete this.reminders[projectId];
    this.save();
    document.getElementById('deadlineModal').remove();
    renderProjects();
    showToast('ÊúüÈôê„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'info');
  }
};

// ============================================
// „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÉÜ„É≥„Éó„É¨„Éº„Éà
// ============================================
const TemplateManager = {
  templates: safeJsonParse(localStorage.getItem('projectTemplates'), []),

  save() {
    localStorage.setItem('projectTemplates', JSON.stringify(this.templates));
  },

  createFromProject(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const name = prompt('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', `${project.specifications || 'LIFE'}„ÉÜ„É≥„Éó„É¨„Éº„Éà`);
    if (!name) return;

    const template = {
      id: Date.now().toString(),
      name: name,
      specifications: project.specifications,
      progress: project.progress || {},
      createdAt: new Date().toISOString()
    };

    this.templates.push(template);
    this.save();
    showToast(`„ÉÜ„É≥„Éó„É¨„Éº„Éà„Äå${name}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
  },

  applyTemplate(templateId, projectId) {
    const template = this.templates.find(t => t.id === templateId);
    const project = projects.find(p => p.id === projectId);
    if (!template || !project) return;

    project.specifications = template.specifications;
    project.progress = JSON.parse(JSON.stringify(template.progress));

    this.saveProject(project);
    showToast(`„ÉÜ„É≥„Éó„É¨„Éº„Éà„Äå${template.name}„Äç„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü`, 'success');
  },

  async saveProject(project) {
    const { error } = await supabase
      .from('projects')
      .update({
        specifications: project.specifications,
        progress: project.progress,
        updated_at: new Date().toISOString()
      })
      .eq('id', project.id);

    if (!error) {
      renderProjects();
    }
  },

  deleteTemplate(templateId) {
    const template = this.templates.find(t => t.id === templateId);
    if (template && confirm(`„ÉÜ„É≥„Éó„É¨„Éº„Éà„Äå${template.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
      this.templates = this.templates.filter(t => t.id !== templateId);
      this.save();
      showToast('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'info');
    }
  },

  showSelectModal(projectId) {
    if (this.templates.length === 0) {
      showToast('‰øùÂ≠òÊ∏à„Åø„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'info');
      return;
    }

    const modal = document.createElement('div');
    modal.id = 'templateSelectModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ©Áî®</h3>
        </div>
        <div style="padding: 12px; max-height: 300px; overflow-y: auto;">
          ${this.templates.map(t => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 500;">${t.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${t.specifications || 'LIFE'}</div>
              </div>
              <button class="btn btn-primary btn-small" onclick="TemplateManager.applyTemplate('${t.id}', '${projectId}'); document.getElementById('templateSelectModal').remove();">ÈÅ©Áî®</button>
            </div>
          `).join('')}
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color);">
          <button class="btn btn-ghost" style="width: 100%;" onclick="document.getElementById('templateSelectModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  },

  showManageModal() {
    const modal = document.createElement('div');
    modal.id = 'templateManageModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ</h3>
        </div>
        <div style="padding: 12px; max-height: 400px; overflow-y: auto;">
          ${this.templates.length === 0 ? '<p style="padding: 20px; text-align: center; color: var(--text-secondary);">„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br><small>Ê°à‰ª∂„ÅÆÁ∑®ÈõÜÁîªÈù¢„Åã„Çâ„Äå„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Äç„Åß‰ΩúÊàê„Åß„Åç„Åæ„Åô</small></p>' : this.templates.map(t => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 500;">${t.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${t.specifications || 'LIFE'} | ${new Date(t.createdAt).toLocaleDateString()}</div>
              </div>
              <button class="btn btn-ghost btn-small" style="color: #EF4444;" onclick="TemplateManager.deleteTemplate('${t.id}'); document.getElementById('templateManageModal').remove(); TemplateManager.showManageModal();">ÂâäÈô§</button>
            </div>
          `).join('')}
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color);">
          <button class="btn btn-ghost" style="width: 100%;" onclick="document.getElementById('templateManageModal').remove()">Èñâ„Åò„Çã</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  }
};

// ============================================
// „É¢„Éê„Ç§„É´„Çπ„ÉØ„Ç§„ÉóÊìç‰Ωú
// ============================================
const MobileGestures = {
  startX: 0,
  startY: 0,
  currentCard: null,

  init() {
    document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
    document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
    document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: true });
  },

  handleTouchStart(e) {
    const card = e.target.closest('.project-card');
    if (!card) return;

    this.startX = e.touches[0].clientX;
    this.startY = e.touches[0].clientY;
    this.currentCard = card;
  },

  handleTouchMove(e) {
    if (!this.currentCard) return;

    const diffX = e.touches[0].clientX - this.startX;
    const diffY = e.touches[0].clientY - this.startY;

    // Ê®™ÊñπÂêë„ÅÆ„Çπ„ÉØ„Ç§„Éó„ÇíÊ§úÂá∫
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 30) {
      e.preventDefault();
      const maxSwipe = 100;
      const translateX = Math.max(-maxSwipe, Math.min(maxSwipe, diffX));
      this.currentCard.style.transform = `translateX(${translateX}px)`;
      this.currentCard.style.transition = 'none';

      // „Çπ„ÉØ„Ç§„ÉóÊñπÂêë„Å´Âøú„Åò„ÅüËÉåÊôØËâ≤
      if (diffX > 50) {
        this.currentCard.style.background = 'linear-gradient(to right, #10B981 0%, white 30%)';
      } else if (diffX < -50) {
        this.currentCard.style.background = 'linear-gradient(to left, #F59E0B 0%, white 30%)';
      } else {
        this.currentCard.style.background = '';
      }
    }
  },

  handleTouchEnd(e) {
    if (!this.currentCard) return;

    const diffX = e.changedTouches[0].clientX - this.startX;
    const projectId = this.currentCard.dataset.projectId;

    this.currentCard.style.transform = '';
    this.currentCard.style.transition = 'transform 0.2s ease';
    this.currentCard.style.background = '';

    if (diffX < -80 && projectId) {
      // Â∑¶„Çπ„ÉØ„Ç§„Éó: ÂÆå‰∫ÜÂàá„ÇäÊõø„Åà
      const project = projects.find(p => p.id === projectId);
      if (project && calculateProgress(project) >= 100) {
        toggleArchive(projectId, !project.is_archived);
      } else {
        showToast('ÂÆå‰∫Ü„Å´„Åô„Çã„Å´„ÅØÈÄ≤Êçó100%„ÅåÂøÖË¶Å„Åß„Åô', 'info');
      }
    }

    this.currentCard = null;
  }
};

// ============================================
// „Çª„ÉÉ„Ç∑„Éß„É≥„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÁÆ°ÁêÜ
// ============================================
const SessionManager = {
  timeoutMinutes: 60,
  warningMinutes: 5,
  lastActivity: Date.now(),
  timeoutId: null,
  warningId: null,
  warningShown: false,

  init() {
    this.resetTimer();
    this.setupActivityListeners();
    log('üîí „Çª„ÉÉ„Ç∑„Éß„É≥ÁÆ°ÁêÜÈñãÂßãÔºà„Çø„Ç§„É†„Ç¢„Ç¶„Éà: ' + this.timeoutMinutes + 'ÂàÜÔºâ');
  },

  setupActivityListeners() {
    const events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];
    events.forEach(event => {
      document.addEventListener(event, () => this.onActivity(), { passive: true });
    });
  },

  onActivity() {
    this.lastActivity = Date.now();
    if (this.warningShown) {
      this.hideWarning();
    }
    this.resetTimer();
  },

  resetTimer() {
    if (this.timeoutId) clearTimeout(this.timeoutId);
    if (this.warningId) clearTimeout(this.warningId);

    // Ë≠¶ÂëäË°®Á§∫„Çø„Ç§„Éû„Éº
    const warningMs = (this.timeoutMinutes - this.warningMinutes) * 60 * 1000;
    this.warningId = setTimeout(() => this.showWarning(), warningMs);

    // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„Çø„Ç§„Éû„Éº
    const timeoutMs = this.timeoutMinutes * 60 * 1000;
    this.timeoutId = setTimeout(() => this.onTimeout(), timeoutMs);
  },

  showWarning() {
    if (this.warningShown) return;
    this.warningShown = true;

    const warning = document.createElement('div');
    warning.id = 'sessionWarning';
    warning.style.cssText = `
      position: fixed; bottom: 20px; right: 20px; z-index: 10001;
      background: var(--warning-color); color: white;
      padding: 16px 20px; border-radius: 8px;
      box-shadow: var(--shadow-lg); max-width: 320px;
    `;
    warning.innerHTML = `
      <div style="font-weight: 600; margin-bottom: 8px;">‚è∞ „Çª„ÉÉ„Ç∑„Éß„É≥ÊúüÈôê</div>
      <div style="font-size: 14px; margin-bottom: 12px;">
        ${this.warningMinutes}ÂàÜÈñìÊìç‰Ωú„Åå„Å™„ÅÑ„Å®„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô
      </div>
      <button onclick="SessionManager.extendSession()"
        style="background: var(--bg-primary); color: var(--warning-color); border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
        „Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂª∂Èï∑
      </button>
    `;
    document.body.appendChild(warning);
  },

  hideWarning() {
    this.warningShown = false;
    const warning = document.getElementById('sessionWarning');
    if (warning) warning.remove();
  },

  extendSession() {
    this.onActivity();
    showToast('„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂª∂Èï∑„Åó„Åæ„Åó„Åü', 'success');
  },

  onTimeout() {
    this.hideWarning();
    showToast('„Çª„ÉÉ„Ç∑„Éß„É≥„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
    setTimeout(() => signOut(), 2000);
  },

  stop() {
    if (this.timeoutId) clearTimeout(this.timeoutId);
    if (this.warningId) clearTimeout(this.warningId);
    this.hideWarning();
  }
};

// ============================================
// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó‰∏¶„Å≥Êõø„Åà
// ============================================
let draggedProject = null;

let dragAndDropInitialized = false;

function enableDragAndDrop() {
  const container = document.getElementById('projectsContainer');
  if (!container || dragAndDropInitialized) return;

  dragAndDropInitialized = true;

  // „Ç§„Éô„É≥„Éà„Éá„É™„Ç≤„Éº„Ç∑„Éß„É≥„ÅßË¶™Ë¶ÅÁ¥†„Å´1„Å§„Å†„Åë„É™„Çπ„Éä„Éº„ÇíÁôªÈå≤Ôºà„É°„É¢„É™„É™„Éº„ÇØÈò≤Ê≠¢Ôºâ
  container.addEventListener('dragstart', (e) => {
    const card = e.target.closest('.project-card');
    if (card) handleProjectDragStart.call(card, e);
  });

  container.addEventListener('dragover', (e) => {
    const card = e.target.closest('.project-card');
    if (card) handleProjectDragOver.call(card, e);
  });

  container.addEventListener('drop', (e) => {
    const card = e.target.closest('.project-card');
    if (card) handleProjectDrop.call(card, e);
  });

  container.addEventListener('dragend', (e) => {
    const card = e.target.closest('.project-card');
    if (card) handleProjectDragEnd.call(card, e);
  });

  // „Ç´„Éº„Éâ„Å´draggableÂ±ûÊÄß„Çí‰ªò‰∏éÔºàMutationObserver„ÅßÁõ£Ë¶ñÔºâ
  const updateDraggable = () => {
    const cards = container.querySelectorAll('.project-card');
    cards.forEach((card, index) => {
      card.setAttribute('draggable', 'true');
      card.dataset.projectIndex = index;
    });
  };

  updateDraggable();

  // DOMÂ§âÊõ¥ÊôÇ„Å´draggableÂ±ûÊÄß„Çí‰ªò‰∏éÔºà„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅØËøΩÂä†„Åó„Å™„ÅÑÔºâ
  const observer = new MutationObserver(updateDraggable);
  observer.observe(container, { childList: true, subtree: true });
}

function handleProjectDragStart(e) {
  draggedProject = this;
  this.style.opacity = '0.4';
  e.dataTransfer.effectAllowed = 'move';
}

function handleProjectDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleProjectDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }

  if (draggedProject !== this) {
    const draggedIndex = parseInt(draggedProject.dataset.projectIndex);
    const targetIndex = parseInt(this.dataset.projectIndex);

    // ÈÖçÂàó„ÅÆÈ†ÜÂ∫è„ÇíÂÖ•„ÇåÊõø„Åà
    const temp = projects[draggedIndex];
    projects.splice(draggedIndex, 1);
    projects.splice(targetIndex, 0, temp);

    // ÂÜçÊèèÁîª
    renderProjects();
  }

  return false;
}

function handleProjectDragEnd(e) {
  this.style.opacity = '1';

  // „Åô„Åπ„Å¶„ÅÆ„Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
  const cards = document.querySelectorAll('.project-card');
  cards.forEach(card => {
    card.classList.remove('over');
  });
}

// ============================================
// URLÁõ¥Êé•„Ç¢„ÇØ„Çª„ÇπÊ©üËÉΩÔºà„Éè„ÉÉ„Ç∑„É•„É´„Éº„ÉÜ„Ç£„É≥„Ç∞Ôºâ
// ============================================
function updateURLWithDesigner(designerName) {
  const currentHash = window.location.hash.substring(1); // #„ÇíÈô§Âéª
  const [pathPart] = currentHash.split('?');
  const mainTab = pathPart.split('/')[0] || 'projects';

  // Êñ∞„Åó„ÅÑURL„ÇíÊßãÁØâ
  let newHash = mainTab;
  if (designerName !== 'ALL') {
    newHash += `?designer=${encodeURIComponent(designerName)}`;
  }

  // hashchange„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´„Åï„Åõ„Åö„Å´URL„ÇíÊõ¥Êñ∞
  history.replaceState(null, '', `#${newHash}`);
}

function handleHashChange() {
  // ÁÑ°Èôê„É´„Éº„ÉóÈò≤Ê≠¢
  if (isHandlingHashChange) {
    log('‚è∏Ô∏è handleHashChange: „Åô„Åß„Å´Âá¶ÁêÜ‰∏≠„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
    return;
  }

  const hash = window.location.hash.substring(1); // #„ÇíÈô§Âéª
  log('üîó handleHashChange ÈñãÂßã:', {
    hash: hash,
    timestamp: new Date().toISOString(),
    vendorsV2Length: vendorsV2.length,
    taskVendorMappingsLength: taskVendorMappings.length
  });

  if (!hash) return;

  isHandlingHashChange = true;

  // URL„Éë„É©„É°„Éº„Çø„ÇíÂàÜÈõ¢Ôºà‰æã: projects?designer=ÁÆïÊµ¶Ôºâ
  const [pathPart, queryPart] = hash.split('?');
  const [mainTab, subTab] = pathPart.split('/');

  // URL„Éë„É©„É°„Éº„Çø„ÇíËß£Êûê
  const params = new URLSearchParams(queryPart || '');
  const designerParam = params.get('designer');

  // ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Éº„ÇíÂæ©ÂÖÉ
  if (designerParam) {
    currentDesignerTab = designerParam;
    // „Çµ„Ç§„Éâ„Éê„Éº„Å®„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË°®Á§∫„ÇíÊõ¥Êñ∞Ôºà„Çø„ÉñÂàá„ÇäÊõø„ÅàÂæå„Å´ÂÆüË°åÔºâ
    setTimeout(() => {
      renderSidebar();
      if (mainTab === 'projects') {
        renderProjects();
      }
    }, 150);
  }

  // „É°„Ç§„É≥„Çø„Éñ„ÅÆÂàá„ÇäÊõø„Åà
  if (mainTab === 'projects') {
    const btn = document.querySelector('.header-nav-btn');
    if (btn) switchMainTab('projects', btn);
  } else if (mainTab === 'calendar') {
    const btn = document.querySelectorAll('.header-nav-btn')[1];
    if (btn) switchMainTab('calendar', btn);
    isHandlingHashChange = false;
    return;
  } else if (mainTab === 'analytics') {
    const btn = document.querySelectorAll('.header-nav-btn')[2];
    if (btn) switchMainTab('analytics', btn);
    isHandlingHashChange = false;
    return;
  } else if (mainTab === 'settings') {
    const btn = document.querySelectorAll('.header-nav-btn')[3];
    if (btn) switchMainTab('settings', btn);

    // „Çµ„Éñ„Çø„Éñ„ÅÆÂàá„ÇäÊõø„Åà
    if (subTab) {
      setTimeout(() => {
        const subTabMap = {
          'staff': 0,
          'vendors': 1,
          'categories': 2,
          'tasks': 3,
          'products': 4
        };
        const index = subTabMap[subTab];
        if (index !== undefined) {
          const subBtn = document.querySelectorAll('.sub-tab-btn')[index];
          if (subBtn) switchSubTab(subTab, subBtn);
        }
        // „Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„ÉàÔºàÈÅÖÂª∂ÂæåÔºâ
        setTimeout(() => {
          isHandlingHashChange = false;
          log('‚úÖ handleHashChangeÂÆå‰∫Ü');
        }, 150);
      }, 100);
    } else {
      // „Çµ„Éñ„Çø„Éñ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Åô„Åê„Å´„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
      setTimeout(() => {
        isHandlingHashChange = false;
        log('‚úÖ handleHashChangeÂÆå‰∫Ü');
      }, 150);
    }
  } else {
    // ‰∏çÊòé„Å™„Çø„Éñ„ÅÆÂ†¥Âêà„ÅØ„Åô„Åê„Å´„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
    isHandlingHashChange = false;
  }
}

// „Éè„ÉÉ„Ç∑„É•Â§âÊõ¥ÊôÇ„ÅÆ„É™„Çπ„Éä„Éº
window.addEventListener('hashchange', handleHashChange);

// ============================================
// ArchiDeck v3.0 Êñ∞Ê©üËÉΩ
// ============================================

// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ËøΩÂä†
let projectTasks = [];
let projectMinutes = [];
let kintoneSettings = null;
let currentTaskSort = 'due';

// „Éá„Ç∂„Ç§„Éä„Éº„Ç´„ÉÜ„Ç¥„É™Âà•ÂèñÂæó„Éò„É´„Éë„ÉºÈñ¢Êï∞
function getDesignersByCategory(category) {
  return designers.filter(d => d.category === category).sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
}
function getSekkeiDesigners() {
  return getDesignersByCategory('Ë®≠Ë®à');
}
function getIcDesigners() {
  return getDesignersByCategory('IC');
}
function getExteriorDesigners() {
  return getDesignersByCategory('Â§ñÊßã');
}
function getRealestateDesigners() {
  return getDesignersByCategory('‰∏çÂãïÁî£');
}
function getConstructionDesigners() {
  return getDesignersByCategory('Â∑•‰∫ã');
}
function getSalesDesigners() {
  return getDesignersByCategory('Âñ∂Ê•≠');
}

// „Çµ„Ç§„Éâ„Éê„Éº„Å´ÈÉ®ÁΩ≤Âà•Êäò„Çä„Åü„Åü„ÅøÊ©üËÉΩ„ÇíËøΩÂä†ÔºàÂÖ®ËÅ∑Á®ÆÂØæÂøúÔºâ
const originalRenderSidebar = renderSidebar;

// „Çµ„Ç§„Éâ„Éê„ÉºÊäò„Çä„Åü„Åü„ÅøÁä∂ÊÖãÁÆ°ÁêÜ
function getSidebarCollapseState() {
  const saved = localStorage.getItem('archideck_sidebar_collapse');
  return saved ? JSON.parse(saved) : {};
}

function setSidebarCollapseState(category, collapsed) {
  const state = getSidebarCollapseState();
  state[category] = collapsed;
  localStorage.setItem('archideck_sidebar_collapse', JSON.stringify(state));
}

function toggleSidebarSection(category) {
  const state = getSidebarCollapseState();
  const newState = !state[category];
  setSidebarCollapseState(category, newState);
  renderSidebar();
}

// ÂàùÊúüË°®Á§∫„Åß„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÅÆËÅ∑Á®Æ„ÇíÈñã„Åè
function getInitialExpandedCategories() {
  const state = getSidebarCollapseState();
  // Êó¢„Å´localStorage„Å´Áä∂ÊÖã„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
  if (Object.keys(state).length > 0) return state;

  // ÂàùÂõû: „É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÅÆËÅ∑Á®Æ„ÇíÈñã„Åè
  const defaultState = { 'Ë®≠Ë®à': true, 'IC': true, 'Â§ñÊßã': true, '‰∏çÂãïÁî£': true, 'Â∑•‰∫ã': true, 'Âñ∂Ê•≠': true };
  if (currentUserCategory && currentUserCategory !== 'admin') {
    // Ëá™ÂàÜ„ÅÆËÅ∑Á®Æ‰ª•Â§ñ„ÅØÈñâ„Åò„Çã
    Object.keys(defaultState).forEach(cat => {
      defaultState[cat] = (cat !== currentUserCategory);
    });
  } else {
    // ÁÆ°ÁêÜËÄÖ„ÅØÂÖ®„Å¶Èñã„Åè
    Object.keys(defaultState).forEach(cat => defaultState[cat] = false);
  }
  return defaultState;
}

renderSidebar = function() {
  const container = document.getElementById('sidebarContent');
  if (!container) return;

  const sekkeiDesigners = getSekkeiDesigners();
  const icDesigners = getIcDesigners();
  const exteriorDesigners = getExteriorDesigners();
  const realestateDesigners = getRealestateDesigners();
  const constructionDesigners = getConstructionDesigners();
  const salesDesigners = getSalesDesigners();
  const allCount = projects.filter(p => p.status !== 'completed' && !p.is_archived).length;
  const archivedCount = projects.filter(p => p.is_archived).length;

  const collapseState = getSidebarCollapseState();
  const initialState = getInitialExpandedCategories();

  // Êäò„Çä„Åü„Åü„ÅøÁä∂ÊÖã„ÇíÊ±∫ÂÆöÔºàlocalStorage„Å´ÁÑ°„Åë„Çå„Å∞ÂàùÊúüÁä∂ÊÖã„Çí‰ΩøÁî®Ôºâ
  const isCollapsed = (cat) => {
    if (collapseState[cat] !== undefined) return collapseState[cat];
    return initialState[cat] || false;
  };

  let html = `
    <div class="sidebar-section">
      <div class="sidebar-item ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="selectDesigner('ALL')">
        <span class="sidebar-item-label">ÂÖ®Ê°à‰ª∂</span>
        <span class="sidebar-item-count">${allCount}</span>
      </div>
      <div class="sidebar-item ${currentDesignerTab === 'ARCHIVED' ? 'active' : ''}" onclick="selectDesigner('ARCHIVED')" style="background: ${currentDesignerTab === 'ARCHIVED' ? 'var(--success-bg)' : 'transparent'};">
        <span class="sidebar-item-label" style="color: var(--success-color);">‚úì ÂÆå‰∫ÜÊ∏à</span>
        <span class="sidebar-item-count" style="background: var(--success-color); color: white;">${archivedCount}</span>
      </div>
    </div>
  `;

  // „Çª„ÇØ„Ç∑„Éß„É≥ÁîüÊàê„Éò„É´„Éë„ÉºÔºàÊ°à‰ª∂Êï∞„Å®„Çø„Çπ„ÇØÊï∞„ÇíË°®Á§∫Ôºâ
  function renderSection(category, icon, designersList, getProjectCount, getTaskCount) {
    if (designersList.length === 0) return '';

    const collapsed = isCollapsed(category);

    // „Çª„ÇØ„Ç∑„Éß„É≥ÂÖ®‰Ωì„ÅÆ„Çø„Çπ„ÇØÊï∞„ÇíË®àÁÆó
    let totalTasks = 0;
    let completedTasks = 0;
    designersList.forEach(designer => {
      const taskInfo = getTaskCount ? getTaskCount(designer) : { total: 0, completed: 0 };
      totalTasks += taskInfo.total;
      completedTasks += taskInfo.completed;
    });
    const sectionTaskBadge = totalTasks > 0 ? `<span style="font-size:11px;color:${totalTasks - completedTasks > 0 ? 'var(--warning-color)' : 'var(--success-color)'};margin-left:6px;">${totalTasks - completedTasks}/${totalTasks}</span>` : '';

    let sectionHtml = `<div class="sidebar-section sidebar-collapsible ${collapsed ? 'collapsed' : ''}">
      <div class="sidebar-section-title" onclick="toggleSidebarSection('${category}')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <span>${icon} ${category}ÊãÖÂΩì${sectionTaskBadge}</span>
        <span class="sidebar-collapse-icon" style="font-size: 10px; transition: transform 0.2s;">${collapsed ? '‚ñ∂' : '‚ñº'}</span>
      </div>
      <div class="sidebar-section-items" style="${collapsed ? 'display: none;' : ''}">`;

    designersList.forEach(designer => {
      const count = getProjectCount(designer);
      const taskInfo = getTaskCount ? getTaskCount(designer) : { total: 0, completed: 0 };
      const incompleteTasks = taskInfo.total - taskInfo.completed;

      // Ëâ≤ÂàÜ„Åë„É≠„Ç∏„ÉÉ„ÇØ
      let countClass = 'count-blue';
      let nameClass = '';
      if (count >= 7) {
        nameClass = 'name-red';
        countClass = 'count-yellow';
      } else if (count >= 5) {
        countClass = 'count-yellow';
      }

      // „Çø„Çπ„ÇØÊï∞„Éê„ÉÉ„Ç∏
      const taskBadge = taskInfo.total > 0 ? `<span style="font-size:10px;padding:2px 4px;border-radius:4px;background:${incompleteTasks > 0 ? 'var(--warning-bg)' : 'var(--success-bg)'};color:${incompleteTasks > 0 ? 'var(--warning-color)' : 'var(--success-color)'};">${incompleteTasks}/${taskInfo.total}</span>` : '';

      sectionHtml += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label ${nameClass}">${designer.name}</span>
          ${taskBadge}
          <button class="sidebar-task-btn" onclick="event.stopPropagation(); openStaffTasksModal('${designer.name}')" title="„Çø„Çπ„ÇØ‰∏ÄË¶ß">üìã</button>
          <span class="sidebar-item-count ${countClass}">${count}</span>
        </div>
      `;
    });

    sectionHtml += '</div></div>';
    return sectionHtml;
  }

  // „Çø„Çπ„ÇØÊï∞Ë®àÁÆó„Éò„É´„Éë„ÉºÔºàÊãÖÂΩìËÄÖ„ÅÆÂÖ®Ê°à‰ª∂„ÅÆ„Çø„Çπ„ÇØÂÆå‰∫ÜÁä∂Ê≥ÅÔºâ
  function calculateTaskCount(designerName, category) {
    let total = 0;
    let completed = 0;

    projects.filter(p => !p.is_archived && p.status !== 'completed').forEach(p => {
      let isAssigned = false;
      let taskList = [];

      if (category === 'Ë®≠Ë®à' && (p.assigned_to || '').trim() === designerName) {
        isAssigned = true;
        taskList = tasksV2.filter(t => t.category === 'Ë®≠Ë®à');
      } else if (category === 'IC' && (p.ic_assignee || '').trim() === designerName) {
        isAssigned = true;
        taskList = tasksV2.filter(t => t.category === 'IC');
      } else if (category === 'Â§ñÊßã' && (p.exterior_assignee || '').trim() === designerName) {
        isAssigned = true;
        taskList = getTasksForCategory('Â§ñÊßã');
      } else if (category === '‰∏çÂãïÁî£' && (p.realestate_assignee || '').trim() === designerName) {
        isAssigned = true;
        taskList = getTasksForCategory('‰∏çÂãïÁî£');
      } else if (category === 'Â∑•‰∫ã' && (p.construction_assignee || '').trim() === designerName) {
        isAssigned = true;
        taskList = getTasksForCategory('Â∑•‰∫ã');
      }

      if (isAssigned && taskList.length > 0) {
        const progressData = p.progress || {};
        taskList.forEach(taskDef => {
          total++;
          const task = progressData[taskDef.task_key] || {};
          const stateOptions = getTaskStateOptions(taskDef.task_key);
          const lastOption = stateOptions && stateOptions.length > 0 ? stateOptions[stateOptions.length - 1] : null;
          if (task.state === lastOption) {
            completed++;
          }
        });
      }
    });

    return { total, completed };
  }

  // Ë®≠Ë®àÊãÖÂΩì„Çª„ÇØ„Ç∑„Éß„É≥
  html += renderSection('Ë®≠Ë®à', 'üìê', sekkeiDesigners, (designer) => {
    return projects.filter(p => {
      const assigned = (p.assigned_to || '').trim();
      return assigned === designer.name.trim() && p.status !== 'completed' && !p.is_archived;
    }).length;
  }, (designer) => calculateTaskCount(designer.name.trim(), 'Ë®≠Ë®à'));

  // ICÊãÖÂΩì„Çª„ÇØ„Ç∑„Éß„É≥
  html += renderSection('IC', 'üé®', icDesigners, (designer) => {
    return projects.filter(p => {
      const icAssigned = (p.ic_assignee || '').trim();
      return icAssigned === designer.name.trim() && p.status !== 'completed' && !p.is_archived;
    }).length;
  }, (designer) => calculateTaskCount(designer.name.trim(), 'IC'));

  // Â§ñÊßãÊãÖÂΩì„Çª„ÇØ„Ç∑„Éß„É≥
  html += renderSection('Â§ñÊßã', 'üå≥', exteriorDesigners, (designer) => {
    return projects.filter(p => {
      const exteriorAssigned = (p.exterior_assignee || '').trim();
      return exteriorAssigned === designer.name.trim() && p.status !== 'completed' && !p.is_archived;
    }).length;
  }, (designer) => calculateTaskCount(designer.name.trim(), 'Â§ñÊßã'));

  // ‰∏çÂãïÁî£ÊãÖÂΩì„Çª„ÇØ„Ç∑„Éß„É≥
  html += renderSection('‰∏çÂãïÁî£', 'üè†', realestateDesigners, (designer) => {
    return projects.filter(p => {
      const realestateAssigned = (p.realestate_assignee || '').trim();
      return realestateAssigned === designer.name.trim() && p.status !== 'completed' && !p.is_archived;
    }).length;
  }, (designer) => calculateTaskCount(designer.name.trim(), '‰∏çÂãïÁî£'));

  // Â∑•‰∫ãÊãÖÂΩì„Çª„ÇØ„Ç∑„Éß„É≥
  html += renderSection('Â∑•‰∫ã', 'üî®', constructionDesigners, (designer) => {
    return projects.filter(p => {
      const constructionAssigned = (p.construction_assignee || '').trim();
      return constructionAssigned === designer.name.trim() && p.status !== 'completed' && !p.is_archived;
    }).length;
  }, (designer) => calculateTaskCount(designer.name.trim(), 'Â∑•‰∫ã'));

  // Âñ∂Ê•≠ÊãÖÂΩì„Çª„ÇØ„Ç∑„Éß„É≥
  html += renderSection('Âñ∂Ê•≠', 'üíº', salesDesigners, (designer) => {
    return projects.filter(p => {
      const salesAssigned = (p.sales_assignee || '').trim();
      return salesAssigned === designer.name.trim() && p.status !== 'completed' && !p.is_archived;
    }).length;
  }, null); // Âñ∂Ê•≠„Å´„ÅØ„Çø„Çπ„ÇØ‰∏ÄË¶ß„Å™„Åó

  container.innerHTML = html;
};

// ÊãÖÂΩìËÄÖ„Çø„Çπ„ÇØ‰∏ÄË¶ß„É¢„Éº„ÉÄ„É´
let currentStaffForTasks = null;

function openStaffTasksModal(staffName) {
  currentStaffForTasks = staffName;
  document.getElementById('staffTasksModalTitle').textContent = `${staffName} „ÅÆ„Çø„Çπ„ÇØ‰∏ÄË¶ß`;
  renderStaffTasksList();
  ModalManager.open(document.getElementById('staffTasksModal'));
}

function closeStaffTasksModal() {
  ModalManager.close(document.getElementById('staffTasksModal'));
  currentStaffForTasks = null;
}

function sortTasksBy(sortType) {
  currentTaskSort = sortType;
  document.getElementById('sortByDueBtn').classList.toggle('btn-primary', sortType === 'due');
  document.getElementById('sortByDueBtn').classList.toggle('btn-ghost', sortType !== 'due');
  document.getElementById('sortByProjectBtn').classList.toggle('btn-primary', sortType === 'project');
  document.getElementById('sortByProjectBtn').classList.toggle('btn-ghost', sortType !== 'project');
  renderStaffTasksList();
}

async function renderStaffTasksList() {
  const container = document.getElementById('staffTasksList');
  if (!container || !currentStaffForTasks) return;

  // ÊãÖÂΩìËÄÖ„ÅÆÊ°à‰ª∂„ÇíÂèñÂæó
  const staffProjects = projects.filter(p => {
    const assigned = (p.assigned_to || '').trim();
    const icAssigned = (p.ic_assignee || '').trim();
    const exteriorAssigned = (p.exterior_assignee || '').trim();
    return (assigned === currentStaffForTasks || icAssigned === currentStaffForTasks || exteriorAssigned === currentStaffForTasks) &&
           p.status !== 'completed' && !p.is_archived;
  });

  // project_tasks„Åã„Çâ„Çø„Çπ„ÇØ„ÇíÂèñÂæó
  const { data: tasks } = await supabase
    .from('project_tasks')
    .select('*')
    .in('project_id', staffProjects.map(p => p.id))
    .eq('is_completed', false)
    .order('due_date');

  if (!tasks || tasks.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>Êú™ÂÆå‰∫Ü„ÅÆ„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>';
    return;
  }

  // „ÇΩ„Éº„Éà
  let sortedTasks = [...tasks];
  if (currentTaskSort === 'due') {
    sortedTasks.sort((a, b) => {
      if (!a.due_date) return 1;
      if (!b.due_date) return -1;
      return new Date(a.due_date) - new Date(b.due_date);
    });
  } else {
    sortedTasks.sort((a, b) => {
      const projectA = staffProjects.find(p => p.id === a.project_id);
      const projectB = staffProjects.find(p => p.id === b.project_id);
      return (projectA?.customer || '').localeCompare(projectB?.customer || '');
    });
  }

  // Ë°®Á§∫
  let html = '';
  const today = new Date().toISOString().split('T')[0];

  if (currentTaskSort === 'project') {
    // ÈÇ∏Âêç„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
    const grouped = {};
    sortedTasks.forEach(task => {
      const project = staffProjects.find(p => p.id === task.project_id);
      const key = project?.customer || '‰∏çÊòé';
      if (!grouped[key]) grouped[key] = [];
      grouped[key].push(task);
    });

    for (const [customer, customerTasks] of Object.entries(grouped)) {
      html += `<div class="task-list-group"><div class="task-list-group-title">${escapeHtml(customer)}</div>`;
      customerTasks.forEach(task => {
        const isOverdue = task.due_date && task.due_date < today;
        html += `
          <div class="project-task-item">
            <input type="checkbox" class="project-task-checkbox" onchange="toggleProjectTask('${task.id}', '${task.project_id}', this.checked)">
            <span class="project-task-name">${escapeHtml(task.task_name)}</span>
            ${task.due_date ? `<span class="project-task-due ${isOverdue ? 'overdue' : ''}">${escapeHtml(task.due_date)}</span>` : ''}
          </div>
        `;
      });
      html += '</div>';
    }
  } else {
    // ÊúüÈôêÈ†Ü
    sortedTasks.forEach(task => {
      const project = staffProjects.find(p => p.id === task.project_id);
      const isOverdue = task.due_date && task.due_date < today;
      html += `
        <div class="project-task-item">
          <input type="checkbox" class="project-task-checkbox" onchange="toggleProjectTask('${task.id}', '${task.project_id}', this.checked)">
          <span class="project-task-name">${escapeHtml(task.task_name)}</span>
          <span style="font-size: 12px; color: var(--text-muted);">${escapeHtml(project?.customer || '')}</span>
          ${task.due_date ? `<span class="project-task-due ${isOverdue ? 'overdue' : ''}">${escapeHtml(task.due_date)}</span>` : ''}
        </div>
      `;
    });
  }

  container.innerHTML = html;
}

// Ê°à‰ª∂„Çø„Çπ„ÇØ‰∏ÄË¶ßË™≠„ÅøËæº„Åø
async function loadProjectTasksList(projectId) {
  const container = document.getElementById(`projectTasksList_${projectId}`);
  if (!container) return;

  try {
    const { data: tasks, error } = await supabase
      .from('project_tasks')
      .select('*')
      .eq('project_id', projectId)
      .order('due_date', { ascending: true, nullsFirst: false });

    if (error) {
      logError('Load tasks error:', error);
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">„Çø„Çπ„ÇØ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
      updateTaskBadge(projectId, 0);
      return;
    }

    // Êú™Ëß£Ê±∫„Çø„Çπ„ÇØÊï∞„ÇíË®àÁÆó„Åó„Å¶„Éê„ÉÉ„Ç∏Êõ¥Êñ∞
    const unresolvedCount = tasks ? tasks.filter(t => !t.is_completed).length : 0;
    updateTaskBadge(projectId, unresolvedCount);

    if (!tasks || tasks.length === 0) {
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      return;
    }

    container.innerHTML = tasks.map(t => `
      <div class="task-item" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: ${t.is_completed ? 'var(--success-light)' : 'var(--bg-secondary)'}; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${t.is_completed ? 'var(--success-color)' : 'var(--primary-color)'};">
        <input type="checkbox" ${t.is_completed ? 'checked' : ''} onchange="toggleProjectTask('${t.id}', '${projectId}', this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
        <div style="flex: 1; min-width: 0;">
          <div style="font-size: 13px; font-weight: 500; ${t.is_completed ? 'text-decoration: line-through; color: var(--text-muted);' : ''}">${escapeHtml(t.task_name)}</div>
          ${t.due_date ? `<div style="font-size: 11px; color: ${isOverdue(t.due_date) && !t.is_completed ? 'var(--danger-color)' : 'var(--text-muted)'}; margin-top: 2px;">ÊúüÈôê: ${formatDate(t.due_date)}</div>` : ''}
        </div>
        <button class="btn btn-small btn-ghost" onclick="deleteProjectTask('${t.id}', '${projectId}')" style="flex-shrink: 0; padding: 4px 8px; font-size: 12px; color: var(--danger-color);">ÂâäÈô§</button>
      </div>
    `).join('');
  } catch (error) {
    logError('Load tasks error:', error);
    container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">„Çø„Çπ„ÇØ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
    updateTaskBadge(projectId, 0);
  }
}

// „Çø„Çπ„ÇØ„Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
function updateTaskBadge(projectId, count) {
  const badge = document.getElementById(`taskBadge_${projectId}`);
  if (badge) {
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = 'inline-flex';
    } else {
      badge.style.display = 'none';
    }
  }
}

// „Éê„ÉÉ„Ç∏„ÅÆ„ÅøÊõ¥Êñ∞Ôºà„Ç´„Éº„ÉâÁî®Ôºâ
async function loadBadgeCounts(projectId) {
  try {
    // „Çø„Çπ„ÇØÊï∞„ÇíÂèñÂæó
    const { data: tasks, error: taskError } = await supabase
      .from('project_tasks')
      .select('id, is_completed')
      .eq('project_id', projectId);

    if (!taskError && tasks) {
      const unresolvedCount = tasks.filter(t => !t.is_completed).length;
      updateTaskBadge(projectId, unresolvedCount);
    }

    // Ë≠∞‰∫ãÈå≤Êï∞„ÇíÂèñÂæó
    const { data: minutes, error: minError } = await supabase
      .from('project_minutes')
      .select('id')
      .eq('project_id', projectId);

    if (!minError && minutes) {
      updateMinutesBadge(projectId, minutes.length);
    }

    // ÂºïÁ∂ôÊõ∏„Éê„ÉÉ„Ç∏„ÇíÂèñÂæóÔºà„ÉÜ„Éº„Éñ„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÇÇ„ÅÇ„Çã„Åü„ÇÅ„ÄÅ„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñÔºâ
    try {
      const { data: handovers, error: handoverError } = await supabase
        .from('project_handovers')
        .select('content')
        .eq('project_id', projectId);

      // „Ç®„É©„Éº„Åå„Å™„Åè„ÄÅ„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂá¶ÁêÜ
      if (!handoverError && handovers && handovers.length > 0) {
        const handover = handovers[0];
        let hasContent = false;
        try {
          const handoverData = JSON.parse(handover.content);
          hasContent = Object.values(handoverData).some(v => v && v.trim());
        } catch (e) {
          hasContent = !!(handover.content && handover.content.trim());
        }
        updateHandoverBadge(projectId, hasContent);
      }
    } catch (handoverErr) {
      // ÂºïÁ∂ôÊõ∏„ÉÜ„Éº„Éñ„É´„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñÔºà„ÉÜ„Éº„Éñ„É´Êú™‰ΩúÊàê„ÅÆÁí∞Â¢ÉÂêë„ÅëÔºâ
    }
  } catch (e) {
    // „Ç®„É©„Éº„ÅØÈùô„Åã„Å´ÁÑ°Ë¶ñ
  }
}

// ÊúüÈôêÂàá„Çå„ÉÅ„Çß„ÉÉ„ÇØ
function isOverdue(dateStr) {
  if (!dateStr) return false;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const dueDate = new Date(dateStr);
  return dueDate < today;
}

// „Çø„Çπ„ÇØÂÆå‰∫ÜÁä∂ÊÖã„ÇíÂàá„ÇäÊõø„Åà
async function toggleProjectTask(taskId, projectId, isCompleted) {
  const { error } = await supabase
    .from('project_tasks')
    .update({ is_completed: isCompleted, updated_at: new Date().toISOString() })
    .eq('id', taskId);

  if (error) {
    showToast('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return;
  }

  // Ê°à‰ª∂„Ç´„Éº„ÉâÂÜÖ„ÅÆ„Çø„Çπ„ÇØ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
  await loadProjectTasksList(projectId);
  // „Éê„ÉÉ„Ç∏„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
  await loadBadgeCounts(projectId);
  // „Çπ„Çø„ÉÉ„ÉïÂà•„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÇÇÊõ¥Êñ∞
  renderStaffTasksList();
}

// „Çø„Çπ„ÇØÂâäÈô§
async function deleteProjectTask(taskId, projectId) {
  if (!confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  const { error } = await supabase
    .from('project_tasks')
    .delete()
    .eq('id', taskId);

  if (error) {
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return;
  }

  showToast('„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
  await loadProjectTasksList(projectId);
  // „Éê„ÉÉ„Ç∏„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
  await loadBadgeCounts(projectId);
}

// Ê°à‰ª∂„Å´„Çø„Çπ„ÇØ„ÇíËøΩÂä†
async function addProjectTask(projectId, taskName, dueDate) {
  if (!taskName.trim()) {
    showToast('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  const project = projects.find(p => p.id === projectId);

  try {
    const { data, error } = await supabase
      .from('project_tasks')
      .insert({
        project_id: projectId,
        task_name: taskName.trim(),
        due_date: dueDate || null,
        assigned_to: project?.assigned_to || '',
        is_completed: false
      })
      .select();

    if (error) {
      logError('„Çø„Çπ„ÇØËøΩÂä†„Ç®„É©„Éº:', error);
      if (error.code === '42501') {
        showToast('„Çø„Çπ„ÇØËøΩÂä†„ÅÆÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´ÈÄ£Áµ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      } else if (error.code === '42P01') {
        showToast('„Çø„Çπ„ÇØ„ÉÜ„Éº„Éñ„É´„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì„ÄÇ„Éá„Éº„Çø„Éô„Éº„Çπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      } else {
        showToast(`„Çø„Çπ„ÇØËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`, 'error');
      }
      return;
    }

    // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
    document.getElementById(`newTaskName_${projectId}`).value = '';
    document.getElementById(`newTaskDue_${projectId}`).value = '';

    showToast('„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
    await loadProjectTasksList(projectId);
    // „Éê„ÉÉ„Ç∏„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
    await loadBadgeCounts(projectId);
  } catch (err) {
    logError('„Çø„Çπ„ÇØËøΩÂä†‰æãÂ§ñ:', err);
    showToast('„Çø„Çπ„ÇØËøΩÂä†‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
  }
}

// ‰∏ªË¶Å„Çø„Çπ„ÇØ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂãïÁöÑ„Å´ÂèñÂæóÔºà„É¨„Éù„Éº„ÉàÁî®Ôºâ
// category: 'Ë®≠Ë®à' or 'IC' - Ë°®Á§∫„Åô„Çã„Ç´„ÉÜ„Ç¥„É™
function getMainTaskStatuses(progressData, category = 'Ë®≠Ë®à') {
  const statuses = [];

  // „Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆ‰∏ªË¶Å„Ç≠„Éº„ÉØ„Éº„Éâ
  const mainKeywords = category === 'IC'
    ? ['„Ç≠„ÉÉ„ÉÅ„É≥', '„ÅäÈ¢®ÂëÇ', 'Ê¥óÈù¢', '„Éà„Ç§„É¨', 'ÁÖßÊòé', '‰ªïÊßòÊõ∏', 'ÂÆüÊñΩÂõ≥', 'Á¢∫ÂÆöÂõ≥']
    : ['Â§™ÈôΩÂÖâ', 'Áµ¶ÊéíÊ∞¥', 'ÊèõÊ∞ó', '„Çµ„ÉÉ„Ç∑', 'ÊßãÈÄ†', '„Ç®„Éú„É´„ÉÑ', 'evoltz'];

  tasksV2.filter(t => t.category === category).forEach(task => {
    if (task.task_name && task.has_state) {
      const isMain = mainKeywords.some(k => task.task_name.includes(k));
      if (isMain && progressData[task.task_key]?.state) {
        // „Çø„Çπ„ÇØÂêç„ÇíÁü≠Á∏Æ
        let shortName = task.task_name
          .replace(/‰æùÈ†º$/, '')
          .replace(/‰ΩúÊàê$/, '')
          .replace(/„Éó„É©„É≥$/, '');
        statuses.push(`${shortName}:${progressData[task.task_key].state}`);
      }
    }
  });

  return statuses;
}

// Áî≥Ë´ãGOÊù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØÔºàÂãïÁöÑ„Å´„Çø„Çπ„ÇØ„ÇíÊ§úÁ¥¢Ôºâ
function getApplicationGoRequiredTasks() {
  // „Çø„Çπ„ÇØÂêç„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÂøÖË¶Å„Å™„Çø„Çπ„ÇØ„ÇíÊ§úÁ¥¢
  const keywords = ['Â§™ÈôΩÂÖâ', 'Áµ¶ÊéíÊ∞¥', 'ÊèõÊ∞ó', '„Çµ„ÉÉ„Ç∑'];
  const requiredTasks = [];

  keywords.forEach(keyword => {
    const task = tasksV2.find(t => t.task_name && t.task_name.includes(keyword) && t.has_state);
    if (task) {
      // state_options„Çí„Éë„Éº„ÇπÔºàÊñáÂ≠óÂàó„ÅÆÂ†¥ÂêàÔºâ
      let options = task.state_options;
      if (typeof options === 'string') {
        try {
          options = JSON.parse(options);
        } catch (e) {
          options = [];
        }
      }
      // ÊúÄÁµÇÁä∂ÊÖãÔºàstate_options„ÅÆÊúÄÂæå„ÅÆÂÄ§Ôºâ„ÇíÂèñÂæó
      const finalState = Array.isArray(options) && options.length > 0
        ? options[options.length - 1]
        : '‰øùÂ≠òÊ∏à';
      requiredTasks.push({
        task_key: task.task_key,
        task_name: task.task_name,
        finalState: finalState
      });
    }
  });

  return requiredTasks;
}

function canPressApplicationGo(project) {
  const progressData = project.progress || {};
  const requiredTasks = getApplicationGoRequiredTasks();

  // ÂøÖË¶Å„Å™„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÊóß„É≠„Ç∏„ÉÉ„ÇØ„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
  if (requiredTasks.length === 0) {
    log('‚ö†Ô∏è Áî≥Ë´ãGO: tasksV2„Åã„Çâ„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÊóß„É≠„Ç∏„ÉÉ„ÇØ„Çí‰ΩøÁî®');
    const solarOk = progressData['solar']?.state === '‰øùÂ≠òÊ∏à';
    const plumbingOk = progressData['plumbing']?.state === '‰øùÂ≠òÊ∏à';
    const ventilationOk = progressData['ventilation']?.state === '‰øùÂ≠òÊ∏à';
    const sashOk = progressData['sash']?.state === '‰øùÂ≠òÊ∏à';
    return solarOk && plumbingOk && ventilationOk && sashOk;
  }

  // ÂÖ®„Å¶„ÅÆÂøÖË¶Å„Çø„Çπ„ÇØ„ÅåÊúÄÁµÇÁä∂ÊÖã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  const results = requiredTasks.map(req => {
    const currentState = progressData[req.task_key]?.state || '-';
    const ok = currentState === req.finalState;
    log(`üìã Áî≥Ë´ãGOÊù°‰ª∂: ${req.task_name} (${req.task_key}) = "${currentState}" / ÂøÖË¶Å: "${req.finalState}" ‚Üí ${ok ? '‚úì' : '‚úó'}`);
    return ok;
  });

  const allOk = results.every(r => r);
  log(`üìã Áî≥Ë´ãGOÂà§ÂÆö: ${allOk ? 'Êù°‰ª∂OK' : 'Êù°‰ª∂Êú™ÈÅî'}`);
  return allOk;
}

// Áî≥Ë´ãGOÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´
let applicationGoProjectId = null;

function confirmApplicationGo(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  applicationGoProjectId = projectId;
  const progressData = project.progress || {};
  const requiredTasks = getApplicationGoRequiredTasks();

  // Êù°‰ª∂Ë°®Á§∫ÔºàÂãïÁöÑ„Å´ÁîüÊàêÔºâ
  let conditions;
  if (requiredTasks.length > 0) {
    conditions = requiredTasks.map(req => ({
      label: req.task_name,
      ok: progressData[req.task_key]?.state === req.finalState,
      value: progressData[req.task_key]?.state || '-',
      required: req.finalState
    }));
  } else {
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
    conditions = [
      { label: 'Â§™ÈôΩÂÖâ‰æùÈ†º', ok: progressData['solar']?.state === '‰øùÂ≠òÊ∏à', value: progressData['solar']?.state || '-', required: '‰øùÂ≠òÊ∏à' },
      { label: 'Áµ¶ÊéíÊ∞¥Âõ≥‰æùÈ†º', ok: progressData['plumbing']?.state === '‰øùÂ≠òÊ∏à', value: progressData['plumbing']?.state || '-', required: '‰øùÂ≠òÊ∏à' },
      { label: 'ÊèõÊ∞óÂõ≥‰æùÈ†º', ok: progressData['ventilation']?.state === '‰øùÂ≠òÊ∏à', value: progressData['ventilation']?.state || '-', required: '‰øùÂ≠òÊ∏à' },
      { label: '„Çµ„ÉÉ„Ç∑‰æùÈ†º', ok: progressData['sash']?.state === '‰øùÂ≠òÊ∏à', value: progressData['sash']?.state || '-', required: '‰øùÂ≠òÊ∏à' }
    ];
  }

  document.getElementById('applicationGoProjectName').textContent = project.customer;
  document.getElementById('applicationGoConditions').innerHTML = conditions.map(c =>
    `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
      <span style="color: ${c.ok ? '#10b981' : '#ef4444'};">${c.ok ? '‚úì' : '‚úó'}</span>
      <span>${c.label}:</span>
      <span style="font-weight: 500; color: ${c.ok ? '#10b981' : 'var(--text-secondary)'};">${c.value}</span>
    </div>`
  ).join('');

  ModalManager.open(document.getElementById('applicationGoModal'));
}

function closeApplicationGoModal() {
  ModalManager.close(document.getElementById('applicationGoModal'));
  applicationGoProjectId = null;
}

async function executeApplicationGo() {
  // ‰∫åÈáç„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢
  if (SaveGuard.isLocked('executeApplicationGo')) return;
  if (!applicationGoProjectId) return;

  const project = projects.find(p => p.id === applicationGoProjectId);
  if (!project) return;

  // Êù°‰ª∂„ÇíÂÜç„ÉÅ„Çß„ÉÉ„ÇØÔºà„É¢„Éº„ÉÄ„É´Ë°®Á§∫Âæå„Å´Êù°‰ª∂„ÅåÂ§â„Çè„Å£„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅÔºâ
  if (!canPressApplicationGo(project)) {
    showToast('Êù°‰ª∂„ÅåÊ∫Ä„Åü„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Çø„Çπ„ÇØ„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
    closeApplicationGoModal();
    return;
  }

  await SaveGuard.run('executeApplicationGo', async () => {
    // Áî≥Ë´ã„Çø„Çπ„ÇØ„ÇíÂÆå‰∫Ü„Å®„Åó„Å¶„Éû„Éº„ÇØ
    const progressData = project.progress || {};
    if (!progressData['application']) progressData['application'] = {};
    progressData['application'].completed = true;
    progressData['application'].date = new Date().toISOString().split('T')[0];

    showStatus('‰øùÂ≠ò‰∏≠...', 'saving');
    const { error } = await supabase
      .from('projects')
      .update({
        is_archived: true,
        progress: progressData,
        updated_at: new Date().toISOString()
      })
      .eq('id', applicationGoProjectId);

    if (error) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('ÂÆå‰∫ÜÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    project.is_archived = true;
    project.progress = progressData;
    project.updated_at = new Date().toISOString();

    closeApplicationGoModal();
    renderProjects();
    updateSidebar();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(`${project.customer} „ÇíÂÆå‰∫ÜÊ∏à„Åø„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü`, 'success');
  });
}

// „Ç´„Éº„Éâ„É¢„Éº„ÉÄ„É´Ê©üËÉΩ
function openCardModal(projectId, type) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  let title = '';
  let content = '';

  switch(type) {
    case 'tasks':
      title = `‚úÖ „Çø„Çπ„ÇØ - ${project.customer}`;
      content = `
        <div id="modalTasksList_${projectId}" class="project-task-list"></div>
        <div class="add-task-form" style="margin-top:16px;display:flex;gap:8px;">
          <input type="text" id="modalNewTaskName_${projectId}" placeholder="„Çø„Çπ„ÇØÂêç" style="flex:1;padding:10px;border:1px solid var(--border-color);border-radius:6px;">
          <input type="date" id="modalNewTaskDue_${projectId}" style="padding:10px;border:1px solid var(--border-color);border-radius:6px;">
          <button class="btn btn-primary" onclick="addProjectTaskFromModal('${projectId}')">ËøΩÂä†</button>
        </div>
      `;
      break;
    case 'memo':
      title = `üìù „É°„É¢ - ${project.customer}`;
      content = `
        <textarea class="shared-memo-area" id="modalSharedMemo_${projectId}" placeholder="„É°„É¢„ÇíÂÖ•Âäõ..." style="width:100%;min-height:200px;padding:12px;border:1px solid var(--border-color);border-radius:8px;resize:vertical;">${escapeHtml(project.shared_memo || '')}</textarea>
        <button class="btn btn-primary" style="margin-top:12px;" onclick="saveSharedMemoFromModal('${projectId}')">„É°„É¢„Çí‰øùÂ≠ò</button>
      `;
      break;
    case 'minutes':
      title = `üìÑ Ë≠∞‰∫ãÈå≤ - ${project.customer}`;
      content = `
        <div id="modalMinutesList_${projectId}" class="minutes-list" style="margin-bottom:16px;"></div>
        <div class="minutes-upload-area" style="padding:24px;border:2px dashed var(--border-color);border-radius:8px;text-align:center;cursor:pointer;" ondragover="handleMinutesDragOver(event)" ondragleave="handleMinutesDragLeave(event)" ondrop="handleDropWithDateModal(event, '${projectId}')" onclick="document.getElementById('modalMinutesUpload_${projectId}').click()">
          <input type="file" id="modalMinutesUpload_${projectId}" style="display:none" accept=".pdf,.doc,.docx,.xls,.xlsx" onchange="uploadMinutesWithDateModal('${projectId}', this.files[0])">
          <span style="font-size:24px;">üìÅ</span>
          <div style="margin-top:8px;">„ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">PDF, Word, ExcelÂØæÂøú</div>
        </div>
      `;
      break;
    case 'handover':
      title = `üìã ÂºïÁ∂ôÊõ∏ - ${project.customer}`;
      content = `
        <div class="handover-sections">
          <div class="handover-section">
            <label class="handover-label">üè† Ë®≠Ë®à</label>
            <textarea class="handover-textarea" id="modalHandover_design_${projectId}" placeholder="Ë®≠Ë®à„Åã„Çâ„ÅÆÂºïÁ∂ô‰∫ãÈ†Ö..." rows="3"></textarea>
          </div>
          <div class="handover-section">
            <label class="handover-label">üé® IC</label>
            <textarea class="handover-textarea" id="modalHandover_ic_${projectId}" placeholder="IC„Åã„Çâ„ÅÆÂºïÁ∂ô‰∫ãÈ†Ö..." rows="3"></textarea>
          </div>
          <div class="handover-section">
            <label class="handover-label">üå≥ Â§ñÊßã</label>
            <textarea class="handover-textarea" id="modalHandover_exterior_${projectId}" placeholder="Â§ñÊßã„Åã„Çâ„ÅÆÂºïÁ∂ô‰∫ãÈ†Ö..." rows="3"></textarea>
          </div>
          <div class="handover-section">
            <label class="handover-label">üè¢ ‰∏çÂãïÁî£</label>
            <textarea class="handover-textarea" id="modalHandover_realestate_${projectId}" placeholder="‰∏çÂãïÁî£„Åã„Çâ„ÅÆÂºïÁ∂ô‰∫ãÈ†Ö..." rows="3"></textarea>
          </div>
          <div class="handover-section">
            <label class="handover-label">üîß Â∑•‰∫ã</label>
            <textarea class="handover-textarea" id="modalHandover_construction_${projectId}" placeholder="Â∑•‰∫ã„Åã„Çâ„ÅÆÂºïÁ∂ô‰∫ãÈ†Ö..." rows="3"></textarea>
          </div>
        </div>
        <button class="btn btn-primary" style="margin-top:12px;" onclick="saveHandoverFromModal('${projectId}')">ÂºïÁ∂ôÊõ∏„Çí‰øùÂ≠ò</button>
      `;
      break;
  }

  // „É¢„Éº„ÉÄ„É´HTML‰ΩúÊàê
  const modalHtml = `
    <div class="card-modal-overlay" onclick="closeCardModal(event)">
      <div class="card-modal" onclick="event.stopPropagation()">
        <div class="card-modal-header">
          <span class="card-modal-title">${title}</span>
          <button class="card-modal-close" onclick="closeCardModal()">&times;</button>
        </div>
        <div class="card-modal-body">${content}</div>
      </div>
    </div>
  `;

  // Êó¢Â≠ò„É¢„Éº„ÉÄ„É´„ÇíÂâäÈô§
  const existing = document.querySelector('.card-modal-overlay');
  if (existing) existing.remove();

  // „É¢„Éº„ÉÄ„É´„ÇíËøΩÂä†
  document.body.insertAdjacentHTML('beforeend', modalHtml);

  // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
  if (type === 'tasks') {
    loadModalTasksList(projectId);
  } else if (type === 'minutes') {
    loadModalMinutesList(projectId);
  } else if (type === 'handover') {
    loadHandoverContent(projectId);
  }
}

function closeCardModal(event) {
  if (event && event.target !== event.currentTarget) return;
  const modal = document.querySelector('.card-modal-overlay');
  if (modal) modal.remove();
}

// „É¢„Éº„ÉÄ„É´Áî®„Çø„Çπ„ÇØË™≠„ÅøËæº„Åø
async function loadModalTasksList(projectId) {
  const container = document.getElementById(`modalTasksList_${projectId}`);
  if (!container) return;

  try {
    const { data: tasks, error } = await supabase
      .from('project_tasks')
      .select('*')
      .eq('project_id', projectId)
      .order('due_date', { ascending: true, nullsFirst: false });

    if (error || !tasks || tasks.length === 0) {
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px; padding: 20px; text-align: center;">„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      return;
    }

    container.innerHTML = tasks.map(t => `
      <div class="task-item" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: ${t.is_completed ? 'var(--success-light)' : 'var(--bg-secondary)'}; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${t.is_completed ? 'var(--success-color)' : 'var(--primary-color)'};">
        <input type="checkbox" ${t.is_completed ? 'checked' : ''} onchange="toggleProjectTaskModal('${t.id}', '${projectId}', this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
        <div style="flex: 1;">
          <div style="font-size: 14px; font-weight: 500; ${t.is_completed ? 'text-decoration: line-through; color: var(--text-muted);' : ''}">${escapeHtml(t.task_name)}</div>
          ${t.due_date ? `<div style="font-size: 12px; color: ${isOverdue(t.due_date) && !t.is_completed ? 'var(--danger-color)' : 'var(--text-muted)'}; margin-top: 4px;">ÊúüÈôê: ${formatDate(t.due_date)}</div>` : ''}
        </div>
        <button class="btn btn-small btn-ghost" onclick="deleteProjectTaskModal('${t.id}', '${projectId}')" style="color: var(--danger-color);">ÂâäÈô§</button>
      </div>
    `).join('');
  } catch (error) {
    container.innerHTML = '<div style="color: var(--text-muted);">Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
  }
}

async function addProjectTaskFromModal(projectId) {
  const taskName = document.getElementById(`modalNewTaskName_${projectId}`).value.trim();
  const dueDate = document.getElementById(`modalNewTaskDue_${projectId}`).value;
  if (!taskName) { showToast('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
  await addProjectTask(projectId, taskName, dueDate);
  document.getElementById(`modalNewTaskName_${projectId}`).value = '';
  document.getElementById(`modalNewTaskDue_${projectId}`).value = '';
  loadModalTasksList(projectId);
}

async function toggleProjectTaskModal(taskId, projectId, isCompleted) {
  await toggleProjectTask(taskId, projectId, isCompleted);
  loadModalTasksList(projectId);
  await loadBadgeCounts(projectId);
}

async function deleteProjectTaskModal(taskId, projectId) {
  if (!confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
  await supabase.from('project_tasks').delete().eq('id', taskId);
  showToast('„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
  loadModalTasksList(projectId);
  loadProjectTasksList(projectId);
  await loadBadgeCounts(projectId);
}

// „É¢„Éº„ÉÄ„É´Áî®„É°„É¢‰øùÂ≠ò
async function saveSharedMemoFromModal(projectId) {
  const memo = document.getElementById(`modalSharedMemo_${projectId}`).value;
  const { error } = await supabase.from('projects').update({ shared_memo: memo, updated_at: new Date().toISOString() }).eq('id', projectId);
  if (error) { showToast('„É°„É¢‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error'); return; }
  const project = projects.find(p => p.id === projectId);
  if (project) project.shared_memo = memo;
  showToast('„É°„É¢„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
  closeCardModal();
  renderProjects();
}

// „É¢„Éº„ÉÄ„É´Áî®Ë≠∞‰∫ãÈå≤Ë™≠„ÅøËæº„Åø
async function loadModalMinutesList(projectId) {
  const container = document.getElementById(`modalMinutesList_${projectId}`);
  if (!container) return;

  try {
    const { data: minutes, error } = await supabase
      .from('project_minutes')
      .select('*')
      .eq('project_id', projectId)
      .order('created_at', { ascending: false });

    if (error || !minutes || minutes.length === 0) {
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px; padding: 16px; text-align: center;">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„ÅüË≠∞‰∫ãÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      return;
    }

    // Ë≠∞‰∫ãÈå≤„ÇíÂõûÊï∞„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñÔºàmeeting_dateÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞created_at„Çí‰ΩøÁî®Ôºâ
    const sortedByDate = [...minutes].sort((a, b) => {
      const dateA = a.meeting_date || a.created_at.split('T')[0];
      const dateB = b.meeting_date || b.created_at.split('T')[0];
      return new Date(dateA) - new Date(dateB);
    });
    const dateGroups = {};
    sortedByDate.forEach(m => {
      const dateKey = m.meeting_date || m.created_at.split('T')[0]; // meeting_dateÂÑ™ÂÖà
      if (!dateGroups[dateKey]) {
        dateGroups[dateKey] = [];
      }
      dateGroups[dateKey].push(m);
    });

    // „Ç∞„É´„Éº„Éó„Å´ÂõûÊï∞„ÇíÂâ≤„ÇäÂΩì„Å¶ÔºàÂè§„ÅÑÊó•‰ªò„Åã„Çâ1ÂõûÁõÆ„ÄÅ2ÂõûÁõÆ...Ôºâ
    const groupKeys = Object.keys(dateGroups).sort();
    const groupedHtml = groupKeys.map((dateKey, index) => {
      const meetingNumber = index + 1;
      const groupMinutes = dateGroups[dateKey];
      const formattedDate = new Date(dateKey).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
      const firstMinuteId = groupMinutes[0].id; // „Ç∞„É´„Éº„Éó„ÅÆ‰ª£Ë°®ID

      return `
        <div class="minutes-group" style="margin-bottom: 16px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
          <div style="background: var(--bg-tertiary); padding: 10px 14px; font-weight: 600; font-size: 13px; color: var(--text-primary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between;">
            <span>üìã Á¨¨${meetingNumber}ÂõûÊâìÂêà„ÅõÔºà${formattedDate}Ôºâ</span>
            <button class="btn btn-small btn-ghost" onclick="editMinuteDate('${firstMinuteId}', '${dateKey}', '${projectId}')" style="padding: 2px 8px; font-size: 11px;">‚úèÔ∏è Á∑®ÈõÜ</button>
          </div>
          <div style="padding: 8px;">
            ${groupMinutes.map(m => `
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">
                <a href="${m.file_url}" target="_blank" style="color: var(--primary-color); text-decoration: none; font-size: 13px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">üìÑ ${escapeHtml(m.file_name)}</a>
                <div style="display: flex; gap: 4px;">
                  <button class="btn btn-small btn-ghost" onclick="editSingleMinuteDate('${m.id}', '${m.meeting_date || dateKey}', '${projectId}')" style="padding: 4px 8px; font-size: 11px;" title="„Åì„ÅÆË≠∞‰∫ãÈå≤„ÅÆÊó•‰ªò„ÇíÂ§âÊõ¥">üìÖ</button>
                  <button class="btn btn-small btn-ghost" onclick="deleteMinuteModal('${m.id}', '${projectId}')" style="color: var(--danger-color); padding: 4px 8px;">ÂâäÈô§</button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }).reverse().join(''); // Êñ∞„Åó„ÅÑÂõû„Åã„ÇâË°®Á§∫

    container.innerHTML = groupedHtml;
  } catch (error) {
    container.innerHTML = '<div style="color: var(--text-muted);">Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
  }
}

// Ë≠∞‰∫ãÈå≤„Ç∞„É´„Éº„Éó„ÅÆÊó•‰ªò„ÇíÁ∑®ÈõÜÔºà„Ç∞„É´„Éº„ÉóÂÜÖÂÖ®„Å¶„ÅÆË≠∞‰∫ãÈå≤„ÇíÊõ¥Êñ∞Ôºâ
async function editMinuteDate(minuteId, currentDate, projectId) {
  const newDate = prompt('ÊâìÂêà„ÅõÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàYYYY-MM-DDÂΩ¢ÂºèÔºâ:', currentDate);
  if (!newDate || newDate === currentDate) return;

  // Êó•‰ªòÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØ
  if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
    showToast('Êó•‰ªòÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„ÇìÔºà‰æã: 2026-01-08Ôºâ', 'error');
    return;
  }

  showStatus('Êõ¥Êñ∞‰∏≠...', 'saving');

  // Âêå„ÅòÊó•‰ªò„ÅÆË≠∞‰∫ãÈå≤„ÇíÂÖ®„Å¶Êõ¥Êñ∞
  const { error } = await supabase
    .from('project_minutes')
    .update({ meeting_date: newDate })
    .eq('project_id', projectId)
    .or(`meeting_date.eq.${currentDate},meeting_date.is.null`);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('ÊâìÂêà„ÅõÊó•„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
  await loadModalMinutesList(projectId);
}

// ÂÄãÂà•„ÅÆË≠∞‰∫ãÈå≤„ÅÆÊó•‰ªò„ÇíÁ∑®ÈõÜ
async function editSingleMinuteDate(minuteId, currentDate, projectId) {
  const newDate = prompt('„Åì„ÅÆË≠∞‰∫ãÈå≤„ÅÆÊâìÂêà„ÅõÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàYYYY-MM-DDÂΩ¢ÂºèÔºâ:', currentDate);
  if (!newDate || newDate === currentDate) return;

  // Êó•‰ªòÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØ
  if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
    showToast('Êó•‰ªòÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„ÇìÔºà‰æã: 2026-01-08Ôºâ', 'error');
    return;
  }

  showStatus('Êõ¥Êñ∞‰∏≠...', 'saving');

  const { error } = await supabase
    .from('project_minutes')
    .update({ meeting_date: newDate })
    .eq('id', minuteId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('ÊâìÂêà„ÅõÊó•„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
  await loadModalMinutesList(projectId);
}

async function uploadMinutesWithDateModal(projectId, file) {
  // ÊâìÂêà„ÅõÊó•„ÅØ‰ªäÊó•„ÅÆÊó•‰ªò„ÇíËá™ÂãïË®≠ÂÆö
  await uploadMinutesWithDate(projectId, file);
  loadModalMinutesList(projectId);
}

function handleDropWithDateModal(event, projectId) {
  event.preventDefault();
  event.stopPropagation();
  const file = event.dataTransfer.files[0];
  if (file) uploadMinutesWithDateModal(projectId, file);
}

async function deleteMinuteModal(minuteId, projectId) {
  if (!confirm('„Åì„ÅÆË≠∞‰∫ãÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
  await supabase.from('project_minutes').delete().eq('id', minuteId);
  showToast('Ë≠∞‰∫ãÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
  loadModalMinutesList(projectId);
  loadMinutesList(projectId);
}

// „É¢„Éº„ÉÄ„É´Áî®ÂºïÁ∂ôÊõ∏Ë™≠„ÅøËæº„Åø
async function loadHandoverContent(projectId) {
  const departments = ['design', 'ic', 'exterior', 'realestate', 'construction'];

  try {
    const { data: handovers, error } = await supabase
      .from('project_handovers')
      .select('content')
      .eq('project_id', projectId);

    // „Ç®„É©„Éº„Åæ„Åü„ÅØ„Éá„Éº„Çø„Å™„Åó„ÅÆÂ†¥Âêà„ÅØÁµÇ‰∫Ü
    if (error || !handovers || handovers.length === 0) return;

    const data = handovers[0];
    if (data && data.content) {
      // JSONÂΩ¢Âºè„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
      let handoverData;
      try {
        handoverData = JSON.parse(data.content);
      } catch (e) {
        // ÊóßÂΩ¢ÂºèÔºà„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„ÉàÔºâ„ÅÆÂ†¥Âêà„ÅØË®≠Ë®à„Å´ÂÖ•„Çå„Çã
        handoverData = { design: data.content };
      }

      // ÂêÑÈÉ®ÁΩ≤„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´ÂÄ§„ÇíË®≠ÂÆö
      departments.forEach(dept => {
        const textarea = document.getElementById(`modalHandover_${dept}_${projectId}`);
        if (textarea && handoverData[dept]) {
          textarea.value = handoverData[dept];
        }
      });
    }
  } catch (e) {}
}

async function saveHandoverFromModal(projectId) {
  const departments = ['design', 'ic', 'exterior', 'realestate', 'construction'];

  // ÂêÑÈÉ®ÁΩ≤„ÅÆÂÜÖÂÆπ„ÇíÂèéÈõÜ
  const handoverData = {};
  departments.forEach(dept => {
    const textarea = document.getElementById(`modalHandover_${dept}_${projectId}`);
    if (textarea && textarea.value.trim()) {
      handoverData[dept] = textarea.value.trim();
    }
  });

  const content = JSON.stringify(handoverData);

  try {
    const { data: existingList } = await supabase
      .from('project_handovers')
      .select('id')
      .eq('project_id', projectId);

    const existing = existingList && existingList.length > 0 ? existingList[0] : null;

    let error;
    if (existing) {
      ({ error } = await supabase.from('project_handovers').update({ content, updated_at: new Date().toISOString() }).eq('id', existing.id));
    } else {
      ({ error } = await supabase.from('project_handovers').insert({ project_id: projectId, content }));
    }

    if (error) { showToast('ÂºïÁ∂ôÊõ∏‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error'); return; }
    showToast('ÂºïÁ∂ôÊõ∏„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
    closeCardModal();
  } catch (e) {
    showToast('ÂºïÁ∂ôÊõ∏‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
  }
}

// Êäò„Çä„Åü„Åü„ÅøÊ©üËÉΩ
function toggleCardSection(element) {
  const section = element.closest('.card-section');
  section.classList.toggle('collapsed');

  // „Çª„ÇØ„Ç∑„Éß„É≥Ë≠òÂà•Â≠ê„ÇíÂèñÂæóÔºà‰æãÔºöprojectId_sectionNameÔºâ
  const card = section.closest('.project-card');
  if (card) {
    const projectId = card.dataset.projectId;
    const sectionTitle = section.querySelector('.card-section-header h4')?.textContent;
    if (projectId && sectionTitle) {
      const key = `archideck_card_${projectId}_${sectionTitle}`;
      const isCollapsed = section.classList.contains('collapsed');
      localStorage.setItem(key, isCollapsed ? 'collapsed' : 'expanded');
    }
  }
}

// Ê•≠ÂãôÂÜÖÂÆπ„Çª„ÇØ„Ç∑„Éß„É≥Áî®„ÅÆÊéí‰ªñÁöÑ„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥Ôºà1„Å§Èñã„Åè„Å®‰ªñ„ÅåÈñâ„Åò„ÇãÔºâ
function toggleBizSection(element, projectId) {
  const clickedSection = element.closest('.card-section.biz-section');
  const card = document.querySelector(`.project-card[data-project-id="${projectId}"]`);
  if (!card || !clickedSection) return;

  // Âêå„Åò„Ç´„Éº„ÉâÂÜÖ„ÅÆÂÖ®Ê•≠ÂãôÂÜÖÂÆπ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂèñÂæó
  const allBizSections = card.querySelectorAll('.card-section.biz-section');

  // „ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Çª„ÇØ„Ç∑„Éß„É≥„ÅåÈñâ„Åò„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈñã„ÅèÔºà‰ªñ„ÅØÈñâ„Åò„ÇãÔºâ
  if (clickedSection.classList.contains('collapsed')) {
    // ÂÖ®„Å¶Èñâ„Åò„Çã
    allBizSections.forEach(sec => sec.classList.add('collapsed'));
    // „ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇÇ„ÅÆ„Å†„ÅëÈñã„Åè
    clickedSection.classList.remove('collapsed');
  } else {
    // Êó¢„Å´Èñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈñâ„Åò„Çã
    clickedSection.classList.add('collapsed');
  }
}

// „Ç´„Éº„ÉâÂ±ïÈñãÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
function restoreCardStates(projectId) {
  const card = document.querySelector(`.project-card[data-project-id="${projectId}"]`);
  if (!card) return;

  const sections = card.querySelectorAll('.card-section');
  sections.forEach(section => {
    const sectionTitle = section.querySelector('.card-section-header h4')?.textContent;
    if (sectionTitle) {
      const key = `archideck_card_${projectId}_${sectionTitle}`;
      const savedState = localStorage.getItem(key);
      if (savedState === 'collapsed') {
        section.classList.add('collapsed');
      } else if (savedState === 'expanded') {
        section.classList.remove('collapsed');
      }
    }
  });
}

// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó‰∏¶„ÅπÊõø„Åà
let draggedCard = null;
let customCardOrder = safeJsonParse(localStorage.getItem('archideck_card_order'), []);

function handleDragStart(event) {
  draggedCard = event.target.closest('.project-card');
  if (!draggedCard) return;
  draggedCard.classList.add('dragging');
  event.dataTransfer.effectAllowed = 'move';
  event.dataTransfer.setData('text/plain', draggedCard.dataset.projectId);
}

function handleDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';

  const targetCard = event.target.closest('.project-card');
  if (!targetCard || targetCard === draggedCard) return;

  const container = document.getElementById('projectsContainer');
  const cards = [...container.querySelectorAll('.project-card:not(.dragging)')];
  const targetIndex = cards.indexOf(targetCard);
  const draggedIndex = cards.indexOf(draggedCard);

  // Ë¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
  targetCard.classList.add('drag-over');
}

function handleDrop(event) {
  event.preventDefault();
  const targetCard = event.target.closest('.project-card');
  if (!targetCard || targetCard === draggedCard) return;

  const container = document.getElementById('projectsContainer');
  const rect = targetCard.getBoundingClientRect();
  const insertBefore = event.clientY < rect.top + rect.height / 2;

  if (insertBefore) {
    container.insertBefore(draggedCard, targetCard);
  } else {
    container.insertBefore(draggedCard, targetCard.nextSibling);
  }

  // „Ç´„Çπ„Çø„É†È†ÜÂ∫è„Çí‰øùÂ≠ò
  saveCardOrder();
  showToast('‰∏¶„Å≥È†Ü„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'info');
}

function handleDragEnd(event) {
  if (draggedCard) {
    draggedCard.classList.remove('dragging');
  }
  // ÂÖ®„Å¶„ÅÆdrag-over„ÇØ„É©„Çπ„ÇíÂâäÈô§
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  draggedCard = null;
}

function saveCardOrder() {
  const container = document.getElementById('projectsContainer');
  const cards = container.querySelectorAll('.project-card');
  customCardOrder = [...cards].map(card => card.dataset.projectId);
  localStorage.setItem('archideck_card_order', JSON.stringify(customCardOrder));
}

function getCustomCardOrder() {
  return safeJsonParse(localStorage.getItem('archideck_card_order'), []);
}

function clearCustomCardOrder() {
  localStorage.removeItem('archideck_card_order');
  customCardOrder = [];
  renderProjects();
  showToast('‰∏¶„Å≥È†Ü„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü', 'info');
}

// „É¢„Éê„Ç§„É´„Çµ„Ç§„Éâ„Éê„ÉºÈñãÈñâ
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
}

function closeSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
}

// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÈñ¢Êï∞ÔºàË≠∞‰∫ãÈå≤„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÁî®Ôºâ
function handleMinutesDragOver(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.add('drag-over');
}

function handleMinutesDragLeave(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');
}

function handleMinutesDrop(event, projectId) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');

  const files = event.dataTransfer.files;
  if (files.length > 0) {
    uploadMinutes(projectId, files[0]);
  }
}

// ÊâìÂêà„ÅõÊó•‰ªò„Åç„Éâ„É≠„ÉÉ„Éó
function handleDropWithDate(event, projectId) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');

  const files = event.dataTransfer.files;
  if (files.length > 0) {
    uploadMinutesWithDate(projectId, files[0]);
  }
}

// „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Éà„É™„Ç¨„Éº
function triggerMinutesUpload(projectId) {
  document.getElementById(`minutesUpload_${projectId}`).click();
}

// „Éï„Ç°„Ç§„É´Âêç„Åã„ÇâÊâìÂêà„ÅõÊó•„Çí‰∫àÊ∏¨
function predictMeetingDateFromFilename(filename) {
  // Êßò„ÄÖ„Å™Êó•‰ªò„Éë„Çø„Éº„É≥„ÇíË™çË≠ò
  const patterns = [
    // YYYYMMDDÂΩ¢Âºè: 20260108, 2026_01_08, 2026-01-08
    /(\d{4})[-_]?(\d{2})[-_]?(\d{2})/,
    // YYMMDDÂΩ¢Âºè: 260108
    /(?:^|[^\d])(\d{2})(\d{2})(\d{2})(?:[^\d]|$)/,
    // MMÊúàDDÊó•ÂΩ¢Âºè: 1Êúà8Êó•, 01Êúà08Êó•
    /(\d{1,2})Êúà(\d{1,2})Êó•/,
    // MM-DDÂΩ¢Âºè: 1-8, 01-08
    /(?:^|[^\d])(\d{1,2})[-\/](\d{1,2})(?:[^\d]|$)/,
    // R6.1.8ÂΩ¢Âºè (‰ª§Âíå)
    /R(\d{1,2})[.\-](\d{1,2})[.\-](\d{1,2})/i,
  ];

  for (const pattern of patterns) {
    const match = filename.match(pattern);
    if (match) {
      let year, month, day;

      if (pattern.source.includes('Êúà')) {
        // MMÊúàDDÊó•ÂΩ¢Âºè
        year = new Date().getFullYear();
        month = parseInt(match[1], 10);
        day = parseInt(match[2], 10);
      } else if (pattern.source.includes('R')) {
        // ‰ª§ÂíåÂΩ¢Âºè
        year = 2018 + parseInt(match[1], 10); // ‰ª§Âíå1Âπ¥=2019Âπ¥
        month = parseInt(match[2], 10);
        day = parseInt(match[3], 10);
      } else if (match[1].length === 4) {
        // YYYYMMDDÂΩ¢Âºè
        year = parseInt(match[1], 10);
        month = parseInt(match[2], 10);
        day = parseInt(match[3], 10);
      } else if (match[1].length === 2 && match[2].length === 2 && match[3].length === 2) {
        // YYMMDDÂΩ¢Âºè
        year = 2000 + parseInt(match[1], 10);
        month = parseInt(match[2], 10);
        day = parseInt(match[3], 10);
      } else {
        // MM-DDÂΩ¢Âºè
        year = new Date().getFullYear();
        month = parseInt(match[1], 10);
        day = parseInt(match[2], 10);
      }

      // Êó•‰ªò„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
      if (month >= 1 && month <= 12 && day >= 1 && day <= 31 && year >= 2020 && year <= 2030) {
        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      }
    }
  }

  // ‰∫àÊ∏¨„Åß„Åç„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅØ‰ªäÊó•„ÅÆÊó•‰ªò
  const today = new Date();
  return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
}

// ÊâìÂêà„ÅõÊó•„ÉªÊ°à‰ª∂Âêç„ÉªÊãÖÂΩìËÄÖ„ÇíÂê´„ÇÄË≠∞‰∫ãÈå≤„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
async function uploadMinutesWithDate(projectId, file) {
  if (!file) {
    showToast('„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  const project = projects.find(p => p.id === projectId);
  if (!project) {
    showToast('Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  // „Éï„Ç°„Ç§„É´Âêç„Åã„ÇâÊâìÂêà„ÅõÊó•„Çí‰∫àÊ∏¨Ôºà‰∫àÊ∏¨„Åß„Åç„Å™„Åë„Çå„Å∞‰ªäÊó•„ÅÆÊó•‰ªòÔºâ
  const meetingDate = predictMeetingDateFromFilename(file.name);

  // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà10MB‰∏äÈôêÔºâ
  const maxSize = 10 * 1024 * 1024;
  if (file.size > maxSize) {
    showToast('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅØ10MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  // ÂØæÂøú„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØ
  const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
  if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx|xls|xlsx)$/i)) {
    showToast('PDF, Word, Excel„Éï„Ç°„Ç§„É´„ÅÆ„ÅøÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åô', 'error');
    return;
  }

  // ÂÖÉ„ÅÆ„Éï„Ç°„Ç§„É´Âêç„ÇíÁ∂≠ÊåÅÔºàË°®Á§∫Áî®Ôºâ
  const originalFileName = file.name;
  const ext = file.name.split('.').pop();
  const formattedDate = meetingDate.replace(/-/g, '');

  // „Çπ„Éà„É¨„Éº„Ç∏Áî®„ÅÆ„Éï„Ç°„Ç§„É´ÂêçÔºàASCIIÊñáÂ≠ó„ÅÆ„Åø - Supabase Storage„ÅÆÂà∂ÈôêÂØæÂøúÔºâ
  const safeFileName = `${Date.now()}_${formattedDate}.${ext}`;

  showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...', 'info');

  try {
    // Supabase Storage„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºà„Éï„Ç°„Ç§„É´Âêç„ÅØASCII„ÅÆ„ÅøÔºâ
    const storagePath = `${projectId}/${safeFileName}`;
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('minutes')
      .upload(storagePath, file);

    if (uploadError) {
      logError('Storage upload error:', uploadError);
      if (uploadError.message?.includes('bucket') || uploadError.statusCode === '404') {
        showToast('„Çπ„Éà„É¨„Éº„Ç∏„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´ÈÄ£Áµ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      } else if (uploadError.message?.includes('policy')) {
        showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
      } else {
        showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (uploadError.message || 'Unknown error'), 'error');
      }
      return;
    }

    // URL„ÇíÂèñÂæó
    const { data: urlData } = supabase.storage
      .from('minutes')
      .getPublicUrl(storagePath);

    // DB„Å´ÁôªÈå≤ÔºàÂÖÉ„ÅÆ„Éï„Ç°„Ç§„É´Âêç„ÇíÁ∂≠ÊåÅ + ÊâìÂêà„ÅõÊó•„Çí‰∫àÊ∏¨Ôºâ
    const insertData = {
      project_id: projectId,
      file_name: originalFileName,
      file_url: urlData.publicUrl || '',
      file_size: file.size || 0,
      uploaded_by: currentUser?.email || 'anonymous@archideck.jp',
      meeting_date: meetingDate // „Éï„Ç°„Ç§„É´Âêç„Åã„Çâ‰∫àÊ∏¨„Åó„ÅüÊâìÂêà„ÅõÊó•
    };

    const { data: insertedData, error: dbError } = await supabase
      .from('project_minutes')
      .insert(insertData)
      .select();

    if (dbError) {
      logError('DB insert error:', dbError);
      console.error('DB insert error details:', JSON.stringify(dbError));
      // „Çπ„Éà„É¨„Éº„Ç∏„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ∏à„Åø„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§
      await supabase.storage.from('minutes').remove([storagePath]).catch(() => {});
      showToast('Ë≠∞‰∫ãÈå≤ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (dbError.message || dbError.code || 'Unknown error'), 'error');
      return;
    }

    // ÈÄöÁü•„ÇíÈÄÅ‰ø°
    const notifyEmails = [];
    if (project.assigned_to) {
      const designer = designers.find(d => d.name === project.assigned_to);
      if (designer?.email) notifyEmails.push(designer.email);
    }
    if (project.ic_assignee) {
      const icDesigner = designers.find(d => d.name === project.ic_assignee);
      if (icDesigner?.email) notifyEmails.push(icDesigner.email);
    }
    if (project.exterior_assignee) {
      const extDesigner = designers.find(d => d.name === project.exterior_assignee);
      if (extDesigner?.email) notifyEmails.push(extDesigner.email);
    }

    for (const email of notifyEmails) {
      await supabase.from('notifications').insert({
        user_email: email,
        title: 'Êñ∞„Åó„ÅÑË≠∞‰∫ãÈå≤„Åå„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü',
        message: `${project.customer}Êßò„ÅÆË≠∞‰∫ãÈå≤„Äå${autoTitle}„Äç„Åå„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü`,
        link: `#projects?id=${projectId}`
      }).catch(() => {});
    }

    showToast('Ë≠∞‰∫ãÈå≤„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
    await loadMinutesList(projectId);
  } catch (error) {
    logError('Upload error:', error);
    showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
}

// ÂÖ±Êúâ„É°„É¢‰øùÂ≠ò
async function saveSharedMemo(projectId) {
  const memo = document.getElementById(`sharedMemo_${projectId}`).value;
  const { error } = await supabase
    .from('projects')
    .update({ shared_memo: memo, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showToast('„É°„É¢‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return;
  }

  const project = projects.find(p => p.id === projectId);
  if (project) project.shared_memo = memo;
  showToast('„É°„É¢„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

// ÂºïÁ∂ôÊõ∏‰øùÂ≠ò
async function saveHandover(projectId) {
  const content = document.getElementById(`handover_${projectId}`).value;

  try {
    // Êó¢Â≠ò„ÅÆÂºïÁ∂ôÊõ∏„ÇíÁ¢∫Ë™ç
    const { data: existingList } = await supabase
      .from('project_handovers')
      .select('id')
      .eq('project_id', projectId);

    const existing = existingList && existingList.length > 0 ? existingList[0] : null;

    let error;
    if (existing) {
      ({ error } = await supabase
        .from('project_handovers')
        .update({ content, updated_at: new Date().toISOString() })
        .eq('id', existing.id));
    } else {
      ({ error } = await supabase
        .from('project_handovers')
        .insert({ project_id: projectId, content }));
    }

    if (error) {
      showToast('ÂºïÁ∂ôÊõ∏‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
      return;
    }

    showToast('ÂºïÁ∂ôÊõ∏„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
  } catch (e) {
    showToast('ÂºïÁ∂ôÊõ∏‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
  }
}

// Ë≠∞‰∫ãÈå≤„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
async function uploadMinutes(projectId, file) {
  if (!file) {
    showToast('„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà10MB‰∏äÈôêÔºâ
  const maxSize = 10 * 1024 * 1024;
  if (file.size > maxSize) {
    showToast('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅØ10MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  // ÂØæÂøú„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØ
  const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
  if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx|xls|xlsx)$/i)) {
    showToast('PDF, Word, Excel„Éï„Ç°„Ç§„É´„ÅÆ„ÅøÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åô', 'error');
    return;
  }

  showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...', 'info');

  try {
    // Supabase Storage„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºà„Éï„Ç°„Ç§„É´Âêç„ÅØASCII„ÅÆ„ÅøÔºâ
    const ext = file.name.split('.').pop();
    const safeStoragePath = `${projectId}/${Date.now()}.${ext}`;
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('minutes')
      .upload(safeStoragePath, file);

    if (uploadError) {
      logError('Storage upload error:', uploadError);
      // „Éê„Ç±„ÉÉ„Éà„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅÆ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
      if (uploadError.message?.includes('bucket') || uploadError.statusCode === '404') {
        showToast('„Çπ„Éà„É¨„Éº„Ç∏„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´ÈÄ£Áµ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      } else if (uploadError.message?.includes('policy')) {
        showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
      } else {
        showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (uploadError.message || 'Unknown error'), 'error');
      }
      return;
    }

    // URL„ÇíÂèñÂæó
    const { data: urlData } = supabase.storage
      .from('minutes')
      .getPublicUrl(safeStoragePath);

    // DB„Å´ÁôªÈå≤
    const insertData = {
      project_id: projectId,
      file_name: file.name,
      file_url: urlData.publicUrl || '',
      file_size: file.size || 0,
      uploaded_by: currentUser?.email || 'anonymous@archideck.jp'
    };

    const { data: insertedData, error: dbError } = await supabase
      .from('project_minutes')
      .insert(insertData)
      .select();

    if (dbError) {
      logError('DB insert error:', dbError);
      console.error('DB insert error details:', JSON.stringify(dbError));
      // „Çπ„Éà„É¨„Éº„Ç∏„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ∏à„Åø„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§
      await supabase.storage.from('minutes').remove([safeStoragePath]).catch(() => {});
      showToast('Ë≠∞‰∫ãÈå≤ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (dbError.message || dbError.code || 'Unknown error'), 'error');
      return;
    }

    // ÈÄöÁü•„ÇíÈÄÅ‰ø°
    const project = projects.find(p => p.id === projectId);
    if (project) {
      const notifyEmails = [];
      if (project.assigned_to) {
        const designer = designers.find(d => d.name === project.assigned_to);
        if (designer?.email) notifyEmails.push(designer.email);
      }
      if (project.ic_assignee) {
        const icDesigner = designers.find(d => d.name === project.ic_assignee);
        if (icDesigner?.email) notifyEmails.push(icDesigner.email);
      }
      if (project.exterior_assignee) {
        const extDesigner = designers.find(d => d.name === project.exterior_assignee);
        if (extDesigner?.email) notifyEmails.push(extDesigner.email);
      }

      // ÈÄöÁü•„ÇíDB„Å´ÁôªÈå≤Ôºà„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñÔºâ
      for (const email of notifyEmails) {
        await supabase.from('notifications').insert({
          user_email: email,
          title: 'Êñ∞„Åó„ÅÑË≠∞‰∫ãÈå≤„Åå„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü',
          message: `${project.customer}Êßò„ÅÆË≠∞‰∫ãÈå≤„Äå${file.name}„Äç„Åå„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü`,
          link: `#projects?id=${projectId}`
        }).catch(() => {});
      }
    }

    showToast('Ë≠∞‰∫ãÈå≤„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
    await loadMinutesList(projectId);
  } catch (error) {
    logError('Upload error:', error);
    showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
}

// Ë≠∞‰∫ãÈå≤‰∏ÄË¶ßË™≠„ÅøËæº„Åø
async function loadMinutesList(projectId) {
  const container = document.getElementById(`minutesList_${projectId}`);
  if (!container) return;

  try {
    const { data: minutes, error } = await supabase
      .from('project_minutes')
      .select('*')
      .eq('project_id', projectId)
      .order('created_at', { ascending: false });

    if (error) {
      logError('Load minutes error:', error);
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">Ë≠∞‰∫ãÈå≤„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
      updateMinutesBadge(projectId, 0);
      return;
    }

    // Ë≠∞‰∫ãÈå≤Êï∞„Çí„Éê„ÉÉ„Ç∏„Å´Ë°®Á§∫
    const minutesCount = minutes ? minutes.length : 0;
    updateMinutesBadge(projectId, minutesCount);

    if (!minutes || minutes.length === 0) {
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„ÅüË≠∞‰∫ãÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      return;
    }

    container.innerHTML = minutes.map(m => `
      <div class="minute-item" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 8px;">
        <div style="flex: 1; min-width: 0;">
          <a href="${m.file_url}" target="_blank" style="color: var(--primary-color); text-decoration: none; font-size: 13px; font-weight: 500; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            üìÑ ${escapeHtml(m.file_name)}
          </a>
          <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
            ${formatFileSize(m.file_size)} ‚Ä¢ ${formatDate(m.created_at)}
          </div>
        </div>
        <button class="btn btn-small btn-ghost" onclick="deleteMinute('${m.id}', '${projectId}')" style="flex-shrink: 0; padding: 4px 8px; font-size: 12px; color: var(--danger-color);">ÂâäÈô§</button>
      </div>
    `).join('');
  } catch (error) {
    logError('Load minutes error:', error);
    container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">Ë≠∞‰∫ãÈå≤„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
    updateMinutesBadge(projectId, 0);
  }
}

// Ë≠∞‰∫ãÈå≤„Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
function updateMinutesBadge(projectId, count) {
  const badge = document.getElementById(`minutesBadge_${projectId}`);
  if (badge) {
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = 'inline-flex';
    } else {
      badge.style.display = 'none';
    }
  }
}

// ÂºïÁ∂ôÊõ∏„Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
function updateHandoverBadge(projectId, hasContent) {
  const badge = document.getElementById(`handoverBadge_${projectId}`);
  if (badge) {
    badge.style.display = hasContent ? 'inline-flex' : 'none';
  }
}

// ÂºïÁ∂ôÊõ∏„Éê„ÉÉ„Ç∏„ÇíË™≠„ÅøËæº„ÅøÊôÇ„Å´Êõ¥Êñ∞
async function loadHandoverBadge(projectId) {
  try {
    const { data: handovers, error } = await supabase
      .from('project_handovers')
      .select('content')
      .eq('project_id', projectId);

    if (error || !handovers || handovers.length === 0) return;

    const data = handovers[0];
    if (data && data.content) {
      let hasContent = false;
      try {
        const handoverData = JSON.parse(data.content);
        hasContent = Object.values(handoverData).some(v => v && v.trim());
      } catch (e) {
        hasContent = !!data.content.trim();
      }
      updateHandoverBadge(projectId, hasContent);
    }
  } catch (e) {}
}

// Ë≠∞‰∫ãÈå≤ÂâäÈô§
async function deleteMinute(minuteId, projectId) {
  if (!confirm('„Åì„ÅÆË≠∞‰∫ãÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  try {
    const { error } = await supabase
      .from('project_minutes')
      .delete()
      .eq('id', minuteId);

    if (error) throw error;
    showToast('Ë≠∞‰∫ãÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
    await loadMinutesList(projectId);
  } catch (error) {
    logError('Delete minute error:', error);
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
}

// „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„Éï„Ç©„Éº„Éû„ÉÉ„Éà
function formatFileSize(bytes) {
  if (!bytes) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„Éà
function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
}

// ‰æùÈ†ºÊó•Áî®„ÅÆÁü≠„ÅÑ„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàM/DÂΩ¢ÂºèÔºâ
function formatDateShort(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return '';
  return `${d.getMonth() + 1}/${d.getDate()}`;
}

// HTML„Ç®„Çπ„Ç±„Éº„Éó
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

// ============================================
// „Éê„É™„Éá„Éº„Ç∑„Éß„É≥Èñ¢Êï∞
// ============================================
const Validators = {
  // „É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÊ§úË®º
  isValidEmail(email) {
    if (!email) return false;
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  },

  // „Éë„Çπ„ÉØ„Éº„ÉâÊ§úË®ºÔºà8ÊñáÂ≠ó‰ª•‰∏ä„ÄÅËã±Êï∞Â≠óÊ∑∑Âú®Ôºâ
  isValidPassword(password) {
    if (!password || password.length < 8) return false;
    return /^(?=.*[a-zA-Z])(?=.*\d).{8,}$/.test(password);
  },

  // ÈõªË©±Áï™Âè∑Ê§úË®º
  isValidPhone(phone) {
    if (!phone) return true; // ‰ªªÊÑè„Éï„Ç£„Éº„É´„Éâ
    return /^[\d\-\+\(\)\s]{10,}$/.test(phone);
  },

  // Êó•‰ªò„ÅåÈÅéÂéª„Åß„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  isNotPastDate(dateStr) {
    if (!dateStr) return true;
    const inputDate = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return inputDate >= today;
  },

  // Êó•‰ªò„ÅåÊúâÂäπ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  isValidDate(dateStr) {
    if (!dateStr) return true;
    const date = new Date(dateStr);
    return !isNaN(date.getTime());
  },

  // ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
  isRequired(value) {
    if (value === null || value === undefined) return false;
    if (typeof value === 'string') return value.trim().length > 0;
    return true;
  },

  // ÊñáÂ≠óÊï∞Âà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ
  maxLength(value, max) {
    if (!value) return true;
    return String(value).length <= max;
  },

  // Êï∞ÂÄ§ÁØÑÂõ≤„ÉÅ„Çß„ÉÉ„ÇØ
  inRange(value, min, max) {
    const num = Number(value);
    if (isNaN(num)) return false;
    return num >= min && num <= max;
  }
};

// „Éï„Ç©„Éº„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÁµêÊûú
function validateForm(rules) {
  const errors = [];
  for (const [fieldName, validations] of Object.entries(rules)) {
    for (const { validate, message, value } of validations) {
      if (!validate(value)) {
        errors.push({ field: fieldName, message });
      }
    }
  }
  return errors;
}

// ============================================
// „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
// ============================================
const ErrorHandler = {
  // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞
  messages: {
    'Invalid login credentials': '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì',
    'Email not confirmed': '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆÁ¢∫Ë™ç„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì',
    'User already registered': '„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô',
    'Password should be at least': '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ8ÊñáÂ≠ó‰ª•‰∏ä„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
    'Network error': '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
    'timeout': '„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ',
    'duplicate key': '„Åì„ÅÆ„Éá„Éº„Çø„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô',
    'foreign key constraint': 'Èñ¢ÈÄ£„Åô„Çã„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åô„Çã„Åü„ÇÅÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì',
    'permission denied': '„Åì„ÅÆÊìç‰Ωú„ÇíË°å„ÅÜÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
  },

  // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂ§âÊèõ
  getUserMessage(error) {
    if (!error) return '‰∫àÊúü„Åõ„Å¨„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';

    const errorMsg = error.message || String(error);

    // „Éû„ÉÉ„Éî„É≥„Ç∞„Åã„ÇâÊ§úÁ¥¢
    for (const [key, userMsg] of Object.entries(this.messages)) {
      if (errorMsg.toLowerCase().includes(key.toLowerCase())) {
        return userMsg;
      }
    }

    // Supabase„Ç®„É©„Éº„Ç≥„Éº„ÉâÂØæÂøú
    if (error.code === 'PGRST116') return '„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
    if (error.code === '23505') return '„Åì„ÅÆ„Éá„Éº„Çø„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô';
    if (error.code === '23503') return 'Èñ¢ÈÄ£„Åô„Çã„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì';
    if (error.code === '42501') return '„Åì„ÅÆÊìç‰Ωú„ÇíË°å„ÅÜÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';

    // „Éá„Éï„Ç©„É´„Éà„É°„ÉÉ„Çª„Éº„Ç∏
    return '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
  },

  // „Ç®„É©„Éº„Çí„É≠„Ç∞ÔºÜÈÄöÁü•
  handle(error, context = '') {
    logError(`‚ùå „Ç®„É©„Éº [${context}]:`, error);

    const userMessage = this.getUserMessage(error);
    showToast(userMessage, 'error');

    // Êú¨Áï™Áí∞Â¢É„Åß„ÅØ„Ç®„É©„Éº„É≠„Ç∞„ÇíÈÄÅ‰ø°ÔºàÂ∞ÜÊù•ÂÆüË£ÖÔºâ
    // this.sendErrorLog(error, context);
  }
};

// ============================================
// ÂàÜÊûê„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊ©üËÉΩ
// ============================================

function getProgressBadgeClass(progress) {
  if (progress >= 70) return 'high';
  if (progress >= 40) return 'medium';
  return 'low';
}

function generateWeeklyReport() {
  const today = new Date();
  const weekAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);

  const activeProjects = projects.filter(p => !p.is_archived);
  const completedThisWeek = projects.filter(p => {
    if (!p.is_archived) return false;
    const updated = new Date(p.updated_at);
    return updated >= weekAgo;
  });

  // ‰ªäÈÄ±Êõ¥Êñ∞„Åï„Çå„ÅüÊ°à‰ª∂
  const updatedThisWeek = projects.filter(p => {
    const updated = new Date(p.updated_at);
    return updated >= weekAgo;
  });

  // Ë®≠Ë®àÊãÖÂΩìËÄÖÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
  const designerProjects = {};
  designers.filter(d => d.category === 'Ë®≠Ë®à').forEach(d => {
    designerProjects[d.name] = activeProjects.filter(p => p.assigned_to === d.name);
  });

  // ICÊãÖÂΩìËÄÖÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
  const icProjects = {};
  designers.filter(d => d.category === 'IC').forEach(d => {
    icProjects[d.name] = activeProjects.filter(p => p.ic_assignee === d.name);
  });

  // Â§ñÊßãÊãÖÂΩìËÄÖÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
  const exteriorProjects = {};
  designers.filter(d => d.category === 'Â§ñÊßã').forEach(d => {
    exteriorProjects[d.name] = activeProjects.filter(p => p.exterior_assignee === d.name);
  });

  // ‰∏çÂãïÁî£ÊãÖÂΩìËÄÖÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
  const realestateProjects = {};
  designers.filter(d => d.category === '‰∏çÂãïÁî£').forEach(d => {
    realestateProjects[d.name] = activeProjects.filter(p => p.realestate_assignee === d.name);
  });

  // ÊãÖÂΩìËÄÖÂà•„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÁîüÊàêÔºàÂÖ±ÈÄöÈñ¢Êï∞Ôºâ
  const generateDesignerSection = (projs, name, categoryLabel, weekAgo) => {
    const projectDetails = projs.map(p => {
      const progress = calculateProgress(p);
      const progressData = p.progress || {};

      // ‰∏ªË¶Å„Çø„Çπ„ÇØ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂèñÂæóÔºàÂãïÁöÑÔºâ
      const statuses = getMainTaskStatuses(progressData, categoryLabel === 'IC' ? 'IC' : 'Ë®≠Ë®à');
      const statusText = statuses.length > 0 ? statuses.join(' / ') : 'Êú™ÁùÄÊâã';
      const wasUpdated = new Date(p.updated_at) >= weekAgo;

      return `<div class="report-project-detail ${wasUpdated ? 'updated' : ''}">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
          <span style="font-weight: 600;">${escapeHtml(p.customer)}</span>
          <span class="report-progress-badge ${getProgressBadgeClass(progress)}">${progress}%</span>
        </div>
        <div style="font-size: 12px; color: var(--text-secondary);">${statusText}</div>
        ${wasUpdated ? '<div style="font-size: 11px; color: var(--primary-color); margin-top: 4px;">üìù ‰ªäÈÄ±Êõ¥Êñ∞</div>' : ''}
      </div>`;
    }).join('');

    return `<div class="report-designer-section">
      <div class="report-designer-header">
        <span class="report-designer-name">${escapeHtml(name)}</span>
        <span class="report-designer-count">${projs.length}‰ª∂</span>
      </div>
      ${projectDetails}
    </div>`;
  };

  const designerSections = Object.entries(designerProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateDesignerSection(projs, name, 'Ë®≠Ë®à', weekAgo))
    .join('');

  const icSections = Object.entries(icProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateDesignerSection(projs, name, 'IC', weekAgo))
    .join('');

  const exteriorSections = Object.entries(exteriorProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateDesignerSection(projs, name, 'Â§ñÊßã', weekAgo))
    .join('');

  const realestateSections = Object.entries(realestateProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateDesignerSection(projs, name, '‰∏çÂãïÁî£', weekAgo))
    .join('');

  const report = `
    <div class="report-card">
      <div class="report-header">
        <h2>ÈÄ±Â†±</h2>
        <span class="report-period">${weekAgo.toLocaleDateString('ja-JP')} „Äú ${today.toLocaleDateString('ja-JP')}</span>
      </div>
      <div class="report-stats-grid">
        <div class="report-stat-item">
          <div class="report-stat-value">${activeProjects.length}</div>
          <div class="report-stat-label">ÈÄ≤Ë°å‰∏≠</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${updatedThisWeek.length}</div>
          <div class="report-stat-label">‰ªäÈÄ±Êõ¥Êñ∞</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${completedThisWeek.length}</div>
          <div class="report-stat-label">‰ªäÈÄ±ÂÆå‰∫Ü</div>
        </div>
      </div>
      <div class="report-section">
        <div class="report-section-title">üìê Ë®≠Ë®àÊãÖÂΩìËÄÖÂà• Ê°à‰ª∂Áä∂Ê≥Å</div>
        ${designerSections || '<div class="report-empty">ÈÄ≤Ë°å‰∏≠„ÅÆÊ°à‰ª∂„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>'}
      </div>
      ${icSections ? `
      <div class="report-section">
        <div class="report-section-title">üé® ICÊãÖÂΩìËÄÖÂà• Ê°à‰ª∂Áä∂Ê≥Å</div>
        ${icSections}
      </div>` : ''}
      ${exteriorSections ? `
      <div class="report-section">
        <div class="report-section-title">üå≥ Â§ñÊßãÊãÖÂΩìËÄÖÂà• Ê°à‰ª∂Áä∂Ê≥Å</div>
        ${exteriorSections}
      </div>` : ''}
      ${realestateSections ? `
      <div class="report-section">
        <div class="report-section-title">üè† ‰∏çÂãïÁî£ÊãÖÂΩìËÄÖÂà• Ê°à‰ª∂Áä∂Ê≥Å</div>
        ${realestateSections}
      </div>` : ''}
      ${completedThisWeek.length > 0 ? `
      <div class="report-section">
        <div class="report-section-title">‰ªäÈÄ±„ÅÆÂÆå‰∫ÜÊ°à‰ª∂</div>
        <ul class="report-list">
          ${completedThisWeek.map(p => `<li class="report-list-item">
            <span class="report-project-name">${escapeHtml(p.customer)}</span>
            <span class="report-assignee">${escapeHtml(p.assigned_to || 'Êú™Ââ≤ÂΩì')}</span>
          </li>`).join('')}
        </ul>
      </div>` : ''}
    </div>
  `;

  const preview = document.getElementById('reportPreview');
  preview.style.display = 'block';
  preview.innerHTML = report;
  showToast('ÈÄ±Â†±„ÇíÁîüÊàê„Åó„Åæ„Åó„Åü', 'success');
}

function generateMonthlyReport() {
  const today = new Date();
  const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

  const activeProjects = projects.filter(p => !p.is_archived);
  const completedThisMonth = projects.filter(p => {
    if (!p.is_archived) return false;
    const updated = new Date(p.updated_at);
    return updated >= monthAgo;
  });

  // ‰ªäÊúàÊõ¥Êñ∞„Åï„Çå„ÅüÊ°à‰ª∂
  const updatedThisMonth = projects.filter(p => {
    const updated = new Date(p.updated_at);
    return updated >= monthAgo;
  });

  const completionRate = projects.length > 0 ? Math.round(completedThisMonth.length / projects.length * 100) : 0;

  // Ë®≠Ë®àÊãÖÂΩìËÄÖÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
  const designerProjects = {};
  designers.filter(d => d.category === 'Ë®≠Ë®à').forEach(d => {
    designerProjects[d.name] = activeProjects.filter(p => p.assigned_to === d.name);
  });

  // ICÊãÖÂΩìËÄÖÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
  const icProjects = {};
  designers.filter(d => d.category === 'IC').forEach(d => {
    icProjects[d.name] = activeProjects.filter(p => p.ic_assignee === d.name);
  });

  // Â§ñÊßãÊãÖÂΩìËÄÖÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
  const exteriorProjects = {};
  designers.filter(d => d.category === 'Â§ñÊßã').forEach(d => {
    exteriorProjects[d.name] = activeProjects.filter(p => p.exterior_assignee === d.name);
  });

  // ‰∏çÂãïÁî£ÊãÖÂΩìËÄÖÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
  const realestateProjects = {};
  designers.filter(d => d.category === '‰∏çÂãïÁî£').forEach(d => {
    realestateProjects[d.name] = activeProjects.filter(p => p.realestate_assignee === d.name);
  });

  // ÊãÖÂΩìËÄÖ„Åî„Å®„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥ÁîüÊàêÔºàÂÖ±ÈÄöÈñ¢Êï∞Ôºâ
  const generateMonthlySection = (projs, name, category, monthAgo) => {
    const projectDetails = projs.map(p => {
      const progressData = p.progress || {};
      const updatedAt = new Date(p.updated_at);
      const isUpdated = updatedAt >= monthAgo;

      // „Çø„Çπ„ÇØ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂèéÈõÜÔºàÂãïÁöÑÔºâ
      const statuses = getMainTaskStatuses(progressData, category);

      const statusTags = statuses.map(s =>
        `<span class="report-status-tag active">${s}</span>`
      ).join('');

      return `<div class="report-project-detail ${isUpdated ? 'updated' : ''}">
        <div class="report-project-title">
          <span class="project-name">${escapeHtml(p.customer)}</span>
          ${isUpdated ? '<span class="report-updated-badge">‰ªäÊúàÊõ¥Êñ∞</span>' : ''}
        </div>
        ${statusTags ? `<div class="report-status-list">${statusTags}</div>` : '<div class="report-status-list"><span class="report-status-tag">Êú™ÁùÄÊâã</span></div>'}
      </div>`;
    }).join('');

    return `<div class="report-designer-section">
      <div class="report-designer-header">
        <span class="report-designer-name">${escapeHtml(name)}</span>
        <span class="report-designer-count">${projs.length}‰ª∂</span>
      </div>
      ${projectDetails}
    </div>`;
  };

  const designerSections = Object.entries(designerProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateMonthlySection(projs, name, 'Ë®≠Ë®à', monthAgo))
    .join('');

  const icSections = Object.entries(icProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateMonthlySection(projs, name, 'IC', monthAgo))
    .join('');

  const exteriorSections = Object.entries(exteriorProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateMonthlySection(projs, name, 'Â§ñÊßã', monthAgo))
    .join('');

  const realestateSections = Object.entries(realestateProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => generateMonthlySection(projs, name, '‰∏çÂãïÁî£', monthAgo))
    .join('');

  const report = `
    <div class="report-card">
      <div class="report-header">
        <h2>ÊúàÂ†±</h2>
        <span class="report-period">${monthAgo.toLocaleDateString('ja-JP')} „Äú ${today.toLocaleDateString('ja-JP')}</span>
      </div>
      <div class="report-stats-grid">
        <div class="report-stat-item">
          <div class="report-stat-value">${projects.length}</div>
          <div class="report-stat-label">Á∑èÊ°à‰ª∂Êï∞</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${activeProjects.length}</div>
          <div class="report-stat-label">ÈÄ≤Ë°å‰∏≠</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${updatedThisMonth.length}</div>
          <div class="report-stat-label">‰ªäÊúàÊõ¥Êñ∞</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${completedThisMonth.length}</div>
          <div class="report-stat-label">‰ªäÊúàÂÆå‰∫Ü</div>
        </div>
      </div>
      <div class="report-section">
        <div class="report-section-title">üìê Ë®≠Ë®àÊãÖÂΩìËÄÖÂà• Ê°à‰ª∂Áä∂Ê≥Å</div>
        ${designerSections || '<div class="report-empty">ÈÄ≤Ë°å‰∏≠„ÅÆÊ°à‰ª∂„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>'}
      </div>
      ${icSections ? `
      <div class="report-section">
        <div class="report-section-title">üé® ICÊãÖÂΩìËÄÖÂà• Ê°à‰ª∂Áä∂Ê≥Å</div>
        ${icSections}
      </div>` : ''}
      ${exteriorSections ? `
      <div class="report-section">
        <div class="report-section-title">üå≥ Â§ñÊßãÊãÖÂΩìËÄÖÂà• Ê°à‰ª∂Áä∂Ê≥Å</div>
        ${exteriorSections}
      </div>` : ''}
      ${realestateSections ? `
      <div class="report-section">
        <div class="report-section-title">üè† ‰∏çÂãïÁî£ÊãÖÂΩìËÄÖÂà• Ê°à‰ª∂Áä∂Ê≥Å</div>
        ${realestateSections}
      </div>` : ''}
      ${completedThisMonth.length > 0 ? `
      <div class="report-section">
        <div class="report-section-title">‰ªäÊúà„ÅÆÂÆå‰∫ÜÊ°à‰ª∂</div>
        <ul class="report-list">
          ${completedThisMonth.map(p => `<li class="report-list-item">
            <span class="report-project-name">${escapeHtml(p.customer)}</span>
            <span class="report-assignee">${escapeHtml(p.assigned_to || 'Êú™Ââ≤ÂΩì')}</span>
          </li>`).join('')}
        </ul>
      </div>` : ''}
    </div>
  `;

  const preview = document.getElementById('reportPreview');
  preview.style.display = 'block';
  preview.innerHTML = report;
  showToast('ÊúàÂ†±„ÇíÁîüÊàê„Åó„Åæ„Åó„Åü', 'success');
}

function exportAnalyticsCSV() {
  const headers = ['Ê°à‰ª∂Âêç', 'Ë®≠Ë®àÊãÖÂΩì', 'ICÊãÖÂΩì', 'Â§ñÊßãÊãÖÂΩì', '‰∏çÂãïÁî£ÊãÖÂΩì', 'ÂïÜÂìÅ', 'ÈÄ≤ÊçóÁéá', '„Çπ„ÉÜ„Éº„Çø„Çπ', '‰ΩúÊàêÊó•'];
  const rows = projects.map(p => [
    p.customer,
    p.assigned_to || '',
    p.ic_assignee || '',
    p.exterior_assignee || '',
    p.realestate_assignee || '',
    p.specifications || '',
    calculateProgress(p) + '%',
    p.is_archived ? 'ÂÆå‰∫Ü' : 'ÈÄ≤Ë°å‰∏≠',
    p.created_at ? new Date(p.created_at).toLocaleDateString('ja-JP') : ''
  ]);

  const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
  const bom = '\uFEFF';
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `archideck_analytics_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
}

// ============================================
// „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„ÉÑ„Ç¢„ÉºÔºàÂàù„ÇÅ„Å¶„ÅÆÊñπ„Å∏Ôºâ
// ============================================
const AppTour = {
  currentStep: 0,
  overlay: null,
  tooltip: null,
  previousHighlight: null,

  steps: [
    {
      target: '.sidebar',
      title: '„Çµ„Ç§„Éâ„Éê„Éº',
      content: 'Ë®≠Ë®à„ÉªIC„ÉªÂ§ñÊßã„ÅÆÊãÖÂΩìËÄÖÂà•„Å´„Çø„Éñ„ÅåÂàÜ„Åã„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„ÇØ„É™„ÉÉ„ÇØ„ÅßÊãÖÂΩìËÄÖ„ÇíÂàá„ÇäÊõø„Åà„Çâ„Çå„Åæ„Åô„ÄÇ',
      position: 'right'
    },
    {
      target: '.project-card',
      title: 'Ê°à‰ª∂„Ç´„Éº„Éâ',
      content: 'ÂêÑÊ°à‰ª∂„ÅÆÊÉÖÂ†±„Åå„Ç´„Éº„ÉâÂΩ¢Âºè„ÅßË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ„ÇØ„É™„ÉÉ„ÇØ„ÅßË©≥Á¥∞„ÇíÈñã„Åç„ÄÅÈÄ≤Êçó„ÇíÊõ¥Êñ∞„Åß„Åç„Åæ„Åô„ÄÇ',
      position: 'bottom'
    },
    {
      target: '[onclick*="openProjectModal()"]',
      title: 'Êñ∞Ë¶èÊ°à‰ª∂„ÅÆËøΩÂä†',
      content: '„Åì„ÅÆ„Éú„Çø„É≥„Åã„ÇâÊñ∞„Åó„ÅÑÊ°à‰ª∂„ÇíÁôªÈå≤„Åß„Åç„Åæ„Åô„ÄÇ„ÅäÂÆ¢ÊßòÂêç„ÉªÊãÖÂΩìËÄÖ„ÉªÂïÜÂìÅ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
      position: 'bottom'
    },
    {
      target: '.search-container',
      title: 'Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„Éº',
      content: '„ÅäÂÆ¢ÊßòÂêç„ÅßÊ§úÁ¥¢„Åó„Åü„Çä„ÄÅÊãÖÂΩìËÄÖ„ÉªÂïÜÂìÅ„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åß„Åç„Åæ„Åô„ÄÇ',
      position: 'bottom'
    },
    {
      target: '[onclick*="showSettingsTab"]',
      title: 'Ë®≠ÂÆöÁîªÈù¢',
      content: '„Çπ„Çø„ÉÉ„Éï„ÉªÊ•≠ËÄÖ„Éª„Çø„Çπ„ÇØ„ÅÆÁÆ°ÁêÜ„ÄÅ„Éá„Éº„Çø„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å™„Å©„ÅØ„Åì„Å°„Çâ„Åã„Çâ„ÄÇ',
      position: 'left'
    }
  ],

  // „ÉÑ„Ç¢„ÉºÈñãÂßãÁ¢∫Ë™ç
  showWelcome() {
    if (this.overlay) return;

    this.overlay = document.createElement('div');
    this.overlay.className = 'tour-overlay';
    document.body.appendChild(this.overlay);

    const welcome = document.createElement('div');
    welcome.className = 'tour-welcome';
    welcome.innerHTML = `
      <div class="tour-welcome-icon">üëã</div>
      <h2>ArchiDeck„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ</h2>
      <p>Ë®≠Ë®à‰∫ãÂãôÊâÄ„ÅÆÊ°à‰ª∂ÁÆ°ÁêÜ„Çí„Ç∑„É≥„Éó„É´„Å´„Åô„Çã„ÉÑ„Éº„É´„Åß„Åô„ÄÇ<br>
      1ÂàÜÈñì„ÅÆ„Åã„Çì„Åü„Çì„ÉÑ„Ç¢„Éº„ÅßÂü∫Êú¨Êìç‰Ωú„Çí„ÅîÁ¥π‰ªã„Åó„Åæ„Åô„ÄÇ</p>
      <div class="tour-welcome-actions">
        <button class="tour-btn tour-btn-skip" onclick="AppTour.end()">„Çπ„Ç≠„ÉÉ„Éó</button>
        <button class="tour-btn tour-btn-next" onclick="AppTour.start()">„ÉÑ„Ç¢„Éº„ÇíÈñãÂßã</button>
      </div>
    `;
    document.body.appendChild(welcome);
    this.tooltip = welcome;
  },

  // „ÉÑ„Ç¢„ÉºÈñãÂßã
  start() {
    if (this.tooltip) {
      this.tooltip.remove();
      this.tooltip = null;
    }
    this.currentStep = 0;
    this.showStep();
  },

  // „Çπ„ÉÜ„ÉÉ„ÉóË°®Á§∫
  showStep() {
    const step = this.steps[this.currentStep];
    if (!step) {
      this.end();
      return;
    }

    // Ââç„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíËß£Èô§
    if (this.previousHighlight) {
      this.previousHighlight.classList.remove('tour-highlight');
    }

    // „Çø„Éº„Ç≤„ÉÉ„ÉàË¶ÅÁ¥†„ÇíÂèñÂæó
    let target = document.querySelector(step.target);

    // Ê°à‰ª∂„Ç´„Éº„Éâ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
    if (!target) {
      if (this.currentStep < this.steps.length - 1) {
        this.currentStep++;
        this.showStep();
        return;
      } else {
        this.end();
        return;
      }
    }

    // „Éè„Ç§„É©„Ç§„Éà
    target.classList.add('tour-highlight');
    this.previousHighlight = target;

    // „Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶Ë°®Á§∫
    target.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Êó¢Â≠ò„ÅÆ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíÂâäÈô§
    if (this.tooltip) {
      this.tooltip.remove();
    }

    // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó‰ΩúÊàê
    setTimeout(() => {
      this.createTooltip(step, target);
    }, 300);
  },

  createTooltip(step, target) {
    const rect = target.getBoundingClientRect();
    const tooltip = document.createElement('div');
    tooltip.className = 'tour-tooltip';

    // „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº
    const dots = this.steps.map((_, i) => {
      let className = 'tour-step-dot';
      if (i < this.currentStep) className += ' completed';
      else if (i === this.currentStep) className += ' active';
      return `<div class="${className}"></div>`;
    }).join('');

    tooltip.innerHTML = `
      <div class="tour-step-indicator">${dots}</div>
      <div class="tour-title">${step.title}</div>
      <div class="tour-content">${step.content}</div>
      <div class="tour-actions">
        <button class="tour-btn tour-btn-skip" onclick="AppTour.end()">„Çπ„Ç≠„ÉÉ„Éó</button>
        <div>
          ${this.currentStep > 0 ? '<button class="tour-btn tour-btn-prev" onclick="AppTour.prev()">Êàª„Çã</button>' : ''}
          <button class="tour-btn tour-btn-next" onclick="AppTour.next()">
            ${this.currentStep === this.steps.length - 1 ? 'ÂÆå‰∫Ü' : 'Ê¨°„Å∏'}
          </button>
        </div>
      </div>
    `;

    // ‰ΩçÁΩÆÊ±∫ÂÆö
    let top, left;
    const padding = 16;

    switch (step.position) {
      case 'right':
        top = rect.top + window.scrollY;
        left = rect.right + padding;
        tooltip.classList.add('arrow-left');
        break;
      case 'left':
        top = rect.top + window.scrollY;
        left = rect.left - 360 - padding;
        tooltip.classList.add('arrow-right');
        break;
      case 'bottom':
        top = rect.bottom + window.scrollY + padding;
        left = rect.left;
        tooltip.classList.add('arrow-top');
        break;
      case 'top':
        top = rect.top + window.scrollY - 200;
        left = rect.left;
        tooltip.classList.add('arrow-bottom');
        break;
    }

    // ÁîªÈù¢Â§ñ„Å´Âá∫„Å™„ÅÑ„Çà„ÅÜË™øÊï¥
    if (left < 16) left = 16;
    if (left + 360 > window.innerWidth) left = window.innerWidth - 376;
    if (top < 16) top = 16;

    tooltip.style.top = `${top}px`;
    tooltip.style.left = `${left}px`;

    document.body.appendChild(tooltip);
    this.tooltip = tooltip;
  },

  next() {
    if (this.currentStep < this.steps.length - 1) {
      this.currentStep++;
      this.showStep();
    } else {
      this.end();
    }
  },

  prev() {
    if (this.currentStep > 0) {
      this.currentStep--;
      this.showStep();
    }
  },

  end() {
    // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
    if (this.overlay) {
      this.overlay.remove();
      this.overlay = null;
    }
    if (this.tooltip) {
      this.tooltip.remove();
      this.tooltip = null;
    }
    if (this.previousHighlight) {
      this.previousHighlight.classList.remove('tour-highlight');
      this.previousHighlight = null;
    }

    // ÂÆå‰∫Ü„Éï„É©„Ç∞‰øùÂ≠ò
    localStorage.setItem('archideck_tour_completed', 'true');

    if (this.currentStep >= this.steps.length - 1) {
      showToast('„ÉÑ„Ç¢„ÉºÂÆå‰∫ÜÔºÅ„Åî‰∏çÊòéÁÇπ„ÅØ„Éò„É´„Éó„Éú„Çø„É≥„Åã„Çâ„ÅÑ„Å§„Åß„ÇÇÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô', 'success');
    }

    this.currentStep = 0;
  },

  // ÂàùÂõû„ÉÅ„Çß„ÉÉ„ÇØ
  checkFirstVisit() {
    const completed = localStorage.getItem('archideck_tour_completed');
    if (!completed) {
      // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„Ç¶„Çß„É´„Ç´„É†Ë°®Á§∫
      setTimeout(() => {
        this.showWelcome();
      }, 1500);
    }
  }
};

// ============================================
// Èü≥Â£∞ÂÖ•ÂäõÊ©üËÉΩ
// ============================================
let recognition = null;

function initVoiceInput() {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;
    recognition.interimResults = false;
  }
}

function startVoiceInput(targetInputId) {
  if (!recognition) {
    showToast('Èü≥Â£∞ÂÖ•Âäõ„ÅØ„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„Åß„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return;
  }

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    const input = document.getElementById(targetInputId);
    if (input) {
      input.value = transcript;
      showToast('Èü≥Â£∞ÂÖ•ÂäõÂÆå‰∫Ü', 'success');
    }
  };

  recognition.onerror = (event) => {
    showToast('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº: ' + event.error, 'error');
  };

  recognition.start();
  showToast('Ë©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ...', 'info');
}

// ÂàùÊúüÂåñÊôÇ„Å´Èü≥Â£∞ÂÖ•Âäõ„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
document.addEventListener('DOMContentLoaded', initVoiceInput);

// ============================================
// FCÔºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫ÔºâÁÆ°ÁêÜ
// ============================================
let fcOrganizations = [];

async function loadFcOrganizations() {
  try {
    const { data, error } = await supabase
      .from('fc_organizations')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      // „ÉÜ„Éº„Éñ„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
      if (error.code === '42P01') {
        warn('fc_organizations„ÉÜ„Éº„Éñ„É´„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì„ÄÇSQL„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }
      throw error;
    }

    fcOrganizations = data || [];
    renderFcList();
  } catch (e) {
    warn('FCÁµÑÁπîË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
  }
}

function renderFcList() {
  const container = document.getElementById('fcListContainer');
  if (!container) return;

  if (fcOrganizations.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üè™</div>
        <p>FC„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì<br><small>„Äå+ FCËøΩÂä†„Äç„Éú„Çø„É≥„Åã„ÇâÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small></p>
      </div>
    `;
    return;
  }

  const baseUrl = window.location.origin;

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>FCÂêç</th>
            <th>„Çπ„É©„ÉÉ„Ç∞</th>
            <th>Â∞ÇÁî®URL</th>
            <th>„Çπ„ÉÜ„Éº„Çø„Çπ</th>
            <th>‰ΩúÊàêÊó•</th>
            <th>Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody>
          ${fcOrganizations.map(fc => `
            <tr>
              <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="display: inline-block; width: 16px; height: 16px; border-radius: 4px; background: ${escapeHtml(fc.primary_color || '#2563EB')};"></span>
                  <strong>${escapeHtml(fc.name)}</strong>
                </div>
              </td>
              <td><code style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px;">${escapeHtml(fc.slug)}</code></td>
              <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <a href="${baseUrl}/fc/${escapeHtml(fc.slug)}/" target="_blank" style="font-size: 13px; color: var(--primary-color);">
                    /fc/${escapeHtml(fc.slug)}/
                  </a>
                  <button class="btn btn-ghost btn-small" onclick="copyFcUrl('${escapeHtml(fc.slug)}')" title="URL„Çí„Ç≥„Éî„Éº">üìã</button>
                </div>
              </td>
              <td>
                ${fc.is_active
                  ? '<span class="badge badge-success">ÊúâÂäπ</span>'
                  : '<span class="badge badge-secondary">ÁÑ°Âäπ</span>'}
              </td>
              <td style="font-size: 13px; color: var(--text-secondary);">${new Date(fc.created_at).toLocaleDateString('ja-JP')}</td>
              <td>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-ghost btn-small" onclick="editFc('${fc.id}')">Á∑®ÈõÜ</button>
                  <button class="btn btn-danger btn-small" onclick="deleteFc('${fc.id}')">ÂâäÈô§</button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function copyFcUrl(slug) {
  const baseUrl = window.location.origin;
  const url = `${baseUrl}/fc/${slug}/`;
  navigator.clipboard.writeText(url).then(() => {
    showToast('URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
  }).catch(() => {
    showToast('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  });
}

function openFcModal(fcId = null) {
  const modal = document.getElementById('fcModal');
  const title = document.getElementById('fcModalTitle');

  document.getElementById('fcForm').reset();
  document.getElementById('fcId').value = '';
  document.getElementById('fcColor').value = '#2563EB';
  document.getElementById('fcColorText').value = '#2563EB';
  document.getElementById('fcIsActive').checked = true;

  if (fcId) {
    const fc = fcOrganizations.find(f => f.id === fcId);
    if (!fc) return;

    title.textContent = 'FCÁ∑®ÈõÜ';
    document.getElementById('fcId').value = fc.id;
    document.getElementById('fcName').value = fc.name;
    document.getElementById('fcSlug').value = fc.slug;
    document.getElementById('fcEmail').value = fc.contact_email || '';
    document.getElementById('fcTel').value = fc.contact_tel || '';
    document.getElementById('fcColor').value = fc.primary_color || '#2563EB';
    document.getElementById('fcColorText').value = fc.primary_color || '#2563EB';
    document.getElementById('fcLogoUrl').value = fc.logo_url || '';
    document.getElementById('fcIsActive').checked = fc.is_active !== false;
  } else {
    title.textContent = 'FCËøΩÂä†';
  }

  ModalManager.open(modal, '#fcName');
}

function closeFcModal() {
  ModalManager.close(document.getElementById('fcModal'));
}

async function saveFc() {
  // ‰∫åÈáç„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢
  if (SaveGuard.isLocked('saveFc')) return;

  const id = document.getElementById('fcId').value;
  const name = document.getElementById('fcName').value.trim();
  const slug = document.getElementById('fcSlug').value.trim().toLowerCase();
  const contactEmail = document.getElementById('fcEmail').value.trim();
  const contactTel = document.getElementById('fcTel').value.trim();
  const primaryColor = document.getElementById('fcColor').value;
  const logoUrl = document.getElementById('fcLogoUrl').value.trim();
  const isActive = document.getElementById('fcIsActive').checked;

  if (!name || !slug) {
    showToast('FCÂêç„Å®„Çπ„É©„ÉÉ„Ç∞„ÅØÂøÖÈ†à„Åß„Åô', 'error');
    return;
  }

  // „Çπ„É©„ÉÉ„Ç∞„ÅÆÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØ
  if (!/^[a-z0-9-]+$/.test(slug)) {
    showToast('„Çπ„É©„ÉÉ„Ç∞„ÅØÂçäËßíËã±Êï∞Â≠ó„Å®„Éè„Ç§„Éï„É≥„ÅÆ„Åø‰ΩøÁî®ÂèØËÉΩ„Åß„Åô', 'error');
    return;
  }

  await SaveGuard.run('saveFc', async () => {
    showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

    const fcData = {
      name,
      slug,
      contact_email: contactEmail || null,
      contact_tel: contactTel || null,
      primary_color: primaryColor,
      logo_url: logoUrl || null,
      is_active: isActive,
      updated_at: new Date().toISOString()
    };

    let result;
    if (id) {
      result = await supabase
        .from('fc_organizations')
        .update(fcData)
        .eq('id', id)
        .select();
    } else {
      result = await supabase
        .from('fc_organizations')
        .insert([fcData])
        .select();
    }

    if (result.error) {
      if (result.error.code === '23505') {
        showToast('„Åì„ÅÆ„Çπ„É©„ÉÉ„Ç∞„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô', 'error');
      } else {
        showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error.message, 'error');
      }
      showStatus('„Ç®„É©„Éº', 'error');
      return;
    }

    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(id ? 'FC„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü' : 'FC„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
    closeFcModal();
    await loadFcOrganizations();
  });
}

function editFc(fcId) {
  openFcModal(fcId);
}

async function deleteFc(fcId) {
  const fc = fcOrganizations.find(f => f.id === fcId);
  if (!fc) return;

  if (!confirm(`FC„Äå${fc.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\nÂâäÈô§„Åô„Çã„Å®„ÄÅFCÂ∞ÇÁî®URL„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Å™„Åè„Å™„Çä„Åæ„Åô„ÄÇ`)) {
    return;
  }

  await SaveGuard.run(`deleteFc_${fcId}`, async () => {
    showStatus('ÂâäÈô§‰∏≠...', 'saving');

    const { error } = await supabase
      .from('fc_organizations')
      .delete()
      .eq('id', fcId);

    if (error) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast('FC„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
    await loadFcOrganizations();
  });
}

// ============================================
// „Ç´„Çπ„Çø„Éû„Ç§„Ç∫Ê©üËÉΩÔºàFCÂêë„Åë„Éé„Éº„Ç≥„Éº„ÉâÔºâ
// ============================================
function loadCustomization() {
  if (!currentOrganization) return;

  document.getElementById('customOrgName').value = currentOrganization.name || '';
  document.getElementById('customLogoUrl').value = currentOrganization.logo_url || '';
  document.getElementById('customPrimaryColor').value = currentOrganization.primary_color || '#2563EB';
  document.getElementById('customPrimaryColorText').value = currentOrganization.primary_color || '#2563EB';
  document.getElementById('customSecondaryColor').value = currentOrganization.secondary_color || '#059669';
  document.getElementById('customSecondaryColorText').value = currentOrganization.secondary_color || '#059669';

  updatePreview();
}

function previewCustomization() {
  const primaryColor = document.getElementById('customPrimaryColor').value;
  const secondaryColor = document.getElementById('customSecondaryColor').value;
  const name = document.getElementById('customOrgName').value;
  const logoUrl = document.getElementById('customLogoUrl').value;

  // CSS„Ç´„Çπ„Çø„É†„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÊõ¥Êñ∞
  document.documentElement.style.setProperty('--primary-color', primaryColor);
  document.documentElement.style.setProperty('--secondary-color', secondaryColor);

  // „Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞
  if (name) {
    document.title = `ArchiDeck | ${name}`;
  }

  // „Éó„É¨„Éì„É•„ÉºÈ†òÂüü„ÇíÊõ¥Êñ∞
  updatePreview();
  showToast('„Éó„É¨„Éì„É•„Éº„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü', 'success');
}

function updatePreview() {
  const primaryColor = document.getElementById('customPrimaryColor')?.value || '#2563EB';
  const secondaryColor = document.getElementById('customSecondaryColor')?.value || '#1E40AF';
  const name = document.getElementById('customOrgName')?.value || '';
  const logoUrl = document.getElementById('customLogoUrl')?.value || '';

  const previewLogo = document.getElementById('previewLogo');
  const previewTitle = document.getElementById('previewTitle');

  // null „ÉÅ„Çß„ÉÉ„ÇØ
  if (!previewLogo || !previewTitle) return;

  // „Ç´„É©„ÉºÂÄ§„ÅÆÊ§úË®ºÔºà#RRGGBBÂΩ¢Âºè„ÅÆ„ÅøË®±ÂèØÔºâ
  const isValidColor = (color) => /^#[0-9A-Fa-f]{6}$/.test(color);
  const safePrimary = isValidColor(primaryColor) ? primaryColor : '#2563EB';
  const safeSecondary = isValidColor(secondaryColor) ? secondaryColor : '#1E40AF';

  if (logoUrl) {
    // XSSÂØæÁ≠ñ: URL„Çí„Ç®„Çπ„Ç±„Éº„Éó„Åó„ÄÅhttp„Åæ„Åü„ÅØhttps„ÅÆ„ÅøË®±ÂèØ
    const isValidUrl = /^https?:\/\//i.test(logoUrl);
    if (isValidUrl) {
      const img = document.createElement('img');
      img.src = logoUrl;
      img.style.cssText = 'max-width: 32px; max-height: 32px; object-fit: contain;';
      img.onerror = () => { previewLogo.innerHTML = 'üè†'; };
      previewLogo.innerHTML = '';
      previewLogo.appendChild(img);
    } else {
      previewLogo.innerHTML = 'üè†';
    }
  } else {
    previewLogo.innerHTML = 'üè†';
    previewLogo.style.background = `linear-gradient(135deg, ${safePrimary}, ${safeSecondary})`;
  }

  previewTitle.textContent = name || 'ArchiDeck';
}

async function saveCustomization() {
  if (!currentOrganization) {
    showToast('ÁµÑÁπîÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  const statusEl = document.getElementById('customizeStatus');
  statusEl.innerHTML = '<span style="color: var(--text-muted);">‰øùÂ≠ò‰∏≠...</span>';

  const updates = {
    name: document.getElementById('customOrgName').value,
    logo_url: document.getElementById('customLogoUrl').value,
    primary_color: document.getElementById('customPrimaryColor').value,
    secondary_color: document.getElementById('customSecondaryColor').value,
    updated_at: new Date().toISOString()
  };

  const { error } = await supabase
    .from('organizations')
    .update(updates)
    .eq('id', currentOrganization.id);

  if (error) {
    statusEl.innerHTML = `<span style="color: var(--danger-color);">‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</span>`;
    logError('„Ç´„Çπ„Çø„Éû„Ç§„Ç∫‰øùÂ≠ò„Ç®„É©„Éº:', error);
    return;
  }

  // „É≠„Éº„Ç´„É´„ÅÆÁµÑÁπîÊÉÖÂ†±„ÇíÊõ¥Êñ∞
  Object.assign(currentOrganization, updates);

  // ÁîªÈù¢„Å´ÈÅ©Áî®
  applyWhiteLabel(currentOrganization);

  statusEl.innerHTML = '<span style="color: var(--success-color);">‰øùÂ≠ò„Åó„Åæ„Åó„Åü</span>';
  showToast('„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');

  setTimeout(() => {
    statusEl.innerHTML = '';
  }, 3000);
}

function resetCustomization() {
  document.getElementById('customOrgName').value = '';
  document.getElementById('customLogoUrl').value = '';
  document.getElementById('customPrimaryColor').value = '#2563EB';
  document.getElementById('customPrimaryColorText').value = '#2563EB';
  document.getElementById('customSecondaryColor').value = '#059669';
  document.getElementById('customSecondaryColorText').value = '#059669';

  // CSS„Ç´„Çπ„Çø„É†„Éó„É≠„Éë„ÉÜ„Ç£„Çí„Éá„Éï„Ç©„É´„Éà„Å´„É™„Çª„ÉÉ„Éà
  document.documentElement.style.setProperty('--primary-color', '#2563EB');
  document.documentElement.style.setProperty('--secondary-color', '#059669');
  document.title = 'ArchiDeck | G„Éè„Ç¶„Çπ Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†';

  updatePreview();
  showToast('„Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü', 'success');
}

// „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº„ÅÆÂêåÊúü
document.addEventListener('DOMContentLoaded', function() {
  const primaryColorPicker = document.getElementById('customPrimaryColor');
  const primaryColorText = document.getElementById('customPrimaryColorText');
  const secondaryColorPicker = document.getElementById('customSecondaryColor');
  const secondaryColorText = document.getElementById('customSecondaryColorText');

  if (primaryColorPicker && primaryColorText) {
    primaryColorPicker.addEventListener('input', function() {
      primaryColorText.value = this.value;
      updatePreview();
    });
  }

  if (secondaryColorPicker && secondaryColorText) {
    secondaryColorPicker.addEventListener('input', function() {
      secondaryColorText.value = this.value;
      updatePreview();
    });
  }
});

// ============================================
// Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊ©üËÉΩ
// ============================================
let autoBackupEnabled = localStorage.getItem('autoBackupEnabled') !== 'false';

function toggleAutoBackup() {
  const toggle = document.getElementById('autoBackupToggle');
  autoBackupEnabled = toggle.checked;
  localStorage.setItem('autoBackupEnabled', autoBackupEnabled);
  showToast(autoBackupEnabled ? 'Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÊúâÂäπÂåñ„Åó„Åæ„Åó„Åü' : 'Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÁÑ°ÂäπÂåñ„Åó„Åæ„Åó„Åü', 'info');
}

function saveAutoBackup() {
  if (!autoBackupEnabled) return;

  try {
    const backup = {
      version: '4.3',
      created_at: new Date().toISOString(),
      data: {
        projects: projects,
        designers: designers,
        tasksV2: tasksV2,
        vendors: vendors,
        emailTemplates: emailTemplates,
        products: products,
        vendorCategories: vendorCategories,
        taskVendorMappings: taskVendorMappings
      }
    };

    const json = JSON.stringify(backup);

    // „Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ (5MBÂà∂Èôê)
    if (json.length > 5 * 1024 * 1024) {
      warn('‚ö†Ô∏è „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô„ÄÇ„É≠„Éº„Ç´„É´‰øùÂ≠ò„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ');
      return;
    }

    localStorage.setItem('archideck_auto_backup', json);
    localStorage.setItem('archideck_last_backup', new Date().toISOString());

    // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂ±•Ê≠¥„Çí‰øùÊåÅÔºàÊúÄÂ§ß3‰ª∂Ôºâ
    const history = safeJsonParse(localStorage.getItem('archideck_backup_history'), []);
    history.unshift({
      timestamp: new Date().toISOString(),
      projectCount: projects.length,
      designerCount: designers.length
    });
    if (history.length > 3) history.pop();
    localStorage.setItem('archideck_backup_history', JSON.stringify(history));

    updateBackupUI();
    log('‚úÖ Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü:', new Date().toLocaleString());
  } catch (e) {
    warn('Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç®„É©„Éº:', e);
  }
}

function updateBackupUI() {
  const lastBackupEl = document.getElementById('lastBackupTime');
  const countEl = document.getElementById('localBackupCount');
  const toggleEl = document.getElementById('autoBackupToggle');

  if (lastBackupEl) {
    const lastBackup = localStorage.getItem('archideck_last_backup');
    lastBackupEl.textContent = lastBackup ? new Date(lastBackup).toLocaleString('ja-JP') : '-';
  }

  if (countEl) {
    const history = safeJsonParse(localStorage.getItem('archideck_backup_history'), []);
    countEl.textContent = history.length.toString();
  }

  if (toggleEl) {
    toggleEl.checked = autoBackupEnabled;
  }
}

function downloadLocalBackup() {
  const backup = localStorage.getItem('archideck_auto_backup');
  if (!backup) {
    showToast('„É≠„Éº„Ç´„É´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'warning');
    return;
  }

  const blob = new Blob([backup], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `archideck_local_backup_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url); // „É°„É¢„É™Ëß£Êîæ
  showToast('„É≠„Éº„Ç´„É´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
}

// ÂàùÊúüÂåñÊôÇ„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóUI„ÇíÊõ¥Êñ∞
setTimeout(updateBackupUI, 1000);

// ÂÆöÊúüÁöÑ„Å´Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºà5ÂàÜ„Åî„Å®Ôºâ
setInterval(() => {
  if (projects.length > 0 || designers.length > 0) {
    saveAutoBackup();
  }
}, 5 * 60 * 1000);

// „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê
async function createBackup() {
  const statusEl = document.getElementById('backupStatus');
  statusEl.innerHTML = '<span style="color: var(--text-muted);">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê‰∏≠...</span>';

  try {
    const backup = {
      version: '4.1',
      created_at: new Date().toISOString(),
      data: {
        projects: projects,
        designers: designers,
        tasksV2: tasksV2,
        vendors: vendors,
        emailTemplates: emailTemplates,
        products: products,
        vendorCategories: vendorCategories,
        taskVendorMappings: taskVendorMappings
      }
    };

    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `archideck_backup_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url); // „É°„É¢„É™Ëß£Êîæ

    statusEl.innerHTML = '<span style="color: var(--success-color);">‚úÖ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü</span>';
    showToast('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
  } catch (error) {
    logError('Backup error:', error);
    statusEl.innerHTML = '<span style="color: var(--danger-color);">‚ùå „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</span>';
    showToast('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
}

// „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂæ©ÂÖÉ
function restoreBackup() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.json';
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!confirm('ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇÊú¨ÂΩì„Å´Âæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü')) return;

    const statusEl = document.getElementById('backupStatus');
    statusEl.innerHTML = '<span style="color: var(--text-muted);">Âæ©ÂÖÉ‰∏≠...</span>';

    try {
      const text = await file.text();
      const backup = JSON.parse(text);

      if (!backup.version || !backup.data) {
        throw new Error('ÁÑ°Âäπ„Å™„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„Åß„Åô');
      }

      // ÂêÑ„ÉÜ„Éº„Éñ„É´„ÇíÂæ©ÂÖÉ
      const tables = ['projects', 'designers', 'vendors', 'email_templates', 'products', 'vendor_categories'];
      const dataMap = {
        projects: backup.data.projects,
        designers: backup.data.designers,
        vendors: backup.data.vendors,
        email_templates: backup.data.emailTemplates,
        products: backup.data.products,
        vendor_categories: backup.data.vendorCategories
      };

      let totalItems = 0;
      let failedItems = 0;

      for (const table of tables) {
        const data = dataMap[table];
        if (data && data.length > 0) {
          // Êó¢Â≠ò„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶Âæ©ÂÖÉ
          await supabase.from(table).delete().neq('id', '00000000-0000-0000-0000-000000000000');
          for (const item of data) {
            totalItems++;
            const { error } = await supabase.from(table).insert(item);
            if (error) {
              failedItems++;
              logError(`Âæ©ÂÖÉ„Ç®„É©„Éº (${table}):`, error);
            }
          }
        }
      }

      if (failedItems > 0) {
        statusEl.innerHTML = `<span style="color: var(--warning-color);">‚ö†Ô∏è Âæ©ÂÖÉÂÆå‰∫ÜÔºà${failedItems}/${totalItems}‰ª∂Â§±ÊïóÔºâ„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</span>`;
        showToast(`Âæ©ÂÖÉÂÆå‰∫ÜÔºà${failedItems}‰ª∂Â§±ÊïóÔºâ`, 'warning');
      } else {
        statusEl.innerHTML = '<span style="color: var(--success-color);">‚úÖ Âæ©ÂÖÉ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</span>';
        showToast('Âæ©ÂÖÉ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü', 'success');
      }
    } catch (error) {
      logError('Restore error:', error);
      statusEl.innerHTML = '<span style="color: var(--danger-color);">‚ùå Âæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</span>';
      showToast('Âæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    }
  };
  fileInput.click();
}

// kintoneÈÄ£Êê∫Ë®≠ÂÆö‰øùÂ≠ò
async function saveKintoneSettings() {
  try {
    const settings = {
      domain: document.getElementById('kintoneDomain').value,
      app_id: document.getElementById('kintoneAppId').value,
      api_token: document.getElementById('kintoneApiToken').value,
      field_sales: document.getElementById('kintoneFieldSales')?.value || '',
      field_design: document.getElementById('kintoneFieldDesign')?.value || '',
      field_ic: document.getElementById('kintoneFieldIC')?.value || '',
      field_construction: document.getElementById('kintoneFieldConstruction')?.value || ''
    };

    // „Éï„Ç£„Éº„É´„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇílocalStorage„Å´„ÇÇ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰øùÂ≠ò
    const fieldMappings = {
      customer: document.getElementById('kintoneFieldCustomer')?.value || '',
      layout: document.getElementById('kintoneFieldLayout')?.value || '',
      permit: document.getElementById('kintoneFieldPermit')?.value || '',
      meeting: document.getElementById('kintoneFieldMeeting')?.value || '',
      sales: settings.field_sales,
      design: settings.field_design,
      ic: settings.field_ic,
      construction: settings.field_construction
    };
    localStorage.setItem('kintone_field_mappings', JSON.stringify(fieldMappings));

    if (!settings.domain || !settings.app_id || !settings.api_token) {
      showToast('„Éâ„É°„Ç§„É≥„ÄÅ„Ç¢„Éó„É™ID„ÄÅAPI„Éà„Éº„ÇØ„É≥„ÅØÂøÖÈ†à„Åß„Åô', 'error');
      return;
    }

    // Êó¢Â≠ò„É¨„Ç≥„Éº„Éâ„ÇíÁ¢∫Ë™ç
    const { data: existing } = await supabase
      .from('kintone_settings')
      .select('id')
      .eq('is_active', true)
      .limit(1);

    let error;
    if (existing && existing.length > 0) {
      // Êó¢Â≠ò„É¨„Ç≥„Éº„Éâ„ÇíÊõ¥Êñ∞
      ({ error } = await supabase
        .from('kintone_settings')
        .update({
          ...settings,
          updated_at: new Date().toISOString()
        })
        .eq('id', existing[0].id));
    } else {
      // Êñ∞Ë¶è‰ΩúÊàê
      ({ error } = await supabase
        .from('kintone_settings')
        .insert({
          ...settings,
          is_active: true
        }));
    }

    if (error) {
      showToast('Ë®≠ÂÆö‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    kintoneSettings = settings;
    showToast('kintoneË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
  } catch (e) {
    showToast('Ë®≠ÂÆö‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
  }
}

// kintoneÊé•Á∂ö„ÉÜ„Çπ„ÉàÔºàEdge FunctionÁµåÁî±Ôºâ
async function testKintoneConnection() {
  const domain = document.getElementById('kintoneDomain').value;
  const appId = document.getElementById('kintoneAppId').value;
  const apiToken = document.getElementById('kintoneApiToken').value;

  if (!domain || !appId || !apiToken) {
    showToast('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  // „Åæ„ÅöË®≠ÂÆö„Çí‰øùÂ≠ò
  await saveKintoneSettings();

  document.getElementById('kintoneStatus').innerHTML = '<span style="color: var(--text-muted);">Êé•Á∂ö„ÉÜ„Çπ„Éà‰∏≠...</span>';

  try {
    const result = await callKintoneProxy('test');

    if (result.success) {
      document.getElementById('kintoneStatus').innerHTML =
        `<span style="color: var(--success-color);">‚úÖ Êé•Á∂öÊàêÂäüÔºÅ„Ç¢„Éó„É™„Äå${result.data?.name || appId}„Äç„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü</span>`;
      showToast('kintoneÊé•Á∂ö„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü', 'success');
    } else {
      // Ë©≥Á¥∞„Ç®„É©„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
      let errorMsg = result.error || 'Êé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
      if (result.hint) errorMsg += `<br><small style="color: var(--text-muted);">${result.hint}</small>`;
      if (result.details) errorMsg += `<br><small style="color: var(--text-muted);">${result.details}</small>`;
      document.getElementById('kintoneStatus').innerHTML =
        `<span style="color: var(--danger-color);">‚ùå ${errorMsg}</span>`;
      showToast('kintoneÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error, 'error');
    }
  } catch (e) {
    document.getElementById('kintoneStatus').innerHTML =
      `<span style="color: var(--danger-color);">‚ùå „Ç®„É©„Éº: ${e.message}</span>`;
    showToast('Êé•Á∂ö„ÉÜ„Çπ„Éà‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
  }
}

// kintone ProxyÂëº„Å≥Âá∫„ÅóÔºàEdge FunctionÁµåÁî±Ôºâ
async function callKintoneProxy(action, data = {}) {
  try {
    const response = await supabase.functions.invoke('kintone-proxy', {
      body: { action, data }
    });

    // Edge Function„Åã„Çâ„ÅÆ„Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ
    if (response.error) {
      console.error('Edge Function error:', response.error);
      return { success: false, error: response.error.message || 'Edge Function „Ç®„É©„Éº' };
    }

    // „É¨„Çπ„Éù„É≥„Çπ„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç
    if (response.data) {
      // Edge Function„Åå„Ç®„É©„Éº„ÇíËøî„Åó„ÅüÂ†¥ÂêàÔºàsuccess: false„ÅÆÂ†¥ÂêàÔºâ
      if (response.data.success === false) {
        console.error('kintone-proxy returned error:', response.data);
        return response.data;
      }
      return response.data;
    }

    return { success: false, error: '„É¨„Çπ„Éù„É≥„Çπ„ÅåÁ©∫„Åß„Åô' };
  } catch (e) {
    console.error('callKintoneProxy exception:', e);
    return { success: false, error: e.message };
  }
}

// kintone„Åã„Çâ„É¨„Ç≥„Éº„ÉâÂèñÂæó
async function fetchKintoneRecords(query = '', fields = []) {
  return await callKintoneProxy('getRecords', { query, fields });
}

// kintone„Å∏„É¨„Ç≥„Éº„ÉâËøΩÂä†
async function addKintoneRecord(record) {
  return await callKintoneProxy('addRecord', { record });
}

// kintone„É¨„Ç≥„Éº„ÉâÊõ¥Êñ∞
async function updateKintoneRecord(recordId, record) {
  return await callKintoneProxy('updateRecord', { recordId, record });
}

// kintone„Åã„ÇâÁõ¥Êé•„Ç§„É≥„Éù„Éº„Éà - ÂÆåÂÖ®‰øÆÊ≠£Áâà
async function importFromKintoneDirect() {
  const statusEl = document.getElementById('kintoneImportStatus');
  statusEl.innerHTML = '<span style="color: var(--text-muted);">üì• kintone„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠...</span>';

  try {
    // 1. ÁµÑÁπîID„ÅÆÁ¢∫Ë™ç
    if (!currentOrganization?.id) {
      statusEl.innerHTML = '<span style="color: var(--danger-color);">‚ùå ÁµÑÁπî„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</span>';
      return;
    }

    // 2. „Éï„Ç£„Éº„É´„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÂèñÂæó
    const fieldMappings = safeJsonParse(localStorage.getItem('kintone_field_mappings'), {});
    const customerField = fieldMappings.customer || 'ÊñáÂ≠ó_Âü∫Êú¨ÊÉÖÂ†±_„ÅäÂÆ¢ÊßòÂêç_„É°„Ç§„É≥';
    const salesField = fieldMappings.sales || '„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû_Âü∫Êú¨ÊÉÖÂ†±_Âñ∂Ê•≠';
    const designField = fieldMappings.design || '„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû_Âü∫Êú¨ÊÉÖÂ†±_Ë®≠Ë®à';
    const icField = fieldMappings.ic || '„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû_Âü∫Êú¨ÊÉÖÂ†±_IC';
    const constructionField = fieldMappings.construction || '„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû_Âü∫Êú¨ÊÉÖÂ†±_Â∑•‰∫ã';

    console.log('Field mappings:', { customerField, salesField, designField, icField, constructionField });

    // 3. kintone„Åã„Çâ„É¨„Ç≥„Éº„ÉâÂèñÂæó
    const result = await fetchKintoneRecords();
    console.log('Kintone result:', result);

    if (!result.success) {
      statusEl.innerHTML = `<span style="color: var(--danger-color);">‚ùå ${result.error}</span>`;
      return;
    }

    const records = result.data?.records || [];
    if (records.length === 0) {
      statusEl.innerHTML = '<span style="color: var(--warning-color);">‚ö†Ô∏è „É¨„Ç≥„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</span>';
      return;
    }

    // „Éá„Éê„ÉÉ„Ç∞: „Éï„Ç£„Éº„É´„Éâ‰∏ÄË¶ß
    console.log('Available fields:', Object.keys(records[0]));

    statusEl.innerHTML = `<span style="color: var(--text-muted);">üì• ${records.length}‰ª∂„ÅÆ„É¨„Ç≥„Éº„Éâ„ÇíÂá¶ÁêÜ‰∏≠...</span>`;

    let imported = 0;
    let updated = 0;
    let skipped = 0;
    const errors = [];

    for (const record of records) {
      try {
        // 4. „Éï„Ç£„Éº„É´„ÉâÂÄ§„ÇíÂÆâÂÖ®„Å´ÂèñÂæó
        const getValue = (field) => {
          const val = record[field]?.value;
          if (val === undefined || val === null) return null;
          if (Array.isArray(val)) {
            const names = val.map(v => v.name || v.code || String(v)).filter(Boolean);
            return names.length > 0 ? names.join(', ') : null;
          }
          const strVal = String(val).trim();
          return strVal || null;
        };

        const customer = getValue(customerField);
        if (!customer) {
          skipped++;
          continue;
        }

        const kintoneRecordId = String(record['$id']?.value || record['„É¨„Ç≥„Éº„ÉâÁï™Âè∑']?.value || '');

        // 5. Êó¢Â≠ò„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÁ¢∫Ë™ç
        const existingProject = projects.find(p =>
          (kintoneRecordId && p.kintone_record_id === kintoneRecordId) ||
          p.customer === customer
        );

        if (existingProject) {
          // 6. Êõ¥Êñ∞
          const updateData = { updated_at: new Date().toISOString() };
          const designVal = getValue(designField);
          const icVal = getValue(icField);
          const salesVal = getValue(salesField);
          const constructionVal = getValue(constructionField);

          if (designVal) updateData.assigned_to = designVal;
          if (icVal) updateData.ic_assignee = icVal;
          if (salesVal) updateData.sales_assignee = salesVal;
          if (constructionVal) updateData.construction_assignee = constructionVal;
          if (kintoneRecordId) updateData.kintone_record_id = kintoneRecordId;

          const { error } = await supabase
            .from('projects')
            .update(updateData)
            .eq('id', existingProject.id);

          if (error) {
            errors.push({ type: 'update', customer, error: error.message });
            skipped++;
          } else {
            Object.assign(existingProject, updateData);
            updated++;
          }
        } else {
          // 7. Êñ∞Ë¶è‰ΩúÊàê
          const insertData = {
            customer,
            organization_id: currentOrganization.id,
            status: 'active',
            progress: {},
            specifications: 'LIFE'
          };

          const designVal = getValue(designField);
          const icVal = getValue(icField);
          const salesVal = getValue(salesField);
          const constructionVal = getValue(constructionField);

          if (designVal) insertData.assigned_to = designVal;
          if (icVal) insertData.ic_assignee = icVal;
          if (salesVal) insertData.sales_assignee = salesVal;
          if (constructionVal) insertData.construction_assignee = constructionVal;
          if (kintoneRecordId) insertData.kintone_record_id = kintoneRecordId;

          const { data: newProject, error } = await supabase
            .from('projects')
            .insert(insertData)
            .select()
            .single();

          if (error) {
            errors.push({ type: 'insert', customer, error: error.message, code: error.code });
            console.error('Insert error:', error, insertData);
            skipped++;
          } else if (newProject) {
            projects.push(newProject);
            imported++;
          }
        }
      } catch (e) {
        console.error('Record error:', e);
        skipped++;
      }
    }

    // 8. „Ç®„É©„Éº„É≠„Ç∞
    if (errors.length > 0) console.error('Import errors:', errors);

    // 9. ÂÆå‰∫ÜË°®Á§∫
    renderProjects();
    renderSidebar();

    if (imported + updated > 0) {
      statusEl.innerHTML = `<span style="color: var(--success-color);">‚úÖ ÂÆå‰∫Ü: ${imported}‰ª∂„Ç§„É≥„Éù„Éº„Éà„ÄÅ${updated}‰ª∂Êõ¥Êñ∞„ÄÅ${skipped}‰ª∂„Çπ„Ç≠„ÉÉ„Éó</span>`;
      showToast(`kintone„Åã„Çâ${imported + updated}‰ª∂„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`, 'success');
    } else {
      statusEl.innerHTML = `<span style="color: var(--warning-color);">‚ö†Ô∏è ${skipped}‰ª∂„Çπ„Ç≠„ÉÉ„ÉóÔºà„Ç≥„É≥„ÇΩ„Éº„É´„Åß„Ç®„É©„ÉºÁ¢∫Ë™çÔºâ</span>`;
    }

  } catch (e) {
    console.error('Import error:', e);
    statusEl.innerHTML = `<span style="color: var(--danger-color);">‚ùå „Ç®„É©„Éº: ${e.message}</span>`;
  }
}

// kintoneË®≠ÂÆöË™≠„ÅøËæº„Åø
async function loadKintoneSettings() {
  try {
    const { data, error } = await supabase
      .from('kintone_settings')
      .select('*')
      .eq('is_active', true)
      .limit(1);

    // DB„Åã„ÇâË™≠„ÅøËæº„ÅøÊàêÂäü„Åó„ÅüÂ†¥Âêà
    if (!error && data && data.length > 0) {
      const settings = data[0];
      kintoneSettings = settings;

      const domainEl = document.getElementById('kintoneDomain');
      const appIdEl = document.getElementById('kintoneAppId');
      const apiTokenEl = document.getElementById('kintoneApiToken');

      if (domainEl) domainEl.value = settings.domain || '';
      if (appIdEl) appIdEl.value = settings.app_id || '';
      if (apiTokenEl) apiTokenEl.value = settings.api_token || '';

      // ÊãÖÂΩìËÄÖ„Éï„Ç£„Éº„É´„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíDB„Åã„ÇâË™≠„ÅøËæº„Åø
      const salesEl = document.getElementById('kintoneFieldSales');
      const designEl = document.getElementById('kintoneFieldDesign');
      const icEl = document.getElementById('kintoneFieldIC');
      const constructionEl = document.getElementById('kintoneFieldConstruction');
      if (salesEl && settings.field_sales) salesEl.value = settings.field_sales;
      if (designEl && settings.field_design) designEl.value = settings.field_design;
      if (icEl && settings.field_ic) icEl.value = settings.field_ic;
      if (constructionEl && settings.field_construction) constructionEl.value = settings.field_construction;
    }

    // Âü∫Êú¨ÊÉÖÂ†±„Éï„Ç£„Éº„É´„Éâ„ÅØlocalStorage„Åã„ÇâË™≠„ÅøËæº„ÅøÔºàDB„Å´„Ç´„É©„É†„Åå„Å™„ÅÑ„Åü„ÇÅÔºâ
    const fieldMappings = safeJsonParse(localStorage.getItem('kintone_field_mappings'), {});
    const customerEl = document.getElementById('kintoneFieldCustomer');
    const layoutEl = document.getElementById('kintoneFieldLayout');
    const permitEl = document.getElementById('kintoneFieldPermit');
    const meetingEl = document.getElementById('kintoneFieldMeeting');
    const salesEl2 = document.getElementById('kintoneFieldSales');
    const designEl2 = document.getElementById('kintoneFieldDesign');
    const icEl2 = document.getElementById('kintoneFieldIC');
    const constructionEl2 = document.getElementById('kintoneFieldConstruction');

    if (customerEl && fieldMappings.customer) customerEl.value = fieldMappings.customer;
    if (layoutEl && fieldMappings.layout) layoutEl.value = fieldMappings.layout;
    if (permitEl && fieldMappings.permit) permitEl.value = fieldMappings.permit;
    if (meetingEl && fieldMappings.meeting) meetingEl.value = fieldMappings.meeting;
    // ÊãÖÂΩìËÄÖ„Éï„Ç£„Éº„É´„Éâ„ÅØDB„Åã„ÇâË™≠„ÅøËæº„ÅøÊ∏à„Åø„Å†„Åå„ÄÅ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Å®„Åó„Å¶localStorage„ÇÇÁ¢∫Ë™ç
    if (salesEl2 && !salesEl2.value && fieldMappings.sales) salesEl2.value = fieldMappings.sales;
    if (designEl2 && !designEl2.value && fieldMappings.design) designEl2.value = fieldMappings.design;
    if (icEl2 && !icEl2.value && fieldMappings.ic) icEl2.value = fieldMappings.ic;
    if (constructionEl2 && !constructionEl2.value && fieldMappings.construction) constructionEl2.value = fieldMappings.construction;
  } catch (e) {
    // ‰æãÂ§ñÁô∫ÁîüÊôÇ„ÇÇÈùô„Åã„Å´ÁµÇ‰∫Ü
  }
}

// kintone„Åã„Çâ„Ç§„É≥„Éù„Éº„ÉàÔºàCSV„Éô„Éº„ÇπÔºâ
async function importFromKintone() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.csv';
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const text = await file.text();
    const lines = text.split('\n');

    // Á©∫„Éï„Ç°„Ç§„É´„Åæ„Åü„ÅØ„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Åø„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
    if (!lines || lines.length < 2) {
      showToast('CSV„Éï„Ç°„Ç§„É´„ÅåÁ©∫„Åã„ÄÅ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }

    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

    // „Éï„Ç£„Éº„É´„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÂèñÂæó
    const fieldMappings = safeJsonParse(localStorage.getItem('kintone_field_mappings'), {});

    // „Ç´„É©„É†„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÊ§úÁ¥¢Ôºà„Éû„ÉÉ„Éî„É≥„Ç∞Ë®≠ÂÆö„Åå„ÅÇ„Çå„Å∞„Åù„Çå„ÇíÂÑ™ÂÖàÔºâ
    const findColIdx = (mapping, fallbacks) => {
      if (mapping) {
        const idx = headers.findIndex(h => h === mapping || h.includes(mapping));
        if (idx !== -1) return idx;
      }
      for (const fb of fallbacks) {
        const idx = headers.findIndex(h => h.includes(fb));
        if (idx !== -1) return idx;
      }
      return -1;
    };

    const customerIdx = findColIdx(fieldMappings.customer, ['È°ßÂÆ¢', 'ÈÇ∏Âêç', 'customer']);
    const addressIdx = headers.findIndex(h => h.includes('Âª∫ÁØâÂú∞') || h.includes('‰ΩèÊâÄ') || h.includes('address'));
    const recordIdIdx = headers.findIndex(h => h.includes('„É¨„Ç≥„Éº„Éâ') || h.includes('record') || h === '$id');
    const salesIdx = findColIdx(fieldMappings.sales, ['Âñ∂Ê•≠ÊãÖÂΩì', 'Âñ∂Ê•≠', 'sales']);
    const designIdx = findColIdx(fieldMappings.design, ['Ë®≠Ë®àÊãÖÂΩì', 'Ë®≠Ë®à', 'design']);
    const icIdx = findColIdx(fieldMappings.ic, ['ICÊãÖÂΩì', 'IC', 'ic']);
    const constructionIdx = findColIdx(fieldMappings.construction, ['Â∑•‰∫ãÊãÖÂΩì', 'Â∑•‰∫ã', 'construction']);

    if (customerIdx === -1) {
      showToast('È°ßÂÆ¢Âêç/ÈÇ∏Âêç„Ç´„É©„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }

    let importCount = 0;
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
      if (!cols[customerIdx]) continue;

      const customer = cols[customerIdx];
      const address = addressIdx >= 0 ? cols[addressIdx] : '';
      const kintoneRecordId = recordIdIdx >= 0 ? cols[recordIdIdx] : '';
      const salesAssignee = salesIdx >= 0 ? cols[salesIdx] : '';
      const designAssignee = designIdx >= 0 ? cols[designIdx] : '';
      const icAssignee = icIdx >= 0 ? cols[icIdx] : '';
      const constructionAssignee = constructionIdx >= 0 ? cols[constructionIdx] : '';

      // Êó¢Â≠ò„ÉÅ„Çß„ÉÉ„ÇØ
      const existing = projects.find(p => p.customer === customer);
      if (existing) continue;

      // Êñ∞Ë¶è‰ΩúÊàê
      const { error } = await supabase.from('projects').insert({
        customer,
        building_address: address,
        kintone_record_id: kintoneRecordId,
        sales_assignee: salesAssignee,
        assigned_to: designAssignee || designers.find(d => d.category === 'Ë®≠Ë®à')?.name || '',
        ic_assignee: icAssignee,
        construction_assignee: constructionAssignee,
        specifications: 'LIFE',
        status: 'active',
        progress: {}
      });

      if (!error) importCount++;
    }

    showToast(`${importCount}‰ª∂„ÅÆÊ°à‰ª∂„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`, 'success');
    await loadProjects();
    renderProjects();
  };
  fileInput.click();
}

// kintone„Å∏„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÔºàCSVÔºâ
function exportToKintone() {
  const headers = ['Ê°à‰ª∂ID', 'kintone_record_id', 'È°ßÂÆ¢Âêç', 'Âª∫ÁØâÂú∞', 'Âñ∂Ê•≠ÊãÖÂΩì', 'Ë®≠Ë®àÊãÖÂΩì', 'ICÊãÖÂΩì', 'Â§ñÊßãÊãÖÂΩì', '‰∏çÂãïÁî£ÊãÖÂΩì', 'Â∑•‰∫ãÊãÖÂΩì', 'ÂïÜÂìÅ', 'ÈÄ≤ÊçóÁéá', 'ÈñìÂèñÁ¢∫ÂÆöÊó•', 'ÁùÄÂ∑•Ë®±ÂèØÊó•', 'Â§âÊõ¥Â•ëÁ¥ÑÂâç‰ºöË≠∞Êó•', 'Êõ¥Êñ∞Êó•'];
  const rows = projects.map(p => [
    p.id,
    p.kintone_record_id || '',
    p.customer,
    p.building_address || '',
    p.sales_assignee || '',
    p.assigned_to,
    p.ic_assignee || '',
    p.exterior_assignee || '',
    p.realestate_assignee || '',
    p.construction_assignee || '',
    p.specifications,
    calculateProgress(p) + '%',
    p.layout_confirmed_date || '',
    p.construction_permit_date || '',
    p.pre_contract_meeting_date || '',
    p.updated_at
  ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));

  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `archideck_export_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  URL.revokeObjectURL(url); // „É°„É¢„É™Ëß£Êîæ
  showToast('CSV„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü', 'success');
}

// kintoneÂêåÊúüÂØæË±°„Éï„Ç£„Éº„É´„Éâ„ÇíÊõ¥Êñ∞
async function syncToKintone(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project || !project.kintone_record_id) {
    showToast('kintone record ID„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return;
  }

  if (!kintoneSettings?.domain || !kintoneSettings?.api_token) {
    showToast('kintoneË®≠ÂÆö„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return;
  }

  // ÂÆüÈöõ„ÅÆAPI„Ç≥„Éº„É´„ÅØCORSÂà∂Èôê„ÅÆ„Åü„ÇÅ„Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„ÅßÂÆüË°å„ÅåÂøÖË¶Å
  // „Åì„Åì„Åß„ÅØUI„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅÆ„Åø
  showToast('kintoneÂêåÊúü„Çí„É™„ÇØ„Ç®„Çπ„Éà„Åó„Åæ„Åó„ÅüÔºà„Çµ„Éº„Éê„Éº„Çµ„Ç§„ÉâÂá¶ÁêÜÂæÖ„Å°Ôºâ', 'info');

  // ÂêåÊúü„É™„ÇØ„Ç®„Çπ„Éà„ÇíDB„Å´Ë®òÈå≤
  await supabase.from('kintone_sync_queue').insert({
    project_id: projectId,
    kintone_record_id: project.kintone_record_id,
    sync_type: 'push',
    status: 'pending',
    data: {
      layout_confirmed_date: project.layout_confirmed_date,
      construction_permit_date: project.construction_permit_date,
      pre_contract_meeting_date: project.pre_contract_meeting_date
    }
  }).catch(() => {});
}

// Â§ñÊßãÊãÖÂΩì„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíË®≠ÂÆö
function populateExteriorAssigneeDropdown(projectId = null, project = null) {
  const exteriorDesigners = designers.filter(d => d.category === 'Â§ñÊßã');
  const exteriorAssigneeSelect = document.getElementById('projectExteriorAssignee');

  if (exteriorAssigneeSelect) {
    exteriorAssigneeSelect.innerHTML = '<option value="">Êú™ÂÆö</option>' +
      exteriorDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    if (projectId && project) {
      exteriorAssigneeSelect.value = project.exterior_assignee || '';
    }
  }
}

// ‰∏çÂãïÁî£ÊãÖÂΩì„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíË®≠ÂÆö
function populateRealestateAssigneeDropdown(projectId = null, project = null) {
  const realestateDesigners = designers.filter(d => d.category === '‰∏çÂãïÁî£');
  const realestateAssigneeSelect = document.getElementById('projectRealestateAssignee');

  if (realestateAssigneeSelect) {
    realestateAssigneeSelect.innerHTML = '<option value="">Êú™ÂÆö</option>' +
      realestateDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    if (projectId && project) {
      realestateAssigneeSelect.value = project.realestate_assignee || '';
    }
  }
}

// Â∑•‰∫ãÊãÖÂΩì„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíË®≠ÂÆö
function populateConstructionAssigneeDropdown(projectId = null, project = null) {
  const constructionDesigners = designers.filter(d => d.category === 'Â∑•‰∫ã');
  const constructionAssigneeSelect = document.getElementById('projectConstructionAssignee');

  if (constructionAssigneeSelect) {
    constructionAssigneeSelect.innerHTML = '<option value="">Êú™ÂÆö</option>' +
      constructionDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    if (projectId && project) {
      constructionAssigneeSelect.value = project.construction_assignee || '';
    }
  }
}

// Âñ∂Ê•≠ÊãÖÂΩì„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíË®≠ÂÆö
function populateSalesAssigneeDropdown(projectId = null, project = null) {
  const salesDesigners = designers.filter(d => d.category === 'Âñ∂Ê•≠');
  const salesAssigneeSelect = document.getElementById('projectSalesAssignee');

  if (salesAssigneeSelect) {
    salesAssigneeSelect.innerHTML = '<option value="">Êú™ÂÆö</option>' +
      salesDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    if (projectId && project) {
      salesAssigneeSelect.value = project.sales_assignee || '';
    }
  }
}

// openProjectModal„ÇíÊã°Âºµ
const originalOpenProjectModal = openProjectModal;
openProjectModal = function(projectId = null) {
  originalOpenProjectModal(projectId);

  const project = projectId ? projects.find(p => p.id === projectId) : null;
  populateExteriorAssigneeDropdown(projectId, project);
  populateRealestateAssigneeDropdown(projectId, project);
  populateConstructionAssigneeDropdown(projectId, project);
  populateSalesAssigneeDropdown(projectId, project);
};

// saveProject„ÇíÊã°Âºµ
const originalSaveProject = saveProject;
saveProject = async function() {
  const customer = document.getElementById('projectCustomer').value.trim();
  const assignedTo = document.getElementById('projectAssignedTo').value.trim();
  const icAssignee = document.getElementById('projectIcAssignee').value.trim();

  // ÊúÄÂæå„Å´‰ΩøÁî®„Åó„ÅüÊãÖÂΩìËÄÖ„ÇíË®òÊÜ∂
  if (assignedTo) {
    localStorage.setItem('archideck_last_assignee', assignedTo);
  }
  const exteriorAssignee = document.getElementById('projectExteriorAssignee')?.value.trim() || '';
  const realestateAssignee = document.getElementById('projectRealestateAssignee')?.value.trim() || '';
  const constructionAssignee = document.getElementById('projectConstructionAssignee')?.value.trim() || '';
  const salesAssignee = document.getElementById('projectSalesAssignee')?.value.trim() || '';
  const specifications = document.getElementById('projectSpecifications').value;

  if (!customer || !assignedTo) {
    showToast('„ÅäÂÆ¢ÊßòÂêç„Å®ÊãÖÂΩìÔºàË®≠Ë®àÔºâ„ÅØÂøÖÈ†à„Åß„Åô', 'error');
    return;
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  const projectData = {
    customer,
    assigned_to: assignedTo,
    ic_assignee: icAssignee || null,
    exterior_assignee: exteriorAssignee || null,
    realestate_assignee: realestateAssignee || null,
    construction_assignee: constructionAssignee || null,
    sales_assignee: salesAssignee || null,
    specifications,
    updated_at: new Date().toISOString()
  };

  try {
    if (editingProjectId) {
      const { error } = await supabase
        .from('projects')
        .update(projectData)
        .eq('id', editingProjectId);

      if (error) throw error;

      const idx = projects.findIndex(p => p.id === editingProjectId);
      if (idx !== -1) {
        projects[idx] = { ...projects[idx], ...projectData };
      }
    } else {
      const uid = 'P-' + Date.now();
      projectData.uid = uid;
      projectData.progress = {};
      projectData.status = 'active';

      const { data, error } = await supabase
        .from('projects')
        .insert(projectData)
        .select()
        .single();

      if (error) throw error;
      projects.push(data);
    }

    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(editingProjectId ? 'Ê°à‰ª∂„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü' : 'Ê°à‰ª∂„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
    closeProjectModal();
    renderSidebar();
    renderProjects();
  } catch (error) {
    logError('‰øùÂ≠ò„Ç®„É©„Éº:', error);
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
};

// ============================================
// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ
// ============================================
window.addEventListener('DOMContentLoaded', () => {
  initDarkMode(); // „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàùÊúüÂåñ
  checkAuth();
  // URLÁõ¥Êé•„Ç¢„ÇØ„Çª„Çπ„ÅÆÂá¶ÁêÜ„ÅØcheckAuth() ‚Üí init()ÂÆå‰∫ÜÂæå„Å´Ëá™ÂãïÂÆüË°å„Åï„Çå„Çã

  // Service WorkerÁôªÈå≤ÔºàPWAÂØæÂøúÔºâ- È†ÜÂ∫èÂà∂Âæ°‰ªò„Åç
  if ('serviceWorker' in navigator) {
    (async () => {
      try {
        // 1. Âè§„ÅÑ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂÖ®„Å¶„ÇØ„É™„Ç¢
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(async (cacheName) => {
          await caches.delete(cacheName);
          log('üóëÔ∏è „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢:', cacheName);
        }));

        // 2. Êó¢Â≠ò„ÅÆService Worker„ÇíÊõ¥Êñ∞
        const registrations = await navigator.serviceWorker.getRegistrations();
        await Promise.all(registrations.map(async (registration) => {
          await registration.update();
          log('üîÑ Service WorkerÊõ¥Êñ∞„ÇíÁ¢∫Ë™ç');
        }));

        // 3. Service Worker„ÇíÁôªÈå≤
        const reg = await navigator.serviceWorker.register('/archideck/sw.js', { updateViaCache: 'none' });
        log('‚úÖ Service Worker registered:', reg.scope);

        // Êñ∞„Åó„ÅÑService Worker„Åå„ÅÇ„Çå„Å∞Âç≥Â∫ß„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éô„Éº„Éà
        if (reg.waiting) {
          reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
      } catch (err) {
        logError('‚ùå Service WorkerÂá¶ÁêÜ„Ç®„É©„Éº:', err);
      }
    })();
  }

  // „Éó„ÉÉ„Ç∑„É•ÈÄöÁü•„ÅÆË®±ÂèØ„É™„ÇØ„Ç®„Çπ„Éà
  if ('Notification' in window && Notification.permission === 'default') {
    // 3ÁßíÂæå„Å´ÈÄöÁü•Ë®±ÂèØ„ÇíÊ±Ç„ÇÅ„Çã
    setTimeout(() => {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          log('‚úÖ Push notifications enabled');
        }
      });
    }, 3000);
  }
});

// „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥
const FAB = {
  container: null,
  button: null,
  menu: null,
  isOpen: false,

  init() {
    this.container = document.getElementById('fabContainer');
    this.button = document.getElementById('fabButton');
    this.menu = document.getElementById('fabMenu');

    // Â§ñÈÉ®„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    document.addEventListener('click', (e) => {
      if (this.isOpen && !this.container?.contains(e.target)) {
        this.close();
      }
    });
  },

  toggle() {
    this.isOpen = !this.isOpen;
    this.button?.classList.toggle('active', this.isOpen);
    this.menu?.classList.toggle('show', this.isOpen);
  },

  close() {
    this.isOpen = false;
    this.button?.classList.remove('active');
    this.menu?.classList.remove('show');
  },

  action(type) {
    this.close();
    switch (type) {
      case 'new':
        createNewProject();
        break;
      case 'refresh':
        forceReloadData();
        break;
      case 'export':
        exportToCSV();
        break;
      case 'print':
        BatchReportGenerator.generateAndPrint('Ë®≠Ë®à');
        break;
      case 'help':
        showShortcutHelp();
        break;
    }
  }
};

// FABÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', () => FAB.init());
</script>

<!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-card">
    <div class="loading-spinner large"></div>
    <div class="loading-text" id="loadingText">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
  </div>
</div>

<!-- „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
<div class="fab-container" id="fabContainer">
  <div class="fab-menu" id="fabMenu">
    <div class="fab-menu-item" onclick="FAB.action('new')">
      <span class="icon">‚ûï</span>
      <span>Êñ∞Ë¶èÊ°à‰ª∂‰ΩúÊàê</span>
    </div>
    <div class="fab-menu-item" onclick="FAB.action('refresh')">
      <span class="icon">üîÑ</span>
      <span>„Éá„Éº„ÇøÂÜçË™≠„ÅøËæº„Åø</span>
    </div>
    <div class="fab-menu-item" onclick="FAB.action('export')">
      <span class="icon">üìä</span>
      <span>CSVÂá∫Âäõ</span>
    </div>
    <div class="fab-menu-item" onclick="FAB.action('print')">
      <span class="icon">üñ®Ô∏è</span>
      <span>„É¨„Éù„Éº„ÉàÂç∞Âà∑</span>
    </div>
    <div class="fab-menu-item" onclick="FAB.action('help')">
      <span class="icon">‚å®Ô∏è</span>
      <span>„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà</span>
    </div>
  </div>
  <button class="fab-button" id="fabButton" onclick="FAB.toggle()" title="„ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥">
    ‚ûï
  </button>
</div>
</body>
</html>
