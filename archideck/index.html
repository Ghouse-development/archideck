<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2563EB">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ArchiDeck">
<meta name="description" content="ä½å®…è¨­è¨ˆæ¥­å‹™ã‚’é©æ–°çš„ã«åŠ¹ç‡åŒ–ã™ã‚‹ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ">
<link rel="manifest" href="/archideck/manifest.json">
<title>ArchiDeck | Gãƒã‚¦ã‚¹ è¨­è¨ˆæ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ </text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232563EB' width='100' height='100' rx='20'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white'>A</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.87.1/dist/umd/supabase.min.js" integrity="sha256-mgB0KFXEH7op01hbCXulq3TZjSqvaCMD35XeKkoTqL8=" crossorigin="anonymous"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  /* Primary - Deep Ocean Blue */
  --primary-color: #2563EB;
  --primary-hover: #1D4ED8;
  --primary-light: #DBEAFE;
  --primary-dark: #1E40AF;

  /* Secondary - Emerald Green */
  --secondary-color: #059669;
  --secondary-hover: #047857;
  --secondary-light: #D1FAE5;

  /* Accent - Violet */
  --accent-color: #7C3AED;
  --accent-light: #EDE9FE;

  /* Status Colors */
  --danger-color: #DC2626;
  --danger-light: #FEE2E2;
  --warning-color: #D97706;
  --warning-light: #FEF3C7;
  --success-color: #16A34A;
  --success-light: #DCFCE7;
  --success-bg: #DCFCE7;
  --info-color: #0891B2;
  --info-light: #CFFAFE;

  /* Text Colors */
  --text-primary: #0F172A;
  --text-secondary: #475569;
  --text-muted: #94A3B8;
  --text-light: #CBD5E1;

  /* Background Colors */
  --bg-primary: #FFFFFF;
  --bg-secondary: #F8FAFC;
  --bg-tertiary: #F1F5F9;
  --bg-hover: #E2E8F0;

  /* Border Colors */
  --border-color: #E2E8F0;
  --border-light: #F1F5F9;
  --border-focus: #93C5FD;

  /* Shadows - More refined */
  --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -2px rgba(0,0,0,0.04);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.03);
  --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.08), 0 8px 10px -6px rgba(0,0,0,0.03);
  --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,0.15);
  --shadow-inner: inset 0 2px 4px rgba(0,0,0,0.04);
  --shadow-glow: 0 0 20px rgba(37, 99, 235, 0.15);

  /* Border Radius */
  --radius-xs: 4px;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --radius-2xl: 20px;
  --radius-full: 9999px;

  /* Transitions */
  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-normal: 200ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-bounce: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);

  /* Spacing */
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-2xl: 48px;
}


/* data-table ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆåˆ†æç”»é¢ç”¨ï¼‰ */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.data-table th,
.data-table td {
  padding: 12px 16px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.data-table th {
  background: var(--bg-secondary);
  font-weight: 600;
  color: var(--text-primary);
}

.data-table td {
  color: var(--text-primary);
}

.data-table tr:hover td {
  background: var(--bg-hover);
}

body {
  font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-secondary);
  color: var(--text-primary);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Global Scrollbar Styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

/* Focus Visible - Accessibility */
:focus-visible {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

/* Selection Styling */
::selection {
  background: var(--primary-light);
  color: var(--primary-dark);
}

/* Utility Classes */
.text-primary { color: var(--text-primary); }
.text-secondary { color: var(--text-secondary); }
.text-muted { color: var(--text-muted); }
.text-success { color: var(--success-color); }
.text-danger { color: var(--danger-color); }
.text-warning { color: var(--warning-color); }

.bg-primary { background: var(--primary-light); }
.bg-success { background: var(--success-light); }
.bg-danger { background: var(--danger-light); }
.bg-warning { background: var(--warning-light); }

.font-medium { font-weight: 500; }
.font-semibold { font-weight: 600; }
.font-bold { font-weight: 700; }

.rounded { border-radius: var(--radius-md); }
.rounded-lg { border-radius: var(--radius-lg); }
.rounded-full { border-radius: var(--radius-full); }

.shadow-sm { box-shadow: var(--shadow-sm); }
.shadow-md { box-shadow: var(--shadow-md); }
.shadow-lg { box-shadow: var(--shadow-lg); }

/* Animation Classes */
.animate-fade-in {
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.animate-slide-up {
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-scale-in {
  animation: scaleIn 0.2s ease-out;
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ - Premium Design */
.login-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--bg-secondary) 0%, #E8F4FE 100%);
  padding: 20px;
  position: relative;
  overflow: hidden;
}

.login-container::before {
  content: '';
  position: absolute;
  width: 600px;
  height: 600px;
  background: radial-gradient(circle, rgba(37, 99, 235, 0.08) 0%, transparent 70%);
  top: -200px;
  right: -200px;
  pointer-events: none;
}

.login-container::after {
  content: '';
  position: absolute;
  width: 400px;
  height: 400px;
  background: radial-gradient(circle, rgba(5, 150, 105, 0.06) 0%, transparent 70%);
  bottom: -100px;
  left: -100px;
  pointer-events: none;
}

.login-card {
  background: var(--bg-primary);
  border: 1px solid rgba(255,255,255,0.8);
  border-radius: var(--radius-2xl);
  padding: 48px;
  box-shadow: var(--shadow-xl), 0 0 40px rgba(37, 99, 235, 0.06);
  max-width: 440px;
  width: 100%;
  text-align: center;
  position: relative;
  z-index: 1;
}

.login-logo {
  width: 64px;
  height: 64px;
  margin: 0 auto 20px;
  background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);
}

.login-card h1 {
  font-size: 26px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
  letter-spacing: -0.02em;
}

.login-card p {
  color: var(--text-secondary);
  margin-bottom: 32px;
  font-size: 14px;
  line-height: 1.5;
}

/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
.main-container {
  display: none;
  max-width: 1800px;
  margin: 0 auto;
  background: var(--bg-secondary);
  min-height: 100vh;
}

.main-container.show {
  display: block;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ - Premium Design */
.header {
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  padding: 0 32px;
  height: 64px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 32px;
}

.sidebar-toggle {
  display: none;
}

.logo {
  font-size: 22px;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
  letter-spacing: -0.02em;
}

.logo-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
}

.logo-text {
  background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-action-btn {
  width: 40px;
  height: 40px;
  border: none;
  background: transparent;
  border-radius: var(--radius-md);
  cursor: pointer;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-fast);
}

.header-action-btn:hover {
  background: var(--bg-secondary);
  color: var(--primary-color);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 6px 12px 6px 6px;
  background: var(--bg-secondary);
  border-radius: var(--radius-full);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.user-info:hover {
  background: var(--bg-hover);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  font-weight: 600;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

.user-role {
  font-size: 11px;
  color: var(--text-muted);
}

/* ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
.category-switch-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  min-width: 180px;
}

.category-switch-menu button {
  display: block;
  width: 100%;
  padding: 12px 16px;
  text-align: left;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-primary);
  transition: background 0.2s;
}

.category-switch-menu button:hover {
  background: var(--bg-secondary);
}

.category-switch-menu button:first-child {
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.category-switch-menu button:last-child {
  border-radius: 0 0 var(--radius-md) var(--radius-md);
}

/* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
.tabs-nav {
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  padding: 0 32px;
  display: flex;
  gap: 8px;
}

.tab-nav-btn {
  padding: 16px 24px;
  border: none;
  background: transparent;
  font-size: 15px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.tab-nav-btn:hover {
  color: var(--text-primary);
  background: var(--bg-secondary);
}

.tab-nav-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
}

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
.tab-panel {
  display: none;
  flex: 1;
  overflow-y: auto;
}

.tab-panel.active {
  display: flex;
  flex-direction: column;
}

/* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
.toolbar {
  background: var(--bg-primary);
  padding: 20px 32px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.toolbar-left {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  flex: 1;
}

.toolbar-right {
  display: flex;
  gap: 12px;
}

/* ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã‚¿ãƒ– */
.designer-tabs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.designer-tab {
  padding: 8px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.designer-tab:hover {
  background: var(--bg-tertiary);
}

.designer-group-label {
  width: 100%;
  padding: 8px 12px;
  margin-top: 12px;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border-radius: 8px;
  border-left: 3px solid var(--primary-color);
}

.designer-tab.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* ãƒœã‚¿ãƒ³ - Premium Design */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 11px 22px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-normal);
  white-space: nowrap;
  position: relative;
  overflow: hidden;
  letter-spacing: 0.01em;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.12) 0%, transparent 50%);
  pointer-events: none;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2), 0 1px 2px rgba(37, 99, 235, 0.12);
}

.btn-primary:hover {
  background: var(--primary-hover);
  box-shadow: 0 8px 16px rgba(37, 99, 235, 0.25), 0 3px 6px rgba(37, 99, 235, 0.15);
  transform: translateY(-1px);
}

.btn-primary:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
}

.btn-secondary {
  background: var(--secondary-color);
  color: white;
  box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2);
}

.btn-secondary:hover {
  background: var(--secondary-hover);
  box-shadow: 0 8px 16px rgba(5, 150, 105, 0.25);
  transform: translateY(-1px);
}

.btn-ghost {
  background: transparent;
  border: 1.5px solid var(--border-color);
  color: var(--text-primary);
}

.btn-ghost::before {
  display: none;
}

.btn-ghost:hover {
  background: var(--bg-secondary);
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.btn-outline {
  background: transparent;
  border: 1.5px solid var(--primary-color);
  color: var(--primary-color);
}

.btn-outline::before {
  display: none;
}

.btn-outline:hover {
  background: var(--primary-light);
}

.btn-danger {
  background: var(--danger-color);
  color: white;
  box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
}

.btn-danger:hover {
  background: #B91C1C;
  box-shadow: 0 8px 16px rgba(220, 38, 38, 0.25);
  transform: translateY(-1px);
}

.btn-soft {
  background: var(--primary-light);
  color: var(--primary-color);
  border: none;
}

.btn-soft::before {
  display: none;
}

.btn-soft:hover {
  background: var(--border-focus);
}

.btn-small {
  padding: 7px 14px;
  font-size: 13px;
}

.btn-large {
  padding: 14px 28px;
  font-size: 16px;
}

.btn-icon {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: var(--radius-md);
}

.btn-icon.btn-small {
  width: 32px;
  height: 32px;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ - Premium Design */
.input, .select {
  padding: 11px 16px;
  border: 1.5px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  background: var(--bg-primary);
  transition: all var(--transition-normal);
  color: var(--text-primary);
}

.input:hover, .select:hover {
  border-color: var(--text-muted);
}

.input:focus, .select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  background: #FAFBFF;
}

.input::placeholder {
  color: var(--text-muted);
}

.input {
  min-width: 200px;
}

.input-group {
  position: relative;
}

.input-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  pointer-events: none;
}

.input-group .input {
  padding-left: 42px;
}

/* ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ */
.cards-container {
  padding: 32px;
}

.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
  gap: 24px;
}

/* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ¼ãƒ‰ - Premium Design */
.project-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-xl);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: all var(--transition-slow);
  position: relative;
  overflow: hidden;
}

.project-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--secondary-color));
  opacity: 0;
  transition: opacity var(--transition-normal);
}

.project-card:hover {
  box-shadow: var(--shadow-lg), var(--shadow-glow);
  transform: translateY(-2px);
  border-color: transparent;
}

.project-card:hover::before {
  opacity: 1;
}

/* ãŠæ°—ã«å…¥ã‚Šã‚«ãƒ¼ãƒ‰ */
.project-card.favorite {
  border-color: var(--warning-color);
  background: linear-gradient(to bottom, var(--warning-light) 0%, white 100px);
}

.project-card.favorite::before {
  background: var(--warning-color);
  opacity: 1;
}

/* é¸æŠä¸­ã‚«ãƒ¼ãƒ‰ */
.project-card.selected {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px var(--primary-light);
}

/* ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ */
.favorite-btn {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: var(--text-muted);
  padding: 4px;
  line-height: 1;
  transition: all var(--transition-fast);
}

.favorite-btn:hover {
  color: var(--warning-color);
  transform: scale(1.2);
}

.favorite-btn.active {
  color: var(--warning-color);
}

/* ãƒãƒƒãƒé¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
.batch-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
  margin-top: 2px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border-light);
}

.card-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 12px;
  line-height: 1.3;
  letter-spacing: -0.02em;
}

.card-title:hover {
  color: var(--primary-color);
}

/* ç‰©ä»¶åã®èƒŒæ™¯ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
.customer-name {
  background: linear-gradient(135deg, #DBEAFE 0%, #EFF6FF 100%);
  padding: 4px 12px;
  border-radius: 6px;
  color: #1E40AF;
}

.card-title:hover .customer-name {
  background: linear-gradient(135deg, #BFDBFE 0%, #DBEAFE 100%);
}

.card-subtitle {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.card-subtitle::before {
  content: '';
  display: inline-block;
  width: 4px;
  height: 4px;
  background: var(--text-muted);
  border-radius: 50%;
}

/* ãƒãƒƒã‚¸ - Premium Design */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  border-radius: var(--radius-full);
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.02em;
  border: none;
}

.badge-primary {
  background: var(--primary-light);
  color: var(--primary-color);
}

.badge-success {
  background: var(--success-light);
  color: var(--success-color);
}

.badge-warning {
  background: var(--warning-light);
  color: var(--warning-color);
}

.badge-danger {
  background: var(--danger-light);
  color: var(--danger-color);
}

.badge-secondary {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
}

.badge-info {
  background: var(--info-light);
  color: var(--info-color);
}

.badge-accent {
  background: var(--accent-light);
  color: var(--accent-color);
}

/* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 26px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.3s;
  border-radius: 26px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: var(--primary-color);
}

input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

/* ãƒŸã‚¹ãƒ»æ¼ã‚Œé˜²æ­¢: è­¦å‘Šãƒãƒƒã‚¸ */
.project-warnings {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.warning-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  animation: pulse-warning 2s ease-in-out infinite;
}

.warning-badge.warning-danger {
  background: linear-gradient(135deg, #FEE2E2, #FECACA);
  color: #DC2626;
  border: 1px solid #FCA5A5;
}

.warning-badge.warning-warning {
  background: linear-gradient(135deg, #FEF3C7, #FDE68A);
  color: #D97706;
  border: 1px solid #FCD34D;
}

.warning-icon {
  font-size: 14px;
}

@keyframes pulse-warning {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* ã‚¢ãƒ©ãƒ¼ãƒˆã‚µãƒãƒªãƒ¼ */
.alert-summary {
  background: linear-gradient(135deg, #FEF2F2, #FEE2E2);
  border: 2px solid #FCA5A5;
  border-radius: 12px;
  padding: 16px 20px;
  margin-bottom: 20px;
  animation: slide-down 0.3s ease-out;
}

@keyframes slide-down {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.alert-summary-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}

.alert-summary-icon {
  font-size: 20px;
}

.alert-summary-title {
  font-size: 16px;
  font-weight: 700;
  color: #DC2626;
}

.alert-summary-count {
  background: #DC2626;
  color: white;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.alert-summary-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.alert-item {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--bg-primary);
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  color: #991B1B;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid #FECACA;
}

.alert-item:hover {
  background: #FEF2F2;
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15);
}

/* ã‚«ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
.project-card.highlight-card {
  animation: highlight-pulse 0.5s ease-out 3;
  box-shadow: 0 0 0 3px var(--primary-color), var(--shadow-lg);
}

@keyframes highlight-pulse {
  0%, 100% { box-shadow: 0 0 0 3px var(--primary-color), var(--shadow-lg); }
  50% { box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.3), var(--shadow-lg); }
}

.badge-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
}

/* æ¥­è€…ã‚«ãƒ¼ãƒ‰ */
.vendor-card {
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.vendor-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
  border-color: var(--primary-color);
}

.vendor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--bg-secondary);
}

.vendor-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.vendor-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
  font-size: 14px;
  color: var(--text-secondary);
}

.vendor-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
.category-filter-btn {
  padding: 8px 16px;
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
}

.category-filter-btn:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  background: var(--bg-secondary);
}

.category-filter-btn.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ©ãƒ™ãƒ« */
.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
}

.checkbox-label input[type="checkbox"] {
  cursor: pointer;
  width: 18px;
  height: 18px;
}

.checkbox-label span {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

/* é€²æ—ãƒãƒ¼ - Premium Design */
.progress-section {
  margin-bottom: 20px;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.progress-label {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
}

.progress-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--primary-color);
  display: flex;
  align-items: baseline;
  gap: 2px;
}

.progress-value-unit {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-muted);
}

.progress-bar {
  height: 8px;
  background: var(--bg-hover);
  border-radius: var(--radius-full);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: var(--radius-full);
  position: relative;
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
  animation: shimmer 2s ease-in-out infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.progress-fill.complete {
  background: var(--success-color);
}

/* ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ - Premium Design */
.tasks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 10px;
  margin-bottom: 20px;
}

.task-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--bg-primary);
  border-radius: var(--radius-md);
  font-size: 14px;
  transition: all var(--transition-fast);
  border: 1px solid var(--border-light);
}

.task-item:hover {
  background: var(--bg-secondary);
  border-color: var(--border-color);
  box-shadow: var(--shadow-sm);
}

/* ã‚¿ã‚¹ã‚¯æœŸé™ãƒ»é…å»¶è¡¨ç¤º */
.task-item.overdue {
  border-left: 3px solid var(--danger-color);
  background: #FEF2F2;
}

.task-item.due-soon {
  border-left: 3px solid var(--warning-color);
  background: #FFFBEB;
}

.task-due-date {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
  margin-left: auto;
  white-space: nowrap;
}

.task-due-date.overdue {
  background: var(--danger-light);
  color: var(--danger-color);
  font-weight: 600;
}

.task-due-date.due-soon {
  background: var(--warning-light);
  color: #92400E;
}

.task-due-date.normal {
  background: var(--bg-tertiary);
  color: var(--text-muted);
}

.task-due-input {
  width: 110px;
  padding: 4px 8px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 12px;
  flex-shrink: 0;
}

.task-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
  border-radius: var(--radius-xs);
}

.task-state-select {
  height: 32px;
  padding: 0 10px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  background: var(--bg-primary);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--transition-fast);
  min-width: 90px;
  flex-shrink: 0;
}

.task-state-select:hover {
  border-color: var(--primary-color);
}

.task-state-select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
}

.task-state-select.state-yellow {
  background: var(--warning-light);
  border-color: #F59E0B;
  color: #92400E;
}

.task-state-select.state-blue {
  background: var(--primary-light);
  border-color: #3B82F6;
  color: #1E40AF;
}

.task-label {
  flex: 1;
  color: var(--text-primary);
  font-weight: 500;
  font-size: 13px;
}

.task-email-btn {
  width: 32px;
  height: 32px;
  padding: 0;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.task-email-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
}

/* ç”³è«‹Goã‚³ãƒ³ãƒ†ãƒŠï¼ˆãƒ•ãƒ«ãƒ¯ã‚¤ãƒ‰ï¼‰ */
.application-go-container {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 16px 24px;
  border-radius: 12px;
  margin-top: 8px;
  transition: all 0.3s ease;
}

.application-go-icon {
  font-size: 24px;
}

.application-go-text {
  font-size: 16px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.application-go-arrow {
  font-size: 20px;
  font-weight: 700;
  animation: pulse-arrow 1.5s infinite;
}

@keyframes pulse-arrow {
  0%, 100% { opacity: 1; transform: translateX(0); }
  50% { opacity: 0.6; transform: translateX(4px); }
}

.application-go-status {
  font-size: 12px;
  padding: 4px 12px;
  background: rgba(0,0,0,0.1);
  border-radius: 12px;
}

/* æ¡ä»¶é”æˆæ™‚ï¼šã‚¯ãƒªãƒƒã‚¯å¯èƒ½ */
.application-go-ready {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
}

.application-go-ready:hover {
  background: linear-gradient(135deg, #059669, #047857);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
}

/* å®Œäº†æ¸ˆã¿ */
.application-go-completed {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}

.application-go-completed .application-go-icon {
  background: white;
  color: #10b981;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
}

/* æ¡ä»¶æœªé” */
.application-go-disabled {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 2px dashed var(--border-color);
}

.application-go-disabled .application-go-icon {
  opacity: 0.5;
}

/* ç”³è«‹Go ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
@media (max-width: 768px) {
  .application-go-container {
    padding: 14px 16px;
    gap: 10px;
  }

  .application-go-icon {
    font-size: 20px;
  }

  .application-go-text {
    font-size: 14px;
  }

  .application-go-arrow {
    font-size: 16px;
  }
}

.template-select-btn {
  width: 100%;
  padding: 16px;
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}

.template-select-btn:hover {
  border-color: var(--primary-color);
  background: var(--bg-secondary);
  transform: translateX(4px);
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« - Premium Design */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.6);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(8px);
  padding: 20px;
}

.modal.show {
  display: flex;
  animation: modalBgFadeIn 0.2s ease-out;
}

@keyframes modalBgFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: var(--bg-primary);
  border-radius: var(--radius-2xl);
  width: min(800px, 100%);
  max-height: calc(100vh - 40px);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-2xl), 0 0 60px rgba(0, 0, 0, 0.15);
  animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-24px) scale(0.96);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  padding: 24px 28px;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg-primary);
  flex-shrink: 0;
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.02em;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.modal-title-icon {
  width: 36px;
  height: 36px;
  background: var(--primary-light);
  color: var(--primary-color);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

.close {
  width: 36px;
  height: 36px;
  border: none;
  background: var(--bg-secondary);
  color: var(--text-secondary);
  font-size: 20px;
  cursor: pointer;
  border-radius: var(--radius-md);
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
}

.close:hover {
  background: var(--danger-light);
  color: var(--danger-color);
}

.modal-body {
  padding: 28px;
  overflow-y: auto;
  flex: 1;
}

.modal-body::-webkit-scrollbar {
  width: 6px;
}

.modal-body::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 3px;
}

.modal-footer {
  padding: 20px 28px;
  border-top: 1px solid var(--border-light);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  background: var(--bg-secondary);
  flex-shrink: 0;
}

/* ãƒ•ã‚©ãƒ¼ãƒ  - Premium Design */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.form-label-required {
  color: var(--danger-color);
  font-size: 12px;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 12px 16px;
  border: 1.5px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  transition: all var(--transition-fast);
  background: var(--bg-primary);
  color: var(--text-primary);
}

.form-input:hover, .form-select:hover, .form-textarea:hover {
  border-color: var(--text-muted);
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  background: #FAFBFF;
}

.form-input::placeholder {
  color: var(--text-muted);
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
  line-height: 1.5;
}

.form-hint {
  margin-top: 6px;
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 4px;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.form-divider {
  height: 1px;
  background: var(--border-light);
  margin: 24px 0;
}

.form-section-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 600;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.status-saving {
  background: #FFF4E6;
  color: var(--warning-color);
}

.status-saving .status-dot {
  background: var(--warning-color);
  animation: pulse 1.5s infinite;
}

.status-saved {
  background: #E6F9F0;
  color: var(--success-color);
}

.status-saved .status-dot {
  background: var(--success-color);
}

.status-error {
  background: #FFE6E6;
  color: var(--danger-color);
}

.status-error .status-dot {
  background: var(--danger-color);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ãƒ†ãƒ¼ãƒ–ãƒ« */
.table-container {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table thead {
  background: linear-gradient(180deg, #f8f9fa, #f0f1f3);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
}

.table th {
  padding: 18px 20px;
  text-align: left;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table td {
  padding: 16px 20px;
  border-top: 1px solid var(--border-color);
  font-size: 14px;
  color: var(--text-primary);
}

.table tbody tr:nth-child(even) {
  background: #fafbfc;
}

.table tbody tr:hover {
  background: #f0f7ff;
  box-shadow: inset 0 0 0 1px rgba(74, 144, 226, 0.1);
  transition: all 0.2s;
}

/* ç©ºçŠ¶æ…‹ */
.empty-state {
  padding: 80px 40px;
  text-align: center;
  color: var(--text-secondary);
}

.empty-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.empty-description {
  font-size: 14px;
  margin-bottom: 24px;
}

/* ãƒ¡ãƒ¼ãƒ«å‡ºåŠ› */
.email-output {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: 20px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.8;
  white-space: pre-wrap;
  margin: 16px 0;
  max-height: 400px;
  overflow-y: auto;
}

/* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
.minutes-upload-area.drag-over {
  background: var(--bg-tertiary);
  border-color: var(--primary-color);
  transform: scale(1.02);
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 1200px) {
  .cards-grid {
    grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
  }
}

@media (max-width: 768px) {
  .header {
    padding: 12px 16px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .header-left {
    gap: 12px;
  }

  .logo {
    font-size: 20px;
  }

  .tabs-nav {
    padding: 0 12px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .tab-nav-btn {
    padding: 12px 16px;
    font-size: 14px;
    white-space: nowrap;
  }

  .toolbar {
    padding: 12px 16px;
    flex-direction: column;
    align-items: stretch;
  }

  .toolbar-left {
    flex-direction: column;
  }

  .toolbar-right {
    justify-content: center;
  }

  .cards-container {
    padding: 12px;
  }

  .cards-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .project-card {
    padding: 16px;
  }

  .card-header {
    flex-direction: column;
    gap: 12px;
  }

  .card-title {
    font-size: 18px;
    flex-wrap: wrap;
  }

  .tasks-grid {
    grid-template-columns: 1fr;
  }

  .task-item {
    flex-wrap: wrap;
    gap: 8px;
  }

  .task-state-select {
    width: 100%;
    margin-top: 4px;
  }

  .modal-content {
    width: 95vw;
    max-height: 90vh;
  }

  .modal-body {
    padding: 16px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-input, .form-select, .select {
    font-size: 16px;
    padding: 12px;
  }

  .btn {
    padding: 12px 16px;
    font-size: 14px;
    min-height: 44px;
  }

  .btn-small {
    padding: 10px 14px;
    min-height: 40px;
  }

  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 1000;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    width: 280px;
  }

  .sidebar.open {
    transform: translateX(0);
  }

  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
  }

  .sidebar-overlay.show {
    display: block;
  }

  .sidebar-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: none;
    background: var(--primary-color);
    color: white;
    border-radius: 8px;
    font-size: 20px;
    cursor: pointer;
    margin-right: 8px;
  }

  .add-task-form {
    flex-direction: column;
  }

  .add-task-form input {
    width: 100%;
  }

  .designer-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 8px;
  }

  .designer-tab {
    flex-shrink: 0;
  }
}

@media (max-width: 480px) {
  .login-card {
    padding: 24px 20px;
  }

  .login-card h1 {
    font-size: 24px;
  }

  .header-right {
    gap: 8px;
  }

  .user-info {
    padding: 6px 10px;
    font-size: 13px;
  }

  .badge {
    padding: 4px 8px;
    font-size: 11px;
  }
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
.spinner {
  border: 3px solid var(--bg-secondary);
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 40px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
.draggable-row {
  cursor: move;
  transition: all 0.2s;
}

.draggable-row:hover {
  background: var(--bg-secondary);
}

.draggable-row.dragging {
  opacity: 0.5;
  background: var(--bg-hover);
}

.draggable-row.drag-over {
  border-top: 3px solid var(--primary-color);
}

.drag-handle {
  cursor: grab;
  color: var(--text-secondary);
  font-size: 18px;
  padding: 0 8px;
  user-select: none;
}

.drag-handle:active {
  cursor: grabbing;
}

/* ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
.context-menu {
  position: fixed;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  min-width: 180px;
  z-index: 10000;
  display: none;
  padding: 8px 0;
}
.context-menu.show { display: block; }
.context-menu-item {
  padding: 10px 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  color: var(--text-primary);
  transition: background 0.15s;
}
.context-menu-item:hover { background: var(--bg-secondary); }
.context-menu-item.danger { color: var(--error-color); }
.context-menu-divider { height: 1px; background: var(--border-color); margin: 4px 0; }

/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ - Premium Design */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  padding: 16px 20px;
  box-shadow: var(--shadow-xl);
  display: none;
  align-items: center;
  gap: 12px;
  z-index: 2000;
  max-width: 400px;
  border: 1px solid var(--border-color);
}

.toast.show {
  display: flex;
  animation: toastSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes toastSlideIn {
  from {
    transform: translateX(120%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 14px;
}

.toast-success {
  border-left: 4px solid var(--success-color);
}

.toast-success .toast-icon {
  background: var(--success-light);
  color: var(--success-color);
}

.toast-error {
  border-left: 4px solid var(--danger-color);
}

.toast-error .toast-icon {
  background: var(--danger-light);
  color: var(--danger-color);
}

.toast-warning {
  border-left: 4px solid var(--warning-color);
}

.toast-warning .toast-icon {
  background: var(--warning-light);
  color: var(--warning-color);
}

.toast-message {
  font-size: 14px;
  color: var(--text-primary);
  font-weight: 500;
  line-height: 1.4;
}

/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ - Premium Design */
.app-layout {
  display: flex;
  height: calc(100vh - 64px);
  overflow: hidden;
}

.sidebar {
  width: 280px;
  background: linear-gradient(180deg, white 0%, var(--bg-secondary) 100%);
  border-right: 1px solid var(--border-color);
  overflow-y: auto;
  flex-shrink: 0;
}

.sidebar::-webkit-scrollbar {
  width: 6px;
}

.sidebar::-webkit-scrollbar-track {
  background: transparent;
}

.sidebar::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 3px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

.sidebar-header {
  padding: 20px 16px;
  border-bottom: 1px solid var(--border-light);
}

.sidebar-section {
  padding: 16px;
  border-bottom: 1px solid var(--border-light);
}

.sidebar-section:last-child {
  border-bottom: none;
}

.sidebar-section-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 12px;
  padding-left: 4px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--transition-fast);
  margin-bottom: 2px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
}

.sidebar-item:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.sidebar-item.active {
  background: var(--primary-color);
  color: white;
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25);
}

.sidebar-item-label {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-item-icon {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.7;
}

.sidebar-item.active .sidebar-item-icon {
  opacity: 1;
}

.sidebar-item-count {
  font-size: 11px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: var(--radius-full);
  background: var(--bg-tertiary);
  color: var(--text-secondary);
}

.sidebar-item.active .sidebar-item-count {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

.sidebar-item-count.warning {
  background: var(--warning-light);
  color: var(--warning-color);
}

.sidebar-item-count.danger {
  background: var(--danger-light);
  color: var(--danger-color);
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ã‚µãƒ–ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ - Premium Design */
.sub-tabs-nav {
  display: flex;
  gap: 4px;
  padding: 12px 24px 0 24px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  overflow-x: auto;
}

.sub-tabs-nav::-webkit-scrollbar {
  height: 4px;
}

.sub-tabs-nav::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 2px;
}

.sub-tab-btn {
  padding: 12px 20px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  border-bottom: 2px solid transparent;
  transition: all var(--transition-fast);
  white-space: nowrap;
  position: relative;
}

.sub-tab-btn:hover {
  color: var(--primary-color);
  background: var(--primary-light);
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.sub-tab-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
  background: var(--primary-light);
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.sub-tab-panel {
  display: none;
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  max-height: calc(100vh - 180px);
}

.sub-tab-panel.active {
  display: block;
}

.table-container {
  overflow-y: auto;
  max-height: calc(100vh - 350px);
}

.cards-grid {
  overflow-y: auto;
  max-height: calc(100vh - 300px);
}

/* æ¥­è€…ã‚«ãƒ¼ãƒ‰ */
.vendor-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.vendor-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
  border-color: var(--primary-color);
}

.vendor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--bg-secondary);
}

.vendor-header h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.vendor-info {
  margin-bottom: 16px;
}

.vendor-info > div {
  padding: 6px 0;
  font-size: 14px;
  color: var(--text-secondary);
}

.vendor-info strong {
  color: var(--text-primary);
  font-weight: 600;
  min-width: 80px;
  display: inline-block;
}

.vendor-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* ===== åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ===== */
.analytics-container {
  padding: 24px;
  max-width: 1400px;
  margin: 0 auto;
}

.analytics-section {
  background: var(--bg-primary);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--border-light);
}

/* ãƒ¬ãƒãƒ¼ãƒˆ */
.report-buttons {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.report-preview {
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 24px;
}

.report-card {
  background: var(--bg-primary);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  border: 1px solid var(--border-color);
}

.report-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--primary);
}

.report-header h2 {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0;
  color: var(--text-primary);
}

.report-period {
  font-size: 0.875rem;
  color: var(--text-secondary);
  background: var(--bg-secondary);
  padding: 4px 12px;
  border-radius: 20px;
}

.report-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.report-stat-item {
  background: var(--bg-secondary);
  padding: 16px;
  border-radius: 10px;
  text-align: center;
}

.report-stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary);
}

.report-stat-label {
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-top: 4px;
}

.report-section {
  margin-top: 20px;
}

.report-section-title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.report-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.report-list-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-radius: 8px;
  margin-bottom: 8px;
}

.report-list-item:last-child {
  margin-bottom: 0;
}

.report-project-name {
  font-weight: 500;
  color: var(--text-primary);
}

.report-project-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.875rem;
}

.report-progress-badge {
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

.report-progress-badge.high { background: #dcfce7; color: #166534; }
.report-progress-badge.medium { background: #fef9c3; color: #854d0e; }
.report-progress-badge.low { background: #fee2e2; color: #991b1b; }

.report-assignee {
  color: var(--text-secondary);
}

.report-empty {
  text-align: center;
  padding: 20px;
  color: var(--text-secondary);
  font-style: italic;
}

/* æ‹…å½“è€…åˆ¥ãƒ¬ãƒãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
.report-designer-section {
  background: var(--bg-primary);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid var(--border-color);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
}

.report-designer-section:last-child {
  margin-bottom: 0;
}

.report-designer-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-bottom: 12px;
  margin-bottom: 12px;
  border-bottom: 1px solid var(--border-color);
}

.report-designer-name {
  font-weight: 600;
  font-size: 1rem;
  color: var(--text-primary);
}

.report-designer-count {
  background: var(--primary);
  color: white;
  font-size: 0.75rem;
  padding: 2px 10px;
  border-radius: 12px;
}

.report-project-detail {
  background: var(--bg-secondary);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  border-left: 3px solid var(--primary);
}

.report-project-detail:last-child {
  margin-bottom: 0;
}

.report-project-detail.updated {
  border-left-color: var(--success-color);
  background: linear-gradient(90deg, rgba(16, 185, 129, 0.05), var(--bg-primary));
}

.report-project-title {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.report-project-title .project-name {
  font-weight: 600;
  color: var(--text-primary);
}

.report-updated-badge {
  background: var(--success-color);
  color: white;
  font-size: 0.65rem;
  padding: 2px 6px;
  border-radius: 8px;
}

.report-status-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.report-status-tag {
  font-size: 0.75rem;
  padding: 3px 8px;
  border-radius: 6px;
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.report-status-tag.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

/* ===== ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ„ã‚¢ãƒ¼ ===== */
.tour-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 9998;
  pointer-events: none;
}

.tour-highlight {
  position: relative;
  z-index: 9999 !important;
  box-shadow: 0 0 0 4px var(--primary), 0 0 20px rgba(37, 99, 235, 0.5);
  border-radius: 8px;
  pointer-events: auto;
}

.tour-tooltip {
  position: fixed;
  z-index: 10000;
  background: white;
  border-radius: 12px;
  padding: 20px;
  max-width: 360px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  animation: tourFadeIn 0.3s ease;
}

@keyframes tourFadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.tour-tooltip::before {
  content: '';
  position: absolute;
  width: 12px;
  height: 12px;
  background: white;
  transform: rotate(45deg);
}

.tour-tooltip.arrow-top::before { top: -6px; left: 24px; }
.tour-tooltip.arrow-bottom::before { bottom: -6px; left: 24px; }
.tour-tooltip.arrow-left::before { left: -6px; top: 24px; }
.tour-tooltip.arrow-right::before { right: -6px; top: 24px; }

.tour-step-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 12px;
}

.tour-step-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #E2E8F0;
}

.tour-step-dot.active {
  background: var(--primary);
  width: 24px;
  border-radius: 4px;
}

.tour-step-dot.completed {
  background: var(--success-color);
}

.tour-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.tour-content {
  font-size: 0.9rem;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 16px;
}

.tour-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}

.tour-btn {
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.tour-btn-skip {
  background: transparent;
  color: var(--text-secondary);
}

.tour-btn-skip:hover {
  color: var(--text-primary);
}

.tour-btn-prev {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.tour-btn-prev:hover {
  background: #E2E8F0;
}

.tour-btn-next {
  background: var(--primary);
  color: white;
}

.tour-btn-next:hover {
  background: #1D4ED8;
}

.tour-welcome {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10000;
  background: white;
  border-radius: 16px;
  padding: 32px;
  max-width: 420px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: tourFadeIn 0.3s ease;
}

.tour-welcome-icon {
  font-size: 3rem;
  margin-bottom: 16px;
}

.tour-welcome h2 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.tour-welcome p {
  color: var(--text-secondary);
  margin-bottom: 24px;
  line-height: 1.6;
}

.tour-welcome-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
}

/* ===== ArchiDeck v3.0 æ–°æ©Ÿèƒ½ã‚¹ã‚¿ã‚¤ãƒ« ===== */

/* 5éƒ¨æ§‹æˆã‚«ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - Premium Design */
.card-section {
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  margin-bottom: 12px;
  overflow: hidden;
  background: var(--bg-primary);
  transition: all var(--transition-fast);
}

.card-section:hover {
  border-color: var(--border-color);
}

.card-section:last-child {
  margin-bottom: 0;
}

.card-section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  background: var(--bg-secondary);
  cursor: pointer;
  user-select: none;
  transition: all var(--transition-fast);
  border-bottom: 1px solid transparent;
}

.card-section-header:hover {
  background: var(--bg-tertiary);
}

.card-section:not(.collapsed) .card-section-header {
  border-bottom-color: var(--border-light);
}

.card-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-section-icon {
  width: 28px;
  height: 28px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  background: var(--primary-light);
  color: var(--primary-color);
}

.card-section:nth-child(2) .card-section-icon {
  background: var(--accent-light);
  color: var(--accent-color);
}

.card-section:nth-child(3) .card-section-icon {
  background: var(--warning-light);
  color: var(--warning-color);
}

.card-section:nth-child(4) .card-section-icon {
  background: var(--info-light);
  color: var(--info-color);
}

.card-section:nth-child(5) .card-section-icon {
  background: var(--success-light);
  color: var(--success-color);
}

.card-section-toggle {
  font-size: 10px;
  color: var(--text-muted);
  transition: transform var(--transition-fast);
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-sm);
}

.card-section-header:hover .card-section-toggle {
  background: var(--bg-hover);
}

.card-section.collapsed .card-section-toggle {
  transform: rotate(-90deg);
}

.card-section-content {
  padding: 18px;
  display: block;
  background: var(--bg-primary);
}

.card-section.collapsed .card-section-content {
  display: none;
}

/* ã‚¿ã‚¹ã‚¯æ©Ÿèƒ½ */
.project-task-list {
  margin-top: 12px;
}

.project-task-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  transition: all 0.2s;
}

.project-task-item.completed {
  opacity: 0.5;
  background: #f5f5f5;
}

.project-task-item.completed .project-task-name {
  text-decoration: line-through;
  color: var(--text-muted);
}

.project-task-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
}

.project-task-name {
  flex: 1;
  font-size: 14px;
}

.project-task-due {
  font-size: 12px;
  color: var(--text-muted);
  padding: 2px 8px;
  background: var(--bg-tertiary);
  border-radius: 12px;
}

.project-task-due.overdue {
  background: #ffe5e5;
  color: var(--danger-color);
}

.add-task-form {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.add-task-form input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 13px;
}

/* å…±æœ‰ãƒ¡ãƒ¢æ¬„ */
.shared-memo-area {
  width: 100%;
  min-height: 80px;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 14px;
  resize: vertical;
  font-family: inherit;
}

/* è­°äº‹éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.minutes-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.minutes-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
}

.minutes-item-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.minutes-upload-area {
  border: 2px dashed var(--border-color);
  border-radius: var(--radius-md);
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.minutes-upload-area:hover {
  border-color: var(--primary-color);
  background: #f8fbff;
}

/* å¼•ç¶™æ›¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.handover-content {
  width: 100%;
  min-height: 120px;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 14px;
  resize: vertical;
  font-family: inherit;
}

/* ã‚µã‚¤ãƒ‰ãƒãƒ¼æ‹…å½“è€…è‰²åˆ†ã‘ */
.sidebar-item-count.count-blue {
  background: #e3f2fd;
  color: #1976d2;
}

.sidebar-item-count.count-yellow {
  background: #fff8e1;
  color: #f57c00;
}

.sidebar-item-label.name-red {
  color: #d32f2f;
  font-weight: 700;
}

/* ã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒœã‚¿ãƒ³ */
.sidebar-task-btn {
  padding: 4px 8px;
  font-size: 11px;
  background: var(--bg-tertiary);
  border: none;
  border-radius: 12px;
  cursor: pointer;
  margin-left: 8px;
}

.sidebar-task-btn:hover {
  background: var(--primary-color);
  color: white;
}

/* ã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« */
.task-list-modal {
  max-height: 70vh;
  overflow-y: auto;
}

.task-list-group {
  margin-bottom: 24px;
}

.task-list-group-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-color);
}

/* ç”³è«‹GOãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ– */
.task-item-btn.disabled {
  opacity: 0.4;
  cursor: not-allowed;
  pointer-events: none;
}

.task-item-btn.disabled:hover {
  transform: none;
}

/* kintoneé€£æºè¡¨ç¤º */
.kintone-info {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.kintone-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: #e8f5e9;
  color: #2e7d32;
  border-radius: 12px;
  font-size: 12px;
}

/* é€šçŸ¥ãƒãƒƒã‚¸ */
.notification-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--danger-color);
  color: white;
  font-size: 10px;
  font-weight: 700;
  min-width: 18px;
  height: 18px;
  border-radius: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
}


/* ============================================
   ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
   ============================================ */
.skeleton-line,
.skeleton-circle {
  background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-hover) 50%, var(--bg-tertiary) 75%);
  background-size: 200% 100%;
  animation: skeleton-shimmer 1.5s infinite;
  border-radius: 4px;
}

.skeleton-circle {
  border-radius: 50%;
}

@keyframes skeleton-shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.skeleton-card {
  padding: 20px;
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-color);
}

.animate-pulse {
  animation: pulse-opacity 2s ease-in-out infinite;
}

@keyframes pulse-opacity {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ============================================
   ãƒ¢ãƒã‚¤ãƒ«è¿½åŠ æ”¹å–„
   ============================================ */
@media (max-width: 768px) {
  /* ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆæœ€é©åŒ– */
  .btn, button, a.btn {
    min-height: 44px;
    min-width: 44px;
  }

  /* ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›æ‹¡å¤§ */
  input, select, textarea {
    font-size: 16px !important; /* iOS zoomé˜²æ­¢ */
  }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ç”»é¢åŒ– */
  .modal-content {
    width: 100vw;
    height: 100vh;
    max-height: 100vh;
    border-radius: 0;
    margin: 0;
  }

  .modal {
    padding: 0;
  }

  /* ã‚«ãƒ¼ãƒ‰å†…ãƒœã‚¿ãƒ³é…ç½® */
  .card-actions {
    flex-direction: column;
    width: 100%;
  }

  .card-actions .btn {
    width: 100%;
    justify-content: center;
  }

  /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* æ¤œç´¢ãƒãƒ¼ */
  .search-box {
    width: 100%;
  }

  /* ãƒœãƒˆãƒ ãƒŠãƒ“ç”¨ã‚¹ãƒšãƒ¼ã‚¹ */
  .main-content {
    padding-bottom: 80px;
  }

  /* ã‚¿ã‚¹ã‚¯ã‚¢ã‚¤ãƒ†ãƒ æ”¹å–„ */
  .task-item {
    padding: 12px;
    gap: 8px;
  }

  .task-label {
    font-size: 14px;
    flex: 1;
    min-width: 0;
  }

  .task-state-select {
    font-size: 13px;
    min-width: 100px;
  }

  .task-email-btn {
    min-width: 36px;
    min-height: 36px;
  }

  /* æ—¥ä»˜å…¥åŠ›æ”¹å–„ */
  .task-due-input {
    min-width: 130px;
  }

  /* æœˆå ±ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
  .report-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .report-header h2 {
    font-size: 1.25rem;
  }

  .report-stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .report-stat-value {
    font-size: 1.5rem;
  }

  .report-designer-section {
    padding: 12px;
  }

  .report-designer-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .report-project-title {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }

  .report-project-title .project-name {
    word-break: break-word;
  }

  .report-status-list {
    gap: 4px;
  }

  .report-status-tag {
    font-size: 0.65rem;
    padding: 2px 6px;
  }

  .report-list-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
}

/* è¶…å°ç”»é¢å¯¾å¿œ */
@media (max-width: 360px) {
  .header {
    padding: 8px 12px;
  }

  .logo {
    font-size: 18px;
  }

  .tab-nav-btn {
    padding: 10px 12px;
    font-size: 13px;
  }

  .project-card {
    padding: 12px;
  }

  .card-title {
    font-size: 16px;
  }
}

/* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å‘ã‘ãƒ›ãƒãƒ¼ç„¡åŠ¹åŒ– */
@media (hover: none) {
  .btn:hover,
  .project-card:hover,
  .task-item:hover {
    transform: none;
    box-shadow: inherit;
  }
}

/* ============================================
   ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ - Accessibility
   ============================================ */

/* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å°‚ç”¨ */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* ã‚¹ã‚­ãƒƒãƒ—ãƒªãƒ³ã‚¯ */
.skip-link {
  position: fixed;
  top: -100px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--primary-color);
  color: white;
  padding: 12px 24px;
  border-radius: var(--radius-md);
  z-index: 10001;
  font-weight: 600;
  text-decoration: none;
  transition: top 0.3s ease;
}

.skip-link:focus {
  top: 10px;
  outline: 3px solid var(--warning-color);
  outline-offset: 2px;
}

/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºã®å¼·åŒ– */
:focus-visible {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
}

button:focus-visible,
a:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
  box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
}

/* é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
@media (prefers-contrast: high) {
  :root {
    --text-primary: #000000;
    --text-secondary: #1a1a1a;
    --border-color: #000000;
  }

  .btn {
    border: 2px solid currentColor;
  }
}

/* å‹•ãã‚’æ¸›ã‚‰ã™ãƒ¢ãƒ¼ãƒ‰ */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }

  .loading-spinner {
    animation: none;
    border-color: var(--primary-color);
  }
}

/* ============================================
   å°åˆ·ã‚¹ã‚¿ã‚¤ãƒ« - Print Styles
   ============================================ */
@media print {
  /* éè¡¨ç¤ºè¦ç´  */
  .header,
  .sidebar,
  .tabs-nav,
  .btn,
  button,
  .modal-overlay,
  .skip-link,
  .status-indicator,
  .toast-container {
    display: none !important;
  }

  /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
  body {
    background: var(--bg-primary) !important;
    color: black !important;
    font-size: 12pt;
    line-height: 1.4;
  }

  /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
  .main-container,
  .app-layout,
  .main-content {
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* ã‚«ãƒ¼ãƒ‰ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ */
  .project-card {
    break-inside: avoid;
    page-break-inside: avoid;
    border: 1px solid #ccc !important;
    box-shadow: none !important;
    margin-bottom: 16pt !important;
  }

  /* ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
  .task-item {
    border-bottom: 1px solid #eee;
    padding: 8pt 0;
  }

  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã‚’ç™½é»’ã§ */
  .status-badge {
    border: 1px solid black !important;
    background: var(--bg-primary) !important;
    color: black !important;
  }

  /* ãƒªãƒ³ã‚¯ã«URLã‚’è¡¨ç¤º */
  a[href^="http"]:after {
    content: " (" attr(href) ")";
    font-size: 10pt;
    color: #666;
  }

  /* ãƒšãƒ¼ã‚¸è¨­å®š */
  @page {
    margin: 2cm;
    size: A4;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼ */
  .print-header {
    display: block !important;
    text-align: center;
    margin-bottom: 20pt;
    font-size: 18pt;
    font-weight: bold;
  }

  .print-footer {
    display: block !important;
    text-align: center;
    margin-top: 20pt;
    font-size: 10pt;
    color: #666;
  }
}
</style>
</head>
<body>

<!-- ã‚¹ã‚­ãƒƒãƒ—ãƒªãƒ³ã‚¯ï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼‰ -->
<a href="#mainContent" class="skip-link">ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã‚¹ã‚­ãƒƒãƒ—</a>

<!-- ãƒ©ã‚¤ãƒ–ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ï¼‰ -->
<div id="liveRegion" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
<div id="loginContainer" class="login-container">
  <div class="login-card">
    <h1>ArchiDeck</h1>
    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Gãƒã‚¦ã‚¹ è¨­è¨ˆæ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
    <p>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
    <form onsubmit="signIn(); return false;" style="margin-bottom: 20px;">
      <input type="email" class="form-input" id="loginEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width: 100%; margin-bottom: 12px;" inputmode="email">
      <input type="password" class="form-input" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width: 100%; margin-bottom: 12px;">
      <div style="text-align: right; margin-bottom: 16px;">
        <a href="#" onclick="showForgotPassword(); return false;" style="font-size: 13px; color: var(--primary-color);">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹</a>
      </div>
      <button type="submit" class="btn btn-primary" style="width: 100%;">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </form>
    <div id="forgotPasswordSection" style="display: none; margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="font-size: 13px; margin-bottom: 12px;">ç™»éŒ²æ¸ˆã¿ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šç”¨ã®ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã¾ã™ã€‚</p>
      <input type="email" class="form-input" id="forgotEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width: 100%; margin-bottom: 12px;">
      <button class="btn btn-primary" style="width: 100%; margin-bottom: 8px;" onclick="sendPasswordReset()">å†è¨­å®šãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡</button>
      <button class="btn btn-ghost" style="width: 100%;" onclick="hideForgotPassword()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
      <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">é–‹ç™ºä¸­ã®ãŸã‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç„¡ã—ã§ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½</p>
      <button class="btn btn-ghost" style="width: 100%;" onclick="enterDemoMode()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç„¡ã—ã§å…¥ã‚‹</button>
    </div>
  </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div id="mainContainer" class="main-container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header" role="banner" aria-label="ã‚µã‚¤ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼">
    <div class="header-left">
      <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
      <div class="logo">ArchiDeck</div>
    </div>
    <div class="header-right">
      <div class="status-indicator status-saved" id="statusIndicator">
        <span class="status-dot"></span>
        <span id="statusText">ä¿å­˜æ¸ˆã¿</span>
      </div>
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="" alt="">
        <span id="userName" class="user-name"></span>
      </div>
      <div style="position: relative;">
        <button class="btn btn-ghost btn-small" onclick="toggleCategorySwitcher()" id="categorySwitchBtn" style="display: none;">
          <span id="currentCategoryLabel">ğŸ“ è¨­è¨ˆ</span> â–¼
        </button>
        <div id="categorySwitchMenu" class="category-switch-menu" style="display: none;">
          <button onclick="switchCategory('è¨­è¨ˆ')">ğŸ“ è¨­è¨ˆæ‹…å½“</button>
          <button onclick="switchCategory('IC')">ğŸ¨ ICæ‹…å½“</button>
          <button onclick="switchCategory('å¤–æ§‹')">ğŸŒ³ å¤–æ§‹æ‹…å½“</button>
          <button onclick="switchCategory('admin')">ğŸ‘‘ ç®¡ç†è€…</button>
        </div>
      </div>
      <button class="btn btn-ghost btn-small" onclick="UndoManager.undo()" title="å…ƒã«æˆ»ã™ (Ctrl+Z)" id="undoBtn" disabled>â†©ï¸</button>
      <button class="btn btn-ghost btn-small" onclick="UndoManager.redo()" title="ã‚„ã‚Šç›´ã™ (Ctrl+Y)" id="redoBtn" disabled>â†ªï¸</button>
      <button class="btn btn-ghost btn-small" onclick="forceReloadData()" title="ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿">ğŸ”„</button>
      <button class="btn btn-ghost btn-small" onclick="AppTour.showWelcome()" title="ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰">â“</button>
      <button class="btn btn-ghost btn-small" onclick="showDebugInfo()" title="ãƒ‡ãƒãƒƒã‚°æƒ…å ±">ğŸ”</button>
      <button class="btn btn-ghost btn-small" onclick="signOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <!-- ã‚¢ãƒ—ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="app-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰ -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
      <div id="sidebarContent"></div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content" id="mainContent" role="main" aria-label="ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„">
      <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <nav class="tabs-nav">
        <button class="tab-nav-btn active" onclick="switchMainTab('projects', this)">ğŸ“‹ æ¡ˆä»¶ç®¡ç†</button>
        <button class="tab-nav-btn" onclick="switchMainTab('analytics', this)">ğŸ“Š åˆ†æ</button>
        <button class="tab-nav-btn" onclick="switchMainTab('settings', this)">âš™ï¸ è¨­å®š</button>
      </nav>

      <!-- æ¡ˆä»¶ç®¡ç†ã‚¿ãƒ– -->
      <div id="projectsTab" class="tab-panel active">
        <div class="toolbar">
          <div class="toolbar-left">
            <input type="text" class="input" id="searchQuery" placeholder="æ¤œç´¢... (Ctrl+K)" oninput="debouncedRenderProjects()" onfocus="updateSearchSuggestions()" list="searchSuggestions" aria-label="æ¡ˆä»¶ã‚’æ¤œç´¢" autocomplete="off">
            <datalist id="searchSuggestions"></datalist>
            <select class="select" id="specFilter" onchange="renderProjects()">
              <option value="">ã™ã¹ã¦ã®å•†å“</option>
              <option>LIFE</option>
              <option>LIFE+</option>
              <option>HOURS</option>
              <option>LACIE</option>
              <option>LIFE Limited</option>
              <option>LIFE+ Limited</option>
            </select>
            <select class="select" id="archiveFilter" onchange="renderProjects()" style="margin-left: 12px;">
              <option value="active">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿</option>
              <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
              <option value="archived">å®Œäº†æ¸ˆã¿ã®ã¿</option>
              <option value="favorites">â˜… ãŠæ°—ã«å…¥ã‚Š</option>
            </select>
          </div>
          <div class="toolbar-right">
            <div style="position: relative; display: inline-block;">
              <button id="presetBtn" class="btn btn-ghost btn-small" onclick="FilterPresets.toggleMenu()" title="ä¿å­˜æ¸ˆã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">ğŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆ â–¼</button>
              <div id="presetMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 280px; z-index: 100;">
                <div style="padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-weight: 600; font-size: 14px;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆ</span>
                  <button class="btn btn-primary btn-small" onclick="FilterPresets.showSaveModal(); document.getElementById('presetMenu').style.display='none';">+ ä¿å­˜</button>
                </div>
                <div id="presetDropdown" style="max-height: 300px; overflow-y: auto;"></div>
              </div>
            </div>
            <button class="btn btn-ghost btn-small" onclick="BatchOperations.selectAll()" title="å…¨ã¦é¸æŠ">â˜‘ å…¨é¸æŠ</button>
            <button class="btn btn-ghost" onclick="DataImporter.showModal()" title="CSV/JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ">ğŸ“¥ å–è¾¼</button>
            <button class="btn btn-ghost" onclick="exportCSV()" title="CSV/JSON/å°åˆ·å‡ºåŠ›">ğŸ“¤ å‡ºåŠ›</button>
            <button class="btn btn-primary" onclick="openProjectModal()">+ æ¡ˆä»¶è¿½åŠ </button>
      </div>
    </div>
    <div class="cards-container">
      <div class="cards-grid" id="projectsGrid"></div>
      <div class="empty-state" id="emptyProjects" style="display: none;">
        <div class="empty-icon">ğŸ“‹</div>
        <div class="empty-title">æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“</div>
        <div class="empty-description">ã€Œæ¡ˆä»¶è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ–°ã—ã„æ¡ˆä»¶ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
        <button class="btn btn-primary" onclick="openProjectModal()">+ æ¡ˆä»¶è¿½åŠ </button>
      </div>
    </div>
  </div>

      <!-- åˆ†æã‚¿ãƒ– -->
      <div id="analyticsTab" class="tab-panel">
        <div class="analytics-container">
          <!-- è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ -->
          <div class="analytics-section">
            <h3 class="section-title">ğŸ“ è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</h3>
            <div class="report-buttons">
              <button class="btn btn-primary" onclick="generateWeeklyReport()">ğŸ“Š é€±å ±ã‚’ç”Ÿæˆ</button>
              <button class="btn btn-ghost" onclick="generateMonthlyReport()">ğŸ“ˆ æœˆå ±ã‚’ç”Ÿæˆ</button>
              <button class="btn btn-ghost" onclick="exportAnalyticsCSV()">ğŸ“ CSVå‡ºåŠ›</button>
            </div>
            <div id="reportPreview" class="report-preview" style="display: none;"></div>
          </div>
        </div>
      </div>

      <!-- è¨­å®šã‚¿ãƒ– -->
      <div id="settingsTab" class="tab-panel">
        <!-- ã‚µãƒ–ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="sub-tabs-nav">
          <button class="sub-tab-btn active" onclick="switchSubTab('staff', this)">ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</button>
          <button class="sub-tab-btn" onclick="switchSubTab('vendors', this)">ğŸ¢ æ¥­è€…ãƒ»ãƒ¡ãƒ¼ãƒ«ç®¡ç†</button>
          <button class="sub-tab-btn" onclick="switchSubTab('categories', this)">ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªç®¡ç†</button>
          <button class="sub-tab-btn" onclick="switchSubTab('tasks', this)">ğŸ“ è¨­è¨ˆæ¥­å‹™ç®¡ç†</button>
          <button class="sub-tab-btn" onclick="switchSubTab('icTasks', this)">ğŸ¨ ICæ¥­å‹™ç®¡ç†</button>
          <button class="sub-tab-btn" onclick="switchSubTab('exteriorTasks', this)">ğŸŒ³ å¤–æ§‹æ¥­å‹™ç®¡ç†</button>
          <button class="sub-tab-btn" onclick="switchSubTab('products', this)">ğŸ“¦ å•†å“ç®¡ç†</button>
          <button class="sub-tab-btn" onclick="switchSubTab('customize', this)">ğŸ¨ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</button>
          <button class="sub-tab-btn" onclick="switchSubTab('kintone', this)">ğŸ”— kintoneé€£æº</button>
          <button class="sub-tab-btn" onclick="switchSubTab('backup', this)">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
          <button class="sub-tab-btn" onclick="switchSubTab('fcManagement', this)">ğŸª FCç®¡ç†</button>
        </nav>

        <!-- ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† -->
        <div id="staffPanel" class="sub-tab-panel active">
          <div style="max-width: 1000px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</h2>
            <div class="form-group">
              <label class="form-label">æ–°ã—ã„ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ </label>
              <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px;">
                <input type="text" class="form-input" id="newDesignerNameInline" placeholder="ã‚¹ã‚¿ãƒƒãƒ•å">
                <select class="form-select" id="newDesignerCategoryInline" style="width: 150px;">
                  <option value="è¨­è¨ˆ">è¨­è¨ˆæ‹…å½“</option>
                  <option value="IC">ICæ‹…å½“</option>
                  <option value="å¤–æ§‹">å¤–æ§‹æ‹…å½“</option>
                </select>
                <button class="btn btn-primary" onclick="addDesignerInline()">è¿½åŠ </button>
              </div>
            </div>
            <div id="designerListInline" style="margin-top: 24px;"></div>
          </div>
        </div>

        <!-- æ¥­è€…ç®¡ç† -->
        <div id="vendorsPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <div id="categoryFilters"></div>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openVendorModalV2()">+ æ¥­è€…è¿½åŠ </button>
            </div>
          </div>
          <div id="vendorsGrid" class="cards-grid"></div>
        </div>

        <!-- ã‚«ãƒ†ã‚´ãƒªç®¡ç† -->
        <div id="categoriesPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">æ¥­è€…ã‚«ãƒ†ã‚´ãƒªç®¡ç†</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">æ¥­è€…ã‚’åˆ†é¡ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚</p>
            <div class="form-group">
              <label class="form-label">æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ </label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="newCategoryNameInline" placeholder="ã‚«ãƒ†ã‚´ãƒªåï¼ˆä¾‹ï¼šé›»æ°—å·¥äº‹ï¼‰" style="flex: 1;">
                <button class="btn btn-primary" onclick="addCategoryInline()">è¿½åŠ </button>
              </div>
            </div>
            <div id="categoriesGrid" style="margin-top: 32px;"></div>
          </div>
        </div>

        <!-- è¨­è¨ˆæ¥­å‹™ç®¡ç† -->
        <div id="tasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">ğŸ“ è¨­è¨ˆã‚¿ã‚¹ã‚¯ç®¡ç†</h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openTaskModal('è¨­è¨ˆ')">+ è¨­è¨ˆã‚¿ã‚¹ã‚¯è¿½åŠ </button>
            </div>
          </div>
          <p style="margin-bottom: 16px; color: var(--text-secondary);">è¨­è¨ˆæ‹…å½“è€…ãŒä½¿ç”¨ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>
          <div id="tasksGrid"></div>
        </div>

        <!-- ICæ¥­å‹™ç®¡ç† -->
        <div id="icTasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">ğŸ¨ ICã‚¿ã‚¹ã‚¯ç®¡ç†</h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openTaskModal('IC')">+ ICã‚¿ã‚¹ã‚¯è¿½åŠ </button>
            </div>
          </div>
          <p style="margin-bottom: 16px; color: var(--text-secondary);">ICæ‹…å½“è€…ãŒä½¿ç”¨ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>
          <div id="icTasksGrid"></div>
        </div>

        <!-- å¤–æ§‹æ¥­å‹™ç®¡ç† -->
        <div id="exteriorTasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">ğŸŒ³ å¤–æ§‹æ¥­å‹™ã‚¿ã‚¹ã‚¯ç®¡ç†</h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openExteriorTaskModal()">+ å¤–æ§‹ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
            </div>
          </div>
          <p style="margin-bottom: 24px; color: var(--text-secondary);">å¤–æ§‹è¨­è¨ˆã®æ¥­å‹™ãƒ•ãƒ­ãƒ¼ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>
          <div id="exteriorTasksGrid"></div>
        </div>

        <!-- å•†å“ç®¡ç† -->
        <div id="productsPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">å•†å“ãƒã‚¹ã‚¿ç®¡ç†</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">æ¡ˆä»¶ã§é¸æŠã§ãã‚‹å•†å“ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>
            <div class="form-group">
              <label class="form-label">æ–°ã—ã„å•†å“ã‚’è¿½åŠ </label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="newProductNameInline" placeholder="å•†å“åï¼ˆä¾‹ï¼šLIFEã€LIFE+ã€HOURSï¼‰" style="flex: 1;">
                <button class="btn btn-primary" onclick="addProductInline()">è¿½åŠ </button>
              </div>
            </div>
            <div id="productsGrid" style="margin-top: 32px;"></div>
          </div>
        </div>

        <!-- ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º -->
        <div id="customizePanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">å¤–è¦³ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">ä¼šç¤¾ã®ãƒ–ãƒ©ãƒ³ãƒ‰ã«åˆã‚ã›ã¦ã‚·ã‚¹ãƒ†ãƒ ã®å¤–è¦³ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸è¦ã§ç°¡å˜ã«å¤‰æ›´ã§ãã¾ã™ã€‚</p>

            <div style="display: grid; grid-template-columns: 1fr 300px; gap: 32px;">
              <div>
                <div class="form-group">
                  <label class="form-label">ä¼šç¤¾å</label>
                  <input type="text" class="form-input" id="customOrgName" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«å·¥å‹™åº—" style="width: 100%;">
                  <div class="form-hint">ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
                </div>

                <div class="form-group">
                  <label class="form-label">ãƒ­ã‚´URL</label>
                  <input type="text" class="form-input" id="customLogoUrl" placeholder="https://example.com/logo.png" style="width: 100%;">
                  <div class="form-hint">æ¨å¥¨ã‚µã‚¤ã‚º: 150x40pxï¼ˆPNG/SVGå½¢å¼ï¼‰</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div class="form-group">
                    <label class="form-label">ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input type="color" id="customPrimaryColor" value="#2563EB" style="width: 50px; height: 40px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); cursor: pointer;">
                      <input type="text" class="form-input" id="customPrimaryColorText" value="#2563EB" style="flex: 1;" oninput="document.getElementById('customPrimaryColor').value = this.value">
                    </div>
                    <div class="form-hint">ãƒœã‚¿ãƒ³ã‚„ãƒªãƒ³ã‚¯ã®è‰²</div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input type="color" id="customSecondaryColor" value="#059669" style="width: 50px; height: 40px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); cursor: pointer;">
                      <input type="text" class="form-input" id="customSecondaryColorText" value="#059669" style="flex: 1;" oninput="document.getElementById('customSecondaryColor').value = this.value">
                    </div>
                    <div class="form-hint">æˆåŠŸçŠ¶æ…‹ã‚„ã‚µãƒ–ãƒœã‚¿ãƒ³ã®è‰²</div>
                  </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                  <button class="btn btn-primary" onclick="saveCustomization()">ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚’ä¿å­˜</button>
                  <button class="btn btn-ghost" onclick="previewCustomization()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                  <button class="btn btn-ghost" onclick="resetCustomization()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>

                <div id="customizeStatus" style="margin-top: 16px;"></div>
              </div>

              <div style="padding: 20px; background: var(--bg-secondary); border-radius: var(--radius-lg); height: fit-content;">
                <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div id="customizePreview" style="padding: 16px; background: var(--bg-primary); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <div id="previewLogo" style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">ğŸ </div>
                    <span id="previewTitle" style="font-weight: 600; font-size: 14px;">ArchiDeck</span>
                  </div>
                  <button class="btn btn-primary btn-small" style="margin-right: 8px;">ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³</button>
                  <button class="btn btn-secondary btn-small">ã‚µãƒ–ãƒœã‚¿ãƒ³</button>
                </div>
              </div>
            </div>

            <div style="margin-top: 32px; padding: 16px; background: var(--primary-light); border-radius: var(--radius-md); border-left: 4px solid var(--primary-color);">
              <h4 style="font-size: 14px; font-weight: 600; color: var(--primary-color); margin-bottom: 8px;">ãƒ’ãƒ³ãƒˆ</h4>
              <ul style="font-size: 13px; color: var(--text-secondary); margin: 0; padding-left: 20px;">
                <li>ãƒ­ã‚´ã¯URLã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ç”»åƒã‚’ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</li>
                <li>ã‚«ãƒ©ãƒ¼ã¯ä¼šç¤¾ã®ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ã«åˆã‚ã›ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™</li>
                <li>å¤‰æ›´ã¯ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã§ç¢ºèªã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- kintoneé€£æº -->
        <div id="kintonePanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">kintoneé€£æºè¨­å®š</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">kintoneã¨é€£æºã—ã¦ã€é‚¸åãƒ»é–“å–ç¢ºå®šæ—¥ãƒ»ç€å·¥è¨±å¯ãƒ»å¤‰æ›´å¥‘ç´„å‰ä¼šè­°ã®æƒ…å ±ã‚’åŒæœŸã—ã¾ã™ã€‚</p>

            <div class="form-group">
              <label class="form-label">kintone ãƒ‰ãƒ¡ã‚¤ãƒ³</label>
              <input type="text" class="form-input" id="kintoneDomain" placeholder="ä¾‹ï¼šyour-company.cybozu.com" style="width: 100%;">
            </div>

            <div class="form-group">
              <label class="form-label">ã‚¢ãƒ—ãƒªID</label>
              <input type="text" class="form-input" id="kintoneAppId" placeholder="ä¾‹ï¼š123" style="width: 100%;">
            </div>

            <div class="form-group">
              <label class="form-label">APIãƒˆãƒ¼ã‚¯ãƒ³</label>
              <input type="password" class="form-input" id="kintoneApiToken" placeholder="APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›" style="width: 100%;">
              <div class="form-hint" style="font-size: 11px; margin-top: 4px;">kintoneã‚¢ãƒ—ãƒªã®è¨­å®šã‹ã‚‰APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¦ãã ã•ã„</div>
            </div>

            <div style="margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
              <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">é‚¸åãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</label>
                  <input type="text" class="form-input" id="kintoneFieldCustomer" placeholder="customer_name" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">é–“å–ç¢ºå®šæ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</label>
                  <input type="text" class="form-input" id="kintoneFieldLayout" placeholder="layout_confirmed_date" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">ç€å·¥è¨±å¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</label>
                  <input type="text" class="form-input" id="kintoneFieldPermit" placeholder="construction_permit" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">å¤‰æ›´å¥‘ç´„å‰ä¼šè­°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</label>
                  <input type="text" class="form-input" id="kintoneFieldMeeting" placeholder="pre_contract_meeting" style="width: 100%;">
                </div>
              </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button class="btn btn-primary" onclick="saveKintoneSettings()">è¨­å®šã‚’ä¿å­˜</button>
              <button class="btn btn-ghost" onclick="testKintoneConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            </div>

            <div id="kintoneStatus" style="margin-top: 16px;"></div>

            <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border-color);">
              <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">ãƒ‡ãƒ¼ã‚¿é€£æº</h3>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-ghost" onclick="importFromKintone()">ğŸ“¥ kintoneã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆCSVï¼‰</button>
                <button class="btn btn-ghost" onclick="exportToKintone()">ğŸ“¤ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
              </div>
              <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">
                kintoneã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™ã€‚<br>
                é¡§å®¢å/é‚¸åã€å»ºç¯‰åœ°ã€ãƒ¬ã‚³ãƒ¼ãƒ‰IDã‚«ãƒ©ãƒ ãŒè‡ªå‹•èªè­˜ã•ã‚Œã¾ã™ã€‚
              </p>
            </div>
          </div>
        </div>

        <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— -->
        <div id="backupPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒã§ãã¾ã™ã€‚è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚‚åˆ©ç”¨å¯èƒ½ã§ã™ã€‚</p>

            <!-- è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š -->
            <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #e0f2fe, #dbeafe); border-radius: var(--radius-md);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <div>
                  <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 4px;">ğŸ”„ è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã«è‡ªå‹•ã§ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã™</p>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px;">
                <div>æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: <strong id="lastBackupTime">-</strong></div>
                <div>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä»¶æ•°: <strong id="localBackupCount">0</strong>ä»¶</div>
                <button class="btn btn-secondary btn-small" onclick="downloadLocalBackup()">ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
              <div style="padding: 24px; background: var(--bg-secondary); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¤</div>
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™</p>
                <button class="btn btn-primary" onclick="createBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ</button>
              </div>

              <div style="padding: 24px; background: var(--bg-secondary); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¥</div>
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒ</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™</p>
                <button class="btn btn-ghost" onclick="restoreBackup()">å¾©å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
              </div>
            </div>

            <div style="margin-top: 32px; padding: 16px; background: rgba(245, 166, 35, 0.1); border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
              <h4 style="font-size: 14px; font-weight: 600; color: var(--warning-color); margin-bottom: 8px;">âš ï¸ æ³¨æ„äº‹é …</h4>
              <ul style="font-size: 13px; color: var(--text-secondary); margin: 0; padding-left: 20px;">
                <li>å¾©å…ƒã‚’è¡Œã†ã¨æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™</li>
                <li>å¾©å…ƒå‰ã«å¿…ãšç¾åœ¨ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¦ãã ã•ã„</li>
                <li>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã¯å®‰å…¨ãªå ´æ‰€ã«ä¿ç®¡ã—ã¦ãã ã•ã„</li>
                <li>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆæœ€å¤§5MBï¼‰</li>
              </ul>
            </div>

            <div id="backupStatus" style="margin-top: 24px;"></div>
          </div>
        </div>

        <!-- FCç®¡ç† -->
        <div id="fcManagementPanel" class="sub-tab-panel">
          <div style="max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <div>
                <h2 style="margin: 0; font-size: 24px; font-weight: 700;">ğŸª FCï¼ˆãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚ºï¼‰ç®¡ç†</h2>
                <p style="margin: 8px 0 0; color: var(--text-secondary);">FCå…ˆã«ãƒ›ãƒ¯ã‚¤ãƒˆãƒ©ãƒ™ãƒ«ç‰ˆã‚’ç™ºè¡Œãƒ»ç®¡ç†ã§ãã¾ã™ã€‚</p>
              </div>
              <button class="btn btn-primary" onclick="openFcModal()">+ FCè¿½åŠ </button>
            </div>

            <div class="card" style="margin-bottom: 24px; padding: 20px;">
              <h3 style="margin: 0 0 12px; font-size: 16px;">FCå°‚ç”¨URLã«ã¤ã„ã¦</h3>
              <p style="margin: 0; color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
                FCå…ˆã«ã¯å°‚ç”¨ã®URLãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚<br>
                ä¾‹: <code style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px;">https://nandemo-nu.vercel.app/fc/tokyo-fc/</code><br>
                FCå°‚ç”¨URLã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€Gãƒã‚¦ã‚¹ã®ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãŒéè¡¨ç¤ºã«ãªã‚Šã€è¨­å®šã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚´ãƒ»ã‚«ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
              </p>
            </div>

            <div id="fcListContainer">
              <div class="empty-state">
                <div class="empty-icon">ğŸª</div>
                <p>FCãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br><small>ã€Œ+ FCè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„</small></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ¡ˆä»¶è¿½åŠ /ç·¨é›† -->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="projectModalTitle">æ¡ˆä»¶è¿½åŠ </h2>
      <button class="close" onclick="closeProjectModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ãŠå®¢æ§˜å *</label>
        <input type="text" class="form-input" id="projectCustomer" placeholder="ä¾‹ï¼šç”°ä¸­å¤ªéƒæ§˜">
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
        <div class="form-group">
          <label class="form-label">æ‹…å½“ï¼ˆè¨­è¨ˆï¼‰ *</label>
          <select class="form-select" id="projectAssignedTo"></select>
        </div>
        <div class="form-group">
          <label class="form-label">æ‹…å½“ï¼ˆICï¼‰</label>
          <select class="form-select" id="projectIcAssignee">
            <option value="">æœªå®š</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">æ‹…å½“ï¼ˆå¤–æ§‹ï¼‰</label>
          <select class="form-select" id="projectExteriorAssignee">
            <option value="">æœªå®š</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">å•†å“</label>
        <select class="form-select" id="projectSpecifications"></select>
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¢</label>
        <textarea class="form-textarea" id="projectMemo" placeholder="è¦æœ›ãƒ»æ³¨æ„ç‚¹ãªã©"></textarea>
      </div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: space-between;">
      <div id="templateButtons" style="display: none;">
        <button class="btn btn-ghost btn-small" onclick="TemplateManager.createFromProject(editingProjectId)" title="ç¾åœ¨ã®è¨­å®šã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜</button>
        <button class="btn btn-ghost btn-small" onclick="TemplateManager.showSelectModal(editingProjectId)" title="ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨</button>
      </div>
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-ghost" onclick="closeProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveProject()">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ /ç·¨é›† -->
<div id="templateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="templateModalTitle">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ </h2>
      <button class="close" onclick="closeTemplateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID *</label>
        <input type="text" class="form-input" id="templateId" placeholder="ä¾‹ï¼šnew-template">
        <div class="form-hint">è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨å¯èƒ½</div>
      </div>
      <div class="form-group">
        <label class="form-label">è¡¨ç¤ºå *</label>
        <input type="text" class="form-input" id="templateDisplayName" placeholder="ä¾‹ï¼šæ–°ä¼šç¤¾åï¼ˆä½œæ¥­å†…å®¹ï¼‰">
      </div>
      <div class="form-group">
        <label class="form-label">ã‚«ãƒ†ã‚´ãƒª *</label>
        <select class="form-select" id="templateCategory">
          <option value="è¨­è¨ˆ">è¨­è¨ˆ</option>
          <option value="IC">IC</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ä¼šç¤¾å *</label>
        <input type="text" class="form-input" id="templateCompany" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ã€‡ã€‡">
      </div>
      <div class="form-group">
        <label class="form-label">å®›å…ˆå</label>
        <input type="text" class="form-input" id="templateContact" placeholder="ä¾‹ï¼šç”°ä¸­æ§˜">
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="text" class="form-input" id="templateEmail" placeholder="ä¾‹ï¼štanaka@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">ä»¶åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ *</label>
        <input type="text" class="form-input" id="templateSubjectFormat" placeholder="ä¾‹ï¼š{customerName}æ§˜ æ–°è¦ã€‡ã€‡ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}">
        <div class="form-hint">ä½¿ç”¨å¯èƒ½ï¼š{customerName}, {dueDate}, {staffName}</div>
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ *</label>
        <textarea class="form-textarea" id="templateText" rows="10" placeholder="ä¾‹:&#10;{company}&#10;{contact}&#10;&#10;ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚"></textarea>
        <div class="form-hint">ä½¿ç”¨å¯èƒ½ï¼š{company}, {contact}, {customerName}, {dueDate}, {staffName}, {specialContent}</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTemplateModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveTemplate()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† -->
<div id="designerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</h2>
      <button class="close" onclick="closeDesignerModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">æ–°ã—ã„ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ </label>
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px;">
          <input type="text" class="form-input" id="newDesignerName" placeholder="ã‚¹ã‚¿ãƒƒãƒ•å">
          <select class="form-select" id="newDesignerCategory" style="width: 150px;">
            <option value="è¨­è¨ˆ">è¨­è¨ˆæ‹…å½“</option>
            <option value="IC">ICæ‹…å½“</option>
          </select>
          <button class="btn btn-primary" onclick="addDesigner()">è¿½åŠ </button>
        </div>
      </div>
      <div id="designerList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeDesignerModal()">å®Œäº†</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒ¡ãƒ¼ãƒ«ä½œæˆ -->
<div id="emailModal" class="modal">
  <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ä½œæˆ</h2>
      <button class="close" onclick="closeEmailModal()">&times;</button>
    </div>
    <div class="modal-body" id="emailComposerContent"></div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ¥­è€…è¿½åŠ /ç·¨é›†V2 -->
<div id="vendorModalV2" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title" id="vendorModalTitle">æ¥­è€…è¿½åŠ </h2>
      <button class="close" onclick="closeVendorModalV2()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="vendorForm">
        <input type="hidden" id="vendorId">

        <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">åŸºæœ¬æƒ…å ±</h3>

        <div class="form-group">
          <label class="form-label">ä¼šç¤¾å *</label>
          <input type="text" class="form-input" id="vendorCompany" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ã€‡ã€‡" required>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">æ‹…å½“è€…å</label>
            <input type="text" class="form-input" id="vendorContact" placeholder="ä¾‹ï¼šç”°ä¸­æ§˜">
          </div>

          <div class="form-group">
            <label class="form-label">é›»è©±ç•ªå·</label>
            <input type="text" class="form-input" id="vendorTel" placeholder="ä¾‹ï¼š090-1234-5678">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="email" class="form-input" id="vendorEmail" placeholder="ä¾‹ï¼štanaka@example.com">
          </div>

          <div class="form-group">
            <label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
            <select class="form-select" id="vendorCategory"></select>
          </div>
        </div>

        <h3 style="margin: 24px 0 16px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>

        <div class="form-group">
          <label class="form-label">ä»¶åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</label>
          <input type="text" class="form-input" id="vendorSubject" placeholder="ä¾‹ï¼š{customerName}æ§˜ æ–°è¦ã€‡ã€‡ä½œæˆä¾é ¼ã€€æœŸæ—¥{dueDate}">
          <div class="form-hint">ä½¿ç”¨å¯èƒ½ï¼š{customerName}, {dueDate}, {staffName}</div>
        </div>

        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡</label>
          <textarea class="form-textarea" id="vendorTemplate" rows="8" placeholder="ä¾‹:&#10;{company}&#10;{contact}&#10;&#10;ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚"></textarea>
          <div class="form-hint">ä½¿ç”¨å¯èƒ½ï¼š{company}, {contact}, {customerName}, {dueDate}, {staffName}</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeVendorModalV2()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveVendorV2()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ‹…å½“è€…ã‚¿ã‚¹ã‚¯ä¸€è¦§ -->
<div id="staffTasksModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="staffTasksModalTitle">ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
      <button class="close" onclick="closeStaffTasksModal()">&times;</button>
    </div>
    <div class="modal-body task-list-modal">
      <div style="margin-bottom: 16px; display: flex; gap: 8px;">
        <button class="btn btn-small btn-ghost" id="sortByDueBtn" onclick="sortTasksBy('due')">æœŸé™é †</button>
        <button class="btn btn-small btn-ghost" id="sortByProjectBtn" onclick="sortTasksBy('project')">é‚¸åé †</button>
      </div>
      <div id="staffTasksList"></div>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚«ãƒ†ã‚´ãƒªè¿½åŠ /ç·¨é›† -->
<div id="categoryModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="categoryModalTitle">ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </h2>
      <button class="close" onclick="closeCategoryModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="categoryForm">
        <input type="hidden" id="categoryId">

        <div class="form-group">
          <label class="form-label">ã‚«ãƒ†ã‚´ãƒªå *</label>
          <input type="text" class="form-input" id="categoryName" placeholder="ä¾‹ï¼šè¨­å‚™" required>
        </div>

        <div class="form-group">
          <label class="form-label">è¡¨ç¤ºé †</label>
          <input type="number" class="form-input" id="categoryOrder" placeholder="1" min="1">
          <div class="form-hint">å°ã•ã„æ•°å­—ã»ã©å…ˆã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeCategoryModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveCategory()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›† -->
<div id="taskModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="taskModalTitle">ã‚¿ã‚¹ã‚¯è¿½åŠ </h2>
      <button class="close" onclick="closeTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="taskForm">
        <input type="hidden" id="taskId">
        <input type="hidden" id="taskKey">

        <div class="form-group">
          <label class="form-label">ã‚¿ã‚¹ã‚¯å *</label>
          <input type="text" class="form-input" id="taskName" placeholder="ä¾‹ï¼š0å›ç›®æ‰“åˆã›" required>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">ã‚«ãƒ†ã‚´ãƒª *</label>
            <select class="form-select" id="taskCategory" required>
              <option value="è¨­è¨ˆ">è¨­è¨ˆ</option>
              <option value="IC">IC</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">è¡¨ç¤ºé †</label>
            <input type="number" class="form-input" id="taskOrder" placeholder="1" min="1">
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="taskHasState" onchange="toggleTaskState()">
            <span>çŠ¶æ…‹ç®¡ç†ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
          </label>
          <div class="form-hint">ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã€Œä¾é ¼æ¸ˆã€ã€Œä¿å­˜æ¸ˆã€ãªã©ã®çŠ¶æ…‹ã‚’é¸æŠå¯èƒ½ã«ãªã‚Šã¾ã™</div>
        </div>

        <div id="stateOptionsGroup" style="display: none;">
          <div class="form-group">
            <label class="form-label">çŠ¶æ…‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆJSONé…åˆ—ï¼‰</label>
            <input type="text" class="form-input" id="taskStateOptions" placeholder='ä¾‹ï¼š["", "ä¾é ¼æ¸ˆ", "ä¿å­˜æ¸ˆ"]'>
            <div class="form-hint">JSONé…åˆ—å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚æœ€åˆã®è¦ç´ ã¯ç©ºæ–‡å­—åˆ—("")ã‚’æ¨å¥¨</div>
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="taskHasEmailButton">
            <span>ğŸ“§ ãƒ¡ãƒ¼ãƒ«ä½œæˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹</span>
          </label>
          <div class="form-hint">ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ã®ã‚¿ã‚¹ã‚¯ã«ğŸ“§ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>

        <div class="form-group">
          <label class="form-label">ç´ã¥ã‘æ¥­è€…ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <div id="taskVendorSelection" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
            <!-- ãƒ™ãƒ³ãƒ€ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
          </div>
          <div class="form-hint">ã“ã®ã‚¿ã‚¹ã‚¯ã‹ã‚‰ç›´æ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveTask()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šFCè¿½åŠ /ç·¨é›† -->
<div id="fcModal" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title" id="fcModalTitle">FCè¿½åŠ </h2>
      <button class="close" onclick="closeFcModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="fcForm">
        <input type="hidden" id="fcId">

        <div class="form-group">
          <label class="form-label">FCå *</label>
          <input type="text" class="form-input" id="fcName" placeholder="ä¾‹ï¼šæ±äº¬ãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚º" required>
        </div>

        <div class="form-group">
          <label class="form-label">URLã‚¹ãƒ©ãƒƒã‚° *</label>
          <input type="text" class="form-input" id="fcSlug" placeholder="ä¾‹ï¼štokyo-fc" required pattern="[a-z0-9-]+" title="åŠè§’è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨å¯èƒ½">
          <div class="form-hint">åŠè§’è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ã€‚ä¾‹: tokyo-fc â†’ /fc/tokyo-fc/ ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">é€£çµ¡å…ˆãƒ¡ãƒ¼ãƒ«</label>
            <input type="email" class="form-input" id="fcEmail" placeholder="contact@example.com">
          </div>
          <div class="form-group">
            <label class="form-label">é€£çµ¡å…ˆé›»è©±</label>
            <input type="tel" class="form-input" id="fcTel" placeholder="03-1234-5678">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼</label>
          <div style="display: flex; gap: 12px; align-items: center;">
            <input type="color" id="fcColor" value="#2563EB" style="width: 50px; height: 36px; border: none; border-radius: 4px; cursor: pointer;" oninput="document.getElementById('fcColorText').value = this.value">
            <input type="text" class="form-input" id="fcColorText" value="#2563EB" style="width: 120px;" oninput="document.getElementById('fcColor').value = this.value">
          </div>
          <div class="form-hint">FCå°‚ç”¨ç”»é¢ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼</div>
        </div>

        <div class="form-group">
          <label class="form-label">ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚´URL</label>
          <input type="url" class="form-input" id="fcLogoUrl" placeholder="https://example.com/logo.png">
          <div class="form-hint">ç©ºç™½ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="fcIsActive" checked>
            <span>æœ‰åŠ¹</span>
          </label>
          <div class="form-hint">ç„¡åŠ¹ã«ã™ã‚‹ã¨FCå°‚ç”¨URLã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeFcModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveFc()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚¹ã‚¿ãƒƒãƒ•èªè¨¼è¨­å®š -->
<div id="designerAuthModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ”‘ ã‚¹ã‚¿ãƒƒãƒ•èªè¨¼è¨­å®š</h2>
      <button class="close" onclick="closeDesignerAuthModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="designerAuthForm">
        <input type="hidden" id="authDesignerId">

        <div class="form-group">
          <label class="form-label">ã‚¹ã‚¿ãƒƒãƒ•å</label>
          <input type="text" class="form-input" id="authDesignerName" disabled>
        </div>

        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒ­ã‚°ã‚¤ãƒ³IDï¼‰ *</label>
          <input type="email" class="form-input" id="authDesignerEmail" placeholder="ä¾‹ï¼šyamada@ghouse.jp" required>
          <div class="form-hint">ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™</div>
        </div>

        <div class="form-group">
          <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
          <input type="password" class="form-input" id="authDesignerPassword" placeholder="8æ–‡å­—ä»¥ä¸Š" required>
          <div class="form-hint">8æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„</div>
        </div>

        <div class="form-group">
          <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰ *</label>
          <input type="password" class="form-input" id="authDesignerPasswordConfirm" placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeDesignerAuthModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveDesignerAuth()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šç”³è«‹Goç¢ºèª -->
<div id="applicationGoModal" class="modal">
  <div class="modal-content" style="max-width: 450px;">
    <div class="modal-header">
      <h2 class="modal-title">ç¢ºèªç”³è«‹</h2>
      <button class="close" onclick="closeApplicationGoModal()">&times;</button>
    </div>
    <div class="modal-body" style="text-align: center; padding: 30px;">
      <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‹</div>
      <p id="applicationGoProjectName" style="font-size: 18px; font-weight: 600; margin-bottom: 8px;"></p>
      <p style="color: var(--text-secondary); margin-bottom: 24px;">ã“ã®æ¡ˆä»¶ã‚’å®Œäº†æ¸ˆã¿ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ</p>
      <div class="application-go-checklist" style="text-align: left; background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <div style="font-weight: 600; margin-bottom: 8px;">æ¡ä»¶ç¢ºèª:</div>
        <div id="applicationGoConditions"></div>
      </div>
    </div>
    <div class="modal-footer" style="justify-content: center; gap: 12px;">
      <button class="btn btn-ghost" onclick="closeApplicationGoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-success" onclick="executeApplicationGo()" style="background: linear-gradient(135deg, #10b981, #059669);">å®Œäº†æ¸ˆã¿ã«ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
<div id="toast" class="toast"></div>
<div id="contextMenu" class="context-menu">
  <div class="context-menu-item" onclick="ContextMenu.edit()">âœï¸ ç·¨é›†</div>
  <div class="context-menu-item" onclick="ContextMenu.toggleFavorite()">â­ ãŠæ°—ã«å…¥ã‚Š</div>
  <div class="context-menu-item" onclick="ContextMenu.toggleSelect()">â˜‘ï¸ é¸æŠ</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="ContextMenu.archive()">ğŸ“¦ å®Œäº†æ¸ˆã¿ã«ç§»å‹•</div>
  <div class="context-menu-item danger" onclick="ContextMenu.delete()">ğŸ—‘ï¸ å‰Šé™¤</div>
</div>

<script>
// ============================================
// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰è¨­å®š
// ============================================
const DEBUG_MODE = false; // æœ¬ç•ªç’°å¢ƒã§ã¯ false
const log = DEBUG_MODE ? console.log.bind(console) : () => {};
const warn = DEBUG_MODE ? console.warn.bind(console) : () => {};
const logError = DEBUG_MODE ? console.error.bind(console) : () => {};

// ============================================
// ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† & ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
// ============================================
const APP_VERSION = '4.12.0-' + Date.now();
if (DEBUG_MODE) log('ğŸš€ ArchiDeck ãƒãƒ¼ã‚¸ãƒ§ãƒ³:', APP_VERSION);

// èµ·å‹•æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¼·åˆ¶ã‚¯ãƒªã‚¢
(async function forceClearCache() {
  try {
    // Service Worker ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
    const cacheNames = await caches.keys();
    for (const name of cacheNames) {
      await caches.delete(name);
      log('ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤:', name);
    }

    // Service Worker ã‚’æ›´æ–°
    if ('serviceWorker' in navigator) {
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const reg of registrations) {
        await reg.update();
        log('ğŸ”„ Service Worker æ›´æ–°');
      }
    }
    log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†');
  } catch (e) {
    log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–å¯ï¼‰:', e);
  }
})();

// ============================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
// ============================================

// ãƒ‡ãƒã‚¦ãƒ³ã‚¹é–¢æ•° - é€£ç¶šå‘¼ã³å‡ºã—ã‚’åˆ¶é™
function debounce(func, wait = 300) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ã‚¹ãƒ­ãƒƒãƒˆãƒ«é–¢æ•° - ä¸€å®šé–“éš”ã§å®Ÿè¡Œã‚’åˆ¶é™
function throttle(func, limit = 100) {
  let inThrottle;
  return function(...args) {
    if (!inThrottle) {
      func.apply(this, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}

// äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢ãƒ˜ãƒ«ãƒ‘ãƒ¼
const SaveGuard = {
  _locks: new Set(),

  // ä¿å­˜å‡¦ç†ã‚’ãƒ­ãƒƒã‚¯ï¼ˆäºŒé‡å®Ÿè¡Œé˜²æ­¢ï¼‰
  async run(key, asyncFn) {
    if (this._locks.has(key)) {
      return false;
    }
    this._locks.add(key);
    try {
      return await asyncFn();
    } finally {
      this._locks.delete(key);
    }
  },

  // ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ç¢ºèª
  isLocked(key) {
    return this._locks.has(key);
  }
};

// å®‰å…¨ãªJSONãƒ‘ãƒ¼ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™ï¼‰
function safeJsonParse(str, defaultValue = null) {
  if (!str) return defaultValue;
  try {
    return JSON.parse(str);
  } catch (e) {
    warn('JSON.parseã‚¨ãƒ©ãƒ¼:', e.message);
    return defaultValue;
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ç®¡ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
const ModalManager = {
  activeModal: null,
  previousFocus: null,

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†ä»˜ãï¼‰
  open(modalElement, firstFocusSelector = 'input:not([type="hidden"]), select, textarea, button') {
    if (!modalElement) return;

    // æ—¢å­˜ã®Escapeãƒãƒ³ãƒ‰ãƒ©ãŒã‚ã‚Œã°å…ˆã«è§£é™¤ï¼ˆè“„ç©é˜²æ­¢ï¼‰
    if (this._escapeHandler) {
      document.removeEventListener('keydown', this._escapeHandler);
      this._escapeHandler = null;
    }

    // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¦ç´ ã‚’ä¿å­˜
    this.previousFocus = document.activeElement;
    this.activeModal = modalElement;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    modalElement.classList.add('show');

    // æœ€åˆã®å…¥åŠ›è¦ç´ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    setTimeout(() => {
      const firstFocusable = modalElement.querySelector(firstFocusSelector);
      if (firstFocusable) {
        firstFocusable.focus();
      }
    }, 100);

    // Escapeã‚­ãƒ¼ã§ã®ã‚¯ãƒ­ãƒ¼ã‚ºã‚’è¨­å®š
    this._escapeHandler = (e) => {
      if (e.key === 'Escape' && this.activeModal === modalElement) {
        this.close(modalElement);
      }
    };
    document.addEventListener('keydown', this._escapeHandler);
  },

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  close(modalElement) {
    if (!modalElement) return;

    modalElement.classList.remove('show');

    // Escapeãƒãƒ³ãƒ‰ãƒ©ã‚’è§£é™¤
    if (this._escapeHandler) {
      document.removeEventListener('keydown', this._escapeHandler);
      this._escapeHandler = null;
    }

    // å‰ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¦ç´ ã«æˆ»ã™
    if (this.previousFocus && typeof this.previousFocus.focus === 'function') {
      this.previousFocus.focus();
    }

    this.activeModal = null;
    this.previousFocus = null;
  }
};

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¢ã‚¤ãƒ‰ãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒãƒªãƒ•ã‚£ãƒ«ä»˜ãï¼‰
const requestIdleCallback = window.requestIdleCallback || function(cb) {
  const start = Date.now();
  return setTimeout(() => {
    cb({
      didTimeout: false,
      timeRemaining: () => Math.max(0, 50 - (Date.now() - start))
    });
  }, 1);
};

// ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ¸ˆã¿æ¤œç´¢é–¢æ•°
const debouncedRenderProjects = debounce(() => {
  renderProjects();
  // æ¤œç´¢å±¥æ­´ã‚’ä¿å­˜
  const query = document.getElementById('searchQuery')?.value.trim();
  if (query && query.length >= 2) {
    saveSearchHistory(query);
  }
}, 250);

// ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½
const ContextMenu = {
  currentProjectId: null,
  menu: null,

  init() {
    this.menu = document.getElementById('contextMenu');
    // æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ã®å³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ‡ãƒªã‚²ãƒ¼ãƒˆ
    document.addEventListener('contextmenu', (e) => {
      const card = e.target.closest('[data-project-id]');
      if (card && document.getElementById('projectsTab').contains(card)) {
        e.preventDefault();
        this.show(e.clientX, e.clientY, card.dataset.projectId);
      }
    });
    // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    document.addEventListener('click', () => this.hide());
  },

  show(x, y, projectId) {
    this.currentProjectId = projectId;
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’å‹•çš„ã«æ›´æ–°
    const archiveItem = this.menu.querySelector('.context-menu-item:nth-child(5)');
    if (archiveItem) {
      archiveItem.innerHTML = project.is_archived ? 'ğŸ“‚ å¾©å…ƒ' : 'ğŸ“¦ å®Œäº†æ¸ˆã¿ã«ç§»å‹•';
    }

    // ç”»é¢å¤–ã«ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«ä½ç½®èª¿æ•´
    this.menu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
    this.menu.style.top = Math.min(y, window.innerHeight - 250) + 'px';
    this.menu.classList.add('show');
  },

  hide() {
    if (this.menu) this.menu.classList.remove('show');
    this.currentProjectId = null;
  },

  edit() {
    if (this.currentProjectId) openProjectModal(this.currentProjectId);
    this.hide();
  },

  toggleFavorite() {
    if (this.currentProjectId) FavoritesManager.toggle(this.currentProjectId);
    this.hide();
  },

  toggleSelect() {
    if (this.currentProjectId) BatchOperations.toggle(this.currentProjectId);
    this.hide();
  },

  archive() {
    if (this.currentProjectId) toggleArchive(this.currentProjectId);
    this.hide();
  },

  delete() {
    if (this.currentProjectId) deleteProject(this.currentProjectId);
    this.hide();
  }
};

// æ¤œç´¢ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆæ©Ÿèƒ½
function getSearchHistory() {
  return safeJsonParse(localStorage.getItem('archideck_search_history'), []);
}

function saveSearchHistory(query) {
  let history = getSearchHistory();
  // é‡è¤‡ã‚’å‰Šé™¤ã—ã¦å…ˆé ­ã«è¿½åŠ 
  history = history.filter(h => h.toLowerCase() !== query.toLowerCase());
  history.unshift(query);
  // æœ€å¤§20ä»¶ã¾ã§ä¿æŒ
  history = history.slice(0, 20);
  localStorage.setItem('archideck_search_history', JSON.stringify(history));
}

function updateSearchSuggestions() {
  const datalist = document.getElementById('searchSuggestions');
  if (!datalist) return;

  const history = getSearchHistory();
  // é¡§å®¢åä¸€è¦§ã‚’å–å¾—ï¼ˆé‡è¤‡ãªã—ï¼‰
  const customers = [...new Set(projects.map(p => p.customer).filter(Boolean))];

  // å±¥æ­´ã¨é¡§å®¢åã‚’çµ±åˆï¼ˆå±¥æ­´å„ªå…ˆï¼‰
  const suggestions = [...new Set([...history, ...customers])].slice(0, 15);

  datalist.innerHTML = suggestions.map(s => `<option value="${escapeHtml(s)}">`).join('');
}

// ============================================
// Undo/Redo ç®¡ç†
// ============================================
const UndoManager = {
  history: [],
  redoStack: [],
  maxHistory: 50,
  isUndoing: false,

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜éŒ²
  record(action) {
    if (this.isUndoing) return;

    this.history.push({
      ...action,
      timestamp: Date.now()
    });

    // å±¥æ­´ã®ä¸Šé™ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
    if (this.history.length > this.maxHistory) {
      this.history.shift();
    }

    // æ–°ã—ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒè¨˜éŒ²ã•ã‚ŒãŸã‚‰Redoã‚¹ã‚¿ãƒƒã‚¯ã‚’ã‚¯ãƒªã‚¢
    this.redoStack = [];

    this.updateUI();
    log(`ğŸ“ æ“ä½œè¨˜éŒ²: ${action.description}`, action);
  },

  // å…ƒã«æˆ»ã™
  async undo() {
    if (this.history.length === 0) {
      showToast('å…ƒã«æˆ»ã™æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“', 'info');
      return;
    }

    this.isUndoing = true;

    try {
      const action = this.history.pop();
      this.redoStack.push(action);

      await this.revert(action);

      showToast(`â†©ï¸ å…ƒã«æˆ»ã—ã¾ã—ãŸ: ${action.description}`, 'success');
      announceToScreenReader(`å…ƒã«æˆ»ã—ã¾ã—ãŸ: ${action.description}`);
    } catch (error) {
      logError('Undoå¤±æ•—:', error);
      showToast('å…ƒã«æˆ»ã™æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    } finally {
      this.isUndoing = false;
      this.updateUI();
    }
  },

  // ã‚„ã‚Šç›´ã™
  async redo() {
    if (this.redoStack.length === 0) {
      showToast('ã‚„ã‚Šç›´ã™æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“', 'info');
      return;
    }

    this.isUndoing = true;

    try {
      const action = this.redoStack.pop();
      this.history.push(action);

      await this.apply(action);

      showToast(`â†ªï¸ ã‚„ã‚Šç›´ã—ã¾ã—ãŸ: ${action.description}`, 'success');
      announceToScreenReader(`ã‚„ã‚Šç›´ã—ã¾ã—ãŸ: ${action.description}`);
    } catch (error) {
      logError('Redoå¤±æ•—:', error);
      showToast('ã‚„ã‚Šç›´ã™æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    } finally {
      this.isUndoing = false;
      this.updateUI();
    }
  },

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å…ƒã«æˆ»ã™
  async revert(action) {
    switch (action.type) {
      case 'UPDATE_PROJECT': {
        const { error } = await supabase
          .from('projects')
          .update(action.oldValue)
          .eq('id', action.projectId);
        if (error) throw new Error(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°å¤±æ•—: ${error.message}`);
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
        const projectIdx = projects.findIndex(p => p.id === action.projectId);
        if (projectIdx !== -1) {
          Object.assign(projects[projectIdx], action.oldValue);
        }
        renderProjects();
        break;
      }

      case 'UPDATE_TASK': {
        const proj = projects.find(p => p.id === action.projectId);
        if (proj && proj.tasks) {
          proj.tasks[action.taskKey] = { ...action.oldValue };
          const { error } = await supabase
            .from('projects')
            .update({ tasks: proj.tasks })
            .eq('id', action.projectId);
          if (error) throw new Error(`ã‚¿ã‚¹ã‚¯æ›´æ–°å¤±æ•—: ${error.message}`);
        }
        renderProjects();
        break;
      }

      case 'CREATE_PROJECT': {
        const { error } = await supabase.from('projects').delete().eq('id', action.projectId);
        if (error) throw new Error(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤å¤±æ•—: ${error.message}`);
        projects = projects.filter(p => p.id !== action.projectId);
        renderProjects();
        renderSidebar();
        break;
      }

      case 'DELETE_PROJECT': {
        const { data, error } = await supabase
          .from('projects')
          .insert(action.oldValue)
          .select()
          .single();
        if (error) throw new Error(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¾©å…ƒå¤±æ•—: ${error.message}`);
        if (data) {
          projects.push(data);
        }
        renderProjects();
        renderSidebar();
        break;
      }

      case 'ARCHIVE_PROJECT': {
        const { error } = await supabase
          .from('projects')
          .update({ is_archived: action.oldValue })
          .eq('id', action.projectId);
        if (error) throw new Error(`ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ›´æ–°å¤±æ•—: ${error.message}`);
        const archiveIdx = projects.findIndex(p => p.id === action.projectId);
        if (archiveIdx !== -1) {
          projects[archiveIdx].is_archived = action.oldValue;
        }
        renderProjects();
        renderSidebar();
        break;
      }

      default:
        warn('æœªå¯¾å¿œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—:', action.type);
    }
  },

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å†é©ç”¨
  async apply(action) {
    switch (action.type) {
      case 'UPDATE_PROJECT': {
        const { error } = await supabase
          .from('projects')
          .update(action.newValue)
          .eq('id', action.projectId);
        if (error) throw new Error(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°å¤±æ•—: ${error.message}`);
        const projectIdx = projects.findIndex(p => p.id === action.projectId);
        if (projectIdx !== -1) {
          Object.assign(projects[projectIdx], action.newValue);
        }
        renderProjects();
        break;
      }

      case 'UPDATE_TASK': {
        const proj = projects.find(p => p.id === action.projectId);
        if (proj && proj.tasks) {
          proj.tasks[action.taskKey] = { ...action.newValue };
          const { error } = await supabase
            .from('projects')
            .update({ tasks: proj.tasks })
            .eq('id', action.projectId);
          if (error) throw new Error(`ã‚¿ã‚¹ã‚¯æ›´æ–°å¤±æ•—: ${error.message}`);
        }
        renderProjects();
        break;
      }

      case 'CREATE_PROJECT': {
        const { data, error } = await supabase
          .from('projects')
          .insert(action.newValue)
          .select()
          .single();
        if (error) throw new Error(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå¤±æ•—: ${error.message}`);
        if (data) {
          projects.push(data);
        }
        renderProjects();
        renderSidebar();
        break;
      }

      case 'DELETE_PROJECT': {
        const { error } = await supabase.from('projects').delete().eq('id', action.projectId);
        if (error) throw new Error(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤å¤±æ•—: ${error.message}`);
        projects = projects.filter(p => p.id !== action.projectId);
        renderProjects();
        renderSidebar();
        break;
      }

      case 'ARCHIVE_PROJECT': {
        const { error } = await supabase
          .from('projects')
          .update({ is_archived: action.newValue })
          .eq('id', action.projectId);
        if (error) throw new Error(`ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ›´æ–°å¤±æ•—: ${error.message}`);
        const archiveIdx = projects.findIndex(p => p.id === action.projectId);
        if (archiveIdx !== -1) {
          projects[archiveIdx].is_archived = action.newValue;
        }
        renderProjects();
        renderSidebar();
        break;
      }

      default:
        warn('æœªå¯¾å¿œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—:', action.type);
    }
  },

  // UIæ›´æ–°
  updateUI() {
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');

    if (undoBtn) {
      undoBtn.disabled = this.history.length === 0;
      undoBtn.title = this.history.length > 0
        ? `å…ƒã«æˆ»ã™: ${this.history[this.history.length - 1].description}`
        : 'å…ƒã«æˆ»ã™æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“';
    }

    if (redoBtn) {
      redoBtn.disabled = this.redoStack.length === 0;
      redoBtn.title = this.redoStack.length > 0
        ? `ã‚„ã‚Šç›´ã™: ${this.redoStack[this.redoStack.length - 1].description}`
        : 'ã‚„ã‚Šç›´ã™æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“';
    }
  },

  // å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
  clear() {
    this.history = [];
    this.redoStack = [];
    this.updateUI();
  },

  // æ“ä½œå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
  canUndo() {
    return this.history.length > 0;
  },

  canRedo() {
    return this.redoStack.length > 0;
  }
};

// ============================================
// SupabaseåˆæœŸåŒ–
// ============================================
const SUPABASE_URL = 'https://twzsirpfudqwboeyakta.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3enNpcnBmdWRxd2JvZXlha3RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MzM4NjgsImV4cCI6MjA3NzAwOTg2OH0.E_8GxfsO6Scjc0dDoEoyxq3i4lfvNxYZvnSL1OlSDSM';

// Supabase CDNã®ãƒ­ãƒ¼ãƒ‰ç¢ºèª
if (!window.supabase) {
  logError('âŒ Supabase CDN ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ï¼');
  alert('Supabase CDN ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
}

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
log('âœ… SupabaseåˆæœŸåŒ–å®Œäº†:', SUPABASE_URL);

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentUser = null;
let currentDesigner = null;
let currentUserCategory = null; // 'admin' | 'è¨­è¨ˆ' | 'IC'
let projects = [];
let designers = [];
let emailTemplates = [];
let vendors = [];
let taskMappings = {};
let currentDesignerTab = 'ALL';
let editingProjectId = null;
let editingTemplateId = null;
let editingVendorId = null;

// æ–°ã‚·ã‚¹ãƒ†ãƒ ç”¨å¤‰æ•°
let vendorCategories = [];
let tasksV2 = [];
let vendorsV2 = [];
let taskVendorMappings = [];
let products = [];

// ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œï¼ˆSaaSç‰ˆï¼‰
let currentOrganization = null;
let currentSubscription = null;

// FCãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚ºå‘ã‘ãƒ›ãƒ¯ã‚¤ãƒˆãƒ©ãƒ™ãƒ«ï¼‰
let isFCMode = false;
let fcSlug = null;
let organizationSettings = null;

// çµ„ç¹”æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
async function loadOrganization() {
  try {
    const { data: memberData } = await supabase
      .from('organization_members')
      .select('organization_id')
      .eq('user_id', currentUser.id)
      .eq('status', 'active')
      .single();

    if (memberData) {
      const { data: orgData } = await supabase
        .from('organizations')
        .select('*')
        .eq('id', memberData.organization_id)
        .single();

      if (orgData) {
        currentOrganization = orgData;
        applyWhiteLabel(orgData);

        // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±
        const { data: subData } = await supabase
          .from('subscriptions')
          .select('*')
          .eq('organization_id', orgData.id)
          .single();

        currentSubscription = subData;
        checkSubscriptionStatus(subData);
      }
    }
  } catch (error) {
    log('çµ„ç¹”æƒ…å ±ã®èª­ã¿è¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«æœªä½œæˆã®å¯èƒ½æ€§ï¼‰');
  }
}

// ãƒ›ãƒ¯ã‚¤ãƒˆãƒ©ãƒ™ãƒ«é©ç”¨
function applyWhiteLabel(org) {
  if (!org) return;

  // ãƒ­ã‚´å¤‰æ›´
  if (org.logo_url) {
    const logoElements = document.querySelectorAll('.logo, .sidebar-logo');
    logoElements.forEach(el => {
      if (el.tagName === 'IMG') {
        el.src = org.logo_url;
      }
    });
  }

  // ã‚«ãƒ©ãƒ¼å¤‰æ›´
  if (org.primary_color) {
    document.documentElement.style.setProperty('--primary-color', org.primary_color);
  }
  if (org.secondary_color) {
    document.documentElement.style.setProperty('--secondary-color', org.secondary_color);
  }

  // ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
  if (org.name) {
    document.title = `ArchiDeck | ${org.name}`;
  }
}

// ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
function checkSubscriptionStatus(sub) {
  if (!sub) return;

  if (sub.status === 'trial') {
    const trialEnd = new Date(sub.trial_ends_at);
    const now = new Date();
    const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));

    if (daysLeft <= 3 && daysLeft > 0) {
      showToast(`ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ãŒã‚ã¨${daysLeft}æ—¥ã§çµ‚äº†ã—ã¾ã™`, 'warning');
    } else if (daysLeft <= 0) {
      showToast('ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚ãƒ—ãƒ©ãƒ³ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚', 'error');
    }
  } else if (sub.status === 'past_due') {
    showToast('ãŠæ”¯æ‰•ã„ãŒé…å»¶ã—ã¦ã„ã¾ã™ã€‚ç®¡ç†ç”»é¢ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
  }
}

// ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ãƒ•ãƒ©ã‚°
let isHandlingHashChange = false;

// æ‹…å½“è€…ã®ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ ï¼‰
function getTasksForAssignee(assigneeName) {
  const designer = designers.find(d => d.name === assigneeName);
  const category = designer?.category || 'è¨­è¨ˆ';

  // tasksV2ãŒç©ºã®å ´åˆã¯ç©ºé…åˆ—ã‚’è¿”ã™
  if (!tasksV2 || tasksV2.length === 0) {
    warn('âš ï¸ tasksV2ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚migration_customizable_system.sqlã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
    return [];
  }

  return tasksV2.filter(t => t.category === category).sort((a, b) => a.display_order - b.display_order);
}

// ã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—ï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ ï¼‰
function getTaskStateOptions(taskKey) {
  const task = tasksV2.find(t => t.task_key === taskKey);
  if (!task || !task.has_state || !task.state_options) return null;
  return task.state_options;
}

// ============================================
// èªè¨¼å‡¦ç†
// ============================================

// ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ã‚¢ãƒã‚¿ãƒ¼è¡¨ç¤ºã®å…±é€šé–¢æ•°
function updateUserDisplay(displayName) {
  const userNameEl = document.getElementById('userName');
  const userAvatarEl = document.getElementById('userAvatar');
  if (userNameEl) userNameEl.textContent = displayName;
  if (userAvatarEl) userAvatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=4A90E2&color=fff&size=32`;
}

// ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°
let isDemoMode = false;

// ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç„¡ã—ã§ãƒ­ã‚°ã‚¤ãƒ³ï¼‰
async function enterDemoMode() {
  log('ğŸ­ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å…¥å ´...');
  document.getElementById('loginContainer').style.display = 'none';
  isDemoMode = true;
  // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§ç›´æ¥ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸
  await selectAccountType('admin');
}

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šUIè¡¨ç¤º
function showForgotPassword() {
  document.getElementById('forgotPasswordSection').style.display = 'block';
  document.getElementById('forgotEmail').value = document.getElementById('loginEmail').value;
  document.getElementById('forgotEmail').focus();
}

function hideForgotPassword() {
  document.getElementById('forgotPasswordSection').style.display = 'none';
}

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šãƒ¡ãƒ¼ãƒ«é€ä¿¡
async function sendPasswordReset() {
  const email = document.getElementById('forgotEmail').value.trim();

  if (!email) {
    showToast('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (!window.supabase) {
    showToast('ã‚¨ãƒ©ãƒ¼: ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
    return;
  }

  try {
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.origin + '/archideck/index.html#reset-password'
    });

    if (error) {
      logError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
      showToast('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚', 'success', 5000);
    hideForgotPassword();
  } catch (e) {
    logError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆä¾‹å¤–:', e);
    showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
  }
}

async function signIn() {
  log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†é–‹å§‹...');

  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  log('ğŸ“§ å…¥åŠ›ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«:', email);

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã®å ´åˆã¯ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å…¥ã‚‹
  if (!password && email) {
    log('ğŸ­ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç„¡ã— - ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ');
    enterDemoMode();
    return;
  }

  if (!email) {
    logError('âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç©ºã§ã™');
    showToast('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (!window.supabase) {
    logError('âŒ Supabase CDNãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
    showToast('ã‚¨ãƒ©ãƒ¼: SupabaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }

  try {
    log('ğŸ”„ Supabaseèªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });

    if (error) {
      logError('âŒ Supabaseèªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }

    log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', data.user.email);
    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ - onAuthStateChangeã§å‡¦ç†ã•ã‚Œã‚‹ã®ã§reloadã¯ä¸è¦
  } catch (error) {
    logError('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
  }
}

async function signOut() {
  try {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
    location.reload();
  } catch (error) {
    logError('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
    showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

async function checkAuth() {
  log('ğŸ” èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...');
  const { data: { session } } = await supabase.auth.getSession();

  if (session) {
    log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œå‡º:', session.user.email);
    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';

    // admin@ghouse.jpã®å ´åˆã¯ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§ç›´æ¥ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸
    if (currentUser.email === 'admin@ghouse.jp') {
      log('ğŸ‘‘ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ - å…¨æ¨©é™ãƒ¢ãƒ¼ãƒ‰');
      await selectAccountType('admin');
      return;
    }

    // ãã®ä»–ã®å ´åˆã¯ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’å–å¾—ã—ã¦categoryã‚’åˆ¤å®š
    const { data: designerData } = await supabase
      .from('designers')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    if (designerData) {
      currentDesigner = designerData;
      currentUserCategory = designerData.category;
      log('âœ… ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±å–å¾—:', currentDesigner.name, '/', currentUserCategory);
    } else {
      warn('âš ï¸ ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', currentUser.email);
    }

    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
    document.getElementById('mainContainer').classList.add('show');

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ã‚¢ãƒã‚¿ãƒ¼ã‚’è¡¨ç¤º
    updateUserDisplay(currentUser.email.split('@')[0]);

    await init();

    // åˆæœŸåŒ–å®Œäº†å¾Œã«URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã®å‡¦ç†ã‚’å®Ÿè¡Œï¼ˆ1å›ã ã‘ï¼‰
    if (!window.location.hash || window.location.hash === '#') {
      window.location.hash = 'projects';
    }
  } else {
    log('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã— - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º');
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('mainContainer').classList.remove('show');
  }
}

// èªè¨¼å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°
let isAuthProcessing = false;

// èªè¨¼çŠ¶æ…‹å¤‰æ›´ã‚’ç›£è¦–
supabase.auth.onAuthStateChange(async (event, session) => {
  log('ğŸ”” èªè¨¼ã‚¤ãƒ™ãƒ³ãƒˆ:', event, 'currentUser:', currentUser?.email, 'processing:', isAuthProcessing);

  if (event === 'SIGNED_IN' && !currentUser && !isAuthProcessing) {
    isAuthProcessing = true;
    log('âœ… SIGNED_IN ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†é–‹å§‹:', session.user.email);

    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';

    // admin@ghouse.jpã®å ´åˆã¯ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§ç›´æ¥ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸
    if (currentUser.email === 'admin@ghouse.jp') {
      log('ğŸ‘‘ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ - å…¨æ¨©é™ãƒ¢ãƒ¼ãƒ‰');
      await selectAccountType('admin');
      isAuthProcessing = false;
      return;
    }

    // ãã®ä»–ã®å ´åˆã¯ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’å–å¾—ã—ã¦categoryã‚’åˆ¤å®š
    const { data: designerData } = await supabase
      .from('designers')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    if (designerData) {
      currentDesigner = designerData;
      currentUserCategory = designerData.category;
      log('âœ… ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±å–å¾—:', currentDesigner.name, '/', currentUserCategory);
    } else {
      warn('âš ï¸ ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', currentUser.email);
    }

    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
    document.getElementById('mainContainer').classList.add('show');

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ã‚¢ãƒã‚¿ãƒ¼ã‚’è¡¨ç¤º
    updateUserDisplay(currentUser.email.split('@')[0]);

    await init();
    isAuthProcessing = false;
  } else if (event === 'SIGNED_OUT') {
    log('ğŸ‘‹ SIGNED_OUT ã‚¤ãƒ™ãƒ³ãƒˆ');
    location.reload();
  } else {
    log('â­ï¸ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—');
  }
});

// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ
async function selectAccountType(category) {
  log('ğŸ¯ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ:', category);
  currentUserCategory = category;
  document.getElementById('mainContainer').classList.add('show');

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ã‚¢ãƒã‚¿ãƒ¼ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰
  const displayName = currentUser?.email ? currentUser.email.split('@')[0] : 'demo';
  updateUserDisplay(displayName);

  // åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  updateCategorySwitchButton();

  await init();

  // åˆæœŸåŒ–å®Œäº†å¾Œã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ–ã‚’è¨­å®šï¼ˆ1å›ã ã‘ï¼‰
  if (!window.location.hash || window.location.hash === '#') {
    window.location.hash = 'projects';
  }

  log('âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠå®Œäº†');
}

// ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
function updateCategorySwitchButton() {
  const btn = document.getElementById('categorySwitchBtn');
  const label = document.getElementById('currentCategoryLabel');

  if (currentUserCategory === 'è¨­è¨ˆ') {
    label.textContent = 'ğŸ“ è¨­è¨ˆ';
  } else if (currentUserCategory === 'IC') {
    label.textContent = 'ğŸ¨ IC';
  } else if (currentUserCategory === 'admin') {
    label.textContent = 'ğŸ‘‘ ç®¡ç†è€…';
  }

  btn.style.display = 'block';
}

// ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰
function toggleCategorySwitcher() {
  const menu = document.getElementById('categorySwitchMenu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.addEventListener('click', function(e) {
  const menu = document.getElementById('categorySwitchMenu');
  const btn = document.getElementById('categorySwitchBtn');
  if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
    menu.style.display = 'none';
  }
});

// ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆ
async function switchCategory(category) {
  log('ğŸ”„ ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆ:', category);

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
  document.getElementById('categorySwitchMenu').style.display = 'none';

  // åŒã˜ã‚«ãƒ†ã‚´ãƒªãªã‚‰ä½•ã‚‚ã—ãªã„
  if (currentUserCategory === category) {
    log('â­ï¸ åŒã˜ã‚«ãƒ†ã‚´ãƒªã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
    return;
  }

  // ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°
  currentUserCategory = category;

  // ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
  updateCategorySwitchButton();

  // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
  showStatus('èª­ã¿è¾¼ã¿ä¸­...', 'saving');
  await init();

  showToast(`${category === 'admin' ? 'ç®¡ç†è€…' : category + 'æ‹…å½“'}ç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, 'success');
  log('âœ… ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆå®Œäº†');
}

// ============================================
// FCãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚ºå‘ã‘ãƒ›ãƒ¯ã‚¤ãƒˆãƒ©ãƒ™ãƒ«ï¼‰
// ============================================
function detectFCMode() {
  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰FCã‚¹ãƒ©ãƒƒã‚°ã‚’å–å¾—
  const urlParams = new URLSearchParams(window.location.search);
  const fcParam = urlParams.get('fc');

  // localStorageã‹ã‚‰FCãƒ¢ãƒ¼ãƒ‰æƒ…å ±ã‚’å–å¾—
  const fcModeData = localStorage.getItem('fc_mode');

  if (fcParam) {
    isFCMode = true;
    fcSlug = fcParam;
    log('ğŸª FCãƒ¢ãƒ¼ãƒ‰æ¤œå‡ºï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰:', fcSlug);
  } else if (fcModeData) {
    try {
      const fcConfig = JSON.parse(fcModeData);
      // 24æ™‚é–“ä»¥å†…ã®è¨­å®šã®ã¿æœ‰åŠ¹
      if (fcConfig.timestamp && (Date.now() - fcConfig.timestamp < 24 * 60 * 60 * 1000)) {
        isFCMode = true;
        fcSlug = fcConfig.slug;
        log('ğŸª FCãƒ¢ãƒ¼ãƒ‰æ¤œå‡ºï¼ˆlocalStorageï¼‰:', fcSlug);
      }
    } catch (e) {
      warn('FCè¨­å®šã®è§£æã«å¤±æ•—:', e);
    }
  }

  // FCãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯UIèª¿æ•´ï¼ˆéåŒæœŸã§å®Ÿè¡Œï¼‰
  if (isFCMode) {
    applyFCMode().catch(e => warn('FCãƒ¢ãƒ¼ãƒ‰é©ç”¨ã‚¨ãƒ©ãƒ¼:', e));
  }
}

async function applyFCMode() {
  log('ğŸ¨ FCãƒ¢ãƒ¼ãƒ‰UIé©ç”¨ä¸­...');

  // ç®¡ç†è€…ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹CSSè¿½åŠ 
  const fcStyle = document.createElement('style');
  fcStyle.id = 'fc-mode-styles';
  fcStyle.textContent = `
    /* FCãƒ¢ãƒ¼ãƒ‰: ç®¡ç†è€…é–¢é€£ã‚’éè¡¨ç¤º */
    .fc-hide { display: none !important; }

    /* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠç”»é¢ã®ç®¡ç†è€…ãƒœã‚¿ãƒ³ */
    button[onclick="selectAccountType('admin')"] { display: none !important; }

    /* ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆã®ç®¡ç†è€…ãƒœã‚¿ãƒ³ */
    button[onclick="switchCategory('admin')"] { display: none !important; }

    /* è¨­å®šç”»é¢ã®ç®¡ç†è€…å°‚ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .admin-only-section { display: none !important; }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®Gãƒã‚¦ã‚¹ãƒ­ã‚´ */
    .header-logo-text .ghouse-text { display: none !important; }
  `;
  document.head.appendChild(fcStyle);

  // FCçµ„ç¹”æƒ…å ±ã‚’DBã‹ã‚‰èª­ã¿è¾¼ã¿
  let fcOrg = null;
  try {
    const { data, error } = await supabase
      .from('fc_organizations')
      .select('*')
      .eq('slug', fcSlug)
      .eq('is_active', true)
      .single();

    if (!error && data) {
      fcOrg = data;
      log('ğŸ“¦ FCçµ„ç¹”æƒ…å ±å–å¾—:', fcOrg.name);
    }
  } catch (e) {
    warn('FCçµ„ç¹”æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
  }

  // FCçµ„ç¹”ã®ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’é©ç”¨
  if (fcOrg) {
    // ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
    document.title = fcOrg.name + ' | è¨­è¨ˆæ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ';

    // ãƒ—ãƒ©ã‚¤ãƒãƒªã‚«ãƒ©ãƒ¼ã‚’é©ç”¨
    if (fcOrg.primary_color) {
      document.documentElement.style.setProperty('--primary-color', fcOrg.primary_color);
    }

    // ãƒ­ã‚´ã‚’é©ç”¨ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
    setTimeout(() => {
      const headerLogo = document.querySelector('.header-logo-text');
      if (headerLogo) {
        if (fcOrg.logo_url) {
          headerLogo.innerHTML = `<img src="${escapeHtml(fcOrg.logo_url)}" alt="${escapeHtml(fcOrg.name)}" style="height: 32px; vertical-align: middle;">`;
        } else {
          headerLogo.innerHTML = `<span style="color: var(--primary-color);">${escapeHtml(fcOrg.name)}</span>`;
        }
      }

      // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ãƒ­ã‚´ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
      const loginLogoText = document.querySelector('.login-logo-text');
      if (loginLogoText) {
        if (fcOrg.logo_url) {
          loginLogoText.innerHTML = `<img src="${escapeHtml(fcOrg.logo_url)}" alt="${escapeHtml(fcOrg.name)}" style="height: 48px;">`;
        } else {
          loginLogoText.innerHTML = `<span style="color: var(--primary-color);">${escapeHtml(fcOrg.name)}</span>`;
        }
      }

      // è¨­å®šç”»é¢ã§çµ„ç¹”åã‚’è¡¨ç¤º
      const orgNameDisplay = document.getElementById('orgNameDisplay');
      if (orgNameDisplay) {
        orgNameDisplay.textContent = fcOrg.name;
      }
    }, 100);
  } else {
    // FCçµ„ç¹”ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
    document.title = 'è¨­è¨ˆæ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ';

    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®Gãƒã‚¦ã‚¹è¡¨ç¤ºã‚’éè¡¨ç¤º
    const loginBranding = document.querySelector('#loginContainer p[style*="color: var(--text-muted)"]');
    if (loginBranding && loginBranding.textContent.includes('Gãƒã‚¦ã‚¹')) {
      loginBranding.style.display = 'none';
    }

    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ãƒ­ã‚´ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
    const loginLogoText = document.querySelector('.login-logo-text');
    if (loginLogoText) {
      loginLogoText.innerHTML = '<span style="color: var(--primary-color);">è¨­è¨ˆæ¥­å‹™</span>ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ';
    }

    setTimeout(() => {
      const headerLogo = document.querySelector('.header-logo-text');
      if (headerLogo && headerLogo.innerHTML.includes('Gãƒã‚¦ã‚¹')) {
        headerLogo.innerHTML = '<span style="color: var(--primary-color);">Archi</span>Deck';
      }

      const orgNameDisplay = document.getElementById('orgNameDisplay');
      if (orgNameDisplay && fcSlug) {
        orgNameDisplay.textContent = fcSlug + ' å°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ';
      }
    }, 100);
  }

  log('âœ… FCãƒ¢ãƒ¼ãƒ‰UIé©ç”¨å®Œäº†');
}

function exitFCMode() {
  localStorage.removeItem('fc_mode');
  isFCMode = false;
  fcSlug = null;
  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
  const url = new URL(window.location);
  url.searchParams.delete('fc');
  window.location.href = url.toString();
}

// ============================================
// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
// ============================================
function initKeyboardShortcuts() {
  document.addEventListener('keydown', handleKeyboardShortcut);
}

function handleKeyboardShortcut(e) {
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã®Escapeã‚­ãƒ¼
  if (e.key === 'Escape') {
    // .show ã‚¯ãƒ©ã‚¹ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const openModals = document.querySelectorAll('.modal.show');
    openModals.forEach(modal => modal.classList.remove('show'));
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
    closeSidebar();
    return;
  }

  // Ctrl/Cmd + ã‚­ãƒ¼ ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
  if (e.ctrlKey || e.metaKey) {
    switch (e.key.toLowerCase()) {
      case 'n':
        // æ–°è¦æ¡ˆä»¶ä½œæˆ
        if (!isLoginScreen()) {
          e.preventDefault();
          showNewProjectModal();
        }
        break;
      case 's':
        // ä¿å­˜ï¼ˆç¾åœ¨ã®çŠ¶æ…‹ã‚’åŒæœŸï¼‰
        e.preventDefault();
        forceReloadData();
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ', 'success');
        break;
      case 'k':
        // ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢
        e.preventDefault();
        const searchInput = document.querySelector('#searchQuery');
        if (searchInput) {
          searchInput.focus();
        }
        break;
      case 'z':
        // å…ƒã«æˆ»ã™ / ã‚„ã‚Šç›´ã™
        e.preventDefault();
        if (e.shiftKey) {
          // Ctrl+Shift+Z = ã‚„ã‚Šç›´ã™
          UndoManager.redo();
        } else {
          // Ctrl+Z = å…ƒã«æˆ»ã™
          UndoManager.undo();
        }
        break;
      case 'y':
        // Ctrl+Y = ã‚„ã‚Šç›´ã™ï¼ˆWindowsæ¨™æº–ï¼‰
        e.preventDefault();
        UndoManager.redo();
        break;
      case 'e':
        // Ctrl+E = CSVå‡ºåŠ›
        if (!isLoginScreen()) {
          e.preventDefault();
          exportToCSV();
        }
        break;
      case 'a':
        // Ctrl+A = å…¨é¸æŠï¼ˆãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ä¸­ã§ãªã„å ´åˆï¼‰
        if (!isLoginScreen() && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
          e.preventDefault();
          BatchOperations.selectAll();
        }
        break;
    }
  }

  // Shift + ã‚­ãƒ¼ ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
  if (e.shiftKey && !e.ctrlKey && !e.metaKey) {
    switch (e.key) {
      case '?':
        // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
        showShortcutHelp();
        break;
    }
  }
}

function isLoginScreen() {
  const loginContainer = document.getElementById('loginContainer');
  return loginContainer && loginContainer.style.display !== 'none';
}

function showShortcutHelp() {
  const helpContent = `
    <div style="padding: 20px;">
      <h3 style="margin-bottom: 16px; font-size: 18px;">âŒ¨ï¸ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h3>
      <div style="display: grid; gap: 12px;">
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + Z</span><span>å…ƒã«æˆ»ã™ï¼ˆUndoï¼‰</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + Shift + Z</span><span>ã‚„ã‚Šç›´ã™ï¼ˆRedoï¼‰</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + Y</span><span>ã‚„ã‚Šç›´ã™ï¼ˆRedoï¼‰</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + N</span><span>æ–°è¦æ¡ˆä»¶ä½œæˆ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + S</span><span>ãƒ‡ãƒ¼ã‚¿åŒæœŸ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + K</span><span>æ¤œç´¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + E</span><span>CSVå‡ºåŠ›</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + A</span><span>å…¨æ¡ˆä»¶é¸æŠ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Escape</span><span>ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Shift + ?</span><span>ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º</span>
        </div>
      </div>
    </div>
  `;

  // ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤º
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
  modal.innerHTML = `
    <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 400px; width: 90%;">
      ${helpContent}
      <div style="padding: 0 20px 20px; text-align: right;">
        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  `;
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });
  document.body.appendChild(modal);
}

// ============================================
// åˆæœŸåŒ–
// ============================================
async function init() {
  log('ğŸš€ åˆæœŸåŒ–é–‹å§‹...');
  showStatus('èª­ã¿è¾¼ã¿ä¸­...', 'saving');

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆåˆæœŸåŒ–
  initKeyboardShortcuts();

  // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆæœŸåŒ–
  ContextMenu.init();

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆæœŸåŒ–
  SessionManager.init();

  // FCãƒ¢ãƒ¼ãƒ‰æ¤œå‡º
  detectFCMode();

  try {
    // ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ: çµ„ç¹”æƒ…å ±ã‚’å…ˆã«èª­ã¿è¾¼ã‚€
    await loadOrganization();

    log('ğŸ“¦ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');
    const results = await Promise.allSettled([
      loadDesigners(),
      loadCurrentDesigner(),
      loadProjects(),
      loadEmailTemplates(),
      loadVendors(),
      loadTaskMappings(),
      loadVendorCategories(),
      loadTasksV2(),
      loadVendorsV2(),
      loadTaskVendorMappings(),
      loadProducts(),
      loadFcOrganizations()
    ]);

    // å„çµæœã‚’ç¢ºèª
    results.forEach((result, index) => {
      const names = ['ã‚¹ã‚¿ãƒƒãƒ•', 'ç¾åœ¨ã®ã‚¹ã‚¿ãƒƒãƒ•', 'æ¡ˆä»¶', 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', 'æ¥­è€…', 'ã‚¿ã‚¹ã‚¯è¨­å®š', 'ã‚«ãƒ†ã‚´ãƒª', 'ã‚¿ã‚¹ã‚¯V2', 'æ¥­è€…V2', 'ã‚¿ã‚¹ã‚¯æ¥­è€…ç´ã¥ã‘', 'å•†å“', 'FCçµ„ç¹”'];
      if (result.status === 'rejected') {
        logError(`âŒ ${names[index]}ã®èª­ã¿è¾¼ã¿å¤±æ•—:`, result.reason);
      } else {
        log(`âœ… ${names[index]}ã®èª­ã¿è¾¼ã¿æˆåŠŸ`);
      }
    });

    // å¤±æ•—ã—ãŸã‚‚ã®ãŒã‚ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    const failedCount = results.filter(r => r.status === 'rejected').length;
    if (failedCount > 0) {
      warn(`âš ï¸ ${failedCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ`);
      showToast(`${failedCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'error');
    }

    // æ¥­è€…ãƒ‡ãƒ¼ã‚¿ã¨ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ï¼ˆä¸¡æ–¹ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸå¾Œã«å®Ÿè¡Œï¼‰
    mergeVendorCategories();

    log('ğŸ¨ ç”»é¢æç”»é–‹å§‹...');
    renderSidebar();
    renderProjects();
    renderTemplates();
    renderVendorsV2();

    // æ–°ã‚·ã‚¹ãƒ†ãƒ ã®UIåˆæœŸåŒ–
    populateVendorCategoryDropdown();
    populateProductDropdown();

    // æ–°ã‚·ã‚¹ãƒ†ãƒ ã®å„ç®¡ç†ç”»é¢ã®åˆæœŸæç”»
    log('ğŸ¨ æ–°ã‚·ã‚¹ãƒ†ãƒ æç”»é–‹å§‹:', {
      vendorsV2Length: vendorsV2.length,
      vendorCategoriesLength: vendorCategories.length,
      tasksV2Length: tasksV2.length,
      taskVendorMappingsLength: taskVendorMappings.length
    });

    renderDesignerListInline();  // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
    renderCategoryFilters();      // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    renderVendorsV2();            // æ¥­è€…ç®¡ç†
    renderCategoriesList();       // ã‚«ãƒ†ã‚´ãƒªç®¡ç†
    renderTasksManagement();      // ã‚¿ã‚¹ã‚¯ç®¡ç†
    renderProductsList();         // å•†å“ç®¡ç†

    // ãƒ¢ãƒã‚¤ãƒ«ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼åˆæœŸåŒ–
    MobileGestures.init();

    // æœŸé™ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ï¼ˆ3ç§’å¾Œã«å®Ÿè¡Œï¼‰
    setTimeout(() => {
      DeadlineManager.checkReminders();
    }, 3000);

    log('âœ… åˆæœŸåŒ–å®Œäº†');
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');

    // åˆå›è¨ªå•æ™‚ã¯ãƒ„ã‚¢ãƒ¼ã‚’è¡¨ç¤º
    AppTour.checkFirstVisit();
  } catch (error) {
    logError('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
  }
}

// ============================================
// ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰
// ============================================
let isReloading = false;

async function forceReloadData() {
  // é‡è¤‡å®Ÿè¡Œé˜²æ­¢
  if (isReloading) {
    showToast('å†èª­ã¿è¾¼ã¿ä¸­ã§ã™...', 'info');
    return;
  }

  isReloading = true;

  // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
  const reloadBtns = document.querySelectorAll('[onclick*="forceReloadData"]');
  reloadBtns.forEach(btn => {
    btn.disabled = true;
    btn.style.opacity = '0.5';
  });

  try {
    showStatus('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ä¸­...', 'saving');

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
    try {
      const cacheNames = await caches.keys();
      for (const name of cacheNames) {
        await caches.delete(name);
      }
    } catch (e) {
      warn('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', e);
    }

    showStatus('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...', 'saving');

    // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
    await init();

    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast(`ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸã€‚æ¡ˆä»¶æ•°: ${projects.length}ä»¶`, 'success');
  } catch (error) {
    logError('å†èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å†èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
  } finally {
    isReloading = false;
    // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
    reloadBtns.forEach(btn => {
      btn.disabled = false;
      btn.style.opacity = '1';
    });
  }
}

// ============================================
// ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰
// ============================================
async function showDebugInfo() {
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ä»¶æ•°ã‚’ç¢ºèª
  let dbProjectsCount = 'å–å¾—ä¸­...';
  let dbDesignersCount = 'å–å¾—ä¸­...';
  let dbError = null;

  try {
    const projectsResult = await supabase.from('projects').select('id', { count: 'exact', head: true });
    const designersResult = await supabase.from('designers').select('id', { count: 'exact', head: true });

    dbProjectsCount = projectsResult.count ?? `ã‚¨ãƒ©ãƒ¼: ${projectsResult.error?.message}`;
    dbDesignersCount = designersResult.count ?? `ã‚¨ãƒ©ãƒ¼: ${designersResult.error?.message}`;

    if (projectsResult.error) dbError = projectsResult.error;
    if (designersResult.error) dbError = designersResult.error;
  } catch (e) {
    dbError = e;
  }

  const info = `
ArchiDeck ãƒ‡ãƒãƒƒã‚°æƒ…å ±
========================
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${APP_VERSION}
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser?.email || 'æœªãƒ­ã‚°ã‚¤ãƒ³'}
ã‚«ãƒ†ã‚´ãƒª: ${currentUserCategory || 'æœªé¸æŠ'}
æ‹…å½“ã‚¿ãƒ–: ${currentDesignerTab}

ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ‡ãƒ¼ã‚¿
----------------
æ¡ˆä»¶æ•°: ${projects.length}ä»¶
ã‚¹ã‚¿ãƒƒãƒ•æ•°: ${designers.length}äºº
ã‚¿ã‚¹ã‚¯æ•°: ${tasksV2.length}ä»¶
æ¥­è€…æ•°: ${vendorsV2.length}ä»¶

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›´æ¥ç¢ºèª
--------------------
DBæ¡ˆä»¶æ•°: ${dbProjectsCount}ä»¶
DBã‚¹ã‚¿ãƒƒãƒ•æ•°: ${dbDesignersCount}äºº
${dbError ? `DBã‚¨ãƒ©ãƒ¼: ${dbError.message || dbError}` : ''}

æ¡ˆä»¶è©³ç´°
--------
${projects.slice(0, 5).map(p => `ãƒ»${p.customer} (è¨­è¨ˆ:${p.assigned_to || 'æœªå‰²å½“'}, IC:${p.ic_assignee || 'æœªå‰²å½“'})`).join('\n')}
${projects.length > 5 ? `...ä»–${projects.length - 5}ä»¶` : ''}
${projects.length === 0 ? 'ï¼ˆæ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰' : ''}

ã‚¹ã‚¿ãƒƒãƒ•è©³ç´°
----------
${designers.slice(0, 5).map(d => `ãƒ»${d.name} (${d.category})`).join('\n')}
${designers.length > 5 ? `...ä»–${designers.length - 5}äºº` : ''}
${designers.length === 0 ? 'ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰' : ''}

ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–çŠ¶æ³
--------------
ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: ${projects.filter(p => !p.is_archived).length}ä»¶
å®Œäº†æ¸ˆã¿: ${projects.filter(p => p.is_archived).length}ä»¶

ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
----------
ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: ${document.getElementById('archiveFilter')?.value || 'ä¸æ˜'}
æ¤œç´¢: ${document.getElementById('searchQuery')?.value || 'ãªã—'}
å•†å“: ${document.getElementById('specFilter')?.value || 'å…¨ã¦'}

RLSæ³¨æ„
-------
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ•°ãŒã‚ã£ã¦ã‚‚ãƒ¡ãƒ¢ãƒªãŒ0ã®å ´åˆã€
RLS(Row Level Security)ãŒãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹
å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚Supabaseç®¡ç†ç”»é¢ã§RLSè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
  `.trim();

  alert(info);
  log(info);

  // ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã®å ´åˆã¯è­¦å‘Šã‚’è¡¨ç¤º
  if (projects.length === 0 || designers.length === 0) {
    logError('ğŸš¨ ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±å•é¡Œæ¤œå‡ºï¼');
    logError('Supabaseã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:');
    logError('1. projectsãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹');
    logError('2. designersãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹');
    logError('3. RLSãƒãƒªã‚·ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹');
    logError('4. anon keyã«é©åˆ‡ãªæ¨©é™ãŒã‚ã‚‹ã‹');
  }
}

// ============================================
// ãƒ‡ãƒãƒƒã‚°ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
// ============================================
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ debug() ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€å…¨ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
window.debug = function() {
  log('='.repeat(80));
  log('ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±');
  log('='.repeat(80));

  log('\nğŸ“Š åŸºæœ¬æƒ…å ±:');
  log('  - ã‚¹ã‚¿ãƒƒãƒ•æ•°:', designers.length);
  log('  - æ¡ˆä»¶æ•°:', projects.length);
  log('  - ã‚¿ã‚¹ã‚¯æ•°:', tasksV2.length);
  log('  - æ¥­è€…æ•°:', vendorsV2.length);

  log('\nğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§:');
  designers.forEach(d => {
    log(`  - [${d.category}] ${d.name} (${d.email})`);
  });

  log('\nğŸ“‹ æ¡ˆä»¶ä¸€è¦§:');
  projects.forEach(p => {
    log(`  - ${p.customer}`);
    log(`    è¨­è¨ˆ: "${p.assigned_to}" (trim: "${(p.assigned_to || '').trim()}")`);
    log(`    IC: "${p.ic_assignee}" (trim: "${(p.ic_assignee || '').trim()}")`);
    log(`    status: ${p.status}, is_archived: ${p.is_archived}`);
  });

  log('\n' + '='.repeat(80));
  return 'ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚ä¸Šè¨˜ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
};

// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ checkAssignment('æ‹…å½“è€…å', 'æ¡ˆä»¶å') ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€è©³ç´°ãƒã‚§ãƒƒã‚¯ãŒã§ãã¾ã™
window.checkAssignment = function(designerName, projectName) {
  log('='.repeat(80));
  log(`ğŸ” å‰²ã‚Šå½“ã¦ãƒã‚§ãƒƒã‚¯: ${designerName} â†’ ${projectName}`);
  log('='.repeat(80));

  const designer = designers.find(d => d.name.includes(designerName));
  if (!designer) {
    logError(`âŒ ã‚¹ã‚¿ãƒƒãƒ• "${designerName}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
    log('ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚¿ãƒƒãƒ•:', designers.map(d => d.name));
    return;
  }

  const project = projects.find(p => p.customer.includes(projectName));
  if (!project) {
    logError(`âŒ æ¡ˆä»¶ "${projectName}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
    log('ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹æ¡ˆä»¶:', projects.map(p => p.customer));
    return;
  }

  log('\nâœ… ãƒ‡ãƒ¼ã‚¿ç¢ºèª:');
  log('ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±:', {
    name: designer.name,
    nameLength: designer.name.length,
    nameTrimmed: designer.name.trim(),
    category: designer.category,
    email: designer.email
  });

  log('\næ¡ˆä»¶æƒ…å ±:', {
    customer: project.customer,
    assigned_to: `"${project.assigned_to}"`,
    assigned_to_length: project.assigned_to?.length,
    assigned_to_trimmed: `"${(project.assigned_to || '').trim()}"`,
    ic_assignee: `"${project.ic_assignee}"`,
    ic_assignee_length: project.ic_assignee?.length,
    ic_assignee_trimmed: `"${(project.ic_assignee || '').trim()}"`,
    status: project.status,
    is_archived: project.is_archived
  });

  log('\nğŸ” ãƒãƒƒãƒãƒ³ã‚°çµæœ:');
  const designerNameTrimmed = designer.name.trim();
  const assignedToTrimmed = (project.assigned_to || '').trim();
  const icAssigneeTrimmed = (project.ic_assignee || '').trim();

  const matchAssigned = assignedToTrimmed === designerNameTrimmed;
  const matchIC = icAssigneeTrimmed === designerNameTrimmed;
  const statusOK = project.status !== 'completed';
  const archivedOK = !project.is_archived;
  const finalMatch = (matchAssigned || matchIC) && statusOK && archivedOK;

  log(`  - assigned_toä¸€è‡´: ${matchAssigned ? 'âœ…' : 'âŒ'} ("${assignedToTrimmed}" === "${designerNameTrimmed}")`);
  log(`  - ic_assigneeä¸€è‡´: ${matchIC ? 'âœ…' : 'âŒ'} ("${icAssigneeTrimmed}" === "${designerNameTrimmed}")`);
  log(`  - statusãƒã‚§ãƒƒã‚¯: ${statusOK ? 'âœ…' : 'âŒ'} (status !== "completed")`);
  log(`  - archivedãƒã‚§ãƒƒã‚¯: ${archivedOK ? 'âœ…' : 'âŒ'} (!is_archived)`);
  log(`  - æœ€çµ‚åˆ¤å®š: ${finalMatch ? 'âœ… ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹' : 'âŒ ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œãªã„'}`);

  if (!finalMatch) {
    log('\nğŸ’¡ ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œãªã„ç†ç”±:');
    if (!matchAssigned && !matchIC) {
      log('  - æ‹…å½“è€…åãŒä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“');
      if (assignedToTrimmed !== designerNameTrimmed) {
        log(`    è¨­è¨ˆ: "${assignedToTrimmed}" â‰  "${designerNameTrimmed}"`);
      }
      if (icAssigneeTrimmed !== designerNameTrimmed) {
        log(`    IC: "${icAssigneeTrimmed}" â‰  "${designerNameTrimmed}"`);
      }
    }
    if (!statusOK) {
      log(`  - statusãŒ "completed" ã§ã™`);
    }
    if (!archivedOK) {
      log(`  - is_archived ãŒ true ã§ã™`);
    }
  }

  log('\n' + '='.repeat(80));
  return finalMatch ? 'ã“ã®æ¡ˆä»¶ã¯ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã™ âœ…' : 'ã“ã®æ¡ˆä»¶ã¯ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã›ã‚“ âŒ';
};

log('ğŸ’¡ ãƒ‡ãƒãƒƒã‚°é–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã§ã™:');
log('  - debug() : å…¨ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ã‚’è¡¨ç¤º');
log('  - checkAssignment("æ‹…å½“è€…å", "æ¡ˆä»¶å") : å‰²ã‚Šå½“ã¦ãƒã‚§ãƒƒã‚¯');

// ============================================
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// ============================================
async function loadDesigners() {
  log('ğŸ”„ ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');

  try {
    const { data, error, count } = await supabase
      .from('designers')
      .select('*', { count: 'exact' })
      .order('display_order');

    log('ğŸ“¡ Supabaseãƒ¬ã‚¹ãƒãƒ³ã‚¹:', {
      success: !error,
      dataLength: data?.length || 0,
      count: count,
      error: error,
      rawDataSample: data?.slice(0, 3)
    });

    if (error) {
      logError('âŒ ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      logError('ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      designers = [];
      return;
    }

    designers = data || [];

    // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®å†…è¨³ã‚’è¡¨ç¤º
    const byCategory = designers.reduce((acc, d) => {
      const cat = d.category || '(ãªã—)';
      acc[cat] = (acc[cat] || 0) + 1;
      return acc;
    }, {});

    log('âœ… ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', {
      'ç·æ•°': designers.length,
      'ã‚«ãƒ†ã‚´ãƒªåˆ¥': byCategory,
      'ã‚µãƒ³ãƒ—ãƒ«': designers.slice(0, 3).map(d => ({ name: d.name, category: d.category, email: d.email }))
    });

    if (designers.length === 0) {
      warn('âš ï¸ è­¦å‘Š: ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã§ã™ï¼Supabaseã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
  } catch (err) {
    logError('âŒ loadDesigners()ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', err);
    designers = [];
  }
}

async function loadCurrentDesigner() {
  if (!currentUser || !currentUser.email) return;

  // admin@ghouse.jpã®å ´åˆã¯ã‚¹ã‚¿ãƒƒãƒ•ã‚’ç‰¹å®šã—ãªã„ï¼ˆå…¨æ¡ˆä»¶é–²è¦§å¯èƒ½ï¼‰
  if (currentUser.email === 'admin@ghouse.jp') {
    currentDesigner = null;
    return;
  }

  const { data, error } = await supabase
    .from('designers')
    .select('*')
    .eq('email', currentUser.email)
    .single();

  if (error) {
    warn('ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error);
    currentDesigner = null;
    return;
  }

  currentDesigner = data;
  log('ç¾åœ¨ã®ã‚¹ã‚¿ãƒƒãƒ•:', currentDesigner);
}

async function loadProjects() {
  log('ğŸ”„ æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
  try {
    const { data, error } = await supabase
      .from('projects')
      .select('*')
      .order('created_at', { ascending: false });
    if (error) {
      logError('âŒ æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      projects = [];
      return;
    }
    projects = data || [];
    log('âœ… æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', projects.length, 'ä»¶');
    log('ğŸ“‹ èª­ã¿è¾¼ã‚“ã æ¡ˆä»¶ã®è©³ç´°:');
    projects.forEach(p => {
      log(`  - ${p.customer}: assigned_to="${p.assigned_to}", ic_assignee="${p.ic_assignee}"`);
    });

    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: assigned_toã¨ic_assigneeã®å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
    await cleanupProjectAssignees();
  } catch (err) {
    logError('âŒ loadProjects()ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', err);
    projects = [];
  }
}

async function cleanupProjectAssignees() {
  log('ğŸ§¹ æ¡ˆä»¶ã®æ‹…å½“è€…ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­...');
  let updatedCount = 0;

  for (const project of projects) {
    // "null"ã¨ã„ã†æ–‡å­—åˆ—ã‚‚nullã¨ã—ã¦æ‰±ã†
    let assigned = (project.assigned_to || '').trim();
    let icAssigned = (project.ic_assignee || '').trim();

    if (assigned === 'null' || assigned === 'undefined') assigned = '';
    if (icAssigned === 'null' || icAssigned === 'undefined') icAssigned = '';

    let needsUpdate = false;

    // trim()ã—ãŸçµæœãŒå…ƒã®å€¤ã¨é•ã†å ´åˆã€ã¾ãŸã¯"null"æ–‡å­—åˆ—ã®å ´åˆã¯æ›´æ–°
    if (project.assigned_to !== assigned ||
        project.ic_assignee !== icAssigned ||
        project.assigned_to === 'null' ||
        project.ic_assignee === 'null') {
      needsUpdate = true;
    }

    if (needsUpdate) {
      log(`ğŸ”§ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: ${project.customer} (assigned_to: "${project.assigned_to}" â†’ "${assigned || 'null'}", ic_assignee: "${project.ic_assignee}" â†’ "${icAssigned || 'null'}")`);

      const { error } = await supabase
        .from('projects')
        .update({
          assigned_to: assigned || null,
          ic_assignee: icAssigned || null
        })
        .eq('id', project.id);

      if (!error) {
        project.assigned_to = assigned || null;
        project.ic_assignee = icAssigned || null;
        updatedCount++;
      } else {
        logError('âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¤±æ•—:', project.customer, error);
      }
    }
  }

  if (updatedCount > 0) {
    log(`âœ… ${updatedCount}ä»¶ã®æ¡ˆä»¶ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ`);
  } else {
    log('âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸è¦ï¼ˆå…¨æ¡ˆä»¶æ­£å¸¸ï¼‰');
  }
}

async function loadEmailTemplates() {
  log('ğŸ”„ ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
  try {
    const { data, error } = await supabase
      .from('email_templates')
      .select('*')
      .order('display_name');
    if (error) {
      logError('âŒ ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      emailTemplates = [];
      return;
    }
    emailTemplates = data || [];
    log('âœ… ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', emailTemplates.length, 'ä»¶');
  } catch (err) {
    logError('âŒ loadEmailTemplates()ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', err);
    emailTemplates = [];
  }
}

async function loadVendors() {
  log('ğŸ”„ æ¥­è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
  try {
    const { data, error } = await supabase
      .from('template_vendors')
      .select('*')
      .order('company');
    if (error) {
      logError('âŒ æ¥­è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      vendors = [];
      return;
    }
    vendors = data || [];
    log('âœ… æ¥­è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', vendors.length, 'ä»¶');
  } catch (err) {
    logError('âŒ loadVendors()ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', err);
    vendors = [];
  }
}

async function loadTaskMappings() {
  log('ğŸ”„ ã‚¿ã‚¹ã‚¯ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
  try {
    const { data, error } = await supabase
      .from('task_template_mappings')
      .select('*');
    if (error) {
      logError('âŒ ã‚¿ã‚¹ã‚¯ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      taskMappings = {};
      return;
    }
    taskMappings = {};
    (data || []).forEach(mapping => {
      taskMappings[mapping.task_key] = mapping.template_id;
    });
    log('âœ… ã‚¿ã‚¹ã‚¯ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', Object.keys(taskMappings).length, 'ä»¶');
  } catch (err) {
    logError('âŒ loadTaskMappings()ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', err);
    taskMappings = {};
  }
}

// æ–°ã‚·ã‚¹ãƒ†ãƒ ç”¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
async function loadVendorCategories() {
  const { data, error } = await supabase
    .from('vendor_categories')
    .select('*')
    .order('display_order');

  if (error) {
    logError('âŒ æ¥­è€…ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    vendorCategories = [];
    return;
  }

  vendorCategories = data || [];
  log('âœ… æ¥­è€…ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿å®Œäº†:', vendorCategories.length, 'ä»¶');
}

async function loadTasksV2() {
  const { data, error } = await supabase
    .from('tasks')
    .select('*')
    .order('display_order');

  if (error) {
    logError('âŒ ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    tasksV2 = [];
    return;
  }

  tasksV2 = data || [];
  log('âœ… ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿å®Œäº†:', tasksV2.length, 'ä»¶');
}

async function loadVendorsV2() {
  log('ğŸ”„ æ¥­è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...', {
    timestamp: new Date().toISOString()
  });

  const { data, error } = await supabase
    .from('vendors_v2')
    .select('*')
    .order('company');

  log('ğŸ“¡ loadVendorsV2 Supabaseãƒ¬ã‚¹ãƒãƒ³ã‚¹:', {
    success: !error,
    dataLength: data?.length || 0,
    error: error,
    rawData: data
  });

  if (error) {
    logError('âŒ æ¥­è€…èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    showToast('æ¥­è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    vendorsV2 = [];
    return;
  }

  if (!data || data.length === 0) {
    logError('âš ï¸ CRITICAL: vendors_v2ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã§ã™ï¼');
    warn('vendors_v2ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');
    vendorsV2 = [];
    return;
  }

  vendorsV2 = data || [];
  log('âœ… æ¥­è€…èª­ã¿è¾¼ã¿å®Œäº†:', vendorsV2.length, 'ä»¶');
  log('âœ… æ¥­è€…ãƒ‡ãƒ¼ã‚¿è©³ç´°:', vendorsV2);
}

function mergeVendorCategories() {
  log('ğŸ”— mergeVendorCategories() é–‹å§‹:', {
    vendorsV2Length: vendorsV2.length,
    vendorCategoriesLength: vendorCategories.length,
    vendorCategories: vendorCategories
  });

  // ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã‚’æ¥­è€…ãƒ‡ãƒ¼ã‚¿ã«ãƒãƒ¼ã‚¸ï¼ˆPromise.allSettledå®Œäº†å¾Œã«å‘¼ã³å‡ºã™ï¼‰
  if (vendorsV2.length > 0 && vendorCategories.length > 0) {
    vendorsV2 = vendorsV2.map(vendor => {
      const category = vendorCategories.find(c => c.id === vendor.category_id);
      return {
        ...vendor,
        vendor_categories: category ? { name: category.name } : null
      };
    });
    log('âœ… æ¥­è€…-ã‚«ãƒ†ã‚´ãƒªãƒãƒ¼ã‚¸å®Œäº†:', vendorsV2.slice(0, 2));
  } else {
    warn('âš ï¸ ãƒãƒ¼ã‚¸ã‚¹ã‚­ãƒƒãƒ—:', {
      vendorsV2Empty: vendorsV2.length === 0,
      vendorCategoriesEmpty: vendorCategories.length === 0
    });
  }
}

async function loadTaskVendorMappings() {
  const { data, error } = await supabase
    .from('task_vendor_mappings_v2')
    .select('*');

  if (error) {
    logError('âŒ ã‚¿ã‚¹ã‚¯-æ¥­è€…ç´ã¥ã‘èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    taskVendorMappings = [];
    return;
  }

  taskVendorMappings = data || [];
  log('âœ… ã‚¿ã‚¹ã‚¯-æ¥­è€…ç´ã¥ã‘èª­ã¿è¾¼ã¿å®Œäº†:', taskVendorMappings.length, 'ä»¶');
}

async function loadProducts() {
  const { data, error } = await supabase
    .from('products')
    .select('*')
    .order('display_order');
  if (!error && data) {
    products = data;
  } else {
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    products = [
      { id: '1', name: 'LIFE', display_order: 1 },
      { id: '2', name: 'LIFE+', display_order: 2 },
      { id: '3', name: 'HOURS', display_order: 3 },
      { id: '4', name: 'LACIE', display_order: 4 },
      { id: '5', name: 'LIFE Limited', display_order: 5 },
      { id: '6', name: 'LIFE+ Limited', display_order: 6 }
    ];
  }
  log('âœ… å•†å“èª­ã¿è¾¼ã¿å®Œäº†:', products.length, 'ä»¶');
}

// ============================================
// æ¥­è€…ç®¡ç†V2
// ============================================
let currentCategoryFilter = 'ALL';

function renderVendorsV2() {
  log('ğŸ“ renderVendorsV2() å‘¼ã³å‡ºã—é–‹å§‹');
  log('ğŸ“Š vendorsV2é…åˆ—ã®çŠ¶æ…‹:', {
    length: vendorsV2.length,
    data: vendorsV2.slice(0, 3),
    'å…¨ãƒ‡ãƒ¼ã‚¿': vendorsV2
  });

  const container = document.getElementById('vendorsGrid');
  log('ğŸ¯ vendorsGridè¦ç´ :', container ? 'found âœ“' : 'NOT FOUND âœ—');

  if (!container) {
    logError('âŒ CRITICAL: vendorsGridè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼');
    log('ğŸ“ ç¾åœ¨ã®DOMçŠ¶æ…‹:', document.getElementById('vendorsPanel'));
    return;
  }

  log('ğŸ” renderVendorsV2():', {
    totalVendors: vendorsV2.length,
    currentFilter: currentCategoryFilter,
    vendors: vendorsV2
  });

  const filtered = currentCategoryFilter === 'ALL'
    ? vendorsV2
    : vendorsV2.filter(v => v.category_id === currentCategoryFilter);

  log('ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œã®æ¥­è€…æ•°:', filtered.length);

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><p>æ¥­è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br><small>ã€Œ+ æ¥­è€…è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„</small></p></div>';
    return;
  }

  container.innerHTML = filtered.map(vendor => {
    const categoryName = vendor.vendor_categories?.name || 'æœªåˆ†é¡';
    return `
      <div class="vendor-card">
        <div class="vendor-header">
          <h3>${escapeHtml(vendor.company)}</h3>
          <span class="badge badge-primary">${escapeHtml(categoryName)}</span>
        </div>
        <div class="vendor-info">
          <div><strong>æ‹…å½“è€…:</strong> ${escapeHtml(vendor.contact || '-')}</div>
          <div><strong>TEL:</strong> ${escapeHtml(vendor.tel || '-')}</div>
          <div><strong>Email:</strong> ${escapeHtml(vendor.email || '-')}</div>
        </div>
        <div class="vendor-actions">
          <button class="btn btn-secondary btn-small" onclick="editVendorV2('${vendor.id}')">ç·¨é›†</button>
          <button class="btn btn-danger btn-small" onclick="deleteVendorV2('${vendor.id}')">å‰Šé™¤</button>
        </div>
      </div>
    `;
  }).join('');
}

function setCategoryFilter(categoryId, e) {
  currentCategoryFilter = categoryId;
  document.querySelectorAll('.category-filter-btn').forEach(btn => btn.classList.remove('active'));
  if (e && e.target) {
    e.target.classList.add('active');
  }
  renderVendorsV2();
}

function openVendorModalV2(vendorId = null) {
  const modal = document.getElementById('vendorModalV2');
  const title = document.getElementById('vendorModalTitle');

  // ã‚«ãƒ†ã‚´ãƒªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
  populateVendorCategoryDropdown();

  if (vendorId) {
    const vendor = vendorsV2.find(v => v.id === vendorId);
    if (!vendor) return;

    title.textContent = 'æ¥­è€…ç·¨é›†';
    document.getElementById('vendorId').value = vendor.id;
    document.getElementById('vendorCompany').value = vendor.company;
    document.getElementById('vendorContact').value = vendor.contact || '';
    document.getElementById('vendorTel').value = vendor.tel || '';
    document.getElementById('vendorEmail').value = vendor.email || '';
    document.getElementById('vendorCategory').value = vendor.category_id || '';
    document.getElementById('vendorSubject').value = vendor.subject_format || '';
    document.getElementById('vendorTemplate').value = vendor.template_text || '';
  } else {
    title.textContent = 'æ¥­è€…è¿½åŠ ';
    document.getElementById('vendorForm').reset();
    document.getElementById('vendorId').value = '';
  }

  ModalManager.open(modal, '#vendorCompany');
}

function closeVendorModalV2() {
  ModalManager.close(document.getElementById('vendorModalV2'));
}

async function saveVendorV2() {
  // äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
  if (SaveGuard.isLocked('saveVendorV2')) return;

  const id = document.getElementById('vendorId').value;
  const company = document.getElementById('vendorCompany').value.trim();
  const contact = document.getElementById('vendorContact').value.trim();
  const tel = document.getElementById('vendorTel').value.trim();
  const email = document.getElementById('vendorEmail').value.trim();
  const categoryId = document.getElementById('vendorCategory').value;
  const subjectFormat = document.getElementById('vendorSubject').value.trim();
  const templateText = document.getElementById('vendorTemplate').value.trim();

  if (!company) {
    showToast('ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  await SaveGuard.run('saveVendorV2', async () => {
    showStatus('ä¿å­˜ä¸­...', 'saving');

    const vendorData = {
      company,
      contact: contact || null,
      tel: tel || null,
      email: email || null,
      category_id: categoryId || null,
      subject_format: subjectFormat || null,
      template_text: templateText || null
    };

    let result;
    if (id) {
      result = await supabase
        .from('vendors_v2')
        .update(vendorData)
        .eq('id', id)
        .select('*, vendor_categories(name)');
    } else {
      result = await supabase
        .from('vendors_v2')
        .insert([vendorData])
        .select('*, vendor_categories(name)');
    }

    if (result.error) {
      showStatus('ä¿å­˜å¤±æ•—', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error.message, 'error');
      return;
    }

    showStatus('ä¿å­˜å®Œäº†', 'success');
    showToast(id ? 'æ¥­è€…ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'æ¥­è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    closeVendorModalV2();
    await loadVendorsV2();
    renderVendorsV2();
  });
}

function editVendorV2(vendorId) {
  openVendorModalV2(vendorId);
}

async function deleteVendorV2(vendorId) {
  const vendor = vendorsV2.find(v => v.id === vendorId);
  if (!vendor) return;

  if (!confirm(`ã€Œ${vendor.company}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  await SaveGuard.run(`deleteVendor_${vendorId}`, async () => {
    showStatus('å‰Šé™¤ä¸­...', 'saving');

    const { error } = await supabase
      .from('vendors_v2')
      .delete()
      .eq('id', vendorId);

    if (error) {
      showStatus('å‰Šé™¤å¤±æ•—', 'error');
      showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    showStatus('å‰Šé™¤å®Œäº†', 'success');
    showToast('æ¥­è€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    await loadVendorsV2();
    renderVendorsV2();
  });
}

// ============================================
// ã‚«ãƒ†ã‚´ãƒªç®¡ç†
// ============================================
function renderCategoriesList() {
  const container = document.getElementById('categoriesGrid');
  if (!container) return;

  if (vendorCategories.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ·ï¸</div><p>ã‚«ãƒ†ã‚´ãƒªãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
    return;
  }

  // è¡¨ç¤ºé †ã§ã‚½ãƒ¼ãƒˆ
  const sortedCategories = [...vendorCategories].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>ã‚«ãƒ†ã‚´ãƒªå</th>
            <th style="width: 100px;">æ¥­è€…æ•°</th>
            <th style="width: 180px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          ${sortedCategories.map(cat => {
            const count = vendorsV2.filter(v => v.category_id === cat.id).length;
            return `
              <tr draggable="true" ondragstart="handleCategoryDragStart(event, '${cat.id}')" ondragover="handleCategoryDragOver(event)" ondrop="handleCategoryDrop(event, '${cat.id}')" style="cursor: move;">
                <td><span style="color: var(--text-muted);">â‹®â‹®</span></td>
                <td><strong>${cat.name}</strong></td>
                <td>${count}ç¤¾</td>
                <td>
                  <button class="btn btn-secondary btn-small" onclick="editCategory('${cat.id}')">ç·¨é›†</button>
                  <button class="btn btn-danger btn-small" onclick="deleteCategory('${cat.id}')">å‰Šé™¤</button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function openCategoryModal(categoryId = null) {
  const modal = document.getElementById('categoryModal');
  const title = document.getElementById('categoryModalTitle');

  if (categoryId) {
    const category = vendorCategories.find(c => c.id === categoryId);
    if (!category) return;

    title.textContent = 'ã‚«ãƒ†ã‚´ãƒªç·¨é›†';
    document.getElementById('categoryId').value = category.id;
    document.getElementById('categoryName').value = category.name;
    document.getElementById('categoryOrder').value = category.display_order;
  } else {
    title.textContent = 'ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ';
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryId').value = '';
    document.getElementById('categoryOrder').value = vendorCategories.length + 1;
  }

  ModalManager.open(modal, '#categoryName');
}

function closeCategoryModal() {
  ModalManager.close(document.getElementById('categoryModal'));
}

async function saveCategory() {
  if (SaveGuard.isLocked('saveCategory')) return;

  const id = document.getElementById('categoryId').value;
  const name = document.getElementById('categoryName').value.trim();
  const order = parseInt(document.getElementById('categoryOrder').value) || 0;

  if (!name) {
    showToast('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  await SaveGuard.run('saveCategory', async () => {
    showStatus('ä¿å­˜ä¸­...', 'saving');

    const categoryData = {
      name,
      display_order: order
    };

    let result;
    if (id) {
      result = await supabase
        .from('vendor_categories')
        .update(categoryData)
        .eq('id', id)
        .select();
    } else {
      result = await supabase
        .from('vendor_categories')
        .insert([categoryData])
        .select();
    }

    if (result.error) {
      showStatus('ä¿å­˜å¤±æ•—', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error.message, 'error');
      return;
    }

    showStatus('ä¿å­˜å®Œäº†', 'success');
    showToast(id ? 'ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    closeCategoryModal();
    await loadVendorCategories();
    renderCategoriesList();
    renderCategoryFilters();
  });
}

function editCategory(categoryId) {
  openCategoryModal(categoryId);
}

async function deleteCategory(categoryId) {
  const category = vendorCategories.find(c => c.id === categoryId);
  if (!category) return;

  const vendorCount = vendorsV2.filter(v => v.category_id === categoryId).length;
  if (vendorCount > 0) {
    showToast(`ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ã¯${vendorCount}ç¤¾ã®æ¥­è€…ãŒç´ã¥ã„ã¦ã„ã¾ã™ã€‚å…ˆã«æ¥­è€…ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚`, 'error');
    return;
  }

  if (!confirm(`ã‚«ãƒ†ã‚´ãƒªã€Œ${category.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  await SaveGuard.run(`deleteCategory_${categoryId}`, async () => {
    showStatus('å‰Šé™¤ä¸­...', 'saving');

    const { error } = await supabase
      .from('vendor_categories')
      .delete()
      .eq('id', categoryId);

    if (error) {
      showStatus('å‰Šé™¤å¤±æ•—', 'error');
      showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    showStatus('å‰Šé™¤å®Œäº†', 'success');
    showToast('ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    await loadVendorCategories();
    renderCategoriesList();
    renderCategoryFilters();
  });
}

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤ºé †ã‚’å¤‰æ›´
let draggedCategoryId = null;

function handleCategoryDragStart(event, categoryId) {
  draggedCategoryId = categoryId;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.5';
}

function handleCategoryDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  return false;
}

async function handleCategoryDrop(event, targetCategoryId) {
  event.preventDefault();
  event.stopPropagation();

  if (!draggedCategoryId || draggedCategoryId === targetCategoryId) {
    resetCategoryDragState();
    return;
  }

  const draggedCategory = vendorCategories.find(c => c.id === draggedCategoryId);
  const targetCategory = vendorCategories.find(c => c.id === targetCategoryId);

  if (!draggedCategory || !targetCategory) {
    resetCategoryDragState();
    return;
  }

  // è¡¨ç¤ºé †ã‚’å…¥ã‚Œæ›¿ãˆ
  const draggedOrder = draggedCategory.display_order;
  const targetOrder = targetCategory.display_order;

  showStatus('ä¸¦ã³æ›¿ãˆä¸­...', 'saving');

  // ä¸¡æ–¹ã®ã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤ºé †ã‚’æ›´æ–°
  const updates = [
    supabase.from('vendor_categories').update({ display_order: targetOrder }).eq('id', draggedCategoryId),
    supabase.from('vendor_categories').update({ display_order: draggedOrder }).eq('id', targetCategoryId)
  ];

  const results = await Promise.all(updates);

  if (results.some(r => r.error)) {
    showStatus('ä¸¦ã³æ›¿ãˆå¤±æ•—', 'error');
    showToast('ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    resetCategoryDragState();
    return;
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
  draggedCategory.display_order = targetOrder;
  targetCategory.display_order = draggedOrder;

  // å†æç”»
  renderCategoriesList();
  renderCategoryFilters();
  showStatus('ä¸¦ã³æ›¿ãˆå®Œäº†', 'success');
  showToast('è¡¨ç¤ºé †ã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success');
  resetCategoryDragState();
}

function resetCategoryDragState() {
  draggedCategoryId = null;
  // ã™ã¹ã¦ã®è¡Œã®é€æ˜åº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
  document.querySelectorAll('#categoriesGrid tr[draggable]').forEach(tr => {
    tr.style.opacity = '1';
  });
}

function renderCategoryFilters() {
  const container = document.getElementById('categoryFilters');
  if (!container) return;

  let html = `<button class="category-filter-btn ${currentCategoryFilter === 'ALL' ? 'active' : ''}" onclick="setCategoryFilter('ALL', event)">å…¨ã¦ (${vendorsV2.length})</button>`;

  vendorCategories.forEach(cat => {
    const count = vendorsV2.filter(v => v.category_id === cat.id).length;
    html += `<button class="category-filter-btn ${currentCategoryFilter === cat.id ? 'active' : ''}" onclick="setCategoryFilter('${cat.id}', event)">${escapeHtml(cat.name)} (${count})</button>`;
  });

  container.innerHTML = html;
}

// ============================================
// å•†å“ç®¡ç†
// ============================================
function renderProductsList() {
  const container = document.getElementById('productsGrid');
  if (!container) return;

  if (products.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><p>å•†å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
    return;
  }

  // è¡¨ç¤ºé †ã§ã‚½ãƒ¼ãƒˆ
  const sortedProducts = [...products].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));

  container.innerHTML = '<div class="table-container"><table class="table"><thead><tr><th style="width: 60px;"></th><th>å•†å“å</th><th style="width: 100px;">æ“ä½œ</th></tr></thead><tbody>' +
    sortedProducts.map(product => `
      <tr draggable="true" ondragstart="handleProductDragStart(event, '${product.id}')" ondragover="handleProductDragOver(event)" ondrop="handleProductDrop(event, '${product.id}')" style="cursor: move;">
        <td><span style="color: var(--text-muted);">â‹®â‹®</span></td>
        <td><strong>${escapeHtml(product.name)}</strong></td>
        <td><button class="btn btn-danger btn-small" onclick="deleteProductInline('${product.id}')">å‰Šé™¤</button></td>
      </tr>
    `).join('') +
    '</tbody></table></div>';
}

async function addProductInline() {
  const name = document.getElementById('newProductNameInline').value.trim();

  if (!name) {
    showToast('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (products.find(p => p.name === name)) {
    showToast('æ—¢ã«å­˜åœ¨ã™ã‚‹å•†å“åã§ã™', 'error');
    return;
  }

  showStatus('è¿½åŠ ä¸­...', 'saving');

  const maxDisplayOrder = products.length > 0 ? Math.max(...products.map(p => p.display_order || 0)) : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('products')
    .insert([{ name, display_order: newDisplayOrder }])
    .select();

  if (error) {
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ã«è¿½åŠ 
    products.push({ id: Date.now().toString(), name, display_order: newDisplayOrder });
    document.getElementById('newProductNameInline').value = '';
    renderProductsList();
    populateProductDropdown();
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast('å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰', 'success');
    return;
  }

  products.push(data[0]);
  document.getElementById('newProductNameInline').value = '';
  renderProductsList();
  populateProductDropdown();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

async function deleteProductInline(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;

  if (!confirm(`å•†å“ã€Œ${product.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');

  const { error } = await supabase
    .from('products')
    .delete()
    .eq('id', productId);

  if (error && !error.message.includes('does not exist')) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  products = products.filter(p => p.id !== productId);
  renderProductsList();
  populateProductDropdown();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§å•†å“ã®è¡¨ç¤ºé †ã‚’å¤‰æ›´
let draggedProductId = null;

function handleProductDragStart(event, productId) {
  draggedProductId = productId;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.5';
}

function handleProductDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  return false;
}

async function handleProductDrop(event, targetProductId) {
  event.preventDefault();
  event.stopPropagation();

  if (!draggedProductId || draggedProductId === targetProductId) {
    resetProductDragState();
    return;
  }

  const draggedProduct = products.find(p => p.id === draggedProductId);
  const targetProduct = products.find(p => p.id === targetProductId);

  if (!draggedProduct || !targetProduct) {
    resetProductDragState();
    return;
  }

  // è¡¨ç¤ºé †ã‚’å…¥ã‚Œæ›¿ãˆ
  const draggedOrder = draggedProduct.display_order;
  const targetOrder = targetProduct.display_order;

  showStatus('ä¸¦ã³æ›¿ãˆä¸­...', 'saving');

  // ä¸¡æ–¹ã®å•†å“ã®è¡¨ç¤ºé †ã‚’æ›´æ–°
  const updates = [
    supabase.from('products').update({ display_order: targetOrder }).eq('id', draggedProductId),
    supabase.from('products').update({ display_order: draggedOrder }).eq('id', targetProductId)
  ];

  const results = await Promise.all(updates);

  if (results.some(r => r.error)) {
    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã§æ›´æ–°
    draggedProduct.display_order = targetOrder;
    targetProduct.display_order = draggedOrder;
    renderProductsList();
    populateProductDropdown();
    showStatus('ä¸¦ã³æ›¿ãˆå®Œäº†', 'success');
    showToast('è¡¨ç¤ºé †ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰', 'success');
    resetProductDragState();
    return;
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
  draggedProduct.display_order = targetOrder;
  targetProduct.display_order = draggedOrder;

  // å†æç”»
  renderProductsList();
  populateProductDropdown();
  showStatus('ä¸¦ã³æ›¿ãˆå®Œäº†', 'success');
  showToast('è¡¨ç¤ºé †ã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success');
  resetProductDragState();
}

function resetProductDragState() {
  draggedProductId = null;
  // ã™ã¹ã¦ã®è¡Œã®é€æ˜åº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
  document.querySelectorAll('#productsGrid tr[draggable]').forEach(tr => {
    tr.style.opacity = '1';
  });
}

function populateProductDropdown() {
  const select = document.getElementById('projectSpecifications');
  if (!select) return;

  const currentValue = select.value;
  select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
    products.map(p => `<option value="${escapeHtml(p.name)}">${escapeHtml(p.name)}</option>`).join('');

  if (currentValue) select.value = currentValue;
}

// ============================================
// ã‚¿ã‚¹ã‚¯ç®¡ç†ï¼ˆè¨­è¨ˆãƒ»ICåˆ†é›¢ï¼‰
// ============================================
function renderTasksManagement() {
  const container = document.getElementById('tasksGrid');
  if (!container) return;

  const sekkeiTasks = tasksV2.filter(t => t.category === 'è¨­è¨ˆ');

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>ã‚¿ã‚¹ã‚¯å</th>
            <th style="width: 100px;">çŠ¶æ…‹ç®¡ç†</th>
            <th style="width: 120px;">ğŸ“§ãƒœã‚¿ãƒ³</th>
            <th>ç´ã¥ã‘æ¥­è€…</th>
            <th style="width: 180px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="sekkeiTasksBody">
          ${sekkeiTasks.map(task => renderTaskRow(task)).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
        ğŸ“ è¨­è¨ˆã‚¿ã‚¹ã‚¯: ${sekkeiTasks.length}ä»¶ç™»éŒ²æ¸ˆã¿
      </p>
    </div>
  `;
}

function renderIcTasksManagement() {
  const container = document.getElementById('icTasksGrid');
  if (!container) return;

  const icTasks = tasksV2.filter(t => t.category === 'IC');

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>ã‚¿ã‚¹ã‚¯å</th>
            <th style="width: 100px;">çŠ¶æ…‹ç®¡ç†</th>
            <th style="width: 120px;">ğŸ“§ãƒœã‚¿ãƒ³</th>
            <th>ç´ã¥ã‘æ¥­è€…</th>
            <th style="width: 180px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="icTasksBody">
          ${icTasks.map(task => renderTaskRow(task)).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
        ğŸ¨ ICã‚¿ã‚¹ã‚¯: ${icTasks.length}ä»¶ç™»éŒ²æ¸ˆã¿
      </p>
    </div>
  `;
}

function renderTaskRow(task) {
  const mappings = taskVendorMappings.filter(m => m.task_id === task.id);
  const vendorNames = mappings.map(m => {
    const vendor = vendorsV2.find(v => v.id === m.vendor_id);
    return vendor ? vendor.company : 'ä¸æ˜';
  }).join(', ');

  const stateInfo = task.has_state ?
    `<span class="badge badge-success">ã‚ã‚Š</span>` :
    `<span class="badge badge-secondary">ãªã—</span>`;

  const emailButtonInfo = task.has_email_button ?
    `<span class="badge badge-success">è¡¨ç¤º</span>` :
    `<span class="badge badge-secondary">éè¡¨ç¤º</span>`;

  return `
    <tr draggable="true" ondragstart="handleTaskDragStart(event, '${task.id}')" ondragover="handleTaskDragOver(event)" ondrop="handleTaskDrop(event, '${task.id}')" style="cursor: move;">
      <td><span style="color: var(--text-muted);">â‹®â‹®</span></td>
      <td><strong>${escapeHtml(task.task_name)}</strong></td>
      <td>${stateInfo}</td>
      <td>${emailButtonInfo}</td>
      <td>${escapeHtml(vendorNames || '-')}</td>
      <td>
        <button class="btn btn-secondary btn-small" onclick="editTask('${task.id}')">ç·¨é›†</button>
        <button class="btn btn-danger btn-small" onclick="deleteTask('${task.id}')">å‰Šé™¤</button>
      </td>
    </tr>
  `;
}

// ============================================
// å¤–æ§‹æ¥­å‹™ç®¡ç†
// ============================================
// å¤–æ§‹ã‚¿ã‚¹ã‚¯ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®šç¾©
const defaultExteriorTasks = [
  { id: 'ext_hearing', name: 'ãƒ’ã‚¢ãƒªãƒ³ã‚°', order: 1, states: ['æœªç€æ‰‹', 'å®Œäº†'] },
  { id: 'ext_site_survey', name: 'ç¾åœ°èª¿æŸ»', order: 2, states: ['æœªç€æ‰‹', 'èª¿æŸ»æ¸ˆ', 'å ±å‘Šæ¸ˆ'] },
  { id: 'ext_first_proposal', name: 'åˆå›ææ¡ˆ', order: 3, states: ['æœªç€æ‰‹', 'ä½œæˆä¸­', 'æå‡ºæ¸ˆ', 'æ‰¿èª'] },
  { id: 'ext_estimate', name: 'è¦‹ç©ä½œæˆ', order: 4, states: ['æœªç€æ‰‹', 'ä½œæˆä¸­', 'æå‡ºæ¸ˆ', 'æ‰¿èª'] },
  { id: 'ext_final_design', name: 'æœ€çµ‚è¨­è¨ˆ', order: 5, states: ['æœªç€æ‰‹', 'ä½œæˆä¸­', 'ç¢ºå®š'] },
  { id: 'ext_material_order', name: 'è³‡æç™ºæ³¨', order: 6, states: ['æœªç€æ‰‹', 'ç™ºæ³¨æ¸ˆ', 'ç´å“æ¸ˆ'] },
  { id: 'ext_construction', name: 'æ–½å·¥', order: 7, states: ['æœªç€æ‰‹', 'ç€å·¥', 'é€²è¡Œä¸­', 'å®Œå·¥'] },
  { id: 'ext_inspection', name: 'å®Œäº†æ¤œæŸ»', order: 8, states: ['æœªç€æ‰‹', 'æ¤œæŸ»æ¸ˆ', 'å¼•æ¸¡å®Œäº†'] }
];

// å¤–æ§‹ã‚¿ã‚¹ã‚¯ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
let exteriorTasks = safeJsonParse(localStorage.getItem('exteriorTasks'), defaultExteriorTasks);

function renderExteriorTasksManagement() {
  const container = document.getElementById('exteriorTasksGrid');
  if (!container) return;

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>ã‚¿ã‚¹ã‚¯å</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³</th>
            <th style="width: 180px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          ${exteriorTasks.map(task => `
            <tr>
              <td><span style="color: var(--text-muted);">â‹®â‹®</span></td>
              <td><strong>${task.name}</strong></td>
              <td>
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                  ${task.states.map(s => `<span class="badge badge-secondary">${s}</span>`).join('')}
                </div>
              </td>
              <td>
                <button class="btn btn-secondary btn-small" onclick="editExteriorTask('${task.id}')">ç·¨é›†</button>
                <button class="btn btn-danger btn-small" onclick="deleteExteriorTask('${task.id}')">å‰Šé™¤</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
        ğŸ’¡ å¤–æ§‹æ¥­å‹™ã‚¿ã‚¹ã‚¯ã¯æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ã®ã€Œå¤–æ§‹ä¾é ¼ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
        å„ã‚¿ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®šã—ã¦ã€å¤–æ§‹è¨­è¨ˆã®é€²æ—ã‚’ç®¡ç†ã§ãã¾ã™ã€‚
      </p>
    </div>
  `;
}

function openExteriorTaskModal(taskId = null) {
  const name = taskId ? exteriorTasks.find(t => t.id === taskId)?.name : '';
  const states = taskId ? exteriorTasks.find(t => t.id === taskId)?.states.join(', ') : 'æœªç€æ‰‹, å®Œäº†';

  const newName = prompt('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›:', name);
  if (!newName) return;

  const newStates = prompt('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰:', states);
  if (!newStates) return;

  const statesArray = newStates.split(',').map(s => s.trim()).filter(s => s);

  if (taskId) {
    const task = exteriorTasks.find(t => t.id === taskId);
    if (task) {
      task.name = newName;
      task.states = statesArray;
    }
  } else {
    exteriorTasks.push({
      id: 'ext_' + Date.now(),
      name: newName,
      order: exteriorTasks.length + 1,
      states: statesArray
    });
  }

  localStorage.setItem('exteriorTasks', JSON.stringify(exteriorTasks));
  renderExteriorTasksManagement();
  showToast('å¤–æ§‹ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

function editExteriorTask(taskId) {
  openExteriorTaskModal(taskId);
}

function deleteExteriorTask(taskId) {
  if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  exteriorTasks = exteriorTasks.filter(t => t.id !== taskId);
  localStorage.setItem('exteriorTasks', JSON.stringify(exteriorTasks));
  renderExteriorTasksManagement();
  showToast('ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

function openTaskModal(taskIdOrCategory = null) {
  const modal = document.getElementById('taskModal');
  const title = document.getElementById('taskModalTitle');

  // ã‚«ãƒ†ã‚´ãƒªåãŒæ¸¡ã•ã‚ŒãŸå ´åˆï¼ˆæ–°è¦è¿½åŠ ï¼‰
  const isCategory = taskIdOrCategory === 'è¨­è¨ˆ' || taskIdOrCategory === 'IC';

  if (taskIdOrCategory && !isCategory) {
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆtaskIdãŒæ¸¡ã•ã‚ŒãŸï¼‰
    const task = tasksV2.find(t => t.id === taskIdOrCategory);
    if (!task) return;

    title.textContent = 'ã‚¿ã‚¹ã‚¯ç·¨é›†';
    document.getElementById('taskId').value = task.id;
    document.getElementById('taskKey').value = task.task_key;
    document.getElementById('taskName').value = task.task_name;
    document.getElementById('taskCategory').value = task.category;
    document.getElementById('taskOrder').value = task.display_order;
    document.getElementById('taskHasState').checked = task.has_state;
    document.getElementById('taskStateOptions').value = task.state_options ? JSON.stringify(task.state_options) : '';
    document.getElementById('taskHasEmailButton').checked = task.has_email_button !== false;
    toggleTaskState();
    populateTaskVendorSelection(taskIdOrCategory);
  } else {
    // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
    const category = isCategory ? taskIdOrCategory : 'è¨­è¨ˆ';
    title.textContent = `${category}ã‚¿ã‚¹ã‚¯è¿½åŠ `;
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
    document.getElementById('taskCategory').value = category;
    document.getElementById('taskOrder').value = tasksV2.filter(t => t.category === category).length + 1;
    document.getElementById('taskHasState').checked = false;
    document.getElementById('taskHasEmailButton').checked = true;
    toggleTaskState();
    populateTaskVendorSelection(null);
  }

  ModalManager.open(modal, '#taskKey');
}

function populateTaskVendorSelection(taskId) {
  const container = document.getElementById('taskVendorSelection');
  if (!container) return;

  // ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã«ç´ã¥ã„ã¦ã„ã‚‹æ¥­è€…IDãƒªã‚¹ãƒˆã‚’å–å¾—
  const currentMappings = taskId ? taskVendorMappings.filter(m => m.task_id === taskId).map(m => m.vendor_id) : [];

  // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦è¡¨ç¤º
  const categories = [...new Set(vendorsV2.map(v => v.vendor_categories?.name || 'æœªåˆ†é¡'))].sort();

  container.innerHTML = categories.map(category => {
    const categoryVendors = vendorsV2.filter(v => (v.vendor_categories?.name || 'æœªåˆ†é¡') === category);

    return `
      <div style="margin-bottom: 12px;">
        <div style="font-weight: 600; color: #4A90E2; margin-bottom: 4px; font-size: 12px;">${category}</div>
        ${categoryVendors.map(vendor => `
          <label style="display: block; padding: 4px 0; cursor: pointer;">
            <input type="checkbox"
                   value="${vendor.id}"
                   ${currentMappings.includes(vendor.id) ? 'checked' : ''}
                   style="margin-right: 8px;">
            ${escapeHtml(vendor.company)}
          </label>
        `).join('')}
      </div>
    `;
  }).join('');
}

function closeTaskModal() {
  ModalManager.close(document.getElementById('taskModal'));
}

function toggleTaskState() {
  const hasState = document.getElementById('taskHasState').checked;
  const stateGroup = document.getElementById('stateOptionsGroup');
  stateGroup.style.display = hasState ? 'block' : 'none';
}

async function saveTask() {
  if (SaveGuard.isLocked('saveTask')) return;

  const id = document.getElementById('taskId').value;
  const taskName = document.getElementById('taskName').value.trim();
  const category = document.getElementById('taskCategory').value;
  const order = parseInt(document.getElementById('taskOrder').value) || 0;
  const hasState = document.getElementById('taskHasState').checked;
  const stateOptionsStr = document.getElementById('taskStateOptions').value.trim();
  const hasEmailButton = document.getElementById('taskHasEmailButton').checked;

  if (!taskName) {
    showToast('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  // ã‚¿ã‚¹ã‚¯ã‚­ãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆï¼ˆç·¨é›†æ™‚ã¯æ—¢å­˜ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨ï¼‰
  let taskKey = document.getElementById('taskKey').value;
  if (!taskKey) {
    // æ–°è¦ä½œæˆæ™‚ï¼šã‚¿ã‚¹ã‚¯åã‹ã‚‰è‡ªå‹•ç”Ÿæˆï¼ˆæ—¥æœ¬èªã‚’å‰Šé™¤ã—ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã«å¤‰æ›ï¼‰
    taskKey = 'task_' + taskName.replace(/[\u3000-\u9FFF]/g, '').replace(/\s+/g, '_').toLowerCase() + '_' + Date.now();
    // å®‰å…¨ã®ãŸã‚ã€è‹±æ•°å­—ã¨ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ã«åˆ¶é™
    taskKey = taskKey.replace(/[^a-z0-9_]/g, '_');
  }

  let stateOptions = null;
  if (hasState && stateOptionsStr) {
    try {
      stateOptions = JSON.parse(stateOptionsStr);
    } catch (e) {
      showToast('çŠ¶æ…‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
      return;
    }
  }

  await SaveGuard.run('saveTask', async () => {
    showStatus('ä¿å­˜ä¸­...', 'saving');

    const taskData = {
      task_key: taskKey,
      task_name: taskName,
      category,
      display_order: order,
      has_state: hasState,
      state_options: stateOptions,
      has_email_button: hasEmailButton
    };

    let result;
    if (id) {
      result = await supabase
        .from('tasks')
        .update(taskData)
        .eq('id', id)
        .select();
    } else {
      result = await supabase
        .from('tasks')
        .insert([taskData])
        .select();
    }

    if (result.error) {
      showStatus('ä¿å­˜å¤±æ•—', 'error');
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error.message, 'error');
      return;
    }

    // æ¥­è€…ç´ã¥ã‘ã®ä¿å­˜
    const savedTaskId = id || result.data[0].id;
    await saveTaskVendorMappings(savedTaskId);

    showStatus('ä¿å­˜å®Œäº†', 'success');
    showToast(id ? 'ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    closeTaskModal();
    await loadTasksV2();
    await loadTaskVendorMappings();
    renderTasksManagement();
  });
}

async function saveTaskVendorMappings(taskId) {
  // é¸æŠã•ã‚ŒãŸæ¥­è€…IDã‚’å–å¾—
  const checkboxes = document.querySelectorAll('#taskVendorSelection input[type="checkbox"]:checked');
  const selectedVendorIds = Array.from(checkboxes).map(cb => cb.value);

  // æ—¢å­˜ã®ç´ã¥ã‘ã‚’å…¨å‰Šé™¤
  const { error: deleteError } = await supabase
    .from('task_vendor_mappings_v2')
    .delete()
    .eq('task_id', taskId);

  if (deleteError) {
    logError('æ¥­è€…ç´ã¥ã‘å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', deleteError);
    showToast('æ—¢å­˜ã®ç´ã¥ã‘å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    return;
  }

  // æ–°ã—ã„ç´ã¥ã‘ã‚’ä½œæˆ
  if (selectedVendorIds.length > 0) {
    const mappings = selectedVendorIds.map(vendorId => ({
      task_id: taskId,
      vendor_id: vendorId
    }));

    const { error } = await supabase
      .from('task_vendor_mappings_v2')
      .insert(mappings);

    if (error) {
      logError('æ¥­è€…ç´ã¥ã‘ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      showToast('æ¥­è€…ç´ã¥ã‘ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  }
}

function editTask(taskId) {
  openTaskModal(taskId);
}

async function deleteTask(taskId) {
  const task = tasksV2.find(t => t.id === taskId);
  if (!task) return;

  if (!confirm(`ã‚¿ã‚¹ã‚¯ã€Œ${task.task_name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  await SaveGuard.run(`deleteTask_${taskId}`, async () => {
    showStatus('å‰Šé™¤ä¸­...', 'saving');

    const { error } = await supabase
      .from('tasks')
      .delete()
      .eq('id', taskId);

    if (error) {
      showStatus('å‰Šé™¤å¤±æ•—', 'error');
      showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    showStatus('å‰Šé™¤å®Œäº†', 'success');
    showToast('ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    await loadTasksV2();
    renderTasksManagement();
  });
}

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤ºé †ã‚’å¤‰æ›´
let draggedTaskId = null;

function handleTaskDragStart(event, taskId) {
  draggedTaskId = taskId;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.5';
}

function handleTaskDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  return false;
}

async function handleTaskDrop(event, targetTaskId) {
  event.preventDefault();
  event.stopPropagation();

  if (!draggedTaskId || draggedTaskId === targetTaskId) {
    resetDragState();
    return;
  }

  const draggedTask = tasksV2.find(t => t.id === draggedTaskId);
  const targetTask = tasksV2.find(t => t.id === targetTaskId);

  if (!draggedTask || !targetTask) {
    resetDragState();
    return;
  }

  // åŒã˜ã‚«ãƒ†ã‚´ãƒªå†…ã§ã®ã¿ä¸¦ã³æ›¿ãˆå¯èƒ½
  if (draggedTask.category !== targetTask.category) {
    showToast('åŒã˜ã‚«ãƒ†ã‚´ãƒªå†…ã§ã®ã¿ä¸¦ã³æ›¿ãˆå¯èƒ½ã§ã™', 'error');
    resetDragState();
    return;
  }

  // è¡¨ç¤ºé †ã‚’å…¥ã‚Œæ›¿ãˆ
  const draggedOrder = draggedTask.display_order;
  const targetOrder = targetTask.display_order;

  showStatus('ä¸¦ã³æ›¿ãˆä¸­...', 'saving');

  // ä¸¡æ–¹ã®ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤ºé †ã‚’æ›´æ–°
  const updates = [
    supabase.from('tasks').update({ display_order: targetOrder }).eq('id', draggedTaskId),
    supabase.from('tasks').update({ display_order: draggedOrder }).eq('id', targetTaskId)
  ];

  const results = await Promise.all(updates);

  if (results.some(r => r.error)) {
    showStatus('ä¸¦ã³æ›¿ãˆå¤±æ•—', 'error');
    showToast('ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    resetDragState();
    return;
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
  draggedTask.display_order = targetOrder;
  targetTask.display_order = draggedOrder;

  // å†æç”»
  renderTasksManagement();
  showStatus('ä¸¦ã³æ›¿ãˆå®Œäº†', 'success');
  showToast('è¡¨ç¤ºé †ã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success');
  resetDragState();
}

function resetDragState() {
  draggedTaskId = null;
  // ã™ã¹ã¦ã®è¡Œã®é€æ˜åº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
  document.querySelectorAll('#tasksGrid tr[draggable]').forEach(tr => {
    tr.style.opacity = '1';
  });
}

// ============================================
// UIåˆ¶å¾¡
// ============================================
// ã‚µã‚¤ãƒ‰ãƒãƒ¼æç”»
function renderSidebar() {
  const container = document.getElementById('sidebarContent');
  if (!container) return;

  const sekkeiDesigners = getSekkeiDesigners();
  const icDesigners = getIcDesigners();
  const allCount = projects.filter(p => p.status !== 'completed').length;

  // å®Œäº†æ¸ˆã®ä»¶æ•°
  const archivedCount = projects.filter(p => p.is_archived).length;

  let html = `
    <div class="sidebar-section">
      <div class="sidebar-item ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="selectDesigner('ALL')">
        <span class="sidebar-item-label">å…¨æ¡ˆä»¶</span>
        <span class="sidebar-item-count">${allCount}</span>
      </div>
      <div class="sidebar-item ${currentDesignerTab === 'ARCHIVED' ? 'active' : ''}" onclick="selectDesigner('ARCHIVED')" style="background: ${currentDesignerTab === 'ARCHIVED' ? 'var(--success-bg)' : 'transparent'};">
        <span class="sidebar-item-label" style="color: var(--success-color);">âœ“ å®Œäº†æ¸ˆ</span>
        <span class="sidebar-item-count" style="background: var(--success-color); color: white;">${archivedCount}</span>
      </div>
    </div>
  `;

  // ä»¶æ•°ã«ã‚ˆã‚‹è‰²åˆ†ã‘ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  function getCountStyle(count) {
    if (count >= 7) {
      return 'color: #dc2626; font-weight: 700;'; // èµ¤è‰²ï¼ˆå±é™ºï¼‰
    } else if (count >= 5) {
      return 'color: #d97706; font-weight: 600;'; // é»„è‰²ï¼ˆæ³¨æ„ï¼‰
    }
    return ''; // é€šå¸¸ï¼ˆ4ä»¶ä»¥ä¸‹ï¼‰
  }

  function getCountBadgeClass(count) {
    if (count >= 7) return 'badge-danger';
    if (count >= 5) return 'badge-warning';
    return 'badge-primary';
  }

  if (sekkeiDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">ğŸ“ è¨­è¨ˆæ‹…å½“</div>';
    sekkeiDesigners.forEach(designer => {
      const count = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const designerName = designer.name.trim();
        return assigned === designerName && p.status !== 'completed' && !p.is_archived;
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-item-count ${badgeClass}">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  if (icDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">ğŸ¨ ICæ‹…å½“</div>';
    icDesigners.forEach(designer => {
      const count = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const icAssigned = (p.ic_assignee || '').trim();
        const designerName = designer.name.trim();
        return (assigned === designerName || icAssigned === designerName) && p.status !== 'completed' && !p.is_archived;
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-item-count ${badgeClass}">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  container.innerHTML = html;
}

function selectDesigner(name) {
  currentDesignerTab = name;

  // URLã‚’æ›´æ–°
  updateURLWithDesigner(name);

  renderSidebar();
  renderProjects();
}

// ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchMainTab(tabName, element) {
  log('ğŸ“‘ switchMainTab é–‹å§‹:', {
    tabName: tabName,
    isHandlingHashChange: isHandlingHashChange,
    currentHash: window.location.hash,
    timestamp: new Date().toISOString()
  });

  document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) element.classList.add('active');

  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');

  // URLã‚’æ›´æ–°ï¼ˆhandleHashChangeå‡¦ç†ä¸­ã§ãªã„å ´åˆã®ã¿ï¼‰
  if (!isHandlingHashChange && window.location.hash !== '#' + tabName) {
    log('ğŸ”— switchMainTab: URLã‚’æ›´æ–°:', tabName);
    window.location.hash = tabName;
  } else {
    log('â¸ï¸ switchMainTab: URLæ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ— (isHandlingHashChange=' + isHandlingHashChange + ')');
  }
}

// ã‚µãƒ–ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchSubTab(panelName, element) {
  log('ğŸ“‘ switchSubTab é–‹å§‹:', {
    panelName: panelName,
    isHandlingHashChange: isHandlingHashChange,
    currentHash: window.location.hash,
    timestamp: new Date().toISOString()
  });

  document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
  if (element) element.classList.add('active');

  document.querySelectorAll('.sub-tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(panelName + 'Panel').classList.add('active');

  // URLã‚’æ›´æ–°ï¼ˆhandleHashChangeå‡¦ç†ä¸­ã§ãªã„å ´åˆã®ã¿ï¼‰
  if (!isHandlingHashChange && window.location.hash !== `#settings/${panelName}`) {
    log('ğŸ”— switchSubTab: URLã‚’æ›´æ–°:', panelName);
    window.location.hash = `settings/${panelName}`;
  } else {
    log('â¸ï¸ switchSubTab: URLæ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ— (isHandlingHashChange=' + isHandlingHashChange + ')');
  }

  // ã‚µãƒ–ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å¯¾å¿œã™ã‚‹æç”»é–¢æ•°ã‚’å®Ÿè¡Œ
  switch(panelName) {
    case 'staff':
      renderDesignerListInline();
      break;
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
    case 'icTasks':
      renderIcTasksManagement();
      break;
    case 'exteriorTasks':
      renderExteriorTasksManagement();
      break;
    case 'products':
      renderProductsList();
      break;
    case 'kintone':
      loadKintoneSettings();
      break;
  }
}

// æ—§switchTabé–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
function switchTab(tabName, element) {
  document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) {
    element.classList.add('active');
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼štabNameã«åŸºã¥ã„ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒœã‚¿ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
    const buttons = document.querySelectorAll('.tab-nav-btn');
    buttons.forEach((btn, index) => {
      const tabs = ['projects', 'vendors', 'categories', 'tasks', 'settings'];
      if (tabs[index] === tabName) {
        btn.classList.add('active');
      }
    });
  }
  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å¯¾å¿œã™ã‚‹æç”»é–¢æ•°ã‚’å®Ÿè¡Œ
  switch(tabName) {
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
  }
}

// ã‚«ãƒ†ã‚´ãƒªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ
function populateVendorCategoryDropdown() {
  const dropdown = document.getElementById('vendorCategory');
  if (!dropdown) return;

  dropdown.innerHTML = '<option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ...</option>' +
    vendorCategories.map(cat => `<option value="${escapeHtml(cat.id)}">${escapeHtml(cat.name)}</option>`).join('');
}

let statusClearTimeout = null;
function showStatus(message, type) {
  const indicator = document.getElementById('statusIndicator');
  const text = document.getElementById('statusText');
  indicator.className = 'status-indicator status-' + type;
  text.textContent = message;

  // ä¿å­˜å®Œäº†å¾Œã¯3ç§’ã§é€šå¸¸çŠ¶æ…‹ã«æˆ»ã™
  if (statusClearTimeout) clearTimeout(statusClearTimeout);
  if (type === 'saved' || type === 'success') {
    statusClearTimeout = setTimeout(() => {
      indicator.className = 'status-indicator';
      text.textContent = '';
    }, 3000);
  }
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.className = 'toast toast-' + type + ' show';
  toast.textContent = message;

  // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ã«ã‚‚é€šçŸ¥
  announceToScreenReader(message);

  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ã‚¢ãƒŠã‚¦ãƒ³ã‚¹
function announceToScreenReader(message, priority = 'polite') {
  const liveRegion = document.getElementById('liveRegion');
  if (liveRegion) {
    liveRegion.setAttribute('aria-live', priority);
    liveRegion.textContent = message;
    // åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚‚å†é€šçŸ¥ã™ã‚‹ãŸã‚ã«ä¸€åº¦ã‚¯ãƒªã‚¢
    setTimeout(() => {
      liveRegion.textContent = '';
    }, 1000);
  }
}

// ============================================
// ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
// ============================================
const NotificationSystem = {
  permission: 'default',
  soundEnabled: localStorage.getItem('notificationSound') !== 'false',

  async init() {
    if ('Notification' in window) {
      this.permission = Notification.permission;
      log('ğŸ”” é€šçŸ¥æ¨©é™:', this.permission);
    }
  },

  async requestPermission() {
    if (!('Notification' in window)) {
      showToast('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“', 'warning');
      return false;
    }

    try {
      const permission = await Notification.requestPermission();
      this.permission = permission;

      if (permission === 'granted') {
        showToast('é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ', 'success');
        return true;
      } else {
        showToast('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'warning');
        return false;
      }
    } catch (error) {
      logError('é€šçŸ¥æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
      return false;
    }
  },

  async send(title, options = {}) {
    if (this.permission !== 'granted') {
      log('é€šçŸ¥æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
      return null;
    }

    const defaultOptions = {
      icon: '/archideck/icon-192.png',
      badge: '/archideck/badge.png',
      tag: 'archideck-notification',
      requireInteraction: false,
      ...options
    };

    try {
      // ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿ
      if (this.soundEnabled && options.sound !== false) {
        this.playSound();
      }

      const notification = new Notification(title, defaultOptions);

      notification.onclick = () => {
        window.focus();
        notification.close();
        if (options.onClick) options.onClick();
      };

      return notification;
    } catch (error) {
      logError('é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
      return null;
    }
  },

  playSound() {
    try {
      // ã‚·ãƒ³ãƒ—ãƒ«ãªé€šçŸ¥éŸ³ã‚’ç”Ÿæˆ
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = 800;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    } catch (e) {
      log('é€šçŸ¥éŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–å¯ï¼‰:', e);
    }
  },

  toggleSound() {
    this.soundEnabled = !this.soundEnabled;
    localStorage.setItem('notificationSound', this.soundEnabled);
    showToast(this.soundEnabled ? 'é€šçŸ¥éŸ³ã‚’ã‚ªãƒ³ã«ã—ã¾ã—ãŸ' : 'é€šçŸ¥éŸ³ã‚’ã‚ªãƒ•ã«ã—ã¾ã—ãŸ', 'info');
    return this.soundEnabled;
  },

  // æœŸé™é–“è¿‘ã®æ¡ˆä»¶ã‚’é€šçŸ¥
  async checkDeadlines() {
    const today = new Date();
    const threeDaysLater = new Date(today);
    threeDaysLater.setDate(today.getDate() + 3);

    const upcomingDeadlines = projects.filter(p => {
      if (!p.tasks || p.status === 'completed' || p.is_archived) return false;

      return Object.entries(p.tasks).some(([key, task]) => {
        if (!task.due_date || task.status === 'completed') return false;
        const dueDate = new Date(task.due_date);
        return dueDate >= today && dueDate <= threeDaysLater;
      });
    });

    if (upcomingDeadlines.length > 0) {
      await this.send('æœŸé™é–“è¿‘ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™', {
        body: `${upcomingDeadlines.length}ä»¶ã®æ¡ˆä»¶ã«æœŸé™ãŒè¿‘ã„ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™`,
        tag: 'deadline-warning'
      });
    }
  }
};

// é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
  NotificationSystem.init();
});

// ============================================
// æ¡ˆä»¶ç®¡ç†
// ============================================
function renderDesignerTabs() {
  const container = document.getElementById('designerTabs');
  if (!container) {
    warn('âš ï¸ designerTabsè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }

  log('ğŸ¨ æ‹…å½“è€…ã‚¿ãƒ–æç”»:', {
    'ç·ã‚¹ã‚¿ãƒƒãƒ•æ•°': designers.length,
    'è¨­è¨ˆæ‹…å½“': designers.filter(d => d.category === 'è¨­è¨ˆ').length,
    'ICæ‹…å½“': designers.filter(d => d.category === 'IC').length,
    'æ¡ˆä»¶æ•°': projects.length
  });

  const activeCount = projects.filter(p => p.status !== 'completed').length;

  let html = `<button class="designer-tab ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="setDesignerTab('ALL')">å…¨æ¡ˆä»¶ (${activeCount})</button>`;

  // è¨­è¨ˆæ‹…å½“
  const sekkeiDesigners = designers.filter(d => d.category === 'è¨­è¨ˆ');
  log('ğŸ“ è¨­è¨ˆæ‹…å½“:', sekkeiDesigners.map(d => d.name));
  if (sekkeiDesigners.length > 0) {
    html += '<div class="designer-group-label">è¨­è¨ˆæ‹…å½“</div>';
    sekkeiDesigners.forEach(designer => {
      const designerProjects = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const designerName = designer.name.trim();
        return assigned === designerName && p.status !== 'completed' && !p.is_archived;
      });
      const count = designerProjects.length;

      html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
    });
  } else {
    warn('âš ï¸ è¨­è¨ˆæ‹…å½“ãŒ0åã§ã™');
  }

  // ICæ‹…å½“
  const icDesigners = designers.filter(d => d.category === 'IC');
  log('ğŸ¨ ICæ‹…å½“:', icDesigners.map(d => d.name));
  if (icDesigners.length > 0) {
    html += '<div class="designer-group-label">ICæ‹…å½“</div>';
    icDesigners.forEach(designer => {
      const designerProjects = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const icAssigned = (p.ic_assignee || '').trim();
        const designerName = designer.name.trim();
        return (assigned === designerName || icAssigned === designerName) && p.status !== 'completed' && !p.is_archived;
      });
      const count = designerProjects.length;

      html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
    });
  }

  container.innerHTML = html;
}

function setDesignerTab(name) {
  currentDesignerTab = name;

  // URLã‚’æ›´æ–°
  updateURLWithDesigner(name);

  renderDesignerTabs();
  renderProjects();
}

function renderProjects() {
  const container = document.getElementById('projectsGrid');
  const emptyState = document.getElementById('emptyProjects');

  log('ğŸ¨ renderProjects() é–‹å§‹');
  log('ğŸ“Š ç¾åœ¨ã®ã‚¿ãƒ–:', currentDesignerTab);
  log('ğŸ“Š å…¨æ¡ˆä»¶æ•°:', projects.length);
  log('ğŸ“Š å…¨æ¡ˆä»¶:', projects.map(p => ({ customer: p.customer, assigned_to: p.assigned_to, ic_assignee: p.ic_assignee })));

  let filtered = projects.filter(p => {
    // å®Œäº†æ¸ˆã‚¿ãƒ–ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
    if (currentDesignerTab === 'ARCHIVED') {
      // å®Œäº†æ¸ˆæ¡ˆä»¶ã®ã¿è¡¨ç¤º
      if (!p.is_archived) return false;

      // æ¤œç´¢ã‚¯ã‚¨ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const query = document.getElementById('searchQuery').value.toLowerCase();
      if (query && !p.customer.toLowerCase().includes(query) && !(p.memo || '').toLowerCase().includes(query)) return false;

      return true;
    }

    // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¨­è¨ˆã¾ãŸã¯ICæ‹…å½“è€…ï¼‰
    if (currentDesignerTab !== 'ALL') {
      const assigned = (p.assigned_to || '').trim();
      const icAssigned = (p.ic_assignee || '').trim();
      const currentTab = currentDesignerTab.trim();

      if (assigned !== currentTab && icAssigned !== currentTab) {
        log(`âŒ ãƒ•ã‚£ãƒ«ã‚¿ã§é™¤å¤–: ${p.customer} (assigned_to: "${p.assigned_to}" (trim: "${assigned}"), ic_assignee: "${p.ic_assignee}" (trim: "${icAssigned}"), currentTab: "${currentTab}")`);
        return false;
      }
    }

    // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆé€šå¸¸æ™‚ã¯å®Œäº†æ¸ˆã‚’é™¤å¤–ï¼‰
    const archiveFilter = document.getElementById('archiveFilter').value;
    const isArchived = p.is_archived || false;
    if (archiveFilter === 'active' && isArchived) return false;
    if (archiveFilter === 'archived' && !isArchived) return false;
    if (archiveFilter === 'favorites' && !FavoritesManager.isFavorite(p.id)) return false;

    const query = document.getElementById('searchQuery').value.toLowerCase();
    if (query && !p.customer.toLowerCase().includes(query) && !(p.memo || '').toLowerCase().includes(query)) return false;

    const specFilter = document.getElementById('specFilter').value;
    if (specFilter && p.specifications !== specFilter) return false;

    return true;
  });

  log('âœ… ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®æ¡ˆä»¶æ•°:', filtered.length);
  log('âœ… ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®æ¡ˆä»¶:', filtered.map(p => ({ customer: p.customer, assigned_to: p.assigned_to })));

  // ãŠæ°—ã«å…¥ã‚Šã‚’å…ˆé ­ã«ã‚½ãƒ¼ãƒˆ
  filtered.sort((a, b) => {
    const aFav = FavoritesManager.isFavorite(a.id) ? 1 : 0;
    const bFav = FavoritesManager.isFavorite(b.id) ? 1 : 0;
    return bFav - aFav;
  });

  if (filtered.length === 0) {
    container.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  container.style.display = 'grid';
  emptyState.style.display = 'none';
  container.innerHTML = filtered.map(project => renderProjectCard(project)).join('');

  // ã‚«ãƒ¼ãƒ‰æç”»å¾Œã«ã‚¿ã‚¹ã‚¯ã¨è­°äº‹éŒ²ã‚’èª­ã¿è¾¼ã‚€ï¼ˆãƒãƒƒãƒå‡¦ç†ã§N+1å•é¡Œã‚’å›é¿ï¼‰
  setTimeout(async () => {
    const BATCH_SIZE = 5; // åŒæ™‚ã«5ä»¶ã¾ã§
    for (let i = 0; i < filtered.length; i += BATCH_SIZE) {
      const batch = filtered.slice(i, i + BATCH_SIZE);
      await Promise.all(
        batch.flatMap(project => [
          loadProjectTasksList(project.id),
          loadMinutesList(project.id)
        ])
      );
    }
  }, 100);
}

// æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
function scrollToProject(projectId) {
  const card = document.querySelector(`[data-project-id="${projectId}"]`);
  if (card) {
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    card.classList.add('highlight-card');
    setTimeout(() => card.classList.remove('highlight-card'), 2000);
  }
}

// ã‚«ãƒ¼ãƒ‰å˜ä½ã§å†æç”»ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹é–‰çŠ¶æ…‹ã‚’ä¿æŒï¼‰
function updateSingleProjectCard(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const cardElement = document.querySelector(`[data-project-id="${projectId}"]`);
  if (!cardElement) return;

  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹é–‰çŠ¶æ…‹ã‚’ä¿æŒ
  const sectionStates = [];
  cardElement.querySelectorAll('.card-section').forEach((section, idx) => {
    sectionStates[idx] = !section.classList.contains('collapsed');
  });

  // ã‚«ãƒ¼ãƒ‰ã‚’å†æç”»
  const newCard = document.createElement('div');
  newCard.innerHTML = renderProjectCard(project);
  const newCardElement = newCard.firstElementChild;

  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹é–‰çŠ¶æ…‹ã‚’å¾©å…ƒ
  newCardElement.querySelectorAll('.card-section').forEach((section, idx) => {
    if (sectionStates[idx]) {
      section.classList.remove('collapsed');
    }
  });

  cardElement.replaceWith(newCardElement);

  // è­°äº‹éŒ²ãƒ»ã‚¿ã‚¹ã‚¯ã®å†ãƒ­ãƒ¼ãƒ‰
  loadMinutesList(projectId);
  loadProjectTasksList(projectId);
  loadHandover(projectId);
}

function renderProjectCard(project) {
  const progress = calculateProgress(project);
  const progressData = project.progress || {};
  const tasks = getTasksForAssignee(project.assigned_to);

  // å…¨ã‚¿ã‚¹ã‚¯å®Œäº†ãƒã‚§ãƒƒã‚¯
  const canArchive = tasks.every(taskDef => {
    const task = progressData[taskDef.task_key] || { completed: false, state: '' };
    if (!task.completed) return false;
    if (taskDef.has_state && task.state !== 'ä¿å­˜æ¸ˆ') return false;
    return true;
  });

  // ç”³è«‹GOæ¡ä»¶ãƒã‚§ãƒƒã‚¯
  const applicationGoEnabled = canPressApplicationGo(project);


  const tasksHtml = tasks.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '', due_date: '' };
    const isApplicationGo = key === 'application';

    // ç”³è«‹Goã®å ´åˆã¯ç‰¹åˆ¥ãªãƒ•ãƒ«ãƒ¯ã‚¤ãƒ‰è¡¨ç¤º
    if (isApplicationGo) {
      if (task.completed) {
        // æ—¢ã«å®Œäº†æ¸ˆã¿ã®å ´åˆ
        return `<div class="application-go-container application-go-completed">
          <div class="application-go-icon">âœ“</div>
          <div class="application-go-text">${taskDef.task_name} å®Œäº†</div>
        </div>`;
      } else if (applicationGoEnabled) {
        // æ¡ä»¶ãŒæƒã£ã¦ã„ã‚‹å ´åˆï¼šã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªãƒœã‚¿ãƒ³
        return `<div class="application-go-container application-go-ready" onclick="confirmApplicationGo('${project.id}')">
          <div class="application-go-icon">ğŸš€</div>
          <div class="application-go-text">${taskDef.task_name}</div>
          <div class="application-go-arrow">â†’</div>
        </div>`;
      } else {
        // æ¡ä»¶ãŒæƒã£ã¦ã„ãªã„å ´åˆï¼šç„¡åŠ¹è¡¨ç¤ºï¼ˆå‹•çš„ã«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç”Ÿæˆï¼‰
        const requiredTasks = getApplicationGoRequiredTasks();
        const tooltip = requiredTasks.length > 0
          ? requiredTasks.map(r => `${r.task_name}:${r.finalState}`).join('ã€') + ' ãŒå¿…è¦'
          : 'å¤ªé™½å…‰:ä¿å­˜æ¸ˆã€çµ¦æ’æ°´:ä¿å­˜æ¸ˆã€æ›æ°—:ä¿å­˜æ¸ˆã€ã‚µãƒƒã‚·:ä¿å­˜æ¸ˆ ãŒå¿…è¦';
        return `<div class="application-go-container application-go-disabled" title="${tooltip}">
          <div class="application-go-icon">ğŸ”’</div>
          <div class="application-go-text">${taskDef.task_name}</div>
          <div class="application-go-status">æ¡ä»¶æœªé”</div>
        </div>`;
      }
    }

    const hasVendor = taskVendorMappings.some(m => m.task_id === taskDef.id);
    const showEmailButton = taskDef.has_email_button !== false && hasVendor;
    const emailBtn = showEmailButton ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="ãƒ¡ãƒ¼ãƒ«ä½œæˆ">ğŸ“§</button>` : '';

    let stateSelect = '';
    const stateOptions = getTaskStateOptions(key);
    if (stateOptions && Array.isArray(stateOptions)) {
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰²åˆ†ã‘: æœ€å¾Œã®é¸æŠè‚¢=é’ã€ç©º/-=ç™½ã€ãã®ä»–=é»„
      const lastOption = stateOptions[stateOptions.length - 1];
      let stateClass = getStateColorClass(task.state, lastOption);
      stateSelect = `<select class="task-state-select ${stateClass}" data-last-option="${lastOption}" onchange="updateTaskStateWithColor(this, '${project.id}', '${key}')">${stateOptions.map(state => `<option value="${state}" ${task.state === state ? 'selected' : ''}>${state || '-'}</option>`).join('')}</select>`;
    }

    return `<div class="task-item">
      <span class="task-label">${taskDef.task_name}</span>${stateSelect}${emailBtn}</div>`;
  }).join('');

  const isFavorite = FavoritesManager.isFavorite(project.id);
  const isSelected = BatchOperations.isSelected(project.id);

  return `<div class="project-card ${isFavorite ? 'favorite' : ''} ${isSelected ? 'selected' : ''}" data-project-id="${project.id}">
    <div class="card-header">
      <div style="display: flex; align-items: flex-start; gap: 8px;">
        <input type="checkbox" class="batch-checkbox" data-project-id="${project.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); BatchOperations.toggle('${project.id}')" title="é¸æŠ">
        <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="event.stopPropagation(); FavoritesManager.toggle('${project.id}')" title="${isFavorite ? 'ãŠæ°—ã«å…¥ã‚Šè§£é™¤' : 'ãŠæ°—ã«å…¥ã‚Šç™»éŒ²'}">${isFavorite ? 'â˜…' : 'â˜†'}</button>
        <div>
          <div class="card-title"><span class="customer-name">${escapeHtml(project.customer)}</span><span class="badge badge-primary">${escapeHtml(project.specifications || 'LIFE')}</span>${project.is_archived ? '<span class="badge badge-success">å®Œäº†æ¸ˆã¿</span>' : ''}</div>
          <div class="card-subtitle"><span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this)" style="cursor: pointer; text-decoration: underline dotted;" title="ã‚¯ãƒªãƒƒã‚¯ã§æ‹…å½“è€…å¤‰æ›´">è¨­è¨ˆï¼š${escapeHtml(project.assigned_to || 'æœªå‰²å½“')}</span>${project.ic_assignee ? ` | ICï¼š${escapeHtml(project.ic_assignee)}` : ''}${project.exterior_assignee ? ` | å¤–æ§‹ï¼š${escapeHtml(project.exterior_assignee)}` : ''}${(() => { const ds = DeadlineManager.getStatus(project.id); return ds ? ` <span style="background: ${ds.color}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 8px;" onclick="event.stopPropagation(); DeadlineManager.showModal('${project.id}')" title="æœŸé™ã‚’å¤‰æ›´">ğŸ“… ${ds.label}</span>` : ` <span style="color: var(--text-muted); font-size: 11px; cursor: pointer;" onclick="event.stopPropagation(); DeadlineManager.showModal('${project.id}')" title="æœŸé™ã‚’è¨­å®š">ğŸ“… æœŸé™è¨­å®š</span>`; })()}</div>
        </div>
      </div>
      <div style="display: flex; gap: 8px; align-items: center;">
        ${project.is_archived ? `
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; background: var(--success-color); color: white; padding: 4px 12px; border-radius: 6px; font-size: 13px;">
            <input type="checkbox" checked onchange="restoreFromArchive('${project.id}')" style="width: 16px; height: 16px; cursor: pointer;">
            å®Œäº†æ¸ˆ
          </label>
        ` : ''}
        <button class="btn btn-ghost btn-small" onclick="editProject('${project.id}')">ç·¨é›†</button>
      </div>
    </div>
    <div class="progress-section"><div class="progress-header"><span class="progress-label">é€²æ—çŠ¶æ³</span><span class="progress-value">${progress}%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div></div>

    <div class="card-section collapsed"><div class="card-section-header" onclick="toggleCardSection(this)"><span class="card-section-title">âœ… ã‚¿ã‚¹ã‚¯</span><span class="card-section-toggle">â–¼</span></div><div class="card-section-content"><div id="projectTasksList_${project.id}" class="project-task-list"></div><div class="add-task-form"><input type="text" id="newTaskName_${project.id}" placeholder="ã‚¿ã‚¹ã‚¯å" inputmode="text"><input type="date" id="newTaskDue_${project.id}"><button class="btn btn-small btn-primary" onclick="addProjectTask('${project.id}', document.getElementById('newTaskName_${project.id}').value, document.getElementById('newTaskDue_${project.id}').value)">è¿½åŠ </button></div></div></div>

    <div class="card-section collapsed"><div class="card-section-header" onclick="toggleCardSection(this)"><span class="card-section-title">ğŸ“ ãƒ¡ãƒ¢æ¬„</span><span class="card-section-toggle">â–¼</span></div><div class="card-section-content"><textarea class="shared-memo-area" id="sharedMemo_${project.id}" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›...">${escapeHtml(project.shared_memo || '')}</textarea><button class="btn btn-small btn-ghost" style="margin-top:8px" onclick="saveSharedMemo('${project.id}')">ãƒ¡ãƒ¢ã‚’ä¿å­˜</button></div></div>

    <div class="card-section collapsed"><div class="card-section-header" onclick="toggleCardSection(this)"><span class="card-section-title">ğŸ“„ è­°äº‹éŒ²</span><span class="card-section-toggle">â–¼</span></div><div class="card-section-content"><div id="minutesList_${project.id}" class="minutes-list"></div><div style="margin-bottom:12px;padding:12px;background:var(--bg-tertiary);border-radius:8px;"><label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:6px;">æ‰“åˆã›æ—¥</label><input type="date" id="meetingDate_${project.id}" style="width:100%;padding:8px 12px;border:1px solid var(--border-color);border-radius:6px;font-size:14px;"></div><div class="minutes-upload-area" id="minutesDropArea_${project.id}" ondragover="handleMinutesDragOver(event)" ondragleave="handleMinutesDragLeave(event)" ondrop="handleDropWithDate(event, '${project.id}')" onclick="triggerMinutesUpload('${project.id}')"><input type="file" id="minutesUpload_${project.id}" style="display:none" accept=".pdf,.doc,.docx,.xls,.xlsx" onchange="uploadMinutesWithDate('${project.id}', this.files[0])"><span>ğŸ“ ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</span><div style="font-size:12px;color:var(--text-muted);margin-top:4px">PDF, Word, Excelå¯¾å¿œ</div></div></div></div>

    <div class="card-section collapsed"><div class="card-section-header" onclick="toggleCardSection(this)"><span class="card-section-title">ğŸ“‹ å¼•ç¶™æ›¸</span><span class="card-section-toggle">â–¼</span></div><div class="card-section-content"><textarea class="handover-content" id="handover_${project.id}" placeholder="å¼•ç¶™æ›¸ã®å†…å®¹ã‚’å…¥åŠ›..."></textarea><button class="btn btn-small btn-ghost" style="margin-top:8px" onclick="saveHandover('${project.id}')">å¼•ç¶™æ›¸ã‚’ä¿å­˜</button></div></div>

    <div class="card-section collapsed"><div class="card-section-header" onclick="toggleCardSection(this)"><span class="card-section-title">ğŸ“‹ æ¥­å‹™å†…å®¹</span><span class="card-section-toggle">â–¼</span></div><div class="card-section-content"><div class="tasks-grid">${tasksHtml}</div></div></div>

    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--bg-secondary);display:flex;justify-content:space-between;align-items:center"><span style="font-size:13px;color:var(--text-muted)">æ›´æ–°: ${formatDateTime(project.updated_at)}</span><button class="btn btn-danger btn-small" onclick="deleteProject('${project.id}')">å‰Šé™¤</button></div>
  </div>`;
}

function calculateProgress(project) {
  const progressData = project.progress || {};
  const tasks = getTasksForAssignee(project.assigned_to);
  if (tasks.length === 0) return 0;
  const completed = tasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / tasks.length) * 100);
}

function formatDateTime(dateStr) {
  if (!dateStr) return 'â€”';
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return 'â€”';
  return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
}

async function updateTaskStatus(projectId, taskKey, completed) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // Undoç”¨ã«å¤‰æ›´å‰ã®çŠ¶æ…‹ã‚’ä¿å­˜
  const oldProgress = JSON.parse(JSON.stringify(project.progress || {}));

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].completed = completed;
  if (completed && !progressData[taskKey].date) {
    progressData[taskKey].date = new Date().toISOString().split('T')[0];
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  // Undoè¨˜éŒ²
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  UndoManager.record({
    type: 'UPDATE_PROJECT',
    projectId: projectId,
    description: `${project.customer} - ${taskDef?.task_name || taskKey}ã‚’${completed ? 'å®Œäº†' : 'æœªå®Œäº†'}ã«å¤‰æ›´`,
    oldValue: { progress: oldProgress },
    newValue: { progress: progressData }
  });

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
}

// ã‚¿ã‚¹ã‚¯æœŸé™ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
function getTaskDueStatus(dueDate, completed) {
  if (!dueDate || completed) {
    return { class: '', badgeClass: 'normal', label: '' };
  }

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const due = new Date(dueDate);
  due.setHours(0, 0, 0, 0);
  const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

  if (diffDays < 0) {
    return { class: 'overdue', badgeClass: 'overdue', label: `${Math.abs(diffDays)}æ—¥é…å»¶` };
  } else if (diffDays === 0) {
    return { class: 'due-soon', badgeClass: 'overdue', label: 'æœ¬æ—¥æœŸé™' };
  } else if (diffDays <= 3) {
    return { class: 'due-soon', badgeClass: 'due-soon', label: `ã‚ã¨${diffDays}æ—¥` };
  } else {
    const m = due.getMonth() + 1;
    const d = due.getDate();
    return { class: '', badgeClass: 'normal', label: `${m}/${d}` };
  }
}

// ã‚¿ã‚¹ã‚¯æœŸé™ã®æ›´æ–°
async function updateTaskDueDate(projectId, taskKey, dueDate) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // éå»æ—¥ä»˜ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã®ã¿ã€ä¿å­˜ã¯è¨±å¯ï¼‰
  if (dueDate && !Validators.isNotPastDate(dueDate)) {
    const confirmPast = confirm('éå»ã®æ—¥ä»˜ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®æ—¥ä»˜ã§ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ');
    if (!confirmPast) {
      renderProjects();
      return;
    }
  }

  // Undoç”¨ã«å¤‰æ›´å‰ã®çŠ¶æ…‹ã‚’ä¿å­˜
  const oldProgress = JSON.parse(JSON.stringify(project.progress || {}));
  const oldDueDate = oldProgress[taskKey]?.due_date || '';

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = { completed: false, date: '', state: '' };
  progressData[taskKey].due_date = dueDate;

  showStatus('ä¿å­˜ä¸­...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    ErrorHandler.handle(error, 'æœŸé™ä¿å­˜');
    return;
  }

  // Undoè¨˜éŒ²
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  UndoManager.record({
    type: 'UPDATE_PROJECT',
    projectId: projectId,
    description: `${project.customer} - ${taskDef?.task_name || taskKey}ã®æœŸé™ã‚’${dueDate || 'è§£é™¤'}ã«å¤‰æ›´`,
    oldValue: { progress: oldProgress },
    newValue: { progress: progressData }
  });

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  if (dueDate) {
    showToast('æœŸé™ã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
  }
}

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰²åˆ†ã‘ã®ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
function getStateColorClass(state, lastOption) {
  // ç©ºã€-ã€null â†’ è‰²ãªã—ï¼ˆç™½ï¼‰
  if (!state || state === '-' || state === '') {
    return '';
  }
  // æœ€å¾Œã®é¸æŠè‚¢ï¼ˆå®Œäº†çŠ¶æ…‹ï¼‰â†’ é’
  if (state === lastOption) {
    return 'state-blue';
  }
  // ãã®ä»–ï¼ˆé€²è¡Œä¸­ï¼‰â†’ é»„
  return 'state-yellow';
}

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ã«è‰²ã‚‚æ›´æ–°
function updateTaskStateWithColor(selectEl, projectId, taskKey) {
  const state = selectEl.value;
  const lastOption = selectEl.dataset.lastOption || '';

  // CSSã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°
  selectEl.classList.remove('state-blue', 'state-yellow');
  const newClass = getStateColorClass(state, lastOption);
  if (newClass) {
    selectEl.classList.add(newClass);
  }

  // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
  updateTaskState(projectId, taskKey, state);
}

async function updateTaskState(projectId, taskKey, state) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // Undoç”¨ã«å¤‰æ›´å‰ã®çŠ¶æ…‹ã‚’ä¿å­˜
  const oldProgress = JSON.parse(JSON.stringify(project.progress || {}));
  const oldState = oldProgress[taskKey]?.state || '';

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].state = state;

  // ç”³è«‹GoãŒå®Œäº†æ¸ˆã¿ã®å ´åˆã€æ¡ä»¶ã‚’å†ãƒã‚§ãƒƒã‚¯
  let applicationGoCleared = false;
  if (progressData['application']?.completed) {
    // ä¸€æ™‚çš„ã«progressã‚’æ›´æ–°ã—ã¦æ¡ä»¶ãƒã‚§ãƒƒã‚¯
    const tempProject = { ...project, progress: progressData };
    if (!canPressApplicationGo(tempProject)) {
      // æ¡ä»¶ã‹ã‚‰å¤–ã‚ŒãŸã®ã§ç”³è«‹Goã‚’ã‚¯ãƒªã‚¢
      progressData['application'].completed = false;
      progressData['application'].date = null;
      applicationGoCleared = true;
    }
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  // ç”³è«‹GoãŒã‚¯ãƒªã‚¢ã•ã‚ŒãŸå ´åˆã€is_archivedã‚‚falseã«æˆ»ã™
  const updateData = {
    progress: progressData,
    updated_at: new Date().toISOString()
  };
  if (applicationGoCleared) {
    updateData.is_archived = false;
  }

  const { error } = await supabase
    .from('projects')
    .update(updateData)
    .eq('id', projectId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  // Undoè¨˜éŒ²
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  UndoManager.record({
    type: 'UPDATE_PROJECT',
    projectId: projectId,
    description: `${project.customer} - ${taskDef?.task_name || taskKey}ã‚’ã€Œ${state || 'æœªè¨­å®š'}ã€ã«å¤‰æ›´`,
    oldValue: { progress: oldProgress },
    newValue: { progress: progressData }
  });

  project.progress = progressData;
  project.updated_at = new Date().toISOString();

  // ç”³è«‹GOã®çŠ¶æ…‹ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å¸¸ã«UIã‚’æ›´æ–°
  // è©²å½“ã®æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ã®ã¿ã‚’æ›´æ–°ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
  const projectCard = document.querySelector(`.project-card[data-project-id="${projectId}"]`);
  if (projectCard) {
    const applicationGoEnabled = canPressApplicationGo(project);
    const applicationGoContainer = projectCard.querySelector('.application-go-container');
    if (applicationGoContainer) {
      const taskDef = tasksV2.find(t => t.task_key === 'application');
      const applicationGoData = progressData['application'] || {};

      if (applicationGoData.completed) {
        // å®Œäº†æ¸ˆã¿
        applicationGoContainer.outerHTML = `<div class="application-go-container application-go-completed">
          <div class="application-go-icon">âœ“</div>
          <div class="application-go-text">${taskDef?.task_name || 'ç”³è«‹GO'} å®Œäº†</div>
        </div>`;
      } else if (applicationGoEnabled) {
        // æ¡ä»¶ãŒæƒã£ã¦ã„ã‚‹ï¼šã‚¯ãƒªãƒƒã‚¯å¯èƒ½
        applicationGoContainer.outerHTML = `<div class="application-go-container application-go-ready" onclick="confirmApplicationGo('${projectId}')">
          <div class="application-go-icon">ğŸš€</div>
          <div class="application-go-text">${taskDef?.task_name || 'ç”³è«‹GO'}</div>
          <div class="application-go-arrow">â†’</div>
        </div>`;
      } else {
        // æ¡ä»¶æœªé”
        const requiredTasks = getApplicationGoRequiredTasks();
        const tooltip = requiredTasks.length > 0
          ? requiredTasks.map(r => `${r.task_name}:${r.finalState}`).join('ã€') + ' ãŒå¿…è¦'
          : 'å¤ªé™½å…‰:ä¿å­˜æ¸ˆã€çµ¦æ’æ°´:ä¿å­˜æ¸ˆã€æ›æ°—:ä¿å­˜æ¸ˆã€ã‚µãƒƒã‚·:ä¿å­˜æ¸ˆ ãŒå¿…è¦';
        applicationGoContainer.outerHTML = `<div class="application-go-container application-go-disabled" title="${tooltip}">
          <div class="application-go-icon">ğŸ”’</div>
          <div class="application-go-text">${taskDef?.task_name || 'ç”³è«‹GO'}</div>
          <div class="application-go-status">æ¡ä»¶æœªé”</div>
        </div>`;
      }
    }
  }

  if (applicationGoCleared) {
    project.is_archived = false;
    renderProjects();
    renderSidebar();
    showToast('ç”³è«‹Goæ¡ä»¶ã‹ã‚‰å¤–ã‚ŒãŸãŸã‚ã€å®Œäº†çŠ¶æ…‹ã‚’è§£é™¤ã—ã¾ã—ãŸ', 'warning');
  }
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
}

function openProjectModal(projectId = null) {
  log('ğŸ“ openProjectModal() å‘¼ã³å‡ºã—:', projectId);
  log('ğŸ‘¥ designersé…åˆ—:', designers);

  editingProjectId = projectId;
  const modal = document.getElementById('projectModal');
  const title = document.getElementById('projectModalTitle');

  log('ğŸ¯ modalè¦ç´ :', modal);
  log('ğŸ¯ titleè¦ç´ :', title);

  let project = null;
  if (projectId) {
    project = projects.find(p => p.id === projectId);
    if (!project) {
      showToast('æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
      return;
    }
    title.textContent = 'æ¡ˆä»¶ç·¨é›†';
    document.getElementById('projectCustomer').value = project.customer;
    document.getElementById('projectSpecifications').value = project.specifications || 'LIFE';
    document.getElementById('projectMemo').value = project.memo || '';
  } else {
    title.textContent = 'æ¡ˆä»¶è¿½åŠ ';
    document.getElementById('projectCustomer').value = '';
    document.getElementById('projectSpecifications').value = 'LIFE';
    document.getElementById('projectMemo').value = '';
  }

  // è¨­è¨ˆæ‹…å½“è€…ï¼ˆè¨­è¨ˆã‚«ãƒ†ã‚´ãƒªã®ã¿ï¼‰ã‚’åŸ‹ã‚ã‚‹
  log('ğŸ”§ è¨­è¨ˆæ‹…å½“è€…ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä¸­...');
  const sekkeiDesigners = designers.filter(d => d.category === 'è¨­è¨ˆ');
  log('âœ… è¨­è¨ˆæ‹…å½“è€…:', sekkeiDesigners);

  const assignedToSelect = document.getElementById('projectAssignedTo');
  log('ğŸ¯ assignedToSelectè¦ç´ :', assignedToSelect);

  if (assignedToSelect) {
    assignedToSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
      sekkeiDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    // å€¤ã‚’è¨­å®šï¼ˆinnerHTMLå¾Œã«å®Ÿè¡Œï¼‰
    if (projectId && project) {
      // ç·¨é›†æ™‚: æ—¢å­˜ã®æ‹…å½“è€…ã‚’é¸æŠ
      assignedToSelect.value = project.assigned_to;
    } else if (currentDesignerTab !== 'ALL' && currentDesignerTab !== 'ARCHIVED') {
      // æ–°è¦æ¡ˆä»¶ã®å ´åˆã€ç¾åœ¨é¸æŠä¸­ã®ã‚¿ãƒ–ã®æ‹…å½“è€…ã‚’è‡ªå‹•é¸æŠ
      const currentDesigner = sekkeiDesigners.find(d => d.name === currentDesignerTab);
      if (currentDesigner) {
        assignedToSelect.value = currentDesigner.name;
      }
    } else {
      // ã€Œå…¨æ¡ˆä»¶ã€ã‚¿ãƒ–ã®å ´åˆã€æœ€å¾Œã«ä½¿ç”¨ã—ãŸæ‹…å½“è€…ã‚’è‡ªå‹•é¸æŠ
      const lastAssignee = localStorage.getItem('archideck_last_assignee');
      if (lastAssignee && sekkeiDesigners.find(d => d.name === lastAssignee)) {
        assignedToSelect.value = lastAssignee;
      }
    }
  }

  // ICæ‹…å½“è€…ï¼ˆICã‚«ãƒ†ã‚´ãƒªã®ã¿ï¼‰ã‚’åŸ‹ã‚ã‚‹
  log('ğŸ”§ ICæ‹…å½“è€…ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä¸­...');
  const icDesigners = designers.filter(d => d.category === 'IC');
  log('âœ… ICæ‹…å½“è€…:', icDesigners);

  const icAssigneeSelect = document.getElementById('projectIcAssignee');
  log('ğŸ¯ icAssigneeSelectè¦ç´ :', icAssigneeSelect);

  if (icAssigneeSelect) {
    icAssigneeSelect.innerHTML = '<option value="">æœªå®š</option>' +
      icDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    // å€¤ã‚’è¨­å®šï¼ˆinnerHTMLå¾Œã«å®Ÿè¡Œï¼‰
    if (projectId && project) {
      // ç·¨é›†æ™‚: æ—¢å­˜ã®ICæ‹…å½“è€…ã‚’é¸æŠ
      icAssigneeSelect.value = project.ic_assignee || '';
    }
  }

  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆç·¨é›†æ™‚ã®ã¿è¡¨ç¤ºï¼‰
  const templateButtons = document.getElementById('templateButtons');
  if (templateButtons) {
    templateButtons.style.display = projectId ? 'block' : 'none';
  }

  log('ğŸ¬ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™...');
  ModalManager.open(modal, '#projectCustomer');
  log('âœ… openProjectModal() å®Œäº†');
}

function closeProjectModal() {
  ModalManager.close(document.getElementById('projectModal'));
  editingProjectId = null;
}

async function saveProject() {
  // äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
  if (SaveGuard.isLocked('saveProject')) {
    return;
  }

  const customer = document.getElementById('projectCustomer').value.trim();
  const assignedTo = document.getElementById('projectAssignedTo').value.trim(); // trim()è¿½åŠ 
  const icAssignee = document.getElementById('projectIcAssignee').value.trim(); // trim()è¿½åŠ 
  const specifications = document.getElementById('projectSpecifications').value;
  const memo = document.getElementById('projectMemo').value.trim();

  log('ğŸ’¾ saveProjecté–‹å§‹:', { customer, assignedTo, icAssignee, specifications });

  if (!customer || !assignedTo) {
    showToast('ãŠå®¢æ§˜åã¨è¨­è¨ˆæ‹…å½“ã¯å¿…é ˆã§ã™', 'error');
    return;
  }

  await SaveGuard.run('saveProject', async () => {
    showStatus('ä¿å­˜ä¸­...', 'saving');

    // è¨­è¨ˆæ‹…å½“ã®IDã‚’å–å¾—
    const designer = designers.find(d => d.name.trim() === assignedTo);
    const designerId = designer ? designer.id : null;

    // ICæ‹…å½“è€…ã®IDã‚’å–å¾—ï¼ˆç©ºæ–‡å­—åˆ—ã®å ´åˆã¯nullï¼‰
    const icDesigner = icAssignee ? designers.find(d => d.name.trim() === icAssignee) : null;
    const icDesignerId = icDesigner ? icDesigner.id : null;

    const blankProgress = {};
    tasksV2.forEach(task => {
      blankProgress[task.task_key] = { completed: false, date: '', state: '' };
    });

    if (editingProjectId) {
      const project = projects.find(p => p.id === editingProjectId);
      const { error } = await supabase
        .from('projects')
        .update({
          customer,
          assigned_to: assignedTo,
          designer_id: designerId,
          ic_assignee: icAssignee || null,
          ic_designer_id: icDesignerId,
          specifications,
          memo,
          updated_at: new Date().toISOString()
        })
        .eq('id', editingProjectId);

      if (error) {
        showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        return;
      }

      Object.assign(project, {
        customer,
        assigned_to: assignedTo,
        ic_assignee: icAssignee || null,
        ic_designer_id: icDesignerId,
        specifications,
        memo,
        updated_at: new Date().toISOString()
      });
    } else {
      const newProject = {
        uid: 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        customer,
        assigned_to: assignedTo,
        designer_id: designerId,
        ic_assignee: icAssignee || null,
        ic_designer_id: icDesignerId,
        specifications,
        memo,
        status: 'active',
        progress: blankProgress,
        created_by: currentUser?.id || null
      };

      const { data, error } = await supabase
        .from('projects')
        .insert([newProject])
        .select();

      if (error) {
        showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        return;
      }

      log('âœ… æ–°è¦æ¡ˆä»¶ä¿å­˜æˆåŠŸ:', data[0]);
      log('ğŸ“Š assigned_to:', data[0].assigned_to);
      log('ğŸ“Š ic_assignee:', data[0].ic_assignee);
      projects.unshift(data[0]);
    }

    log('ğŸ”„ renderDesignerTabs()ã¨renderProjects()ã‚’å®Ÿè¡Œã—ã¾ã™');
    log('ğŸ“Š ç¾åœ¨ã®projectsæ•°:', projects.length);
    closeProjectModal();
    renderDesignerTabs();
    renderProjects();
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast('æ¡ˆä»¶ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
  });
}

function editProject(projectId) {
  openProjectModal(projectId);
}

async function deleteProject(projectId) {
  if (!confirm('ã“ã®æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  await SaveGuard.run(`deleteProject_${projectId}`, async () => {
    showStatus('å‰Šé™¤ä¸­...', 'saving');
    const { error } = await supabase
      .from('projects')
      .delete()
      .eq('id', projectId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    projects = projects.filter(p => p.id !== projectId);
    renderDesignerTabs();
    renderProjects();
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast('æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
  });
}

async function toggleArchive(projectId, isArchived) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const message = isArchived ? 'å®Œäº†æ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ' : 'æ¡ˆä»¶ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ';
  if (!confirm(message)) return;

  showStatus('æ›´æ–°ä¸­...', 'saving');

  const updateData = {
    is_archived: isArchived,
    archived_at: isArchived ? new Date().toISOString() : null
  };

  const { error } = await supabase
    .from('projects')
    .update(updateData)
    .eq('id', projectId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
  project.is_archived = isArchived;
  project.archived_at = updateData.archived_at;

  renderProjects();
  renderSidebar();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast(isArchived ? 'æ¡ˆä»¶ã‚’å®Œäº†æ¸ˆã¿ã«ã—ã¾ã—ãŸ' : 'æ¡ˆä»¶ã‚’å¾©å…ƒã—ã¾ã—ãŸ', 'success');
}

// å®Œäº†æ¸ˆã‹ã‚‰å¾©å…ƒï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è§£é™¤æ™‚ï¼‰
async function restoreFromArchive(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  if (!confirm(`ã€Œ${project.customer}ã€ã‚’æ‹…å½“è€…ï¼ˆ${project.assigned_to || 'æœªå‰²å½“'}ï¼‰ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ`)) {
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æˆ»ã™
    renderProjects();
    return;
  }

  showStatus('å¾©å…ƒä¸­...', 'saving');

  const { error } = await supabase
    .from('projects')
    .update({
      is_archived: false,
      archived_at: null,
      updated_at: new Date().toISOString()
    })
    .eq('id', projectId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    renderProjects(); // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æˆ»ã™
    return;
  }

  project.is_archived = false;
  project.archived_at = null;
  project.updated_at = new Date().toISOString();

  // æ‹…å½“è€…ã®ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
  if (project.assigned_to) {
    currentDesignerTab = project.assigned_to;
  } else {
    currentDesignerTab = 'ALL';
  }

  renderSidebar();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast(`${project.customer} ã‚’å¾©å…ƒã—ã¾ã—ãŸ`, 'success');
}

// ============================================
// ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†æ©Ÿèƒ½
// ============================================
function openDesignerModal() {
  renderDesignerList();
  ModalManager.open(document.getElementById('designerModal'));
}

function closeDesignerModal() {
  ModalManager.close(document.getElementById('designerModal'));
}

function renderDesignerList() {
  const container = document.getElementById('designerList');

  // ã‚«ãƒ†ã‚´ãƒªã§ä¸¦ã³æ›¿ãˆï¼ˆè¨­è¨ˆâ†’ICï¼‰
  const sortedDesigners = [...designers].sort((a, b) => {
    if (a.category === 'è¨­è¨ˆ' && b.category === 'IC') return -1;
    if (a.category === 'IC' && b.category === 'è¨­è¨ˆ') return 1;
    return (a.display_order || 999) - (b.display_order || 999);
  });

  container.innerHTML = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆ' + designers.length + 'åï¼‰</h3>' +
    '<div class="table-container"><table class="table"><thead><tr><th>ã‚¹ã‚¿ãƒƒãƒ•å</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>æ‹…å½“æ¡ˆä»¶æ•°</th><th>æ“ä½œ</th></tr></thead><tbody>' +
    sortedDesigners.map(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name).length;
      const categoryLabel = designer.category === 'è¨­è¨ˆ' ? 'è¨­è¨ˆæ‹…å½“' : 'ICæ‹…å½“';
      return `
        <tr>
          <td><strong>${designer.name}</strong></td>
          <td><span class="badge ${designer.category === 'è¨­è¨ˆ' ? 'badge-primary' : 'badge-success'}">${categoryLabel}</span></td>
          <td>${count}ä»¶</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteDesigner('${designer.id}')">å‰Šé™¤</button></td>
        </tr>
      `;
    }).join('') +
    '</tbody></table></div>';
}

async function addDesigner() {
  const name = document.getElementById('newDesignerName').value.trim();
  const category = document.getElementById('newDesignerCategory').value;

  if (!name) {
    showToast('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('æ—¢ã«å­˜åœ¨ã™ã‚‹ã‚¹ã‚¿ãƒƒãƒ•åã§ã™', 'error');
    return;
  }

  showStatus('è¿½åŠ ä¸­...', 'saving');

  // åŒã˜ã‚«ãƒ†ã‚´ãƒªã®æœ€å¤§display_orderã‚’å–å¾—ã—ã¦+1
  const sameCategoryDesigners = designers.filter(d => d.category === category);
  const maxDisplayOrder = sameCategoryDesigners.length > 0
    ? Math.max(...sameCategoryDesigners.map(d => d.display_order || 0))
    : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('designers')
    .insert([{ name, category, email: `${name.replace(/\s/g, '')}@temp.local`, created_by: currentUser?.id, display_order: newDisplayOrder }])
    .select();

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerName').value = '';
  renderDesignerList();
  renderDesignerTabs();
  renderSidebar();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

async function deleteDesigner(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã¯æ¡ˆä»¶ã«å‰²å½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚æ¡ˆä»¶ã®æ‹…å½“ã‚’å¤‰æ›´ã—ã¦ã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }

  if (!confirm(`${designer.name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  await SaveGuard.run(`deleteDesigner_${designerId}`, async () => {
    showStatus('å‰Šé™¤ä¸­...', 'saving');
    const { error } = await supabase
      .from('designers')
      .delete()
      .eq('id', designerId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    designers = designers.filter(d => d.id !== designerId);
    renderDesignerList();
    renderDesignerListInline();
    renderSidebar();
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
  });
}

// ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†é–¢æ•°
function renderDesignerListInline() {
  const container = document.getElementById('designerListInline');
  if (!container) return;

  const sekkeiDesigners = [...designers].filter(d => d.category === 'è¨­è¨ˆ').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const icDesigners = [...designers].filter(d => d.category === 'IC').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const exteriorDesigners = [...designers].filter(d => d.category === 'å¤–æ§‹').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));

  let html = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆ' + designers.length + 'åï¼‰</h3>';
  html += '<p style="color: var(--text-secondary); margin-bottom: 16px;">ğŸ’¡ è¡Œã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¡¨ç¤ºé †åºã‚’å¤‰æ›´ã§ãã¾ã™</p>';

  // ã‚¹ã‚¿ãƒƒãƒ•è¡Œã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  function renderDesignerRow(designer, category, countField) {
    const count = projects.filter(p => p[countField] === designer.name).length;
    const emailDisplay = designer.email && !designer.email.includes('@temp.local') ? designer.email : '<span style="color: var(--text-muted);">æœªè¨­å®š</span>';
    const canManageAuth = currentUserCategory === 'admin' || designer.id === currentDesigner?.id;
    const authButton = canManageAuth ? `<button class="btn btn-secondary btn-small" onclick="openDesignerAuthModal('${designer.id}')" style="margin-right: 4px;">ğŸ”‘</button>` : '';
    return `
      <tr class="draggable-row" draggable="true" data-designer-id="${designer.id}" data-category="${category}">
        <td><span class="drag-handle">â‰¡</span></td>
        <td><strong>${designer.name}</strong></td>
        <td>${emailDisplay}</td>
        <td>${count}ä»¶</td>
        <td>
          <button class="btn btn-ghost btn-small" onclick="openEditDesignerModal('${designer.id}')" style="margin-right: 4px;">âœï¸ ç·¨é›†</button>
          ${authButton}
          <button class="btn btn-danger btn-small" onclick="deleteDesignerInline('${designer.id}')">å‰Šé™¤</button>
        </td>
      </tr>
    `;
  }

  // è¨­è¨ˆæ‹…å½“
  if (sekkeiDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--primary-color);">ğŸ“ è¨­è¨ˆæ‹…å½“</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>ã‚¹ã‚¿ãƒƒãƒ•å</th><th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th><th>æ‹…å½“æ¡ˆä»¶æ•°</th><th>æ“ä½œ</th></tr></thead><tbody id="sekkeiTbody">';
    sekkeiDesigners.forEach(designer => {
      html += renderDesignerRow(designer, 'è¨­è¨ˆ', 'assigned_to');
    });
    html += '</tbody></table></div>';
  }

  // ICæ‹…å½“
  if (icDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--success-color);">ğŸ¨ ICæ‹…å½“</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>ã‚¹ã‚¿ãƒƒãƒ•å</th><th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th><th>æ‹…å½“æ¡ˆä»¶æ•°</th><th>æ“ä½œ</th></tr></thead><tbody id="icTbody">';
    icDesigners.forEach(designer => {
      html += renderDesignerRow(designer, 'IC', 'ic_assignee');
    });
    html += '</tbody></table></div>';
  }

  // å¤–æ§‹æ‹…å½“
  if (exteriorDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--secondary-color);">ğŸŒ³ å¤–æ§‹æ‹…å½“</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>ã‚¹ã‚¿ãƒƒãƒ•å</th><th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th><th>æ‹…å½“æ¡ˆä»¶æ•°</th><th>æ“ä½œ</th></tr></thead><tbody id="exteriorTbody">';
    exteriorDesigners.forEach(designer => {
      html += renderDesignerRow(designer, 'å¤–æ§‹', 'exterior_assignee');
    });
    html += '</tbody></table></div>';
  }

  container.innerHTML = html;

  // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  setupDragAndDrop();
}

// ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
function openEditDesignerModal(designerId) {
  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.id = 'editDesignerModal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†</h2>
        <button class="close" onclick="closeEditDesignerModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editDesignerId" value="${designer.id}">
        <div class="form-group">
          <label class="form-label">ã‚¹ã‚¿ãƒƒãƒ•å *</label>
          <input type="text" class="form-input" id="editDesignerName" value="${designer.name}" style="width: 100%;">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" class="form-input" id="editDesignerEmail" value="${designer.email && !designer.email.includes('@temp.local') ? designer.email : ''}" placeholder="ä¾‹: staff@example.com" style="width: 100%;">
        </div>
        <div class="form-group">
          <label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
          <select class="form-input" id="editDesignerCategory" style="width: 100%;">
            <option value="è¨­è¨ˆ" ${designer.category === 'è¨­è¨ˆ' ? 'selected' : ''}>è¨­è¨ˆæ‹…å½“</option>
            <option value="IC" ${designer.category === 'IC' ? 'selected' : ''}>ICæ‹…å½“</option>
            <option value="å¤–æ§‹" ${designer.category === 'å¤–æ§‹' ? 'selected' : ''}>å¤–æ§‹æ‹…å½“</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeEditDesignerModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveEditDesigner()">ä¿å­˜</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function closeEditDesignerModal() {
  const modal = document.getElementById('editDesignerModal');
  if (modal) modal.remove();
}

async function saveEditDesigner() {
  const designerId = document.getElementById('editDesignerId').value;
  const name = document.getElementById('editDesignerName').value.trim();
  const email = document.getElementById('editDesignerEmail').value.trim();
  const category = document.getElementById('editDesignerCategory').value;

  if (!name) {
    showToast('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  // åå‰ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€é‡è¤‡ãƒã‚§ãƒƒã‚¯
  if (name !== designer.name && designers.find(d => d.name === name && d.id !== designerId)) {
    showToast('æ—¢ã«å­˜åœ¨ã™ã‚‹ã‚¹ã‚¿ãƒƒãƒ•åã§ã™', 'error');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  const oldName = designer.name;
  const updateData = {
    name,
    category,
    email: email || `${name.replace(/\s/g, '')}@temp.local`
  };

  const { error } = await supabase
    .from('designers')
    .update(updateData)
    .eq('id', designerId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  // åå‰ãŒå¤‰ã‚ã£ãŸå ´åˆã€é–¢é€£ã™ã‚‹æ¡ˆä»¶ã®æ‹…å½“è€…åã‚‚æ›´æ–°
  if (oldName !== name) {
    const fieldsToUpdate = {
      'è¨­è¨ˆ': 'assigned_to',
      'IC': 'ic_assignee',
      'å¤–æ§‹': 'exterior_assignee'
    };
    const field = fieldsToUpdate[designer.category];
    if (field) {
      const relatedProjects = projects.filter(p => p[field] === oldName);
      for (const project of relatedProjects) {
        await supabase.from('projects').update({ [field]: name }).eq('id', project.id);
        project[field] = name;
      }
    }
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
  Object.assign(designer, updateData);

  closeEditDesignerModal();
  renderDesignerListInline();
  renderDesignerTabs();
  renderSidebar();
  renderProjects();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
}

async function addDesignerInline() {
  const name = document.getElementById('newDesignerNameInline').value.trim();
  const category = document.getElementById('newDesignerCategoryInline').value;

  if (!name) {
    showToast('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('æ—¢ã«å­˜åœ¨ã™ã‚‹ã‚¹ã‚¿ãƒƒãƒ•åã§ã™', 'error');
    return;
  }

  showStatus('è¿½åŠ ä¸­...', 'saving');

  // åŒã˜ã‚«ãƒ†ã‚´ãƒªã®æœ€å¤§display_orderã‚’å–å¾—ã—ã¦+1
  const sameCategoryDesigners = designers.filter(d => d.category === category);
  const maxDisplayOrder = sameCategoryDesigners.length > 0
    ? Math.max(...sameCategoryDesigners.map(d => d.display_order || 0))
    : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('designers')
    .insert([{ name, category, email: `${name.replace(/\s/g, '')}@temp.local`, created_by: currentUser?.id, display_order: newDisplayOrder }])
    .select();

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerNameInline').value = '';
  renderDesignerListInline();
  renderSidebar();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

async function deleteDesignerInline(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã¯æ¡ˆä»¶ã«å‰²å½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚æ¡ˆä»¶ã®æ‹…å½“ã‚’å¤‰æ›´ã—ã¦ã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚', 'error');
    return;
  }

  if (!confirm(`${designer.name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('designers')
    .delete()
    .eq('id', designerId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  designers = designers.filter(d => d.id !== designerId);
  renderDesignerListInline();
  renderSidebar();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// ã‚¹ã‚¿ãƒƒãƒ•èªè¨¼è¨­å®š
// ============================================
function openDesignerAuthModal(designerId) {
  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  document.getElementById('authDesignerId').value = designer.id;
  document.getElementById('authDesignerName').value = designer.name;
  document.getElementById('authDesignerEmail').value = designer.email && !designer.email.includes('@temp.local') ? designer.email : '';
  document.getElementById('authDesignerPassword').value = '';
  document.getElementById('authDesignerPasswordConfirm').value = '';

  ModalManager.open(document.getElementById('designerAuthModal'), '#authDesignerEmail');
}

function closeDesignerAuthModal() {
  ModalManager.close(document.getElementById('designerAuthModal'));
}

async function saveDesignerAuth() {
  const designerId = document.getElementById('authDesignerId').value;
  const email = document.getElementById('authDesignerEmail').value.trim();
  const password = document.getElementById('authDesignerPassword').value;
  const passwordConfirm = document.getElementById('authDesignerPasswordConfirm').value;

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (!email) {
    showToast('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (!password) {
    showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (password.length < 8) {
    showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (password !== passwordConfirm) {
    showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  try {
    const designer = designers.find(d => d.id === designerId);
    const oldEmail = designer.email;

    log('ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆé–‹å§‹:', { email, designerId });

    // 1. Supabase Authã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email: email,
      password: password,
      options: {
        data: {
          name: designer.name,
          designer_id: designerId
        },
        emailRedirectTo: window.location.origin
      }
    });

    log('ğŸ” signUpçµæœ:', { authData, authError });

    if (authError) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã ã‘ã‚’æ›´æ–°ã§ããªã„ã®ã§è­¦å‘Š
      if (authError.message.includes('already registered')) {
        showToast('âš ï¸ ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸã€ã‹ã‚‰å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚', 'error');
      } else {
        throw authError;
      }
    } else {
      log('âœ… Supabase Authã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå®Œäº†:', authData.user?.id);
    }

    // 2. designersãƒ†ãƒ¼ãƒ–ãƒ«ã®emailã‚’æ›´æ–°
    const { error: updateError } = await supabase
      .from('designers')
      .update({ email: email })
      .eq('id', designerId);

    if (updateError) {
      logError('âŒ designersæ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + updateError.message, 'error');
      return;
    }

    log('âœ… designersãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°å®Œäº†');

    // 3. ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼é…åˆ—ã‚’æ›´æ–°
    const designerIndex = designers.findIndex(d => d.id === designerId);
    if (designerIndex !== -1) {
      designers[designerIndex].email = email;
    }

    closeDesignerAuthModal();
    renderDesignerListInline();
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');

    if (authError && authError.message.includes('already registered')) {
      showToast('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ï¼‰', 'success');
    } else {
      showToast('âœ… ãƒ­ã‚°ã‚¤ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚', 'success', 5000);
    }

  } catch (error) {
    logError('âŒ èªè¨¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('èªè¨¼è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
  }
}

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
let draggedElement = null;

function setupDragAndDrop() {
  const draggableRows = document.querySelectorAll('.draggable-row');

  draggableRows.forEach(row => {
    row.addEventListener('dragstart', handleDesignerDragStart);
    row.addEventListener('dragover', handleDesignerDragOver);
    row.addEventListener('drop', handleDesignerDrop);
    row.addEventListener('dragend', handleDesignerDragEnd);
    row.addEventListener('dragleave', handleDesignerDragLeave);
  });
}

function handleDesignerDragStart(e) {
  draggedElement = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDesignerDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }

  // åŒã˜ã‚«ãƒ†ã‚´ãƒªå†…ã§ã®ã¿ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½
  const draggedCategory = draggedElement.dataset.category;
  const targetCategory = this.dataset.category;

  if (draggedCategory === targetCategory && this !== draggedElement) {
    this.classList.add('drag-over');
  }

  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDesignerDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }

  const draggedCategory = draggedElement.dataset.category;
  const targetCategory = this.dataset.category;

  // åŒã˜ã‚«ãƒ†ã‚´ãƒªå†…ã§ã®ã¿ãƒ‰ãƒ­ãƒƒãƒ—å®Ÿè¡Œ
  if (draggedCategory === targetCategory && draggedElement !== this) {
    const draggedId = draggedElement.dataset.designerId;
    const targetId = this.dataset.designerId;

    // é †åºã‚’å…¥ã‚Œæ›¿ãˆ
    updateDesignerOrder(draggedId, targetId, draggedCategory);
  }

  this.classList.remove('drag-over');
  return false;
}

function handleDesignerDragEnd(e) {
  this.classList.remove('dragging');

  const allRows = document.querySelectorAll('.draggable-row');
  allRows.forEach(row => {
    row.classList.remove('drag-over');
  });
}

function handleDesignerDragLeave(e) {
  this.classList.remove('drag-over');
}

async function updateDesignerOrder(draggedId, targetId, category) {
  showStatus('ä¸¦ã³æ›¿ãˆä¸­...', 'saving');

  // è©²å½“ã‚«ãƒ†ã‚´ãƒªã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å–å¾—
  const categoryDesigners = designers.filter(d => d.category === category);

  // ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸã‚¹ã‚¿ãƒƒãƒ•ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¹ã‚¿ãƒƒãƒ•ã‚’è¦‹ã¤ã‘ã‚‹
  const draggedIndex = categoryDesigners.findIndex(d => d.id === draggedId);
  const targetIndex = categoryDesigners.findIndex(d => d.id === targetId);

  // é…åˆ—ã‚’ä¸¦ã³æ›¿ãˆ
  const [draggedDesigner] = categoryDesigners.splice(draggedIndex, 1);
  categoryDesigners.splice(targetIndex, 0, draggedDesigner);

  // display_orderã‚’å†è¨ˆç®—
  const updates = [];
  for (let i = 0; i < categoryDesigners.length; i++) {
    const designer = categoryDesigners[i];
    const newOrder = i + 1;

    if (designer.display_order !== newOrder) {
      updates.push({
        id: designer.id,
        display_order: newOrder
      });

      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
      const localDesigner = designers.find(d => d.id === designer.id);
      if (localDesigner) {
        localDesigner.display_order = newOrder;
      }
    }
  }

  // Supabaseã«ä¸€æ‹¬æ›´æ–°
  for (const update of updates) {
    const { error } = await supabase
      .from('designers')
      .update({ display_order: update.display_order })
      .eq('id', update.id);

    if (error) {
      logError('ä¸¦ã³æ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }
  }

  // UIæ›´æ–°
  renderDesignerListInline();
  renderSidebar();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ä¸¦ã³æ›¿ãˆã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

// ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆã‚«ãƒ†ã‚´ãƒªè¿½åŠ 
async function addCategoryInline() {
  const name = document.getElementById('newCategoryNameInline').value.trim();

  if (!name) {
    showToast('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  if (vendorCategories.find(c => c.name === name)) {
    showToast('æ—¢ã«å­˜åœ¨ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªåã§ã™', 'error');
    return;
  }

  showStatus('è¿½åŠ ä¸­...', 'saving');
  const { data, error } = await supabase
    .from('vendor_categories')
    .insert([{ name, display_order: vendorCategories.length + 1 }])
    .select();

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  vendorCategories.push(data[0]);
  document.getElementById('newCategoryNameInline').value = '';
  renderCategoriesList();
  renderCategoryFilters();
  populateVendorCategoryDropdown();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
// ============================================
function renderTemplates() {
  const container = document.getElementById('templatesTable');
  if (!container) return; // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

  const categoryFilterEl = document.getElementById('categoryFilter');
  const categoryFilter = categoryFilterEl ? categoryFilterEl.value : null;

  let filtered = emailTemplates;

  // currentUserCategoryã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆç®¡ç†è€…ä»¥å¤–ï¼‰
  if (currentUserCategory && currentUserCategory !== 'admin') {
    filtered = emailTemplates.filter(t => t.category === currentUserCategory);
  }

  // ã•ã‚‰ã«ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
  if (categoryFilter) {
    filtered = filtered.filter(t => t.category === categoryFilter);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“§</div><div class="empty-title">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div><div class="empty-description">ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¦ã€æ¡ˆä»¶ã‹ã‚‰ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã§ãã¾ã™</div><button class="btn btn-primary" onclick="openTemplateModal()">+ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ </button></div>';
    return;
  }

  container.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>è¡¨ç¤ºå</th>
          <th>ã‚«ãƒ†ã‚´ãƒª</th>
          <th>ä¼šç¤¾å</th>
          <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(template => `
          <tr>
            <td><strong>${template.display_name}</strong></td>
            <td><span class="badge ${template.category === 'IC' ? 'badge-success' : 'badge-primary'}">${template.category}</span></td>
            <td>${template.company}</td>
            <td>${template.email || 'â€”'}</td>
            <td>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-ghost btn-small" onclick="editTemplate('${template.id}')">ç·¨é›†</button>
                <button class="btn btn-danger btn-small" onclick="deleteTemplate('${template.id}')">å‰Šé™¤</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function openTemplateModal(templateId = null) {
  editingTemplateId = templateId;
  const modal = document.getElementById('templateModal');
  const title = document.getElementById('templateModalTitle');

  if (templateId) {
    const template = emailTemplates.find(t => t.id === templateId);
    title.textContent = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†';
    document.getElementById('templateId').value = template.template_id;
    document.getElementById('templateId').disabled = true;
    document.getElementById('templateDisplayName').value = template.display_name;
    document.getElementById('templateCategory').value = template.category;
    document.getElementById('templateCompany').value = template.company;
    document.getElementById('templateContact').value = template.contact || '';
    document.getElementById('templateEmail').value = template.email || '';
    document.getElementById('templateSubjectFormat').value = template.subject_format || '';
    document.getElementById('templateText').value = template.template_text || '';
  } else {
    title.textContent = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ ';
    document.getElementById('templateId').value = '';
    document.getElementById('templateId').disabled = false;
    document.getElementById('templateDisplayName').value = '';
    document.getElementById('templateCategory').value = 'è¨­è¨ˆ';
    document.getElementById('templateCompany').value = '';
    document.getElementById('templateContact').value = '';
    document.getElementById('templateEmail').value = '';
    document.getElementById('templateSubjectFormat').value = '';
    document.getElementById('templateText').value = '';
  }

  ModalManager.open(modal, '#templateId');
}

function closeTemplateModal() {
  ModalManager.close(document.getElementById('templateModal'));
  editingTemplateId = null;
}

async function saveTemplate() {
  if (SaveGuard.isLocked('saveTemplate')) return;

  const templateId = document.getElementById('templateId').value.trim();
  const displayName = document.getElementById('templateDisplayName').value.trim();
  const category = document.getElementById('templateCategory').value;
  const company = document.getElementById('templateCompany').value.trim();
  const contact = document.getElementById('templateContact').value.trim();
  const email = document.getElementById('templateEmail').value.trim();
  const subjectFormat = document.getElementById('templateSubjectFormat').value.trim();
  const templateText = document.getElementById('templateText').value.trim();

  if (!templateId || !displayName || !company || !subjectFormat || !templateText) {
    showToast('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  await SaveGuard.run('saveTemplate', async () => {
    showStatus('ä¿å­˜ä¸­...', 'saving');

    const templateData = {
      template_id: templateId,
      display_name: displayName,
      category,
      company,
      contact,
      email,
      subject_format: subjectFormat,
      template_text: templateText,
      has_special_content: false,
      has_sub_options: false,
      created_by: currentUser.id
    };

    if (editingTemplateId) {
      const { error } = await supabase
        .from('email_templates')
        .update(templateData)
        .eq('id', editingTemplateId);

      if (error) {
        showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        return;
      }

      const template = emailTemplates.find(t => t.id === editingTemplateId);
      Object.assign(template, templateData);
    } else {
      const { data, error } = await supabase
        .from('email_templates')
        .insert([templateData])
        .select();

      if (error) {
        showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        return;
      }

      emailTemplates.push(data[0]);
    }

    closeTemplateModal();
    renderTemplates();
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
  });
}

function editTemplate(templateId) {
  openTemplateModal(templateId);
}

async function deleteTemplate(templateId) {
  if (!confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  showStatus('å‰Šé™¤ä¸­...', 'saving');
  const { error } = await supabase
    .from('email_templates')
    .delete()
    .eq('id', templateId);

  if (error) {
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    return;
  }

  emailTemplates = emailTemplates.filter(t => t.id !== templateId);
  renderTemplates();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// ã‚¿ã‚¹ã‚¯ã‹ã‚‰ã®ãƒ¡ãƒ¼ãƒ«ä½œæˆæ©Ÿèƒ½ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºèªå¾Œã«Gmailé–‹ãï¼‰
// ============================================
async function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) {
    showToast('æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  // ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’å–å¾—
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  if (!taskDef) {
    showToast('ã‚¿ã‚¹ã‚¯å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  // ã‚¿ã‚¹ã‚¯ã«ç´ã¥ã„ãŸæ¥­è€…ã‚’å–å¾—
  const mappings = taskVendorMappings.filter(m => m.task_id === taskDef.id);
  if (mappings.length === 0) {
    showToast('ã“ã®ã‚¿ã‚¹ã‚¯ã«æ¥­è€…ãŒç´ã¥ã‘ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
    return;
  }

  // æ¥­è€…æƒ…å ±ã‚’å–å¾—
  const taskVendors = mappings
    .map(m => vendorsV2.find(v => v.id === m.vendor_id))
    .filter(v => v != null);

  if (taskVendors.length === 0) {
    showToast('æ¥­è€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  // æ‹…å½“è€…æƒ…å ±ã‚’å–å¾—
  const designer = designers.find(d => d.id === project.designer_id);
  const staffName = designer ? designer.name : '';

  // ç¾åœ¨æ—¥ä»˜ã‹ã‚‰æœŸæ—¥ã‚’è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼š7æ—¥å¾Œï¼‰
  const today = new Date();
  const dueDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
  const dueDateStr = dueDate.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' }).replace('/', 'æœˆ') + 'æ—¥';

  // æœ€åˆã®æ¥­è€…ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨
  const vendor = taskVendors[0];

  // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç½®æ›
  const replacePlaceholders = (text) => {
    if (!text) return '';
    return text
      .replace(/\{customerName\}/g, project.customer)
      .replace(/\{dueDate\}/g, dueDateStr)
      .replace(/\{staffName\}/g, staffName)
      .replace(/\{company\}/g, vendor.company)
      .replace(/\{contact\}/g, vendor.contact || 'ã”æ‹…å½“è€…æ§˜');
  };

  // åˆæœŸã®ä»¶åã¨æœ¬æ–‡ã‚’ç”Ÿæˆ
  const initialSubject = replacePlaceholders(vendor.subject_format || `${project.customer}æ§˜é‚¸ ${taskDef.task_name}`);
  const initialBody = replacePlaceholders(vendor.template_text || '');

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  showEmailModal(project, taskDef, taskVendors, initialSubject, initialBody);
}

function showEmailModal(project, taskDef, vendors, initialSubject, initialBody) {
  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  // æ¥­è€…é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®HTMLï¼ˆXSSå¯¾ç­–: escapeHtmlé©ç”¨ï¼‰
  const vendorCheckboxes = vendors.map((v, idx) => `
    <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md); cursor: pointer;">
      <input type="checkbox"
        id="vendor_${escapeHtml(v.id)}"
        value="${escapeHtml(v.id)}"
        ${idx === 0 ? 'checked' : ''}
        onchange="updateEmailPreview()"
        style="width: 18px; height: 18px; cursor: pointer;">
      <div style="flex: 1;">
        <div style="font-weight: 600; margin-bottom: 2px;">${escapeHtml(v.company)}</div>
        <div style="font-size: 13px; color: var(--text-secondary);">${escapeHtml(v.contact || '')} - ${escapeHtml(v.email || '')}</div>
      </div>
    </label>
  `).join('');

  content.innerHTML = `
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <div>
        <h3 style="margin: 0 0 8px 0; font-size: 18px;">ğŸ“§ ${escapeHtml(taskDef.task_name)} - ãƒ¡ãƒ¼ãƒ«ä½œæˆ</h3>
        <div style="font-size: 14px; color: var(--text-secondary);">æ¡ˆä»¶: ${escapeHtml(project.customer)}</div>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">å®›å…ˆæ¥­è€…ã‚’é¸æŠ</label>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${vendorCheckboxes}
        </div>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">ä»¶å</label>
        <input type="text" id="emailSubject" class="form-input" value="${escapeHtml(initialSubject)}">
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">æœ¬æ–‡</label>
        <textarea id="emailBody" class="form-textarea" rows="15" style="font-family: inherit; line-height: 1.8;">${escapeHtml(initialBody)}</textarea>
      </div>

      <div style="display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="closeEmailModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-secondary" onclick="copyEmailToClipboard()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        <button class="btn btn-secondary" onclick="openOutlookFromModal()">ğŸ“¨ Outlook</button>
        <button class="btn btn-primary" onclick="openGmailFromModal()">ğŸ“§ Gmail</button>
      </div>
    </div>
  `;

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆopenGmailFromModalã§ä½¿ç”¨ï¼‰
  window.__emailModalData = { project, taskDef, vendors };

  modal.classList.add('show');
}

function updateEmailPreview() {
  // å¿…è¦ã«å¿œã˜ã¦ä»¶åãƒ»æœ¬æ–‡ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°å‡¦ç†ã‚’è¿½åŠ 
}

// ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—å…±é€šé–¢æ•°
function getSelectedEmailAddresses() {
  const { vendors } = window.__emailModalData || {};
  if (!vendors) return { addresses: '', vendors: [] };

  const selectedVendorIds = vendors
    .filter(v => document.getElementById(`vendor_${v.id}`)?.checked)
    .map(v => v.id);

  if (selectedVendorIds.length === 0) {
    showToast('æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return { addresses: '', vendors: [] };
  }

  const selectedVendors = vendors.filter(v => selectedVendorIds.includes(v.id));
  const emailAddresses = selectedVendors.map(v => v.email).filter(e => e).join(',');

  if (!emailAddresses) {
    showToast('é¸æŠã•ã‚ŒãŸæ¥­è€…ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
    return { addresses: '', vendors: [] };
  }

  return { addresses: emailAddresses, vendors: selectedVendors };
}

function openGmailFromModal() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  const { addresses } = getSelectedEmailAddresses();

  if (!addresses) return;

  // Gmail URLã‚’ç”Ÿæˆ
  const gmailUrl = `https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(addresses)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  // Gmailã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
  window.open(gmailUrl, '_blank');

  // é€ä¿¡å±¥æ­´ã‚’è¨˜éŒ²
  logEmailSent('gmail', addresses, subject);

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  closeEmailModal();

  // ãƒˆãƒ¼ã‚¹ãƒˆã§é€šçŸ¥
  showToast('Gmailã‚’é–‹ãã¾ã—ãŸ', 'success');
}

function openOutlookFromModal() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  const { addresses } = getSelectedEmailAddresses();

  if (!addresses) return;

  // Outlook Web URLã‚’ç”Ÿæˆ
  const outlookUrl = `https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(addresses)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  // Outlookã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
  window.open(outlookUrl, '_blank');

  // é€ä¿¡å±¥æ­´ã‚’è¨˜éŒ²
  logEmailSent('outlook', addresses, subject);

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  closeEmailModal();

  showToast('Outlookã‚’é–‹ãã¾ã—ãŸ', 'success');
}

function copyEmailToClipboard() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  const { addresses } = getSelectedEmailAddresses();

  if (!addresses) return;

  const emailText = `å®›å…ˆ: ${addresses}\nä»¶å: ${subject}\n\n${body}`;

  navigator.clipboard.writeText(emailText).then(() => {
    showToast('ãƒ¡ãƒ¼ãƒ«å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
  }).catch(() => {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    const textarea = document.createElement('textarea');
    textarea.value = emailText;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast('ãƒ¡ãƒ¼ãƒ«å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
  });
}

// ãƒ¡ãƒ¼ãƒ«é€ä¿¡å±¥æ­´ã‚’è¨˜éŒ²
async function logEmailSent(method, to, subject) {
  const { project, taskDef } = window.__emailModalData || {};
  if (!project || !taskDef) return;

  log(`ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡è¨˜éŒ²: ${method} -> ${to}, ä»¶å: ${subject}`);

  // å°†æ¥: Supabaseã«é€ä¿¡å±¥æ­´ã‚’ä¿å­˜
  // try {
  //   await supabase.from('email_logs').insert({
  //     project_id: project.id,
  //     task_key: taskDef.task_key,
  //     method,
  //     recipients: to,
  //     subject,
  //     sent_at: new Date().toISOString()
  //   });
  // } catch (e) {
  //   logError('ãƒ¡ãƒ¼ãƒ«å±¥æ­´ä¿å­˜å¤±æ•—:', e);
  // }
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠç”»é¢ã‚’è¡¨ç¤º
function showTemplateSelector(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  const currentTaskNames = getTaskNames();
  const taskName = currentTaskNames[taskKey];

  // ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿
  const availableTemplates = emailTemplates.filter(t => t.category === currentUserCategory);

  let html = `
    <div class="form-section">
      <h3 style="margin-bottom: 8px; color: var(--text-primary);">ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</h3>
      <p style="margin-bottom: 24px; color: var(--text-secondary); font-size: 14px;">
        æ¡ˆä»¶ï¼š${project.customer} ï¼ ã‚¿ã‚¹ã‚¯ï¼š${taskName}
      </p>

      <div style="display: grid; gap: 12px;">
        ${availableTemplates.map(template => `
          <button class="template-select-btn" onclick="selectTemplateForTask('${projectId}', '${taskKey}', '${template.template_id}')">
            <div style="font-weight: 600; margin-bottom: 4px;">${template.display_name}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">${template.company}</div>
          </button>
        `).join('')}
      </div>

      ${availableTemplates.length === 0 ? '<p style="text-align: center; padding: 32px; color: var(--text-muted);">åˆ©ç”¨å¯èƒ½ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>' : ''}
    </div>
  `;

  document.getElementById('emailComposerContent').innerHTML = html;
  ModalManager.open(document.getElementById('emailModal'));
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠå¾Œã«ãƒ¡ãƒ¼ãƒ«ä½œæˆç”»é¢ã‚’è¡¨ç¤º
function selectTemplateForTask(projectId, taskKey, templateId) {
  const project = projects.find(p => p.id === projectId);
  const template = emailTemplates.find(t => t.template_id === templateId);
  const designer = designers.find(d => d.id === project.designer_id);
  const staffName = designer ? designer.name : '';

  const composerHTML = createEmailComposer(project, template, staffName, taskKey);
  document.getElementById('emailComposerContent').innerHTML = composerHTML;
}

function createEmailComposer(project, template, staffName, taskKey) {
  const hasSubOptions = template.has_sub_options;
  const hasSpecialContent = template.has_special_content;

  let html = `
    <div class="form-section">
      <h3 style="margin-bottom: 16px; color: var(--text-primary);">${template.display_name}</h3>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div class="form-group">
          <label class="form-label">ãŠå®¢æ§˜å:</label>
          <input type="text" class="form-input" id="modalCustomerName" value="${project.customer}" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label class="form-label">æ‹…å½“è€…å:</label>
          <input type="text" class="form-input" id="modalStaffName" value="${staffName}" oninput="updateModalEmail()">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">æœŸæ—¥:</label>
        <input type="date" class="form-input" id="modalDueDate" oninput="updateModalEmail()">
      </div>
  `;

  if (hasSpecialContent) {
    const defaultContent = template.default_special_content || '';
    html += `
      <div class="form-group">
        <label class="form-label">ç‰¹è¨˜äº‹é …:</label>
        <textarea class="form-textarea" id="modalSpecialContent" rows="4" oninput="updateModalEmail()">${defaultContent}</textarea>
      </div>
    `;
  }

  if (hasSubOptions) {
    const templateVendors = vendors.filter(v => v.template_id === template.template_id);
    html += `
      <div class="form-group">
        <label class="form-label">æ¥­è€…é¸æŠ:</label>
        <select class="form-select" id="modalVendorSelect" onchange="updateModalEmail()">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          ${templateVendors.map(v => `<option value="${escapeHtml(v.vendor_id)}">${escapeHtml(v.company)}</option>`).join('')}
        </select>
      </div>
    `;
  }

  html += `
    </div>

    <div style="margin-top: 24px;">
      <h3 style="margin-bottom: 12px; color: var(--text-primary);">ğŸ“¬ ç”Ÿæˆã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«</h3>

      <div class="form-group">
        <label class="form-label">ä»¶å:</label>
        <div id="modalEmailSubject" style="padding: 12px; background: #f8f9fa; border-radius: 8px; font-weight: 500;"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailSubject')" style="margin-top: 8px;">ğŸ“‹ ä»¶åã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>

      <div class="form-group">
        <label class="form-label">é€ä¿¡å…ˆ:</label>
        <div id="modalEmailAddress" style="padding: 12px; background: #f8f9fa; border-radius: 8px; color: var(--primary-color);"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailAddress')" style="margin-top: 8px;">ğŸ“‹ ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>

      <div class="form-group">
        <label class="form-label">æœ¬æ–‡:</label>
        <div id="modalEmailBody" style="padding: 16px; background: #f8f9fa; border-radius: 8px; white-space: pre-wrap; line-height: 1.8; min-height: 200px;"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailBody')" style="margin-top: 8px;">ğŸ“‹ æœ¬æ–‡ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>

    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
      <button class="btn btn-secondary" onclick="closeEmailModal()">é–‰ã˜ã‚‹</button>
      <button class="btn btn-primary" onclick="markTaskAsRequested('${project.id}', '${taskKey}')">ä¾é ¼æ¸ˆã¿ã«ã™ã‚‹</button>
    </div>
  `;

  // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆupdateModalEmailã§ä½¿ç”¨ï¼‰
  window.__currentEmailData = {
    project,
    template,
    staffName,
    taskKey
  };

  // åˆå›ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ
  setTimeout(() => updateModalEmail(), 100);

  return html;
}

function updateModalEmail() {
  if (!window.__currentEmailData) return;

  const { project, template } = window.__currentEmailData;

  const customerName = document.getElementById('modalCustomerName')?.value || project.customer;
  const staffName = document.getElementById('modalStaffName')?.value || '';
  const dueDate = document.getElementById('modalDueDate')?.value || '';
  const specialContent = document.getElementById('modalSpecialContent')?.value || template.default_special_content || '';
  const vendorSelect = document.getElementById('modalVendorSelect');
  const selectedVendorId = vendorSelect?.value || '';

  let subject = template.subject_format || '';
  let body = template.template_text || '';
  let email = template.email || '';
  let company = template.company || '';
  let contact = template.contact || '';

  // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯æ¥­è€…æƒ…å ±ã‚’ä½¿ç”¨
  if (template.has_sub_options && selectedVendorId) {
    const vendor = vendors.find(v => v.template_id === template.template_id && v.vendor_id === selectedVendorId);
    if (vendor) {
      company = vendor.company;
      contact = vendor.contact || 'ã”æ‹…å½“è€…æ§˜';
      email = vendor.email || '';
    }
  }

  // å¤‰æ•°ã‚’ç½®æ›
  subject = subject
    .replace(/\{customerName\}/g, customerName)
    .replace(/\{dueDate\}/g, dueDate);

  body = body
    .replace(/\{company\}/g, company)
    .replace(/\{contact\}/g, contact)
    .replace(/\{customerName\}/g, customerName)
    .replace(/\{staffName\}/g, staffName)
    .replace(/\{dueDate\}/g, dueDate)
    .replace(/\{specialContent\}/g, specialContent);

  // è¡¨ç¤ºã‚’æ›´æ–°
  const subjectEl = document.getElementById('modalEmailSubject');
  const addressEl = document.getElementById('modalEmailAddress');
  const bodyEl = document.getElementById('modalEmailBody');

  if (subjectEl) subjectEl.textContent = subject;
  if (addressEl) addressEl.textContent = email;
  if (bodyEl) bodyEl.textContent = body;
}

function copyModalText(elementId) {
  const text = document.getElementById(elementId)?.textContent;
  if (!text || text.includes('{') || text.includes('é¸æŠã—ã¦ãã ã•ã„')) {
    showToast('ã‚³ãƒ”ãƒ¼ã§ãã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
  }).catch(err => {
    logError('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
    showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  });
}

async function markTaskAsRequested(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].state = 'ä¾é ¼æ¸ˆ';

  showStatus('ä¿å­˜ä¸­...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    logError('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    return;
  }

  project.progress = progressData;
  renderProjects();
  closeEmailModal();
  showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
  showToast('ä¾é ¼æ¸ˆã¿ã«æ›´æ–°ã—ã¾ã—ãŸ', 'success');
}

function closeEmailModal() {
  ModalManager.close(document.getElementById('emailModal'));
  window.__currentEmailData = null;
}

// ============================================
// ç‹¬ç«‹ã—ãŸãƒ¡ãƒ¼ãƒ«ä½œæˆæ©Ÿèƒ½ï¼ˆå‰Šé™¤äºˆå®šï¼‰
// ============================================
function updateStandaloneEmail() {
  const templateSelect = document.getElementById('standaloneTemplateSelect');
  const templateId = templateSelect.value;

  if (!templateId) {
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæœªé¸æŠæ™‚ã¯ã‚¯ãƒªã‚¢
    document.getElementById('standaloneEmailSubject').textContent = '';
    document.getElementById('standaloneEmailAddress').textContent = '';
    document.getElementById('standaloneEmailBody').textContent = '';
    document.getElementById('standaloneVendorGroup').style.display = 'none';
    document.getElementById('standaloneSpecialContentGroup').style.display = 'none';
    return;
  }

  const template = emailTemplates.find(t => t.template_id === templateId);
  if (!template) return;

  // ç‰¹è¨˜äº‹é …ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º
  if (template.has_special_content) {
    document.getElementById('standaloneSpecialContentGroup').style.display = 'block';
  } else {
    document.getElementById('standaloneSpecialContentGroup').style.display = 'none';
  }

  // å…¥åŠ›å€¤ã‚’å–å¾—
  const customerName = document.getElementById('standaloneCustomerName').value.trim();
  const staffName = document.getElementById('standaloneStaffName').value.trim();
  const dueDate = document.getElementById('standaloneDueDate').value;
  const specialContent = document.getElementById('standaloneSpecialContent').value.trim();

  // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæ¥­è€…é¸æŠï¼‰ãŒã‚ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å ´åˆ
  if (template.has_sub_options) {
    document.getElementById('standaloneVendorGroup').style.display = 'block';
    const vendorSelect = document.getElementById('standaloneVendorSelect');
    const selectedVendorId = vendorSelect.value;

    // æ¥­è€…é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
    if (vendorSelect.options.length === 0) {
      const templateVendors = vendors.filter(v => v.template_id === templateId);
      vendorSelect.innerHTML = '<option value="">æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>' +
        templateVendors.map(v =>
          `<option value="${escapeHtml(v.vendor_id)}">${escapeHtml(v.company)}</option>`
        ).join('');
    }

    if (!selectedVendorId) {
      // æ¥­è€…æœªé¸æŠæ™‚ã¯ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆã—ãªã„
      document.getElementById('standaloneEmailSubject').textContent = 'æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„';
      document.getElementById('standaloneEmailAddress').textContent = '';
      document.getElementById('standaloneEmailBody').textContent = '';
      return;
    }

    const vendor = vendors.find(v => v.template_id === templateId && v.vendor_id === selectedVendorId);
    if (!vendor) return;

    // æ¥­è€…æƒ…å ±ã§å¤‰æ•°ã‚’ç½®æ›
    let subject = template.subject_format || '';
    let body = template.template_text || '';

    subject = subject
      .replace(/\{customerName\}/g, customerName || '{ãŠå®¢æ§˜å}')
      .replace(/\{dueDate\}/g, dueDate || '{æœŸæ—¥}');

    body = body
      .replace(/\{company\}/g, vendor.company)
      .replace(/\{contact\}/g, vendor.contact || 'ã”æ‹…å½“è€…æ§˜')
      .replace(/\{customerName\}/g, customerName || '{ãŠå®¢æ§˜å}')
      .replace(/\{staffName\}/g, staffName || '{æ‹…å½“è€…å}')
      .replace(/\{dueDate\}/g, dueDate || '{æœŸæ—¥}')
      .replace(/\{specialContent\}/g, specialContent || template.default_special_content || '');

    document.getElementById('standaloneEmailSubject').textContent = subject;
    document.getElementById('standaloneEmailAddress').textContent = vendor.email || '';
    document.getElementById('standaloneEmailBody').textContent = body;
  } else {
    // ã‚µãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãªã—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    document.getElementById('standaloneVendorGroup').style.display = 'none';

    let subject = template.subject_format || '';
    let body = template.template_text || '';

    subject = subject
      .replace(/\{customerName\}/g, customerName || '{ãŠå®¢æ§˜å}')
      .replace(/\{dueDate\}/g, dueDate || '{æœŸæ—¥}');

    body = body
      .replace(/\{company\}/g, template.company)
      .replace(/\{contact\}/g, template.contact || 'ã”æ‹…å½“è€…æ§˜')
      .replace(/\{customerName\}/g, customerName || '{ãŠå®¢æ§˜å}')
      .replace(/\{staffName\}/g, staffName || '{æ‹…å½“è€…å}')
      .replace(/\{dueDate\}/g, dueDate || '{æœŸæ—¥}')
      .replace(/\{specialContent\}/g, specialContent || template.default_special_content || '');

    document.getElementById('standaloneEmailSubject').textContent = subject;
    document.getElementById('standaloneEmailAddress').textContent = template.email || '';
    document.getElementById('standaloneEmailBody').textContent = body;
  }
}

function copyStandaloneText(elementId) {
  const text = document.getElementById(elementId).textContent;
  if (!text || text.includes('{') || text.includes('é¸æŠã—ã¦ãã ã•ã„')) {
    showToast('ã‚³ãƒ”ãƒ¼ã§ãã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
  }).catch(err => {
    logError('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
    showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  });
}

function populateStandaloneTemplateSelect() {
  const select = document.getElementById('standaloneTemplateSelect');
  if (!select) return;

  // currentUserCategoryã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  let filtered = emailTemplates;
  if (currentUserCategory && currentUserCategory !== 'admin') {
    filtered = emailTemplates.filter(t => t.category === currentUserCategory);
  }

  select.innerHTML = '<option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>' +
    filtered.map(t =>
      `<option value="${escapeHtml(t.template_id)}">${escapeHtml(t.display_name)}</option>`
    ).join('');
}

// ============================================
// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
// ============================================
const ExportManager = {
  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  showModal() {
    const modal = document.createElement('div');
    modal.id = 'exportModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 500px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼</label>
            <div style="display: grid; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="exportFormat" value="csv" checked> CSVï¼ˆExcelå¯¾å¿œï¼‰
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="exportFormat" value="json"> JSON
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="exportFormat" value="print"> å°åˆ·ç”¨ãƒ¬ãƒãƒ¼ãƒˆ
              </label>
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡</label>
            <div style="display: grid; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exportProjects" checked> æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ï¼ˆ${projects.length}ä»¶ï¼‰
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exportWithTasks" checked> ã‚¿ã‚¹ã‚¯è©³ç´°ã‚’å«ã‚ã‚‹
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exportOnlyActive" checked> ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ¡ˆä»¶ã®ã¿
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('exportModal').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn-primary" onclick="ExportManager.execute()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  },

  execute() {
    const format = document.querySelector('input[name="exportFormat"]:checked').value;
    const includeProjects = document.getElementById('exportProjects').checked;
    const includeTasks = document.getElementById('exportWithTasks').checked;
    const onlyActive = document.getElementById('exportOnlyActive').checked;

    document.getElementById('exportModal').remove();

    let dataToExport = projects;
    if (onlyActive) {
      dataToExport = dataToExport.filter(p => p.status !== 'completed' && !p.is_archived);
    }

    switch (format) {
      case 'csv':
        this.exportCSV(dataToExport, includeTasks);
        break;
      case 'json':
        this.exportJSON(dataToExport, includeTasks);
        break;
      case 'print':
        this.exportPrint(dataToExport, includeTasks);
        break;
    }
  },

  exportCSV(data, includeTasks) {
    if (data.length === 0) {
      showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    let headers, rows;

    if (includeTasks) {
      headers = ['é¡§å®¢å', 'æ‹…å½“è€…', 'ICæ‹…å½“', 'å•†å“', 'é€²æ—ç‡', 'ã‚¿ã‚¹ã‚¯å', 'ã‚¿ã‚¹ã‚¯çŠ¶æ…‹', 'æœŸé™', 'ãƒ¡ãƒ¢', 'ä½œæˆæ—¥'];
      rows = [];
      data.forEach(p => {
        const progress = calculateProgress(p);
        const tasks = p.tasks || {};
        const taskEntries = Object.entries(tasks);

        if (taskEntries.length === 0) {
          rows.push([
            this.csvEscape(p.customer),
            this.csvEscape(p.assigned_to),
            this.csvEscape(p.ic_assignee),
            this.csvEscape(p.specifications || 'LIFE'),
            `${progress}%`,
            '', '', '',
            this.csvEscape(p.memo),
            p.created_at || ''
          ].join(','));
        } else {
          taskEntries.forEach(([key, task], idx) => {
            const taskDef = tasksV2.find(t => t.task_key === key);
            rows.push([
              idx === 0 ? this.csvEscape(p.customer) : '',
              idx === 0 ? this.csvEscape(p.assigned_to) : '',
              idx === 0 ? this.csvEscape(p.ic_assignee) : '',
              idx === 0 ? this.csvEscape(p.specifications || 'LIFE') : '',
              idx === 0 ? `${progress}%` : '',
              this.csvEscape(taskDef?.task_name || key),
              this.csvEscape(task.status || ''),
              task.due_date || '',
              idx === 0 ? this.csvEscape(p.memo) : '',
              idx === 0 ? (p.created_at || '') : ''
            ].join(','));
          });
        }
      });
    } else {
      headers = ['é¡§å®¢å', 'æ‹…å½“è€…', 'ICæ‹…å½“', 'å•†å“', 'é€²æ—ç‡', 'ãƒ¡ãƒ¢', 'ä½œæˆæ—¥', 'æ›´æ–°æ—¥'];
      rows = data.map(p => {
        const progress = calculateProgress(p);
        return [
          this.csvEscape(p.customer),
          this.csvEscape(p.assigned_to),
          this.csvEscape(p.ic_assignee),
          this.csvEscape(p.specifications || 'LIFE'),
          `${progress}%`,
          this.csvEscape(p.memo),
          p.created_at || '',
          p.updated_at || ''
        ].join(',');
      });
    }

    const csvContent = [headers.join(','), ...rows].join('\n');
    this.download(csvContent, 'csv', 'projects');
    showToast(`${data.length}ä»¶ã®æ¡ˆä»¶ã‚’CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
  },

  exportJSON(data, includeTasks) {
    if (data.length === 0) {
      showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    const exportData = data.map(p => {
      const base = {
        customer: p.customer,
        assigned_to: p.assigned_to,
        ic_assignee: p.ic_assignee,
        specifications: p.specifications,
        progress: calculateProgress(p),
        status: p.status,
        memo: p.memo,
        created_at: p.created_at,
        updated_at: p.updated_at
      };

      if (includeTasks && p.tasks) {
        base.tasks = Object.entries(p.tasks).map(([key, task]) => {
          const taskDef = tasksV2.find(t => t.task_key === key);
          return {
            task_key: key,
            task_name: taskDef?.task_name || key,
            status: task.status,
            due_date: task.due_date,
            completed_at: task.completed_at
          };
        });
      }

      return base;
    });

    const jsonContent = JSON.stringify({
      exported_at: new Date().toISOString(),
      version: APP_VERSION,
      count: exportData.length,
      projects: exportData
    }, null, 2);

    this.download(jsonContent, 'json', 'projects');
    showToast(`${data.length}ä»¶ã®æ¡ˆä»¶ã‚’JSONã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
  },

  exportPrint(data, includeTasks) {
    if (data.length === 0) {
      showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      showToast('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚è¨±å¯ã—ã¦ãã ã•ã„ã€‚', 'error');
      return;
    }

    const html = `
      <!DOCTYPE html>
      <html lang="ja">
      <head>
        <meta charset="UTF-8">
        <title>ArchiDeck - æ¡ˆä»¶ãƒ¬ãƒãƒ¼ãƒˆ</title>
        <style>
          body { font-family: 'Noto Sans JP', sans-serif; padding: 20mm; color: #333; }
          h1 { text-align: center; border-bottom: 2px solid #2563EB; padding-bottom: 10px; }
          .meta { text-align: right; color: #666; margin-bottom: 20px; }
          table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background: #f5f5f5; font-weight: 600; }
          .project-section { margin-bottom: 30px; page-break-inside: avoid; }
          .project-title { background: #2563EB; color: white; padding: 10px; margin-bottom: 10px; }
          .tasks-table { font-size: 12px; }
          .progress { font-weight: bold; color: #2563EB; }
          @media print {
            body { padding: 10mm; }
            .project-section { page-break-inside: avoid; }
          }
        </style>
      </head>
      <body>
        <h1>ArchiDeck æ¡ˆä»¶ãƒ¬ãƒãƒ¼ãƒˆ</h1>
        <div class="meta">
          å‡ºåŠ›æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}<br>
          æ¡ˆä»¶æ•°: ${data.length}ä»¶
        </div>
        ${data.map(p => {
          const progress = calculateProgress(p);
          const taskRows = includeTasks && p.tasks ? Object.entries(p.tasks).map(([key, task]) => {
            const taskDef = tasksV2.find(t => t.task_key === key);
            return `<tr>
              <td>${this.escapeHtml(taskDef?.task_name || key)}</td>
              <td>${this.escapeHtml(task.status || 'æœªç€æ‰‹')}</td>
              <td>${task.due_date || '-'}</td>
            </tr>`;
          }).join('') : '';

          return `
            <div class="project-section">
              <div class="project-title">${this.escapeHtml(p.customer)} - ${this.escapeHtml(p.specifications || 'LIFE')}</div>
              <table>
                <tr><th>æ‹…å½“è€…</th><td>${this.escapeHtml(p.assigned_to || '-')}</td><th>ICæ‹…å½“</th><td>${this.escapeHtml(p.ic_assignee || '-')}</td></tr>
                <tr><th>é€²æ—</th><td class="progress">${progress}%</td><th>ä½œæˆæ—¥</th><td>${p.created_at?.split('T')[0] || '-'}</td></tr>
                ${p.memo ? `<tr><th>ãƒ¡ãƒ¢</th><td colspan="3">${this.escapeHtml(p.memo)}</td></tr>` : ''}
              </table>
              ${includeTasks && taskRows ? `
                <table class="tasks-table">
                  <thead><tr><th>ã‚¿ã‚¹ã‚¯</th><th>çŠ¶æ…‹</th><th>æœŸé™</th></tr></thead>
                  <tbody>${taskRows}</tbody>
                </table>
              ` : ''}
            </div>
          `;
        }).join('')}
      </body>
      </html>
    `;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.onload = () => printWindow.print();
    showToast('å°åˆ·ç”¨ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
  },

  csvEscape(str) {
    if (!str) return '""';
    return `"${String(str).replace(/"/g, '""')}"`;
  },

  escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  },

  download(content, type, prefix) {
    const mimeTypes = {
      csv: 'text/csv;charset=utf-8;',
      json: 'application/json;charset=utf-8;'
    };
    const extensions = { csv: 'csv', json: 'json' };

    const bom = type === 'csv' ? new Uint8Array([0xEF, 0xBB, 0xBF]) : new Uint8Array([]);
    const blob = new Blob([bom, content], { type: mimeTypes[type] });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${prefix}_${new Date().toISOString().split('T')[0]}.${extensions[type]}`;
    link.click();
    URL.revokeObjectURL(url);
  }
};

// å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ—§é–¢æ•°ã‚’æ®‹ã™
function exportCSV() {
  ExportManager.showModal();
}

// ============================================
// ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
// ============================================
const DataImporter = {
  showModal() {
    const modal = document.createElement('div');
    modal.id = 'importModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 500px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆå½¢å¼</label>
            <select id="importFormat" class="form-input" style="width: 100%; padding: 10px;">
              <option value="csv">CSVï¼ˆExcelå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</option>
              <option value="json">JSONï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</label>
            <input type="file" id="importFile" accept=".csv,.json" style="width: 100%;">
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
              CSV: é¡§å®¢å,æ‹…å½“è€…,ICæ‹…å½“,å•†å“,ãƒ¡ãƒ¢ ã®å½¢å¼<br>
              JSON: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«
            </p>
          </div>
          <div id="importPreview" style="display: none; margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
            <div id="importPreviewContent" style="max-height: 200px; overflow-y: auto; background: var(--bg-secondary); padding: 12px; border-radius: 8px; font-size: 13px;"></div>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="importSkipDuplicates" checked>
              <span>é‡è¤‡ã™ã‚‹é¡§å®¢åã¯ã‚¹ã‚­ãƒƒãƒ—</span>
            </label>
          </div>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('importModal').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn-primary" id="importExecuteBtn" onclick="DataImporter.execute()" disabled>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    document.getElementById('importFile').addEventListener('change', (e) => {
      this.previewFile(e.target.files[0]);
    });
  },

  async previewFile(file) {
    if (!file) return;

    const format = document.getElementById('importFormat').value;
    const previewDiv = document.getElementById('importPreview');
    const previewContent = document.getElementById('importPreviewContent');
    const executeBtn = document.getElementById('importExecuteBtn');

    try {
      const text = await file.text();
      let data;

      if (format === 'csv') {
        data = this.parseCSV(text);
      } else {
        data = this.parseJSON(text);
      }

      if (data.length === 0) {
        previewContent.innerHTML = '<p style="color: var(--danger-color);">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
        executeBtn.disabled = true;
        previewDiv.style.display = 'block';
        return;
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆæœ€å¤§5ä»¶ï¼‰
      const previewItems = data.slice(0, 5);
      previewContent.innerHTML = `
        <p style="margin-bottom: 8px; font-weight: 500;">${data.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡º</p>
        ${previewItems.map(item => `
          <div style="padding: 8px; background: var(--bg-primary); border-radius: 4px; margin-bottom: 4px;">
            ${escapeHtml(item.customer || item.é¡§å®¢å || '(é¡§å®¢åãªã—)')} - ${escapeHtml(item.specifications || item.å•†å“ || 'LIFE')}
          </div>
        `).join('')}
        ${data.length > 5 ? `<p style="color: var(--text-muted);">...ä»– ${data.length - 5}ä»¶</p>` : ''}
      `;

      this.pendingData = data;
      executeBtn.disabled = false;
      previewDiv.style.display = 'block';

    } catch (error) {
      previewContent.innerHTML = `<p style="color: var(--danger-color);">ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${escapeHtml(error.message || 'Unknown error')}</p>`;
      executeBtn.disabled = true;
      previewDiv.style.display = 'block';
    }
  },

  parseCSV(text) {
    const lines = text.split('\n').filter(line => line.trim());
    if (lines.length < 2) return [];

    // ãƒ˜ãƒƒãƒ€ãƒ¼è§£æ
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const data = [];

    for (let i = 1; i < lines.length; i++) {
      const values = this.parseCSVLine(lines[i]);
      if (values.length === 0) continue;

      const row = {};
      headers.forEach((header, idx) => {
        row[header] = values[idx] || '';
      });

      // é¡§å®¢åãŒã‚ã‚Œã°æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è¿½åŠ 
      if (row['é¡§å®¢å'] || row['customer']) {
        data.push({
          customer: row['é¡§å®¢å'] || row['customer'] || '',
          assigned_to: row['æ‹…å½“è€…'] || row['assigned_to'] || '',
          ic_assignee: row['ICæ‹…å½“'] || row['ic_assignee'] || '',
          specifications: row['å•†å“'] || row['specifications'] || 'LIFE',
          memo: row['ãƒ¡ãƒ¢'] || row['memo'] || ''
        });
      }
    }

    return data;
  },

  parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === ',' && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    result.push(current.trim());
    return result;
  },

  parseJSON(text) {
    const json = JSON.parse(text);
    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼ã®å ´åˆ
    if (json.projects && Array.isArray(json.projects)) {
      return json.projects;
    }
    // é…åˆ—ã®å ´åˆ
    if (Array.isArray(json)) {
      return json;
    }
    return [];
  },

  async execute() {
    if (!this.pendingData || this.pendingData.length === 0) {
      showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    const skipDuplicates = document.getElementById('importSkipDuplicates').checked;
    const existingCustomers = new Set(projects.map(p => p.customer?.toLowerCase()));

    let imported = 0;
    let skipped = 0;

    showStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...', 'saving');

    for (const item of this.pendingData) {
      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if (skipDuplicates && existingCustomers.has(item.customer?.toLowerCase())) {
        skipped++;
        continue;
      }

      try {
        const newProject = {
          customer: item.customer,
          assigned_to: item.assigned_to || null,
          ic_assignee: item.ic_assignee || null,
          specifications: item.specifications || 'LIFE',
          memo: item.memo || '',
          status: 'active',
          progress: {},
          tasks: {}
        };

        const { data, error } = await supabase
          .from('projects')
          .insert(newProject)
          .select()
          .single();

        if (!error && data) {
          projects.push(data);
          existingCustomers.add(item.customer?.toLowerCase());
          imported++;
        }
      } catch (e) {
        logError('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    document.getElementById('importModal').remove();
    renderProjects();
    renderSidebar();
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');

    let message = `${imported}ä»¶ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`;
    if (skipped > 0) {
      message += `ï¼ˆ${skipped}ä»¶ã¯é‡è¤‡ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼‰`;
    }
    showToast(message, 'success');

    this.pendingData = null;
  },

  pendingData: null
};

// ============================================
// ãŠæ°—ã«å…¥ã‚Šç®¡ç†
// ============================================
const FavoritesManager = {
  favorites: new Set(safeJsonParse(localStorage.getItem('favorites'), [])),

  toggle(projectId) {
    if (this.favorites.has(projectId)) {
      this.favorites.delete(projectId);
      showToast('ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
    } else {
      this.favorites.add(projectId);
      showToast('ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    }
    this.save();
    renderProjects();
  },

  isFavorite(projectId) {
    return this.favorites.has(projectId);
  },

  save() {
    localStorage.setItem('favorites', JSON.stringify([...this.favorites]));
  },

  getCount() {
    return this.favorites.size;
  }
};

// ============================================
// ãƒãƒƒãƒæ“ä½œ
// ============================================
const BatchOperations = {
  selected: new Set(),

  toggle(projectId) {
    if (this.selected.has(projectId)) {
      this.selected.delete(projectId);
    } else {
      this.selected.add(projectId);
    }
    this.updateUI();
  },

  selectAll() {
    const visibleCards = document.querySelectorAll('.project-card[data-project-id]');
    visibleCards.forEach(card => {
      this.selected.add(card.dataset.projectId);
    });
    this.updateUI();
    renderProjects();
  },

  deselectAll() {
    this.selected.clear();
    this.updateUI();
    renderProjects();
  },

  isSelected(projectId) {
    return this.selected.has(projectId);
  },

  updateUI() {
    const toolbar = document.getElementById('batchToolbar');
    const count = this.selected.size;

    if (count > 0) {
      if (!toolbar) {
        this.showToolbar();
      }
      document.getElementById('batchCount').textContent = `${count}ä»¶é¸æŠä¸­`;
    } else {
      if (toolbar) toolbar.remove();
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.batch-checkbox').forEach(cb => {
      cb.checked = this.selected.has(cb.dataset.projectId);
    });
  },

  showToolbar() {
    const toolbar = document.createElement('div');
    toolbar.id = 'batchToolbar';
    toolbar.style.cssText = `
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--bg-primary); border: 1px solid var(--border-color);
      padding: 12px 20px; border-radius: 12px; box-shadow: var(--shadow-lg);
      display: flex; align-items: center; gap: 16px; z-index: 1000;
    `;
    toolbar.innerHTML = `
      <span id="batchCount" style="font-weight: 600;">0ä»¶é¸æŠä¸­</span>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.archiveSelected()">ğŸ“¦ ä¸€æ‹¬å®Œäº†</button>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.showAssignModal()">ğŸ‘¤ æ‹…å½“å¤‰æ›´</button>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.deselectAll()">âœ• é¸æŠè§£é™¤</button>
    `;
    document.body.appendChild(toolbar);
  },

  async archiveSelected() {
    if (this.selected.size === 0) return;

    const confirmed = confirm(`${this.selected.size}ä»¶ã®æ¡ˆä»¶ã‚’å®Œäº†æ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ`);
    if (!confirmed) return;

    showStatus('å‡¦ç†ä¸­...', 'saving');
    let count = 0;

    for (const projectId of this.selected) {
      const { error } = await supabase
        .from('projects')
        .update({ is_archived: true, updated_at: new Date().toISOString() })
        .eq('id', projectId);

      if (!error) {
        const project = projects.find(p => p.id === projectId);
        if (project) project.is_archived = true;
        count++;
      }
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    renderSidebar();
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast(`${count}ä»¶ã‚’å®Œäº†æ¸ˆã¿ã«ã—ã¾ã—ãŸ`, 'success');
  },

  showAssignModal() {
    if (this.selected.size === 0) return;

    const modal = document.createElement('div');
    modal.id = 'batchAssignModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    const designerOptions = designers
      .filter(d => d.category === 'è¨­è¨ˆ')
      .map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`)
      .join('');

    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 400px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">ğŸ‘¤ ä¸€æ‹¬æ‹…å½“è€…å¤‰æ›´</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <p style="margin-bottom: 16px; color: var(--text-secondary);">${this.selected.size}ä»¶ã®æ¡ˆä»¶ã®æ‹…å½“è€…ã‚’å¤‰æ›´ã—ã¾ã™</p>
          <select id="batchAssignee" class="form-input" style="width: 100%;">
            <option value="">æ‹…å½“è€…ã‚’é¸æŠ</option>
            ${designerOptions}
          </select>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('batchAssignModal').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn-primary" onclick="BatchOperations.applyAssign()">å¤‰æ›´</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  },

  async applyAssign() {
    const assignee = document.getElementById('batchAssignee').value;
    if (!assignee) {
      showToast('æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
      return;
    }

    document.getElementById('batchAssignModal').remove();
    showStatus('å‡¦ç†ä¸­...', 'saving');
    let count = 0;

    for (const projectId of this.selected) {
      const { error } = await supabase
        .from('projects')
        .update({ assigned_to: assignee, updated_at: new Date().toISOString() })
        .eq('id', projectId);

      if (!error) {
        const project = projects.find(p => p.id === projectId);
        if (project) project.assigned_to = assignee;
        count++;
      }
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    renderSidebar();
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast(`${count}ä»¶ã®æ‹…å½“è€…ã‚’${assignee}ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
  }
};

// ============================================
// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†
// ============================================
const FilterPresets = {
  presets: safeJsonParse(localStorage.getItem('filterPresets'), []),

  save() {
    localStorage.setItem('filterPresets', JSON.stringify(this.presets));
  },

  getCurrentFilter() {
    return {
      designer: currentDesignerTab,
      archive: document.getElementById('archiveFilter')?.value || 'active',
      search: document.getElementById('searchQuery')?.value || '',
      spec: document.getElementById('specFilter')?.value || ''
    };
  },

  addPreset(name) {
    if (!name || !name.trim()) {
      showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
      return false;
    }

    const filter = this.getCurrentFilter();
    const preset = {
      id: Date.now().toString(),
      name: name.trim(),
      filter: filter,
      createdAt: new Date().toISOString()
    };

    this.presets.unshift(preset);
    this.save();
    this.renderDropdown();
    showToast(`ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, 'success');
    return true;
  },

  deletePreset(id) {
    const preset = this.presets.find(p => p.id === id);
    if (preset && confirm(`ã€Œ${preset.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      this.presets = this.presets.filter(p => p.id !== id);
      this.save();
      this.renderDropdown();
      showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
    }
  },

  applyPreset(id) {
    const preset = this.presets.find(p => p.id === id);
    if (!preset) return;

    const { filter } = preset;

    // æ‹…å½“è€…ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
    if (filter.designer) {
      currentDesignerTab = filter.designer;
      renderDesignerTabs();
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å€¤ã‚’è¨­å®š
    const archiveFilter = document.getElementById('archiveFilter');
    const searchQuery = document.getElementById('searchQuery');
    const specFilter = document.getElementById('specFilter');

    if (archiveFilter) archiveFilter.value = filter.archive || 'active';
    if (searchQuery) searchQuery.value = filter.search || '';
    if (specFilter) specFilter.value = filter.spec || '';

    renderProjects();
    showToast(`ã€Œ${preset.name}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸ`, 'success');
  },

  showSaveModal() {
    const filter = this.getCurrentFilter();
    const filterDesc = this.describeFilter(filter);

    const modal = document.createElement('div');
    modal.id = 'presetSaveModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä¿å­˜</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
            <strong>ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</strong><br>${filterDesc}
          </div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">ãƒ—ãƒªã‚»ãƒƒãƒˆå</label>
          <input type="text" id="presetName" class="form-input" style="width: 100%;" placeholder="ä¾‹: ç”°ä¸­ã•ã‚“ã®é€²è¡Œä¸­æ¡ˆä»¶" autofocus>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('presetSaveModal').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn-primary" onclick="FilterPresets.confirmSave()">ä¿å­˜</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);

    // Enterã‚­ãƒ¼ã§ä¿å­˜
    document.getElementById('presetName').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') FilterPresets.confirmSave();
    });
  },

  confirmSave() {
    const name = document.getElementById('presetName').value;
    if (this.addPreset(name)) {
      document.getElementById('presetSaveModal').remove();
    }
  },

  describeFilter(filter) {
    const parts = [];
    if (filter.designer && filter.designer !== 'ALL') {
      parts.push(`æ‹…å½“: ${filter.designer}`);
    }
    if (filter.archive && filter.archive !== 'active') {
      const labels = { all: 'å…¨ã¦', archived: 'å®Œäº†æ¸ˆã¿', favorites: 'ãŠæ°—ã«å…¥ã‚Š' };
      parts.push(labels[filter.archive] || filter.archive);
    }
    if (filter.search) {
      parts.push(`æ¤œç´¢: "${filter.search}"`);
    }
    if (filter.spec) {
      parts.push(`ä»•æ§˜: ${filter.spec}`);
    }
    return parts.length > 0 ? parts.join('ã€') : 'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—';
  },

  renderDropdown() {
    const container = document.getElementById('presetDropdown');
    if (!container) return;

    if (this.presets.length === 0) {
      container.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); font-size: 13px;">ä¿å­˜æ¸ˆã¿ãƒ—ãƒªã‚»ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    container.innerHTML = this.presets.map(preset => `
      <div class="preset-item" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid var(--border-color); cursor: pointer;"
           onmouseenter="this.style.background='var(--bg-secondary)'"
           onmouseleave="this.style.background='white'">
        <div style="flex: 1;" onclick="FilterPresets.applyPreset('${preset.id}'); document.getElementById('presetMenu').style.display='none';">
          <div style="font-weight: 500; font-size: 14px;">${preset.name}</div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${this.describeFilter(preset.filter)}</div>
        </div>
        <button class="btn btn-ghost btn-small" style="padding: 4px 8px; font-size: 12px;" onclick="event.stopPropagation(); FilterPresets.deletePreset('${preset.id}')">å‰Šé™¤</button>
      </div>
    `).join('');
  },

  toggleMenu() {
    const menu = document.getElementById('presetMenu');
    if (!menu) return;

    if (menu.style.display === 'none' || !menu.style.display) {
      this.renderDropdown();
      menu.style.display = 'block';
      // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      setTimeout(() => {
        document.addEventListener('click', this.closeMenuOnClickOutside);
      }, 10);
    } else {
      menu.style.display = 'none';
      document.removeEventListener('click', this.closeMenuOnClickOutside);
    }
  },

  closeMenuOnClickOutside(e) {
    const menu = document.getElementById('presetMenu');
    const btn = document.getElementById('presetBtn');
    if (menu && !menu.contains(e.target) && !btn.contains(e.target)) {
      menu.style.display = 'none';
      document.removeEventListener('click', FilterPresets.closeMenuOnClickOutside);
    }
  }
};

// ============================================
// ã‚¯ã‚¤ãƒƒã‚¯ç·¨é›†
// ============================================
const QuickEdit = {
  showAssigneeDropdown(projectId, element) {
    // æ—¢å­˜ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å‰Šé™¤
    document.querySelectorAll('.quick-edit-dropdown').forEach(el => el.remove());

    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const rect = element.getBoundingClientRect();
    const designerList = designers.filter(d => d.category === 'è¨­è¨ˆ' || d.category === 'IC');

    const dropdown = document.createElement('div');
    dropdown.className = 'quick-edit-dropdown';
    dropdown.style.cssText = `position: fixed; top: ${rect.bottom + 4}px; left: ${rect.left}px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; min-width: 150px;`;

    dropdown.innerHTML = `
      <div style="padding: 8px 12px; border-bottom: 1px solid var(--border-color); font-size: 12px; color: var(--text-secondary);">æ‹…å½“è€…ã‚’å¤‰æ›´</div>
      ${designerList.map(d => `
        <div class="quick-edit-option" style="padding: 10px 12px; cursor: pointer; font-size: 14px; ${project.assigned_to === d.name ? 'background: var(--primary-light); font-weight: 500;' : ''}"
             onmouseenter="this.style.background='var(--bg-secondary)'"
             onmouseleave="this.style.background='${project.assigned_to === d.name ? 'var(--primary-light)' : ''}'"
             onclick="QuickEdit.changeAssignee('${projectId}', '${d.name}')">${d.name}</div>
      `).join('')}
    `;

    document.body.appendChild(dropdown);

    // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    setTimeout(() => {
      document.addEventListener('click', QuickEdit.closeDropdown);
    }, 10);
  },

  closeDropdown(e) {
    if (!e.target.closest('.quick-edit-dropdown') && !e.target.closest('.quick-edit-trigger')) {
      document.querySelectorAll('.quick-edit-dropdown').forEach(el => el.remove());
      document.removeEventListener('click', QuickEdit.closeDropdown);
    }
  },

  async changeAssignee(projectId, assignee) {
    document.querySelectorAll('.quick-edit-dropdown').forEach(el => el.remove());

    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const oldAssignee = project.assigned_to;
    showStatus('ä¿å­˜ä¸­...', 'saving');

    const { error } = await supabase
      .from('projects')
      .update({ assigned_to: assignee, updated_at: new Date().toISOString() })
      .eq('id', projectId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      return;
    }

    UndoManager.record({
      type: 'UPDATE_PROJECT',
      projectId,
      description: `${project.customer} - æ‹…å½“è€…ã‚’${oldAssignee || 'æœªå‰²å½“'}ã‹ã‚‰${assignee}ã«å¤‰æ›´`,
      oldValue: { assigned_to: oldAssignee },
      newValue: { assigned_to: assignee }
    });

    project.assigned_to = assignee;
    project.updated_at = new Date().toISOString();
    renderProjects();
    renderSidebar();
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast(`æ‹…å½“è€…ã‚’${assignee}ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
  }
};

// ============================================
// æœŸé™ãƒ»ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ç®¡ç†
// ============================================
const DeadlineManager = {
  reminders: safeJsonParse(localStorage.getItem('projectReminders'), {}),

  setDeadline(projectId, deadline) {
    this.reminders[projectId] = { deadline, notified: false };
    this.save();
  },

  getDeadline(projectId) {
    return this.reminders[projectId]?.deadline || null;
  },

  save() {
    localStorage.setItem('projectReminders', JSON.stringify(this.reminders));
  },

  checkReminders() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    projects.forEach(project => {
      const reminder = this.reminders[project.id];
      if (!reminder || reminder.notified || project.is_archived) return;

      const deadline = new Date(reminder.deadline);
      deadline.setHours(0, 0, 0, 0);
      const diffDays = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));

      if (diffDays <= 3 && diffDays >= 0) {
        const msg = diffDays === 0 ? 'æœ¬æ—¥ãŒæœŸé™ã§ã™' : `ã‚ã¨${diffDays}æ—¥ã§æœŸé™ã§ã™`;
        showToast(`ğŸ“… ${project.customer}: ${msg}`, 'warning');
        this.reminders[project.id].notified = true;
        this.save();
      } else if (diffDays < 0) {
        showToast(`âš ï¸ ${project.customer}: æœŸé™ã‚’${Math.abs(diffDays)}æ—¥éãã¦ã„ã¾ã™`, 'error');
        this.reminders[project.id].notified = true;
        this.save();
      }
    });
  },

  getStatus(projectId) {
    const deadline = this.getDeadline(projectId);
    if (!deadline) return null;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const due = new Date(deadline);
    due.setHours(0, 0, 0, 0);
    const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

    if (diffDays < 0) return { class: 'overdue', label: `${Math.abs(diffDays)}æ—¥è¶…é`, color: '#EF4444' };
    if (diffDays === 0) return { class: 'today', label: 'æœ¬æ—¥', color: '#F59E0B' };
    if (diffDays <= 3) return { class: 'soon', label: `ã‚ã¨${diffDays}æ—¥`, color: '#F59E0B' };
    return { class: 'normal', label: `${due.getMonth() + 1}/${due.getDate()}`, color: '#6B7280' };
  },

  showModal(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const currentDeadline = this.getDeadline(projectId) || '';

    const modal = document.createElement('div');
    modal.id = 'deadlineModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 360px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">æœŸé™ã‚’è¨­å®š</h3>
          <p style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;">${escapeHtml(project.customer)}</p>
        </div>
        <div style="padding: 20px;">
          <input type="date" id="deadlineInput" class="form-input" style="width: 100%;" value="${currentDeadline}">
          <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">æœŸé™ã®3æ—¥å‰ã‹ã‚‰é€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between;">
          <button class="btn btn-ghost" onclick="DeadlineManager.clearDeadline('${projectId}')">ã‚¯ãƒªã‚¢</button>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-ghost" onclick="document.getElementById('deadlineModal').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" onclick="DeadlineManager.saveFromModal('${projectId}')">ä¿å­˜</button>
          </div>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  },

  saveFromModal(projectId) {
    const deadline = document.getElementById('deadlineInput').value;
    if (deadline) {
      this.setDeadline(projectId, deadline);
      showToast('æœŸé™ã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
    }
    document.getElementById('deadlineModal').remove();
    renderProjects();
  },

  clearDeadline(projectId) {
    delete this.reminders[projectId];
    this.save();
    document.getElementById('deadlineModal').remove();
    renderProjects();
    showToast('æœŸé™ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
  }
};

// ============================================
// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
// ============================================
const TemplateManager = {
  templates: safeJsonParse(localStorage.getItem('projectTemplates'), []),

  save() {
    localStorage.setItem('projectTemplates', JSON.stringify(this.templates));
  },

  createFromProject(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const name = prompt('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', `${project.specifications || 'LIFE'}ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ`);
    if (!name) return;

    const template = {
      id: Date.now().toString(),
      name: name,
      specifications: project.specifications,
      progress: project.progress || {},
      createdAt: new Date().toISOString()
    };

    this.templates.push(template);
    this.save();
    showToast(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${name}ã€ã‚’ä½œæˆã—ã¾ã—ãŸ`, 'success');
  },

  applyTemplate(templateId, projectId) {
    const template = this.templates.find(t => t.id === templateId);
    const project = projects.find(p => p.id === projectId);
    if (!template || !project) return;

    project.specifications = template.specifications;
    project.progress = JSON.parse(JSON.stringify(template.progress));

    this.saveProject(project);
    showToast(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${template.name}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸ`, 'success');
  },

  async saveProject(project) {
    const { error } = await supabase
      .from('projects')
      .update({
        specifications: project.specifications,
        progress: project.progress,
        updated_at: new Date().toISOString()
      })
      .eq('id', project.id);

    if (!error) {
      renderProjects();
    }
  },

  deleteTemplate(templateId) {
    const template = this.templates.find(t => t.id === templateId);
    if (template && confirm(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${template.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      this.templates = this.templates.filter(t => t.id !== templateId);
      this.save();
      showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
    }
  },

  showSelectModal(projectId) {
    if (this.templates.length === 0) {
      showToast('ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'info');
      return;
    }

    const modal = document.createElement('div');
    modal.id = 'templateSelectModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨</h3>
        </div>
        <div style="padding: 12px; max-height: 300px; overflow-y: auto;">
          ${this.templates.map(t => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 500;">${t.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${t.specifications || 'LIFE'}</div>
              </div>
              <button class="btn btn-primary btn-small" onclick="TemplateManager.applyTemplate('${t.id}', '${projectId}'); document.getElementById('templateSelectModal').remove();">é©ç”¨</button>
            </div>
          `).join('')}
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color);">
          <button class="btn btn-ghost" style="width: 100%;" onclick="document.getElementById('templateSelectModal').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  },

  showManageModal() {
    const modal = document.createElement('div');
    modal.id = 'templateManageModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</h3>
        </div>
        <div style="padding: 12px; max-height: 400px; overflow-y: auto;">
          ${this.templates.length === 0 ? '<p style="padding: 20px; text-align: center; color: var(--text-secondary);">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“<br><small>æ¡ˆä»¶ã®ç·¨é›†ç”»é¢ã‹ã‚‰ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ã€ã§ä½œæˆã§ãã¾ã™</small></p>' : this.templates.map(t => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 500;">${t.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${t.specifications || 'LIFE'} | ${new Date(t.createdAt).toLocaleDateString()}</div>
              </div>
              <button class="btn btn-ghost btn-small" style="color: #EF4444;" onclick="TemplateManager.deleteTemplate('${t.id}'); document.getElementById('templateManageModal').remove(); TemplateManager.showManageModal();">å‰Šé™¤</button>
            </div>
          `).join('')}
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color);">
          <button class="btn btn-ghost" style="width: 100%;" onclick="document.getElementById('templateManageModal').remove()">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  }
};

// ============================================
// ãƒ¢ãƒã‚¤ãƒ«ã‚¹ãƒ¯ã‚¤ãƒ—æ“ä½œ
// ============================================
const MobileGestures = {
  startX: 0,
  startY: 0,
  currentCard: null,

  init() {
    document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
    document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
    document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: true });
  },

  handleTouchStart(e) {
    const card = e.target.closest('.project-card');
    if (!card) return;

    this.startX = e.touches[0].clientX;
    this.startY = e.touches[0].clientY;
    this.currentCard = card;
  },

  handleTouchMove(e) {
    if (!this.currentCard) return;

    const diffX = e.touches[0].clientX - this.startX;
    const diffY = e.touches[0].clientY - this.startY;

    // æ¨ªæ–¹å‘ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’æ¤œå‡º
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 30) {
      e.preventDefault();
      const maxSwipe = 100;
      const translateX = Math.max(-maxSwipe, Math.min(maxSwipe, diffX));
      this.currentCard.style.transform = `translateX(${translateX}px)`;
      this.currentCard.style.transition = 'none';

      // ã‚¹ãƒ¯ã‚¤ãƒ—æ–¹å‘ã«å¿œã˜ãŸèƒŒæ™¯è‰²
      if (diffX > 50) {
        this.currentCard.style.background = 'linear-gradient(to right, #10B981 0%, white 30%)';
      } else if (diffX < -50) {
        this.currentCard.style.background = 'linear-gradient(to left, #F59E0B 0%, white 30%)';
      } else {
        this.currentCard.style.background = '';
      }
    }
  },

  handleTouchEnd(e) {
    if (!this.currentCard) return;

    const diffX = e.changedTouches[0].clientX - this.startX;
    const projectId = this.currentCard.dataset.projectId;

    this.currentCard.style.transform = '';
    this.currentCard.style.transition = 'transform 0.2s ease';
    this.currentCard.style.background = '';

    if (diffX > 80 && projectId) {
      // å³ã‚¹ãƒ¯ã‚¤ãƒ—: ãŠæ°—ã«å…¥ã‚Šåˆ‡ã‚Šæ›¿ãˆ
      FavoritesManager.toggle(projectId);
    } else if (diffX < -80 && projectId) {
      // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—: å®Œäº†åˆ‡ã‚Šæ›¿ãˆ
      const project = projects.find(p => p.id === projectId);
      if (project && calculateProgress(project) >= 100) {
        toggleArchive(projectId, !project.is_archived);
      } else {
        showToast('å®Œäº†ã«ã™ã‚‹ã«ã¯é€²æ—100%ãŒå¿…è¦ã§ã™', 'info');
      }
    }

    this.currentCard = null;
  }
};

// ============================================
// ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç®¡ç†
// ============================================
const SessionManager = {
  timeoutMinutes: 60,
  warningMinutes: 5,
  lastActivity: Date.now(),
  timeoutId: null,
  warningId: null,
  warningShown: false,

  init() {
    this.resetTimer();
    this.setupActivityListeners();
    log('ğŸ”’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†é–‹å§‹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ' + this.timeoutMinutes + 'åˆ†ï¼‰');
  },

  setupActivityListeners() {
    const events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];
    events.forEach(event => {
      document.addEventListener(event, () => this.onActivity(), { passive: true });
    });
  },

  onActivity() {
    this.lastActivity = Date.now();
    if (this.warningShown) {
      this.hideWarning();
    }
    this.resetTimer();
  },

  resetTimer() {
    if (this.timeoutId) clearTimeout(this.timeoutId);
    if (this.warningId) clearTimeout(this.warningId);

    // è­¦å‘Šè¡¨ç¤ºã‚¿ã‚¤ãƒãƒ¼
    const warningMs = (this.timeoutMinutes - this.warningMinutes) * 60 * 1000;
    this.warningId = setTimeout(() => this.showWarning(), warningMs);

    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¿ã‚¤ãƒãƒ¼
    const timeoutMs = this.timeoutMinutes * 60 * 1000;
    this.timeoutId = setTimeout(() => this.onTimeout(), timeoutMs);
  },

  showWarning() {
    if (this.warningShown) return;
    this.warningShown = true;

    const warning = document.createElement('div');
    warning.id = 'sessionWarning';
    warning.style.cssText = `
      position: fixed; bottom: 20px; right: 20px; z-index: 10001;
      background: var(--warning-color); color: white;
      padding: 16px 20px; border-radius: 8px;
      box-shadow: var(--shadow-lg); max-width: 320px;
    `;
    warning.innerHTML = `
      <div style="font-weight: 600; margin-bottom: 8px;">â° ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™</div>
      <div style="font-size: 14px; margin-bottom: 12px;">
        ${this.warningMinutes}åˆ†é–“æ“ä½œãŒãªã„ã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™
      </div>
      <button onclick="SessionManager.extendSession()"
        style="background: var(--bg-primary); color: var(--warning-color); border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
        ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å»¶é•·
      </button>
    `;
    document.body.appendChild(warning);
  },

  hideWarning() {
    this.warningShown = false;
    const warning = document.getElementById('sessionWarning');
    if (warning) warning.remove();
  },

  extendSession() {
    this.onActivity();
    showToast('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å»¶é•·ã—ã¾ã—ãŸ', 'success');
  },

  onTimeout() {
    this.hideWarning();
    showToast('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'warning');
    setTimeout(() => signOut(), 2000);
  },

  stop() {
    if (this.timeoutId) clearTimeout(this.timeoutId);
    if (this.warningId) clearTimeout(this.warningId);
    this.hideWarning();
  }
};

// ============================================
// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ä¸¦ã³æ›¿ãˆ
// ============================================
let draggedProject = null;

let dragAndDropInitialized = false;

function enableDragAndDrop() {
  const container = document.getElementById('projectsContainer');
  if (!container || dragAndDropInitialized) return;

  dragAndDropInitialized = true;

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã§è¦ªè¦ç´ ã«1ã¤ã ã‘ãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰
  container.addEventListener('dragstart', (e) => {
    const card = e.target.closest('.project-card');
    if (card) handleProjectDragStart.call(card, e);
  });

  container.addEventListener('dragover', (e) => {
    const card = e.target.closest('.project-card');
    if (card) handleProjectDragOver.call(card, e);
  });

  container.addEventListener('drop', (e) => {
    const card = e.target.closest('.project-card');
    if (card) handleProjectDrop.call(card, e);
  });

  container.addEventListener('dragend', (e) => {
    const card = e.target.closest('.project-card');
    if (card) handleProjectDragEnd.call(card, e);
  });

  // ã‚«ãƒ¼ãƒ‰ã«draggableå±æ€§ã‚’ä»˜ä¸ï¼ˆMutationObserverã§ç›£è¦–ï¼‰
  const updateDraggable = () => {
    const cards = container.querySelectorAll('.project-card');
    cards.forEach((card, index) => {
      card.setAttribute('draggable', 'true');
      card.dataset.projectIndex = index;
    });
  };

  updateDraggable();

  // DOMå¤‰æ›´æ™‚ã«draggableå±æ€§ã‚’ä»˜ä¸ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯è¿½åŠ ã—ãªã„ï¼‰
  const observer = new MutationObserver(updateDraggable);
  observer.observe(container, { childList: true, subtree: true });
}

function handleProjectDragStart(e) {
  draggedProject = this;
  this.style.opacity = '0.4';
  e.dataTransfer.effectAllowed = 'move';
}

function handleProjectDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleProjectDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }

  if (draggedProject !== this) {
    const draggedIndex = parseInt(draggedProject.dataset.projectIndex);
    const targetIndex = parseInt(this.dataset.projectIndex);

    // é…åˆ—ã®é †åºã‚’å…¥ã‚Œæ›¿ãˆ
    const temp = projects[draggedIndex];
    projects.splice(draggedIndex, 1);
    projects.splice(targetIndex, 0, temp);

    // å†æç”»
    renderProjects();
  }

  return false;
}

function handleProjectDragEnd(e) {
  this.style.opacity = '1';

  // ã™ã¹ã¦ã®ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  const cards = document.querySelectorAll('.project-card');
  cards.forEach(card => {
    card.classList.remove('over');
  });
}

// ============================================
// URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹æ©Ÿèƒ½ï¼ˆãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰
// ============================================
function updateURLWithDesigner(designerName) {
  const currentHash = window.location.hash.substring(1); // #ã‚’é™¤å»
  const [pathPart] = currentHash.split('?');
  const mainTab = pathPart.split('/')[0] || 'projects';

  // æ–°ã—ã„URLã‚’æ§‹ç¯‰
  let newHash = mainTab;
  if (designerName !== 'ALL') {
    newHash += `?designer=${encodeURIComponent(designerName)}`;
  }

  // hashchangeã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ãšã«URLã‚’æ›´æ–°
  history.replaceState(null, '', `#${newHash}`);
}

function handleHashChange() {
  // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
  if (isHandlingHashChange) {
    log('â¸ï¸ handleHashChange: ã™ã§ã«å‡¦ç†ä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
    return;
  }

  const hash = window.location.hash.substring(1); // #ã‚’é™¤å»
  log('ğŸ”— handleHashChange é–‹å§‹:', {
    hash: hash,
    timestamp: new Date().toISOString(),
    vendorsV2Length: vendorsV2.length,
    taskVendorMappingsLength: taskVendorMappings.length
  });

  if (!hash) return;

  isHandlingHashChange = true;

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’åˆ†é›¢ï¼ˆä¾‹: projects?designer=ç®•æµ¦ï¼‰
  const [pathPart, queryPart] = hash.split('?');
  const [mainTab, subTab] = pathPart.split('/');

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è§£æ
  const params = new URLSearchParams(queryPart || '');
  const designerParam = params.get('designer');

  // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¾©å…ƒ
  if (designerParam) {
    currentDesignerTab = designerParam;
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤ºã‚’æ›´æ–°ï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå¾Œã«å®Ÿè¡Œï¼‰
    setTimeout(() => {
      renderSidebar();
      if (mainTab === 'projects') {
        renderProjects();
      }
    }, 150);
  }

  // ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
  if (mainTab === 'projects') {
    const btn = document.querySelector('.tab-nav-btn');
    if (btn) switchMainTab('projects', btn);
  } else if (mainTab === 'settings') {
    const btn = document.querySelectorAll('.tab-nav-btn')[1];
    if (btn) switchMainTab('settings', btn);

    // ã‚µãƒ–ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
    if (subTab) {
      setTimeout(() => {
        const subTabMap = {
          'staff': 0,
          'vendors': 1,
          'categories': 2,
          'tasks': 3,
          'products': 4
        };
        const index = subTabMap[subTab];
        if (index !== undefined) {
          const subBtn = document.querySelectorAll('.sub-tab-btn')[index];
          if (subBtn) switchSubTab(subTab, subBtn);
        }
        // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆé…å»¶å¾Œï¼‰
        setTimeout(() => {
          isHandlingHashChange = false;
          log('âœ… handleHashChangeå®Œäº†');
        }, 150);
      }, 100);
    } else {
      // ã‚µãƒ–ã‚¿ãƒ–ãŒãªã„å ´åˆã¯ã™ãã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
      setTimeout(() => {
        isHandlingHashChange = false;
        log('âœ… handleHashChangeå®Œäº†');
      }, 150);
    }
  } else {
    // ä¸æ˜ãªã‚¿ãƒ–ã®å ´åˆã¯ã™ãã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
    isHandlingHashChange = false;
  }
}

// ãƒãƒƒã‚·ãƒ¥å¤‰æ›´æ™‚ã®ãƒªã‚¹ãƒŠãƒ¼
window.addEventListener('hashchange', handleHashChange);

// ============================================
// ArchiDeck v3.0 æ–°æ©Ÿèƒ½
// ============================================

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°è¿½åŠ 
let projectTasks = [];
let projectMinutes = [];
let kintoneSettings = null;
let currentTaskSort = 'due';

// ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã‚«ãƒ†ã‚´ãƒªåˆ¥å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function getDesignersByCategory(category) {
  return designers.filter(d => d.category === category).sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
}
function getSekkeiDesigners() {
  return getDesignersByCategory('è¨­è¨ˆ');
}
function getIcDesigners() {
  return getDesignersByCategory('IC');
}
function getExteriorDesigners() {
  return getDesignersByCategory('å¤–æ§‹');
}

// ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«å¤–æ§‹æ‹…å½“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆrenderSidebaré–¢æ•°ã®æ‹¡å¼µï¼‰
const originalRenderSidebar = renderSidebar;
renderSidebar = function() {
  const container = document.getElementById('sidebarContent');
  if (!container) return;

  const sekkeiDesigners = getSekkeiDesigners();
  const icDesigners = getIcDesigners();
  const exteriorDesigners = getExteriorDesigners();
  const allCount = projects.filter(p => p.status !== 'completed' && !p.is_archived).length;
  const archivedCount = projects.filter(p => p.is_archived).length;

  let html = `
    <div class="sidebar-section">
      <div class="sidebar-item ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="selectDesigner('ALL')">
        <span class="sidebar-item-label">å…¨æ¡ˆä»¶</span>
        <span class="sidebar-item-count">${allCount}</span>
      </div>
      <div class="sidebar-item ${currentDesignerTab === 'ARCHIVED' ? 'active' : ''}" onclick="selectDesigner('ARCHIVED')" style="background: ${currentDesignerTab === 'ARCHIVED' ? 'var(--success-bg)' : 'transparent'};">
        <span class="sidebar-item-label" style="color: var(--success-color);">âœ“ å®Œäº†æ¸ˆ</span>
        <span class="sidebar-item-count" style="background: var(--success-color); color: white;">${archivedCount}</span>
      </div>
    </div>
  `;

  // è¨­è¨ˆæ‹…å½“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç”³è«‹GOæ•°ã®è‰²åˆ†ã‘ä»˜ãï¼‰
  if (sekkeiDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">ğŸ“ è¨­è¨ˆæ‹…å½“</div>';
    sekkeiDesigners.forEach(designer => {
      const designerProjects = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const designerName = designer.name.trim();
        return assigned === designerName && p.status !== 'completed' && !p.is_archived;
      });
      const count = designerProjects.length;

      // ç”³è«‹GOæœªå®Œäº†æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
      const applicationNotDone = designerProjects.filter(p => {
        const progressData = p.progress || {};
        return !progressData['application']?.completed;
      }).length;

      // è‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯
      let countClass = '';
      let nameClass = '';
      if (applicationNotDone >= 7) {
        nameClass = 'name-red';
        countClass = 'count-yellow';
      } else if (applicationNotDone >= 5) {
        countClass = 'count-yellow';
      } else if (applicationNotDone <= 4) {
        countClass = 'count-blue';
      }

      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label ${nameClass}">${designer.name}</span>
          <button class="sidebar-task-btn" onclick="event.stopPropagation(); openStaffTasksModal('${designer.name}')" title="ã‚¿ã‚¹ã‚¯ä¸€è¦§">ğŸ“‹</button>
          <span class="sidebar-item-count ${countClass}">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  // ICæ‹…å½“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè‰²åˆ†ã‘ä»˜ãï¼‰
  if (icDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">ğŸ¨ ICæ‹…å½“</div>';
    icDesigners.forEach(designer => {
      const count = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const icAssigned = (p.ic_assignee || '').trim();
        const designerName = designer.name.trim();
        return (assigned === designerName || icAssigned === designerName) && p.status !== 'completed' && !p.is_archived;
      }).length;

      // è‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆICç”¨ï¼‰
      let countClass = 'count-blue';
      let nameClass = '';
      if (count >= 7) {
        nameClass = 'name-red';
        countClass = 'count-yellow';
      } else if (count >= 5) {
        countClass = 'count-yellow';
      }

      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label ${nameClass}">${designer.name}</span>
          <button class="sidebar-task-btn" onclick="event.stopPropagation(); openStaffTasksModal('${designer.name}')" title="ã‚¿ã‚¹ã‚¯ä¸€è¦§">ğŸ“‹</button>
          <span class="sidebar-item-count ${countClass}">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  // å¤–æ§‹æ‹…å½“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè‰²åˆ†ã‘ä»˜ãï¼‰
  if (exteriorDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">ğŸŒ³ å¤–æ§‹æ‹…å½“</div>';
    exteriorDesigners.forEach(designer => {
      const count = projects.filter(p => {
        const exteriorAssigned = (p.exterior_assignee || '').trim();
        const designerName = designer.name.trim();
        return exteriorAssigned === designerName && p.status !== 'completed' && !p.is_archived;
      }).length;

      // è‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå¤–æ§‹ç”¨ï¼‰
      let countClass = 'count-blue';
      let nameClass = '';
      if (count >= 7) {
        nameClass = 'name-red';
        countClass = 'count-yellow';
      } else if (count >= 5) {
        countClass = 'count-yellow';
      }

      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label ${nameClass}">${designer.name}</span>
          <button class="sidebar-task-btn" onclick="event.stopPropagation(); openStaffTasksModal('${designer.name}')" title="ã‚¿ã‚¹ã‚¯ä¸€è¦§">ğŸ“‹</button>
          <span class="sidebar-item-count ${countClass}">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  container.innerHTML = html;
};

// æ‹…å½“è€…ã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«
let currentStaffForTasks = null;

function openStaffTasksModal(staffName) {
  currentStaffForTasks = staffName;
  document.getElementById('staffTasksModalTitle').textContent = `${staffName} ã®ã‚¿ã‚¹ã‚¯ä¸€è¦§`;
  renderStaffTasksList();
  ModalManager.open(document.getElementById('staffTasksModal'));
}

function closeStaffTasksModal() {
  ModalManager.close(document.getElementById('staffTasksModal'));
  currentStaffForTasks = null;
}

function sortTasksBy(sortType) {
  currentTaskSort = sortType;
  document.getElementById('sortByDueBtn').classList.toggle('btn-primary', sortType === 'due');
  document.getElementById('sortByDueBtn').classList.toggle('btn-ghost', sortType !== 'due');
  document.getElementById('sortByProjectBtn').classList.toggle('btn-primary', sortType === 'project');
  document.getElementById('sortByProjectBtn').classList.toggle('btn-ghost', sortType !== 'project');
  renderStaffTasksList();
}

async function renderStaffTasksList() {
  const container = document.getElementById('staffTasksList');
  if (!container || !currentStaffForTasks) return;

  // æ‹…å½“è€…ã®æ¡ˆä»¶ã‚’å–å¾—
  const staffProjects = projects.filter(p => {
    const assigned = (p.assigned_to || '').trim();
    const icAssigned = (p.ic_assignee || '').trim();
    const exteriorAssigned = (p.exterior_assignee || '').trim();
    return (assigned === currentStaffForTasks || icAssigned === currentStaffForTasks || exteriorAssigned === currentStaffForTasks) &&
           p.status !== 'completed' && !p.is_archived;
  });

  // project_tasksã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
  const { data: tasks } = await supabase
    .from('project_tasks')
    .select('*')
    .in('project_id', staffProjects.map(p => p.id))
    .eq('is_completed', false)
    .order('due_date');

  if (!tasks || tasks.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p></div>';
    return;
  }

  // ã‚½ãƒ¼ãƒˆ
  let sortedTasks = [...tasks];
  if (currentTaskSort === 'due') {
    sortedTasks.sort((a, b) => {
      if (!a.due_date) return 1;
      if (!b.due_date) return -1;
      return new Date(a.due_date) - new Date(b.due_date);
    });
  } else {
    sortedTasks.sort((a, b) => {
      const projectA = staffProjects.find(p => p.id === a.project_id);
      const projectB = staffProjects.find(p => p.id === b.project_id);
      return (projectA?.customer || '').localeCompare(projectB?.customer || '');
    });
  }

  // è¡¨ç¤º
  let html = '';
  const today = new Date().toISOString().split('T')[0];

  if (currentTaskSort === 'project') {
    // é‚¸åã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const grouped = {};
    sortedTasks.forEach(task => {
      const project = staffProjects.find(p => p.id === task.project_id);
      const key = project?.customer || 'ä¸æ˜';
      if (!grouped[key]) grouped[key] = [];
      grouped[key].push(task);
    });

    for (const [customer, customerTasks] of Object.entries(grouped)) {
      html += `<div class="task-list-group"><div class="task-list-group-title">${escapeHtml(customer)}</div>`;
      customerTasks.forEach(task => {
        const isOverdue = task.due_date && task.due_date < today;
        html += `
          <div class="project-task-item">
            <input type="checkbox" class="project-task-checkbox" onchange="toggleProjectTask('${task.id}', '${task.project_id}', this.checked)">
            <span class="project-task-name">${escapeHtml(task.task_name)}</span>
            ${task.due_date ? `<span class="project-task-due ${isOverdue ? 'overdue' : ''}">${escapeHtml(task.due_date)}</span>` : ''}
          </div>
        `;
      });
      html += '</div>';
    }
  } else {
    // æœŸé™é †
    sortedTasks.forEach(task => {
      const project = staffProjects.find(p => p.id === task.project_id);
      const isOverdue = task.due_date && task.due_date < today;
      html += `
        <div class="project-task-item">
          <input type="checkbox" class="project-task-checkbox" onchange="toggleProjectTask('${task.id}', '${task.project_id}', this.checked)">
          <span class="project-task-name">${escapeHtml(task.task_name)}</span>
          <span style="font-size: 12px; color: var(--text-muted);">${escapeHtml(project?.customer || '')}</span>
          ${task.due_date ? `<span class="project-task-due ${isOverdue ? 'overdue' : ''}">${escapeHtml(task.due_date)}</span>` : ''}
        </div>
      `;
    });
  }

  container.innerHTML = html;
}

// æ¡ˆä»¶ã‚¿ã‚¹ã‚¯ä¸€è¦§èª­ã¿è¾¼ã¿
async function loadProjectTasksList(projectId) {
  const container = document.getElementById(`projectTasksList_${projectId}`);
  if (!container) return;

  try {
    const { data: tasks, error } = await supabase
      .from('project_tasks')
      .select('*')
      .eq('project_id', projectId)
      .order('due_date', { ascending: true, nullsFirst: false });

    if (error) {
      logError('Load tasks error:', error);
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      return;
    }

    if (!tasks || tasks.length === 0) {
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    container.innerHTML = tasks.map(t => `
      <div class="task-item" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: ${t.is_completed ? 'var(--success-light)' : 'var(--bg-secondary)'}; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${t.is_completed ? 'var(--success-color)' : 'var(--primary-color)'};">
        <input type="checkbox" ${t.is_completed ? 'checked' : ''} onchange="toggleProjectTask('${t.id}', '${projectId}', this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
        <div style="flex: 1; min-width: 0;">
          <div style="font-size: 13px; font-weight: 500; ${t.is_completed ? 'text-decoration: line-through; color: var(--text-muted);' : ''}">${escapeHtml(t.task_name)}</div>
          ${t.due_date ? `<div style="font-size: 11px; color: ${isOverdue(t.due_date) && !t.is_completed ? 'var(--danger-color)' : 'var(--text-muted)'}; margin-top: 2px;">æœŸé™: ${formatDate(t.due_date)}</div>` : ''}
        </div>
        <button class="btn btn-small btn-ghost" onclick="deleteProjectTask('${t.id}', '${projectId}')" style="flex-shrink: 0; padding: 4px 8px; font-size: 12px; color: var(--danger-color);">å‰Šé™¤</button>
      </div>
    `).join('');
  } catch (error) {
    logError('Load tasks error:', error);
    container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

// æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
function isOverdue(dateStr) {
  if (!dateStr) return false;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const dueDate = new Date(dateStr);
  return dueDate < today;
}

// ã‚¿ã‚¹ã‚¯å®Œäº†çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
async function toggleProjectTask(taskId, projectId, isCompleted) {
  const { error } = await supabase
    .from('project_tasks')
    .update({ is_completed: isCompleted, updated_at: new Date().toISOString() })
    .eq('id', taskId);

  if (error) {
    showToast('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    return;
  }

  // æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰å†…ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’æ›´æ–°
  await loadProjectTasksList(projectId);
  // ã‚¹ã‚¿ãƒƒãƒ•åˆ¥ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚‚æ›´æ–°
  renderStaffTasksList();
}

// ã‚¿ã‚¹ã‚¯å‰Šé™¤
async function deleteProjectTask(taskId, projectId) {
  if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  const { error } = await supabase
    .from('project_tasks')
    .delete()
    .eq('id', taskId);

  if (error) {
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    return;
  }

  showToast('ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
  await loadProjectTasksList(projectId);
}

// æ¡ˆä»¶ã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
async function addProjectTask(projectId, taskName, dueDate) {
  if (!taskName.trim()) {
    showToast('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  const project = projects.find(p => p.id === projectId);

  try {
    const { data, error } = await supabase
      .from('project_tasks')
      .insert({
        project_id: projectId,
        task_name: taskName.trim(),
        due_date: dueDate || null,
        assigned_to: project?.assigned_to || '',
        is_completed: false
      })
      .select();

    if (error) {
      logError('ã‚¿ã‚¹ã‚¯è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
      if (error.code === '42501') {
        showToast('ã‚¿ã‚¹ã‚¯è¿½åŠ ã®æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚', 'error');
      } else if (error.code === '42P01') {
        showToast('ã‚¿ã‚¹ã‚¯ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
      } else {
        showToast(`ã‚¿ã‚¹ã‚¯è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
      }
      return;
    }

    // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
    document.getElementById(`newTaskName_${projectId}`).value = '';
    document.getElementById(`newTaskDue_${projectId}`).value = '';

    showToast('ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    await loadProjectTasksList(projectId);
  } catch (err) {
    logError('ã‚¿ã‚¹ã‚¯è¿½åŠ ä¾‹å¤–:', err);
    showToast('ã‚¿ã‚¹ã‚¯è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
  }
}

// ä¸»è¦ã‚¿ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å‹•çš„ã«å–å¾—ï¼ˆãƒ¬ãƒãƒ¼ãƒˆç”¨ï¼‰
function getMainTaskStatuses(progressData) {
  const statuses = [];
  const mainKeywords = ['å¤ªé™½å…‰', 'çµ¦æ’æ°´', 'æ›æ°—', 'ã‚µãƒƒã‚·', 'æ§‹é€ ', 'ã‚¨ãƒœãƒ«ãƒ„', 'evoltz'];

  tasksV2.forEach(task => {
    if (task.task_name && task.has_state) {
      const isMain = mainKeywords.some(k => task.task_name.includes(k));
      if (isMain && progressData[task.task_key]?.state) {
        // ã‚¿ã‚¹ã‚¯åã‚’çŸ­ç¸®ï¼ˆã€Œä¾é ¼ã€ã‚’é™¤å»ï¼‰
        const shortName = task.task_name.replace(/ä¾é ¼$/, '');
        statuses.push(`${shortName}:${progressData[task.task_key].state}`);
      }
    }
  });

  return statuses;
}

// ç”³è«‹GOæ¡ä»¶ãƒã‚§ãƒƒã‚¯ï¼ˆå‹•çš„ã«ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢ï¼‰
function getApplicationGoRequiredTasks() {
  // ã‚¿ã‚¹ã‚¯åã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§å¿…è¦ãªã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢
  const keywords = ['å¤ªé™½å…‰', 'çµ¦æ’æ°´', 'æ›æ°—', 'ã‚µãƒƒã‚·'];
  const requiredTasks = [];

  keywords.forEach(keyword => {
    const task = tasksV2.find(t => t.task_name && t.task_name.includes(keyword) && t.has_state);
    if (task) {
      // æœ€çµ‚çŠ¶æ…‹ï¼ˆstate_optionsã®æœ€å¾Œã®å€¤ï¼‰ã‚’å–å¾—
      const finalState = Array.isArray(task.state_options) && task.state_options.length > 0
        ? task.state_options[task.state_options.length - 1]
        : 'ä¿å­˜æ¸ˆ';
      requiredTasks.push({
        task_key: task.task_key,
        task_name: task.task_name,
        finalState: finalState
      });
    }
  });

  return requiredTasks;
}

function canPressApplicationGo(project) {
  const progressData = project.progress || {};
  const requiredTasks = getApplicationGoRequiredTasks();

  // å¿…è¦ãªã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æ—§ãƒ­ã‚¸ãƒƒã‚¯ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (requiredTasks.length === 0) {
    log('âš ï¸ ç”³è«‹GO: tasksV2ã‹ã‚‰ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ—§ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨');
    const solarOk = progressData['solar']?.state === 'ä¿å­˜æ¸ˆ';
    const plumbingOk = progressData['plumbing']?.state === 'ä¿å­˜æ¸ˆ';
    const ventilationOk = progressData['ventilation']?.state === 'ä¿å­˜æ¸ˆ';
    const sashOk = progressData['sash']?.state === 'ä¿å­˜æ¸ˆ';
    return solarOk && plumbingOk && ventilationOk && sashOk;
  }

  // å…¨ã¦ã®å¿…è¦ã‚¿ã‚¹ã‚¯ãŒæœ€çµ‚çŠ¶æ…‹ã‹ãƒã‚§ãƒƒã‚¯
  const results = requiredTasks.map(req => {
    const currentState = progressData[req.task_key]?.state || '-';
    const ok = currentState === req.finalState;
    log(`ğŸ“‹ ç”³è«‹GOæ¡ä»¶: ${req.task_name} (${req.task_key}) = "${currentState}" / å¿…è¦: "${req.finalState}" â†’ ${ok ? 'âœ“' : 'âœ—'}`);
    return ok;
  });

  const allOk = results.every(r => r);
  log(`ğŸ“‹ ç”³è«‹GOåˆ¤å®š: ${allOk ? 'æ¡ä»¶OK' : 'æ¡ä»¶æœªé”'}`);
  return allOk;
}

// ç”³è«‹GOç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
let applicationGoProjectId = null;

function confirmApplicationGo(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  applicationGoProjectId = projectId;
  const progressData = project.progress || {};
  const requiredTasks = getApplicationGoRequiredTasks();

  // æ¡ä»¶è¡¨ç¤ºï¼ˆå‹•çš„ã«ç”Ÿæˆï¼‰
  let conditions;
  if (requiredTasks.length > 0) {
    conditions = requiredTasks.map(req => ({
      label: req.task_name,
      ok: progressData[req.task_key]?.state === req.finalState,
      value: progressData[req.task_key]?.state || '-',
      required: req.finalState
    }));
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    conditions = [
      { label: 'å¤ªé™½å…‰ä¾é ¼', ok: progressData['solar']?.state === 'ä¿å­˜æ¸ˆ', value: progressData['solar']?.state || '-', required: 'ä¿å­˜æ¸ˆ' },
      { label: 'çµ¦æ’æ°´å›³ä¾é ¼', ok: progressData['plumbing']?.state === 'ä¿å­˜æ¸ˆ', value: progressData['plumbing']?.state || '-', required: 'ä¿å­˜æ¸ˆ' },
      { label: 'æ›æ°—å›³ä¾é ¼', ok: progressData['ventilation']?.state === 'ä¿å­˜æ¸ˆ', value: progressData['ventilation']?.state || '-', required: 'ä¿å­˜æ¸ˆ' },
      { label: 'ã‚µãƒƒã‚·ä¾é ¼', ok: progressData['sash']?.state === 'ä¿å­˜æ¸ˆ', value: progressData['sash']?.state || '-', required: 'ä¿å­˜æ¸ˆ' }
    ];
  }

  document.getElementById('applicationGoProjectName').textContent = project.customer;
  document.getElementById('applicationGoConditions').innerHTML = conditions.map(c =>
    `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
      <span style="color: ${c.ok ? '#10b981' : '#ef4444'};">${c.ok ? 'âœ“' : 'âœ—'}</span>
      <span>${c.label}:</span>
      <span style="font-weight: 500; color: ${c.ok ? '#10b981' : 'var(--text-secondary)'};">${c.value}</span>
    </div>`
  ).join('');

  ModalManager.open(document.getElementById('applicationGoModal'));
}

function closeApplicationGoModal() {
  ModalManager.close(document.getElementById('applicationGoModal'));
  applicationGoProjectId = null;
}

async function executeApplicationGo() {
  // äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
  if (SaveGuard.isLocked('executeApplicationGo')) return;
  if (!applicationGoProjectId) return;

  const project = projects.find(p => p.id === applicationGoProjectId);
  if (!project) return;

  // æ¡ä»¶ã‚’å†ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«æ¡ä»¶ãŒå¤‰ã‚ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
  if (!canPressApplicationGo(project)) {
    showToast('æ¡ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
    closeApplicationGoModal();
    return;
  }

  await SaveGuard.run('executeApplicationGo', async () => {
    // ç”³è«‹ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã¨ã—ã¦ãƒãƒ¼ã‚¯
    const progressData = project.progress || {};
    if (!progressData['application']) progressData['application'] = {};
    progressData['application'].completed = true;
    progressData['application'].date = new Date().toISOString().split('T')[0];

    showStatus('ä¿å­˜ä¸­...', 'saving');
    const { error } = await supabase
      .from('projects')
      .update({
        is_archived: true,
        progress: progressData,
        updated_at: new Date().toISOString()
      })
      .eq('id', applicationGoProjectId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('å®Œäº†å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    project.is_archived = true;
    project.progress = progressData;
    project.updated_at = new Date().toISOString();

    closeApplicationGoModal();
    renderProjects();
    updateSidebar();
    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast(`${project.customer} ã‚’å®Œäº†æ¸ˆã¿ã«ç§»å‹•ã—ã¾ã—ãŸ`, 'success');
  });
}

// æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
function toggleCardSection(element) {
  const section = element.closest('.card-section');
  section.classList.toggle('collapsed');
}

// ãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
}

function closeSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
}

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—é–¢æ•°ï¼ˆè­°äº‹éŒ²ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
function handleMinutesDragOver(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.add('drag-over');
}

function handleMinutesDragLeave(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');
}

function handleMinutesDrop(event, projectId) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');

  const files = event.dataTransfer.files;
  if (files.length > 0) {
    uploadMinutes(projectId, files[0]);
  }
}

// æ‰“åˆã›æ—¥ä»˜ããƒ‰ãƒ­ãƒƒãƒ—
function handleDropWithDate(event, projectId) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');

  const files = event.dataTransfer.files;
  if (files.length > 0) {
    uploadMinutesWithDate(projectId, files[0]);
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒˆãƒªã‚¬ãƒ¼
function triggerMinutesUpload(projectId) {
  document.getElementById(`minutesUpload_${projectId}`).click();
}

// æ‰“åˆã›æ—¥ãƒ»æ¡ˆä»¶åãƒ»æ‹…å½“è€…ã‚’å«ã‚€è­°äº‹éŒ²ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
async function uploadMinutesWithDate(projectId, file) {
  if (!file) {
    showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }

  const project = projects.find(p => p.id === projectId);
  if (!project) {
    showToast('æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  // æ‰“åˆã›æ—¥ã‚’å–å¾—
  const meetingDateInput = document.getElementById(`meetingDate_${projectId}`);
  const meetingDate = meetingDateInput?.value;

  if (!meetingDate) {
    showToast('æ‰“åˆã›æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBä¸Šé™ï¼‰
  const maxSize = 10 * 1024 * 1024;
  if (file.size > maxSize) {
    showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  // å¯¾å¿œãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
  const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
  if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx|xls|xlsx)$/i)) {
    showToast('PDF, Word, Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™', 'error');
    return;
  }

  // ã‚¿ã‚¤ãƒˆãƒ«è‡ªå‹•ç”Ÿæˆ: æ‰“åˆã›æ—¥_æ¡ˆä»¶å_æ‹…å½“è€…
  const formattedDate = meetingDate.replace(/-/g, '');
  const customerName = project.customer || 'ä¸æ˜';
  const assignee = project.assigned_to || 'æ‹…å½“æœªå®š';
  const ext = file.name.split('.').pop();
  const autoTitle = `${formattedDate}_${customerName}_${assignee}.${ext}`;

  // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆASCIIæ–‡å­—ã®ã¿ã€ã‚¹ãƒšãƒ¼ã‚¹ã¯ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã«ç½®æ›ï¼‰
  const safeFileName = `${Date.now()}_${formattedDate}.${ext}`;

  showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');

  try {
    // Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã¯ASCIIã®ã¿ï¼‰
    const storagePath = `${projectId}/${safeFileName}`;
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('minutes')
      .upload(storagePath, file);

    if (uploadError) {
      logError('Storage upload error:', uploadError);
      if (uploadError.message?.includes('bucket') || uploadError.statusCode === '404') {
        showToast('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚', 'error');
      } else if (uploadError.message?.includes('policy')) {
        showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
      } else {
        showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (uploadError.message || 'Unknown error'), 'error');
      }
      return;
    }

    // URLã‚’å–å¾—
    const { data: urlData } = supabase.storage
      .from('minutes')
      .getPublicUrl(storagePath);

    // DBã«ç™»éŒ²ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã‚’è‡ªå‹•ç”Ÿæˆã—ãŸã‚‚ã®ã«ï¼‰
    const { error: dbError } = await supabase
      .from('project_minutes')
      .insert({
        project_id: projectId,
        file_name: autoTitle,
        file_url: urlData.publicUrl,
        file_size: file.size,
        uploaded_by: currentUser?.email || 'demo@archideck.jp'
      });

    if (dbError) {
      logError('DB insert error:', dbError);
      showToast('è­°äº‹éŒ²ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (dbError.message || 'Unknown error'), 'error');
      return;
    }

    // é€šçŸ¥ã‚’é€ä¿¡
    const notifyEmails = [];
    if (project.assigned_to) {
      const designer = designers.find(d => d.name === project.assigned_to);
      if (designer?.email) notifyEmails.push(designer.email);
    }
    if (project.ic_assignee) {
      const icDesigner = designers.find(d => d.name === project.ic_assignee);
      if (icDesigner?.email) notifyEmails.push(icDesigner.email);
    }
    if (project.exterior_assignee) {
      const extDesigner = designers.find(d => d.name === project.exterior_assignee);
      if (extDesigner?.email) notifyEmails.push(extDesigner.email);
    }

    for (const email of notifyEmails) {
      await supabase.from('notifications').insert({
        user_email: email,
        title: 'æ–°ã—ã„è­°äº‹éŒ²ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ',
        message: `${project.customer}æ§˜ã®è­°äº‹éŒ²ã€Œ${autoTitle}ã€ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ`,
        link: `#projects?id=${projectId}`
      }).catch(() => {});
    }

    // æ‰“åˆã›æ—¥å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
    meetingDateInput.value = '';

    showToast('è­°äº‹éŒ²ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
    await loadMinutesList(projectId);
  } catch (error) {
    logError('Upload error:', error);
    showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

// å…±æœ‰ãƒ¡ãƒ¢ä¿å­˜
async function saveSharedMemo(projectId) {
  const memo = document.getElementById(`sharedMemo_${projectId}`).value;
  const { error } = await supabase
    .from('projects')
    .update({ shared_memo: memo, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showToast('ãƒ¡ãƒ¢ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    return;
  }

  const project = projects.find(p => p.id === projectId);
  if (project) project.shared_memo = memo;
  showToast('ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

// å¼•ç¶™æ›¸ä¿å­˜
async function saveHandover(projectId) {
  const content = document.getElementById(`handover_${projectId}`).value;

  // æ—¢å­˜ã®å¼•ç¶™æ›¸ã‚’ç¢ºèª
  const { data: existing } = await supabase
    .from('project_handovers')
    .select('id')
    .eq('project_id', projectId)
    .single();

  let error;
  if (existing) {
    ({ error } = await supabase
      .from('project_handovers')
      .update({ content, updated_at: new Date().toISOString() })
      .eq('id', existing.id));
  } else {
    ({ error } = await supabase
      .from('project_handovers')
      .insert({ project_id: projectId, content }));
  }

  if (error) {
    showToast('å¼•ç¶™æ›¸ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    return;
  }

  showToast('å¼•ç¶™æ›¸ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

// è­°äº‹éŒ²ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
async function uploadMinutes(projectId, file) {
  if (!file) {
    showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBä¸Šé™ï¼‰
  const maxSize = 10 * 1024 * 1024;
  if (file.size > maxSize) {
    showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  // å¯¾å¿œãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
  const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
  if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx|xls|xlsx)$/i)) {
    showToast('PDF, Word, Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™', 'error');
    return;
  }

  showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');

  try {
    // Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã¯ASCIIã®ã¿ï¼‰
    const ext = file.name.split('.').pop();
    const safeStoragePath = `${projectId}/${Date.now()}.${ext}`;
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('minutes')
      .upload(safeStoragePath, file);

    if (uploadError) {
      logError('Storage upload error:', uploadError);
      // ãƒã‚±ãƒƒãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if (uploadError.message?.includes('bucket') || uploadError.statusCode === '404') {
        showToast('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚', 'error');
      } else if (uploadError.message?.includes('policy')) {
        showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
      } else {
        showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (uploadError.message || 'Unknown error'), 'error');
      }
      return;
    }

    // URLã‚’å–å¾—
    const { data: urlData } = supabase.storage
      .from('minutes')
      .getPublicUrl(safeStoragePath);

    // DBã«ç™»éŒ²
    const { error: dbError } = await supabase
      .from('project_minutes')
      .insert({
        project_id: projectId,
        file_name: file.name,
        file_url: urlData.publicUrl,
        file_size: file.size,
        uploaded_by: currentUser?.email || 'demo@archideck.jp'
      });

    if (dbError) {
      logError('DB insert error:', dbError);
      showToast('è­°äº‹éŒ²ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (dbError.message || 'Unknown error'), 'error');
      return;
    }

    // é€šçŸ¥ã‚’é€ä¿¡
    const project = projects.find(p => p.id === projectId);
    if (project) {
      const notifyEmails = [];
      if (project.assigned_to) {
        const designer = designers.find(d => d.name === project.assigned_to);
        if (designer?.email) notifyEmails.push(designer.email);
      }
      if (project.ic_assignee) {
        const icDesigner = designers.find(d => d.name === project.ic_assignee);
        if (icDesigner?.email) notifyEmails.push(icDesigner.email);
      }
      if (project.exterior_assignee) {
        const extDesigner = designers.find(d => d.name === project.exterior_assignee);
        if (extDesigner?.email) notifyEmails.push(extDesigner.email);
      }

      // é€šçŸ¥ã‚’DBã«ç™»éŒ²ï¼ˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
      for (const email of notifyEmails) {
        await supabase.from('notifications').insert({
          user_email: email,
          title: 'æ–°ã—ã„è­°äº‹éŒ²ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ',
          message: `${project.customer}æ§˜ã®è­°äº‹éŒ²ã€Œ${file.name}ã€ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ`,
          link: `#projects?id=${projectId}`
        }).catch(() => {});
      }
    }

    showToast('è­°äº‹éŒ²ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
    await loadMinutesList(projectId);
  } catch (error) {
    logError('Upload error:', error);
    showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

// è­°äº‹éŒ²ä¸€è¦§èª­ã¿è¾¼ã¿
async function loadMinutesList(projectId) {
  const container = document.getElementById(`minutesList_${projectId}`);
  if (!container) return;

  try {
    const { data: minutes, error } = await supabase
      .from('project_minutes')
      .select('*')
      .eq('project_id', projectId)
      .order('created_at', { ascending: false });

    if (error) {
      logError('Load minutes error:', error);
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">è­°äº‹éŒ²ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      return;
    }

    if (!minutes || minutes.length === 0) {
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸè­°äº‹éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    container.innerHTML = minutes.map(m => `
      <div class="minute-item" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 8px;">
        <div style="flex: 1; min-width: 0;">
          <a href="${m.file_url}" target="_blank" style="color: var(--primary-color); text-decoration: none; font-size: 13px; font-weight: 500; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ğŸ“„ ${escapeHtml(m.file_name)}
          </a>
          <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
            ${formatFileSize(m.file_size)} â€¢ ${formatDate(m.created_at)}
          </div>
        </div>
        <button class="btn btn-small btn-ghost" onclick="deleteMinute('${m.id}', '${projectId}')" style="flex-shrink: 0; padding: 4px 8px; font-size: 12px; color: var(--danger-color);">å‰Šé™¤</button>
      </div>
    `).join('');
  } catch (error) {
    logError('Load minutes error:', error);
    container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">è­°äº‹éŒ²ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

// è­°äº‹éŒ²å‰Šé™¤
async function deleteMinute(minuteId, projectId) {
  if (!confirm('ã“ã®è­°äº‹éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  try {
    const { error } = await supabase
      .from('project_minutes')
      .delete()
      .eq('id', minuteId);

    if (error) throw error;
    showToast('è­°äº‹éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    await loadMinutesList(projectId);
  } catch (error) {
    logError('Delete minute error:', error);
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatFileSize(bytes) {
  if (!bytes) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
}

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

// ============================================
// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
// ============================================
const Validators = {
  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼
  isValidEmail(email) {
    if (!email) return false;
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  },

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ï¼ˆ8æ–‡å­—ä»¥ä¸Šã€è‹±æ•°å­—æ··åœ¨ï¼‰
  isValidPassword(password) {
    if (!password || password.length < 8) return false;
    return /^(?=.*[a-zA-Z])(?=.*\d).{8,}$/.test(password);
  },

  // é›»è©±ç•ªå·æ¤œè¨¼
  isValidPhone(phone) {
    if (!phone) return true; // ä»»æ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    return /^[\d\-\+\(\)\s]{10,}$/.test(phone);
  },

  // æ—¥ä»˜ãŒéå»ã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
  isNotPastDate(dateStr) {
    if (!dateStr) return true;
    const inputDate = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return inputDate >= today;
  },

  // æ—¥ä»˜ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
  isValidDate(dateStr) {
    if (!dateStr) return true;
    const date = new Date(dateStr);
    return !isNaN(date.getTime());
  },

  // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
  isRequired(value) {
    if (value === null || value === undefined) return false;
    if (typeof value === 'string') return value.trim().length > 0;
    return true;
  },

  // æ–‡å­—æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯
  maxLength(value, max) {
    if (!value) return true;
    return String(value).length <= max;
  },

  // æ•°å€¤ç¯„å›²ãƒã‚§ãƒƒã‚¯
  inRange(value, min, max) {
    const num = Number(value);
    if (isNaN(num)) return false;
    return num >= min && num <= max;
  }
};

// ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ
function validateForm(rules) {
  const errors = [];
  for (const [fieldName, validations] of Object.entries(rules)) {
    for (const { validate, message, value } of validations) {
      if (!validate(value)) {
        errors.push({ field: fieldName, message });
      }
    }
  }
  return errors;
}

// ============================================
// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
// ============================================
const ErrorHandler = {
  // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
  messages: {
    'Invalid login credentials': 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“',
    'Email not confirmed': 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“',
    'User already registered': 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™',
    'Password should be at least': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„',
    'Network error': 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„',
    'timeout': 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„',
    'duplicate key': 'ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™',
    'foreign key constraint': 'é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“',
    'permission denied': 'ã“ã®æ“ä½œã‚’è¡Œã†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“',
  },

  // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›
  getUserMessage(error) {
    if (!error) return 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

    const errorMsg = error.message || String(error);

    // ãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰æ¤œç´¢
    for (const [key, userMsg] of Object.entries(this.messages)) {
      if (errorMsg.toLowerCase().includes(key.toLowerCase())) {
        return userMsg;
      }
    }

    // Supabaseã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰å¯¾å¿œ
    if (error.code === 'PGRST116') return 'ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
    if (error.code === '23505') return 'ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™';
    if (error.code === '23503') return 'é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“';
    if (error.code === '42501') return 'ã“ã®æ“ä½œã‚’è¡Œã†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„';
  },

  // ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°ï¼†é€šçŸ¥
  handle(error, context = '') {
    logError(`âŒ ã‚¨ãƒ©ãƒ¼ [${context}]:`, error);

    const userMessage = this.getUserMessage(error);
    showToast(userMessage, 'error');

    // æœ¬ç•ªç’°å¢ƒã§ã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’é€ä¿¡ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
    // this.sendErrorLog(error, context);
  }
};

// ============================================
// åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½
// ============================================

function getProgressBadgeClass(progress) {
  if (progress >= 70) return 'high';
  if (progress >= 40) return 'medium';
  return 'low';
}

function generateWeeklyReport() {
  const today = new Date();
  const weekAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);

  const activeProjects = projects.filter(p => !p.is_archived);
  const completedThisWeek = projects.filter(p => {
    if (!p.is_archived) return false;
    const updated = new Date(p.updated_at);
    return updated >= weekAgo;
  });

  // ä»Šé€±æ›´æ–°ã•ã‚ŒãŸæ¡ˆä»¶
  const updatedThisWeek = projects.filter(p => {
    const updated = new Date(p.updated_at);
    return updated >= weekAgo;
  });

  // æ‹…å½“è€…åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const designerProjects = {};
  designers.filter(d => d.category === 'è¨­è¨ˆ').forEach(d => {
    designerProjects[d.name] = activeProjects.filter(p => p.assigned_to === d.name);
  });

  // æ‹…å½“è€…åˆ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
  const designerSections = Object.entries(designerProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => {
      const projectDetails = projs.map(p => {
        const progress = calculateProgress(p);
        const progressData = p.progress || {};

        // ä¸»è¦ã‚¿ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ï¼ˆå‹•çš„ï¼‰
        const statuses = getMainTaskStatuses(progressData);
        const statusText = statuses.length > 0 ? statuses.join(' / ') : 'æœªç€æ‰‹';
        const wasUpdated = new Date(p.updated_at) >= weekAgo;

        return `<div class="report-project-detail ${wasUpdated ? 'updated' : ''}">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 600;">${escapeHtml(p.customer)}</span>
            <span class="report-progress-badge ${getProgressBadgeClass(progress)}">${progress}%</span>
          </div>
          <div style="font-size: 12px; color: var(--text-secondary);">${statusText}</div>
          ${wasUpdated ? '<div style="font-size: 11px; color: var(--primary-color); margin-top: 4px;">ğŸ“ ä»Šé€±æ›´æ–°</div>' : ''}
        </div>`;
      }).join('');

      return `<div class="report-designer-section">
        <div class="report-designer-header">
          <span class="report-designer-name">${escapeHtml(name)}</span>
          <span class="report-designer-count">${projs.length}ä»¶</span>
        </div>
        ${projectDetails}
      </div>`;
    }).join('');

  const report = `
    <div class="report-card">
      <div class="report-header">
        <h2>é€±å ±</h2>
        <span class="report-period">${weekAgo.toLocaleDateString('ja-JP')} ã€œ ${today.toLocaleDateString('ja-JP')}</span>
      </div>
      <div class="report-stats-grid">
        <div class="report-stat-item">
          <div class="report-stat-value">${activeProjects.length}</div>
          <div class="report-stat-label">é€²è¡Œä¸­</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${updatedThisWeek.length}</div>
          <div class="report-stat-label">ä»Šé€±æ›´æ–°</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${completedThisWeek.length}</div>
          <div class="report-stat-label">ä»Šé€±å®Œäº†</div>
        </div>
      </div>
      <div class="report-section">
        <div class="report-section-title">æ‹…å½“è€…åˆ¥ æ¡ˆä»¶çŠ¶æ³</div>
        ${designerSections || '<div class="report-empty">é€²è¡Œä¸­ã®æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</div>'}
      </div>
      ${completedThisWeek.length > 0 ? `
      <div class="report-section">
        <div class="report-section-title">ä»Šé€±ã®å®Œäº†æ¡ˆä»¶</div>
        <ul class="report-list">
          ${completedThisWeek.map(p => `<li class="report-list-item">
            <span class="report-project-name">${escapeHtml(p.customer)}</span>
            <span class="report-assignee">${escapeHtml(p.assigned_to || 'æœªå‰²å½“')}</span>
          </li>`).join('')}
        </ul>
      </div>` : ''}
    </div>
  `;

  const preview = document.getElementById('reportPreview');
  preview.style.display = 'block';
  preview.innerHTML = report;
  showToast('é€±å ±ã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
}

function generateMonthlyReport() {
  const today = new Date();
  const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

  const activeProjects = projects.filter(p => !p.is_archived);
  const completedThisMonth = projects.filter(p => {
    if (!p.is_archived) return false;
    const updated = new Date(p.updated_at);
    return updated >= monthAgo;
  });

  // ä»Šæœˆæ›´æ–°ã•ã‚ŒãŸæ¡ˆä»¶
  const updatedThisMonth = projects.filter(p => {
    const updated = new Date(p.updated_at);
    return updated >= monthAgo;
  });

  const completionRate = projects.length > 0 ? Math.round(completedThisMonth.length / projects.length * 100) : 0;

  // æ‹…å½“è€…åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const designerProjects = {};
  designers.filter(d => d.category === 'è¨­è¨ˆ').forEach(d => {
    designerProjects[d.name] = activeProjects.filter(p => p.assigned_to === d.name);
  });

  // æ‹…å½“è€…ã”ã¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”Ÿæˆ
  const designerSections = Object.entries(designerProjects)
    .filter(([name, projs]) => projs.length > 0)
    .map(([name, projs]) => {
      const projectDetails = projs.map(p => {
        const progressData = p.progress || {};
        const updatedAt = new Date(p.updated_at);
        const isUpdated = updatedAt >= monthAgo;

        // ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åé›†ï¼ˆå‹•çš„ï¼‰
        const statuses = getMainTaskStatuses(progressData);

        const statusTags = statuses.map(s =>
          `<span class="report-status-tag active">${s}</span>`
        ).join('');

        return `<div class="report-project-detail ${isUpdated ? 'updated' : ''}">
          <div class="report-project-title">
            <span class="project-name">${escapeHtml(p.customer)}</span>
            ${isUpdated ? '<span class="report-updated-badge">ä»Šæœˆæ›´æ–°</span>' : ''}
          </div>
          ${statusTags ? `<div class="report-status-list">${statusTags}</div>` : '<div class="report-status-list"><span class="report-status-tag">æœªç€æ‰‹</span></div>'}
        </div>`;
      }).join('');

      return `<div class="report-designer-section">
        <div class="report-designer-header">
          <span class="report-designer-name">${escapeHtml(name)}</span>
          <span class="report-designer-count">${projs.length}ä»¶</span>
        </div>
        ${projectDetails}
      </div>`;
    }).join('');

  const report = `
    <div class="report-card">
      <div class="report-header">
        <h2>æœˆå ±</h2>
        <span class="report-period">${monthAgo.toLocaleDateString('ja-JP')} ã€œ ${today.toLocaleDateString('ja-JP')}</span>
      </div>
      <div class="report-stats-grid">
        <div class="report-stat-item">
          <div class="report-stat-value">${projects.length}</div>
          <div class="report-stat-label">ç·æ¡ˆä»¶æ•°</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${activeProjects.length}</div>
          <div class="report-stat-label">é€²è¡Œä¸­</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${updatedThisMonth.length}</div>
          <div class="report-stat-label">ä»Šæœˆæ›´æ–°</div>
        </div>
        <div class="report-stat-item">
          <div class="report-stat-value">${completedThisMonth.length}</div>
          <div class="report-stat-label">ä»Šæœˆå®Œäº†</div>
        </div>
      </div>
      <div class="report-section">
        <div class="report-section-title">æ‹…å½“è€…åˆ¥ æ¡ˆä»¶çŠ¶æ³</div>
        ${designerSections || '<div class="report-empty">é€²è¡Œä¸­ã®æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</div>'}
      </div>
      ${completedThisMonth.length > 0 ? `
      <div class="report-section">
        <div class="report-section-title">ä»Šæœˆã®å®Œäº†æ¡ˆä»¶</div>
        <ul class="report-list">
          ${completedThisMonth.map(p => `<li class="report-list-item">
            <span class="report-project-name">${escapeHtml(p.customer)}</span>
            <span class="report-assignee">${escapeHtml(p.assigned_to || 'æœªå‰²å½“')}</span>
          </li>`).join('')}
        </ul>
      </div>` : ''}
    </div>
  `;

  const preview = document.getElementById('reportPreview');
  preview.style.display = 'block';
  preview.innerHTML = report;
  showToast('æœˆå ±ã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
}

function exportAnalyticsCSV() {
  const headers = ['æ¡ˆä»¶å', 'æ‹…å½“è€…', 'å•†å“', 'é€²æ—ç‡', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'ä½œæˆæ—¥'];
  const rows = projects.map(p => [
    p.customer,
    p.assigned_to || '',
    p.specifications || '',
    calculateProgress(p) + '%',
    p.is_archived ? 'å®Œäº†' : 'é€²è¡Œä¸­',
    p.created_at ? new Date(p.created_at).toLocaleDateString('ja-JP') : ''
  ]);

  const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
  const bom = '\uFEFF';
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `archideck_analytics_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
}

// ============================================
// ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ„ã‚¢ãƒ¼ï¼ˆåˆã‚ã¦ã®æ–¹ã¸ï¼‰
// ============================================
const AppTour = {
  currentStep: 0,
  overlay: null,
  tooltip: null,
  previousHighlight: null,

  steps: [
    {
      target: '.sidebar',
      title: 'ã‚µã‚¤ãƒ‰ãƒãƒ¼',
      content: 'è¨­è¨ˆãƒ»ICãƒ»å¤–æ§‹ã®æ‹…å½“è€…åˆ¥ã«ã‚¿ãƒ–ãŒåˆ†ã‹ã‚Œã¦ã„ã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã§æ‹…å½“è€…ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚',
      position: 'right'
    },
    {
      target: '.project-card',
      title: 'æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰',
      content: 'å„æ¡ˆä»¶ã®æƒ…å ±ãŒã‚«ãƒ¼ãƒ‰å½¢å¼ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’é–‹ãã€é€²æ—ã‚’æ›´æ–°ã§ãã¾ã™ã€‚',
      position: 'bottom'
    },
    {
      target: '[onclick*="openProjectModal()"]',
      title: 'æ–°è¦æ¡ˆä»¶ã®è¿½åŠ ',
      content: 'ã“ã®ãƒœã‚¿ãƒ³ã‹ã‚‰æ–°ã—ã„æ¡ˆä»¶ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚ãŠå®¢æ§˜åãƒ»æ‹…å½“è€…ãƒ»å•†å“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
      position: 'bottom'
    },
    {
      target: '.search-container',
      title: 'æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼',
      content: 'ãŠå®¢æ§˜åã§æ¤œç´¢ã—ãŸã‚Šã€æ‹…å½“è€…ãƒ»å•†å“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ãã¾ã™ã€‚',
      position: 'bottom'
    },
    {
      target: '[onclick*="showSettingsTab"]',
      title: 'è¨­å®šç”»é¢',
      content: 'ã‚¹ã‚¿ãƒƒãƒ•ãƒ»æ¥­è€…ãƒ»ã‚¿ã‚¹ã‚¯ã®ç®¡ç†ã€ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã©ã¯ã“ã¡ã‚‰ã‹ã‚‰ã€‚',
      position: 'left'
    }
  ],

  // ãƒ„ã‚¢ãƒ¼é–‹å§‹ç¢ºèª
  showWelcome() {
    if (this.overlay) return;

    this.overlay = document.createElement('div');
    this.overlay.className = 'tour-overlay';
    document.body.appendChild(this.overlay);

    const welcome = document.createElement('div');
    welcome.className = 'tour-welcome';
    welcome.innerHTML = `
      <div class="tour-welcome-icon">ğŸ‘‹</div>
      <h2>ArchiDeckã¸ã‚ˆã†ã“ãï¼</h2>
      <p>è¨­è¨ˆäº‹å‹™æ‰€ã®æ¡ˆä»¶ç®¡ç†ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚<br>
      1åˆ†é–“ã®ã‹ã‚“ãŸã‚“ãƒ„ã‚¢ãƒ¼ã§åŸºæœ¬æ“ä½œã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚</p>
      <div class="tour-welcome-actions">
        <button class="tour-btn tour-btn-skip" onclick="AppTour.end()">ã‚¹ã‚­ãƒƒãƒ—</button>
        <button class="tour-btn tour-btn-next" onclick="AppTour.start()">ãƒ„ã‚¢ãƒ¼ã‚’é–‹å§‹</button>
      </div>
    `;
    document.body.appendChild(welcome);
    this.tooltip = welcome;
  },

  // ãƒ„ã‚¢ãƒ¼é–‹å§‹
  start() {
    if (this.tooltip) {
      this.tooltip.remove();
      this.tooltip = null;
    }
    this.currentStep = 0;
    this.showStep();
  },

  // ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º
  showStep() {
    const step = this.steps[this.currentStep];
    if (!step) {
      this.end();
      return;
    }

    // å‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
    if (this.previousHighlight) {
      this.previousHighlight.classList.remove('tour-highlight');
    }

    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¦ç´ ã‚’å–å¾—
    let target = document.querySelector(step.target);

    // æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    if (!target) {
      if (this.currentStep < this.steps.length - 1) {
        this.currentStep++;
        this.showStep();
        return;
      } else {
        this.end();
        return;
      }
    }

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    target.classList.add('tour-highlight');
    this.previousHighlight = target;

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¡¨ç¤º
    target.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // æ—¢å­˜ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’å‰Šé™¤
    if (this.tooltip) {
      this.tooltip.remove();
    }

    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ä½œæˆ
    setTimeout(() => {
      this.createTooltip(step, target);
    }, 300);
  },

  createTooltip(step, target) {
    const rect = target.getBoundingClientRect();
    const tooltip = document.createElement('div');
    tooltip.className = 'tour-tooltip';

    // ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
    const dots = this.steps.map((_, i) => {
      let className = 'tour-step-dot';
      if (i < this.currentStep) className += ' completed';
      else if (i === this.currentStep) className += ' active';
      return `<div class="${className}"></div>`;
    }).join('');

    tooltip.innerHTML = `
      <div class="tour-step-indicator">${dots}</div>
      <div class="tour-title">${step.title}</div>
      <div class="tour-content">${step.content}</div>
      <div class="tour-actions">
        <button class="tour-btn tour-btn-skip" onclick="AppTour.end()">ã‚¹ã‚­ãƒƒãƒ—</button>
        <div>
          ${this.currentStep > 0 ? '<button class="tour-btn tour-btn-prev" onclick="AppTour.prev()">æˆ»ã‚‹</button>' : ''}
          <button class="tour-btn tour-btn-next" onclick="AppTour.next()">
            ${this.currentStep === this.steps.length - 1 ? 'å®Œäº†' : 'æ¬¡ã¸'}
          </button>
        </div>
      </div>
    `;

    // ä½ç½®æ±ºå®š
    let top, left;
    const padding = 16;

    switch (step.position) {
      case 'right':
        top = rect.top + window.scrollY;
        left = rect.right + padding;
        tooltip.classList.add('arrow-left');
        break;
      case 'left':
        top = rect.top + window.scrollY;
        left = rect.left - 360 - padding;
        tooltip.classList.add('arrow-right');
        break;
      case 'bottom':
        top = rect.bottom + window.scrollY + padding;
        left = rect.left;
        tooltip.classList.add('arrow-top');
        break;
      case 'top':
        top = rect.top + window.scrollY - 200;
        left = rect.left;
        tooltip.classList.add('arrow-bottom');
        break;
    }

    // ç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†èª¿æ•´
    if (left < 16) left = 16;
    if (left + 360 > window.innerWidth) left = window.innerWidth - 376;
    if (top < 16) top = 16;

    tooltip.style.top = `${top}px`;
    tooltip.style.left = `${left}px`;

    document.body.appendChild(tooltip);
    this.tooltip = tooltip;
  },

  next() {
    if (this.currentStep < this.steps.length - 1) {
      this.currentStep++;
      this.showStep();
    } else {
      this.end();
    }
  },

  prev() {
    if (this.currentStep > 0) {
      this.currentStep--;
      this.showStep();
    }
  },

  end() {
    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    if (this.overlay) {
      this.overlay.remove();
      this.overlay = null;
    }
    if (this.tooltip) {
      this.tooltip.remove();
      this.tooltip = null;
    }
    if (this.previousHighlight) {
      this.previousHighlight.classList.remove('tour-highlight');
      this.previousHighlight = null;
    }

    // å®Œäº†ãƒ•ãƒ©ã‚°ä¿å­˜
    localStorage.setItem('archideck_tour_completed', 'true');

    if (this.currentStep >= this.steps.length - 1) {
      showToast('ãƒ„ã‚¢ãƒ¼å®Œäº†ï¼ã”ä¸æ˜ç‚¹ã¯ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ã‹ã‚‰ã„ã¤ã§ã‚‚ç¢ºèªã§ãã¾ã™', 'success');
    }

    this.currentStep = 0;
  },

  // åˆå›ãƒã‚§ãƒƒã‚¯
  checkFirstVisit() {
    const completed = localStorage.getItem('archideck_tour_completed');
    if (!completed) {
      // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¦ã‚§ãƒ«ã‚«ãƒ è¡¨ç¤º
      setTimeout(() => {
        this.showWelcome();
      }, 1500);
    }
  }
};

// ============================================
// éŸ³å£°å…¥åŠ›æ©Ÿèƒ½
// ============================================
let recognition = null;

function initVoiceInput() {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;
    recognition.interimResults = false;
  }
}

function startVoiceInput(targetInputId) {
  if (!recognition) {
    showToast('éŸ³å£°å…¥åŠ›ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
    return;
  }

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    const input = document.getElementById(targetInputId);
    if (input) {
      input.value = transcript;
      showToast('éŸ³å£°å…¥åŠ›å®Œäº†', 'success');
    }
  };

  recognition.onerror = (event) => {
    showToast('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ' + event.error, 'error');
  };

  recognition.start();
  showToast('è©±ã—ã¦ãã ã•ã„...', 'info');
}

// åˆæœŸåŒ–æ™‚ã«éŸ³å£°å…¥åŠ›ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
document.addEventListener('DOMContentLoaded', initVoiceInput);

// ============================================
// FCï¼ˆãƒ•ãƒ©ãƒ³ãƒãƒ£ã‚¤ã‚ºï¼‰ç®¡ç†
// ============================================
let fcOrganizations = [];

async function loadFcOrganizations() {
  try {
    const { data, error } = await supabase
      .from('fc_organizations')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      if (error.code === '42P01') {
        warn('fc_organizationsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚SQLã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      throw error;
    }

    fcOrganizations = data || [];
    renderFcList();
  } catch (e) {
    warn('FCçµ„ç¹”èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
  }
}

function renderFcList() {
  const container = document.getElementById('fcListContainer');
  if (!container) return;

  if (fcOrganizations.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸª</div>
        <p>FCãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br><small>ã€Œ+ FCè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„</small></p>
      </div>
    `;
    return;
  }

  const baseUrl = window.location.origin;

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>FCå</th>
            <th>ã‚¹ãƒ©ãƒƒã‚°</th>
            <th>å°‚ç”¨URL</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th>ä½œæˆæ—¥</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          ${fcOrganizations.map(fc => `
            <tr>
              <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="display: inline-block; width: 16px; height: 16px; border-radius: 4px; background: ${escapeHtml(fc.primary_color || '#2563EB')};"></span>
                  <strong>${escapeHtml(fc.name)}</strong>
                </div>
              </td>
              <td><code style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px;">${escapeHtml(fc.slug)}</code></td>
              <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <a href="${baseUrl}/fc/${escapeHtml(fc.slug)}/" target="_blank" style="font-size: 13px; color: var(--primary-color);">
                    /fc/${escapeHtml(fc.slug)}/
                  </a>
                  <button class="btn btn-ghost btn-small" onclick="copyFcUrl('${escapeHtml(fc.slug)}')" title="URLã‚’ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
                </div>
              </td>
              <td>
                ${fc.is_active
                  ? '<span class="badge badge-success">æœ‰åŠ¹</span>'
                  : '<span class="badge badge-secondary">ç„¡åŠ¹</span>'}
              </td>
              <td style="font-size: 13px; color: var(--text-secondary);">${new Date(fc.created_at).toLocaleDateString('ja-JP')}</td>
              <td>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-ghost btn-small" onclick="editFc('${fc.id}')">ç·¨é›†</button>
                  <button class="btn btn-danger btn-small" onclick="deleteFc('${fc.id}')">å‰Šé™¤</button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function copyFcUrl(slug) {
  const baseUrl = window.location.origin;
  const url = `${baseUrl}/fc/${slug}/`;
  navigator.clipboard.writeText(url).then(() => {
    showToast('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
  }).catch(() => {
    showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  });
}

function openFcModal(fcId = null) {
  const modal = document.getElementById('fcModal');
  const title = document.getElementById('fcModalTitle');

  document.getElementById('fcForm').reset();
  document.getElementById('fcId').value = '';
  document.getElementById('fcColor').value = '#2563EB';
  document.getElementById('fcColorText').value = '#2563EB';
  document.getElementById('fcIsActive').checked = true;

  if (fcId) {
    const fc = fcOrganizations.find(f => f.id === fcId);
    if (!fc) return;

    title.textContent = 'FCç·¨é›†';
    document.getElementById('fcId').value = fc.id;
    document.getElementById('fcName').value = fc.name;
    document.getElementById('fcSlug').value = fc.slug;
    document.getElementById('fcEmail').value = fc.contact_email || '';
    document.getElementById('fcTel').value = fc.contact_tel || '';
    document.getElementById('fcColor').value = fc.primary_color || '#2563EB';
    document.getElementById('fcColorText').value = fc.primary_color || '#2563EB';
    document.getElementById('fcLogoUrl').value = fc.logo_url || '';
    document.getElementById('fcIsActive').checked = fc.is_active !== false;
  } else {
    title.textContent = 'FCè¿½åŠ ';
  }

  ModalManager.open(modal, '#fcName');
}

function closeFcModal() {
  ModalManager.close(document.getElementById('fcModal'));
}

async function saveFc() {
  // äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
  if (SaveGuard.isLocked('saveFc')) return;

  const id = document.getElementById('fcId').value;
  const name = document.getElementById('fcName').value.trim();
  const slug = document.getElementById('fcSlug').value.trim().toLowerCase();
  const contactEmail = document.getElementById('fcEmail').value.trim();
  const contactTel = document.getElementById('fcTel').value.trim();
  const primaryColor = document.getElementById('fcColor').value;
  const logoUrl = document.getElementById('fcLogoUrl').value.trim();
  const isActive = document.getElementById('fcIsActive').checked;

  if (!name || !slug) {
    showToast('FCåã¨ã‚¹ãƒ©ãƒƒã‚°ã¯å¿…é ˆã§ã™', 'error');
    return;
  }

  // ã‚¹ãƒ©ãƒƒã‚°ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
  if (!/^[a-z0-9-]+$/.test(slug)) {
    showToast('ã‚¹ãƒ©ãƒƒã‚°ã¯åŠè§’è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™', 'error');
    return;
  }

  await SaveGuard.run('saveFc', async () => {
    showStatus('ä¿å­˜ä¸­...', 'saving');

    const fcData = {
      name,
      slug,
      contact_email: contactEmail || null,
      contact_tel: contactTel || null,
      primary_color: primaryColor,
      logo_url: logoUrl || null,
      is_active: isActive,
      updated_at: new Date().toISOString()
    };

    let result;
    if (id) {
      result = await supabase
        .from('fc_organizations')
        .update(fcData)
        .eq('id', id)
        .select();
    } else {
      result = await supabase
        .from('fc_organizations')
        .insert([fcData])
        .select();
    }

    if (result.error) {
      if (result.error.code === '23505') {
        showToast('ã“ã®ã‚¹ãƒ©ãƒƒã‚°ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™', 'error');
      } else {
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error.message, 'error');
      }
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      return;
    }

    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast(id ? 'FCã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'FCã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    closeFcModal();
    await loadFcOrganizations();
  });
}

function editFc(fcId) {
  openFcModal(fcId);
}

async function deleteFc(fcId) {
  const fc = fcOrganizations.find(f => f.id === fcId);
  if (!fc) return;

  if (!confirm(`FCã€Œ${fc.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nå‰Šé™¤ã™ã‚‹ã¨ã€FCå°‚ç”¨URLã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚`)) {
    return;
  }

  await SaveGuard.run(`deleteFc_${fcId}`, async () => {
    showStatus('å‰Šé™¤ä¸­...', 'saving');

    const { error } = await supabase
      .from('fc_organizations')
      .delete()
      .eq('id', fcId);

    if (error) {
      showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
      showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      return;
    }

    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast('FCã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    await loadFcOrganizations();
  });
}

// ============================================
// ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ©Ÿèƒ½ï¼ˆFCå‘ã‘ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰
// ============================================
function loadCustomization() {
  if (!currentOrganization) return;

  document.getElementById('customOrgName').value = currentOrganization.name || '';
  document.getElementById('customLogoUrl').value = currentOrganization.logo_url || '';
  document.getElementById('customPrimaryColor').value = currentOrganization.primary_color || '#2563EB';
  document.getElementById('customPrimaryColorText').value = currentOrganization.primary_color || '#2563EB';
  document.getElementById('customSecondaryColor').value = currentOrganization.secondary_color || '#059669';
  document.getElementById('customSecondaryColorText').value = currentOrganization.secondary_color || '#059669';

  updatePreview();
}

function previewCustomization() {
  const primaryColor = document.getElementById('customPrimaryColor').value;
  const secondaryColor = document.getElementById('customSecondaryColor').value;
  const name = document.getElementById('customOrgName').value;
  const logoUrl = document.getElementById('customLogoUrl').value;

  // CSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°
  document.documentElement.style.setProperty('--primary-color', primaryColor);
  document.documentElement.style.setProperty('--secondary-color', secondaryColor);

  // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
  if (name) {
    document.title = `ArchiDeck | ${name}`;
  }

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é ˜åŸŸã‚’æ›´æ–°
  updatePreview();
  showToast('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é©ç”¨ã—ã¾ã—ãŸ', 'success');
}

function updatePreview() {
  const primaryColor = document.getElementById('customPrimaryColor')?.value || '#2563EB';
  const secondaryColor = document.getElementById('customSecondaryColor')?.value || '#1E40AF';
  const name = document.getElementById('customOrgName')?.value || '';
  const logoUrl = document.getElementById('customLogoUrl')?.value || '';

  const previewLogo = document.getElementById('previewLogo');
  const previewTitle = document.getElementById('previewTitle');

  // null ãƒã‚§ãƒƒã‚¯
  if (!previewLogo || !previewTitle) return;

  // ã‚«ãƒ©ãƒ¼å€¤ã®æ¤œè¨¼ï¼ˆ#RRGGBBå½¢å¼ã®ã¿è¨±å¯ï¼‰
  const isValidColor = (color) => /^#[0-9A-Fa-f]{6}$/.test(color);
  const safePrimary = isValidColor(primaryColor) ? primaryColor : '#2563EB';
  const safeSecondary = isValidColor(secondaryColor) ? secondaryColor : '#1E40AF';

  if (logoUrl) {
    // XSSå¯¾ç­–: URLã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã€httpã¾ãŸã¯httpsã®ã¿è¨±å¯
    const isValidUrl = /^https?:\/\//i.test(logoUrl);
    if (isValidUrl) {
      const img = document.createElement('img');
      img.src = logoUrl;
      img.style.cssText = 'max-width: 32px; max-height: 32px; object-fit: contain;';
      img.onerror = () => { previewLogo.innerHTML = 'ğŸ '; };
      previewLogo.innerHTML = '';
      previewLogo.appendChild(img);
    } else {
      previewLogo.innerHTML = 'ğŸ ';
    }
  } else {
    previewLogo.innerHTML = 'ğŸ ';
    previewLogo.style.background = `linear-gradient(135deg, ${safePrimary}, ${safeSecondary})`;
  }

  previewTitle.textContent = name || 'ArchiDeck';
}

async function saveCustomization() {
  if (!currentOrganization) {
    showToast('çµ„ç¹”æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }

  const statusEl = document.getElementById('customizeStatus');
  statusEl.innerHTML = '<span style="color: var(--text-muted);">ä¿å­˜ä¸­...</span>';

  const updates = {
    name: document.getElementById('customOrgName').value,
    logo_url: document.getElementById('customLogoUrl').value,
    primary_color: document.getElementById('customPrimaryColor').value,
    secondary_color: document.getElementById('customSecondaryColor').value,
    updated_at: new Date().toISOString()
  };

  const { error } = await supabase
    .from('organizations')
    .update(updates)
    .eq('id', currentOrganization.id);

  if (error) {
    statusEl.innerHTML = `<span style="color: var(--danger-color);">ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ</span>`;
    logError('ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    return;
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ã®çµ„ç¹”æƒ…å ±ã‚’æ›´æ–°
  Object.assign(currentOrganization, updates);

  // ç”»é¢ã«é©ç”¨
  applyWhiteLabel(currentOrganization);

  statusEl.innerHTML = '<span style="color: var(--success-color);">ä¿å­˜ã—ã¾ã—ãŸ</span>';
  showToast('ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');

  setTimeout(() => {
    statusEl.innerHTML = '';
  }, 3000);
}

function resetCustomization() {
  document.getElementById('customOrgName').value = '';
  document.getElementById('customLogoUrl').value = '';
  document.getElementById('customPrimaryColor').value = '#2563EB';
  document.getElementById('customPrimaryColorText').value = '#2563EB';
  document.getElementById('customSecondaryColor').value = '#059669';
  document.getElementById('customSecondaryColorText').value = '#059669';

  // CSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ
  document.documentElement.style.setProperty('--primary-color', '#2563EB');
  document.documentElement.style.setProperty('--secondary-color', '#059669');
  document.title = 'ArchiDeck | Gãƒã‚¦ã‚¹ è¨­è¨ˆæ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ';

  updatePreview();
  showToast('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
}

// ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®åŒæœŸ
document.addEventListener('DOMContentLoaded', function() {
  const primaryColorPicker = document.getElementById('customPrimaryColor');
  const primaryColorText = document.getElementById('customPrimaryColorText');
  const secondaryColorPicker = document.getElementById('customSecondaryColor');
  const secondaryColorText = document.getElementById('customSecondaryColorText');

  if (primaryColorPicker && primaryColorText) {
    primaryColorPicker.addEventListener('input', function() {
      primaryColorText.value = this.value;
      updatePreview();
    });
  }

  if (secondaryColorPicker && secondaryColorText) {
    secondaryColorPicker.addEventListener('input', function() {
      secondaryColorText.value = this.value;
      updatePreview();
    });
  }
});

// ============================================
// è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
// ============================================
let autoBackupEnabled = localStorage.getItem('autoBackupEnabled') !== 'false';

function toggleAutoBackup() {
  const toggle = document.getElementById('autoBackupToggle');
  autoBackupEnabled = toggle.checked;
  localStorage.setItem('autoBackupEnabled', autoBackupEnabled);
  showToast(autoBackupEnabled ? 'è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ' : 'è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ', 'info');
}

function saveAutoBackup() {
  if (!autoBackupEnabled) return;

  try {
    const backup = {
      version: '4.3',
      created_at: new Date().toISOString(),
      data: {
        projects: projects,
        designers: designers,
        tasksV2: tasksV2,
        vendors: vendors,
        emailTemplates: emailTemplates,
        products: products,
        vendorCategories: vendorCategories,
        taskVendorMappings: taskVendorMappings
      }
    };

    const json = JSON.stringify(backup);

    // ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ (5MBåˆ¶é™)
    if (json.length > 5 * 1024 * 1024) {
      warn('âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚');
      return;
    }

    localStorage.setItem('archideck_auto_backup', json);
    localStorage.setItem('archideck_last_backup', new Date().toISOString());

    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´ã‚’ä¿æŒï¼ˆæœ€å¤§3ä»¶ï¼‰
    const history = safeJsonParse(localStorage.getItem('archideck_backup_history'), []);
    history.unshift({
      timestamp: new Date().toISOString(),
      projectCount: projects.length,
      designerCount: designers.length
    });
    if (history.length > 3) history.pop();
    localStorage.setItem('archideck_backup_history', JSON.stringify(history));

    updateBackupUI();
    log('âœ… è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†:', new Date().toLocaleString());
  } catch (e) {
    warn('è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', e);
  }
}

function updateBackupUI() {
  const lastBackupEl = document.getElementById('lastBackupTime');
  const countEl = document.getElementById('localBackupCount');
  const toggleEl = document.getElementById('autoBackupToggle');

  if (lastBackupEl) {
    const lastBackup = localStorage.getItem('archideck_last_backup');
    lastBackupEl.textContent = lastBackup ? new Date(lastBackup).toLocaleString('ja-JP') : '-';
  }

  if (countEl) {
    const history = safeJsonParse(localStorage.getItem('archideck_backup_history'), []);
    countEl.textContent = history.length.toString();
  }

  if (toggleEl) {
    toggleEl.checked = autoBackupEnabled;
  }
}

function downloadLocalBackup() {
  const backup = localStorage.getItem('archideck_auto_backup');
  if (!backup) {
    showToast('ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
    return;
  }

  const blob = new Blob([backup], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `archideck_local_backup_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url); // ãƒ¡ãƒ¢ãƒªè§£æ”¾
  showToast('ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
}

// åˆæœŸåŒ–æ™‚ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—UIã‚’æ›´æ–°
setTimeout(updateBackupUI, 1000);

// å®šæœŸçš„ã«è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆ5åˆ†ã”ã¨ï¼‰
setInterval(() => {
  if (projects.length > 0 || designers.length > 0) {
    saveAutoBackup();
  }
}, 5 * 60 * 1000);

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
async function createBackup() {
  const statusEl = document.getElementById('backupStatus');
  statusEl.innerHTML = '<span style="color: var(--text-muted);">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆä¸­...</span>';

  try {
    const backup = {
      version: '4.1',
      created_at: new Date().toISOString(),
      data: {
        projects: projects,
        designers: designers,
        tasksV2: tasksV2,
        vendors: vendors,
        emailTemplates: emailTemplates,
        products: products,
        vendorCategories: vendorCategories,
        taskVendorMappings: taskVendorMappings
      }
    };

    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `archideck_backup_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url); // ãƒ¡ãƒ¢ãƒªè§£æ”¾

    statusEl.innerHTML = '<span style="color: var(--success-color);">âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ</span>';
    showToast('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
  } catch (error) {
    logError('Backup error:', error);
    statusEl.innerHTML = '<span style="color: var(--danger-color);">âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ</span>';
    showToast('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒ
function restoreBackup() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.json';
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚æœ¬å½“ã«å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ')) return;

    const statusEl = document.getElementById('backupStatus');
    statusEl.innerHTML = '<span style="color: var(--text-muted);">å¾©å…ƒä¸­...</span>';

    try {
      const text = await file.text();
      const backup = JSON.parse(text);

      if (!backup.version || !backup.data) {
        throw new Error('ç„¡åŠ¹ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
      }

      // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å¾©å…ƒ
      const tables = ['projects', 'designers', 'vendors', 'email_templates', 'products', 'vendor_categories'];
      const dataMap = {
        projects: backup.data.projects,
        designers: backup.data.designers,
        vendors: backup.data.vendors,
        email_templates: backup.data.emailTemplates,
        products: backup.data.products,
        vendor_categories: backup.data.vendorCategories
      };

      let totalItems = 0;
      let failedItems = 0;

      for (const table of tables) {
        const data = dataMap[table];
        if (data && data.length > 0) {
          // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦å¾©å…ƒ
          await supabase.from(table).delete().neq('id', '00000000-0000-0000-0000-000000000000');
          for (const item of data) {
            totalItems++;
            const { error } = await supabase.from(table).insert(item);
            if (error) {
              failedItems++;
              logError(`å¾©å…ƒã‚¨ãƒ©ãƒ¼ (${table}):`, error);
            }
          }
        }
      }

      if (failedItems > 0) {
        statusEl.innerHTML = `<span style="color: var(--warning-color);">âš ï¸ å¾©å…ƒå®Œäº†ï¼ˆ${failedItems}/${totalItems}ä»¶å¤±æ•—ï¼‰ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</span>`;
        showToast(`å¾©å…ƒå®Œäº†ï¼ˆ${failedItems}ä»¶å¤±æ•—ï¼‰`, 'warning');
      } else {
        statusEl.innerHTML = '<span style="color: var(--success-color);">âœ… å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</span>';
        showToast('å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
      }
    } catch (error) {
      logError('Restore error:', error);
      statusEl.innerHTML = '<span style="color: var(--danger-color);">âŒ å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ</span>';
      showToast('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  };
  fileInput.click();
}

// kintoneé€£æºè¨­å®šä¿å­˜
async function saveKintoneSettings() {
  const settings = {
    domain: document.getElementById('kintoneDomain').value,
    app_id: document.getElementById('kintoneAppId').value,
    api_token: document.getElementById('kintoneApiToken').value
  };

  if (!settings.domain || !settings.app_id || !settings.api_token) {
    showToast('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  const { error } = await supabase
    .from('kintone_settings')
    .upsert({
      ...settings,
      is_active: true,
      updated_at: new Date().toISOString()
    });

  if (error) {
    showToast('è¨­å®šä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    return;
  }

  kintoneSettings = settings;
  showToast('kintoneè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

// kintoneæ¥ç¶šãƒ†ã‚¹ãƒˆ
async function testKintoneConnection() {
  const domain = document.getElementById('kintoneDomain').value;
  const appId = document.getElementById('kintoneAppId').value;
  const apiToken = document.getElementById('kintoneApiToken').value;

  if (!domain || !appId || !apiToken) {
    showToast('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
    return;
  }

  document.getElementById('kintoneStatus').innerHTML = '<span style="color: var(--text-muted);">æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...</span>';

  try {
    // CORSåˆ¶é™ã®ãŸã‚ã€å®Ÿéš›ã®æ¥ç¶šãƒ†ã‚¹ãƒˆã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§è¡Œã†å¿…è¦ãŒã‚ã‚‹
    // ã“ã“ã§ã¯UIã®ã¿å®Ÿè£…
    setTimeout(() => {
      document.getElementById('kintoneStatus').innerHTML = '<span style="color: var(--success-color);">âœ… æ¥ç¶šè¨­å®šã¯ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚å®Ÿéš›ã®åŒæœŸã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§è¡Œã‚ã‚Œã¾ã™ã€‚</span>';
    }, 1000);
  } catch (e) {
    document.getElementById('kintoneStatus').innerHTML = '<span style="color: var(--danger-color);">âŒ æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ</span>';
  }
}

// kintoneè¨­å®šèª­ã¿è¾¼ã¿
async function loadKintoneSettings() {
  const { data } = await supabase
    .from('kintone_settings')
    .select('*')
    .eq('is_active', true)
    .single();

  if (data) {
    kintoneSettings = data;
    document.getElementById('kintoneDomain').value = data.domain || '';
    document.getElementById('kintoneAppId').value = data.app_id || '';
    // APIãƒˆãƒ¼ã‚¯ãƒ³ã¯è¡¨ç¤ºã—ãªã„ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
  }
}

// kintoneã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆCSVãƒ™ãƒ¼ã‚¹ï¼‰
async function importFromKintone() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.csv';
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const text = await file.text();
    const lines = text.split('\n');

    // ç©ºãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã¿ã®ãƒã‚§ãƒƒã‚¯
    if (!lines || lines.length < 2) {
      showToast('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã‹ã€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

    const customerIdx = headers.findIndex(h => h.includes('é¡§å®¢') || h.includes('é‚¸å') || h.includes('customer'));
    const addressIdx = headers.findIndex(h => h.includes('å»ºç¯‰åœ°') || h.includes('ä½æ‰€') || h.includes('address'));
    const recordIdIdx = headers.findIndex(h => h.includes('ãƒ¬ã‚³ãƒ¼ãƒ‰') || h.includes('record') || h === '$id');

    if (customerIdx === -1) {
      showToast('é¡§å®¢å/é‚¸åã‚«ãƒ©ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    let importCount = 0;
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
      if (!cols[customerIdx]) continue;

      const customer = cols[customerIdx];
      const address = addressIdx >= 0 ? cols[addressIdx] : '';
      const kintoneRecordId = recordIdIdx >= 0 ? cols[recordIdIdx] : '';

      // æ—¢å­˜ãƒã‚§ãƒƒã‚¯
      const existing = projects.find(p => p.customer === customer);
      if (existing) continue;

      // æ–°è¦ä½œæˆ
      const { error } = await supabase.from('projects').insert({
        customer,
        building_address: address,
        kintone_record_id: kintoneRecordId,
        assigned_to: designers.find(d => d.category === 'è¨­è¨ˆ')?.name || '',
        specifications: 'LIFE',
        status: 'active',
        progress: {}
      });

      if (!error) importCount++;
    }

    showToast(`${importCount}ä»¶ã®æ¡ˆä»¶ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
    await loadProjects();
    renderProjects();
  };
  fileInput.click();
}

// kintoneã¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCSVï¼‰
function exportToKintone() {
  const headers = ['æ¡ˆä»¶ID', 'kintone_record_id', 'é¡§å®¢å', 'å»ºç¯‰åœ°', 'è¨­è¨ˆæ‹…å½“', 'å•†å“', 'é€²æ—ç‡', 'é–“å–ç¢ºå®šæ—¥', 'ç€å·¥è¨±å¯æ—¥', 'å¤‰æ›´å¥‘ç´„å‰ä¼šè­°æ—¥', 'æ›´æ–°æ—¥'];
  const rows = projects.map(p => [
    p.id,
    p.kintone_record_id || '',
    p.customer,
    p.building_address || '',
    p.assigned_to,
    p.specifications,
    calculateProgress(p) + '%',
    p.layout_confirmed_date || '',
    p.construction_permit_date || '',
    p.pre_contract_meeting_date || '',
    p.updated_at
  ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));

  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `archideck_export_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  URL.revokeObjectURL(url); // ãƒ¡ãƒ¢ãƒªè§£æ”¾
  showToast('CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
}

// kintoneåŒæœŸå¯¾è±¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
async function syncToKintone(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project || !project.kintone_record_id) {
    showToast('kintone record IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
    return;
  }

  if (!kintoneSettings?.domain || !kintoneSettings?.api_token) {
    showToast('kintoneè¨­å®šãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“', 'error');
    return;
  }

  // å®Ÿéš›ã®APIã‚³ãƒ¼ãƒ«ã¯CORSåˆ¶é™ã®ãŸã‚ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè¡ŒãŒå¿…è¦
  // ã“ã“ã§ã¯UIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã¿
  showToast('kintoneåŒæœŸã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å‡¦ç†å¾…ã¡ï¼‰', 'info');

  // åŒæœŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’DBã«è¨˜éŒ²
  await supabase.from('kintone_sync_queue').insert({
    project_id: projectId,
    kintone_record_id: project.kintone_record_id,
    sync_type: 'push',
    status: 'pending',
    data: {
      layout_confirmed_date: project.layout_confirmed_date,
      construction_permit_date: project.construction_permit_date,
      pre_contract_meeting_date: project.pre_contract_meeting_date
    }
  }).catch(() => {});
}

// å¤–æ§‹æ‹…å½“ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¨­å®š
function populateExteriorAssigneeDropdown(projectId = null, project = null) {
  const exteriorDesigners = designers.filter(d => d.category === 'å¤–æ§‹');
  const exteriorAssigneeSelect = document.getElementById('projectExteriorAssignee');

  if (exteriorAssigneeSelect) {
    exteriorAssigneeSelect.innerHTML = '<option value="">æœªå®š</option>' +
      exteriorDesigners.map(d => `<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`).join('');

    if (projectId && project) {
      exteriorAssigneeSelect.value = project.exterior_assignee || '';
    }
  }
}

// openProjectModalã‚’æ‹¡å¼µ
const originalOpenProjectModal = openProjectModal;
openProjectModal = function(projectId = null) {
  originalOpenProjectModal(projectId);

  const project = projectId ? projects.find(p => p.id === projectId) : null;
  populateExteriorAssigneeDropdown(projectId, project);
};

// saveProjectã‚’æ‹¡å¼µ
const originalSaveProject = saveProject;
saveProject = async function() {
  const customer = document.getElementById('projectCustomer').value.trim();
  const assignedTo = document.getElementById('projectAssignedTo').value.trim();
  const icAssignee = document.getElementById('projectIcAssignee').value.trim();

  // æœ€å¾Œã«ä½¿ç”¨ã—ãŸæ‹…å½“è€…ã‚’è¨˜æ†¶
  if (assignedTo) {
    localStorage.setItem('archideck_last_assignee', assignedTo);
  }
  const exteriorAssignee = document.getElementById('projectExteriorAssignee')?.value.trim() || '';
  const specifications = document.getElementById('projectSpecifications').value;
  const memo = document.getElementById('projectMemo').value.trim();

  if (!customer || !assignedTo) {
    showToast('ãŠå®¢æ§˜åã¨æ‹…å½“ï¼ˆè¨­è¨ˆï¼‰ã¯å¿…é ˆã§ã™', 'error');
    return;
  }

  showStatus('ä¿å­˜ä¸­...', 'saving');

  const projectData = {
    customer,
    assigned_to: assignedTo,
    ic_assignee: icAssignee || null,
    exterior_assignee: exteriorAssignee || null,
    specifications,
    memo,
    updated_at: new Date().toISOString()
  };

  try {
    if (editingProjectId) {
      const { error } = await supabase
        .from('projects')
        .update(projectData)
        .eq('id', editingProjectId);

      if (error) throw error;

      const idx = projects.findIndex(p => p.id === editingProjectId);
      if (idx !== -1) {
        projects[idx] = { ...projects[idx], ...projectData };
      }
    } else {
      const uid = 'P-' + Date.now();
      projectData.uid = uid;
      projectData.progress = {};
      projectData.status = 'active';

      const { data, error } = await supabase
        .from('projects')
        .insert(projectData)
        .select()
        .single();

      if (error) throw error;
      projects.push(data);
    }

    showStatus('ä¿å­˜æ¸ˆã¿', 'saved');
    showToast(editingProjectId ? 'æ¡ˆä»¶ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'æ¡ˆä»¶ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    closeProjectModal();
    renderSidebar();
    renderProjects();
  } catch (error) {
    logError('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    showStatus('ã‚¨ãƒ©ãƒ¼', 'error');
    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
};

// ============================================
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
// ============================================
window.addEventListener('DOMContentLoaded', () => {
  checkAuth();
  // URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã®å‡¦ç†ã¯checkAuth() â†’ init()å®Œäº†å¾Œã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹

  // Service Workerç™»éŒ²ï¼ˆPWAå¯¾å¿œï¼‰- é †åºåˆ¶å¾¡ä»˜ã
  if ('serviceWorker' in navigator) {
    (async () => {
      try {
        // 1. å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å…¨ã¦ã‚¯ãƒªã‚¢
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(async (cacheName) => {
          await caches.delete(cacheName);
          log('ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢:', cacheName);
        }));

        // 2. æ—¢å­˜ã®Service Workerã‚’æ›´æ–°
        const registrations = await navigator.serviceWorker.getRegistrations();
        await Promise.all(registrations.map(async (registration) => {
          await registration.update();
          log('ğŸ”„ Service Workeræ›´æ–°ã‚’ç¢ºèª');
        }));

        // 3. Service Workerã‚’ç™»éŒ²
        const reg = await navigator.serviceWorker.register('/archideck/sw.js', { updateViaCache: 'none' });
        log('âœ… Service Worker registered:', reg.scope);

        // æ–°ã—ã„Service WorkerãŒã‚ã‚Œã°å³åº§ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
        if (reg.waiting) {
          reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
      } catch (err) {
        logError('âŒ Service Workerå‡¦ç†ã‚¨ãƒ©ãƒ¼:', err);
      }
    })();
  }

  // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  if ('Notification' in window && Notification.permission === 'default') {
    // 3ç§’å¾Œã«é€šçŸ¥è¨±å¯ã‚’æ±‚ã‚ã‚‹
    setTimeout(() => {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          log('âœ… Push notifications enabled');
        }
      });
    }, 3000);
  }
});
</script>
</body>
</html>
