<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2563EB">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ArchiDeck">
<meta name="description" content="‰ΩèÂÆÖË®≠Ë®àÊ•≠Âãô„ÇíÈù©Êñ∞ÁöÑ„Å´ÂäπÁéáÂåñ„Åô„Çã„Çø„Çπ„ÇØÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†">
<link rel="manifest" href="/archideck/manifest.json">
<title>ArchiDeck | G„Éè„Ç¶„Çπ Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üè†</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232563EB' width='100' height='100' rx='20'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white'>A</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  /* Primary - Deep Ocean Blue */
  --primary-color: #2563EB;
  --primary-hover: #1D4ED8;
  --primary-light: #DBEAFE;
  --primary-dark: #1E40AF;

  /* Secondary - Emerald Green */
  --secondary-color: #059669;
  --secondary-hover: #047857;
  --secondary-light: #D1FAE5;

  /* Accent - Violet */
  --accent-color: #7C3AED;
  --accent-light: #EDE9FE;

  /* Status Colors */
  --danger-color: #DC2626;
  --danger-light: #FEE2E2;
  --warning-color: #D97706;
  --warning-light: #FEF3C7;
  --success-color: #16A34A;
  --success-light: #DCFCE7;
  --info-color: #0891B2;
  --info-light: #CFFAFE;

  /* Text Colors */
  --text-primary: #0F172A;
  --text-secondary: #475569;
  --text-muted: #94A3B8;
  --text-light: #CBD5E1;

  /* Background Colors */
  --bg-primary: #FFFFFF;
  --bg-secondary: #F8FAFC;
  --bg-tertiary: #F1F5F9;
  --bg-hover: #E2E8F0;

  /* Border Colors */
  --border-color: #E2E8F0;
  --border-light: #F1F5F9;
  --border-focus: #93C5FD;

  /* Shadows - More refined */
  --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -2px rgba(0,0,0,0.04);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.03);
  --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.08), 0 8px 10px -6px rgba(0,0,0,0.03);
  --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,0.15);
  --shadow-inner: inset 0 2px 4px rgba(0,0,0,0.04);
  --shadow-glow: 0 0 20px rgba(37, 99, 235, 0.15);

  /* Border Radius */
  --radius-xs: 4px;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --radius-2xl: 20px;
  --radius-full: 9999px;

  /* Transitions */
  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-normal: 200ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-bounce: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);

  /* Spacing */
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-2xl: 48px;
}

/* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ - Dark Mode Theme */
[data-theme="dark"] {
  --primary-color: #3B82F6;
  --primary-hover: #2563EB;
  --primary-light: #1E3A5F;
  --primary-dark: #60A5FA;

  --secondary-color: #10B981;
  --secondary-hover: #059669;
  --secondary-light: #064E3B;

  --accent-color: #8B5CF6;
  --accent-light: #2E1065;

  --danger-color: #EF4444;
  --danger-light: #450A0A;
  --warning-color: #F59E0B;
  --warning-light: #451A03;
  --success-color: #22C55E;
  --success-light: #052E16;
  --info-color: #06B6D4;
  --info-light: #083344;

  --text-primary: #F1F5F9;
  --text-secondary: #94A3B8;
  --text-muted: #64748B;
  --text-light: #475569;

  --bg-primary: #0F172A;
  --bg-secondary: #1E293B;
  --bg-tertiary: #334155;
  --bg-hover: #475569;

  --border-color: #334155;
  --border-light: #1E293B;
  --border-focus: #3B82F6;

  --shadow-xs: 0 1px 2px rgba(0,0,0,0.3);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.4), 0 1px 2px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.4), 0 2px 4px -2px rgba(0,0,0,0.3);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.4), 0 4px 6px -4px rgba(0,0,0,0.2);
  --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.4), 0 8px 10px -6px rgba(0,0,0,0.2);
  --shadow-glow: 0 0 20px rgba(59, 130, 246, 0.3);
}

/* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ„ÅÆ„Éà„É©„É≥„Ç∏„Ç∑„Éß„É≥ */
body, .header, .sidebar, .modal-content, .card, .project-card, .btn {
  transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}

/* „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâËøΩÂä†„Çπ„Çø„Ç§„É´ */
[data-theme="dark"] .sidebar {
  background: var(--bg-secondary);
}

[data-theme="dark"] .sidebar-item,
[data-theme="dark"] .sidebar-section-title {
  color: var(--text-primary);
}

[data-theme="dark"] .sidebar-item:hover {
  background: var(--bg-tertiary);
}

[data-theme="dark"] .input,
[data-theme="dark"] .select,
[data-theme="dark"] .form-input,
[data-theme="dark"] input[type="text"],
[data-theme="dark"] input[type="email"],
[data-theme="dark"] input[type="password"],
[data-theme="dark"] input[type="date"],
[data-theme="dark"] input[type="number"],
[data-theme="dark"] select,
[data-theme="dark"] textarea {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border-color: var(--border-color);
}

[data-theme="dark"] .input::placeholder,
[data-theme="dark"] .form-input::placeholder,
[data-theme="dark"] textarea::placeholder {
  color: var(--text-muted);
}

[data-theme="dark"] select option {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

[data-theme="dark"] .task-state-select {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border-color: var(--border-color);
}

[data-theme="dark"] .task-item {
  background: var(--bg-secondary);
  border-color: var(--border-color);
}

[data-theme="dark"] .task-label {
  color: var(--text-primary);
}

[data-theme="dark"] .card-section-header {
  color: var(--text-primary);
}

[data-theme="dark"] .card-section-content {
  background: var(--bg-secondary);
}

[data-theme="dark"] .table {
  background: var(--bg-primary);
}

[data-theme="dark"] .table th {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

[data-theme="dark"] .table td {
  color: var(--text-primary);
  border-color: var(--border-color);
}

[data-theme="dark"] .table tr:hover {
  background: var(--bg-secondary);
}

[data-theme="dark"] .modal-content {
  background: var(--bg-primary);
  color: var(--text-primary);
}

[data-theme="dark"] .modal-header,
[data-theme="dark"] .modal-footer {
  border-color: var(--border-color);
}

[data-theme="dark"] .badge {
  color: var(--text-primary);
}

[data-theme="dark"] .progress-bar {
  background: var(--bg-tertiary);
}

[data-theme="dark"] .designer-tab {
  color: var(--text-primary);
  background: var(--bg-tertiary);
  border-color: var(--border-color);
}

[data-theme="dark"] .designer-tab:hover {
  background: var(--bg-hover);
}

[data-theme="dark"] .designer-tab.active {
  background: var(--primary-color);
  color: white;
}

/* ÂàÜÊûêÁîªÈù¢„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
[data-theme="dark"] .analytics-section {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
}

[data-theme="dark"] .section-title {
  color: var(--text-primary);
}

[data-theme="dark"] .kpi-card {
  background: var(--bg-tertiary);
  border-color: var(--border-color);
}

[data-theme="dark"] .kpi-value,
[data-theme="dark"] .kpi-label {
  color: var(--text-primary);
}

[data-theme="dark"] .prediction-card {
  background: var(--bg-tertiary);
  border-color: var(--border-color);
}

[data-theme="dark"] .prediction-header,
[data-theme="dark"] .prediction-content {
  color: var(--text-primary);
}

[data-theme="dark"] .gantt-container {
  background: var(--bg-tertiary);
}

[data-theme="dark"] .report-preview {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

/* data-table „Çπ„Çø„Ç§„É´ÔºàÂàÜÊûêÁîªÈù¢Áî®Ôºâ */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.data-table th,
.data-table td {
  padding: 12px 16px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.data-table th {
  background: var(--bg-secondary);
  font-weight: 600;
  color: var(--text-primary);
}

.data-table td {
  color: var(--text-primary);
}

.data-table tr:hover td {
  background: var(--bg-hover);
}

[data-theme="dark"] .data-table th {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

[data-theme="dark"] .data-table td {
  color: var(--text-primary);
  border-color: var(--border-color);
}

[data-theme="dark"] .data-table tr:hover td {
  background: var(--bg-hover);
}

body {
  font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-secondary);
  color: var(--text-primary);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Global Scrollbar Styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

/* Focus Visible - Accessibility */
:focus-visible {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

/* Selection Styling */
::selection {
  background: var(--primary-light);
  color: var(--primary-dark);
}

/* Utility Classes */
.text-primary { color: var(--text-primary); }
.text-secondary { color: var(--text-secondary); }
.text-muted { color: var(--text-muted); }
.text-success { color: var(--success-color); }
.text-danger { color: var(--danger-color); }
.text-warning { color: var(--warning-color); }

.bg-primary { background: var(--primary-light); }
.bg-success { background: var(--success-light); }
.bg-danger { background: var(--danger-light); }
.bg-warning { background: var(--warning-light); }

.font-medium { font-weight: 500; }
.font-semibold { font-weight: 600; }
.font-bold { font-weight: 700; }

.rounded { border-radius: var(--radius-md); }
.rounded-lg { border-radius: var(--radius-lg); }
.rounded-full { border-radius: var(--radius-full); }

.shadow-sm { box-shadow: var(--shadow-sm); }
.shadow-md { box-shadow: var(--shadow-md); }
.shadow-lg { box-shadow: var(--shadow-lg); }

/* Animation Classes */
.animate-fade-in {
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.animate-slide-up {
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-scale-in {
  animation: scaleIn 0.2s ease-out;
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ - Premium Design */
.login-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--bg-secondary) 0%, #E8F4FE 100%);
  padding: 20px;
  position: relative;
  overflow: hidden;
}

.login-container::before {
  content: '';
  position: absolute;
  width: 600px;
  height: 600px;
  background: radial-gradient(circle, rgba(37, 99, 235, 0.08) 0%, transparent 70%);
  top: -200px;
  right: -200px;
  pointer-events: none;
}

.login-container::after {
  content: '';
  position: absolute;
  width: 400px;
  height: 400px;
  background: radial-gradient(circle, rgba(5, 150, 105, 0.06) 0%, transparent 70%);
  bottom: -100px;
  left: -100px;
  pointer-events: none;
}

.login-card {
  background: var(--bg-primary);
  border: 1px solid rgba(255,255,255,0.8);
  border-radius: var(--radius-2xl);
  padding: 48px;
  box-shadow: var(--shadow-xl), 0 0 40px rgba(37, 99, 235, 0.06);
  max-width: 440px;
  width: 100%;
  text-align: center;
  position: relative;
  z-index: 1;
}

.login-logo {
  width: 64px;
  height: 64px;
  margin: 0 auto 20px;
  background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);
}

.login-card h1 {
  font-size: 26px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
  letter-spacing: -0.02em;
}

.login-card p {
  color: var(--text-secondary);
  margin-bottom: 32px;
  font-size: 14px;
  line-height: 1.5;
}

/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä */
.main-container {
  display: none;
  max-width: 1800px;
  margin: 0 auto;
  background: var(--bg-secondary);
  min-height: 100vh;
}

.main-container.show {
  display: block;
}

/* „Éò„ÉÉ„ÉÄ„Éº - Premium Design */
.header {
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  padding: 0 32px;
  height: 64px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 32px;
}

.sidebar-toggle {
  display: none;
}

.logo {
  font-size: 22px;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
  letter-spacing: -0.02em;
}

.logo-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
}

.logo-text {
  background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-action-btn {
  width: 40px;
  height: 40px;
  border: none;
  background: transparent;
  border-radius: var(--radius-md);
  cursor: pointer;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-fast);
}

.header-action-btn:hover {
  background: var(--bg-secondary);
  color: var(--primary-color);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 6px 12px 6px 6px;
  background: var(--bg-secondary);
  border-radius: var(--radius-full);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.user-info:hover {
  background: var(--bg-hover);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  font-weight: 600;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

.user-role {
  font-size: 11px;
  color: var(--text-muted);
}

/* „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„Åà„É°„Éã„É•„Éº */
.category-switch-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  min-width: 180px;
}

.category-switch-menu button {
  display: block;
  width: 100%;
  padding: 12px 16px;
  text-align: left;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-primary);
  transition: background 0.2s;
}

.category-switch-menu button:hover {
  background: var(--bg-secondary);
}

.category-switch-menu button:first-child {
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.category-switch-menu button:last-child {
  border-radius: 0 0 var(--radius-md) var(--radius-md);
}

/* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
.tabs-nav {
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  padding: 0 32px;
  display: flex;
  gap: 8px;
}

.tab-nav-btn {
  padding: 16px 24px;
  border: none;
  background: transparent;
  font-size: 15px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.tab-nav-btn:hover {
  color: var(--text-primary);
  background: var(--bg-secondary);
}

.tab-nav-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
}

/* „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
.tab-panel {
  display: none;
  flex: 1;
  overflow-y: auto;
}

.tab-panel.active {
  display: flex;
  flex-direction: column;
}

/* „ÉÑ„Éº„É´„Éê„Éº */
.toolbar {
  background: var(--bg-primary);
  padding: 20px 32px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.toolbar-left {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  flex: 1;
}

.toolbar-right {
  display: flex;
  gap: 12px;
}

/* „Éá„Ç∂„Ç§„Éä„Éº„Çø„Éñ */
.designer-tabs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.designer-tab {
  padding: 8px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.designer-tab:hover {
  background: var(--bg-tertiary);
}

.designer-group-label {
  width: 100%;
  padding: 8px 12px;
  margin-top: 12px;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border-radius: 8px;
  border-left: 3px solid var(--primary-color);
}

.designer-tab.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* „Éú„Çø„É≥ - Premium Design */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 11px 22px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-normal);
  white-space: nowrap;
  position: relative;
  overflow: hidden;
  letter-spacing: 0.01em;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.12) 0%, transparent 50%);
  pointer-events: none;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2), 0 1px 2px rgba(37, 99, 235, 0.12);
}

.btn-primary:hover {
  background: var(--primary-hover);
  box-shadow: 0 8px 16px rgba(37, 99, 235, 0.25), 0 3px 6px rgba(37, 99, 235, 0.15);
  transform: translateY(-1px);
}

.btn-primary:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
}

.btn-secondary {
  background: var(--secondary-color);
  color: white;
  box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2);
}

.btn-secondary:hover {
  background: var(--secondary-hover);
  box-shadow: 0 8px 16px rgba(5, 150, 105, 0.25);
  transform: translateY(-1px);
}

.btn-ghost {
  background: transparent;
  border: 1.5px solid var(--border-color);
  color: var(--text-primary);
}

.btn-ghost::before {
  display: none;
}

.btn-ghost:hover {
  background: var(--bg-secondary);
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.btn-outline {
  background: transparent;
  border: 1.5px solid var(--primary-color);
  color: var(--primary-color);
}

.btn-outline::before {
  display: none;
}

.btn-outline:hover {
  background: var(--primary-light);
}

.btn-danger {
  background: var(--danger-color);
  color: white;
  box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
}

.btn-danger:hover {
  background: #B91C1C;
  box-shadow: 0 8px 16px rgba(220, 38, 38, 0.25);
  transform: translateY(-1px);
}

.btn-soft {
  background: var(--primary-light);
  color: var(--primary-color);
  border: none;
}

.btn-soft::before {
  display: none;
}

.btn-soft:hover {
  background: var(--border-focus);
}

.btn-small {
  padding: 7px 14px;
  font-size: 13px;
}

.btn-large {
  padding: 14px 28px;
  font-size: 16px;
}

.btn-icon {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: var(--radius-md);
}

.btn-icon.btn-small {
  width: 32px;
  height: 32px;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ - Premium Design */
.input, .select {
  padding: 11px 16px;
  border: 1.5px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  background: var(--bg-primary);
  transition: all var(--transition-normal);
  color: var(--text-primary);
}

.input:hover, .select:hover {
  border-color: var(--text-muted);
}

.input:focus, .select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  background: #FAFBFF;
}

.input::placeholder {
  color: var(--text-muted);
}

.input {
  min-width: 200px;
}

.input-group {
  position: relative;
}

.input-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  pointer-events: none;
}

.input-group .input {
  padding-left: 42px;
}

/* „Ç´„Éº„Éâ„Ç∞„É™„ÉÉ„Éâ */
.cards-container {
  padding: 32px;
}

.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
  gap: 24px;
}

/* „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„Éº„Éâ - Premium Design */
.project-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-xl);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: all var(--transition-slow);
  position: relative;
  overflow: hidden;
}

.project-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--secondary-color));
  opacity: 0;
  transition: opacity var(--transition-normal);
}

.project-card:hover {
  box-shadow: var(--shadow-lg), var(--shadow-glow);
  transform: translateY(-2px);
  border-color: transparent;
}

.project-card:hover::before {
  opacity: 1;
}

/* „ÅäÊ∞ó„Å´ÂÖ•„Çä„Ç´„Éº„Éâ */
.project-card.favorite {
  border-color: var(--warning-color);
  background: linear-gradient(to bottom, var(--warning-light) 0%, white 100px);
}

.project-card.favorite::before {
  background: var(--warning-color);
  opacity: 1;
}

/* ÈÅ∏Êäû‰∏≠„Ç´„Éº„Éâ */
.project-card.selected {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px var(--primary-light);
}

/* „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éú„Çø„É≥ */
.favorite-btn {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: var(--text-muted);
  padding: 4px;
  line-height: 1;
  transition: all var(--transition-fast);
}

.favorite-btn:hover {
  color: var(--warning-color);
  transform: scale(1.2);
}

.favorite-btn.active {
  color: var(--warning-color);
}

/* „Éê„ÉÉ„ÉÅÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ */
.batch-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
  margin-top: 2px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border-light);
}

.card-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 12px;
  line-height: 1.3;
  letter-spacing: -0.02em;
}

.card-title:hover {
  color: var(--primary-color);
}

/* Áâ©‰ª∂Âêç„ÅÆËÉåÊôØ„Éè„Ç§„É©„Ç§„Éà */
.customer-name {
  background: linear-gradient(135deg, #DBEAFE 0%, #EFF6FF 100%);
  padding: 4px 12px;
  border-radius: 6px;
  color: #1E40AF;
}

.card-title:hover .customer-name {
  background: linear-gradient(135deg, #BFDBFE 0%, #DBEAFE 100%);
}

.card-subtitle {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.card-subtitle::before {
  content: '';
  display: inline-block;
  width: 4px;
  height: 4px;
  background: var(--text-muted);
  border-radius: 50%;
}

/* „Éê„ÉÉ„Ç∏ - Premium Design */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  border-radius: var(--radius-full);
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.02em;
  border: none;
}

.badge-primary {
  background: var(--primary-light);
  color: var(--primary-color);
}

.badge-success {
  background: var(--success-light);
  color: var(--success-color);
}

.badge-warning {
  background: var(--warning-light);
  color: var(--warning-color);
}

.badge-danger {
  background: var(--danger-light);
  color: var(--danger-color);
}

.badge-secondary {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
}

.badge-info {
  background: var(--info-light);
  color: var(--info-color);
}

.badge-accent {
  background: var(--accent-light);
  color: var(--accent-color);
}

/* „Éà„Ç∞„É´„Çπ„Ç§„ÉÉ„ÉÅ */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 26px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.3s;
  border-radius: 26px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: var(--primary-color);
}

input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

/* „Éü„Çπ„ÉªÊºè„ÇåÈò≤Ê≠¢: Ë≠¶Âëä„Éê„ÉÉ„Ç∏ */
.project-warnings {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.warning-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  animation: pulse-warning 2s ease-in-out infinite;
}

.warning-badge.warning-danger {
  background: linear-gradient(135deg, #FEE2E2, #FECACA);
  color: #DC2626;
  border: 1px solid #FCA5A5;
}

.warning-badge.warning-warning {
  background: linear-gradient(135deg, #FEF3C7, #FDE68A);
  color: #D97706;
  border: 1px solid #FCD34D;
}

.warning-icon {
  font-size: 14px;
}

@keyframes pulse-warning {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* „Ç¢„É©„Éº„Éà„Çµ„Éû„É™„Éº */
.alert-summary {
  background: linear-gradient(135deg, #FEF2F2, #FEE2E2);
  border: 2px solid #FCA5A5;
  border-radius: 12px;
  padding: 16px 20px;
  margin-bottom: 20px;
  animation: slide-down 0.3s ease-out;
}

@keyframes slide-down {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.alert-summary-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}

.alert-summary-icon {
  font-size: 20px;
}

.alert-summary-title {
  font-size: 16px;
  font-weight: 700;
  color: #DC2626;
}

.alert-summary-count {
  background: #DC2626;
  color: white;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.alert-summary-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.alert-item {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--bg-primary);
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  color: #991B1B;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid #FECACA;
}

.alert-item:hover {
  background: #FEF2F2;
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15);
}

/* „Ç´„Éº„Éâ„Éè„Ç§„É©„Ç§„Éà */
.project-card.highlight-card {
  animation: highlight-pulse 0.5s ease-out 3;
  box-shadow: 0 0 0 3px var(--primary-color), var(--shadow-lg);
}

@keyframes highlight-pulse {
  0%, 100% { box-shadow: 0 0 0 3px var(--primary-color), var(--shadow-lg); }
  50% { box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.3), var(--shadow-lg); }
}

.badge-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
}

/* Ê•≠ËÄÖ„Ç´„Éº„Éâ */
.vendor-card {
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.vendor-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
  border-color: var(--primary-color);
}

.vendor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--bg-secondary);
}

.vendor-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.vendor-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
  font-size: 14px;
  color: var(--text-secondary);
}

.vendor-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* „Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø„Éº */
.category-filter-btn {
  padding: 8px 16px;
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
}

.category-filter-btn:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  background: var(--bg-secondary);
}

.category-filter-btn.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„É©„Éô„É´ */
.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
}

.checkbox-label input[type="checkbox"] {
  cursor: pointer;
  width: 18px;
  height: 18px;
}

.checkbox-label span {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

/* ÈÄ≤Êçó„Éê„Éº - Premium Design */
.progress-section {
  margin-bottom: 20px;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.progress-label {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
}

.progress-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--primary-color);
  display: flex;
  align-items: baseline;
  gap: 2px;
}

.progress-value-unit {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-muted);
}

.progress-bar {
  height: 8px;
  background: var(--bg-hover);
  border-radius: var(--radius-full);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: var(--radius-full);
  position: relative;
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
  animation: shimmer 2s ease-in-out infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.progress-fill.complete {
  background: var(--success-color);
}

/* „Çø„Çπ„ÇØ„É™„Çπ„Éà - Premium Design */
.tasks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 10px;
  margin-bottom: 20px;
}

.task-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--bg-primary);
  border-radius: var(--radius-md);
  font-size: 14px;
  transition: all var(--transition-fast);
  border: 1px solid var(--border-light);
}

.task-item:hover {
  background: var(--bg-secondary);
  border-color: var(--border-color);
  box-shadow: var(--shadow-sm);
}

/* „Çø„Çπ„ÇØÊúüÈôê„ÉªÈÅÖÂª∂Ë°®Á§∫ */
.task-item.overdue {
  border-left: 3px solid var(--danger-color);
  background: #FEF2F2;
}

.task-item.due-soon {
  border-left: 3px solid var(--warning-color);
  background: #FFFBEB;
}

.task-due-date {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
  margin-left: auto;
  white-space: nowrap;
}

.task-due-date.overdue {
  background: var(--danger-light);
  color: var(--danger-color);
  font-weight: 600;
}

.task-due-date.due-soon {
  background: var(--warning-light);
  color: #92400E;
}

.task-due-date.normal {
  background: var(--bg-tertiary);
  color: var(--text-muted);
}

.task-due-input {
  width: 110px;
  padding: 4px 8px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 12px;
  flex-shrink: 0;
}

.task-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
  border-radius: var(--radius-xs);
}

.task-state-select {
  height: 32px;
  padding: 0 10px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  background: var(--bg-primary);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--transition-fast);
  min-width: 90px;
  flex-shrink: 0;
}

.task-state-select:hover {
  border-color: var(--primary-color);
}

.task-state-select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
}

.task-state-select.state-yellow {
  background: var(--warning-light);
  border-color: #F59E0B;
  color: #92400E;
}

.task-state-select.state-blue {
  background: var(--primary-light);
  border-color: #3B82F6;
  color: #1E40AF;
}

.task-label {
  flex: 1;
  color: var(--text-primary);
  font-weight: 500;
  font-size: 13px;
}

.task-email-btn {
  width: 32px;
  height: 32px;
  padding: 0;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.task-email-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
}

.template-select-btn {
  width: 100%;
  padding: 16px;
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}

.template-select-btn:hover {
  border-color: var(--primary-color);
  background: var(--bg-secondary);
  transform: translateX(4px);
}

/* „É¢„Éº„ÉÄ„É´ - Premium Design */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.6);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(8px);
  padding: 20px;
}

.modal.show {
  display: flex;
  animation: modalBgFadeIn 0.2s ease-out;
}

@keyframes modalBgFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: var(--bg-primary);
  border-radius: var(--radius-2xl);
  width: min(800px, 100%);
  max-height: calc(100vh - 40px);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-2xl), 0 0 60px rgba(0, 0, 0, 0.15);
  animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-24px) scale(0.96);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  padding: 24px 28px;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg-primary);
  flex-shrink: 0;
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.02em;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.modal-title-icon {
  width: 36px;
  height: 36px;
  background: var(--primary-light);
  color: var(--primary-color);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

.close {
  width: 36px;
  height: 36px;
  border: none;
  background: var(--bg-secondary);
  color: var(--text-secondary);
  font-size: 20px;
  cursor: pointer;
  border-radius: var(--radius-md);
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
}

.close:hover {
  background: var(--danger-light);
  color: var(--danger-color);
}

.modal-body {
  padding: 28px;
  overflow-y: auto;
  flex: 1;
}

.modal-body::-webkit-scrollbar {
  width: 6px;
}

.modal-body::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 3px;
}

.modal-footer {
  padding: 20px 28px;
  border-top: 1px solid var(--border-light);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  background: var(--bg-secondary);
  flex-shrink: 0;
}

/* „Éï„Ç©„Éº„É† - Premium Design */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.form-label-required {
  color: var(--danger-color);
  font-size: 12px;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 12px 16px;
  border: 1.5px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  transition: all var(--transition-fast);
  background: var(--bg-primary);
  color: var(--text-primary);
}

.form-input:hover, .form-select:hover, .form-textarea:hover {
  border-color: var(--text-muted);
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  background: #FAFBFF;
}

.form-input::placeholder {
  color: var(--text-muted);
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
  line-height: 1.5;
}

.form-hint {
  margin-top: 6px;
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 4px;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.form-divider {
  height: 1px;
  background: var(--border-light);
  margin: 24px 0;
}

.form-section-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* „Çπ„ÉÜ„Éº„Çø„Çπ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 600;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.status-saving {
  background: #FFF4E6;
  color: var(--warning-color);
}

.status-saving .status-dot {
  background: var(--warning-color);
  animation: pulse 1.5s infinite;
}

.status-saved {
  background: #E6F9F0;
  color: var(--success-color);
}

.status-saved .status-dot {
  background: var(--success-color);
}

.status-error {
  background: #FFE6E6;
  color: var(--danger-color);
}

.status-error .status-dot {
  background: var(--danger-color);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* „ÉÜ„Éº„Éñ„É´ */
.table-container {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table thead {
  background: linear-gradient(180deg, #f8f9fa, #f0f1f3);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
}

.table th {
  padding: 18px 20px;
  text-align: left;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table td {
  padding: 16px 20px;
  border-top: 1px solid var(--border-color);
  font-size: 14px;
  color: var(--text-primary);
}

.table tbody tr:nth-child(even) {
  background: #fafbfc;
}

.table tbody tr:hover {
  background: #f0f7ff;
  box-shadow: inset 0 0 0 1px rgba(74, 144, 226, 0.1);
  transition: all 0.2s;
}

/* Á©∫Áä∂ÊÖã */
.empty-state {
  padding: 80px 40px;
  text-align: center;
  color: var(--text-secondary);
}

.empty-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.empty-description {
  font-size: 14px;
  margin-bottom: 24px;
}

/* „É°„Éº„É´Âá∫Âäõ */
.email-output {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: 20px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.8;
  white-space: pre-wrap;
  margin: 16px 0;
  max-height: 400px;
  overflow-y: auto;
}

/* „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó */
.minutes-upload-area.drag-over {
  background: var(--bg-tertiary);
  border-color: var(--primary-color);
  transform: scale(1.02);
}

/* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
@media (max-width: 1200px) {
  .cards-grid {
    grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
  }
}

@media (max-width: 768px) {
  .header {
    padding: 12px 16px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .header-left {
    gap: 12px;
  }

  .logo {
    font-size: 20px;
  }

  .tabs-nav {
    padding: 0 12px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .tab-nav-btn {
    padding: 12px 16px;
    font-size: 14px;
    white-space: nowrap;
  }

  .toolbar {
    padding: 12px 16px;
    flex-direction: column;
    align-items: stretch;
  }

  .toolbar-left {
    flex-direction: column;
  }

  .toolbar-right {
    justify-content: center;
  }

  .cards-container {
    padding: 12px;
  }

  .cards-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .project-card {
    padding: 16px;
  }

  .card-header {
    flex-direction: column;
    gap: 12px;
  }

  .card-title {
    font-size: 18px;
    flex-wrap: wrap;
  }

  .tasks-grid {
    grid-template-columns: 1fr;
  }

  .task-item {
    flex-wrap: wrap;
    gap: 8px;
  }

  .task-state-select {
    width: 100%;
    margin-top: 4px;
  }

  .modal-content {
    width: 95vw;
    max-height: 90vh;
  }

  .modal-body {
    padding: 16px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-input, .form-select, .select {
    font-size: 16px;
    padding: 12px;
  }

  .btn {
    padding: 12px 16px;
    font-size: 14px;
    min-height: 44px;
  }

  .btn-small {
    padding: 10px 14px;
    min-height: 40px;
  }

  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 1000;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    width: 280px;
  }

  .sidebar.open {
    transform: translateX(0);
  }

  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
  }

  .sidebar-overlay.show {
    display: block;
  }

  .sidebar-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: none;
    background: var(--primary-color);
    color: white;
    border-radius: 8px;
    font-size: 20px;
    cursor: pointer;
    margin-right: 8px;
  }

  .add-task-form {
    flex-direction: column;
  }

  .add-task-form input {
    width: 100%;
  }

  .designer-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 8px;
  }

  .designer-tab {
    flex-shrink: 0;
  }
}

@media (max-width: 480px) {
  .login-card {
    padding: 24px 20px;
  }

  .login-card h1 {
    font-size: 24px;
  }

  .header-right {
    gap: 8px;
  }

  .user-info {
    padding: 6px 10px;
    font-size: 13px;
  }

  .badge {
    padding: 4px 8px;
    font-size: 11px;
  }
}

/* „É≠„Éº„Éá„Ç£„É≥„Ç∞„Çπ„Éî„Éä„Éº */
.spinner {
  border: 3px solid var(--bg-secondary);
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 40px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó */
.draggable-row {
  cursor: move;
  transition: all 0.2s;
}

.draggable-row:hover {
  background: var(--bg-secondary);
}

.draggable-row.dragging {
  opacity: 0.5;
  background: var(--bg-hover);
}

.draggable-row.drag-over {
  border-top: 3px solid var(--primary-color);
}

.drag-handle {
  cursor: grab;
  color: var(--text-secondary);
  font-size: 18px;
  padding: 0 8px;
  user-select: none;
}

.drag-handle:active {
  cursor: grabbing;
}

/* „Éà„Éº„Çπ„ÉàÈÄöÁü• - Premium Design */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  padding: 16px 20px;
  box-shadow: var(--shadow-xl);
  display: none;
  align-items: center;
  gap: 12px;
  z-index: 2000;
  max-width: 400px;
  border: 1px solid var(--border-color);
}

.toast.show {
  display: flex;
  animation: toastSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes toastSlideIn {
  from {
    transform: translateX(120%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 14px;
}

.toast-success {
  border-left: 4px solid var(--success-color);
}

.toast-success .toast-icon {
  background: var(--success-light);
  color: var(--success-color);
}

.toast-error {
  border-left: 4px solid var(--danger-color);
}

.toast-error .toast-icon {
  background: var(--danger-light);
  color: var(--danger-color);
}

.toast-warning {
  border-left: 4px solid var(--warning-color);
}

.toast-warning .toast-icon {
  background: var(--warning-light);
  color: var(--warning-color);
}

.toast-message {
  font-size: 14px;
  color: var(--text-primary);
  font-weight: 500;
  line-height: 1.4;
}

/* „Çµ„Ç§„Éâ„Éê„Éº„É¨„Ç§„Ç¢„Ç¶„Éà - Premium Design */
.app-layout {
  display: flex;
  height: calc(100vh - 64px);
  overflow: hidden;
}

.sidebar {
  width: 280px;
  background: linear-gradient(180deg, white 0%, var(--bg-secondary) 100%);
  border-right: 1px solid var(--border-color);
  overflow-y: auto;
  flex-shrink: 0;
}

.sidebar::-webkit-scrollbar {
  width: 6px;
}

.sidebar::-webkit-scrollbar-track {
  background: transparent;
}

.sidebar::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 3px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

.sidebar-header {
  padding: 20px 16px;
  border-bottom: 1px solid var(--border-light);
}

.sidebar-section {
  padding: 16px;
  border-bottom: 1px solid var(--border-light);
}

.sidebar-section:last-child {
  border-bottom: none;
}

.sidebar-section-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 12px;
  padding-left: 4px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--transition-fast);
  margin-bottom: 2px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
}

.sidebar-item:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.sidebar-item.active {
  background: var(--primary-color);
  color: white;
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25);
}

.sidebar-item-label {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-item-icon {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.7;
}

.sidebar-item.active .sidebar-item-icon {
  opacity: 1;
}

.sidebar-item-count {
  font-size: 11px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: var(--radius-full);
  background: var(--bg-tertiary);
  color: var(--text-secondary);
}

.sidebar-item.active .sidebar-item-count {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

.sidebar-item-count.warning {
  background: var(--warning-light);
  color: var(--warning-color);
}

.sidebar-item-count.danger {
  background: var(--danger-light);
  color: var(--danger-color);
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* „Çµ„Éñ„Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ - Premium Design */
.sub-tabs-nav {
  display: flex;
  gap: 4px;
  padding: 12px 24px 0 24px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  overflow-x: auto;
}

.sub-tabs-nav::-webkit-scrollbar {
  height: 4px;
}

.sub-tabs-nav::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 2px;
}

.sub-tab-btn {
  padding: 12px 20px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  border-bottom: 2px solid transparent;
  transition: all var(--transition-fast);
  white-space: nowrap;
  position: relative;
}

.sub-tab-btn:hover {
  color: var(--primary-color);
  background: var(--primary-light);
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.sub-tab-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
  background: var(--primary-light);
  border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.sub-tab-panel {
  display: none;
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  max-height: calc(100vh - 180px);
}

.sub-tab-panel.active {
  display: block;
}

.table-container {
  overflow-y: auto;
  max-height: calc(100vh - 350px);
}

.cards-grid {
  overflow-y: auto;
  max-height: calc(100vh - 300px);
}

/* Ê•≠ËÄÖ„Ç´„Éº„Éâ */
.vendor-card {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.vendor-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
  border-color: var(--primary-color);
}

.vendor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--bg-secondary);
}

.vendor-header h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.vendor-info {
  margin-bottom: 16px;
}

.vendor-info > div {
  padding: 6px 0;
  font-size: 14px;
  color: var(--text-secondary);
}

.vendor-info strong {
  color: var(--text-primary);
  font-weight: 600;
  min-width: 80px;
  display: inline-block;
}

.vendor-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* ===== ÂàÜÊûê„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ ===== */
.analytics-container {
  padding: 24px;
  max-width: 1400px;
  margin: 0 auto;
}

.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.kpi-card {
  background: var(--bg-primary);
  border-radius: 16px;
  padding: 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: var(--shadow-md);
  transition: all var(--transition-fast);
}

.kpi-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.kpi-icon {
  font-size: 32px;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
}

.kpi-primary .kpi-icon { background: var(--primary-light); }
.kpi-success .kpi-icon { background: var(--success-light); }
.kpi-warning .kpi-icon { background: var(--warning-light); }
.kpi-info .kpi-icon { background: var(--info-light); }

.kpi-value {
  font-size: 32px;
  font-weight: 700;
  color: var(--text-primary);
}

.kpi-label {
  font-size: 14px;
  color: var(--text-secondary);
  margin-top: 4px;
}

.analytics-section {
  background: var(--bg-primary);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--border-light);
}

.prediction-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

.prediction-card {
  background: linear-gradient(135deg, var(--primary-light), #EFF6FF);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid var(--primary-color);
}

.prediction-header {
  font-size: 14px;
  font-weight: 600;
  color: var(--primary-dark);
  margin-bottom: 12px;
}

.prediction-content {
  font-size: 14px;
  color: var(--text-primary);
  line-height: 1.6;
}

.prediction-item {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 8px;
  padding: 8px;
  background: var(--bg-primary);
  border-radius: 8px;
}

.prediction-item.risk-high { border-left: 3px solid var(--danger-color); }
.prediction-item.risk-medium { border-left: 3px solid var(--warning-color); }
.prediction-item.risk-low { border-left: 3px solid var(--success-color); }

/* „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà */
.gantt-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
}

.gantt-container {
  overflow-x: auto;
  border: 1px solid var(--border-color);
  border-radius: 12px;
}

.gantt-table {
  width: 100%;
  min-width: 800px;
  border-collapse: collapse;
}

.gantt-table th, .gantt-table td {
  padding: 12px 8px;
  text-align: center;
  border-bottom: 1px solid var(--border-light);
  font-size: 12px;
}

.gantt-table th {
  background: var(--bg-secondary);
  font-weight: 600;
  position: sticky;
  top: 0;
}

.gantt-table th:first-child, .gantt-table td:first-child {
  text-align: left;
  min-width: 150px;
  position: sticky;
  left: 0;
  background: var(--bg-primary);
  z-index: 1;
}

.gantt-bar {
  height: 24px;
  border-radius: 4px;
  position: relative;
}

.gantt-bar-fill {
  height: 100%;
  border-radius: 4px;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
}

.gantt-today {
  background: rgba(220, 38, 38, 0.1);
}

/* „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÉÜ„Éº„Éñ„É´ */
.performance-table-container {
  overflow-x: auto;
}

/* „É¨„Éù„Éº„Éà */
.report-buttons {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.report-preview {
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 24px;
  white-space: pre-wrap;
  font-family: monospace;
  font-size: 13px;
  line-height: 1.6;
  max-height: 500px;
  overflow-y: auto;
}

/* ===== ArchiDeck v3.0 Êñ∞Ê©üËÉΩ„Çπ„Çø„Ç§„É´ ===== */

/* 5ÈÉ®ÊßãÊàê„Ç´„Éº„Éâ„Çª„ÇØ„Ç∑„Éß„É≥ - Premium Design */
.card-section {
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  margin-bottom: 12px;
  overflow: hidden;
  background: var(--bg-primary);
  transition: all var(--transition-fast);
}

.card-section:hover {
  border-color: var(--border-color);
}

.card-section:last-child {
  margin-bottom: 0;
}

.card-section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  background: var(--bg-secondary);
  cursor: pointer;
  user-select: none;
  transition: all var(--transition-fast);
  border-bottom: 1px solid transparent;
}

.card-section-header:hover {
  background: var(--bg-tertiary);
}

.card-section:not(.collapsed) .card-section-header {
  border-bottom-color: var(--border-light);
}

.card-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-section-icon {
  width: 28px;
  height: 28px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  background: var(--primary-light);
  color: var(--primary-color);
}

.card-section:nth-child(2) .card-section-icon {
  background: var(--accent-light);
  color: var(--accent-color);
}

.card-section:nth-child(3) .card-section-icon {
  background: var(--warning-light);
  color: var(--warning-color);
}

.card-section:nth-child(4) .card-section-icon {
  background: var(--info-light);
  color: var(--info-color);
}

.card-section:nth-child(5) .card-section-icon {
  background: var(--success-light);
  color: var(--success-color);
}

.card-section-toggle {
  font-size: 10px;
  color: var(--text-muted);
  transition: transform var(--transition-fast);
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-sm);
}

.card-section-header:hover .card-section-toggle {
  background: var(--bg-hover);
}

.card-section.collapsed .card-section-toggle {
  transform: rotate(-90deg);
}

.card-section-content {
  padding: 18px;
  display: block;
  background: var(--bg-primary);
}

.card-section.collapsed .card-section-content {
  display: none;
}

/* „Çø„Çπ„ÇØÊ©üËÉΩ */
.project-task-list {
  margin-top: 12px;
}

.project-task-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  transition: all 0.2s;
}

.project-task-item.completed {
  opacity: 0.5;
  background: #f5f5f5;
}

.project-task-item.completed .project-task-name {
  text-decoration: line-through;
  color: var(--text-muted);
}

.project-task-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
}

.project-task-name {
  flex: 1;
  font-size: 14px;
}

.project-task-due {
  font-size: 12px;
  color: var(--text-muted);
  padding: 2px 8px;
  background: var(--bg-tertiary);
  border-radius: 12px;
}

.project-task-due.overdue {
  background: #ffe5e5;
  color: var(--danger-color);
}

.add-task-form {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.add-task-form input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 13px;
}

/* ÂÖ±Êúâ„É°„É¢Ê¨Ñ */
.shared-memo-area {
  width: 100%;
  min-height: 80px;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 14px;
  resize: vertical;
  font-family: inherit;
}

/* Ë≠∞‰∫ãÈå≤„Çª„ÇØ„Ç∑„Éß„É≥ */
.minutes-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.minutes-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
}

.minutes-item-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.minutes-upload-area {
  border: 2px dashed var(--border-color);
  border-radius: var(--radius-md);
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.minutes-upload-area:hover {
  border-color: var(--primary-color);
  background: #f8fbff;
}

/* ÂºïÁ∂ôÊõ∏„Çª„ÇØ„Ç∑„Éß„É≥ */
.handover-content {
  width: 100%;
  min-height: 120px;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 14px;
  resize: vertical;
  font-family: inherit;
}

/* „Çµ„Ç§„Éâ„Éê„ÉºÊãÖÂΩìËÄÖËâ≤ÂàÜ„Åë */
.sidebar-item-count.count-blue {
  background: #e3f2fd;
  color: #1976d2;
}

.sidebar-item-count.count-yellow {
  background: #fff8e1;
  color: #f57c00;
}

.sidebar-item-label.name-red {
  color: #d32f2f;
  font-weight: 700;
}

/* „Çø„Çπ„ÇØ‰∏ÄË¶ß„Éú„Çø„É≥ */
.sidebar-task-btn {
  padding: 4px 8px;
  font-size: 11px;
  background: var(--bg-tertiary);
  border: none;
  border-radius: 12px;
  cursor: pointer;
  margin-left: 8px;
}

.sidebar-task-btn:hover {
  background: var(--primary-color);
  color: white;
}

/* „Çø„Çπ„ÇØ‰∏ÄË¶ß„É¢„Éº„ÉÄ„É´ */
.task-list-modal {
  max-height: 70vh;
  overflow-y: auto;
}

.task-list-group {
  margin-bottom: 24px;
}

.task-list-group-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-color);
}

/* Áî≥Ë´ãGO„Éú„Çø„É≥ÁÑ°ÂäπÂåñ */
.task-item-btn.disabled {
  opacity: 0.4;
  cursor: not-allowed;
  pointer-events: none;
}

.task-item-btn.disabled:hover {
  transform: none;
}

/* kintoneÈÄ£Êê∫Ë°®Á§∫ */
.kintone-info {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.kintone-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: #e8f5e9;
  color: #2e7d32;
  border-radius: 12px;
  font-size: 12px;
}

/* ÈÄöÁü•„Éê„ÉÉ„Ç∏ */
.notification-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--danger-color);
  color: white;
  font-size: 10px;
  font-weight: 700;
  min-width: 18px;
  height: 18px;
  border-radius: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Â§ñÊßãÊãÖÂΩì„Çª„ÇØ„Ç∑„Éß„É≥ */
.sidebar-section-exterior {
  border-left: 3px solid #8bc34a;
}

.sidebar-section-exterior .sidebar-section-title {
  color: #689f38;
}

/* ============================================
   „Çπ„Ç±„É´„Éà„É≥„É≠„Éº„Éá„Ç£„É≥„Ç∞
   ============================================ */
.skeleton-line,
.skeleton-circle {
  background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-hover) 50%, var(--bg-tertiary) 75%);
  background-size: 200% 100%;
  animation: skeleton-shimmer 1.5s infinite;
  border-radius: 4px;
}

.skeleton-circle {
  border-radius: 50%;
}

@keyframes skeleton-shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.skeleton-card {
  padding: 20px;
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-color);
}

.animate-pulse {
  animation: pulse-opacity 2s ease-in-out infinite;
}

@keyframes pulse-opacity {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ============================================
   „É¢„Éê„Ç§„É´ËøΩÂä†ÊîπÂñÑ
   ============================================ */
@media (max-width: 768px) {
  /* „Çø„ÉÉ„ÉÅ„Çø„Éº„Ç≤„ÉÉ„ÉàÊúÄÈÅ©Âåñ */
  .btn, button, a.btn {
    min-height: 44px;
    min-width: 44px;
  }

  /* „Éï„Ç©„Éº„É†ÂÖ•ÂäõÊã°Â§ß */
  input, select, textarea {
    font-size: 16px !important; /* iOS zoomÈò≤Ê≠¢ */
  }

  /* „É¢„Éº„ÉÄ„É´ÂÖ®ÁîªÈù¢Âåñ */
  .modal-content {
    width: 100vw;
    height: 100vh;
    max-height: 100vh;
    border-radius: 0;
    margin: 0;
  }

  .modal {
    padding: 0;
  }

  /* „Ç´„Éº„ÉâÂÜÖ„Éú„Çø„É≥ÈÖçÁΩÆ */
  .card-actions {
    flex-direction: column;
    width: 100%;
  }

  .card-actions .btn {
    width: 100%;
    justify-content: center;
  }

  /* „ÉÜ„Éº„Éñ„É´„Çπ„ÇØ„É≠„Éº„É´ */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Ê§úÁ¥¢„Éê„Éº */
  .search-box {
    width: 100%;
  }

  /* „Éú„Éà„É†„Éä„ÉìÁî®„Çπ„Éö„Éº„Çπ */
  .main-content {
    padding-bottom: 80px;
  }

  /* „Çø„Çπ„ÇØ„Ç¢„Ç§„ÉÜ„É†ÊîπÂñÑ */
  .task-item {
    padding: 12px;
    gap: 8px;
  }

  .task-label {
    font-size: 14px;
    flex: 1;
    min-width: 0;
  }

  .task-state-select {
    font-size: 13px;
    min-width: 100px;
  }

  .task-email-btn {
    min-width: 36px;
    min-height: 36px;
  }

  /* Êó•‰ªòÂÖ•ÂäõÊîπÂñÑ */
  .task-due-input {
    min-width: 130px;
  }
}

/* Ë∂ÖÂ∞èÁîªÈù¢ÂØæÂøú */
@media (max-width: 360px) {
  .header {
    padding: 8px 12px;
  }

  .logo {
    font-size: 18px;
  }

  .tab-nav-btn {
    padding: 10px 12px;
    font-size: 13px;
  }

  .project-card {
    padding: 12px;
  }

  .card-title {
    font-size: 16px;
  }
}

/* „Çø„ÉÉ„ÉÅ„Éá„Éê„Ç§„ÇπÂêë„Åë„Éõ„Éê„ÉºÁÑ°ÂäπÂåñ */
@media (hover: none) {
  .btn:hover,
  .project-card:hover,
  .task-item:hover {
    transform: none;
    box-shadow: inherit;
  }
}

/* ============================================
   „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£ - Accessibility
   ============================================ */

/* „Çπ„ÇØ„É™„Éº„É≥„É™„Éº„ÉÄ„ÉºÂ∞ÇÁî® */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* „Çπ„Ç≠„ÉÉ„Éó„É™„É≥„ÇØ */
.skip-link {
  position: fixed;
  top: -100px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--primary-color);
  color: white;
  padding: 12px 24px;
  border-radius: var(--radius-md);
  z-index: 10001;
  font-weight: 600;
  text-decoration: none;
  transition: top 0.3s ease;
}

.skip-link:focus {
  top: 10px;
  outline: 3px solid var(--warning-color);
  outline-offset: 2px;
}

/* „Éï„Ç©„Éº„Ç´„ÇπË°®Á§∫„ÅÆÂº∑Âåñ */
:focus-visible {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
}

button:focus-visible,
a:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
  box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
}

/* È´ò„Ç≥„É≥„Éà„É©„Çπ„Éà„É¢„Éº„ÉâÂØæÂøú */
@media (prefers-contrast: high) {
  :root {
    --text-primary: #000000;
    --text-secondary: #1a1a1a;
    --border-color: #000000;
  }

  [data-theme="dark"] {
    --text-primary: #ffffff;
    --text-secondary: #e0e0e0;
    --border-color: #ffffff;
  }

  .btn {
    border: 2px solid currentColor;
  }
}

/* Âãï„Åç„ÇíÊ∏õ„Çâ„Åô„É¢„Éº„Éâ */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }

  .loading-spinner {
    animation: none;
    border-color: var(--primary-color);
  }
}

/* ============================================
   Âç∞Âà∑„Çπ„Çø„Ç§„É´ - Print Styles
   ============================================ */
@media print {
  /* ÈùûË°®Á§∫Ë¶ÅÁ¥† */
  .header,
  .sidebar,
  .tabs-nav,
  .btn,
  button,
  .modal-overlay,
  .skip-link,
  .status-indicator,
  .toast-container {
    display: none !important;
  }

  /* Âü∫Êú¨„Çπ„Çø„Ç§„É´ */
  body {
    background: var(--bg-primary) !important;
    color: black !important;
    font-size: 12pt;
    line-height: 1.4;
  }

  /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
  .main-container,
  .app-layout,
  .main-content {
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* „Ç´„Éº„Éâ„Éª„Éó„É≠„Ç∏„Çß„ÇØ„Éà */
  .project-card {
    break-inside: avoid;
    page-break-inside: avoid;
    border: 1px solid #ccc !important;
    box-shadow: none !important;
    margin-bottom: 16pt !important;
  }

  /* „Çø„Çπ„ÇØ„É™„Çπ„Éà */
  .task-item {
    border-bottom: 1px solid #eee;
    padding: 8pt 0;
  }

  /* „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏„ÇíÁôΩÈªí„Åß */
  .status-badge {
    border: 1px solid black !important;
    background: var(--bg-primary) !important;
    color: black !important;
  }

  /* „É™„É≥„ÇØ„Å´URL„ÇíË°®Á§∫ */
  a[href^="http"]:after {
    content: " (" attr(href) ")";
    font-size: 10pt;
    color: #666;
  }

  /* „Éö„Éº„Ç∏Ë®≠ÂÆö */
  @page {
    margin: 2cm;
    size: A4;
  }

  /* „Éò„ÉÉ„ÉÄ„Éº„Éª„Éï„ÉÉ„Çø„Éº */
  .print-header {
    display: block !important;
    text-align: center;
    margin-bottom: 20pt;
    font-size: 18pt;
    font-weight: bold;
  }

  .print-footer {
    display: block !important;
    text-align: center;
    margin-top: 20pt;
    font-size: 10pt;
    color: #666;
  }
}
</style>
</head>
<body>

<!-- „Çπ„Ç≠„ÉÉ„Éó„É™„É≥„ÇØÔºà„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£Ôºâ -->
<a href="#mainContent" class="skip-link">„É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Å∏„Çπ„Ç≠„ÉÉ„Éó</a>

<!-- „É©„Ç§„Éñ„É™„Éº„Ç∏„Éß„É≥Ôºà„Çπ„ÇØ„É™„Éº„É≥„É™„Éº„ÉÄ„ÉºÁî®Ôºâ -->
<div id="liveRegion" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
<div id="loginContainer" class="login-container">
  <div class="login-card">
    <h1>ArchiDeck</h1>
    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">G„Éè„Ç¶„Çπ Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</p>
    <p>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
    <form onsubmit="signIn(); return false;" style="margin-bottom: 20px;">
      <input type="email" class="form-input" id="loginEmail" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ" style="width: 100%; margin-bottom: 12px;" inputmode="email">
      <input type="password" class="form-input" id="loginPassword" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" style="width: 100%; margin-bottom: 12px;">
      <div style="text-align: right; margin-bottom: 16px;">
        <a href="#" onclick="showForgotPassword(); return false;" style="font-size: 13px; color: var(--primary-color);">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÊñπ</a>
      </div>
      <button type="submit" class="btn btn-primary" style="width: 100%;">„É≠„Ç∞„Ç§„É≥</button>
    </form>
    <div id="forgotPasswordSection" style="display: none; margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="font-size: 13px; margin-bottom: 12px;">ÁôªÈå≤Ê∏à„Åø„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Éë„Çπ„ÉØ„Éº„ÉâÂÜçË®≠ÂÆöÁî®„ÅÆ„É™„É≥„ÇØ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô„ÄÇ</p>
      <input type="email" class="form-input" id="forgotEmail" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ" style="width: 100%; margin-bottom: 12px;">
      <button class="btn btn-primary" style="width: 100%; margin-bottom: 8px;" onclick="sendPasswordReset()">ÂÜçË®≠ÂÆö„É°„Éº„É´„ÇíÈÄÅ‰ø°</button>
      <button class="btn btn-ghost" style="width: 100%;" onclick="hideForgotPassword()">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
      <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">ÈñãÁô∫‰∏≠„ÅÆ„Åü„ÇÅ„Éë„Çπ„ÉØ„Éº„ÉâÁÑ°„Åó„Åß„É≠„Ç∞„Ç§„É≥ÂèØËÉΩ</p>
      <button class="btn btn-ghost" style="width: 100%;" onclick="enterDemoMode()">„Éë„Çπ„ÉØ„Éº„ÉâÁÑ°„Åó„ÅßÂÖ•„Çã</button>
    </div>
  </div>
</div>

<!-- „Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢ -->
<div id="accountSelectContainer" class="login-container" style="display: none;">
  <div class="login-card">
    <h1>„Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏Êäû</h1>
    <p>„ÅîÂà©Áî®„ÅÆÊ•≠Âãô„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 24px;">
      <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px;" onclick="selectAccountType('Ë®≠Ë®à')">
        üìê Ë®≠Ë®àÊãÖÂΩì
      </button>
      <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px;" onclick="selectAccountType('IC')">
        üé® ICÊãÖÂΩì
      </button>
      <button class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px; background: linear-gradient(135deg, #8bc34a, #689f38);" onclick="selectAccountType('Â§ñÊßã')">
        üå≥ Â§ñÊßãÊãÖÂΩì
      </button>
      <button class="btn btn-secondary" style="width: 100%; padding: 16px; font-size: 16px;" onclick="selectAccountType('admin')">
        üëë ÁÆ°ÁêÜËÄÖÔºàÂÖ®Ê®©ÈôêÔºâ
      </button>
    </div>
  </div>
</div>

<!-- „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ -->
<div id="mainContainer" class="main-container">
  <!-- „Éò„ÉÉ„ÉÄ„Éº -->
  <header class="header" role="banner" aria-label="„Çµ„Ç§„Éà„Éò„ÉÉ„ÉÄ„Éº">
    <div class="header-left">
      <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
      <div class="logo">ArchiDeck</div>
    </div>
    <div class="header-right">
      <div class="status-indicator status-saved" id="statusIndicator">
        <span class="status-dot"></span>
        <span id="statusText">‰øùÂ≠òÊ∏à„Åø</span>
      </div>
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="" alt="">
        <span id="userName" class="user-name"></span>
      </div>
      <div style="position: relative;">
        <button class="btn btn-ghost btn-small" onclick="toggleCategorySwitcher()" id="categorySwitchBtn" style="display: none;">
          <span id="currentCategoryLabel">üìê Ë®≠Ë®à</span> ‚ñº
        </button>
        <div id="categorySwitchMenu" class="category-switch-menu" style="display: none;">
          <button onclick="switchCategory('Ë®≠Ë®à')">üìê Ë®≠Ë®àÊãÖÂΩì</button>
          <button onclick="switchCategory('IC')">üé® ICÊãÖÂΩì</button>
          <button onclick="switchCategory('Â§ñÊßã')">üå≥ Â§ñÊßãÊãÖÂΩì</button>
          <button onclick="switchCategory('admin')">üëë ÁÆ°ÁêÜËÄÖ</button>
        </div>
      </div>
      <button class="btn btn-ghost btn-small" onclick="UndoManager.undo()" title="ÂÖÉ„Å´Êàª„Åô (Ctrl+Z)" id="undoBtn" disabled>‚Ü©Ô∏è</button>
      <button class="btn btn-ghost btn-small" onclick="UndoManager.redo()" title="„ÇÑ„ÇäÁõ¥„Åô (Ctrl+Y)" id="redoBtn" disabled>‚Ü™Ô∏è</button>
      <button class="btn btn-ghost btn-small" onclick="toggleDarkMode()" title="„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø" id="darkModeToggle">üåô</button>
      <button class="btn btn-ghost btn-small" onclick="forceReloadData()" title="„Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø">üîÑ</button>
      <button class="btn btn-ghost btn-small" onclick="showDebugInfo()" title="„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±">üîç</button>
      <button class="btn btn-ghost btn-small" onclick="signOut()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
    </div>
  </header>

  <!-- „Ç¢„Éó„É™„É¨„Ç§„Ç¢„Ç¶„Éà -->
  <div class="app-layout">
    <!-- „Çµ„Ç§„Éâ„Éê„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§Ôºà„É¢„Éê„Ç§„É´Áî®Ôºâ -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="„Çµ„Ç§„Éâ„Éê„Éº„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥">
      <div id="sidebarContent"></div>
    </aside>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <main class="main-content" id="mainContent" role="main" aria-label="„É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ">
      <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
      <nav class="tabs-nav">
        <button class="tab-nav-btn active" onclick="switchMainTab('projects', this)">üìã Ê°à‰ª∂ÁÆ°ÁêÜ</button>
        <button class="tab-nav-btn" onclick="switchMainTab('calendar', this)">üìÖ „Ç´„É¨„É≥„ÉÄ„Éº</button>
        <button class="tab-nav-btn" onclick="switchMainTab('analytics', this)">üìä ÂàÜÊûê</button>
        <button class="tab-nav-btn" onclick="switchMainTab('settings', this)">‚öôÔ∏è Ë®≠ÂÆö</button>
      </nav>

      <!-- Ê°à‰ª∂ÁÆ°ÁêÜ„Çø„Éñ -->
      <div id="projectsTab" class="tab-panel active">
        <div class="toolbar">
          <div class="toolbar-left">
            <input type="text" class="input" id="searchQuery" placeholder="Ê§úÁ¥¢... (Ctrl+K)" oninput="debouncedRenderProjects()" aria-label="Ê°à‰ª∂„ÇíÊ§úÁ¥¢">
            <select class="select" id="specFilter" onchange="renderProjects()">
              <option value="">„Åô„Åπ„Å¶„ÅÆÂïÜÂìÅ</option>
              <option>LIFE</option>
              <option>LIFE+</option>
              <option>HOURS</option>
              <option>LACIE</option>
              <option>LIFE Limited</option>
              <option>LIFE+ Limited</option>
            </select>
            <select class="select" id="archiveFilter" onchange="renderProjects()" style="margin-left: 12px;">
              <option value="active">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÅÆ„Åø</option>
              <option value="all">„Åô„Åπ„Å¶Ë°®Á§∫</option>
              <option value="archived">ÂÆå‰∫ÜÊ∏à„Åø„ÅÆ„Åø</option>
              <option value="favorites">‚òÖ „ÅäÊ∞ó„Å´ÂÖ•„Çä</option>
            </select>
          </div>
          <div class="toolbar-right">
            <div style="position: relative; display: inline-block;">
              <button id="presetBtn" class="btn btn-ghost btn-small" onclick="FilterPresets.toggleMenu()" title="‰øùÂ≠òÊ∏à„Åø„Éï„Ç£„É´„Çø„Éº">üìã „Éó„É™„Çª„ÉÉ„Éà ‚ñº</button>
              <div id="presetMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 280px; z-index: 100;">
                <div style="padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-weight: 600; font-size: 14px;">„Éï„Ç£„É´„Çø„Éº„Éó„É™„Çª„ÉÉ„Éà</span>
                  <button class="btn btn-primary btn-small" onclick="FilterPresets.showSaveModal(); document.getElementById('presetMenu').style.display='none';">+ ‰øùÂ≠ò</button>
                </div>
                <div id="presetDropdown" style="max-height: 300px; overflow-y: auto;"></div>
              </div>
            </div>
            <button class="btn btn-ghost btn-small" onclick="BatchOperations.selectAll()" title="ÂÖ®„Å¶ÈÅ∏Êäû">‚òë ÂÖ®ÈÅ∏Êäû</button>
            <button class="btn btn-ghost" onclick="DataImporter.showModal()" title="CSV/JSON„Ç§„É≥„Éù„Éº„Éà">üì• ÂèñËæº</button>
            <button class="btn btn-ghost" onclick="exportCSV()" title="CSV/JSON/Âç∞Âà∑Âá∫Âäõ">üì§ Âá∫Âäõ</button>
            <button class="btn btn-primary" onclick="openProjectModal()">+ Ê°à‰ª∂ËøΩÂä†</button>
      </div>
    </div>
    <div class="cards-container">
      <div class="cards-grid" id="projectsGrid"></div>
      <div class="empty-state" id="emptyProjects" style="display: none;">
        <div class="empty-icon">üìã</div>
        <div class="empty-title">Ê°à‰ª∂„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        <div class="empty-description">„ÄåÊ°à‰ª∂ËøΩÂä†„Äç„Éú„Çø„É≥„Åã„ÇâÊñ∞„Åó„ÅÑÊ°à‰ª∂„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        <button class="btn btn-primary" onclick="openProjectModal()">+ Ê°à‰ª∂ËøΩÂä†</button>
      </div>
    </div>
  </div>

      <!-- ÂàÜÊûê„Çø„Éñ -->
      <div id="analyticsTab" class="tab-panel">
        <div class="analytics-container">
          <!-- KPI„Ç´„Éº„Éâ -->
          <div class="kpi-grid">
            <div class="kpi-card kpi-primary">
              <div class="kpi-icon">üìä</div>
              <div class="kpi-content">
                <div class="kpi-value" id="kpiTotalProjects">0</div>
                <div class="kpi-label">Á∑èÊ°à‰ª∂Êï∞</div>
              </div>
            </div>
            <div class="kpi-card kpi-success">
              <div class="kpi-icon">‚úÖ</div>
              <div class="kpi-content">
                <div class="kpi-value" id="kpiCompletedProjects">0</div>
                <div class="kpi-label">ÂÆå‰∫ÜÊ∏à„Åø</div>
              </div>
            </div>
            <div class="kpi-card kpi-warning">
              <div class="kpi-icon">‚ö†Ô∏è</div>
              <div class="kpi-content">
                <div class="kpi-value" id="kpiAtRiskProjects">0</div>
                <div class="kpi-label">Ë¶ÅÊ≥®ÊÑèÊ°à‰ª∂</div>
              </div>
            </div>
            <div class="kpi-card kpi-info">
              <div class="kpi-icon">üìà</div>
              <div class="kpi-content">
                <div class="kpi-value" id="kpiAvgProgress">0%</div>
                <div class="kpi-label">Âπ≥ÂùáÈÄ≤ÊçóÁéá</div>
              </div>
            </div>
          </div>

          <!-- ‰∫àÊ∏¨ÂàÜÊûê„Çª„ÇØ„Ç∑„Éß„É≥ -->
          <div class="analytics-section">
            <h3 class="section-title">üîÆ AI‰∫àÊ∏¨ÂàÜÊûê</h3>
            <div class="prediction-grid" id="predictionGrid">
              <div class="prediction-card">
                <div class="prediction-header">ÈÅÖÂª∂„É™„Çπ„ÇØ‰∫àÊ∏¨</div>
                <div class="prediction-content" id="delayRiskContent">ÂàÜÊûê‰∏≠...</div>
              </div>
              <div class="prediction-card">
                <div class="prediction-header">‰ªäÈÄ±„ÅÆÊé®Â•®„Ç¢„ÇØ„Ç∑„Éß„É≥</div>
                <div class="prediction-content" id="recommendedActions">ÂàÜÊûê‰∏≠...</div>
              </div>
            </div>
          </div>

          <!-- „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà -->
          <div class="analytics-section">
            <h3 class="section-title">üìÖ „Ç¨„É≥„Éà„ÉÅ„É£„Éº„ÉàÔºàÊ°à‰ª∂„Çπ„Ç±„Ç∏„É•„Éº„É´Ôºâ</h3>
            <div class="gantt-controls">
              <button class="btn btn-small btn-ghost" onclick="ganttPrevMonth()">‚óÄ ÂâçÊúà</button>
              <span id="ganttMonthLabel" style="font-weight: 600; padding: 0 16px;"></span>
              <button class="btn btn-small btn-ghost" onclick="ganttNextMonth()">Ê¨°Êúà ‚ñ∂</button>
            </div>
            <div class="gantt-container" id="ganttChart"></div>
          </div>

          <!-- ÊãÖÂΩìËÄÖÂà•Áµ±Ë®à -->
          <div class="analytics-section">
            <h3 class="section-title">üë• ÊãÖÂΩìËÄÖÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</h3>
            <div class="performance-table-container">
              <table class="data-table" id="performanceTable">
                <thead>
                  <tr>
                    <th>ÊãÖÂΩìËÄÖ</th>
                    <th>ÊãÖÂΩìÊ°à‰ª∂Êï∞</th>
                    <th>ÂÆå‰∫ÜÊ°à‰ª∂Êï∞</th>
                    <th>Âπ≥ÂùáÈÄ≤Êçó</th>
                    <th>ÂÆå‰∫ÜÁéá</th>
                  </tr>
                </thead>
                <tbody id="performanceTableBody"></tbody>
              </table>
            </div>
          </div>

          <!-- Ëá™Âãï„É¨„Éù„Éº„ÉàÁîüÊàê -->
          <div class="analytics-section">
            <h3 class="section-title">üìù Ëá™Âãï„É¨„Éù„Éº„ÉàÁîüÊàê</h3>
            <div class="report-buttons">
              <button class="btn btn-primary" onclick="generateWeeklyReport()">üìä ÈÄ±Â†±„ÇíÁîüÊàê</button>
              <button class="btn btn-ghost" onclick="generateMonthlyReport()">üìà ÊúàÂ†±„ÇíÁîüÊàê</button>
              <button class="btn btn-ghost" onclick="exportAnalyticsCSV()">üìÅ CSVÂá∫Âäõ</button>
            </div>
            <div id="reportPreview" class="report-preview" style="display: none;"></div>
          </div>
        </div>
      </div>

      <!-- „Ç´„É¨„É≥„ÉÄ„Éº„Çø„Éñ -->
      <div id="calendarTab" class="tab-panel">
        <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="font-size: 24px; font-weight: 700;">üìÖ „Ç´„É¨„É≥„ÉÄ„Éº„Éì„É•„Éº</h2>
            <button class="btn btn-ghost" onclick="TemplateManager.showManageModal()">üìã „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ</button>
          </div>
          <p style="color: var(--text-secondary); margin-bottom: 24px;">ÊúüÈôê„ÅåË®≠ÂÆö„Åï„Çå„ÅüÊ°à‰ª∂„Çí„Ç´„É¨„É≥„ÉÄ„ÉºÂΩ¢Âºè„ÅßË°®Á§∫„Åó„Åæ„Åô„ÄÇÊ°à‰ª∂„Ç´„Éº„Éâ„ÅÆ„ÄåüìÖ ÊúüÈôêË®≠ÂÆö„Äç„Åã„ÇâÊúüÈôê„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
          <div id="calendarContainer"></div>
        </div>
      </div>

      <!-- Ë®≠ÂÆö„Çø„Éñ -->
      <div id="settingsTab" class="tab-panel">
        <!-- „Çµ„Éñ„Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <nav class="sub-tabs-nav">
          <button class="sub-tab-btn active" onclick="switchSubTab('staff', this)">üë• „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('vendors', this)">üè¢ Ê•≠ËÄÖ„Éª„É°„Éº„É´ÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('categories', this)">üè∑Ô∏è „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('tasks', this)">üìê Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('icTasks', this)">üé® ICÊ•≠ÂãôÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('exteriorTasks', this)">üå≥ Â§ñÊßãÊ•≠ÂãôÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('products', this)">üì¶ ÂïÜÂìÅÁÆ°ÁêÜ</button>
          <button class="sub-tab-btn" onclick="switchSubTab('customize', this)">üé® „Ç´„Çπ„Çø„Éû„Ç§„Ç∫</button>
          <button class="sub-tab-btn" onclick="switchSubTab('kintone', this)">üîó kintoneÈÄ£Êê∫</button>
          <button class="sub-tab-btn" onclick="switchSubTab('backup', this)">üíæ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</button>
        </nav>

        <!-- „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ -->
        <div id="staffPanel" class="sub-tab-panel active">
          <div style="max-width: 1000px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">„Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ</h2>
            <div class="form-group">
              <label class="form-label">Êñ∞„Åó„ÅÑ„Çπ„Çø„ÉÉ„Éï„ÇíËøΩÂä†</label>
              <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px;">
                <input type="text" class="form-input" id="newDesignerNameInline" placeholder="„Çπ„Çø„ÉÉ„ÉïÂêç">
                <select class="form-select" id="newDesignerCategoryInline" style="width: 150px;">
                  <option value="Ë®≠Ë®à">Ë®≠Ë®àÊãÖÂΩì</option>
                  <option value="IC">ICÊãÖÂΩì</option>
                  <option value="Â§ñÊßã">Â§ñÊßãÊãÖÂΩì</option>
                </select>
                <button class="btn btn-primary" onclick="addDesignerInline()">ËøΩÂä†</button>
              </div>
            </div>
            <div id="designerListInline" style="margin-top: 24px;"></div>
          </div>
        </div>

        <!-- Ê•≠ËÄÖÁÆ°ÁêÜ -->
        <div id="vendorsPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <div id="categoryFilters"></div>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openVendorModalV2()">+ Ê•≠ËÄÖËøΩÂä†</button>
            </div>
          </div>
          <div id="vendorsGrid" class="cards-grid"></div>
        </div>

        <!-- „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ -->
        <div id="categoriesPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">Ê•≠ËÄÖ„Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">Ê•≠ËÄÖ„ÇíÂàÜÈ°û„Åô„Çã„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†„ÉªÁ∑®ÈõÜ„ÉªÂâäÈô§„Åß„Åç„Åæ„Åô„ÄÇ</p>
            <div class="form-group">
              <label class="form-label">Êñ∞„Åó„ÅÑ„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†</label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="newCategoryNameInline" placeholder="„Ç´„ÉÜ„Ç¥„É™ÂêçÔºà‰æãÔºöÈõªÊ∞óÂ∑•‰∫ãÔºâ" style="flex: 1;">
                <button class="btn btn-primary" onclick="addCategoryInline()">ËøΩÂä†</button>
              </div>
            </div>
            <div id="categoriesGrid" style="margin-top: 32px;"></div>
          </div>
        </div>

        <!-- Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ -->
        <div id="tasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">üìê Ë®≠Ë®à„Çø„Çπ„ÇØÁÆ°ÁêÜ</h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openTaskModal('Ë®≠Ë®à')">+ Ë®≠Ë®à„Çø„Çπ„ÇØËøΩÂä†</button>
            </div>
          </div>
          <p style="margin-bottom: 16px; color: var(--text-secondary);">Ë®≠Ë®àÊãÖÂΩìËÄÖ„Åå‰ΩøÁî®„Åô„Çã„Çø„Çπ„ÇØ„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
          <div id="tasksGrid"></div>
        </div>

        <!-- ICÊ•≠ÂãôÁÆ°ÁêÜ -->
        <div id="icTasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">üé® IC„Çø„Çπ„ÇØÁÆ°ÁêÜ</h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openTaskModal('IC')">+ IC„Çø„Çπ„ÇØËøΩÂä†</button>
            </div>
          </div>
          <p style="margin-bottom: 16px; color: var(--text-secondary);">ICÊãÖÂΩìËÄÖ„Åå‰ΩøÁî®„Åô„Çã„Çø„Çπ„ÇØ„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
          <div id="icTasksGrid"></div>
        </div>

        <!-- Â§ñÊßãÊ•≠ÂãôÁÆ°ÁêÜ -->
        <div id="exteriorTasksPanel" class="sub-tab-panel">
          <div class="toolbar" style="padding-bottom: 16px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px;">
            <div class="toolbar-left">
              <h3 style="margin: 0; font-size: 18px;">üå≥ Â§ñÊßãÊ•≠Âãô„Çø„Çπ„ÇØÁÆ°ÁêÜ</h3>
            </div>
            <div class="toolbar-right">
              <button class="btn btn-primary" onclick="openExteriorTaskModal()">+ Â§ñÊßã„Çø„Çπ„ÇØËøΩÂä†</button>
            </div>
          </div>
          <p style="margin-bottom: 24px; color: var(--text-secondary);">Â§ñÊßãË®≠Ë®à„ÅÆÊ•≠Âãô„Éï„É≠„Éº„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
          <div id="exteriorTasksGrid"></div>
        </div>

        <!-- ÂïÜÂìÅÁÆ°ÁêÜ -->
        <div id="productsPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">ÂïÜÂìÅ„Éû„Çπ„ÇøÁÆ°ÁêÜ</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">Ê°à‰ª∂„ÅßÈÅ∏Êäû„Åß„Åç„ÇãÂïÜÂìÅ„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
            <div class="form-group">
              <label class="form-label">Êñ∞„Åó„ÅÑÂïÜÂìÅ„ÇíËøΩÂä†</label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="newProductNameInline" placeholder="ÂïÜÂìÅÂêçÔºà‰æãÔºöLIFE„ÄÅLIFE+„ÄÅHOURSÔºâ" style="flex: 1;">
                <button class="btn btn-primary" onclick="addProductInline()">ËøΩÂä†</button>
              </div>
            </div>
            <div id="productsGrid" style="margin-top: 32px;"></div>
          </div>
        </div>

        <!-- „Ç´„Çπ„Çø„Éû„Ç§„Ç∫ -->
        <div id="customizePanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">Â§ñË¶≥„Ç´„Çπ„Çø„Éû„Ç§„Ç∫</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">‰ºöÁ§æ„ÅÆ„Éñ„É©„É≥„Éâ„Å´Âêà„Çè„Åõ„Å¶„Ç∑„Çπ„ÉÜ„É†„ÅÆÂ§ñË¶≥„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åß„Åç„Åæ„Åô„ÄÇ„Ç≥„Éº„Éá„Ç£„É≥„Ç∞‰∏çË¶Å„ÅßÁ∞°Âçò„Å´Â§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ</p>

            <div style="display: grid; grid-template-columns: 1fr 300px; gap: 32px;">
              <div>
                <div class="form-group">
                  <label class="form-label">‰ºöÁ§æÂêç</label>
                  <input type="text" class="form-input" id="customOrgName" placeholder="‰æãÔºöÊ†™Âºè‰ºöÁ§æ„Çµ„É≥„Éó„É´Â∑•ÂãôÂ∫ó" style="width: 100%;">
                  <div class="form-hint">„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Çø„Ç§„Éà„É´„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>
                </div>

                <div class="form-group">
                  <label class="form-label">„É≠„Ç¥URL</label>
                  <input type="text" class="form-input" id="customLogoUrl" placeholder="https://example.com/logo.png" style="width: 100%;">
                  <div class="form-hint">Êé®Â•®„Çµ„Ç§„Ç∫: 150x40pxÔºàPNG/SVGÂΩ¢ÂºèÔºâ</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div class="form-group">
                    <label class="form-label">„É°„Ç§„É≥„Ç´„É©„Éº</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input type="color" id="customPrimaryColor" value="#2563EB" style="width: 50px; height: 40px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); cursor: pointer;">
                      <input type="text" class="form-input" id="customPrimaryColorText" value="#2563EB" style="flex: 1;" oninput="document.getElementById('customPrimaryColor').value = this.value">
                    </div>
                    <div class="form-hint">„Éú„Çø„É≥„ÇÑ„É™„É≥„ÇØ„ÅÆËâ≤</div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">„Ç¢„ÇØ„Çª„É≥„Éà„Ç´„É©„Éº</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input type="color" id="customSecondaryColor" value="#059669" style="width: 50px; height: 40px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); cursor: pointer;">
                      <input type="text" class="form-input" id="customSecondaryColorText" value="#059669" style="flex: 1;" oninput="document.getElementById('customSecondaryColor').value = this.value">
                    </div>
                    <div class="form-hint">ÊàêÂäüÁä∂ÊÖã„ÇÑ„Çµ„Éñ„Éú„Çø„É≥„ÅÆËâ≤</div>
                  </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                  <button class="btn btn-primary" onclick="saveCustomization()">„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Çí‰øùÂ≠ò</button>
                  <button class="btn btn-ghost" onclick="previewCustomization()">„Éó„É¨„Éì„É•„Éº</button>
                  <button class="btn btn-ghost" onclick="resetCustomization()">„É™„Çª„ÉÉ„Éà</button>
                </div>

                <div id="customizeStatus" style="margin-top: 16px;"></div>
              </div>

              <div style="padding: 20px; background: var(--bg-secondary); border-radius: var(--radius-lg); height: fit-content;">
                <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">„Éó„É¨„Éì„É•„Éº</h3>
                <div id="customizePreview" style="padding: 16px; background: var(--bg-primary); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <div id="previewLogo" style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">üè†</div>
                    <span id="previewTitle" style="font-weight: 600; font-size: 14px;">ArchiDeck</span>
                  </div>
                  <button class="btn btn-primary btn-small" style="margin-right: 8px;">„É°„Ç§„É≥„Éú„Çø„É≥</button>
                  <button class="btn btn-secondary btn-small">„Çµ„Éñ„Éú„Çø„É≥</button>
                </div>
              </div>
            </div>

            <div style="margin-top: 32px; padding: 16px; background: var(--primary-light); border-radius: var(--radius-md); border-left: 4px solid var(--primary-color);">
              <h4 style="font-size: 14px; font-weight: 600; color: var(--primary-color); margin-bottom: 8px;">„Éí„É≥„Éà</h4>
              <ul style="font-size: 13px; color: var(--text-secondary); margin: 0; padding-left: 20px;">
                <li>„É≠„Ç¥„ÅØURL„ÇíÂÖ•Âäõ„Åô„Çã„Åã„ÄÅÁîªÂÉè„Çí„Éõ„Çπ„ÉÜ„Ç£„É≥„Ç∞„Çµ„Éº„Éì„Çπ„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                <li>„Ç´„É©„Éº„ÅØ‰ºöÁ§æ„ÅÆ„Éñ„É©„É≥„Éâ„Ç´„É©„Éº„Å´Âêà„Çè„Åõ„Çã„Åì„Å®„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô</li>
                <li>Â§âÊõ¥„ÅØ„Äå„Éó„É¨„Éì„É•„Éº„Äç„ÅßÁ¢∫Ë™ç„Åó„Å¶„Åã„Çâ‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- kintoneÈÄ£Êê∫ -->
        <div id="kintonePanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">kintoneÈÄ£Êê∫Ë®≠ÂÆö</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">kintone„Å®ÈÄ£Êê∫„Åó„Å¶„ÄÅÈÇ∏Âêç„ÉªÈñìÂèñÁ¢∫ÂÆöÊó•„ÉªÁùÄÂ∑•Ë®±ÂèØ„ÉªÂ§âÊõ¥Â•ëÁ¥ÑÂâç‰ºöË≠∞„ÅÆÊÉÖÂ†±„ÇíÂêåÊúü„Åó„Åæ„Åô„ÄÇ</p>

            <div class="form-group">
              <label class="form-label">kintone „Éâ„É°„Ç§„É≥</label>
              <input type="text" class="form-input" id="kintoneDomain" placeholder="‰æãÔºöyour-company.cybozu.com" style="width: 100%;">
            </div>

            <div class="form-group">
              <label class="form-label">„Ç¢„Éó„É™ID</label>
              <input type="text" class="form-input" id="kintoneAppId" placeholder="‰æãÔºö123" style="width: 100%;">
            </div>

            <div class="form-group">
              <label class="form-label">API„Éà„Éº„ÇØ„É≥</label>
              <input type="password" class="form-input" id="kintoneApiToken" placeholder="API„Éà„Éº„ÇØ„É≥„ÇíÂÖ•Âäõ" style="width: 100%;">
              <div class="form-hint" style="font-size: 11px; margin-top: 4px;">kintone„Ç¢„Éó„É™„ÅÆË®≠ÂÆö„Åã„ÇâAPI„Éà„Éº„ÇØ„É≥„ÇíÁô∫Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            </div>

            <div style="margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
              <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">„Éï„Ç£„Éº„É´„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">ÈÇ∏Âêç„Éï„Ç£„Éº„É´„Éâ</label>
                  <input type="text" class="form-input" id="kintoneFieldCustomer" placeholder="customer_name" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">ÈñìÂèñÁ¢∫ÂÆöÊó•„Éï„Ç£„Éº„É´„Éâ</label>
                  <input type="text" class="form-input" id="kintoneFieldLayout" placeholder="layout_confirmed_date" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">ÁùÄÂ∑•Ë®±ÂèØ„Éï„Ç£„Éº„É´„Éâ</label>
                  <input type="text" class="form-input" id="kintoneFieldPermit" placeholder="construction_permit" style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 12px;">Â§âÊõ¥Â•ëÁ¥ÑÂâç‰ºöË≠∞„Éï„Ç£„Éº„É´„Éâ</label>
                  <input type="text" class="form-input" id="kintoneFieldMeeting" placeholder="pre_contract_meeting" style="width: 100%;">
                </div>
              </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button class="btn btn-primary" onclick="saveKintoneSettings()">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
              <button class="btn btn-ghost" onclick="testKintoneConnection()">Êé•Á∂ö„ÉÜ„Çπ„Éà</button>
            </div>

            <div id="kintoneStatus" style="margin-top: 16px;"></div>

            <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border-color);">
              <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">„Éá„Éº„ÇøÈÄ£Êê∫</h3>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-ghost" onclick="importFromKintone()">üì• kintone„Åã„Çâ„Ç§„É≥„Éù„Éº„ÉàÔºàCSVÔºâ</button>
                <button class="btn btn-ghost" onclick="exportToKintone()">üì§ CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
              </div>
              <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">
                kintone„Åã„Çâ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„ÅüCSV„Éï„Ç°„Ç§„É´„Çí„Ç§„É≥„Éù„Éº„Éà„Åß„Åç„Åæ„Åô„ÄÇ<br>
                È°ßÂÆ¢Âêç/ÈÇ∏Âêç„ÄÅÂª∫ÁØâÂú∞„ÄÅ„É¨„Ç≥„Éº„ÉâID„Ç´„É©„É†„ÅåËá™ÂãïË™çË≠ò„Åï„Çå„Åæ„Åô„ÄÇ
              </p>
            </div>
          </div>
        </div>

        <!-- „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó -->
        <div id="backupPanel" class="sub-tab-panel">
          <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700;">„Éá„Éº„Çø„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</h2>
            <p style="margin-bottom: 32px; color: var(--text-secondary);">„Ç∑„Çπ„ÉÜ„É†ÂÖ®‰Ωì„ÅÆ„Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÉªÂæ©ÂÖÉ„Åß„Åç„Åæ„Åô„ÄÇËá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇÇÂà©Áî®ÂèØËÉΩ„Åß„Åô„ÄÇ</p>

            <!-- Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóË®≠ÂÆö -->
            <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #e0f2fe, #dbeafe); border-radius: var(--radius-md);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <div>
                  <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 4px;">üîÑ Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</h3>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">„Éá„Éº„ÇøÂ§âÊõ¥ÊôÇ„Å´Ëá™Âãï„Åß„É≠„Éº„Ç´„É´„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰øùÂ≠ò„Åó„Åæ„Åô</p>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px;">
                <div>ÊúÄÁµÇ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó: <strong id="lastBackupTime">-</strong></div>
                <div>„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ª∂Êï∞: <strong id="localBackupCount">0</strong>‰ª∂</div>
                <button class="btn btn-secondary btn-small" onclick="downloadLocalBackup()">„É≠„Éº„Ç´„É´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
              <div style="padding: 24px; background: var(--bg-secondary); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">ÂÖ®„Éá„Éº„Çø„ÇíJSON„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô</p>
                <button class="btn btn-primary" onclick="createBackup()">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê</button>
              </div>

              <div style="padding: 24px; background: var(--bg-secondary); border-radius: var(--radius-md); text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">üì•</div>
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂæ©ÂÖÉ</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">JSON„Éï„Ç°„Ç§„É´„Åã„Çâ„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô</p>
                <button class="btn btn-ghost" onclick="restoreBackup()">Âæ©ÂÖÉ„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</button>
              </div>
            </div>

            <div style="margin-top: 32px; padding: 16px; background: rgba(245, 166, 35, 0.1); border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
              <h4 style="font-size: 14px; font-weight: 600; color: var(--warning-color); margin-bottom: 8px;">‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ†Ö</h4>
              <ul style="font-size: 13px; color: var(--text-secondary); margin: 0; padding-left: 20px;">
                <li>Âæ©ÂÖÉ„ÇíË°å„ÅÜ„Å®Êó¢Â≠ò„Éá„Éº„Çø„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô</li>
                <li>Âæ©ÂÖÉÂâç„Å´ÂøÖ„ÅöÁèæÂú®„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                <li>„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„ÅØÂÆâÂÖ®„Å™Â†¥ÊâÄ„Å´‰øùÁÆ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                <li>Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅØ„Éñ„É©„Ç¶„Ç∂„ÅÆ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„ÅôÔºàÊúÄÂ§ß5MBÔºâ</li>
              </ul>
            </div>

            <div id="backupStatus" style="margin-top: 24px;"></div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´ÔºöÊ°à‰ª∂ËøΩÂä†/Á∑®ÈõÜ -->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="projectModalTitle">Ê°à‰ª∂ËøΩÂä†</h2>
      <button class="close" onclick="closeProjectModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">„ÅäÂÆ¢ÊßòÂêç *</label>
        <input type="text" class="form-input" id="projectCustomer" placeholder="‰æãÔºöÁî∞‰∏≠Â§™ÈÉéÊßò">
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
        <div class="form-group">
          <label class="form-label">ÊãÖÂΩìÔºàË®≠Ë®àÔºâ *</label>
          <select class="form-select" id="projectAssignedTo"></select>
        </div>
        <div class="form-group">
          <label class="form-label">ÊãÖÂΩìÔºàICÔºâ</label>
          <select class="form-select" id="projectIcAssignee">
            <option value="">Êú™ÂÆö</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ÊãÖÂΩìÔºàÂ§ñÊßãÔºâ</label>
          <select class="form-select" id="projectExteriorAssignee">
            <option value="">Êú™ÂÆö</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ÂïÜÂìÅ</label>
        <select class="form-select" id="projectSpecifications"></select>
      </div>
      <div class="form-group">
        <label class="form-label">„É°„É¢</label>
        <textarea class="form-textarea" id="projectMemo" placeholder="Ë¶ÅÊúõ„ÉªÊ≥®ÊÑèÁÇπ„Å™„Å©"></textarea>
      </div>
    </div>
    <div class="modal-footer" style="display: flex; justify-content: space-between;">
      <div id="templateButtons" style="display: none;">
        <button class="btn btn-ghost btn-small" onclick="TemplateManager.createFromProject(editingProjectId)" title="ÁèæÂú®„ÅÆË®≠ÂÆö„Çí„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å®„Åó„Å¶‰øùÂ≠ò">üìã „ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò</button>
        <button class="btn btn-ghost btn-small" onclick="TemplateManager.showSelectModal(editingProjectId)" title="‰øùÂ≠òÊ∏à„Åø„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ©Áî®">üìã „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ©Áî®</button>
      </div>
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-ghost" onclick="closeProjectModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn btn-primary" onclick="saveProject()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´Ôºö„É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„ÉàËøΩÂä†/Á∑®ÈõÜ -->
<div id="templateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="templateModalTitle">„ÉÜ„É≥„Éó„É¨„Éº„ÉàËøΩÂä†</h2>
      <button class="close" onclick="closeTemplateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">„ÉÜ„É≥„Éó„É¨„Éº„ÉàID *</label>
        <input type="text" class="form-input" id="templateId" placeholder="‰æãÔºönew-template">
        <div class="form-hint">Ëã±Êï∞Â≠ó„Å®„Éè„Ç§„Éï„É≥„ÅÆ„Åø‰ΩøÁî®ÂèØËÉΩ</div>
      </div>
      <div class="form-group">
        <label class="form-label">Ë°®Á§∫Âêç *</label>
        <input type="text" class="form-input" id="templateDisplayName" placeholder="‰æãÔºöÊñ∞‰ºöÁ§æÂêçÔºà‰ΩúÊ•≠ÂÜÖÂÆπÔºâ">
      </div>
      <div class="form-group">
        <label class="form-label">„Ç´„ÉÜ„Ç¥„É™ *</label>
        <select class="form-select" id="templateCategory">
          <option value="Ë®≠Ë®à">Ë®≠Ë®à</option>
          <option value="IC">IC</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">‰ºöÁ§æÂêç *</label>
        <input type="text" class="form-input" id="templateCompany" placeholder="‰æãÔºöÊ†™Âºè‰ºöÁ§æ„Äá„Äá">
      </div>
      <div class="form-group">
        <label class="form-label">ÂÆõÂÖàÂêç</label>
        <input type="text" class="form-input" id="templateContact" placeholder="‰æãÔºöÁî∞‰∏≠Êßò">
      </div>
      <div class="form-group">
        <label class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
        <input type="text" class="form-input" id="templateEmail" placeholder="‰æãÔºötanaka@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">‰ª∂Âêç„Éï„Ç©„Éº„Éû„ÉÉ„Éà *</label>
        <input type="text" class="form-input" id="templateSubjectFormat" placeholder="‰æãÔºö{customerName}Êßò Êñ∞Ë¶è„Äá„Äá‰ΩúÊàê‰æùÈ†º„ÄÄÊúüÊó•{dueDate}">
        <div class="form-hint">‰ΩøÁî®ÂèØËÉΩÔºö{customerName}, {dueDate}, {staffName}</div>
      </div>
      <div class="form-group">
        <label class="form-label">„É°„Éº„É´Êú¨Êñá *</label>
        <textarea class="form-textarea" id="templateText" rows="10" placeholder="‰æã:&#10;{company}&#10;{contact}&#10;&#10;„ÅÑ„Å§„ÇÇ„Åä‰∏ñË©±„Å´„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ"></textarea>
        <div class="form-hint">‰ΩøÁî®ÂèØËÉΩÔºö{company}, {contact}, {customerName}, {dueDate}, {staffName}, {specialContent}</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTemplateModal()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary" onclick="saveTemplate()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´Ôºö„Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ -->
<div id="designerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">„Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ</h2>
      <button class="close" onclick="closeDesignerModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Êñ∞„Åó„ÅÑ„Çπ„Çø„ÉÉ„Éï„ÇíËøΩÂä†</label>
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px;">
          <input type="text" class="form-input" id="newDesignerName" placeholder="„Çπ„Çø„ÉÉ„ÉïÂêç">
          <select class="form-select" id="newDesignerCategory" style="width: 150px;">
            <option value="Ë®≠Ë®à">Ë®≠Ë®àÊãÖÂΩì</option>
            <option value="IC">ICÊãÖÂΩì</option>
          </select>
          <button class="btn btn-primary" onclick="addDesigner()">ËøΩÂä†</button>
        </div>
      </div>
      <div id="designerList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeDesignerModal()">ÂÆå‰∫Ü</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´Ôºö„É°„Éº„É´‰ΩúÊàê -->
<div id="emailModal" class="modal">
  <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
      <h2 class="modal-title">üìß „É°„Éº„É´‰ΩúÊàê</h2>
      <button class="close" onclick="closeEmailModal()">&times;</button>
    </div>
    <div class="modal-body" id="emailComposerContent"></div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´ÔºöÊ•≠ËÄÖËøΩÂä†/Á∑®ÈõÜV2 -->
<div id="vendorModalV2" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title" id="vendorModalTitle">Ê•≠ËÄÖËøΩÂä†</h2>
      <button class="close" onclick="closeVendorModalV2()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="vendorForm">
        <input type="hidden" id="vendorId">

        <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Âü∫Êú¨ÊÉÖÂ†±</h3>

        <div class="form-group">
          <label class="form-label">‰ºöÁ§æÂêç *</label>
          <input type="text" class="form-input" id="vendorCompany" placeholder="‰æãÔºöÊ†™Âºè‰ºöÁ§æ„Äá„Äá" required>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">ÊãÖÂΩìËÄÖÂêç</label>
            <input type="text" class="form-input" id="vendorContact" placeholder="‰æãÔºöÁî∞‰∏≠Êßò">
          </div>

          <div class="form-group">
            <label class="form-label">ÈõªË©±Áï™Âè∑</label>
            <input type="text" class="form-input" id="vendorTel" placeholder="‰æãÔºö090-1234-5678">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
            <input type="email" class="form-input" id="vendorEmail" placeholder="‰æãÔºötanaka@example.com">
          </div>

          <div class="form-group">
            <label class="form-label">„Ç´„ÉÜ„Ç¥„É™</label>
            <select class="form-select" id="vendorCategory"></select>
          </div>
        </div>

        <h3 style="margin: 24px 0 16px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">„É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà</h3>

        <div class="form-group">
          <label class="form-label">‰ª∂Âêç„Éï„Ç©„Éº„Éû„ÉÉ„Éà</label>
          <input type="text" class="form-input" id="vendorSubject" placeholder="‰æãÔºö{customerName}Êßò Êñ∞Ë¶è„Äá„Äá‰ΩúÊàê‰æùÈ†º„ÄÄÊúüÊó•{dueDate}">
          <div class="form-hint">‰ΩøÁî®ÂèØËÉΩÔºö{customerName}, {dueDate}, {staffName}</div>
        </div>

        <div class="form-group">
          <label class="form-label">„É°„Éº„É´Êú¨Êñá</label>
          <textarea class="form-textarea" id="vendorTemplate" rows="8" placeholder="‰æã:&#10;{company}&#10;{contact}&#10;&#10;„ÅÑ„Å§„ÇÇ„Åä‰∏ñË©±„Å´„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ"></textarea>
          <div class="form-hint">‰ΩøÁî®ÂèØËÉΩÔºö{company}, {contact}, {customerName}, {dueDate}, {staffName}</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeVendorModalV2()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary" onclick="saveVendorV2()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´ÔºöÊãÖÂΩìËÄÖ„Çø„Çπ„ÇØ‰∏ÄË¶ß -->
<div id="staffTasksModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="staffTasksModalTitle">„Çø„Çπ„ÇØ‰∏ÄË¶ß</h2>
      <button class="close" onclick="closeStaffTasksModal()">&times;</button>
    </div>
    <div class="modal-body task-list-modal">
      <div style="margin-bottom: 16px; display: flex; gap: 8px;">
        <button class="btn btn-small btn-ghost" id="sortByDueBtn" onclick="sortTasksBy('due')">ÊúüÈôêÈ†Ü</button>
        <button class="btn btn-small btn-ghost" id="sortByProjectBtn" onclick="sortTasksBy('project')">ÈÇ∏ÂêçÈ†Ü</button>
      </div>
      <div id="staffTasksList"></div>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´Ôºö„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†/Á∑®ÈõÜ -->
<div id="categoryModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="categoryModalTitle">„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†</h2>
      <button class="close" onclick="closeCategoryModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="categoryForm">
        <input type="hidden" id="categoryId">

        <div class="form-group">
          <label class="form-label">„Ç´„ÉÜ„Ç¥„É™Âêç *</label>
          <input type="text" class="form-input" id="categoryName" placeholder="‰æãÔºöË®≠ÂÇô" required>
        </div>

        <div class="form-group">
          <label class="form-label">Ë°®Á§∫È†Ü</label>
          <input type="number" class="form-input" id="categoryOrder" placeholder="1" min="1">
          <div class="form-hint">Â∞è„Åï„ÅÑÊï∞Â≠ó„Åª„Å©ÂÖà„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeCategoryModal()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary" onclick="saveCategory()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´Ôºö„Çø„Çπ„ÇØËøΩÂä†/Á∑®ÈõÜ -->
<div id="taskModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="taskModalTitle">„Çø„Çπ„ÇØËøΩÂä†</h2>
      <button class="close" onclick="closeTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="taskForm">
        <input type="hidden" id="taskId">
        <input type="hidden" id="taskKey">

        <div class="form-group">
          <label class="form-label">„Çø„Çπ„ÇØÂêç *</label>
          <input type="text" class="form-input" id="taskName" placeholder="‰æãÔºö0ÂõûÁõÆÊâìÂêà„Åõ" required>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label class="form-label">„Ç´„ÉÜ„Ç¥„É™ *</label>
            <select class="form-select" id="taskCategory" required>
              <option value="Ë®≠Ë®à">Ë®≠Ë®à</option>
              <option value="IC">IC</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Ë°®Á§∫È†Ü</label>
            <input type="number" class="form-input" id="taskOrder" placeholder="1" min="1">
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="taskHasState" onchange="toggleTaskState()">
            <span>Áä∂ÊÖãÁÆ°ÁêÜ„ÇíÊúâÂäπ„Å´„Åô„Çã</span>
          </label>
          <div class="form-hint">„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Å®„Äå‰æùÈ†ºÊ∏à„Äç„Äå‰øùÂ≠òÊ∏à„Äç„Å™„Å©„ÅÆÁä∂ÊÖã„ÇíÈÅ∏ÊäûÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô</div>
        </div>

        <div id="stateOptionsGroup" style="display: none;">
          <div class="form-group">
            <label class="form-label">Áä∂ÊÖã„Ç™„Éó„Ç∑„Éß„É≥ÔºàJSONÈÖçÂàóÔºâ</label>
            <input type="text" class="form-input" id="taskStateOptions" placeholder='‰æãÔºö["", "‰æùÈ†ºÊ∏à", "‰øùÂ≠òÊ∏à"]'>
            <div class="form-hint">JSONÈÖçÂàóÂΩ¢Âºè„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊúÄÂàù„ÅÆË¶ÅÁ¥†„ÅØÁ©∫ÊñáÂ≠óÂàó("")„ÇíÊé®Â•®</div>
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="taskHasEmailButton">
            <span>üìß „É°„Éº„É´‰ΩúÊàê„Éú„Çø„É≥„ÇíË°®Á§∫„Åô„Çã</span>
          </label>
          <div class="form-hint">„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Å®Ê°à‰ª∂„Ç´„Éº„Éâ„ÅÆ„Çø„Çπ„ÇØ„Å´üìß„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>
        </div>

        <div class="form-group">
          <label class="form-label">Á¥ê„Å•„ÅëÊ•≠ËÄÖÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</label>
          <div id="taskVendorSelection" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
            <!-- „Éô„É≥„ÉÄ„Éº„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
          </div>
          <div class="form-hint">„Åì„ÅÆ„Çø„Çπ„ÇØ„Åã„ÇâÁõ¥Êé•„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åô„ÇãÊ•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeTaskModal()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary" onclick="saveTask()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- „É¢„Éº„ÉÄ„É´Ôºö„Çπ„Çø„ÉÉ„ÉïË™çË®ºË®≠ÂÆö -->
<div id="designerAuthModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h2 class="modal-title">üîë „Çπ„Çø„ÉÉ„ÉïË™çË®ºË®≠ÂÆö</h2>
      <button class="close" onclick="closeDesignerAuthModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="designerAuthForm">
        <input type="hidden" id="authDesignerId">

        <div class="form-group">
          <label class="form-label">„Çπ„Çø„ÉÉ„ÉïÂêç</label>
          <input type="text" class="form-input" id="authDesignerName" disabled>
        </div>

        <div class="form-group">
          <label class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÔºà„É≠„Ç∞„Ç§„É≥IDÔºâ *</label>
          <input type="email" class="form-input" id="authDesignerEmail" placeholder="‰æãÔºöyamada@ghouse.jp" required>
          <div class="form-hint">„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åß„É≠„Ç∞„Ç§„É≥„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô</div>
        </div>

        <div class="form-group">
          <label class="form-label">„Éë„Çπ„ÉØ„Éº„Éâ *</label>
          <input type="password" class="form-input" id="authDesignerPassword" placeholder="8ÊñáÂ≠ó‰ª•‰∏ä" required>
          <div class="form-hint">8ÊñáÂ≠ó‰ª•‰∏ä„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        </div>

        <div class="form-group">
          <label class="form-label">„Éë„Çπ„ÉØ„Éº„ÉâÔºàÁ¢∫Ë™çÔºâ *</label>
          <input type="password" class="form-input" id="authDesignerPasswordConfirm" placeholder="„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÂÖ•Âäõ">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeDesignerAuthModal()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn btn-primary" onclick="saveDesignerAuth()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- „Éà„Éº„Çπ„ÉàÈÄöÁü• -->
<div id="toast" class="toast"></div>

<script>
// ============================================
// „Éê„Éº„Ç∏„Éß„É≥ÁÆ°ÁêÜ & „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢
// ============================================
const APP_VERSION = '4.11.0-' + Date.now();
console.log('üöÄ ArchiDeck „Éê„Éº„Ç∏„Éß„É≥:', APP_VERSION);

// Ëµ∑ÂãïÊôÇ„Å´„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂº∑Âà∂„ÇØ„É™„Ç¢
(async function forceClearCache() {
  try {
    // Service Worker „ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
    const cacheNames = await caches.keys();
    for (const name of cacheNames) {
      await caches.delete(name);
      console.log('üóëÔ∏è „Ç≠„É£„ÉÉ„Ç∑„É•ÂâäÈô§:', name);
    }

    // Service Worker „ÇíÊõ¥Êñ∞
    if ('serviceWorker' in navigator) {
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const reg of registrations) {
        await reg.update();
        console.log('üîÑ Service Worker Êõ¥Êñ∞');
      }
    }
    console.log('‚úÖ „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ÂÆå‰∫Ü');
  } catch (e) {
    console.log('„Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢„Ç®„É©„ÉºÔºàÁÑ°Ë¶ñÂèØÔºâ:', e);
  }
})();

// ============================================
// „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
// ============================================

// „Éá„Éê„Ç¶„É≥„ÇπÈñ¢Êï∞ - ÈÄ£Á∂öÂëº„Å≥Âá∫„Åó„ÇíÂà∂Èôê
function debounce(func, wait = 300) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// „Çπ„É≠„ÉÉ„Éà„É´Èñ¢Êï∞ - ‰∏ÄÂÆöÈñìÈöî„ÅßÂÆüË°å„ÇíÂà∂Èôê
function throttle(func, limit = 100) {
  let inThrottle;
  return function(...args) {
    if (!inThrottle) {
      func.apply(this, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}

// „É°„É¢ÂåñÈñ¢Êï∞ - ÁµêÊûú„Çí„Ç≠„É£„ÉÉ„Ç∑„É•
function memoize(fn, ttl = 60000) {
  const cache = new Map();
  return function(...args) {
    const key = JSON.stringify(args);
    const cached = cache.get(key);
    if (cached && Date.now() - cached.time < ttl) {
      return cached.value;
    }
    const result = fn.apply(this, args);
    cache.set(key, { value: result, time: Date.now() });
    return result;
  };
}

// „É™„ÇØ„Ç®„Çπ„Éà„Ç¢„Ç§„Éâ„É´„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÔºà„Éù„É™„Éï„Ç£„É´‰ªò„ÅçÔºâ
const requestIdleCallback = window.requestIdleCallback || function(cb) {
  const start = Date.now();
  return setTimeout(() => {
    cb({
      didTimeout: false,
      timeRemaining: () => Math.max(0, 50 - (Date.now() - start))
    });
  }, 1);
};

// „Éá„Éê„Ç¶„É≥„ÇπÊ∏à„ÅøÊ§úÁ¥¢Èñ¢Êï∞
const debouncedRenderProjects = debounce(() => {
  renderProjects();
}, 250);

// ============================================
// Undo/Redo ÁÆ°ÁêÜ
// ============================================
const UndoManager = {
  history: [],
  redoStack: [],
  maxHistory: 50,
  isUndoing: false,

  // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË®òÈå≤
  record(action) {
    if (this.isUndoing) return;

    this.history.push({
      ...action,
      timestamp: Date.now()
    });

    // Â±•Ê≠¥„ÅÆ‰∏äÈôê„ÇíË∂Ö„Åà„Åü„ÇâÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂâäÈô§
    if (this.history.length > this.maxHistory) {
      this.history.shift();
    }

    // Êñ∞„Åó„ÅÑ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅåË®òÈå≤„Åï„Çå„Åü„ÇâRedo„Çπ„Çø„ÉÉ„ÇØ„Çí„ÇØ„É™„Ç¢
    this.redoStack = [];

    this.updateUI();
    console.log(`üìù Êìç‰ΩúË®òÈå≤: ${action.description}`, action);
  },

  // ÂÖÉ„Å´Êàª„Åô
  async undo() {
    if (this.history.length === 0) {
      showToast('ÂÖÉ„Å´Êàª„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'info');
      return;
    }

    this.isUndoing = true;

    try {
      const action = this.history.pop();
      this.redoStack.push(action);

      await this.revert(action);

      showToast(`‚Ü©Ô∏è ÂÖÉ„Å´Êàª„Åó„Åæ„Åó„Åü: ${action.description}`, 'success');
      announceToScreenReader(`ÂÖÉ„Å´Êàª„Åó„Åæ„Åó„Åü: ${action.description}`);
    } catch (error) {
      console.error('UndoÂ§±Êïó:', error);
      showToast('ÂÖÉ„Å´Êàª„ÅôÊìç‰Ωú„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    } finally {
      this.isUndoing = false;
      this.updateUI();
    }
  },

  // „ÇÑ„ÇäÁõ¥„Åô
  async redo() {
    if (this.redoStack.length === 0) {
      showToast('„ÇÑ„ÇäÁõ¥„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'info');
      return;
    }

    this.isUndoing = true;

    try {
      const action = this.redoStack.pop();
      this.history.push(action);

      await this.apply(action);

      showToast(`‚Ü™Ô∏è „ÇÑ„ÇäÁõ¥„Åó„Åæ„Åó„Åü: ${action.description}`, 'success');
      announceToScreenReader(`„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åó„Åü: ${action.description}`);
    } catch (error) {
      console.error('RedoÂ§±Êïó:', error);
      showToast('„ÇÑ„ÇäÁõ¥„ÅôÊìç‰Ωú„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    } finally {
      this.isUndoing = false;
      this.updateUI();
    }
  },

  // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÖÉ„Å´Êàª„Åô
  async revert(action) {
    switch (action.type) {
      case 'UPDATE_PROJECT':
        await supabase
          .from('projects')
          .update(action.oldValue)
          .eq('id', action.projectId);
        // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
        const projectIdx = projects.findIndex(p => p.id === action.projectId);
        if (projectIdx !== -1) {
          Object.assign(projects[projectIdx], action.oldValue);
        }
        renderProjects();
        break;

      case 'UPDATE_TASK':
        const proj = projects.find(p => p.id === action.projectId);
        if (proj && proj.tasks) {
          proj.tasks[action.taskKey] = { ...action.oldValue };
          await supabase
            .from('projects')
            .update({ tasks: proj.tasks })
            .eq('id', action.projectId);
        }
        renderProjects();
        break;

      case 'CREATE_PROJECT':
        await supabase.from('projects').delete().eq('id', action.projectId);
        projects = projects.filter(p => p.id !== action.projectId);
        renderProjects();
        renderSidebar();
        break;

      case 'DELETE_PROJECT':
        const { data } = await supabase
          .from('projects')
          .insert(action.oldValue)
          .select()
          .single();
        if (data) {
          projects.push(data);
        }
        renderProjects();
        renderSidebar();
        break;

      case 'ARCHIVE_PROJECT':
        await supabase
          .from('projects')
          .update({ is_archived: action.oldValue })
          .eq('id', action.projectId);
        const archiveIdx = projects.findIndex(p => p.id === action.projectId);
        if (archiveIdx !== -1) {
          projects[archiveIdx].is_archived = action.oldValue;
        }
        renderProjects();
        renderSidebar();
        break;

      default:
        console.warn('Êú™ÂØæÂøú„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éó:', action.type);
    }
  },

  // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÜçÈÅ©Áî®
  async apply(action) {
    switch (action.type) {
      case 'UPDATE_PROJECT':
        await supabase
          .from('projects')
          .update(action.newValue)
          .eq('id', action.projectId);
        const projectIdx = projects.findIndex(p => p.id === action.projectId);
        if (projectIdx !== -1) {
          Object.assign(projects[projectIdx], action.newValue);
        }
        renderProjects();
        break;

      case 'UPDATE_TASK':
        const proj = projects.find(p => p.id === action.projectId);
        if (proj && proj.tasks) {
          proj.tasks[action.taskKey] = { ...action.newValue };
          await supabase
            .from('projects')
            .update({ tasks: proj.tasks })
            .eq('id', action.projectId);
        }
        renderProjects();
        break;

      case 'CREATE_PROJECT':
        const { data } = await supabase
          .from('projects')
          .insert(action.newValue)
          .select()
          .single();
        if (data) {
          projects.push(data);
        }
        renderProjects();
        renderSidebar();
        break;

      case 'DELETE_PROJECT':
        await supabase.from('projects').delete().eq('id', action.projectId);
        projects = projects.filter(p => p.id !== action.projectId);
        renderProjects();
        renderSidebar();
        break;

      case 'ARCHIVE_PROJECT':
        await supabase
          .from('projects')
          .update({ is_archived: action.newValue })
          .eq('id', action.projectId);
        const archiveIdx = projects.findIndex(p => p.id === action.projectId);
        if (archiveIdx !== -1) {
          projects[archiveIdx].is_archived = action.newValue;
        }
        renderProjects();
        renderSidebar();
        break;

      default:
        console.warn('Êú™ÂØæÂøú„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éó:', action.type);
    }
  },

  // UIÊõ¥Êñ∞
  updateUI() {
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');

    if (undoBtn) {
      undoBtn.disabled = this.history.length === 0;
      undoBtn.title = this.history.length > 0
        ? `ÂÖÉ„Å´Êàª„Åô: ${this.history[this.history.length - 1].description}`
        : 'ÂÖÉ„Å´Êàª„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
    }

    if (redoBtn) {
      redoBtn.disabled = this.redoStack.length === 0;
      redoBtn.title = this.redoStack.length > 0
        ? `„ÇÑ„ÇäÁõ¥„Åô: ${this.redoStack[this.redoStack.length - 1].description}`
        : '„ÇÑ„ÇäÁõ¥„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
    }
  },

  // Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢
  clear() {
    this.history = [];
    this.redoStack = [];
    this.updateUI();
  },

  // Êìç‰ΩúÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  canUndo() {
    return this.history.length > 0;
  },

  canRedo() {
    return this.redoStack.length > 0;
  }
};

// ============================================
// SupabaseÂàùÊúüÂåñ
// ============================================
const SUPABASE_URL = 'https://twzsirpfudqwboeyakta.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3enNpcnBmdWRxd2JvZXlha3RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MzM4NjgsImV4cCI6MjA3NzAwOTg2OH0.E_8GxfsO6Scjc0dDoEoyxq3i4lfvNxYZvnSL1OlSDSM';

// Supabase CDN„ÅÆ„É≠„Éº„ÉâÁ¢∫Ë™ç
if (!window.supabase) {
  console.error('‚ùå Supabase CDN „ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºÅ');
  alert('Supabase CDN „ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
}

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
console.log('‚úÖ SupabaseÂàùÊúüÂåñÂÆå‰∫Ü:', SUPABASE_URL);

// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
let currentUser = null;
let currentDesigner = null;
let currentUserCategory = null; // 'admin' | 'Ë®≠Ë®à' | 'IC'
let projects = [];
let designers = [];
let emailTemplates = [];
let vendors = [];
let taskMappings = {};
let currentDesignerTab = 'ALL';
let editingProjectId = null;
let editingTemplateId = null;
let editingVendorId = null;

// Êñ∞„Ç∑„Çπ„ÉÜ„É†Áî®Â§âÊï∞
let vendorCategories = [];
let tasksV2 = [];
let vendorsV2 = [];
let taskVendorMappings = [];
let products = [];

// „Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÂØæÂøúÔºàSaaSÁâàÔºâ
let currentOrganization = null;
let currentSubscription = null;

// FC„É¢„Éº„ÉâÔºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫Âêë„Åë„Éõ„ÉØ„Ç§„Éà„É©„Éô„É´Ôºâ
let isFCMode = false;
let fcSlug = null;
let organizationSettings = null;

// ÁµÑÁπîÊÉÖÂ†±„ÇíË™≠„ÅøËæº„ÇÄ
async function loadOrganization() {
  try {
    const { data: memberData } = await supabase
      .from('organization_members')
      .select('organization_id')
      .eq('user_id', currentUser.id)
      .eq('status', 'active')
      .single();

    if (memberData) {
      const { data: orgData } = await supabase
        .from('organizations')
        .select('*')
        .eq('id', memberData.organization_id)
        .single();

      if (orgData) {
        currentOrganization = orgData;
        applyWhiteLabel(orgData);

        // „Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥ÊÉÖÂ†±
        const { data: subData } = await supabase
          .from('subscriptions')
          .select('*')
          .eq('organization_id', orgData.id)
          .single();

        currentSubscription = subData;
        checkSubscriptionStatus(subData);
      }
    }
  } catch (error) {
    console.log('ÁµÑÁπîÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºà„ÉÜ„Éº„Éñ„É´Êú™‰ΩúÊàê„ÅÆÂèØËÉΩÊÄßÔºâ');
  }
}

// „Éõ„ÉØ„Ç§„Éà„É©„Éô„É´ÈÅ©Áî®
function applyWhiteLabel(org) {
  if (!org) return;

  // „É≠„Ç¥Â§âÊõ¥
  if (org.logo_url) {
    const logoElements = document.querySelectorAll('.logo, .sidebar-logo');
    logoElements.forEach(el => {
      if (el.tagName === 'IMG') {
        el.src = org.logo_url;
      }
    });
  }

  // „Ç´„É©„ÉºÂ§âÊõ¥
  if (org.primary_color) {
    document.documentElement.style.setProperty('--primary-color', org.primary_color);
  }
  if (org.secondary_color) {
    document.documentElement.style.setProperty('--secondary-color', org.secondary_color);
  }

  // „Çø„Ç§„Éà„É´Â§âÊõ¥
  if (org.name) {
    document.title = `ArchiDeck | ${org.name}`;
  }
}

// „Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
function checkSubscriptionStatus(sub) {
  if (!sub) return;

  if (sub.status === 'trial') {
    const trialEnd = new Date(sub.trial_ends_at);
    const now = new Date();
    const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));

    if (daysLeft <= 3 && daysLeft > 0) {
      showToast(`„Éà„É©„Ç§„Ç¢„É´ÊúüÈñì„Åå„ÅÇ„Å®${daysLeft}Êó•„ÅßÁµÇ‰∫Ü„Åó„Åæ„Åô`, 'warning');
    } else if (daysLeft <= 0) {
      showToast('„Éà„É©„Ç§„Ç¢„É´ÊúüÈñì„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„Éó„É©„É≥„Çí„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
    }
  } else if (sub.status === 'past_due') {
    showToast('„ÅäÊîØÊâï„ÅÑ„ÅåÈÅÖÂª∂„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÁÆ°ÁêÜÁîªÈù¢„ÅßÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
  }
}

// ÁÑ°Èôê„É´„Éº„ÉóÈò≤Ê≠¢„Éï„É©„Ç∞
let isHandlingHashChange = false;

// ÊãÖÂΩìËÄÖ„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´Âøú„Åò„Åü„Çø„Çπ„ÇØ„É™„Çπ„Éà„ÇíÂèñÂæóÔºàÊñ∞„Ç∑„Çπ„ÉÜ„É†Ôºâ
function getTasksForAssignee(assigneeName) {
  const designer = designers.find(d => d.name === assigneeName);
  const category = designer?.category || 'Ë®≠Ë®à';

  // tasksV2„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÁ©∫ÈÖçÂàó„ÇíËøî„Åô
  if (!tasksV2 || tasksV2.length === 0) {
    console.warn('‚ö†Ô∏è tasksV2„ÉÜ„Éº„Éñ„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇmigration_customizable_system.sql„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    return [];
  }

  return tasksV2.filter(t => t.category === category).sort((a, b) => a.display_order - b.display_order);
}

// „Çø„Çπ„ÇØ„ÅÆÁä∂ÊÖã„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂèñÂæóÔºàÊñ∞„Ç∑„Çπ„ÉÜ„É†Ôºâ
function getTaskStateOptions(taskKey) {
  const task = tasksV2.find(t => t.task_key === taskKey);
  if (!task || !task.has_state || !task.state_options) return null;
  return task.state_options;
}

// ============================================
// Ë™çË®ºÂá¶ÁêÜ
// ============================================

// „Éá„É¢„É¢„Éº„ÉâÔºà„Éë„Çπ„ÉØ„Éº„ÉâÁÑ°„Åó„Åß„É≠„Ç∞„Ç§„É≥Ôºâ
function enterDemoMode() {
  console.log('üé≠ „Éá„É¢„É¢„Éº„Éâ„ÅßÂÖ•Â†¥...');
  document.getElementById('loginContainer').style.display = 'none';
  document.getElementById('accountSelectContainer').style.display = 'flex';
  isDemoMode = true;
}

// „Éá„É¢„É¢„Éº„Éâ„Éï„É©„Ç∞
let isDemoMode = false;

// „Éë„Çπ„ÉØ„Éº„ÉâÂÜçË®≠ÂÆöUIË°®Á§∫
function showForgotPassword() {
  document.getElementById('forgotPasswordSection').style.display = 'block';
  document.getElementById('forgotEmail').value = document.getElementById('loginEmail').value;
  document.getElementById('forgotEmail').focus();
}

function hideForgotPassword() {
  document.getElementById('forgotPasswordSection').style.display = 'none';
}

// „Éë„Çπ„ÉØ„Éº„ÉâÂÜçË®≠ÂÆö„É°„Éº„É´ÈÄÅ‰ø°
async function sendPasswordReset() {
  const email = document.getElementById('forgotEmail').value.trim();

  if (!email) {
    showToast('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (!window.supabase) {
    showToast('„Ç®„É©„Éº: „Ç∑„Çπ„ÉÜ„É†„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return;
  }

  try {
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.origin + '/archideck/index.html#reset-password'
    });

    if (error) {
      console.error('„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
      showToast('„É°„Éº„É´ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    showToast('„Éë„Çπ„ÉØ„Éº„ÉâÂÜçË®≠ÂÆöÁî®„ÅÆ„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ', 'success', 5000);
    hideForgotPassword();
  } catch (e) {
    console.error('„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà‰æãÂ§ñ:', e);
    showToast('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
  }
}

async function signIn() {
  console.log('üîê „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜÈñãÂßã...');

  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  console.log('üìß ÂÖ•Âäõ„Åï„Çå„Åü„É°„Éº„É´:', email);

  // „Éë„Çπ„ÉØ„Éº„Éâ„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØ„Éá„É¢„É¢„Éº„Éâ„ÅßÂÖ•„Çã
  if (!password && email) {
    console.log('üé≠ „Éë„Çπ„ÉØ„Éº„ÉâÁÑ°„Åó - „Éá„É¢„É¢„Éº„Éâ„ÅßÁ∂öË°å');
    enterDemoMode();
    return;
  }

  if (!email) {
    console.error('‚ùå „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåÁ©∫„Åß„Åô');
    showToast('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (!window.supabase) {
    console.error('‚ùå Supabase CDN„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
    showToast('„Ç®„É©„Éº: Supabase„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
    return;
  }

  try {
    console.log('üîÑ SupabaseË™çË®º„É™„ÇØ„Ç®„Çπ„ÉàÈÄÅ‰ø°‰∏≠...');
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });

    if (error) {
      console.error('‚ùå SupabaseË™çË®º„Ç®„É©„Éº:', error);
      throw error;
    }

    console.log('‚úÖ „É≠„Ç∞„Ç§„É≥ÊàêÂäü:', data.user.email);
    // „É≠„Ç∞„Ç§„É≥ÊàêÂäü - onAuthStateChange„ÅßÂá¶ÁêÜ„Åï„Çå„Çã„ÅÆ„Åßreload„ÅØ‰∏çË¶Å
  } catch (error) {
    console.error('‚ùå „É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
    showToast('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
  }
}

async function signOut() {
  try {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
    location.reload();
  } catch (error) {
    console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
    showToast('„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
}

async function checkAuth() {
  console.log('üîç Ë™çË®ºÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠...');
  const { data: { session } } = await supabase.auth.getSession();

  if (session) {
    console.log('‚úÖ „Çª„ÉÉ„Ç∑„Éß„É≥Ê§úÂá∫:', session.user.email);
    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';

    // admin@ghouse.jp„ÅÆÂ†¥Âêà„ÅØ„Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫
    if (currentUser.email === 'admin@ghouse.jp') {
      console.log('üëë ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥ - „Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫');
      document.getElementById('accountSelectContainer').style.display = 'flex';
      return;
    }

    // „Åù„ÅÆ‰ªñ„ÅÆÂ†¥Âêà„ÅØ„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶category„ÇíÂà§ÂÆö
    const { data: designerData } = await supabase
      .from('designers')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    if (designerData) {
      currentDesigner = designerData;
      currentUserCategory = designerData.category;
      console.log('‚úÖ „Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±ÂèñÂæó:', currentDesigner.name, '/', currentUserCategory);
    } else {
      console.warn('‚ö†Ô∏è „Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', currentUser.email);
    }

    // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä„ÇíË°®Á§∫
    document.getElementById('mainContainer').classList.add('show');

    // „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åã„Çâ„É¶„Éº„Ç∂„ÉºÂêç„ÇíË°®Á§∫Ôºà@„Çà„ÇäÂâç„ÅÆÈÉ®ÂàÜÔºâ
    const displayName = currentUser.email.split('@')[0];
    document.getElementById('userName').textContent = displayName;

    // „Éá„Éï„Ç©„É´„Éà„Ç¢„Éê„Çø„Éº„ÇíË®≠ÂÆö
    document.getElementById('userAvatar').src = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(displayName) + '&background=4A90E2&color=fff&size=32';

    await init();

    // ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„Å´URLÁõ¥Êé•„Ç¢„ÇØ„Çª„Çπ„ÅÆÂá¶ÁêÜ„ÇíÂÆüË°åÔºà1Âõû„Å†„ÅëÔºâ
    if (!window.location.hash || window.location.hash === '#') {
      window.location.hash = 'projects';
    }
  } else {
    console.log('‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó - „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÇíË°®Á§∫');
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('mainContainer').classList.remove('show');
  }
}

// Ë™çË®ºÂá¶ÁêÜ‰∏≠„Éï„É©„Ç∞
let isAuthProcessing = false;

// Ë™çË®ºÁä∂ÊÖãÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
supabase.auth.onAuthStateChange(async (event, session) => {
  console.log('üîî Ë™çË®º„Ç§„Éô„É≥„Éà:', event, 'currentUser:', currentUser?.email, 'processing:', isAuthProcessing);

  if (event === 'SIGNED_IN' && !currentUser && !isAuthProcessing) {
    isAuthProcessing = true;
    console.log('‚úÖ SIGNED_IN „Ç§„Éô„É≥„ÉàÂá¶ÁêÜÈñãÂßã:', session.user.email);

    currentUser = session.user;
    document.getElementById('loginContainer').style.display = 'none';

    // admin@ghouse.jp„ÅÆÂ†¥Âêà„ÅØ„Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫
    if (currentUser.email === 'admin@ghouse.jp') {
      console.log('üëë ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥ - „Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫');
      document.getElementById('accountSelectContainer').style.display = 'flex';
      isAuthProcessing = false;
      return;
    }

    // „Åù„ÅÆ‰ªñ„ÅÆÂ†¥Âêà„ÅØ„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶category„ÇíÂà§ÂÆö
    const { data: designerData } = await supabase
      .from('designers')
      .select('*')
      .eq('email', currentUser.email)
      .single();

    if (designerData) {
      currentDesigner = designerData;
      currentUserCategory = designerData.category;
      console.log('‚úÖ „Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±ÂèñÂæó:', currentDesigner.name, '/', currentUserCategory);
    } else {
      console.warn('‚ö†Ô∏è „Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', currentUser.email);
    }

    // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä„ÇíË°®Á§∫
    document.getElementById('mainContainer').classList.add('show');

    const displayName = currentUser.email.split('@')[0];
    document.getElementById('userName').textContent = displayName;
    document.getElementById('userAvatar').src = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(displayName) + '&background=4A90E2&color=fff&size=32';

    await init();
    isAuthProcessing = false;
  } else if (event === 'SIGNED_OUT') {
    console.log('üëã SIGNED_OUT „Ç§„Éô„É≥„Éà');
    location.reload();
  } else {
    console.log('‚è≠Ô∏è „Ç§„Éô„É≥„Éà„Çí„Çπ„Ç≠„ÉÉ„Éó');
  }
});

// „Ç¢„Ç´„Ç¶„É≥„Éà„Çø„Ç§„ÉóÈÅ∏Êäû
async function selectAccountType(category) {
  console.log('üéØ „Ç¢„Ç´„Ç¶„É≥„Éà„Çø„Ç§„ÉóÈÅ∏Êäû:', category);
  currentUserCategory = category;
  document.getElementById('accountSelectContainer').style.display = 'none';
  document.getElementById('mainContainer').classList.add('show');

  // „Éá„É¢„É¢„Éº„ÉâÂØæÂøú: currentUser„Åånull„ÅÆÂ†¥Âêà„ÅØ'demo'„Çí‰ΩøÁî®
  const displayName = currentUser?.email ? currentUser.email.split('@')[0] : 'demo';
  document.getElementById('userName').textContent = displayName;
  document.getElementById('userAvatar').src = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(displayName) + '&background=4A90E2&color=fff&size=32';

  // Âàá„ÇäÊõø„Åà„Éú„Çø„É≥„ÇíË°®Á§∫
  updateCategorySwitchButton();

  await init();

  // ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„Å´„Éá„Éï„Ç©„É´„Éà„Çø„Éñ„ÇíË®≠ÂÆöÔºà1Âõû„Å†„ÅëÔºâ
  if (!window.location.hash || window.location.hash === '#') {
    window.location.hash = 'projects';
  }

  console.log('‚úÖ „Ç¢„Ç´„Ç¶„É≥„Éà„Çø„Ç§„ÉóÈÅ∏ÊäûÂÆå‰∫Ü');
}

// „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„Åà„Éú„Çø„É≥„ÅÆË°®Á§∫Êõ¥Êñ∞
function updateCategorySwitchButton() {
  const btn = document.getElementById('categorySwitchBtn');
  const label = document.getElementById('currentCategoryLabel');

  if (currentUserCategory === 'Ë®≠Ë®à') {
    label.textContent = 'üìê Ë®≠Ë®à';
  } else if (currentUserCategory === 'IC') {
    label.textContent = 'üé® IC';
  } else if (currentUserCategory === 'admin') {
    label.textContent = 'üëë ÁÆ°ÁêÜËÄÖ';
  }

  btn.style.display = 'block';
}

// „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„Åà„É°„Éã„É•„Éº„ÅÆÈñãÈñâ
function toggleCategorySwitcher() {
  const menu = document.getElementById('categorySwitchMenu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// „É°„Éã„É•„ÉºÂ§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
document.addEventListener('click', function(e) {
  const menu = document.getElementById('categorySwitchMenu');
  const btn = document.getElementById('categorySwitchBtn');
  if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
    menu.style.display = 'none';
  }
});

// „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„Åà
async function switchCategory(category) {
  console.log('üîÑ „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„Åà:', category);

  // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
  document.getElementById('categorySwitchMenu').style.display = 'none';

  // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
  if (currentUserCategory === category) {
    console.log('‚è≠Ô∏è Âêå„Åò„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
    return;
  }

  // „Ç´„ÉÜ„Ç¥„É™„ÇíÊõ¥Êñ∞
  currentUserCategory = category;

  // „Éú„Çø„É≥Ë°®Á§∫„ÇíÊõ¥Êñ∞
  updateCategorySwitchButton();

  // „Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
  showStatus('Ë™≠„ÅøËæº„Åø‰∏≠...', 'saving');
  await init();

  showToast(`${category === 'admin' ? 'ÁÆ°ÁêÜËÄÖ' : category + 'ÊãÖÂΩì'}ÁîªÈù¢„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü`, 'success');
  console.log('‚úÖ „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„ÅàÂÆå‰∫Ü');
}

// ============================================
// FC„É¢„Éº„ÉâÔºà„Éï„É©„É≥„ÉÅ„É£„Ç§„Ç∫Âêë„Åë„Éõ„ÉØ„Ç§„Éà„É©„Éô„É´Ôºâ
// ============================================
function detectFCMode() {
  // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâFC„Çπ„É©„ÉÉ„Ç∞„ÇíÂèñÂæó
  const urlParams = new URLSearchParams(window.location.search);
  const fcParam = urlParams.get('fc');

  // localStorage„Åã„ÇâFC„É¢„Éº„ÉâÊÉÖÂ†±„ÇíÂèñÂæó
  const fcModeData = localStorage.getItem('fc_mode');

  if (fcParam) {
    isFCMode = true;
    fcSlug = fcParam;
    console.log('üè™ FC„É¢„Éº„ÉâÊ§úÂá∫ÔºàURL„Éë„É©„É°„Éº„ÇøÔºâ:', fcSlug);
  } else if (fcModeData) {
    try {
      const fcConfig = JSON.parse(fcModeData);
      // 24ÊôÇÈñì‰ª•ÂÜÖ„ÅÆË®≠ÂÆö„ÅÆ„ÅøÊúâÂäπ
      if (fcConfig.timestamp && (Date.now() - fcConfig.timestamp < 24 * 60 * 60 * 1000)) {
        isFCMode = true;
        fcSlug = fcConfig.slug;
        console.log('üè™ FC„É¢„Éº„ÉâÊ§úÂá∫ÔºàlocalStorageÔºâ:', fcSlug);
      }
    } catch (e) {
      console.warn('FCË®≠ÂÆö„ÅÆËß£Êûê„Å´Â§±Êïó:', e);
    }
  }

  // FC„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØUIË™øÊï¥
  if (isFCMode) {
    applyFCMode();
  }
}

function applyFCMode() {
  console.log('üé® FC„É¢„Éº„ÉâUIÈÅ©Áî®‰∏≠...');

  // „Çø„Ç§„Éà„É´„Åã„ÇâG„Éè„Ç¶„Çπ„ÇíÂâäÈô§
  document.title = 'Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†';

  // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆG„Éè„Ç¶„ÇπË°®Á§∫„ÇíÈùûË°®Á§∫
  const loginBranding = document.querySelector('#loginContainer p[style*="color: var(--text-muted)"]');
  if (loginBranding && loginBranding.textContent.includes('G„Éè„Ç¶„Çπ')) {
    loginBranding.style.display = 'none';
  }

  // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆ„É≠„Ç¥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂ§âÊõ¥
  const loginLogoText = document.querySelector('.login-logo-text');
  if (loginLogoText) {
    loginLogoText.innerHTML = '<span style="color: var(--primary-color);">Ë®≠Ë®àÊ•≠Âãô</span>ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†';
  }

  // ÁÆ°ÁêÜËÄÖ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´„Åô„ÇãCSSËøΩÂä†
  const fcStyle = document.createElement('style');
  fcStyle.id = 'fc-mode-styles';
  fcStyle.textContent = `
    /* FC„É¢„Éº„Éâ: ÁÆ°ÁêÜËÄÖÈñ¢ÈÄ£„ÇíÈùûË°®Á§∫ */
    .fc-hide { display: none !important; }

    /* „Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢„ÅÆÁÆ°ÁêÜËÄÖ„Éú„Çø„É≥ */
    button[onclick="selectAccountType('admin')"] { display: none !important; }

    /* „Ç´„ÉÜ„Ç¥„É™Âàá„ÇäÊõø„Åà„ÅÆÁÆ°ÁêÜËÄÖ„Éú„Çø„É≥ */
    button[onclick="switchCategory('admin')"] { display: none !important; }

    /* Ë®≠ÂÆöÁîªÈù¢„ÅÆÁÆ°ÁêÜËÄÖÂ∞ÇÁî®„Çª„ÇØ„Ç∑„Éß„É≥ */
    .admin-only-section { display: none !important; }

    /* „Éò„ÉÉ„ÉÄ„Éº„ÅÆG„Éè„Ç¶„Çπ„É≠„Ç¥ */
    .header-logo-text .ghouse-text { display: none !important; }
  `;
  document.head.appendChild(fcStyle);

  // „Éò„ÉÉ„ÉÄ„Éº„É≠„Ç¥„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂ§âÊõ¥ÔºàDOMContentLoadedÂæå„Å´ÂÆüË°åÔºâ
  setTimeout(() => {
    const headerLogo = document.querySelector('.header-logo-text');
    if (headerLogo && headerLogo.innerHTML.includes('G„Éè„Ç¶„Çπ')) {
      headerLogo.innerHTML = '<span style="color: var(--primary-color);">Archi</span>Deck';
    }

    // Ë®≠ÂÆöÁîªÈù¢„ÅßÁµÑÁπîÂêç„ÇíË°®Á§∫
    const orgNameDisplay = document.getElementById('orgNameDisplay');
    if (orgNameDisplay && fcSlug) {
      orgNameDisplay.textContent = fcSlug + ' Â∞ÇÁî®„Ç∑„Çπ„ÉÜ„É†';
    }
  }, 100);

  console.log('‚úÖ FC„É¢„Éº„ÉâUIÈÅ©Áî®ÂÆå‰∫Ü');
}

function exitFCMode() {
  localStorage.removeItem('fc_mode');
  isFCMode = false;
  fcSlug = null;
  // URL„Éë„É©„É°„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶„É™„É≠„Éº„Éâ
  const url = new URL(window.location);
  url.searchParams.delete('fc');
  window.location.href = url.toString();
}

// ============================================
// „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ
// ============================================
function initDarkMode() {
  const savedTheme = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

  if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
    document.documentElement.setAttribute('data-theme', 'dark');
    updateDarkModeIcon(true);
  }

  // „Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem('theme')) {
      document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
      updateDarkModeIcon(e.matches);
    }
  });
}

function toggleDarkMode() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  const newTheme = isDark ? 'light' : 'dark';

  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  updateDarkModeIcon(!isDark);

  showToast(isDark ? '„É©„Ç§„Éà„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü' : '„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü', 'info');
}

function updateDarkModeIcon(isDark) {
  const btn = document.getElementById('darkModeToggle');
  if (btn) {
    btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    btn.title = isDark ? '„É©„Ç§„Éà„É¢„Éº„Éâ„Å´ÂàáÊõø' : '„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ„Å´ÂàáÊõø';
  }
}

// ============================================
// „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
// ============================================
function initKeyboardShortcuts() {
  document.addEventListener('keydown', handleKeyboardShortcut);
}

function handleKeyboardShortcut(e) {
  // „É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆEscape„Ç≠„Éº
  if (e.key === 'Escape') {
    const modals = document.querySelectorAll('.modal-overlay[style*="flex"], .modal[style*="flex"]');
    modals.forEach(modal => {
      if (modal.style.display === 'flex') {
        modal.style.display = 'none';
      }
    });
    // „Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñâ„Åò„Çã
    closeSidebar();
    return;
  }

  // Ctrl/Cmd + „Ç≠„Éº „ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
  if (e.ctrlKey || e.metaKey) {
    switch (e.key.toLowerCase()) {
      case 'n':
        // Êñ∞Ë¶èÊ°à‰ª∂‰ΩúÊàê
        if (!isLoginScreen()) {
          e.preventDefault();
          showNewProjectModal();
        }
        break;
      case 's':
        // ‰øùÂ≠òÔºàÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíÂêåÊúüÔºâ
        e.preventDefault();
        forceReloadData();
        showToast('„Éá„Éº„Çø„ÇíÂêåÊúü„Åó„Åæ„Åó„Åü', 'success');
        break;
      case 'k':
        // „ÇØ„Ç§„ÉÉ„ÇØÊ§úÁ¥¢
        e.preventDefault();
        const searchInput = document.querySelector('#searchQuery');
        if (searchInput) {
          searchInput.focus();
        }
        break;
      case 'd':
        // „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø
        e.preventDefault();
        toggleDarkMode();
        break;
      case 'z':
        // ÂÖÉ„Å´Êàª„Åô / „ÇÑ„ÇäÁõ¥„Åô
        e.preventDefault();
        if (e.shiftKey) {
          // Ctrl+Shift+Z = „ÇÑ„ÇäÁõ¥„Åô
          UndoManager.redo();
        } else {
          // Ctrl+Z = ÂÖÉ„Å´Êàª„Åô
          UndoManager.undo();
        }
        break;
      case 'y':
        // Ctrl+Y = „ÇÑ„ÇäÁõ¥„ÅôÔºàWindowsÊ®ôÊ∫ñÔºâ
        e.preventDefault();
        UndoManager.redo();
        break;
    }
  }

  // Shift + „Ç≠„Éº „ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
  if (e.shiftKey && !e.ctrlKey && !e.metaKey) {
    switch (e.key) {
      case '?':
        // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Éò„É´„Éó„ÇíË°®Á§∫
        showShortcutHelp();
        break;
    }
  }
}

function isLoginScreen() {
  const loginContainer = document.getElementById('loginContainer');
  return loginContainer && loginContainer.style.display !== 'none';
}

function showShortcutHelp() {
  const helpContent = `
    <div style="padding: 20px;">
      <h3 style="margin-bottom: 16px; font-size: 18px;">‚å®Ô∏è „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà</h3>
      <div style="display: grid; gap: 12px;">
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + Z</span><span>ÂÖÉ„Å´Êàª„ÅôÔºàUndoÔºâ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + Shift + Z</span><span>„ÇÑ„ÇäÁõ¥„ÅôÔºàRedoÔºâ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + Y</span><span>„ÇÑ„ÇäÁõ¥„ÅôÔºàRedoÔºâ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + N</span><span>Êñ∞Ë¶èÊ°à‰ª∂‰ΩúÊàê</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + S</span><span>„Éá„Éº„ÇøÂêåÊúü</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + D</span><span>„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Ctrl/Cmd + K</span><span>Ê§úÁ¥¢„Å´„Éï„Ç©„Éº„Ç´„Çπ</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Escape</span><span>„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
          <span>Shift + ?</span><span>„Åì„ÅÆ„Éò„É´„Éó„ÇíË°®Á§∫</span>
        </div>
      </div>
    </div>
  `;

  // Á∞°Êòì„É¢„Éº„ÉÄ„É´„ÅßË°®Á§∫
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
  modal.innerHTML = `
    <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 400px; width: 90%;">
      ${helpContent}
      <div style="padding: 0 20px 20px; text-align: right;">
        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  `;
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });
  document.body.appendChild(modal);
}

// ============================================
// ÂàùÊúüÂåñ
// ============================================
async function init() {
  console.log('üöÄ ÂàùÊúüÂåñÈñãÂßã...');
  showStatus('Ë™≠„ÅøËæº„Åø‰∏≠...', 'saving');

  // „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàùÊúüÂåñÔºàÊó©Êúü„Å´ÂÆüË°å„Åó„Å¶„Éï„É©„ÉÉ„Ç∑„É•„ÇíÈò≤„ÅêÔºâ
  initDarkMode();

  // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÂàùÊúüÂåñ
  initKeyboardShortcuts();

  // „Çª„ÉÉ„Ç∑„Éß„É≥„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÂàùÊúüÂåñ
  SessionManager.init();

  // FC„É¢„Éº„ÉâÊ§úÂá∫
  detectFCMode();

  try {
    // „Éû„É´„ÉÅ„ÉÜ„Éä„É≥„Éà: ÁµÑÁπîÊÉÖÂ†±„ÇíÂÖà„Å´Ë™≠„ÅøËæº„ÇÄ
    await loadOrganization();

    console.log('üì¶ „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã...');
    const results = await Promise.allSettled([
      loadDesigners(),
      loadCurrentDesigner(),
      loadProjects(),
      loadEmailTemplates(),
      loadVendors(),
      loadTaskMappings(),
      loadVendorCategories(),
      loadTasksV2(),
      loadVendorsV2(),
      loadTaskVendorMappings(),
      loadProducts()
    ]);

    // ÂêÑÁµêÊûú„ÇíÁ¢∫Ë™ç
    results.forEach((result, index) => {
      const names = ['„Çπ„Çø„ÉÉ„Éï', 'ÁèæÂú®„ÅÆ„Çπ„Çø„ÉÉ„Éï', 'Ê°à‰ª∂', '„ÉÜ„É≥„Éó„É¨„Éº„Éà', 'Ê•≠ËÄÖ', '„Çø„Çπ„ÇØË®≠ÂÆö'];
      if (result.status === 'rejected') {
        console.error(`‚ùå ${names[index]}„ÅÆË™≠„ÅøËæº„ÅøÂ§±Êïó:`, result.reason);
      } else {
        console.log(`‚úÖ ${names[index]}„ÅÆË™≠„ÅøËæº„ÅøÊàêÂäü`);
      }
    });

    // Â§±Êïó„Åó„Åü„ÇÇ„ÅÆ„Åå„ÅÇ„Çå„Å∞„Ç®„É©„Éº„ÇíË°®Á§∫
    const failedCount = results.filter(r => r.status === 'rejected').length;
    if (failedCount > 0) {
      console.warn(`‚ö†Ô∏è ${failedCount}‰ª∂„ÅÆ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü`);
      showToast(`${failedCount}‰ª∂„ÅÆ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`, 'error');
    }

    // Ê•≠ËÄÖ„Éá„Éº„Çø„Å®„Ç´„ÉÜ„Ç¥„É™„Éá„Éº„Çø„Çí„Éû„Éº„Ç∏Ôºà‰∏°Êñπ„ÅÆË™≠„ÅøËæº„Åø„ÅåÂÆå‰∫Ü„Åó„ÅüÂæå„Å´ÂÆüË°åÔºâ
    mergeVendorCategories();

    console.log('üé® ÁîªÈù¢ÊèèÁîªÈñãÂßã...');
    renderSidebar();
    renderProjects();
    renderTemplates();
    renderVendors();
    renderMappings();

    // Êñ∞„Ç∑„Çπ„ÉÜ„É†„ÅÆUIÂàùÊúüÂåñ
    populateVendorCategoryDropdown();
    populateProductDropdown();

    // Êñ∞„Ç∑„Çπ„ÉÜ„É†„ÅÆÂêÑÁÆ°ÁêÜÁîªÈù¢„ÅÆÂàùÊúüÊèèÁîª
    console.log('üé® Êñ∞„Ç∑„Çπ„ÉÜ„É†ÊèèÁîªÈñãÂßã:', {
      vendorsV2Length: vendorsV2.length,
      vendorCategoriesLength: vendorCategories.length,
      tasksV2Length: tasksV2.length,
      taskVendorMappingsLength: taskVendorMappings.length
    });

    renderDesignerListInline();  // „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ
    renderCategoryFilters();      // „Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø„Éº
    renderVendorsV2();            // Ê•≠ËÄÖÁÆ°ÁêÜ
    renderCategoriesList();       // „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ
    renderTasksManagement();      // „Çø„Çπ„ÇØÁÆ°ÁêÜ
    renderProductsList();         // ÂïÜÂìÅÁÆ°ÁêÜ

    // „É¢„Éê„Ç§„É´„Çπ„ÉØ„Ç§„Éó„Ç∏„Çß„Çπ„ÉÅ„É£„ÉºÂàùÊúüÂåñ
    MobileGestures.init();

    // ÊúüÈôê„É™„Éû„Ç§„É≥„ÉÄ„Éº„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÔºà3ÁßíÂæå„Å´ÂÆüË°åÔºâ
    setTimeout(() => {
      DeadlineManager.checkReminders();
    }, 3000);

    console.log('‚úÖ ÂàùÊúüÂåñÂÆå‰∫Ü');
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  } catch (error) {
    console.error('‚ùå ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
  }
}

// ============================================
// „Éá„Éº„ÇøÂº∑Âà∂„É™„É≠„Éº„Éâ
// ============================================
async function forceReloadData() {
  showToast('„Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø‰∏≠...', 'info');
  showStatus('Ë™≠„ÅøËæº„Åø‰∏≠...', 'saving');

  // „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
  try {
    const cacheNames = await caches.keys();
    for (const name of cacheNames) {
      await caches.delete(name);
    }
  } catch (e) {}

  // „Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
  await init();

  showToast(`„Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Åæ„Åó„Åü„ÄÇÊ°à‰ª∂Êï∞: ${projects.length}‰ª∂`, 'success');
}

// ============================================
// „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Ë°®Á§∫Ôºà„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÔºâ
// ============================================
async function showDebugInfo() {
  // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´Áõ¥Êé•„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶‰ª∂Êï∞„ÇíÁ¢∫Ë™ç
  let dbProjectsCount = 'ÂèñÂæó‰∏≠...';
  let dbDesignersCount = 'ÂèñÂæó‰∏≠...';
  let dbError = null;

  try {
    const projectsResult = await supabase.from('projects').select('id', { count: 'exact', head: true });
    const designersResult = await supabase.from('designers').select('id', { count: 'exact', head: true });

    dbProjectsCount = projectsResult.count ?? `„Ç®„É©„Éº: ${projectsResult.error?.message}`;
    dbDesignersCount = designersResult.count ?? `„Ç®„É©„Éº: ${designersResult.error?.message}`;

    if (projectsResult.error) dbError = projectsResult.error;
    if (designersResult.error) dbError = designersResult.error;
  } catch (e) {
    dbError = e;
  }

  const info = `
ArchiDeck „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
========================
„Éê„Éº„Ç∏„Éß„É≥: ${APP_VERSION}
„É¶„Éº„Ç∂„Éº: ${currentUser?.email || 'Êú™„É≠„Ç∞„Ç§„É≥'}
„Ç´„ÉÜ„Ç¥„É™: ${currentUserCategory || 'Êú™ÈÅ∏Êäû'}
ÊãÖÂΩì„Çø„Éñ: ${currentDesignerTab}

„É°„É¢„É™‰∏ä„ÅÆ„Éá„Éº„Çø
----------------
Ê°à‰ª∂Êï∞: ${projects.length}‰ª∂
„Çπ„Çø„ÉÉ„ÉïÊï∞: ${designers.length}‰∫∫
„Çø„Çπ„ÇØÊï∞: ${tasksV2.length}‰ª∂
Ê•≠ËÄÖÊï∞: ${vendorsV2.length}‰ª∂

„Éá„Éº„Çø„Éô„Éº„ÇπÁõ¥Êé•Á¢∫Ë™ç
--------------------
DBÊ°à‰ª∂Êï∞: ${dbProjectsCount}‰ª∂
DB„Çπ„Çø„ÉÉ„ÉïÊï∞: ${dbDesignersCount}‰∫∫
${dbError ? `DB„Ç®„É©„Éº: ${dbError.message || dbError}` : ''}

Ê°à‰ª∂Ë©≥Á¥∞
--------
${projects.slice(0, 5).map(p => `„Éª${p.customer} (Ë®≠Ë®à:${p.assigned_to || 'Êú™Ââ≤ÂΩì'}, IC:${p.ic_assignee || 'Êú™Ââ≤ÂΩì'})`).join('\n')}
${projects.length > 5 ? `...‰ªñ${projects.length - 5}‰ª∂` : ''}
${projects.length === 0 ? 'ÔºàÊ°à‰ª∂„Éá„Éº„Çø„Å™„ÅóÔºâ' : ''}

„Çπ„Çø„ÉÉ„ÉïË©≥Á¥∞
----------
${designers.slice(0, 5).map(d => `„Éª${d.name} (${d.category})`).join('\n')}
${designers.length > 5 ? `...‰ªñ${designers.length - 5}‰∫∫` : ''}
${designers.length === 0 ? 'Ôºà„Çπ„Çø„ÉÉ„Éï„Éá„Éº„Çø„Å™„ÅóÔºâ' : ''}

„Ç¢„Éº„Ç´„Ç§„ÉñÁä∂Ê≥Å
--------------
„Ç¢„ÇØ„ÉÜ„Ç£„Éñ: ${projects.filter(p => !p.is_archived).length}‰ª∂
ÂÆå‰∫ÜÊ∏à„Åø: ${projects.filter(p => p.is_archived).length}‰ª∂

„Éï„Ç£„É´„Çø„Éº
----------
„Ç¢„Éº„Ç´„Ç§„Éñ„Éï„Ç£„É´„Çø„Éº: ${document.getElementById('archiveFilter')?.value || '‰∏çÊòé'}
Ê§úÁ¥¢: ${document.getElementById('searchQuery')?.value || '„Å™„Åó'}
ÂïÜÂìÅ: ${document.getElementById('specFilter')?.value || 'ÂÖ®„Å¶'}

RLSÊ≥®ÊÑè
-------
„Éá„Éº„Çø„Éô„Éº„Çπ„Å´Êï∞„Åå„ÅÇ„Å£„Å¶„ÇÇ„É°„É¢„É™„Åå0„ÅÆÂ†¥Âêà„ÄÅ
RLS(Row Level Security)„Åå„Éá„Éº„Çø„Çí„Éñ„É≠„ÉÉ„ÇØ„Åó„Å¶„ÅÑ„Çã
ÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇSupabaseÁÆ°ÁêÜÁîªÈù¢„ÅßRLSË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
  `.trim();

  alert(info);
  console.log(info);

  // „Éá„Éº„Çø„Åå0‰ª∂„ÅÆÂ†¥Âêà„ÅØË≠¶Âëä„ÇíË°®Á§∫
  if (projects.length === 0 || designers.length === 0) {
    console.error('üö® „Éá„Éº„ÇøÊ∂àÂ§±ÂïèÈ°åÊ§úÂá∫ÔºÅ');
    console.error('Supabase„ÅÆ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Åß‰ª•‰∏ã„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
    console.error('1. projects„ÉÜ„Éº„Éñ„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çã„Åã');
    console.error('2. designers„ÉÜ„Éº„Éñ„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çã„Åã');
    console.error('3. RLS„Éù„É™„Ç∑„Éº„ÅåÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åã');
    console.error('4. anon key„Å´ÈÅ©Âàá„Å™Ê®©Èôê„Åå„ÅÇ„Çã„Åã');
  }
}

// ============================================
// „Éá„Éê„ÉÉ„Ç∞Áî®„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
// ============================================
// „Ç≥„É≥„ÇΩ„Éº„É´„Åß debug() „ÇíÂÆüË°å„Åô„Çã„Å®„ÄÅÂÖ®„Éá„Éº„Çø„ÅÆË©≥Á¥∞„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
window.debug = function() {
  console.log('='.repeat(80));
  console.log('üîç „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±');
  console.log('='.repeat(80));

  console.log('\nüìä Âü∫Êú¨ÊÉÖÂ†±:');
  console.log('  - „Çπ„Çø„ÉÉ„ÉïÊï∞:', designers.length);
  console.log('  - Ê°à‰ª∂Êï∞:', projects.length);
  console.log('  - „Çø„Çπ„ÇØÊï∞:', tasksV2.length);
  console.log('  - Ê•≠ËÄÖÊï∞:', vendorsV2.length);

  console.log('\nüë• „Çπ„Çø„ÉÉ„Éï‰∏ÄË¶ß:');
  designers.forEach(d => {
    console.log(`  - [${d.category}] ${d.name} (${d.email})`);
  });

  console.log('\nüìã Ê°à‰ª∂‰∏ÄË¶ß:');
  projects.forEach(p => {
    console.log(`  - ${p.customer}`);
    console.log(`    Ë®≠Ë®à: "${p.assigned_to}" (trim: "${(p.assigned_to || '').trim()}")`);
    console.log(`    IC: "${p.ic_assignee}" (trim: "${(p.ic_assignee || '').trim()}")`);
    console.log(`    status: ${p.status}, is_archived: ${p.is_archived}`);
  });

  console.log('\n' + '='.repeat(80));
  return '„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÂá∫Âäõ„Åó„Åæ„Åó„Åü„ÄÇ‰∏äË®ò„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
};

// „Ç≥„É≥„ÇΩ„Éº„É´„Åß checkAssignment('ÊãÖÂΩìËÄÖÂêç', 'Ê°à‰ª∂Âêç') „ÇíÂÆüË°å„Åô„Çã„Å®„ÄÅË©≥Á¥∞„ÉÅ„Çß„ÉÉ„ÇØ„Åå„Åß„Åç„Åæ„Åô
window.checkAssignment = function(designerName, projectName) {
  console.log('='.repeat(80));
  console.log(`üîç Ââ≤„ÇäÂΩì„Å¶„ÉÅ„Çß„ÉÉ„ÇØ: ${designerName} ‚Üí ${projectName}`);
  console.log('='.repeat(80));

  const designer = designers.find(d => d.name.includes(designerName));
  if (!designer) {
    console.error(`‚ùå „Çπ„Çø„ÉÉ„Éï "${designerName}" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
    console.log('ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã„Çπ„Çø„ÉÉ„Éï:', designers.map(d => d.name));
    return;
  }

  const project = projects.find(p => p.customer.includes(projectName));
  if (!project) {
    console.error(`‚ùå Ê°à‰ª∂ "${projectName}" „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
    console.log('ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÊ°à‰ª∂:', projects.map(p => p.customer));
    return;
  }

  console.log('\n‚úÖ „Éá„Éº„ÇøÁ¢∫Ë™ç:');
  console.log('„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±:', {
    name: designer.name,
    nameLength: designer.name.length,
    nameTrimmed: designer.name.trim(),
    category: designer.category,
    email: designer.email
  });

  console.log('\nÊ°à‰ª∂ÊÉÖÂ†±:', {
    customer: project.customer,
    assigned_to: `"${project.assigned_to}"`,
    assigned_to_length: project.assigned_to?.length,
    assigned_to_trimmed: `"${(project.assigned_to || '').trim()}"`,
    ic_assignee: `"${project.ic_assignee}"`,
    ic_assignee_length: project.ic_assignee?.length,
    ic_assignee_trimmed: `"${(project.ic_assignee || '').trim()}"`,
    status: project.status,
    is_archived: project.is_archived
  });

  console.log('\nüîç „Éû„ÉÉ„ÉÅ„É≥„Ç∞ÁµêÊûú:');
  const designerNameTrimmed = designer.name.trim();
  const assignedToTrimmed = (project.assigned_to || '').trim();
  const icAssigneeTrimmed = (project.ic_assignee || '').trim();

  const matchAssigned = assignedToTrimmed === designerNameTrimmed;
  const matchIC = icAssigneeTrimmed === designerNameTrimmed;
  const statusOK = project.status !== 'completed';
  const archivedOK = !project.is_archived;
  const finalMatch = (matchAssigned || matchIC) && statusOK && archivedOK;

  console.log(`  - assigned_to‰∏ÄËá¥: ${matchAssigned ? '‚úÖ' : '‚ùå'} ("${assignedToTrimmed}" === "${designerNameTrimmed}")`);
  console.log(`  - ic_assignee‰∏ÄËá¥: ${matchIC ? '‚úÖ' : '‚ùå'} ("${icAssigneeTrimmed}" === "${designerNameTrimmed}")`);
  console.log(`  - status„ÉÅ„Çß„ÉÉ„ÇØ: ${statusOK ? '‚úÖ' : '‚ùå'} (status !== "completed")`);
  console.log(`  - archived„ÉÅ„Çß„ÉÉ„ÇØ: ${archivedOK ? '‚úÖ' : '‚ùå'} (!is_archived)`);
  console.log(`  - ÊúÄÁµÇÂà§ÂÆö: ${finalMatch ? '‚úÖ „Ç´„Ç¶„É≥„Éà„Åï„Çå„Çã' : '‚ùå „Ç´„Ç¶„É≥„Éà„Åï„Çå„Å™„ÅÑ'}`);

  if (!finalMatch) {
    console.log('\nüí° „Ç´„Ç¶„É≥„Éà„Åï„Çå„Å™„ÅÑÁêÜÁî±:');
    if (!matchAssigned && !matchIC) {
      console.log('  - ÊãÖÂΩìËÄÖÂêç„Åå‰∏ÄËá¥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
      if (assignedToTrimmed !== designerNameTrimmed) {
        console.log(`    Ë®≠Ë®à: "${assignedToTrimmed}" ‚â† "${designerNameTrimmed}"`);
      }
      if (icAssigneeTrimmed !== designerNameTrimmed) {
        console.log(`    IC: "${icAssigneeTrimmed}" ‚â† "${designerNameTrimmed}"`);
      }
    }
    if (!statusOK) {
      console.log(`  - status„Åå "completed" „Åß„Åô`);
    }
    if (!archivedOK) {
      console.log(`  - is_archived „Åå true „Åß„Åô`);
    }
  }

  console.log('\n' + '='.repeat(80));
  return finalMatch ? '„Åì„ÅÆÊ°à‰ª∂„ÅØ„Ç´„Ç¶„É≥„Éà„Åï„Çå„Åæ„Åô ‚úÖ' : '„Åì„ÅÆÊ°à‰ª∂„ÅØ„Ç´„Ç¶„É≥„Éà„Åï„Çå„Åæ„Åõ„Çì ‚ùå';
};

console.log('üí° „Éá„Éê„ÉÉ„Ç∞Èñ¢Êï∞„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô:');
console.log('  - debug() : ÂÖ®„Éá„Éº„Çø„ÅÆË©≥Á¥∞„ÇíË°®Á§∫');
console.log('  - checkAssignment("ÊãÖÂΩìËÄÖÂêç", "Ê°à‰ª∂Âêç") : Ââ≤„ÇäÂΩì„Å¶„ÉÅ„Çß„ÉÉ„ÇØ');

// ============================================
// „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
// ============================================
async function loadDesigners() {
  console.log('üîÑ „Çπ„Çø„ÉÉ„Éï„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã...');

  try {
    const { data, error, count } = await supabase
      .from('designers')
      .select('*', { count: 'exact' })
      .order('display_order');

    console.log('üì° Supabase„É¨„Çπ„Éù„É≥„Çπ:', {
      success: !error,
      dataLength: data?.length || 0,
      count: count,
      error: error,
      rawDataSample: data?.slice(0, 3)
    });

    if (error) {
      console.error('‚ùå „Çπ„Çø„ÉÉ„Éï„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      console.error('„Ç®„É©„ÉºË©≥Á¥∞:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      designers = [];
      return;
    }

    designers = data || [];

    // „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„ÅÆÂÜÖË®≥„ÇíË°®Á§∫
    const byCategory = designers.reduce((acc, d) => {
      const cat = d.category || '(„Å™„Åó)';
      acc[cat] = (acc[cat] || 0) + 1;
      return acc;
    }, {});

    console.log('‚úÖ „Çπ„Çø„ÉÉ„Éï„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', {
      'Á∑èÊï∞': designers.length,
      '„Ç´„ÉÜ„Ç¥„É™Âà•': byCategory,
      '„Çµ„É≥„Éó„É´': designers.slice(0, 3).map(d => ({ name: d.name, category: d.category, email: d.email }))
    });

    if (designers.length === 0) {
      console.warn('‚ö†Ô∏è Ë≠¶Âëä: „Çπ„Çø„ÉÉ„Éï„Éá„Éº„Çø„Åå0‰ª∂„Åß„ÅôÔºÅSupabase„ÅÆ„ÉÜ„Éº„Éñ„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    }
  } catch (err) {
    console.error('‚ùå loadDesigners()„Åß‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº:', err);
    designers = [];
  }
}

async function loadCurrentDesigner() {
  if (!currentUser || !currentUser.email) return;

  // admin@ghouse.jp„ÅÆÂ†¥Âêà„ÅØ„Çπ„Çø„ÉÉ„Éï„ÇíÁâπÂÆö„Åó„Å™„ÅÑÔºàÂÖ®Ê°à‰ª∂Èñ≤Ë¶ßÂèØËÉΩÔºâ
  if (currentUser.email === 'admin@ghouse.jp') {
    currentDesigner = null;
    return;
  }

  const { data, error } = await supabase
    .from('designers')
    .select('*')
    .eq('email', currentUser.email)
    .single();

  if (error) {
    console.warn('„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó:', error);
    currentDesigner = null;
    return;
  }

  currentDesigner = data;
  console.log('ÁèæÂú®„ÅÆ„Çπ„Çø„ÉÉ„Éï:', currentDesigner);
}

async function loadProjects() {
  console.log('üîÑ Ê°à‰ª∂„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...');
  try {
    const { data, error } = await supabase
      .from('projects')
      .select('*')
      .order('created_at', { ascending: false });
    if (error) {
      console.error('‚ùå Ê°à‰ª∂„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      projects = [];
      return;
    }
    projects = data || [];
    console.log('‚úÖ Ê°à‰ª∂„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', projects.length, '‰ª∂');
    console.log('üìã Ë™≠„ÅøËæº„Çì„Å†Ê°à‰ª∂„ÅÆË©≥Á¥∞:');
    projects.forEach(p => {
      console.log(`  - ${p.customer}: assigned_to="${p.assigned_to}", ic_assignee="${p.ic_assignee}"`);
    });

    // Êó¢Â≠ò„Éá„Éº„Çø„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó: assigned_to„Å®ic_assignee„ÅÆÂâçÂæå„ÅÆÁ©∫ÁôΩ„ÇíÂâäÈô§
    await cleanupProjectAssignees();
  } catch (err) {
    console.error('‚ùå loadProjects()„Åß‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº:', err);
    projects = [];
  }
}

async function cleanupProjectAssignees() {
  console.log('üßπ Ê°à‰ª∂„ÅÆÊãÖÂΩìËÄÖ„Éá„Éº„Çø„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó‰∏≠...');
  let updatedCount = 0;

  for (const project of projects) {
    // "null"„Å®„ÅÑ„ÅÜÊñáÂ≠óÂàó„ÇÇnull„Å®„Åó„Å¶Êâ±„ÅÜ
    let assigned = (project.assigned_to || '').trim();
    let icAssigned = (project.ic_assignee || '').trim();

    if (assigned === 'null' || assigned === 'undefined') assigned = '';
    if (icAssigned === 'null' || icAssigned === 'undefined') icAssigned = '';

    let needsUpdate = false;

    // trim()„Åó„ÅüÁµêÊûú„ÅåÂÖÉ„ÅÆÂÄ§„Å®ÈÅï„ÅÜÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØ"null"ÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØÊõ¥Êñ∞
    if (project.assigned_to !== assigned ||
        project.ic_assignee !== icAssigned ||
        project.assigned_to === 'null' ||
        project.ic_assignee === 'null') {
      needsUpdate = true;
    }

    if (needsUpdate) {
      console.log(`üîß „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó: ${project.customer} (assigned_to: "${project.assigned_to}" ‚Üí "${assigned || 'null'}", ic_assignee: "${project.ic_assignee}" ‚Üí "${icAssigned || 'null'}")`);

      const { error } = await supabase
        .from('projects')
        .update({
          assigned_to: assigned || null,
          ic_assignee: icAssigned || null
        })
        .eq('id', project.id);

      if (!error) {
        project.assigned_to = assigned || null;
        project.ic_assignee = icAssigned || null;
        updatedCount++;
      } else {
        console.error('‚ùå „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂ§±Êïó:', project.customer, error);
      }
    }
  }

  if (updatedCount > 0) {
    console.log(`‚úÖ ${updatedCount}‰ª∂„ÅÆÊ°à‰ª∂„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Åó„Åæ„Åó„Åü`);
  } else {
    console.log('‚úÖ „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó‰∏çË¶ÅÔºàÂÖ®Ê°à‰ª∂Ê≠£Â∏∏Ôºâ');
  }
}

async function loadEmailTemplates() {
  console.log('üîÑ „É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...');
  try {
    const { data, error } = await supabase
      .from('email_templates')
      .select('*')
      .order('display_name');
    if (error) {
      console.error('‚ùå „É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      emailTemplates = [];
      return;
    }
    emailTemplates = data || [];
    console.log('‚úÖ „É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', emailTemplates.length, '‰ª∂');
  } catch (err) {
    console.error('‚ùå loadEmailTemplates()„Åß‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº:', err);
    emailTemplates = [];
  }
}

async function loadVendors() {
  console.log('üîÑ Ê•≠ËÄÖ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...');
  try {
    const { data, error } = await supabase
      .from('template_vendors')
      .select('*')
      .order('company');
    if (error) {
      console.error('‚ùå Ê•≠ËÄÖ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      vendors = [];
      return;
    }
    vendors = data || [];
    console.log('‚úÖ Ê•≠ËÄÖ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', vendors.length, '‰ª∂');
  } catch (err) {
    console.error('‚ùå loadVendors()„Åß‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº:', err);
    vendors = [];
  }
}

async function loadTaskMappings() {
  console.log('üîÑ „Çø„Çπ„ÇØ„Éû„ÉÉ„Éî„É≥„Ç∞„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...');
  try {
    const { data, error } = await supabase
      .from('task_template_mappings')
      .select('*');
    if (error) {
      console.error('‚ùå „Çø„Çπ„ÇØ„Éû„ÉÉ„Éî„É≥„Ç∞„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      taskMappings = {};
      return;
    }
    taskMappings = {};
    (data || []).forEach(mapping => {
      taskMappings[mapping.task_key] = mapping.template_id;
    });
    console.log('‚úÖ „Çø„Çπ„ÇØ„Éû„ÉÉ„Éî„É≥„Ç∞„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', Object.keys(taskMappings).length, '‰ª∂');
  } catch (err) {
    console.error('‚ùå loadTaskMappings()„Åß‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº:', err);
    taskMappings = {};
  }
}

// Êñ∞„Ç∑„Çπ„ÉÜ„É†Áî®„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
async function loadVendorCategories() {
  const { data, error } = await supabase
    .from('vendor_categories')
    .select('*')
    .order('display_order');
  if (!error) vendorCategories = data || [];
  console.log('‚úÖ Ê•≠ËÄÖ„Ç´„ÉÜ„Ç¥„É™Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', vendorCategories.length, '‰ª∂');
}

async function loadTasksV2() {
  const { data, error } = await supabase
    .from('tasks')
    .select('*')
    .order('display_order');
  if (!error) tasksV2 = data || [];
  console.log('‚úÖ „Çø„Çπ„ÇØË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', tasksV2.length, '‰ª∂');
}

async function loadVendorsV2() {
  console.log('üîÑ Ê•≠ËÄÖ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã...', {
    timestamp: new Date().toISOString()
  });

  const { data, error } = await supabase
    .from('vendors_v2')
    .select('*')
    .order('company');

  console.log('üì° loadVendorsV2 Supabase„É¨„Çπ„Éù„É≥„Çπ:', {
    success: !error,
    dataLength: data?.length || 0,
    error: error,
    rawData: data
  });

  if (error) {
    console.error('‚ùå Ê•≠ËÄÖË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
    alert('Ê•≠ËÄÖ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + error.message);
    vendorsV2 = [];
    return;
  }

  if (!data || data.length === 0) {
    console.error('‚ö†Ô∏è CRITICAL: vendors_v2„ÉÜ„Éº„Éñ„É´„Å´„Éá„Éº„Çø„Åå0‰ª∂„Åß„ÅôÔºÅ');
    alert('‚ö†Ô∏è vendors_v2„ÉÜ„Éº„Éñ„É´„Å´„Éá„Éº„Çø„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇSupabase„ÅßÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    vendorsV2 = [];
    return;
  }

  vendorsV2 = data || [];
  console.log('‚úÖ Ê•≠ËÄÖË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', vendorsV2.length, '‰ª∂');
  console.log('‚úÖ Ê•≠ËÄÖ„Éá„Éº„ÇøË©≥Á¥∞:', vendorsV2);
}

function mergeVendorCategories() {
  console.log('üîó mergeVendorCategories() ÈñãÂßã:', {
    vendorsV2Length: vendorsV2.length,
    vendorCategoriesLength: vendorCategories.length,
    vendorCategories: vendorCategories
  });

  // „Ç´„ÉÜ„Ç¥„É™ÊÉÖÂ†±„ÇíÊ•≠ËÄÖ„Éá„Éº„Çø„Å´„Éû„Éº„Ç∏ÔºàPromise.allSettledÂÆå‰∫ÜÂæå„Å´Âëº„Å≥Âá∫„ÅôÔºâ
  if (vendorsV2.length > 0 && vendorCategories.length > 0) {
    vendorsV2 = vendorsV2.map(vendor => {
      const category = vendorCategories.find(c => c.id === vendor.category_id);
      return {
        ...vendor,
        vendor_categories: category ? { name: category.name } : null
      };
    });
    console.log('‚úÖ Ê•≠ËÄÖ-„Ç´„ÉÜ„Ç¥„É™„Éû„Éº„Ç∏ÂÆå‰∫Ü:', vendorsV2.slice(0, 2));
  } else {
    console.warn('‚ö†Ô∏è „Éû„Éº„Ç∏„Çπ„Ç≠„ÉÉ„Éó:', {
      vendorsV2Empty: vendorsV2.length === 0,
      vendorCategoriesEmpty: vendorCategories.length === 0
    });
  }
}

async function loadTaskVendorMappings() {
  console.log('üîÑ „Çø„Çπ„ÇØ-Ê•≠ËÄÖÁ¥ê„Å•„Åë„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã...', {
    timestamp: new Date().toISOString()
  });

  const { data, error } = await supabase
    .from('task_vendor_mappings_v2')
    .select('*');

  console.log('üì° loadTaskVendorMappings Supabase„É¨„Çπ„Éù„É≥„Çπ:', {
    success: !error,
    dataLength: data?.length || 0,
    error: error,
    rawDataSample: data?.slice(0, 3)
  });

  if (!error) taskVendorMappings = data || [];

  console.log('‚úÖ „Çø„Çπ„ÇØ-Ê•≠ËÄÖÁ¥ê„Å•„ÅëË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', {
    count: taskVendorMappings.length,
    mappings: taskVendorMappings
  });
}

async function loadProducts() {
  const { data, error } = await supabase
    .from('products')
    .select('*')
    .order('display_order');
  if (!error && data) {
    products = data;
  } else {
    // „ÉÜ„Éº„Éñ„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
    products = [
      { id: '1', name: 'LIFE', display_order: 1 },
      { id: '2', name: 'LIFE+', display_order: 2 },
      { id: '3', name: 'HOURS', display_order: 3 },
      { id: '4', name: 'LACIE', display_order: 4 },
      { id: '5', name: 'LIFE Limited', display_order: 5 },
      { id: '6', name: 'LIFE+ Limited', display_order: 6 }
    ];
  }
  console.log('‚úÖ ÂïÜÂìÅË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', products.length, '‰ª∂');
}

// ============================================
// Ê•≠ËÄÖÁÆ°ÁêÜV2
// ============================================
let currentCategoryFilter = 'ALL';

function renderVendorsV2() {
  console.log('üìû renderVendorsV2() Âëº„Å≥Âá∫„ÅóÈñãÂßã');
  console.log('üìä vendorsV2ÈÖçÂàó„ÅÆÁä∂ÊÖã:', {
    length: vendorsV2.length,
    data: vendorsV2.slice(0, 3),
    'ÂÖ®„Éá„Éº„Çø': vendorsV2
  });

  const container = document.getElementById('vendorsGrid');
  console.log('üéØ vendorsGridË¶ÅÁ¥†:', container ? 'found ‚úì' : 'NOT FOUND ‚úó');

  if (!container) {
    console.error('‚ùå CRITICAL: vendorsGridË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„ÇìÔºÅ');
    console.log('üìç ÁèæÂú®„ÅÆDOMÁä∂ÊÖã:', document.getElementById('vendorsPanel'));
    return;
  }

  console.log('üîç renderVendorsV2():', {
    totalVendors: vendorsV2.length,
    currentFilter: currentCategoryFilter,
    vendors: vendorsV2
  });

  const filtered = currentCategoryFilter === 'ALL'
    ? vendorsV2
    : vendorsV2.filter(v => v.category_id === currentCategoryFilter);

  console.log('üîç „Éï„Ç£„É´„Çø„ÉºÂæå„ÅÆÊ•≠ËÄÖÊï∞:', filtered.length);

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><p>Ê•≠ËÄÖ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì<br><small>„Äå+ Ê•≠ËÄÖËøΩÂä†„Äç„Éú„Çø„É≥„Åã„ÇâÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small></p></div>';
    return;
  }

  container.innerHTML = filtered.map(vendor => {
    const categoryName = vendor.vendor_categories?.name || 'Êú™ÂàÜÈ°û';
    return `
      <div class="vendor-card">
        <div class="vendor-header">
          <h3>${vendor.company}</h3>
          <span class="badge badge-primary">${categoryName}</span>
        </div>
        <div class="vendor-info">
          <div><strong>ÊãÖÂΩìËÄÖ:</strong> ${vendor.contact || '-'}</div>
          <div><strong>TEL:</strong> ${vendor.tel || '-'}</div>
          <div><strong>Email:</strong> ${vendor.email || '-'}</div>
        </div>
        <div class="vendor-actions">
          <button class="btn btn-secondary btn-small" onclick="editVendorV2('${vendor.id}')">Á∑®ÈõÜ</button>
          <button class="btn btn-danger btn-small" onclick="deleteVendorV2('${vendor.id}')">ÂâäÈô§</button>
        </div>
      </div>
    `;
  }).join('');
}

function setCategoryFilter(categoryId) {
  currentCategoryFilter = categoryId;
  document.querySelectorAll('.category-filter-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  renderVendorsV2();
}

function openVendorModalV2(vendorId = null) {
  const modal = document.getElementById('vendorModalV2');
  const title = document.getElementById('vendorModalTitle');

  // „Ç´„ÉÜ„Ç¥„É™„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞
  populateVendorCategoryDropdown();

  if (vendorId) {
    const vendor = vendorsV2.find(v => v.id === vendorId);
    if (!vendor) return;

    title.textContent = 'Ê•≠ËÄÖÁ∑®ÈõÜ';
    document.getElementById('vendorId').value = vendor.id;
    document.getElementById('vendorCompany').value = vendor.company;
    document.getElementById('vendorContact').value = vendor.contact || '';
    document.getElementById('vendorTel').value = vendor.tel || '';
    document.getElementById('vendorEmail').value = vendor.email || '';
    document.getElementById('vendorCategory').value = vendor.category_id || '';
    document.getElementById('vendorSubject').value = vendor.subject_format || '';
    document.getElementById('vendorTemplate').value = vendor.template_text || '';
  } else {
    title.textContent = 'Ê•≠ËÄÖËøΩÂä†';
    document.getElementById('vendorForm').reset();
    document.getElementById('vendorId').value = '';
  }

  modal.style.display = 'flex';
}

function closeVendorModalV2() {
  document.getElementById('vendorModalV2').style.display = 'none';
}

async function saveVendorV2() {
  const id = document.getElementById('vendorId').value;
  const company = document.getElementById('vendorCompany').value.trim();
  const contact = document.getElementById('vendorContact').value.trim();
  const tel = document.getElementById('vendorTel').value.trim();
  const email = document.getElementById('vendorEmail').value.trim();
  const categoryId = document.getElementById('vendorCategory').value;
  const subjectFormat = document.getElementById('vendorSubject').value.trim();
  const templateText = document.getElementById('vendorTemplate').value.trim();

  if (!company) {
    showToast('‰ºöÁ§æÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  const vendorData = {
    company,
    contact: contact || null,
    tel: tel || null,
    email: email || null,
    category_id: categoryId || null,
    subject_format: subjectFormat || null,
    template_text: templateText || null
  };

  let result;
  if (id) {
    result = await supabase
      .from('vendors_v2')
      .update(vendorData)
      .eq('id', id)
      .select('*, vendor_categories(name)');
  } else {
    result = await supabase
      .from('vendors_v2')
      .insert([vendorData])
      .select('*, vendor_categories(name)');
  }

  if (result.error) {
    showStatus('‰øùÂ≠òÂ§±Êïó', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error.message, 'error');
    return;
  }

  showStatus('‰øùÂ≠òÂÆå‰∫Ü', 'success');
  showToast(id ? 'Ê•≠ËÄÖ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü' : 'Ê•≠ËÄÖ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
  closeVendorModalV2();
  await loadVendorsV2();
  renderVendorsV2();
}

function editVendorV2(vendorId) {
  openVendorModalV2(vendorId);
}

async function deleteVendorV2(vendorId) {
  const vendor = vendorsV2.find(v => v.id === vendorId);
  if (!vendor) return;

  if (!confirm(`„Äå${vendor.company}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

  showStatus('ÂâäÈô§‰∏≠...', 'saving');

  const { error } = await supabase
    .from('vendors_v2')
    .delete()
    .eq('id', vendorId);

  if (error) {
    showStatus('ÂâäÈô§Â§±Êïó', 'error');
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  showStatus('ÂâäÈô§ÂÆå‰∫Ü', 'success');
  showToast('Ê•≠ËÄÖ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
  await loadVendorsV2();
  renderVendorsV2();
}

// ============================================
// „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ
// ============================================
function renderCategoriesList() {
  const container = document.getElementById('categoriesGrid');
  if (!container) return;

  if (vendorCategories.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üè∑Ô∏è</div><p>„Ç´„ÉÜ„Ç¥„É™„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p></div>';
    return;
  }

  // Ë°®Á§∫È†Ü„Åß„ÇΩ„Éº„Éà
  const sortedCategories = [...vendorCategories].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>„Ç´„ÉÜ„Ç¥„É™Âêç</th>
            <th style="width: 100px;">Ê•≠ËÄÖÊï∞</th>
            <th style="width: 180px;">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody>
          ${sortedCategories.map(cat => {
            const count = vendorsV2.filter(v => v.category_id === cat.id).length;
            return `
              <tr draggable="true" ondragstart="handleCategoryDragStart(event, '${cat.id}')" ondragover="handleCategoryDragOver(event)" ondrop="handleCategoryDrop(event, '${cat.id}')" style="cursor: move;">
                <td><span style="color: var(--text-muted);">‚ãÆ‚ãÆ</span></td>
                <td><strong>${cat.name}</strong></td>
                <td>${count}Á§æ</td>
                <td>
                  <button class="btn btn-secondary btn-small" onclick="editCategory('${cat.id}')">Á∑®ÈõÜ</button>
                  <button class="btn btn-danger btn-small" onclick="deleteCategory('${cat.id}')">ÂâäÈô§</button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function openCategoryModal(categoryId = null) {
  const modal = document.getElementById('categoryModal');
  const title = document.getElementById('categoryModalTitle');

  if (categoryId) {
    const category = vendorCategories.find(c => c.id === categoryId);
    if (!category) return;

    title.textContent = '„Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ';
    document.getElementById('categoryId').value = category.id;
    document.getElementById('categoryName').value = category.name;
    document.getElementById('categoryOrder').value = category.display_order;
  } else {
    title.textContent = '„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†';
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryId').value = '';
    document.getElementById('categoryOrder').value = vendorCategories.length + 1;
  }

  modal.style.display = 'flex';
}

function closeCategoryModal() {
  document.getElementById('categoryModal').style.display = 'none';
}

async function saveCategory() {
  const id = document.getElementById('categoryId').value;
  const name = document.getElementById('categoryName').value.trim();
  const order = parseInt(document.getElementById('categoryOrder').value) || 0;

  if (!name) {
    showToast('„Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  const categoryData = {
    name,
    display_order: order
  };

  let result;
  if (id) {
    result = await supabase
      .from('vendor_categories')
      .update(categoryData)
      .eq('id', id)
      .select();
  } else {
    result = await supabase
      .from('vendor_categories')
      .insert([categoryData])
      .select();
  }

  if (result.error) {
    showStatus('‰øùÂ≠òÂ§±Êïó', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error.message, 'error');
    return;
  }

  showStatus('‰øùÂ≠òÂÆå‰∫Ü', 'success');
  showToast(id ? '„Ç´„ÉÜ„Ç¥„É™„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü' : '„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
  closeCategoryModal();
  await loadVendorCategories();
  renderCategoriesList();
  renderCategoryFilters();
}

function editCategory(categoryId) {
  openCategoryModal(categoryId);
}

async function deleteCategory(categoryId) {
  const category = vendorCategories.find(c => c.id === categoryId);
  if (!category) return;

  const vendorCount = vendorsV2.filter(v => v.category_id === categoryId).length;
  if (vendorCount > 0) {
    showToast(`„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´„ÅØ${vendorCount}Á§æ„ÅÆÊ•≠ËÄÖ„ÅåÁ¥ê„Å•„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇÂÖà„Å´Ê•≠ËÄÖ„ÇíÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`, 'error');
    return;
  }

  if (!confirm(`„Ç´„ÉÜ„Ç¥„É™„Äå${category.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

  showStatus('ÂâäÈô§‰∏≠...', 'saving');

  const { error } = await supabase
    .from('vendor_categories')
    .delete()
    .eq('id', categoryId);

  if (error) {
    showStatus('ÂâäÈô§Â§±Êïó', 'error');
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  showStatus('ÂâäÈô§ÂÆå‰∫Ü', 'success');
  showToast('„Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
  await loadVendorCategories();
  renderCategoriesList();
  renderCategoryFilters();
}

// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åß„Ç´„ÉÜ„Ç¥„É™„ÅÆË°®Á§∫È†Ü„ÇíÂ§âÊõ¥
let draggedCategoryId = null;

function handleCategoryDragStart(event, categoryId) {
  draggedCategoryId = categoryId;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.5';
}

function handleCategoryDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  return false;
}

async function handleCategoryDrop(event, targetCategoryId) {
  event.preventDefault();
  event.stopPropagation();

  if (!draggedCategoryId || draggedCategoryId === targetCategoryId) {
    resetCategoryDragState();
    return;
  }

  const draggedCategory = vendorCategories.find(c => c.id === draggedCategoryId);
  const targetCategory = vendorCategories.find(c => c.id === targetCategoryId);

  if (!draggedCategory || !targetCategory) {
    resetCategoryDragState();
    return;
  }

  // Ë°®Á§∫È†Ü„ÇíÂÖ•„ÇåÊõø„Åà
  const draggedOrder = draggedCategory.display_order;
  const targetOrder = targetCategory.display_order;

  showStatus('‰∏¶„Å≥Êõø„Åà‰∏≠...', 'saving');

  // ‰∏°Êñπ„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅÆË°®Á§∫È†Ü„ÇíÊõ¥Êñ∞
  const updates = [
    supabase.from('vendor_categories').update({ display_order: targetOrder }).eq('id', draggedCategoryId),
    supabase.from('vendor_categories').update({ display_order: draggedOrder }).eq('id', targetCategoryId)
  ];

  const results = await Promise.all(updates);

  if (results.some(r => r.error)) {
    showStatus('‰∏¶„Å≥Êõø„ÅàÂ§±Êïó', 'error');
    showToast('‰∏¶„Å≥Êõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    resetCategoryDragState();
    return;
  }

  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
  draggedCategory.display_order = targetOrder;
  targetCategory.display_order = draggedOrder;

  // ÂÜçÊèèÁîª
  renderCategoriesList();
  renderCategoryFilters();
  showStatus('‰∏¶„Å≥Êõø„ÅàÂÆå‰∫Ü', 'success');
  showToast('Ë°®Á§∫È†Ü„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü', 'success');
  resetCategoryDragState();
}

function resetCategoryDragState() {
  draggedCategoryId = null;
  // „Åô„Åπ„Å¶„ÅÆË°å„ÅÆÈÄèÊòéÂ∫¶„Çí„É™„Çª„ÉÉ„Éà
  document.querySelectorAll('#categoriesGrid tr[draggable]').forEach(tr => {
    tr.style.opacity = '1';
  });
}

function renderCategoryFilters() {
  const container = document.getElementById('categoryFilters');
  if (!container) return;

  let html = `<button class="category-filter-btn ${currentCategoryFilter === 'ALL' ? 'active' : ''}" onclick="setCategoryFilter('ALL')">ÂÖ®„Å¶ (${vendorsV2.length})</button>`;

  vendorCategories.forEach(cat => {
    const count = vendorsV2.filter(v => v.category_id === cat.id).length;
    html += `<button class="category-filter-btn ${currentCategoryFilter === cat.id ? 'active' : ''}" onclick="setCategoryFilter('${cat.id}')">${cat.name} (${count})</button>`;
  });

  container.innerHTML = html;
}

// ============================================
// ÂïÜÂìÅÁÆ°ÁêÜ
// ============================================
function renderProductsList() {
  const container = document.getElementById('productsGrid');
  if (!container) return;

  if (products.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><p>ÂïÜÂìÅ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p></div>';
    return;
  }

  // Ë°®Á§∫È†Ü„Åß„ÇΩ„Éº„Éà
  const sortedProducts = [...products].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));

  container.innerHTML = '<div class="table-container"><table class="table"><thead><tr><th style="width: 60px;"></th><th>ÂïÜÂìÅÂêç</th><th style="width: 100px;">Êìç‰Ωú</th></tr></thead><tbody>' +
    sortedProducts.map(product => `
      <tr draggable="true" ondragstart="handleProductDragStart(event, '${product.id}')" ondragover="handleProductDragOver(event)" ondrop="handleProductDrop(event, '${product.id}')" style="cursor: move;">
        <td><span style="color: var(--text-muted);">‚ãÆ‚ãÆ</span></td>
        <td><strong>${product.name}</strong></td>
        <td><button class="btn btn-danger btn-small" onclick="deleteProductInline('${product.id}')">ÂâäÈô§</button></td>
      </tr>
    `).join('') +
    '</tbody></table></div>';
}

async function addProductInline() {
  const name = document.getElementById('newProductNameInline').value.trim();

  if (!name) {
    showToast('ÂïÜÂìÅÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (products.find(p => p.name === name)) {
    showToast('Êó¢„Å´Â≠òÂú®„Åô„ÇãÂïÜÂìÅÂêç„Åß„Åô', 'error');
    return;
  }

  showStatus('ËøΩÂä†‰∏≠...', 'saving');

  const maxDisplayOrder = products.length > 0 ? Math.max(...products.map(p => p.display_order || 0)) : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('products')
    .insert([{ name, display_order: newDisplayOrder }])
    .select();

  if (error) {
    // „ÉÜ„Éº„Éñ„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÄÅ„É≠„Éº„Ç´„É´„Å´ËøΩÂä†
    products.push({ id: Date.now().toString(), name, display_order: newDisplayOrder });
    document.getElementById('newProductNameInline').value = '';
    renderProductsList();
    populateProductDropdown();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast('ÂïÜÂìÅ„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºà„É≠„Éº„Ç´„É´„ÅÆ„ÅøÔºâ', 'success');
    return;
  }

  products.push(data[0]);
  document.getElementById('newProductNameInline').value = '';
  renderProductsList();
  populateProductDropdown();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('ÂïÜÂìÅ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
}

async function deleteProductInline(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;

  if (!confirm(`ÂïÜÂìÅ„Äå${product.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

  showStatus('ÂâäÈô§‰∏≠...', 'saving');

  const { error } = await supabase
    .from('products')
    .delete()
    .eq('id', productId);

  if (error && !error.message.includes('does not exist')) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  products = products.filter(p => p.id !== productId);
  renderProductsList();
  populateProductDropdown();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('ÂïÜÂìÅ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÂïÜÂìÅ„ÅÆË°®Á§∫È†Ü„ÇíÂ§âÊõ¥
let draggedProductId = null;

function handleProductDragStart(event, productId) {
  draggedProductId = productId;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.5';
}

function handleProductDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  return false;
}

async function handleProductDrop(event, targetProductId) {
  event.preventDefault();
  event.stopPropagation();

  if (!draggedProductId || draggedProductId === targetProductId) {
    resetProductDragState();
    return;
  }

  const draggedProduct = products.find(p => p.id === draggedProductId);
  const targetProduct = products.find(p => p.id === targetProductId);

  if (!draggedProduct || !targetProduct) {
    resetProductDragState();
    return;
  }

  // Ë°®Á§∫È†Ü„ÇíÂÖ•„ÇåÊõø„Åà
  const draggedOrder = draggedProduct.display_order;
  const targetOrder = targetProduct.display_order;

  showStatus('‰∏¶„Å≥Êõø„Åà‰∏≠...', 'saving');

  // ‰∏°Êñπ„ÅÆÂïÜÂìÅ„ÅÆË°®Á§∫È†Ü„ÇíÊõ¥Êñ∞
  const updates = [
    supabase.from('products').update({ display_order: targetOrder }).eq('id', draggedProductId),
    supabase.from('products').update({ display_order: draggedOrder }).eq('id', targetProductId)
  ];

  const results = await Promise.all(updates);

  if (results.some(r => r.error)) {
    // „Ç®„É©„Éº„Åå„ÅÇ„Å£„Å¶„ÇÇ„É≠„Éº„Ç´„É´„ÅßÊõ¥Êñ∞
    draggedProduct.display_order = targetOrder;
    targetProduct.display_order = draggedOrder;
    renderProductsList();
    populateProductDropdown();
    showStatus('‰∏¶„Å≥Êõø„ÅàÂÆå‰∫Ü', 'success');
    showToast('Ë°®Á§∫È†Ü„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„ÅüÔºà„É≠„Éº„Ç´„É´„ÅÆ„ÅøÔºâ', 'success');
    resetProductDragState();
    return;
  }

  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
  draggedProduct.display_order = targetOrder;
  targetProduct.display_order = draggedOrder;

  // ÂÜçÊèèÁîª
  renderProductsList();
  populateProductDropdown();
  showStatus('‰∏¶„Å≥Êõø„ÅàÂÆå‰∫Ü', 'success');
  showToast('Ë°®Á§∫È†Ü„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü', 'success');
  resetProductDragState();
}

function resetProductDragState() {
  draggedProductId = null;
  // „Åô„Åπ„Å¶„ÅÆË°å„ÅÆÈÄèÊòéÂ∫¶„Çí„É™„Çª„ÉÉ„Éà
  document.querySelectorAll('#productsGrid tr[draggable]').forEach(tr => {
    tr.style.opacity = '1';
  });
}

function populateProductDropdown() {
  const select = document.getElementById('projectSpecifications');
  if (!select) return;

  const currentValue = select.value;
  select.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' +
    products.map(p => `<option value="${p.name}">${p.name}</option>`).join('');

  if (currentValue) select.value = currentValue;
}

// ============================================
// „Çø„Çπ„ÇØÁÆ°ÁêÜÔºàË®≠Ë®à„ÉªICÂàÜÈõ¢Ôºâ
// ============================================
function renderTasksManagement() {
  const container = document.getElementById('tasksGrid');
  if (!container) return;

  const sekkeiTasks = tasksV2.filter(t => t.category === 'Ë®≠Ë®à');

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>„Çø„Çπ„ÇØÂêç</th>
            <th style="width: 100px;">Áä∂ÊÖãÁÆ°ÁêÜ</th>
            <th style="width: 120px;">üìß„Éú„Çø„É≥</th>
            <th>Á¥ê„Å•„ÅëÊ•≠ËÄÖ</th>
            <th style="width: 180px;">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody id="sekkeiTasksBody">
          ${sekkeiTasks.map(task => renderTaskRow(task)).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
        üìê Ë®≠Ë®à„Çø„Çπ„ÇØ: ${sekkeiTasks.length}‰ª∂ÁôªÈå≤Ê∏à„Åø
      </p>
    </div>
  `;
}

function renderIcTasksManagement() {
  const container = document.getElementById('icTasksGrid');
  if (!container) return;

  const icTasks = tasksV2.filter(t => t.category === 'IC');

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>„Çø„Çπ„ÇØÂêç</th>
            <th style="width: 100px;">Áä∂ÊÖãÁÆ°ÁêÜ</th>
            <th style="width: 120px;">üìß„Éú„Çø„É≥</th>
            <th>Á¥ê„Å•„ÅëÊ•≠ËÄÖ</th>
            <th style="width: 180px;">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody id="icTasksBody">
          ${icTasks.map(task => renderTaskRow(task)).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
        üé® IC„Çø„Çπ„ÇØ: ${icTasks.length}‰ª∂ÁôªÈå≤Ê∏à„Åø
      </p>
    </div>
  `;
}

function renderTaskRow(task) {
  const mappings = taskVendorMappings.filter(m => m.task_id === task.id);
  const vendorNames = mappings.map(m => {
    const vendor = vendorsV2.find(v => v.id === m.vendor_id);
    return vendor ? vendor.company : '‰∏çÊòé';
  }).join(', ');

  const stateInfo = task.has_state ?
    `<span class="badge badge-success">„ÅÇ„Çä</span>` :
    `<span class="badge badge-secondary">„Å™„Åó</span>`;

  const emailButtonInfo = task.has_email_button ?
    `<span class="badge badge-success">Ë°®Á§∫</span>` :
    `<span class="badge badge-secondary">ÈùûË°®Á§∫</span>`;

  return `
    <tr draggable="true" ondragstart="handleTaskDragStart(event, '${task.id}')" ondragover="handleTaskDragOver(event)" ondrop="handleTaskDrop(event, '${task.id}')" style="cursor: move;">
      <td><span style="color: var(--text-muted);">‚ãÆ‚ãÆ</span></td>
      <td><strong>${task.task_name}</strong></td>
      <td>${stateInfo}</td>
      <td>${emailButtonInfo}</td>
      <td>${vendorNames || '-'}</td>
      <td>
        <button class="btn btn-secondary btn-small" onclick="editTask('${task.id}')">Á∑®ÈõÜ</button>
        <button class="btn btn-danger btn-small" onclick="deleteTask('${task.id}')">ÂâäÈô§</button>
      </td>
    </tr>
  `;
}

// ============================================
// Â§ñÊßãÊ•≠ÂãôÁÆ°ÁêÜ
// ============================================
// Â§ñÊßã„Çø„Çπ„ÇØ„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂÆöÁæ©
const defaultExteriorTasks = [
  { id: 'ext_hearing', name: '„Éí„Ç¢„É™„É≥„Ç∞', order: 1, states: ['Êú™ÁùÄÊâã', 'ÂÆå‰∫Ü'] },
  { id: 'ext_site_survey', name: 'ÁèæÂú∞Ë™øÊüª', order: 2, states: ['Êú™ÁùÄÊâã', 'Ë™øÊüªÊ∏à', 'Â†±ÂëäÊ∏à'] },
  { id: 'ext_first_proposal', name: 'ÂàùÂõûÊèêÊ°à', order: 3, states: ['Êú™ÁùÄÊâã', '‰ΩúÊàê‰∏≠', 'ÊèêÂá∫Ê∏à', 'ÊâøË™ç'] },
  { id: 'ext_estimate', name: 'Ë¶ãÁ©ç‰ΩúÊàê', order: 4, states: ['Êú™ÁùÄÊâã', '‰ΩúÊàê‰∏≠', 'ÊèêÂá∫Ê∏à', 'ÊâøË™ç'] },
  { id: 'ext_final_design', name: 'ÊúÄÁµÇË®≠Ë®à', order: 5, states: ['Êú™ÁùÄÊâã', '‰ΩúÊàê‰∏≠', 'Á¢∫ÂÆö'] },
  { id: 'ext_material_order', name: 'Ë≥áÊùêÁô∫Ê≥®', order: 6, states: ['Êú™ÁùÄÊâã', 'Áô∫Ê≥®Ê∏à', 'Á¥çÂìÅÊ∏à'] },
  { id: 'ext_construction', name: 'ÊñΩÂ∑•', order: 7, states: ['Êú™ÁùÄÊâã', 'ÁùÄÂ∑•', 'ÈÄ≤Ë°å‰∏≠', 'ÂÆåÂ∑•'] },
  { id: 'ext_inspection', name: 'ÂÆå‰∫ÜÊ§úÊüª', order: 8, states: ['Êú™ÁùÄÊâã', 'Ê§úÊüªÊ∏à', 'ÂºïÊ∏°ÂÆå‰∫Ü'] }
];

// Â§ñÊßã„Çø„Çπ„ÇØ„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„Åø
let exteriorTasks = JSON.parse(localStorage.getItem('exteriorTasks')) || defaultExteriorTasks;

function renderExteriorTasksManagement() {
  const container = document.getElementById('exteriorTasksGrid');
  if (!container) return;

  container.innerHTML = `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width: 60px;"></th>
            <th>„Çø„Çπ„ÇØÂêç</th>
            <th>„Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éó„Ç∑„Éß„É≥</th>
            <th style="width: 180px;">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody>
          ${exteriorTasks.map(task => `
            <tr>
              <td><span style="color: var(--text-muted);">‚ãÆ‚ãÆ</span></td>
              <td><strong>${task.name}</strong></td>
              <td>
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                  ${task.states.map(s => `<span class="badge badge-secondary">${s}</span>`).join('')}
                </div>
              </td>
              <td>
                <button class="btn btn-secondary btn-small" onclick="editExteriorTask('${task.id}')">Á∑®ÈõÜ</button>
                <button class="btn btn-danger btn-small" onclick="deleteExteriorTask('${task.id}')">ÂâäÈô§</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
        üí° Â§ñÊßãÊ•≠Âãô„Çø„Çπ„ÇØ„ÅØÊ°à‰ª∂„Ç´„Éº„Éâ„ÅÆ„ÄåÂ§ñÊßã‰æùÈ†º„Äç„Çª„ÇØ„Ç∑„Éß„É≥„Åß‰ΩøÁî®„Åï„Çå„Åæ„Åô„ÄÇ
        ÂêÑ„Çø„Çπ„ÇØ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíË®≠ÂÆö„Åó„Å¶„ÄÅÂ§ñÊßãË®≠Ë®à„ÅÆÈÄ≤Êçó„ÇíÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô„ÄÇ
      </p>
    </div>
  `;
}

function openExteriorTaskModal(taskId = null) {
  const name = taskId ? exteriorTasks.find(t => t.id === taskId)?.name : '';
  const states = taskId ? exteriorTasks.find(t => t.id === taskId)?.states.join(', ') : 'Êú™ÁùÄÊâã, ÂÆå‰∫Ü';

  const newName = prompt('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ:', name);
  if (!newName) return;

  const newStates = prompt('„Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éó„Ç∑„Éß„É≥Ôºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ:', states);
  if (!newStates) return;

  const statesArray = newStates.split(',').map(s => s.trim()).filter(s => s);

  if (taskId) {
    const task = exteriorTasks.find(t => t.id === taskId);
    if (task) {
      task.name = newName;
      task.states = statesArray;
    }
  } else {
    exteriorTasks.push({
      id: 'ext_' + Date.now(),
      name: newName,
      order: exteriorTasks.length + 1,
      states: statesArray
    });
  }

  localStorage.setItem('exteriorTasks', JSON.stringify(exteriorTasks));
  renderExteriorTasksManagement();
  showToast('Â§ñÊßã„Çø„Çπ„ÇØ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

function editExteriorTask(taskId) {
  openExteriorTaskModal(taskId);
}

function deleteExteriorTask(taskId) {
  if (!confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  exteriorTasks = exteriorTasks.filter(t => t.id !== taskId);
  localStorage.setItem('exteriorTasks', JSON.stringify(exteriorTasks));
  renderExteriorTasksManagement();
  showToast('„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

function openTaskModal(taskIdOrCategory = null) {
  const modal = document.getElementById('taskModal');
  const title = document.getElementById('taskModalTitle');

  // „Ç´„ÉÜ„Ç¥„É™Âêç„ÅåÊ∏°„Åï„Çå„ÅüÂ†¥ÂêàÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ
  const isCategory = taskIdOrCategory === 'Ë®≠Ë®à' || taskIdOrCategory === 'IC';

  if (taskIdOrCategory && !isCategory) {
    // Á∑®ÈõÜ„É¢„Éº„ÉâÔºàtaskId„ÅåÊ∏°„Åï„Çå„ÅüÔºâ
    const task = tasksV2.find(t => t.id === taskIdOrCategory);
    if (!task) return;

    title.textContent = '„Çø„Çπ„ÇØÁ∑®ÈõÜ';
    document.getElementById('taskId').value = task.id;
    document.getElementById('taskKey').value = task.task_key;
    document.getElementById('taskName').value = task.task_name;
    document.getElementById('taskCategory').value = task.category;
    document.getElementById('taskOrder').value = task.display_order;
    document.getElementById('taskHasState').checked = task.has_state;
    document.getElementById('taskStateOptions').value = task.state_options ? JSON.stringify(task.state_options) : '';
    document.getElementById('taskHasEmailButton').checked = task.has_email_button !== false;
    toggleTaskState();
    populateTaskVendorSelection(taskIdOrCategory);
  } else {
    // Êñ∞Ë¶èËøΩÂä†„É¢„Éº„Éâ
    const category = isCategory ? taskIdOrCategory : 'Ë®≠Ë®à';
    title.textContent = `${category}„Çø„Çπ„ÇØËøΩÂä†`;
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
    document.getElementById('taskCategory').value = category;
    document.getElementById('taskOrder').value = tasksV2.filter(t => t.category === category).length + 1;
    document.getElementById('taskHasState').checked = false;
    document.getElementById('taskHasEmailButton').checked = true;
    toggleTaskState();
    populateTaskVendorSelection(null);
  }

  modal.style.display = 'flex';
}

function populateTaskVendorSelection(taskId) {
  const container = document.getElementById('taskVendorSelection');
  if (!container) return;

  // ÁèæÂú®„ÅÆ„Çø„Çπ„ÇØ„Å´Á¥ê„Å•„ÅÑ„Å¶„ÅÑ„ÇãÊ•≠ËÄÖID„É™„Çπ„Éà„ÇíÂèñÂæó
  const currentMappings = taskId ? taskVendorMappings.filter(m => m.task_id === taskId).map(m => m.vendor_id) : [];

  // „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ„Åó„Å¶Ë°®Á§∫
  const categories = [...new Set(vendorsV2.map(v => v.vendor_categories?.name || 'Êú™ÂàÜÈ°û'))].sort();

  container.innerHTML = categories.map(category => {
    const categoryVendors = vendorsV2.filter(v => (v.vendor_categories?.name || 'Êú™ÂàÜÈ°û') === category);

    return `
      <div style="margin-bottom: 12px;">
        <div style="font-weight: 600; color: #4A90E2; margin-bottom: 4px; font-size: 12px;">${category}</div>
        ${categoryVendors.map(vendor => `
          <label style="display: block; padding: 4px 0; cursor: pointer;">
            <input type="checkbox"
                   value="${vendor.id}"
                   ${currentMappings.includes(vendor.id) ? 'checked' : ''}
                   style="margin-right: 8px;">
            ${vendor.company}
          </label>
        `).join('')}
      </div>
    `;
  }).join('');
}

function closeTaskModal() {
  document.getElementById('taskModal').style.display = 'none';
}

function toggleTaskState() {
  const hasState = document.getElementById('taskHasState').checked;
  const stateGroup = document.getElementById('stateOptionsGroup');
  stateGroup.style.display = hasState ? 'block' : 'none';
}

async function saveTask() {
  const id = document.getElementById('taskId').value;
  const taskName = document.getElementById('taskName').value.trim();
  const category = document.getElementById('taskCategory').value;
  const order = parseInt(document.getElementById('taskOrder').value) || 0;
  const hasState = document.getElementById('taskHasState').checked;
  const stateOptionsStr = document.getElementById('taskStateOptions').value.trim();
  const hasEmailButton = document.getElementById('taskHasEmailButton').checked;

  if (!taskName) {
    showToast('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  // „Çø„Çπ„ÇØ„Ç≠„Éº„ÇíËá™ÂãïÁîüÊàêÔºàÁ∑®ÈõÜÊôÇ„ÅØÊó¢Â≠ò„ÅÆ„Ç≠„Éº„Çí‰ΩøÁî®Ôºâ
  let taskKey = document.getElementById('taskKey').value;
  if (!taskKey) {
    // Êñ∞Ë¶è‰ΩúÊàêÊôÇÔºö„Çø„Çπ„ÇØÂêç„Åã„ÇâËá™ÂãïÁîüÊàêÔºàÊó•Êú¨Ë™û„ÇíÂâäÈô§„Åó„ÄÅ„Çπ„Éö„Éº„Çπ„Çí„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„Å´Â§âÊèõÔºâ
    taskKey = 'task_' + taskName.replace(/[\u3000-\u9FFF]/g, '').replace(/\s+/g, '_').toLowerCase() + '_' + Date.now();
    // ÂÆâÂÖ®„ÅÆ„Åü„ÇÅ„ÄÅËã±Êï∞Â≠ó„Å®„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„ÅÆ„Åø„Å´Âà∂Èôê
    taskKey = taskKey.replace(/[^a-z0-9_]/g, '_');
  }

  let stateOptions = null;
  if (hasState && stateOptionsStr) {
    try {
      stateOptions = JSON.parse(stateOptionsStr);
    } catch (e) {
      showToast('Áä∂ÊÖã„Ç™„Éó„Ç∑„Éß„É≥„ÅÆJSONÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  const taskData = {
    task_key: taskKey,
    task_name: taskName,
    category,
    display_order: order,
    has_state: hasState,
    state_options: stateOptions,
    has_email_button: hasEmailButton
  };

  let result;
  if (id) {
    result = await supabase
      .from('tasks')
      .update(taskData)
      .eq('id', id)
      .select();
  } else {
    result = await supabase
      .from('tasks')
      .insert([taskData])
      .select();
  }

  if (result.error) {
    showStatus('‰øùÂ≠òÂ§±Êïó', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error.message, 'error');
    return;
  }

  // Ê•≠ËÄÖÁ¥ê„Å•„Åë„ÅÆ‰øùÂ≠ò
  const savedTaskId = id || result.data[0].id;
  await saveTaskVendorMappings(savedTaskId);

  showStatus('‰øùÂ≠òÂÆå‰∫Ü', 'success');
  showToast(id ? '„Çø„Çπ„ÇØ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü' : '„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
  closeTaskModal();
  await loadTasksV2();
  await loadTaskVendorMappings();
  renderTasksManagement();
}

async function saveTaskVendorMappings(taskId) {
  // ÈÅ∏Êäû„Åï„Çå„ÅüÊ•≠ËÄÖID„ÇíÂèñÂæó
  const checkboxes = document.querySelectorAll('#taskVendorSelection input[type="checkbox"]:checked');
  const selectedVendorIds = Array.from(checkboxes).map(cb => cb.value);

  // Êó¢Â≠ò„ÅÆÁ¥ê„Å•„Åë„ÇíÂÖ®ÂâäÈô§
  await supabase
    .from('task_vendor_mappings_v2')
    .delete()
    .eq('task_id', taskId);

  // Êñ∞„Åó„ÅÑÁ¥ê„Å•„Åë„Çí‰ΩúÊàê
  if (selectedVendorIds.length > 0) {
    const mappings = selectedVendorIds.map(vendorId => ({
      task_id: taskId,
      vendor_id: vendorId
    }));

    const { error } = await supabase
      .from('task_vendor_mappings_v2')
      .insert(mappings);

    if (error) {
      console.error('Ê•≠ËÄÖÁ¥ê„Å•„Åë‰øùÂ≠ò„Ç®„É©„Éº:', error);
      showToast('Ê•≠ËÄÖÁ¥ê„Å•„Åë„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    }
  }
}

function editTask(taskId) {
  openTaskModal(taskId);
}

async function deleteTask(taskId) {
  const task = tasksV2.find(t => t.id === taskId);
  if (!task) return;

  if (!confirm(`„Çø„Çπ„ÇØ„Äå${task.task_name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

  showStatus('ÂâäÈô§‰∏≠...', 'saving');

  const { error } = await supabase
    .from('tasks')
    .delete()
    .eq('id', taskId);

  if (error) {
    showStatus('ÂâäÈô§Â§±Êïó', 'error');
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  showStatus('ÂâäÈô§ÂÆå‰∫Ü', 'success');
  showToast('„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
  await loadTasksV2();
  renderTasksManagement();
}

// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åß„Çø„Çπ„ÇØ„ÅÆË°®Á§∫È†Ü„ÇíÂ§âÊõ¥
let draggedTaskId = null;

function handleTaskDragStart(event, taskId) {
  draggedTaskId = taskId;
  event.dataTransfer.effectAllowed = 'move';
  event.target.style.opacity = '0.5';
}

function handleTaskDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  return false;
}

async function handleTaskDrop(event, targetTaskId) {
  event.preventDefault();
  event.stopPropagation();

  if (!draggedTaskId || draggedTaskId === targetTaskId) {
    resetDragState();
    return;
  }

  const draggedTask = tasksV2.find(t => t.id === draggedTaskId);
  const targetTask = tasksV2.find(t => t.id === targetTaskId);

  if (!draggedTask || !targetTask) {
    resetDragState();
    return;
  }

  // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™ÂÜÖ„Åß„ÅÆ„Åø‰∏¶„Å≥Êõø„ÅàÂèØËÉΩ
  if (draggedTask.category !== targetTask.category) {
    showToast('Âêå„Åò„Ç´„ÉÜ„Ç¥„É™ÂÜÖ„Åß„ÅÆ„Åø‰∏¶„Å≥Êõø„ÅàÂèØËÉΩ„Åß„Åô', 'error');
    resetDragState();
    return;
  }

  // Ë°®Á§∫È†Ü„ÇíÂÖ•„ÇåÊõø„Åà
  const draggedOrder = draggedTask.display_order;
  const targetOrder = targetTask.display_order;

  showStatus('‰∏¶„Å≥Êõø„Åà‰∏≠...', 'saving');

  // ‰∏°Êñπ„ÅÆ„Çø„Çπ„ÇØ„ÅÆË°®Á§∫È†Ü„ÇíÊõ¥Êñ∞
  const updates = [
    supabase.from('tasks').update({ display_order: targetOrder }).eq('id', draggedTaskId),
    supabase.from('tasks').update({ display_order: draggedOrder }).eq('id', targetTaskId)
  ];

  const results = await Promise.all(updates);

  if (results.some(r => r.error)) {
    showStatus('‰∏¶„Å≥Êõø„ÅàÂ§±Êïó', 'error');
    showToast('‰∏¶„Å≥Êõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    resetDragState();
    return;
  }

  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
  draggedTask.display_order = targetOrder;
  targetTask.display_order = draggedOrder;

  // ÂÜçÊèèÁîª
  renderTasksManagement();
  showStatus('‰∏¶„Å≥Êõø„ÅàÂÆå‰∫Ü', 'success');
  showToast('Ë°®Á§∫È†Ü„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü', 'success');
  resetDragState();
}

function resetDragState() {
  draggedTaskId = null;
  // „Åô„Åπ„Å¶„ÅÆË°å„ÅÆÈÄèÊòéÂ∫¶„Çí„É™„Çª„ÉÉ„Éà
  document.querySelectorAll('#tasksGrid tr[draggable]').forEach(tr => {
    tr.style.opacity = '1';
  });
}

// ============================================
// UIÂà∂Âæ°
// ============================================
// „Çµ„Ç§„Éâ„Éê„ÉºÊèèÁîª
function renderSidebar() {
  const container = document.getElementById('sidebarContent');
  if (!container) return;

  const sekkeiDesigners = designers.filter(d => d.category === 'Ë®≠Ë®à').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const icDesigners = designers.filter(d => d.category === 'IC').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const allCount = projects.filter(p => p.status !== 'completed').length;

  let html = `
    <div class="sidebar-section">
      <div class="sidebar-item ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="selectDesigner('ALL')">
        <span class="sidebar-item-label">ÂÖ®Ê°à‰ª∂</span>
        <span class="sidebar-item-count">${allCount}</span>
      </div>
    </div>
  `;

  // ‰ª∂Êï∞„Å´„Çà„ÇãËâ≤ÂàÜ„Åë„Éò„É´„Éë„ÉºÈñ¢Êï∞
  function getCountStyle(count) {
    if (count >= 7) {
      return 'color: #dc2626; font-weight: 700;'; // Ëµ§Ëâ≤ÔºàÂç±Èô∫Ôºâ
    } else if (count >= 5) {
      return 'color: #d97706; font-weight: 600;'; // ÈªÑËâ≤ÔºàÊ≥®ÊÑèÔºâ
    }
    return ''; // ÈÄöÂ∏∏Ôºà4‰ª∂‰ª•‰∏ãÔºâ
  }

  function getCountBadgeClass(count) {
    if (count >= 7) return 'badge-danger';
    if (count >= 5) return 'badge-warning';
    return 'badge-primary';
  }

  if (sekkeiDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">üìê Ë®≠Ë®àÊãÖÂΩì</div>';
    sekkeiDesigners.forEach(designer => {
      const count = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const designerName = designer.name.trim();
        return assigned === designerName && p.status !== 'completed' && !p.is_archived;
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-item-count ${badgeClass}">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  if (icDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">üé® ICÊãÖÂΩì</div>';
    icDesigners.forEach(designer => {
      const count = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const icAssigned = (p.ic_assignee || '').trim();
        const designerName = designer.name.trim();
        return (assigned === designerName || icAssigned === designerName) && p.status !== 'completed' && !p.is_archived;
      }).length;
      const nameStyle = getCountStyle(count);
      const badgeClass = getCountBadgeClass(count);
      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label" style="${nameStyle}">${designer.name}</span>
          <span class="sidebar-item-count ${badgeClass}">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  container.innerHTML = html;
}

function selectDesigner(name) {
  currentDesignerTab = name;

  // URL„ÇíÊõ¥Êñ∞
  updateURLWithDesigner(name);

  renderSidebar();
  renderProjects();
}

// „É°„Ç§„É≥„Çø„ÉñÂàá„ÇäÊõø„Åà
function switchMainTab(tabName, element) {
  console.log('üìë switchMainTab ÈñãÂßã:', {
    tabName: tabName,
    isHandlingHashChange: isHandlingHashChange,
    currentHash: window.location.hash,
    timestamp: new Date().toISOString()
  });

  document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) element.classList.add('active');

  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');

  // ÂàÜÊûê„Çø„Éñ„ÅÆÂ†¥Âêà„ÅØ„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
  if (tabName === 'analytics') {
    updateAnalyticsDashboard();
  }

  // „Ç´„É¨„É≥„ÉÄ„Éº„Çø„Éñ„ÅÆÂ†¥Âêà„ÅØÊèèÁîª
  if (tabName === 'calendar') {
    CalendarView.render();
  }

  // URL„ÇíÊõ¥Êñ∞ÔºàhandleHashChangeÂá¶ÁêÜ‰∏≠„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
  if (!isHandlingHashChange && window.location.hash !== '#' + tabName) {
    console.log('üîó switchMainTab: URL„ÇíÊõ¥Êñ∞:', tabName);
    window.location.hash = tabName;
  } else {
    console.log('‚è∏Ô∏è switchMainTab: URLÊõ¥Êñ∞„Çí„Çπ„Ç≠„ÉÉ„Éó (isHandlingHashChange=' + isHandlingHashChange + ')');
  }
}

// „Çµ„Éñ„Çø„ÉñÂàá„ÇäÊõø„Åà
function switchSubTab(panelName, element) {
  console.log('üìë switchSubTab ÈñãÂßã:', {
    panelName: panelName,
    isHandlingHashChange: isHandlingHashChange,
    currentHash: window.location.hash,
    timestamp: new Date().toISOString()
  });

  document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
  if (element) element.classList.add('active');

  document.querySelectorAll('.sub-tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(panelName + 'Panel').classList.add('active');

  // URL„ÇíÊõ¥Êñ∞ÔºàhandleHashChangeÂá¶ÁêÜ‰∏≠„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
  if (!isHandlingHashChange && window.location.hash !== `#settings/${panelName}`) {
    console.log('üîó switchSubTab: URL„ÇíÊõ¥Êñ∞:', panelName);
    window.location.hash = `settings/${panelName}`;
  } else {
    console.log('‚è∏Ô∏è switchSubTab: URLÊõ¥Êñ∞„Çí„Çπ„Ç≠„ÉÉ„Éó (isHandlingHashChange=' + isHandlingHashChange + ')');
  }

  // „Çµ„Éñ„Çø„ÉñÂàá„ÇäÊõø„ÅàÊôÇ„Å´ÂØæÂøú„Åô„ÇãÊèèÁîªÈñ¢Êï∞„ÇíÂÆüË°å
  switch(panelName) {
    case 'staff':
      renderDesignerListInline();
      break;
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
    case 'icTasks':
      renderIcTasksManagement();
      break;
    case 'exteriorTasks':
      renderExteriorTasksManagement();
      break;
    case 'products':
      renderProductsList();
      break;
    case 'kintone':
      loadKintoneSettings();
      break;
  }
}

// ÊóßswitchTabÈñ¢Êï∞Ôºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
function switchTab(tabName, element) {
  document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
  if (element) {
    element.classList.add('active');
  } else {
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºötabName„Å´Âü∫„Å•„ÅÑ„Å¶„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éú„Çø„É≥„ÇíË¶ã„Å§„Åë„Çã
    const buttons = document.querySelectorAll('.tab-nav-btn');
    buttons.forEach((btn, index) => {
      const tabs = ['projects', 'vendors', 'categories', 'tasks', 'settings'];
      if (tabs[index] === tabName) {
        btn.classList.add('active');
      }
    });
  }
  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');

  // „Çø„ÉñÂàá„ÇäÊõø„ÅàÊôÇ„Å´ÂØæÂøú„Åô„ÇãÊèèÁîªÈñ¢Êï∞„ÇíÂÆüË°å
  switch(tabName) {
    case 'vendors':
      renderCategoryFilters();
      renderVendorsV2();
      break;
    case 'categories':
      renderCategoriesList();
      break;
    case 'tasks':
      renderTasksManagement();
      break;
  }
}

// „Ç´„ÉÜ„Ç¥„É™„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÂãïÁöÑ„Å´ÁîüÊàê
function populateVendorCategoryDropdown() {
  const dropdown = document.getElementById('vendorCategory');
  if (!dropdown) return;

  dropdown.innerHTML = '<option value="">„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû...</option>' +
    vendorCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
}

function showStatus(message, type) {
  const indicator = document.getElementById('statusIndicator');
  const text = document.getElementById('statusText');
  indicator.className = 'status-indicator status-' + type;
  text.textContent = message;
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.className = 'toast toast-' + type + ' show';
  toast.textContent = message;

  // „Çπ„ÇØ„É™„Éº„É≥„É™„Éº„ÉÄ„Éº„Å´„ÇÇÈÄöÁü•
  announceToScreenReader(message);

  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// „Çπ„ÇØ„É™„Éº„É≥„É™„Éº„ÉÄ„ÉºÁî®„Ç¢„Éä„Ç¶„É≥„Çπ
function announceToScreenReader(message, priority = 'polite') {
  const liveRegion = document.getElementById('liveRegion');
  if (liveRegion) {
    liveRegion.setAttribute('aria-live', priority);
    liveRegion.textContent = message;
    // Âêå„Åò„É°„ÉÉ„Çª„Éº„Ç∏„Åß„ÇÇÂÜçÈÄöÁü•„Åô„Çã„Åü„ÇÅ„Å´‰∏ÄÂ∫¶„ÇØ„É™„Ç¢
    setTimeout(() => {
      liveRegion.textContent = '';
    }, 1000);
  }
}

// ============================================
// „Éñ„É©„Ç¶„Ç∂ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†
// ============================================
const NotificationSystem = {
  permission: 'default',
  soundEnabled: localStorage.getItem('notificationSound') !== 'false',

  async init() {
    if ('Notification' in window) {
      this.permission = Notification.permission;
      console.log('üîî ÈÄöÁü•Ê®©Èôê:', this.permission);
    }
  },

  async requestPermission() {
    if (!('Notification' in window)) {
      showToast('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈÄöÁü•„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', 'warning');
      return false;
    }

    try {
      const permission = await Notification.requestPermission();
      this.permission = permission;

      if (permission === 'granted') {
        showToast('ÈÄöÁü•„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„Åü', 'success');
        return true;
      } else {
        showToast('ÈÄöÁü•„ÅåË®±ÂèØ„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü', 'warning');
        return false;
      }
    } catch (error) {
      console.error('ÈÄöÁü•Ê®©Èôê„É™„ÇØ„Ç®„Çπ„Éà„Ç®„É©„Éº:', error);
      return false;
    }
  },

  async send(title, options = {}) {
    if (this.permission !== 'granted') {
      console.log('ÈÄöÁü•Ê®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
      return null;
    }

    const defaultOptions = {
      icon: '/archideck/icon-192.png',
      badge: '/archideck/badge.png',
      tag: 'archideck-notification',
      requireInteraction: false,
      ...options
    };

    try {
      // „Çµ„Ç¶„É≥„ÉâÂÜçÁîü
      if (this.soundEnabled && options.sound !== false) {
        this.playSound();
      }

      const notification = new Notification(title, defaultOptions);

      notification.onclick = () => {
        window.focus();
        notification.close();
        if (options.onClick) options.onClick();
      };

      return notification;
    } catch (error) {
      console.error('ÈÄöÁü•ÈÄÅ‰ø°„Ç®„É©„Éº:', error);
      return null;
    }
  },

  playSound() {
    try {
      // „Ç∑„É≥„Éó„É´„Å™ÈÄöÁü•Èü≥„ÇíÁîüÊàê
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = 800;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    } catch (e) {
      console.log('ÈÄöÁü•Èü≥ÂÜçÁîü„Ç®„É©„ÉºÔºàÁÑ°Ë¶ñÂèØÔºâ:', e);
    }
  },

  toggleSound() {
    this.soundEnabled = !this.soundEnabled;
    localStorage.setItem('notificationSound', this.soundEnabled);
    showToast(this.soundEnabled ? 'ÈÄöÁü•Èü≥„Çí„Ç™„É≥„Å´„Åó„Åæ„Åó„Åü' : 'ÈÄöÁü•Èü≥„Çí„Ç™„Éï„Å´„Åó„Åæ„Åó„Åü', 'info');
    return this.soundEnabled;
  },

  // ÊúüÈôêÈñìËøë„ÅÆÊ°à‰ª∂„ÇíÈÄöÁü•
  async checkDeadlines() {
    const today = new Date();
    const threeDaysLater = new Date(today);
    threeDaysLater.setDate(today.getDate() + 3);

    const upcomingDeadlines = projects.filter(p => {
      if (!p.tasks || p.status === 'completed' || p.is_archived) return false;

      return Object.entries(p.tasks).some(([key, task]) => {
        if (!task.due_date || task.status === 'completed') return false;
        const dueDate = new Date(task.due_date);
        return dueDate >= today && dueDate <= threeDaysLater;
      });
    });

    if (upcomingDeadlines.length > 0) {
      await this.send('ÊúüÈôêÈñìËøë„ÅÆ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô', {
        body: `${upcomingDeadlines.length}‰ª∂„ÅÆÊ°à‰ª∂„Å´ÊúüÈôê„ÅåËøë„ÅÑ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô`,
        tag: 'deadline-warning'
      });
    }
  }
};

// ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', () => {
  NotificationSystem.init();
});

// ============================================
// „É°„Éº„É´‰ΩúÊàêÔºàÊñ∞„Ç∑„Çπ„ÉÜ„É†Ôºâ
// ============================================
function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  if (!taskDef) {
    showToast('„Çø„Çπ„ÇØÂÆöÁæ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  // „Åì„ÅÆ„Çø„Çπ„ÇØ„Å´Á¥ê„Å•„ÅèÊ•≠ËÄÖ„ÇíÂèñÂæó
  const mappings = taskVendorMappings.filter(m => m.task_id === taskDef.id);
  const linkedVendors = mappings.map(m => vendorsV2.find(v => v.id === m.vendor_id)).filter(v => v);

  if (linkedVendors.length === 0) {
    showToast('„Åì„ÅÆ„Çø„Çπ„ÇØ„Å´„ÅØÊ•≠ËÄÖ„ÅåÁ¥ê„Å•„ÅÑ„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return;
  }

  if (linkedVendors.length === 1) {
    // Ê•≠ËÄÖ„Åå1„Å§„ÅÆÂ†¥Âêà„ÅØÁõ¥Êé•„É°„Éº„É´‰ΩúÊàêÁîªÈù¢„ÇíË°®Á§∫
    openEmailComposer(project, taskDef, linkedVendors[0]);
  } else {
    // Ê•≠ËÄÖ„ÅåË§áÊï∞„ÅÆÂ†¥Âêà„ÅØÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫
    showVendorSelection(project, taskDef, linkedVendors);
  }
}

function showVendorSelection(project, taskDef, vendors) {
  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  content.innerHTML = `
    <h3 style="margin-bottom: 16px;">Ê•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
    <div style="display: flex; flex-direction: column; gap: 12px;">
      ${vendors.map(vendor => `
        <button class="template-select-btn" onclick="openEmailComposer(
          projects.find(p => p.id === '${project.id}'),
          tasksV2.find(t => t.id === '${taskDef.id}'),
          vendorsV2.find(v => v.id === '${vendor.id}')
        )">
          <div style="font-weight: 600; margin-bottom: 4px;">${vendor.company}</div>
          <div style="font-size: 13px; color: var(--text-secondary);">${vendor.contact || ''}</div>
        </button>
      `).join('')}
    </div>
  `;

  modal.style.display = 'flex';
}

function openEmailComposer(project, taskDef, vendor) {
  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  // ÁèæÂú®„ÅÆÊãÖÂΩìËÄÖÊÉÖÂ†±„ÇíÂèñÂæó
  const assignee = designers.find(d => d.name === project.assigned_to);
  const staffName = assignee?.name || project.assigned_to;

  // ÊúüÊó•„ÇíË®àÁÆóÔºà‰ªäÊó•+1ÈÄ±ÈñìÔºâ
  const dueDate = new Date();
  dueDate.setDate(dueDate.getDate() + 7);
  const dueDateStr = `${dueDate.getMonth() + 1}/${dueDate.getDate()}`;

  // Â§âÊï∞ÁΩÆÊèõÁî®„ÅÆ„Éá„Éº„Çø
  const variables = {
    company: vendor.company,
    contact: vendor.contact || '',
    customerName: project.customer,
    dueDate: dueDateStr,
    staffName: staffName,
    specialContent: vendor.default_special_content || ''
  };

  // ‰ª∂Âêç„Å®Êú¨Êñá„ÅÆÁΩÆÊèõ
  let subject = vendor.subject_format || '';
  let body = vendor.template_text || '';

  Object.keys(variables).forEach(key => {
    const regex = new RegExp(`\\{${key}\\}`, 'g');
    subject = subject.replace(regex, variables[key]);
    body = body.replace(regex, variables[key]);
  });

  // „É°„Éº„É´‰ΩúÊàêUI
  content.innerHTML = `
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <div>
        <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">Ê•≠ËÄÖ</div>
        <div style="padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
          <div style="font-weight: 600;">${vendor.company}</div>
          <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">${vendor.contact || ''}</div>
        </div>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">ÂÆõÂÖà</label>
        <input type="email" id="emailTo" class="form-input" value="${vendor.email || ''}" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ">
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">‰ª∂Âêç</label>
        <input type="text" id="emailSubject" class="form-input" value="${subject}">
      </div>

      ${vendor.has_special_content ? `
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">ÁâπÂà•„Ç≥„É≥„ÉÜ„É≥„ÉÑ</label>
          <textarea id="emailSpecialContent" class="form-textarea" rows="3">${vendor.default_special_content || ''}</textarea>
          <div class="form-hint">Êú¨Êñá‰∏≠„ÅÆ {specialContent} „Å´ÁΩÆÊèõ„Åï„Çå„Åæ„Åô</div>
        </div>
      ` : ''}

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">ÊúüÊó•</label>
        <input type="text" id="emailDueDate" class="form-input" value="${dueDateStr}">
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Êú¨Êñá„Éó„É¨„Éì„É•„Éº</label>
        <textarea id="emailBody" class="form-textarea" rows="15">${body}</textarea>
      </div>

      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn btn-ghost" onclick="closeEmailModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn btn-primary" onclick="copyEmailToClipboard()">üìã „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº</button>
      </div>
    </div>
  `;

  // ÁâπÂà•„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇÑÊúüÊó•„ÅÆÂ§âÊõ¥ÊôÇ„Å´Êú¨Êñá„ÇíÊõ¥Êñ∞
  if (vendor.has_special_content) {
    document.getElementById('emailSpecialContent').addEventListener('input', () => updateEmailBody(vendor, variables));
  }
  document.getElementById('emailDueDate').addEventListener('input', () => updateEmailBody(vendor, variables));

  modal.style.display = 'flex';
}

function updateEmailBody(vendor, baseVariables) {
  const specialContent = document.getElementById('emailSpecialContent')?.value || baseVariables.specialContent;
  const dueDate = document.getElementById('emailDueDate').value;

  const variables = { ...baseVariables, specialContent, dueDate };

  let body = vendor.template_text || '';
  Object.keys(variables).forEach(key => {
    const regex = new RegExp(`\\{${key}\\}`, 'g');
    body = body.replace(regex, variables[key]);
  });

  document.getElementById('emailBody').value = body;
}

function copyEmailToClipboard() {
  const to = document.getElementById('emailTo').value;
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;

  const emailText = `To: ${to}\nSubject: ${subject}\n\n${body}`;

  navigator.clipboard.writeText(emailText).then(() => {
    showToast('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
  }).catch(err => {
    showToast('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  });
}

function closeEmailModal() {
  document.getElementById('emailModal').style.display = 'none';
}

// ============================================
// Ê°à‰ª∂ÁÆ°ÁêÜ
// ============================================
function renderDesignerTabs() {
  const container = document.getElementById('designerTabs');
  if (!container) {
    console.warn('‚ö†Ô∏è designerTabsË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
    return;
  }

  console.log('üé® ÊãÖÂΩìËÄÖ„Çø„ÉñÊèèÁîª:', {
    'Á∑è„Çπ„Çø„ÉÉ„ÉïÊï∞': designers.length,
    'Ë®≠Ë®àÊãÖÂΩì': designers.filter(d => d.category === 'Ë®≠Ë®à').length,
    'ICÊãÖÂΩì': designers.filter(d => d.category === 'IC').length,
    'Ê°à‰ª∂Êï∞': projects.length
  });

  const activeCount = projects.filter(p => p.status !== 'completed').length;

  let html = `<button class="designer-tab ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="setDesignerTab('ALL')">ÂÖ®Ê°à‰ª∂ (${activeCount})</button>`;

  // Ë®≠Ë®àÊãÖÂΩì
  const sekkeiDesigners = designers.filter(d => d.category === 'Ë®≠Ë®à');
  console.log('üìê Ë®≠Ë®àÊãÖÂΩì:', sekkeiDesigners.map(d => d.name));
  if (sekkeiDesigners.length > 0) {
    html += '<div class="designer-group-label">Ë®≠Ë®àÊãÖÂΩì</div>';
    sekkeiDesigners.forEach(designer => {
      const designerProjects = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const designerName = designer.name.trim();
        return assigned === designerName && p.status !== 'completed' && !p.is_archived;
      });
      const count = designerProjects.length;

      html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
    });
  } else {
    console.warn('‚ö†Ô∏è Ë®≠Ë®àÊãÖÂΩì„Åå0Âêç„Åß„Åô');
  }

  // ICÊãÖÂΩì
  const icDesigners = designers.filter(d => d.category === 'IC');
  console.log('üé® ICÊãÖÂΩì:', icDesigners.map(d => d.name));
  if (icDesigners.length > 0) {
    html += '<div class="designer-group-label">ICÊãÖÂΩì</div>';
    icDesigners.forEach(designer => {
      const designerProjects = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const icAssigned = (p.ic_assignee || '').trim();
        const designerName = designer.name.trim();
        return (assigned === designerName || icAssigned === designerName) && p.status !== 'completed' && !p.is_archived;
      });
      const count = designerProjects.length;

      html += `<button class="designer-tab ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="setDesignerTab('${designer.name}')">${designer.name} (${count})</button>`;
    });
  }

  container.innerHTML = html;
}

function setDesignerTab(name) {
  currentDesignerTab = name;

  // URL„ÇíÊõ¥Êñ∞
  updateURLWithDesigner(name);

  renderDesignerTabs();
  renderProjects();
}

function renderProjects() {
  const container = document.getElementById('projectsGrid');
  const emptyState = document.getElementById('emptyProjects');

  console.log('üé® renderProjects() ÈñãÂßã');
  console.log('üìä ÁèæÂú®„ÅÆ„Çø„Éñ:', currentDesignerTab);
  console.log('üìä ÂÖ®Ê°à‰ª∂Êï∞:', projects.length);
  console.log('üìä ÂÖ®Ê°à‰ª∂:', projects.map(p => ({ customer: p.customer, assigned_to: p.assigned_to, ic_assignee: p.ic_assignee })));

  let filtered = projects.filter(p => {
    // ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„ÉºÔºàË®≠Ë®à„Åæ„Åü„ÅØICÊãÖÂΩìËÄÖÔºâ
    if (currentDesignerTab !== 'ALL') {
      const assigned = (p.assigned_to || '').trim();
      const icAssigned = (p.ic_assignee || '').trim();
      const currentTab = currentDesignerTab.trim();

      if (assigned !== currentTab && icAssigned !== currentTab) {
        console.log(`‚ùå „Éï„Ç£„É´„Çø„ÅßÈô§Â§ñ: ${p.customer} (assigned_to: "${p.assigned_to}" (trim: "${assigned}"), ic_assignee: "${p.ic_assignee}" (trim: "${icAssigned}"), currentTab: "${currentTab}")`);
        return false;
      }
    }

    // „Ç¢„Éº„Ç´„Ç§„Éñ„Éï„Ç£„É´„Çø„Éº
    const archiveFilter = document.getElementById('archiveFilter').value;
    const isArchived = p.is_archived || false;
    if (archiveFilter === 'active' && isArchived) return false;
    if (archiveFilter === 'archived' && !isArchived) return false;
    if (archiveFilter === 'favorites' && !FavoritesManager.isFavorite(p.id)) return false;

    const query = document.getElementById('searchQuery').value.toLowerCase();
    if (query && !p.customer.toLowerCase().includes(query) && !(p.memo || '').toLowerCase().includes(query)) return false;

    const specFilter = document.getElementById('specFilter').value;
    if (specFilter && p.specifications !== specFilter) return false;

    return true;
  });

  console.log('‚úÖ „Éï„Ç£„É´„ÇøÂæå„ÅÆÊ°à‰ª∂Êï∞:', filtered.length);
  console.log('‚úÖ „Éï„Ç£„É´„ÇøÂæå„ÅÆÊ°à‰ª∂:', filtered.map(p => ({ customer: p.customer, assigned_to: p.assigned_to })));

  // „ÅäÊ∞ó„Å´ÂÖ•„Çä„ÇíÂÖàÈ†≠„Å´„ÇΩ„Éº„Éà
  filtered.sort((a, b) => {
    const aFav = FavoritesManager.isFavorite(a.id) ? 1 : 0;
    const bFav = FavoritesManager.isFavorite(b.id) ? 1 : 0;
    return bFav - aFav;
  });

  if (filtered.length === 0) {
    container.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  container.style.display = 'grid';
  emptyState.style.display = 'none';
  container.innerHTML = filtered.map(project => renderProjectCard(project)).join('');

  // „Ç´„Éº„ÉâÊèèÁîªÂæå„Å´„Çø„Çπ„ÇØ„Å®Ë≠∞‰∫ãÈå≤„ÇíË™≠„ÅøËæº„ÇÄ
  setTimeout(() => {
    filtered.forEach(project => {
      loadProjectTasksList(project.id);
      loadMinutesList(project.id);
    });
  }, 50);
}

// Ê°à‰ª∂„Ç´„Éº„Éâ„Å´„Çπ„ÇØ„É≠„Éº„É´
function scrollToProject(projectId) {
  const card = document.querySelector(`[data-project-id="${projectId}"]`);
  if (card) {
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    card.classList.add('highlight-card');
    setTimeout(() => card.classList.remove('highlight-card'), 2000);
  }
}

// „Ç´„Éº„ÉâÂçò‰Ωç„ÅßÂÜçÊèèÁîªÔºà„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÈñãÈñâÁä∂ÊÖã„Çí‰øùÊåÅÔºâ
function updateSingleProjectCard(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const cardElement = document.querySelector(`[data-project-id="${projectId}"]`);
  if (!cardElement) return;

  // „Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÈñãÈñâÁä∂ÊÖã„Çí‰øùÊåÅ
  const sectionStates = [];
  cardElement.querySelectorAll('.card-section').forEach((section, idx) => {
    sectionStates[idx] = !section.classList.contains('collapsed');
  });

  // „Ç´„Éº„Éâ„ÇíÂÜçÊèèÁîª
  const newCard = document.createElement('div');
  newCard.innerHTML = renderProjectCard(project);
  const newCardElement = newCard.firstElementChild;

  // „Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÈñãÈñâÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
  newCardElement.querySelectorAll('.card-section').forEach((section, idx) => {
    if (sectionStates[idx]) {
      section.classList.remove('collapsed');
    }
  });

  cardElement.replaceWith(newCardElement);

  // Ë≠∞‰∫ãÈå≤„Éª„Çø„Çπ„ÇØ„ÅÆÂÜç„É≠„Éº„Éâ
  loadProjectMinutes(projectId);
  loadProjectTasks(projectId);
  loadHandover(projectId);
}

function renderProjectCard(project) {
  const progress = calculateProgress(project);
  const progressData = project.progress || {};
  const tasks = getTasksForAssignee(project.assigned_to);

  // ÂÖ®„Çø„Çπ„ÇØÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
  const canArchive = tasks.every(taskDef => {
    const task = progressData[taskDef.task_key] || { completed: false, state: '' };
    if (!task.completed) return false;
    if (taskDef.has_state && task.state !== '‰øùÂ≠òÊ∏à') return false;
    return true;
  });

  // Áî≥Ë´ãGOÊù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
  const applicationGoEnabled = canPressApplicationGo(project);

  // ‚ö†Ô∏è „Éü„Çπ„ÉªÊºè„ÇåÈò≤Ê≠¢: Ë≠¶Âëä„ÉÅ„Çß„ÉÉ„ÇØ
  const warnings = [];

  // ÊãÖÂΩìËÄÖÊú™Ââ≤ÂΩì„ÉÅ„Çß„ÉÉ„ÇØ
  if (!project.assigned_to) {
    warnings.push({ type: 'danger', message: 'Ë®≠Ë®àÊãÖÂΩì„ÅåÊú™Ââ≤ÂΩì' });
  }

  // ÈáçË¶Å„Çø„Çπ„ÇØÊú™ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØÔºàÈÄ≤Êçó50%‰ª•‰∏ä„ÅßÈñìÂèñÁ¢∫ÂÆö„ÅåÊú™ÂÆå‰∫ÜÔºâ
  if (progress >= 50) {
    const layoutTask = progressData['layout_confirmed'];
    if (!layoutTask?.completed) {
      warnings.push({ type: 'warning', message: 'ÈñìÂèñÁ¢∫ÂÆö„ÅåÊú™ÂÆå‰∫Ü' });
    }
  }

  // ÈÄ≤Êçó80%‰ª•‰∏ä„ÅßÁî≥Ë´ãGO„ÅåÊú™ÂÆå‰∫Ü
  if (progress >= 80 && !progressData['application']?.completed) {
    warnings.push({ type: 'warning', message: 'Áî≥Ë´ãGO„ÅåÊú™ÂÆå‰∫Ü' });
  }

  // ÁùÄÂ∑•Êó•„ÅåËøë„ÅÑÔºà14Êó•‰ª•ÂÜÖÔºâ„ÅÆ„Å´ÈÄ≤Êçó„Åå‰Ωé„ÅÑ
  if (project.construction_start_date) {
    const startDate = new Date(project.construction_start_date);
    const today = new Date();
    const daysUntilStart = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
    if (daysUntilStart <= 14 && daysUntilStart > 0 && progress < 90) {
      warnings.push({ type: 'danger', message: `ÁùÄÂ∑•„Åæ„Åß${daysUntilStart}Êó•ÔºàÈÄ≤Êçó${progress}%Ôºâ` });
    }
  }

  // Ë≠¶ÂëäHTMLÁîüÊàê
  const warningsHtml = warnings.length > 0 ? `
    <div class="project-warnings" style="margin-bottom:12px;">
      ${warnings.map(w => `<div class="warning-badge warning-${w.type}"><span class="warning-icon">${w.type === 'danger' ? 'üö®' : '‚ö†Ô∏è'}</span>${w.message}</div>`).join('')}
    </div>
  ` : '';

  const tasksHtml = tasks.map(taskDef => {
    const key = taskDef.task_key;
    const task = progressData[key] || { completed: false, date: '', state: '', due_date: '' };
    const isApplicationGo = key === 'application';
    const disabledClass = isApplicationGo && !applicationGoEnabled ? 'disabled' : '';

    const hasVendor = taskVendorMappings.some(m => m.task_id === taskDef.id);
    const showEmailButton = taskDef.has_email_button !== false && hasVendor;
    const emailBtn = showEmailButton ?
      `<button class="task-email-btn" onclick="openEmailFromTask('${project.id}', '${key}')" title="„É°„Éº„É´‰ΩúÊàê">üìß</button>` : '';

    let stateSelect = '';
    const stateOptions = getTaskStateOptions(key);
    if (stateOptions && Array.isArray(stateOptions)) {
      // „Çπ„ÉÜ„Éº„Çø„ÇπËâ≤ÂàÜ„Åë: ÊúÄÂæå„ÅÆÈÅ∏ÊäûËÇ¢=Èùí„ÄÅÁ©∫/-=ÁôΩ„ÄÅ„Åù„ÅÆ‰ªñ=ÈªÑ
      const lastOption = stateOptions[stateOptions.length - 1];
      let stateClass = '';
      if (task.state && task.state !== '-' && task.state !== '') {
        stateClass = task.state === lastOption ? 'state-blue' : 'state-yellow';
      }
      stateSelect = `<select class="task-state-select ${stateClass}" onchange="updateTaskState('${project.id}', '${key}', this.value)">${stateOptions.map(state => `<option value="${state}" ${task.state === state ? 'selected' : ''}>${state || '-'}</option>`).join('')}</select>`;
    }

    return `<div class="task-item ${disabledClass}" ${isApplicationGo && !applicationGoEnabled ? 'title="Â§™ÈôΩÂÖâ:Âñ∂Ê•≠ÂÖ±ÊúâÊ∏à„ÄÅÁµ¶ÊéíÊ∞¥:‰øùÂ≠òÊ∏à„ÄÅÊèõÊ∞ó:‰øùÂ≠òÊ∏à„ÄÅ„Çµ„ÉÉ„Ç∑:‰øùÂ≠òÊ∏à „ÅåÂøÖË¶Å"' : ''}>
      <span class="task-label">${taskDef.task_name}</span>${stateSelect}${emailBtn}</div>`;
  }).join('');

  const isFavorite = FavoritesManager.isFavorite(project.id);
  const isSelected = BatchOperations.isSelected(project.id);

  return `<div class="project-card ${isFavorite ? 'favorite' : ''} ${isSelected ? 'selected' : ''}" data-project-id="${project.id}">
    <div class="card-header">
      <div style="display: flex; align-items: flex-start; gap: 8px;">
        <input type="checkbox" class="batch-checkbox" data-project-id="${project.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); BatchOperations.toggle('${project.id}')" title="ÈÅ∏Êäû">
        <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="event.stopPropagation(); FavoritesManager.toggle('${project.id}')" title="${isFavorite ? '„ÅäÊ∞ó„Å´ÂÖ•„ÇäËß£Èô§' : '„ÅäÊ∞ó„Å´ÂÖ•„ÇäÁôªÈå≤'}">${isFavorite ? '‚òÖ' : '‚òÜ'}</button>
        <div>
          <div class="card-title"><span class="customer-name">${project.customer}</span><span class="badge badge-primary">${project.specifications || 'LIFE'}</span>${project.is_archived ? '<span class="badge badge-success">ÂÆå‰∫ÜÊ∏à„Åø</span>' : ''}</div>
          <div class="card-subtitle"><span class="quick-edit-trigger" onclick="event.stopPropagation(); QuickEdit.showAssigneeDropdown('${project.id}', this)" style="cursor: pointer; text-decoration: underline dotted;" title="„ÇØ„É™„ÉÉ„ÇØ„ÅßÊãÖÂΩìËÄÖÂ§âÊõ¥">Ë®≠Ë®àÔºö${project.assigned_to || 'Êú™Ââ≤ÂΩì'}</span>${project.ic_assignee ? ` | ICÔºö${project.ic_assignee}` : ''}${project.exterior_assignee ? ` | Â§ñÊßãÔºö${project.exterior_assignee}` : ''}${(() => { const ds = DeadlineManager.getStatus(project.id); return ds ? ` <span style="background: ${ds.color}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 8px;" onclick="event.stopPropagation(); DeadlineManager.showModal('${project.id}')" title="ÊúüÈôê„ÇíÂ§âÊõ¥">üìÖ ${ds.label}</span>` : ` <span style="color: var(--text-muted); font-size: 11px; cursor: pointer;" onclick="event.stopPropagation(); DeadlineManager.showModal('${project.id}')" title="ÊúüÈôê„ÇíË®≠ÂÆö">üìÖ ÊúüÈôêË®≠ÂÆö</span>`; })()}</div>
        </div>
      </div>
      <div style="display: flex; gap: 8px;">
        ${project.is_archived ? `<button class="btn btn-success btn-small" onclick="toggleArchive('${project.id}', false)">Âæ©ÂÖÉ</button>` : canArchive ? `<button class="btn btn-warning btn-small" onclick="toggleArchive('${project.id}', true)">ÂÆå‰∫ÜÊ∏à„Åø„Å´„Åô„Çã</button>` : ''}
        <button class="btn btn-ghost btn-small" onclick="editProject('${project.id}')">Á∑®ÈõÜ</button>
      </div>
    </div>
    ${warningsHtml}
    <div class="progress-section"><div class="progress-header"><span class="progress-label">ÈÄ≤ÊçóÁä∂Ê≥Å</span><span class="progress-value">${progress}%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div></div>

    <div class="card-section collapsed"><div class="card-section-header" onclick="toggleCardSection(this)"><span class="card-section-title">‚úÖ „Çø„Çπ„ÇØ</span><span class="card-section-toggle">‚ñº</span></div><div class="card-section-content"><div id="projectTasksList_${project.id}" class="project-task-list"></div><div class="add-task-form"><input type="text" id="newTaskName_${project.id}" placeholder="„Çø„Çπ„ÇØÂêç" inputmode="text"><input type="date" id="newTaskDue_${project.id}"><button class="btn btn-small btn-primary" onclick="addProjectTask('${project.id}', document.getElementById('newTaskName_${project.id}').value, document.getElementById('newTaskDue_${project.id}').value)">ËøΩÂä†</button></div></div></div>

    <div class="card-section collapsed"><div class="card-section-header" onclick="toggleCardSection(this)"><span class="card-section-title">üìù „É°„É¢Ê¨Ñ</span><span class="card-section-toggle">‚ñº</span></div><div class="card-section-content"><textarea class="shared-memo-area" id="sharedMemo_${project.id}" placeholder="„É°„É¢„ÇíÂÖ•Âäõ...">${project.shared_memo || ''}</textarea><button class="btn btn-small btn-ghost" style="margin-top:8px" onclick="saveSharedMemo('${project.id}')">„É°„É¢„Çí‰øùÂ≠ò</button></div></div>

    <div class="card-section collapsed"><div class="card-section-header" onclick="toggleCardSection(this)"><span class="card-section-title">üìÑ Ë≠∞‰∫ãÈå≤</span><span class="card-section-toggle">‚ñº</span></div><div class="card-section-content"><div id="minutesList_${project.id}" class="minutes-list"></div><div style="margin-bottom:12px;padding:12px;background:var(--bg-tertiary);border-radius:8px;"><label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:6px;">ÊâìÂêà„ÅõÊó•</label><input type="date" id="meetingDate_${project.id}" style="width:100%;padding:8px 12px;border:1px solid var(--border-color);border-radius:6px;font-size:14px;"></div><div class="minutes-upload-area" id="minutesDropArea_${project.id}" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDropWithDate(event, '${project.id}')" onclick="triggerMinutesUpload('${project.id}')"><input type="file" id="minutesUpload_${project.id}" style="display:none" accept=".pdf,.doc,.docx,.xls,.xlsx" onchange="uploadMinutesWithDate('${project.id}', this.files[0])"><span>üìÅ „ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</span><div style="font-size:12px;color:var(--text-muted);margin-top:4px">PDF, Word, ExcelÂØæÂøú</div></div></div></div>

    <div class="card-section collapsed"><div class="card-section-header" onclick="toggleCardSection(this)"><span class="card-section-title">üìã ÂºïÁ∂ôÊõ∏</span><span class="card-section-toggle">‚ñº</span></div><div class="card-section-content"><textarea class="handover-content" id="handover_${project.id}" placeholder="ÂºïÁ∂ôÊõ∏„ÅÆÂÜÖÂÆπ„ÇíÂÖ•Âäõ..."></textarea><button class="btn btn-small btn-ghost" style="margin-top:8px" onclick="saveHandover('${project.id}')">ÂºïÁ∂ôÊõ∏„Çí‰øùÂ≠ò</button></div></div>

    <div class="card-section collapsed"><div class="card-section-header" onclick="toggleCardSection(this)"><span class="card-section-title">üìã Ê•≠ÂãôÂÜÖÂÆπ</span><span class="card-section-toggle">‚ñº</span></div><div class="card-section-content"><div class="tasks-grid">${tasksHtml}</div></div></div>

    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--bg-secondary);display:flex;justify-content:space-between;align-items:center"><span style="font-size:13px;color:var(--text-muted)">Êõ¥Êñ∞: ${formatDateTime(project.updated_at)}</span><button class="btn btn-danger btn-small" onclick="deleteProject('${project.id}')">ÂâäÈô§</button></div>
  </div>`;
}

function calculateProgress(project) {
  const progressData = project.progress || {};
  const tasks = getTasksForAssignee(project.assigned_to);
  if (tasks.length === 0) return 0;
  const completed = tasks.filter(taskDef => progressData[taskDef.task_key]?.completed).length;
  return Math.round((completed / tasks.length) * 100);
}

function formatDateTime(dateStr) {
  if (!dateStr) return '‚Äî';
  const d = new Date(dateStr);
  return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
}

async function updateTaskStatus(projectId, taskKey, completed) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // UndoÁî®„Å´Â§âÊõ¥Ââç„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠ò
  const oldProgress = JSON.parse(JSON.stringify(project.progress || {}));

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].completed = completed;
  if (completed && !progressData[taskKey].date) {
    progressData[taskKey].date = new Date().toISOString().split('T')[0];
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  // UndoË®òÈå≤
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  UndoManager.record({
    type: 'UPDATE_PROJECT',
    projectId: projectId,
    description: `${project.customer} - ${taskDef?.task_name || taskKey}„Çí${completed ? 'ÂÆå‰∫Ü' : 'Êú™ÂÆå‰∫Ü'}„Å´Â§âÊõ¥`,
    oldValue: { progress: oldProgress },
    newValue: { progress: progressData }
  });

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  renderProjects();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
}

// „Çø„Çπ„ÇØÊúüÈôê„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂà§ÂÆö
function getTaskDueStatus(dueDate, completed) {
  if (!dueDate || completed) {
    return { class: '', badgeClass: 'normal', label: '' };
  }

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const due = new Date(dueDate);
  due.setHours(0, 0, 0, 0);
  const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

  if (diffDays < 0) {
    return { class: 'overdue', badgeClass: 'overdue', label: `${Math.abs(diffDays)}Êó•ÈÅÖÂª∂` };
  } else if (diffDays === 0) {
    return { class: 'due-soon', badgeClass: 'overdue', label: 'Êú¨Êó•ÊúüÈôê' };
  } else if (diffDays <= 3) {
    return { class: 'due-soon', badgeClass: 'due-soon', label: `„ÅÇ„Å®${diffDays}Êó•` };
  } else {
    const m = due.getMonth() + 1;
    const d = due.getDate();
    return { class: '', badgeClass: 'normal', label: `${m}/${d}` };
  }
}

// „Çø„Çπ„ÇØÊúüÈôê„ÅÆÊõ¥Êñ∞
async function updateTaskDueDate(projectId, taskKey, dueDate) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // ÈÅéÂéªÊó•‰ªò„ÉÅ„Çß„ÉÉ„ÇØÔºàË≠¶Âëä„ÅÆ„Åø„ÄÅ‰øùÂ≠ò„ÅØË®±ÂèØÔºâ
  if (dueDate && !Validators.isNotPastDate(dueDate)) {
    const confirmPast = confirm('ÈÅéÂéª„ÅÆÊó•‰ªò„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åì„ÅÆÊó•‰ªò„Åß‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü');
    if (!confirmPast) {
      renderProjects();
      return;
    }
  }

  // UndoÁî®„Å´Â§âÊõ¥Ââç„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠ò
  const oldProgress = JSON.parse(JSON.stringify(project.progress || {}));
  const oldDueDate = oldProgress[taskKey]?.due_date || '';

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = { completed: false, date: '', state: '' };
  progressData[taskKey].due_date = dueDate;

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    ErrorHandler.handle(error, 'ÊúüÈôê‰øùÂ≠ò');
    return;
  }

  // UndoË®òÈå≤
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  UndoManager.record({
    type: 'UPDATE_PROJECT',
    projectId: projectId,
    description: `${project.customer} - ${taskDef?.task_name || taskKey}„ÅÆÊúüÈôê„Çí${dueDate || 'Ëß£Èô§'}„Å´Â§âÊõ¥`,
    oldValue: { progress: oldProgress },
    newValue: { progress: progressData }
  });

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  renderProjects();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  if (dueDate) {
    showToast('ÊúüÈôê„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü', 'success');
  }
}

async function updateTaskState(projectId, taskKey, state) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // UndoÁî®„Å´Â§âÊõ¥Ââç„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠ò
  const oldProgress = JSON.parse(JSON.stringify(project.progress || {}));
  const oldState = oldProgress[taskKey]?.state || '';

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].state = state;

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  // UndoË®òÈå≤
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  UndoManager.record({
    type: 'UPDATE_PROJECT',
    projectId: projectId,
    description: `${project.customer} - ${taskDef?.task_name || taskKey}„Çí„Äå${state || 'Êú™Ë®≠ÂÆö'}„Äç„Å´Â§âÊõ¥`,
    oldValue: { progress: oldProgress },
    newValue: { progress: progressData }
  });

  project.progress = progressData;
  project.updated_at = new Date().toISOString();
  updateSingleProjectCard(projectId);
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
}

function openProjectModal(projectId = null) {
  console.log('üìù openProjectModal() Âëº„Å≥Âá∫„Åó:', projectId);
  console.log('üë• designersÈÖçÂàó:', designers);

  editingProjectId = projectId;
  const modal = document.getElementById('projectModal');
  const title = document.getElementById('projectModalTitle');

  console.log('üéØ modalË¶ÅÁ¥†:', modal);
  console.log('üéØ titleË¶ÅÁ¥†:', title);

  let project = null;
  if (projectId) {
    project = projects.find(p => p.id === projectId);
    title.textContent = 'Ê°à‰ª∂Á∑®ÈõÜ';
    document.getElementById('projectCustomer').value = project.customer;
    document.getElementById('projectSpecifications').value = project.specifications || 'LIFE';
    document.getElementById('projectMemo').value = project.memo || '';
  } else {
    title.textContent = 'Ê°à‰ª∂ËøΩÂä†';
    document.getElementById('projectCustomer').value = '';
    document.getElementById('projectSpecifications').value = 'LIFE';
    document.getElementById('projectMemo').value = '';
  }

  // Ë®≠Ë®àÊãÖÂΩìËÄÖÔºàË®≠Ë®à„Ç´„ÉÜ„Ç¥„É™„ÅÆ„ÅøÔºâ„ÇíÂüã„ÇÅ„Çã
  console.log('üîß Ë®≠Ë®àÊãÖÂΩìËÄÖ„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞‰∏≠...');
  const sekkeiDesigners = designers.filter(d => d.category === 'Ë®≠Ë®à');
  console.log('‚úÖ Ë®≠Ë®àÊãÖÂΩìËÄÖ:', sekkeiDesigners);

  const assignedToSelect = document.getElementById('projectAssignedTo');
  console.log('üéØ assignedToSelectË¶ÅÁ¥†:', assignedToSelect);

  if (assignedToSelect) {
    assignedToSelect.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' +
      sekkeiDesigners.map(d => `<option value="${d.name}">${d.name}</option>`).join('');

    // ÂÄ§„ÇíË®≠ÂÆöÔºàinnerHTMLÂæå„Å´ÂÆüË°åÔºâ
    if (projectId && project) {
      // Á∑®ÈõÜÊôÇ: Êó¢Â≠ò„ÅÆÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû
      assignedToSelect.value = project.assigned_to;
    } else if (currentDesignerTab !== 'ALL') {
      // Êñ∞Ë¶èÊ°à‰ª∂„ÅÆÂ†¥Âêà„ÄÅÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„Çø„Éñ„ÅÆÊãÖÂΩìËÄÖ„ÇíËá™ÂãïÈÅ∏Êäû
      const currentDesigner = sekkeiDesigners.find(d => d.name === currentDesignerTab);
      if (currentDesigner) {
        assignedToSelect.value = currentDesigner.name;
      }
    }
  }

  // ICÊãÖÂΩìËÄÖÔºàIC„Ç´„ÉÜ„Ç¥„É™„ÅÆ„ÅøÔºâ„ÇíÂüã„ÇÅ„Çã
  console.log('üîß ICÊãÖÂΩìËÄÖ„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞‰∏≠...');
  const icDesigners = designers.filter(d => d.category === 'IC');
  console.log('‚úÖ ICÊãÖÂΩìËÄÖ:', icDesigners);

  const icAssigneeSelect = document.getElementById('projectIcAssignee');
  console.log('üéØ icAssigneeSelectË¶ÅÁ¥†:', icAssigneeSelect);

  if (icAssigneeSelect) {
    icAssigneeSelect.innerHTML = '<option value="">Êú™ÂÆö</option>' +
      icDesigners.map(d => `<option value="${d.name}">${d.name}</option>`).join('');

    // ÂÄ§„ÇíË®≠ÂÆöÔºàinnerHTMLÂæå„Å´ÂÆüË°åÔºâ
    if (projectId && project) {
      // Á∑®ÈõÜÊôÇ: Êó¢Â≠ò„ÅÆICÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû
      icAssigneeSelect.value = project.ic_assignee || '';
    }
  }

  // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°ÔºàÁ∑®ÈõÜÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ
  const templateButtons = document.getElementById('templateButtons');
  if (templateButtons) {
    templateButtons.style.display = projectId ? 'block' : 'none';
  }

  console.log('üé¨ „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫„Åó„Åæ„Åô...');
  modal.classList.add('show');
  console.log('‚úÖ openProjectModal() ÂÆå‰∫Ü');
}

function closeProjectModal() {
  document.getElementById('projectModal').classList.remove('show');
  editingProjectId = null;
}

async function saveProject() {
  const customer = document.getElementById('projectCustomer').value.trim();
  const assignedTo = document.getElementById('projectAssignedTo').value.trim(); // trim()ËøΩÂä†
  const icAssignee = document.getElementById('projectIcAssignee').value.trim(); // trim()ËøΩÂä†
  const specifications = document.getElementById('projectSpecifications').value;
  const memo = document.getElementById('projectMemo').value.trim();

  console.log('üíæ saveProjectÈñãÂßã:', { customer, assignedTo, icAssignee, specifications });

  if (!customer || !assignedTo) {
    showToast('„ÅäÂÆ¢ÊßòÂêç„Å®Ë®≠Ë®àÊãÖÂΩì„ÅØÂøÖÈ†à„Åß„Åô', 'error');
    return;
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  // Ë®≠Ë®àÊãÖÂΩì„ÅÆID„ÇíÂèñÂæó
  const designer = designers.find(d => d.name.trim() === assignedTo);
  const designerId = designer ? designer.id : null;

  // ICÊãÖÂΩìËÄÖ„ÅÆID„ÇíÂèñÂæóÔºàÁ©∫ÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÅØnullÔºâ
  const icDesigner = icAssignee ? designers.find(d => d.name.trim() === icAssignee) : null;
  const icDesignerId = icDesigner ? icDesigner.id : null;

  const blankProgress = {};
  tasksV2.forEach(task => {
    blankProgress[task.task_key] = { completed: false, date: '', state: '' };
  });

  if (editingProjectId) {
    const project = projects.find(p => p.id === editingProjectId);
    const { error } = await supabase
      .from('projects')
      .update({
        customer,
        assigned_to: assignedTo,
        designer_id: designerId,
        ic_assignee: icAssignee || null,
        ic_designer_id: icDesignerId,
        specifications,
        memo,
        updated_at: new Date().toISOString()
      })
      .eq('id', editingProjectId);

    if (error) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    Object.assign(project, {
      customer,
      assigned_to: assignedTo,
      ic_assignee: icAssignee || null,
      ic_designer_id: icDesignerId,
      specifications,
      memo,
      updated_at: new Date().toISOString()
    });
  } else {
    const newProject = {
      uid: 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      customer,
      assigned_to: assignedTo,
      designer_id: designerId,
      ic_assignee: icAssignee || null,
      ic_designer_id: icDesignerId,
      specifications,
      memo,
      status: 'active',
      progress: blankProgress,
      created_by: currentUser?.id || null
    };

    const { data, error } = await supabase
      .from('projects')
      .insert([newProject])
      .select();

    if (error) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    console.log('‚úÖ Êñ∞Ë¶èÊ°à‰ª∂‰øùÂ≠òÊàêÂäü:', data[0]);
    console.log('üìä assigned_to:', data[0].assigned_to);
    console.log('üìä ic_assignee:', data[0].ic_assignee);
    projects.unshift(data[0]);
  }

  console.log('üîÑ renderDesignerTabs()„Å®renderProjects()„ÇíÂÆüË°å„Åó„Åæ„Åô');
  console.log('üìä ÁèæÂú®„ÅÆprojectsÊï∞:', projects.length);
  closeProjectModal();
  renderDesignerTabs();
  renderProjects();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('Ê°à‰ª∂„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

function editProject(projectId) {
  openProjectModal(projectId);
}

async function deleteProject(projectId) {
  if (!confirm('„Åì„ÅÆÊ°à‰ª∂„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  showStatus('ÂâäÈô§‰∏≠...', 'saving');
  const { error } = await supabase
    .from('projects')
    .delete()
    .eq('id', projectId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  projects = projects.filter(p => p.id !== projectId);
  renderDesignerTabs();
  renderProjects();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('Ê°à‰ª∂„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

async function toggleArchive(projectId, isArchived) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const message = isArchived ? 'ÂÆå‰∫ÜÊ∏à„Åø„Å´„Åó„Åæ„Åô„ÅãÔºü' : 'Ê°à‰ª∂„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü';
  if (!confirm(message)) return;

  showStatus('Êõ¥Êñ∞‰∏≠...', 'saving');

  const updateData = {
    is_archived: isArchived,
    archived_at: isArchived ? new Date().toISOString() : null
  };

  const { error } = await supabase
    .from('projects')
    .update(updateData)
    .eq('id', projectId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
  project.is_archived = isArchived;
  project.archived_at = updateData.archived_at;

  renderProjects();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast(isArchived ? 'Ê°à‰ª∂„ÇíÂÆå‰∫ÜÊ∏à„Åø„Å´„Åó„Åæ„Åó„Åü' : 'Ê°à‰ª∂„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü', 'success');
}

// ============================================
// „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜÊ©üËÉΩ
// ============================================
function openDesignerModal() {
  renderDesignerList();
  document.getElementById('designerModal').classList.add('show');
}

function closeDesignerModal() {
  document.getElementById('designerModal').classList.remove('show');
}

function renderDesignerList() {
  const container = document.getElementById('designerList');

  // „Ç´„ÉÜ„Ç¥„É™„Åß‰∏¶„Å≥Êõø„ÅàÔºàË®≠Ë®à‚ÜíICÔºâ
  const sortedDesigners = [...designers].sort((a, b) => {
    if (a.category === 'Ë®≠Ë®à' && b.category === 'IC') return -1;
    if (a.category === 'IC' && b.category === 'Ë®≠Ë®à') return 1;
    return (a.display_order || 999) - (b.display_order || 999);
  });

  container.innerHTML = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">ÁôªÈå≤Ê∏à„Åø„Çπ„Çø„ÉÉ„ÉïÔºà' + designers.length + 'ÂêçÔºâ</h3>' +
    '<div class="table-container"><table class="table"><thead><tr><th>„Çπ„Çø„ÉÉ„ÉïÂêç</th><th>„Ç´„ÉÜ„Ç¥„É™</th><th>ÊãÖÂΩìÊ°à‰ª∂Êï∞</th><th>Êìç‰Ωú</th></tr></thead><tbody>' +
    sortedDesigners.map(designer => {
      const count = projects.filter(p => p.assigned_to === designer.name).length;
      const categoryLabel = designer.category === 'Ë®≠Ë®à' ? 'Ë®≠Ë®àÊãÖÂΩì' : 'ICÊãÖÂΩì';
      return `
        <tr>
          <td><strong>${designer.name}</strong></td>
          <td><span class="badge ${designer.category === 'Ë®≠Ë®à' ? 'badge-primary' : 'badge-success'}">${categoryLabel}</span></td>
          <td>${count}‰ª∂</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteDesigner('${designer.id}')">ÂâäÈô§</button></td>
        </tr>
      `;
    }).join('') +
    '</tbody></table></div>';
}

async function addDesigner() {
  const name = document.getElementById('newDesignerName').value.trim();
  const category = document.getElementById('newDesignerCategory').value;

  if (!name) {
    showToast('„Çπ„Çø„ÉÉ„ÉïÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('Êó¢„Å´Â≠òÂú®„Åô„Çã„Çπ„Çø„ÉÉ„ÉïÂêç„Åß„Åô', 'error');
    return;
  }

  showStatus('ËøΩÂä†‰∏≠...', 'saving');

  // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™„ÅÆÊúÄÂ§ßdisplay_order„ÇíÂèñÂæó„Åó„Å¶+1
  const sameCategoryDesigners = designers.filter(d => d.category === category);
  const maxDisplayOrder = sameCategoryDesigners.length > 0
    ? Math.max(...sameCategoryDesigners.map(d => d.display_order || 0))
    : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('designers')
    .insert([{ name, category, email: `${name.replace(/\s/g, '')}@temp.local`, created_by: currentUser?.id, display_order: newDisplayOrder }])
    .select();

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerName').value = '';
  renderDesignerList();
  renderDesignerTabs();
  renderSidebar();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„Çπ„Çø„ÉÉ„Éï„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
}

async function deleteDesigner(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('„Åì„ÅÆ„Çπ„Çø„ÉÉ„Éï„ÅØÊ°à‰ª∂„Å´Ââ≤ÂΩì„Å¶„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÊ°à‰ª∂„ÅÆÊãÖÂΩì„ÇíÂ§âÊõ¥„Åó„Å¶„Åã„ÇâÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
    return;
  }

  if (!confirm(`${designer.name}„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

  showStatus('ÂâäÈô§‰∏≠...', 'saving');
  const { error } = await supabase
    .from('designers')
    .delete()
    .eq('id', designerId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  designers = designers.filter(d => d.id !== designerId);
  renderDesignerList();
  renderDesignerListInline();
  renderSidebar();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„Çπ„Çø„ÉÉ„Éï„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

// „Ç§„É≥„É©„Ç§„É≥Áâà„Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜÈñ¢Êï∞
function renderDesignerListInline() {
  const container = document.getElementById('designerListInline');
  if (!container) return;

  const sekkeiDesigners = [...designers].filter(d => d.category === 'Ë®≠Ë®à').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const icDesigners = [...designers].filter(d => d.category === 'IC').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const exteriorDesigners = [...designers].filter(d => d.category === 'Â§ñÊßã').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));

  let html = '<h3 style="margin: 24px 0 16px; font-size: 18px; font-weight: 600;">ÁôªÈå≤Ê∏à„Åø„Çπ„Çø„ÉÉ„ÉïÔºà' + designers.length + 'ÂêçÔºâ</h3>';
  html += '<p style="color: var(--text-secondary); margin-bottom: 16px;">üí° Ë°å„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åó„Å¶Ë°®Á§∫È†ÜÂ∫è„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô</p>';

  // „Çπ„Çø„ÉÉ„ÉïË°å„ÇíÁîüÊàê„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
  function renderDesignerRow(designer, category, countField) {
    const count = projects.filter(p => p[countField] === designer.name).length;
    const emailDisplay = designer.email && !designer.email.includes('@temp.local') ? designer.email : '<span style="color: var(--text-muted);">Êú™Ë®≠ÂÆö</span>';
    const canManageAuth = currentUserCategory === 'admin' || designer.id === currentDesigner?.id;
    const authButton = canManageAuth ? `<button class="btn btn-secondary btn-small" onclick="openDesignerAuthModal('${designer.id}')" style="margin-right: 4px;">üîë</button>` : '';
    return `
      <tr class="draggable-row" draggable="true" data-designer-id="${designer.id}" data-category="${category}">
        <td><span class="drag-handle">‚â°</span></td>
        <td><strong>${designer.name}</strong></td>
        <td>${emailDisplay}</td>
        <td>${count}‰ª∂</td>
        <td>
          <button class="btn btn-ghost btn-small" onclick="openEditDesignerModal('${designer.id}')" style="margin-right: 4px;">‚úèÔ∏è Á∑®ÈõÜ</button>
          ${authButton}
          <button class="btn btn-danger btn-small" onclick="deleteDesignerInline('${designer.id}')">ÂâäÈô§</button>
        </td>
      </tr>
    `;
  }

  // Ë®≠Ë®àÊãÖÂΩì
  if (sekkeiDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--primary-color);">üìê Ë®≠Ë®àÊãÖÂΩì</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>„Çπ„Çø„ÉÉ„ÉïÂêç</th><th>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th><th>ÊãÖÂΩìÊ°à‰ª∂Êï∞</th><th>Êìç‰Ωú</th></tr></thead><tbody id="sekkeiTbody">';
    sekkeiDesigners.forEach(designer => {
      html += renderDesignerRow(designer, 'Ë®≠Ë®à', 'assigned_to');
    });
    html += '</tbody></table></div>';
  }

  // ICÊãÖÂΩì
  if (icDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: var(--success-color);">üé® ICÊãÖÂΩì</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>„Çπ„Çø„ÉÉ„ÉïÂêç</th><th>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th><th>ÊãÖÂΩìÊ°à‰ª∂Êï∞</th><th>Êìç‰Ωú</th></tr></thead><tbody id="icTbody">';
    icDesigners.forEach(designer => {
      html += renderDesignerRow(designer, 'IC', 'ic_assignee');
    });
    html += '</tbody></table></div>';
  }

  // Â§ñÊßãÊãÖÂΩì
  if (exteriorDesigners.length > 0) {
    html += '<h4 style="margin: 20px 0 12px; color: #8bc34a;">üå≥ Â§ñÊßãÊãÖÂΩì</h4>';
    html += '<div class="table-container"><table class="table"><thead><tr><th width="40"></th><th>„Çπ„Çø„ÉÉ„ÉïÂêç</th><th>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th><th>ÊãÖÂΩìÊ°à‰ª∂Êï∞</th><th>Êìç‰Ωú</th></tr></thead><tbody id="exteriorTbody">';
    exteriorDesigners.forEach(designer => {
      html += renderDesignerRow(designer, 'Â§ñÊßã', 'exterior_assignee');
    });
    html += '</tbody></table></div>';
  }

  container.innerHTML = html;

  // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Ç§„Éô„É≥„ÉàË®≠ÂÆö
  setupDragAndDrop();
}

// „Çπ„Çø„ÉÉ„ÉïÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´
function openEditDesignerModal(designerId) {
  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.id = 'editDesignerModal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">„Çπ„Çø„ÉÉ„ÉïÁ∑®ÈõÜ</h2>
        <button class="close" onclick="closeEditDesignerModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editDesignerId" value="${designer.id}">
        <div class="form-group">
          <label class="form-label">„Çπ„Çø„ÉÉ„ÉïÂêç *</label>
          <input type="text" class="form-input" id="editDesignerName" value="${designer.name}" style="width: 100%;">
        </div>
        <div class="form-group">
          <label class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
          <input type="email" class="form-input" id="editDesignerEmail" value="${designer.email && !designer.email.includes('@temp.local') ? designer.email : ''}" placeholder="‰æã: staff@example.com" style="width: 100%;">
        </div>
        <div class="form-group">
          <label class="form-label">„Ç´„ÉÜ„Ç¥„É™</label>
          <select class="form-input" id="editDesignerCategory" style="width: 100%;">
            <option value="Ë®≠Ë®à" ${designer.category === 'Ë®≠Ë®à' ? 'selected' : ''}>Ë®≠Ë®àÊãÖÂΩì</option>
            <option value="IC" ${designer.category === 'IC' ? 'selected' : ''}>ICÊãÖÂΩì</option>
            <option value="Â§ñÊßã" ${designer.category === 'Â§ñÊßã' ? 'selected' : ''}>Â§ñÊßãÊãÖÂΩì</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeEditDesignerModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn btn-primary" onclick="saveEditDesigner()">‰øùÂ≠ò</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function closeEditDesignerModal() {
  const modal = document.getElementById('editDesignerModal');
  if (modal) modal.remove();
}

async function saveEditDesigner() {
  const designerId = document.getElementById('editDesignerId').value;
  const name = document.getElementById('editDesignerName').value.trim();
  const email = document.getElementById('editDesignerEmail').value.trim();
  const category = document.getElementById('editDesignerCategory').value;

  if (!name) {
    showToast('„Çπ„Çø„ÉÉ„ÉïÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  // ÂêçÂâç„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
  if (name !== designer.name && designers.find(d => d.name === name && d.id !== designerId)) {
    showToast('Êó¢„Å´Â≠òÂú®„Åô„Çã„Çπ„Çø„ÉÉ„ÉïÂêç„Åß„Åô', 'error');
    return;
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  const oldName = designer.name;
  const updateData = {
    name,
    category,
    email: email || `${name.replace(/\s/g, '')}@temp.local`
  };

  const { error } = await supabase
    .from('designers')
    .update(updateData)
    .eq('id', designerId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  // ÂêçÂâç„ÅåÂ§â„Çè„Å£„ÅüÂ†¥Âêà„ÄÅÈñ¢ÈÄ£„Åô„ÇãÊ°à‰ª∂„ÅÆÊãÖÂΩìËÄÖÂêç„ÇÇÊõ¥Êñ∞
  if (oldName !== name) {
    const fieldsToUpdate = {
      'Ë®≠Ë®à': 'assigned_to',
      'IC': 'ic_assignee',
      'Â§ñÊßã': 'exterior_assignee'
    };
    const field = fieldsToUpdate[designer.category];
    if (field) {
      const relatedProjects = projects.filter(p => p[field] === oldName);
      for (const project of relatedProjects) {
        await supabase.from('projects').update({ [field]: name }).eq('id', project.id);
        project[field] = name;
      }
    }
  }

  // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
  Object.assign(designer, updateData);

  closeEditDesignerModal();
  renderDesignerListInline();
  renderDesignerTabs();
  renderSidebar();
  renderProjects();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
}

async function addDesignerInline() {
  const name = document.getElementById('newDesignerNameInline').value.trim();
  const category = document.getElementById('newDesignerCategoryInline').value;

  if (!name) {
    showToast('„Çπ„Çø„ÉÉ„ÉïÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (designers.find(d => d.name === name)) {
    showToast('Êó¢„Å´Â≠òÂú®„Åô„Çã„Çπ„Çø„ÉÉ„ÉïÂêç„Åß„Åô', 'error');
    return;
  }

  showStatus('ËøΩÂä†‰∏≠...', 'saving');

  // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™„ÅÆÊúÄÂ§ßdisplay_order„ÇíÂèñÂæó„Åó„Å¶+1
  const sameCategoryDesigners = designers.filter(d => d.category === category);
  const maxDisplayOrder = sameCategoryDesigners.length > 0
    ? Math.max(...sameCategoryDesigners.map(d => d.display_order || 0))
    : 0;
  const newDisplayOrder = maxDisplayOrder + 1;

  const { data, error } = await supabase
    .from('designers')
    .insert([{ name, category, email: `${name.replace(/\s/g, '')}@temp.local`, created_by: currentUser?.id, display_order: newDisplayOrder }])
    .select();

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  designers.push(data[0]);
  document.getElementById('newDesignerNameInline').value = '';
  renderDesignerListInline();
  renderSidebar();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„Çπ„Çø„ÉÉ„Éï„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
}

async function deleteDesignerInline(designerId) {
  const designer = designers.find(d => d.id === designerId);
  const hasProjects = projects.some(p => p.assigned_to === designer.name);

  if (hasProjects) {
    showToast('„Åì„ÅÆ„Çπ„Çø„ÉÉ„Éï„ÅØÊ°à‰ª∂„Å´Ââ≤ÂΩì„Å¶„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÊ°à‰ª∂„ÅÆÊãÖÂΩì„ÇíÂ§âÊõ¥„Åó„Å¶„Åã„ÇâÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
    return;
  }

  if (!confirm(`${designer.name}„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

  showStatus('ÂâäÈô§‰∏≠...', 'saving');
  const { error } = await supabase
    .from('designers')
    .delete()
    .eq('id', designerId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  designers = designers.filter(d => d.id !== designerId);
  renderDesignerListInline();
  renderSidebar();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„Çπ„Çø„ÉÉ„Éï„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

// ============================================
// „Çπ„Çø„ÉÉ„ÉïË™çË®ºË®≠ÂÆö
// ============================================
function openDesignerAuthModal(designerId) {
  const designer = designers.find(d => d.id === designerId);
  if (!designer) return;

  document.getElementById('authDesignerId').value = designer.id;
  document.getElementById('authDesignerName').value = designer.name;
  document.getElementById('authDesignerEmail').value = designer.email && !designer.email.includes('@temp.local') ? designer.email : '';
  document.getElementById('authDesignerPassword').value = '';
  document.getElementById('authDesignerPasswordConfirm').value = '';

  document.getElementById('designerAuthModal').classList.add('show');
}

function closeDesignerAuthModal() {
  document.getElementById('designerAuthModal').classList.remove('show');
}

async function saveDesignerAuth() {
  const designerId = document.getElementById('authDesignerId').value;
  const email = document.getElementById('authDesignerEmail').value.trim();
  const password = document.getElementById('authDesignerPassword').value;
  const passwordConfirm = document.getElementById('authDesignerPasswordConfirm').value;

  // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
  if (!email) {
    showToast('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (!password) {
    showToast('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (password.length < 8) {
    showToast('„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ8ÊñáÂ≠ó‰ª•‰∏ä„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (password !== passwordConfirm) {
    showToast('„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì', 'error');
    return;
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  try {
    const designer = designers.find(d => d.id === designerId);
    const oldEmail = designer.email;

    console.log('üîê „É¶„Éº„Ç∂„Éº„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàêÈñãÂßã:', { email, designerId });

    // 1. Supabase Auth„Å´„É¶„Éº„Ç∂„Éº„Çí‰ΩúÊàê
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email: email,
      password: password,
      options: {
        data: {
          name: designer.name,
          designer_id: designerId
        },
        emailRedirectTo: window.location.origin
      }
    });

    console.log('üîê signUpÁµêÊûú:', { authData, authError });

    if (authError) {
      // „É¶„Éº„Ç∂„Éº„ÅåÊó¢„Å´Â≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Éë„Çπ„ÉØ„Éº„Éâ„Å†„Åë„ÇíÊõ¥Êñ∞„Åß„Åç„Å™„ÅÑ„ÅÆ„ÅßË≠¶Âëä
      if (authError.message.includes('already registered')) {
        showToast('‚ö†Ô∏è „Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éë„Çπ„ÉØ„Éº„Éâ„ÅÆÂ§âÊõ¥„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ„ÄÅ„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆ„Äå„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„Åü„Äç„Åã„ÇâÂ§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      } else {
        throw authError;
      }
    } else {
      console.log('‚úÖ Supabase Auth„Å´„É¶„Éº„Ç∂„Éº‰ΩúÊàêÂÆå‰∫Ü:', authData.user?.id);
    }

    // 2. designers„ÉÜ„Éº„Éñ„É´„ÅÆemail„ÇíÊõ¥Êñ∞
    const { error: updateError } = await supabase
      .from('designers')
      .update({ email: email })
      .eq('id', designerId);

    if (updateError) {
      console.error('‚ùå designersÊõ¥Êñ∞„Ç®„É©„Éº:', updateError);
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + updateError.message, 'error');
      return;
    }

    console.log('‚úÖ designers„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞ÂÆå‰∫Ü');

    // 3. „Éá„Ç∂„Ç§„Éä„ÉºÈÖçÂàó„ÇíÊõ¥Êñ∞
    const designerIndex = designers.findIndex(d => d.id === designerId);
    if (designerIndex !== -1) {
      designers[designerIndex].email = email;
    }

    closeDesignerAuthModal();
    renderDesignerListInline();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');

    if (authError && authError.message.includes('already registered')) {
      showToast('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºà„Ç¢„Ç´„Ç¶„É≥„Éà„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„ÅôÔºâ', 'success');
    } else {
      showToast('‚úÖ „É≠„Ç∞„Ç§„É≥„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„Åß„É≠„Ç∞„Ç§„É≥„Åß„Åç„Åæ„Åô„ÄÇ', 'success', 5000);
    }

  } catch (error) {
    console.error('‚ùå Ë™çË®ºË®≠ÂÆö„Ç®„É©„Éº:', error);
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('Ë™çË®ºË®≠ÂÆö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
  }
}

// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÂá¶ÁêÜ
let draggedElement = null;

function setupDragAndDrop() {
  const draggableRows = document.querySelectorAll('.draggable-row');

  draggableRows.forEach(row => {
    row.addEventListener('dragstart', handleDragStart);
    row.addEventListener('dragover', handleDragOver);
    row.addEventListener('drop', handleDrop);
    row.addEventListener('dragend', handleDragEnd);
    row.addEventListener('dragleave', handleDragLeave);
  });
}

function handleDragStart(e) {
  draggedElement = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }

  // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™ÂÜÖ„Åß„ÅÆ„Åø„Éâ„É≠„ÉÉ„ÉóÂèØËÉΩ
  const draggedCategory = draggedElement.dataset.category;
  const targetCategory = this.dataset.category;

  if (draggedCategory === targetCategory && this !== draggedElement) {
    this.classList.add('drag-over');
  }

  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }

  const draggedCategory = draggedElement.dataset.category;
  const targetCategory = this.dataset.category;

  // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™ÂÜÖ„Åß„ÅÆ„Åø„Éâ„É≠„ÉÉ„ÉóÂÆüË°å
  if (draggedCategory === targetCategory && draggedElement !== this) {
    const draggedId = draggedElement.dataset.designerId;
    const targetId = this.dataset.designerId;

    // È†ÜÂ∫è„ÇíÂÖ•„ÇåÊõø„Åà
    updateDesignerOrder(draggedId, targetId, draggedCategory);
  }

  this.classList.remove('drag-over');
  return false;
}

function handleDragEnd(e) {
  this.classList.remove('dragging');

  const allRows = document.querySelectorAll('.draggable-row');
  allRows.forEach(row => {
    row.classList.remove('drag-over');
  });
}

function handleDragLeave(e) {
  this.classList.remove('drag-over');
}

async function updateDesignerOrder(draggedId, targetId, category) {
  showStatus('‰∏¶„Å≥Êõø„Åà‰∏≠...', 'saving');

  // Ë©≤ÂΩì„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Çπ„Çø„ÉÉ„Éï„ÇíÂèñÂæó
  const categoryDesigners = designers.filter(d => d.category === category);

  // „Éâ„É©„ÉÉ„Ç∞„Åï„Çå„Åü„Çπ„Çø„ÉÉ„Éï„Å®„Çø„Éº„Ç≤„ÉÉ„Éà„Çπ„Çø„ÉÉ„Éï„ÇíË¶ã„Å§„Åë„Çã
  const draggedIndex = categoryDesigners.findIndex(d => d.id === draggedId);
  const targetIndex = categoryDesigners.findIndex(d => d.id === targetId);

  // ÈÖçÂàó„Çí‰∏¶„Å≥Êõø„Åà
  const [draggedDesigner] = categoryDesigners.splice(draggedIndex, 1);
  categoryDesigners.splice(targetIndex, 0, draggedDesigner);

  // display_order„ÇíÂÜçË®àÁÆó
  const updates = [];
  for (let i = 0; i < categoryDesigners.length; i++) {
    const designer = categoryDesigners[i];
    const newOrder = i + 1;

    if (designer.display_order !== newOrder) {
      updates.push({
        id: designer.id,
        display_order: newOrder
      });

      // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
      const localDesigner = designers.find(d => d.id === designer.id);
      if (localDesigner) {
        localDesigner.display_order = newOrder;
      }
    }
  }

  // Supabase„Å´‰∏ÄÊã¨Êõ¥Êñ∞
  for (const update of updates) {
    const { error } = await supabase
      .from('designers')
      .update({ display_order: update.display_order })
      .eq('id', update.id);

    if (error) {
      console.error('‰∏¶„Å≥Êõø„Åà„Ç®„É©„Éº:', error);
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('‰∏¶„Å≥Êõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }
  }

  // UIÊõ¥Êñ∞
  renderDesignerListInline();
  renderSidebar();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('‰∏¶„Å≥Êõø„Åà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

// „Ç§„É≥„É©„Ç§„É≥Áâà„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†
async function addCategoryInline() {
  const name = document.getElementById('newCategoryNameInline').value.trim();

  if (!name) {
    showToast('„Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  if (vendorCategories.find(c => c.name === name)) {
    showToast('Êó¢„Å´Â≠òÂú®„Åô„Çã„Ç´„ÉÜ„Ç¥„É™Âêç„Åß„Åô', 'error');
    return;
  }

  showStatus('ËøΩÂä†‰∏≠...', 'saving');
  const { data, error } = await supabase
    .from('vendor_categories')
    .insert([{ name, display_order: vendorCategories.length + 1 }])
    .select();

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  vendorCategories.push(data[0]);
  document.getElementById('newCategoryNameInline').value = '';
  renderCategoriesList();
  renderCategoryFilters();
  populateVendorCategoryDropdown();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
}

// ============================================
// „É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ
// ============================================
function renderTemplates() {
  const container = document.getElementById('templatesTable');
  if (!container) return; // Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

  const categoryFilterEl = document.getElementById('categoryFilter');
  const categoryFilter = categoryFilterEl ? categoryFilterEl.value : null;

  let filtered = emailTemplates;

  // currentUserCategory„Å´Âøú„Åò„Å¶„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÁÆ°ÁêÜËÄÖ‰ª•Â§ñÔºâ
  if (currentUserCategory && currentUserCategory !== 'admin') {
    filtered = emailTemplates.filter(t => t.category === currentUserCategory);
  }

  // „Åï„Çâ„Å´„Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
  if (categoryFilter) {
    filtered = filtered.filter(t => t.category === categoryFilter);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìß</div><div class="empty-title">„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div><div class="empty-description">„É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíËøΩÂä†„Åó„Å¶„ÄÅÊ°à‰ª∂„Åã„Çâ„ÉØ„É≥„ÇØ„É™„ÉÉ„ÇØ„Åß„É°„Éº„É´„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô</div><button class="btn btn-primary" onclick="openTemplateModal()">+ „ÉÜ„É≥„Éó„É¨„Éº„ÉàËøΩÂä†</button></div>';
    return;
  }

  container.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>Ë°®Á§∫Âêç</th>
          <th>„Ç´„ÉÜ„Ç¥„É™</th>
          <th>‰ºöÁ§æÂêç</th>
          <th>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th>
          <th>Êìç‰Ωú</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(template => `
          <tr>
            <td><strong>${template.display_name}</strong></td>
            <td><span class="badge ${template.category === 'IC' ? 'badge-success' : 'badge-primary'}">${template.category}</span></td>
            <td>${template.company}</td>
            <td>${template.email || '‚Äî'}</td>
            <td>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-ghost btn-small" onclick="editTemplate('${template.id}')">Á∑®ÈõÜ</button>
                <button class="btn btn-danger btn-small" onclick="deleteTemplate('${template.id}')">ÂâäÈô§</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function openTemplateModal(templateId = null) {
  editingTemplateId = templateId;
  const modal = document.getElementById('templateModal');
  const title = document.getElementById('templateModalTitle');

  if (templateId) {
    const template = emailTemplates.find(t => t.id === templateId);
    title.textContent = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ';
    document.getElementById('templateId').value = template.template_id;
    document.getElementById('templateId').disabled = true;
    document.getElementById('templateDisplayName').value = template.display_name;
    document.getElementById('templateCategory').value = template.category;
    document.getElementById('templateCompany').value = template.company;
    document.getElementById('templateContact').value = template.contact || '';
    document.getElementById('templateEmail').value = template.email || '';
    document.getElementById('templateSubjectFormat').value = template.subject_format || '';
    document.getElementById('templateText').value = template.template_text || '';
  } else {
    title.textContent = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàËøΩÂä†';
    document.getElementById('templateId').value = '';
    document.getElementById('templateId').disabled = false;
    document.getElementById('templateDisplayName').value = '';
    document.getElementById('templateCategory').value = 'Ë®≠Ë®à';
    document.getElementById('templateCompany').value = '';
    document.getElementById('templateContact').value = '';
    document.getElementById('templateEmail').value = '';
    document.getElementById('templateSubjectFormat').value = '';
    document.getElementById('templateText').value = '';
  }

  modal.classList.add('show');
}

function closeTemplateModal() {
  document.getElementById('templateModal').classList.remove('show');
  editingTemplateId = null;
}

async function saveTemplate() {
  const templateId = document.getElementById('templateId').value.trim();
  const displayName = document.getElementById('templateDisplayName').value.trim();
  const category = document.getElementById('templateCategory').value;
  const company = document.getElementById('templateCompany').value.trim();
  const contact = document.getElementById('templateContact').value.trim();
  const email = document.getElementById('templateEmail').value.trim();
  const subjectFormat = document.getElementById('templateSubjectFormat').value.trim();
  const templateText = document.getElementById('templateText').value.trim();

  if (!templateId || !displayName || !company || !subjectFormat || !templateText) {
    showToast('ÂøÖÈ†àÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  const templateData = {
    template_id: templateId,
    display_name: displayName,
    category,
    company,
    contact,
    email,
    subject_format: subjectFormat,
    template_text: templateText,
    has_special_content: false,
    has_sub_options: false,
    created_by: currentUser.id
  };

  if (editingTemplateId) {
    const { error } = await supabase
      .from('email_templates')
      .update(templateData)
      .eq('id', editingTemplateId);

    if (error) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    const template = emailTemplates.find(t => t.id === editingTemplateId);
    Object.assign(template, templateData);
  } else {
    const { data, error } = await supabase
      .from('email_templates')
      .insert([templateData])
      .select();

    if (error) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    emailTemplates.push(data[0]);
  }

  closeTemplateModal();
  renderTemplates();
  renderMappings();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

function editTemplate(templateId) {
  openTemplateModal(templateId);
}

async function deleteTemplate(templateId) {
  if (!confirm('„Åì„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  showStatus('ÂâäÈô§‰∏≠...', 'saving');
  const { error } = await supabase
    .from('email_templates')
    .delete()
    .eq('id', templateId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  emailTemplates = emailTemplates.filter(t => t.id !== templateId);
  renderTemplates();
  renderMappings();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

// ============================================
// Ê•≠ËÄÖÁÆ°ÁêÜ
// ============================================
function renderVendors() {
  const container = document.getElementById('vendorsTable');
  if (!container) return; // Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

  const filterSelect = document.getElementById('vendorTemplateFilter');
  if (!filterSelect) return; // Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

  const templateFilter = filterSelect.value;

  // „Éï„Ç£„É´„Çø„Éº„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞Ôºà„Åô„Åπ„Å¶„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË°®Á§∫Ôºâ
  filterSelect.innerHTML = '<option value="">„Åô„Åπ„Å¶„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà</option>' +
    emailTemplates.map(t =>
      `<option value="${t.template_id}">${t.display_name}</option>`
    ).join('');
  if (templateFilter) filterSelect.value = templateFilter;

  let filtered = vendors;
  if (templateFilter) {
    filtered = vendors.filter(v => v.template_id === templateFilter);
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-title">Ê•≠ËÄÖÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div><div class="empty-description">Ê•≠ËÄÖÊÉÖÂ†±„ÇíÁôªÈå≤„Åô„Çã„Å®„ÄÅ„É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åß‰ΩøÁî®„Åß„Åç„Åæ„Åô</div><button class="btn btn-primary" onclick="openVendorModal()">+ Ê•≠ËÄÖËøΩÂä†</button></div>';
    return;
  }

  container.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>‰ºöÁ§æÂêç</th>
          <th>ÊãÖÂΩìËÄÖ</th>
          <th>ÈõªË©±Áï™Âè∑</th>
          <th>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</th>
          <th>„ÉÜ„É≥„Éó„É¨„Éº„Éà</th>
          <th>Êìç‰Ωú</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(vendor => {
          const template = emailTemplates.find(t => t.template_id === vendor.template_id);
          return `
            <tr>
              <td><strong>${vendor.company}</strong></td>
              <td>${vendor.contact}</td>
              <td>${vendor.tel || '‚Äî'}</td>
              <td>${vendor.email}</td>
              <td>${template ? template.display_name : '‚Äî'}</td>
              <td>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-ghost btn-small" onclick="editVendor('${vendor.id}')">Á∑®ÈõÜ</button>
                  <button class="btn btn-danger btn-small" onclick="deleteVendor('${vendor.id}')">ÂâäÈô§</button>
                </div>
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
}

function openVendorModal(vendorId = null) {
  editingVendorId = vendorId;
  const modal = document.getElementById('vendorModal');
  const title = document.getElementById('vendorModalTitle');

  // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Çª„É¨„ÇØ„Éà„ÇíÊõ¥Êñ∞
  const templateSelect = document.getElementById('vendorTemplateId');
  templateSelect.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' +
    emailTemplates.map(t => `<option value="${t.template_id}">${t.display_name}</option>`).join('');

  if (vendorId) {
    const vendor = vendors.find(v => v.id === vendorId);
    title.textContent = 'Ê•≠ËÄÖÁ∑®ÈõÜ';
    document.getElementById('vendorTemplateId').value = vendor.template_id;
    document.getElementById('vendorId').value = vendor.vendor_id;
    document.getElementById('vendorId').disabled = true;
    document.getElementById('vendorCompany').value = vendor.company;
    document.getElementById('vendorContact').value = vendor.contact;
    document.getElementById('vendorTel').value = vendor.tel || '';
    document.getElementById('vendorEmail').value = vendor.email;
  } else {
    title.textContent = 'Ê•≠ËÄÖËøΩÂä†';
    document.getElementById('vendorTemplateId').value = '';
    document.getElementById('vendorId').value = '';
    document.getElementById('vendorId').disabled = false;
    document.getElementById('vendorCompany').value = '';
    document.getElementById('vendorContact').value = '';
    document.getElementById('vendorTel').value = '';
    document.getElementById('vendorEmail').value = '';
  }

  modal.classList.add('show');
}

function closeVendorModal() {
  document.getElementById('vendorModal').classList.remove('show');
  editingVendorId = null;
}

async function saveVendor() {
  const templateId = document.getElementById('vendorTemplateId').value;
  const vendorId = document.getElementById('vendorId').value.trim();
  const company = document.getElementById('vendorCompany').value.trim();
  const contact = document.getElementById('vendorContact').value.trim();
  const tel = document.getElementById('vendorTel').value.trim();
  const email = document.getElementById('vendorEmail').value.trim();

  if (!templateId || !vendorId || !company || !contact || !email) {
    showToast('ÂøÖÈ†àÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  const vendorData = {
    template_id: templateId,
    vendor_id: vendorId,
    company,
    contact,
    tel,
    email,
    created_by: currentUser.id
  };

  if (editingVendorId) {
    const { error } = await supabase
      .from('template_vendors')
      .update(vendorData)
      .eq('id', editingVendorId);

    if (error) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    const vendor = vendors.find(v => v.id === editingVendorId);
    Object.assign(vendor, vendorData);
  } else {
    const { data, error } = await supabase
      .from('template_vendors')
      .insert([vendorData])
      .select();

    if (error) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
      return;
    }

    vendors.push(data[0]);
  }

  closeVendorModal();
  renderVendors();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('Ê•≠ËÄÖÊÉÖÂ†±„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

function editVendor(vendorId) {
  openVendorModal(vendorId);
}

async function deleteVendor(vendorId) {
  if (!confirm('„Åì„ÅÆÊ•≠ËÄÖÊÉÖÂ†±„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  showStatus('ÂâäÈô§‰∏≠...', 'saving');
  const { error } = await supabase
    .from('template_vendors')
    .delete()
    .eq('id', vendorId);

  if (error) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
    return;
  }

  vendors = vendors.filter(v => v.id !== vendorId);
  renderVendors();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('Ê•≠ËÄÖÊÉÖÂ†±„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

// ============================================
// „Çø„Çπ„ÇØ-„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ¥ê„Å•„Åë
// ============================================
function renderMappings() {
  const container = document.getElementById('mappingsGrid');
  if (!container) return; // Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

  // Êóß„Ç∑„Çπ„ÉÜ„É†„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅÁ©∫„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
  container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚öôÔ∏è</div><div class="empty-title">„Çø„Çπ„ÇØ-„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ¥ê„Å•„Åë„ÅØÊóß„Ç∑„Çπ„ÉÜ„É†„Åß„Åô</div><div class="empty-description">Êñ∞„Ç∑„Çπ„ÉÜ„É†„Åß„ÅØ„Äå‚úÖ „Çø„Çπ„ÇØÁÆ°ÁêÜ„Äç„Åã„ÇâÊ•≠ËÄÖ„ÇíÁ¥ê„Å•„Åë„Å¶„Åè„Å†„Åï„ÅÑ</div></div>';
  return;

  container.innerHTML = Object.keys({}).map(taskKey => {
    const templateOptions = emailTemplates.map(t =>
      `<option value="${t.template_id}" ${taskMappings[taskKey] === t.template_id ? 'selected' : ''}>
        ${t.display_name} (${t.category})
      </option>`
    ).join('');

    return `
      <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md);">
        <label style="flex: 0 0 200px; font-weight: 600;">${TASK_NAMES[taskKey]}</label>
        <select class="form-select" id="mapping_${taskKey}" style="flex: 1;">
          <option value="">„É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å™„Åó</option>
          ${templateOptions}
        </select>
      </div>
    `;
  }).join('');
}

async function saveMappings() {
  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  const newMappings = {};
  Object.keys(TASK_NAMES).forEach(taskKey => {
    const select = document.getElementById('mapping_' + taskKey);
    if (select && select.value) {
      newMappings[taskKey] = select.value;
    }
  });

  // Êó¢Â≠ò„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÂâäÈô§
  const { error: deleteError } = await supabase
    .from('task_template_mappings')
    .delete()
    .neq('id', '00000000-0000-0000-0000-000000000000');

  if (deleteError) {
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + deleteError.message, 'error');
    return;
  }

  // Êñ∞„Åó„ÅÑ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÊåøÂÖ•
  const mappingsToInsert = Object.keys(newMappings).map(taskKey => ({
    task_key: taskKey,
    template_id: newMappings[taskKey]
  }));

  if (mappingsToInsert.length > 0) {
    const { error: insertError } = await supabase
      .from('task_template_mappings')
      .insert(mappingsToInsert);

    if (insertError) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + insertError.message, 'error');
      return;
    }
  }

  taskMappings = newMappings;
  renderProjects();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('„Çø„Çπ„ÇØË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

// ============================================
function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const templateId = taskMappings[taskKey];
  if (!templateId) {
    showToast('„Åì„ÅÆ„Çø„Çπ„ÇØ„Å´„É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\n„Äå„Çø„Çπ„ÇØË®≠ÂÆö„Äç„Çø„Éñ„Åã„ÇâË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
    return;
  }

  const template = emailTemplates.find(t => t.template_id === templateId);
  if (!template) {
    showToast('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  const taskDate = project.progress?.[taskKey]?.date;
  const dueDate = taskDate || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  // „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÊ•≠ËÄÖ„É™„Çπ„Éà„ÇíÂèñÂæó
  const templateVendors = vendors.filter(v => v.template_id === templateId);
  const hasVendorOptions = template.has_sub_options && templateVendors.length > 0;

  // Ê•≠ËÄÖÈÅ∏Êäû„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥
  let vendorSelectHtml = '';
  if (hasVendorOptions) {
    vendorSelectHtml = `
      <div class="form-group">
        <label class="form-label">Ê•≠ËÄÖÈÅ∏Êäû</label>
        <select class="form-select" id="emailVendorSelect" onchange="updateVendorInfo('${templateId}')">
          <option value="">Ê•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
          ${templateVendors.map(v => `<option value="${v.id}">${v.company} - ${v.contact}</option>`).join('')}
        </select>
      </div>
    `;
  }

  content.innerHTML = `
    <div class="form-group">
      <label class="form-label">ÊãÖÂΩìËÄÖÂêçÔºàÁΩ≤ÂêçÁî®Ôºâ</label>
      <input type="text" class="form-input" id="emailStaffName" value="${project.assigned_to}">
    </div>
    <div class="form-group">
      <label class="form-label">ÊúüÊó•</label>
      <input type="date" class="form-input" id="emailDueDate" value="${dueDate}">
    </div>
    ${vendorSelectHtml}
    <div class="form-group">
      <label class="form-label">ÂÜÖÂÆπË©≥Á¥∞Ôºà‰ªªÊÑèÔºâ</label>
      <textarea class="form-textarea" id="emailSpecialContent" placeholder="ÂøÖË¶Å„Å´Âøú„Åò„Å¶Ë©≥Á¥∞„ÇíÂÖ•Âäõ"></textarea>
    </div>
    <button class="btn btn-primary" onclick="generateEmail('${project.id}', '${taskKey}')">„É°„Éº„É´„ÇíÁîüÊàê</button>
    <div id="generatedEmailSection" style="display: none; margin-top: 32px;">
      <h3 style="margin-bottom: 12px; font-size: 18px; font-weight: 600;">üìß ‰ª∂Âêç</h3>
      <div id="emailSubject" class="email-output"></div>
      <button class="btn btn-secondary btn-small" onclick="copyText('emailSubject')">‰ª∂Âêç„Çí„Ç≥„Éî„Éº</button>

      <h3 style="margin: 24px 0 12px; font-size: 18px; font-weight: 600;">üìÆ ÂÆõÂÖà</h3>
      <div id="emailAddress" class="email-output"></div>
      <button class="btn btn-secondary btn-small" onclick="copyText('emailAddress')">ÂÆõÂÖà„Çí„Ç≥„Éî„Éº</button>

      <h3 style="margin: 24px 0 12px; font-size: 18px; font-weight: 600;">üì® Êú¨Êñá</h3>
      <div id="emailBody" class="email-output"></div>
      <button class="btn btn-secondary btn-small" onclick="copyText('emailBody')">Êú¨Êñá„Çí„Ç≥„Éî„Éº</button>
    </div>
  `;

  modal.classList.add('show');
}

// Ê•≠ËÄÖÈÅ∏ÊäûÊôÇ„Å´ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
function updateVendorInfo(templateId) {
  const select = document.getElementById('emailVendorSelect');
  if (!select) return;

  // ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
  if (!select.value) return;

  // ÈÅ∏Êäû„Åï„Çå„ÅüÊ•≠ËÄÖ„ÇíÂèñÂæó
  const selectedVendor = vendors.find(v => v.id === select.value);
  if (selectedVendor) {
    // ÁâπÂà•„Å™„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅØ‰∏çË¶ÅÔºàgenerateEmailÊôÇ„Å´‰ΩøÁî®Ôºâ
    console.log('Ê•≠ËÄÖÈÅ∏Êäû:', selectedVendor.company);
  }
}

function generateEmail(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  const templateId = taskMappings[taskKey];
  const template = emailTemplates.find(t => t.template_id === templateId);

  const staffName = document.getElementById('emailStaffName').value.trim();
  const dueDate = document.getElementById('emailDueDate').value;
  const specialContent = document.getElementById('emailSpecialContent').value.trim();

  // Ê•≠ËÄÖÈÅ∏Êäû„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊ•≠ËÄÖÊÉÖÂ†±„Çí‰ΩøÁî®
  let company = template.company;
  let contact = template.contact || '„ÅîÊãÖÂΩìËÄÖÊßò';
  let email = template.email;

  const vendorSelect = document.getElementById('emailVendorSelect');
  if (vendorSelect && vendorSelect.value) {
    const selectedVendor = vendors.find(v => v.id === vendorSelect.value);
    if (selectedVendor) {
      company = selectedVendor.company;
      contact = selectedVendor.contact;
      email = selectedVendor.email;
    }
  }

  const replacements = {
    '{customerName}': project.customer,
    '{dueDate}': dueDate,
    '{staffName}': staffName,
    '{company}': company,
    '{contact}': contact,
    '{specialContent}': specialContent || template.default_special_content || ''
  };

  let subject = template.subject_format;
  let body = template.template_text;

  Object.keys(replacements).forEach(key => {
    const regex = new RegExp(key.replace(/[{}]/g, '\\$&'), 'g');
    subject = subject.replace(regex, replacements[key]);
    body = body.replace(regex, replacements[key]);
  });

  document.getElementById('emailSubject').textContent = subject;
  document.getElementById('emailAddress').textContent = email || '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
  document.getElementById('emailBody').textContent = body;
  document.getElementById('generatedEmailSection').style.display = 'block';
}

function copyText(elementId) {
  const element = document.getElementById(elementId);
  const text = element.textContent;

  navigator.clipboard.writeText(text).then(() => {
    showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
  }).catch(err => {
    console.error('„Ç≥„Éî„Éº„Å´Â§±Êïó:', err);
    showToast('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  });
}

// ============================================
// „Çø„Çπ„ÇØ„Åã„Çâ„ÅÆ„É°„Éº„É´‰ΩúÊàêÊ©üËÉΩÔºà„É¢„Éº„ÉÄ„É´Á¢∫Ë™çÂæå„Å´GmailÈñã„ÅèÔºâ
// ============================================
async function openEmailFromTask(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) {
    showToast('Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  // „Çø„Çπ„ÇØÂÆöÁæ©„ÇíÂèñÂæó
  const taskDef = tasksV2.find(t => t.task_key === taskKey);
  if (!taskDef) {
    showToast('„Çø„Çπ„ÇØÂÆöÁæ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  // „Çø„Çπ„ÇØ„Å´Á¥ê„Å•„ÅÑ„ÅüÊ•≠ËÄÖ„ÇíÂèñÂæó
  const mappings = taskVendorMappings.filter(m => m.task_id === taskDef.id);
  if (mappings.length === 0) {
    showToast('„Åì„ÅÆ„Çø„Çπ„ÇØ„Å´Ê•≠ËÄÖ„ÅåÁ¥ê„Å•„Åë„Çâ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return;
  }

  // Ê•≠ËÄÖÊÉÖÂ†±„ÇíÂèñÂæó
  const taskVendors = mappings
    .map(m => vendorsV2.find(v => v.id === m.vendor_id))
    .filter(v => v != null);

  if (taskVendors.length === 0) {
    showToast('Ê•≠ËÄÖÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  // ÊãÖÂΩìËÄÖÊÉÖÂ†±„ÇíÂèñÂæó
  const designer = designers.find(d => d.id === project.designer_id);
  const staffName = designer ? designer.name : '';

  // ÁèæÂú®Êó•‰ªò„Åã„ÇâÊúüÊó•„ÇíË®≠ÂÆöÔºà„Éá„Éï„Ç©„É´„ÉàÔºö7Êó•ÂæåÔºâ
  const today = new Date();
  const dueDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
  const dueDateStr = dueDate.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' }).replace('/', 'Êúà') + 'Êó•';

  // ÊúÄÂàù„ÅÆÊ•≠ËÄÖ„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩøÁî®
  const vendor = taskVendors[0];

  // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁΩÆÊèõ
  const replacePlaceholders = (text) => {
    if (!text) return '';
    return text
      .replace(/\{customerName\}/g, project.customer)
      .replace(/\{dueDate\}/g, dueDateStr)
      .replace(/\{staffName\}/g, staffName)
      .replace(/\{company\}/g, vendor.company)
      .replace(/\{contact\}/g, vendor.contact || '„ÅîÊãÖÂΩìËÄÖÊßò');
  };

  // ÂàùÊúü„ÅÆ‰ª∂Âêç„Å®Êú¨Êñá„ÇíÁîüÊàê
  const initialSubject = replacePlaceholders(vendor.subject_format || `${project.customer}ÊßòÈÇ∏ ${taskDef.task_name}`);
  const initialBody = replacePlaceholders(vendor.template_text || '');

  // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
  showEmailModal(project, taskDef, taskVendors, initialSubject, initialBody);
}

function showEmailModal(project, taskDef, vendors, initialSubject, initialBody) {
  const modal = document.getElementById('emailModal');
  const content = document.getElementById('emailComposerContent');

  // Ê•≠ËÄÖÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆHTMLÔºàXSSÂØæÁ≠ñ: escapeHtmlÈÅ©Áî®Ôºâ
  const vendorCheckboxes = vendors.map((v, idx) => `
    <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md); cursor: pointer;">
      <input type="checkbox"
        id="vendor_${escapeHtml(v.id)}"
        value="${escapeHtml(v.id)}"
        ${idx === 0 ? 'checked' : ''}
        onchange="updateEmailPreview()"
        style="width: 18px; height: 18px; cursor: pointer;">
      <div style="flex: 1;">
        <div style="font-weight: 600; margin-bottom: 2px;">${escapeHtml(v.company)}</div>
        <div style="font-size: 13px; color: var(--text-secondary);">${escapeHtml(v.contact || '')} - ${escapeHtml(v.email || '')}</div>
      </div>
    </label>
  `).join('');

  content.innerHTML = `
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <div>
        <h3 style="margin: 0 0 8px 0; font-size: 18px;">üìß ${escapeHtml(taskDef.task_name)} - „É°„Éº„É´‰ΩúÊàê</h3>
        <div style="font-size: 14px; color: var(--text-secondary);">Ê°à‰ª∂: ${escapeHtml(project.customer)}</div>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">ÂÆõÂÖàÊ•≠ËÄÖ„ÇíÈÅ∏Êäû</label>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${vendorCheckboxes}
        </div>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">‰ª∂Âêç</label>
        <input type="text" id="emailSubject" class="form-input" value="${escapeHtml(initialSubject)}">
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Êú¨Êñá</label>
        <textarea id="emailBody" class="form-textarea" rows="15" style="font-family: inherit; line-height: 1.8;">${escapeHtml(initialBody)}</textarea>
      </div>

      <div style="display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="closeEmailModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn btn-secondary" onclick="copyEmailToClipboard()">üìã „Ç≥„Éî„Éº</button>
        <button class="btn btn-secondary" onclick="openOutlookFromModal()">üì® Outlook</button>
        <button class="btn btn-primary" onclick="openGmailFromModal()">üìß Gmail</button>
      </div>
    </div>
  `;

  // „Ç∞„É≠„Éº„Éê„É´„Å´‰øùÂ≠òÔºàopenGmailFromModal„Åß‰ΩøÁî®Ôºâ
  window.__emailModalData = { project, taskDef, vendors };

  modal.classList.add('show');
}

function updateEmailPreview() {
  // ÂøÖË¶Å„Å´Âøú„Åò„Å¶‰ª∂Âêç„ÉªÊú¨Êñá„ÅÆ„Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞Âá¶ÁêÜ„ÇíËøΩÂä†
}

// „É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÂèñÂæóÂÖ±ÈÄöÈñ¢Êï∞
function getSelectedEmailAddresses() {
  const { vendors } = window.__emailModalData || {};
  if (!vendors) return { addresses: '', vendors: [] };

  const selectedVendorIds = vendors
    .filter(v => document.getElementById(`vendor_${v.id}`)?.checked)
    .map(v => v.id);

  if (selectedVendorIds.length === 0) {
    showToast('Ê•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return { addresses: '', vendors: [] };
  }

  const selectedVendors = vendors.filter(v => selectedVendorIds.includes(v.id));
  const emailAddresses = selectedVendors.map(v => v.email).filter(e => e).join(',');

  if (!emailAddresses) {
    showToast('ÈÅ∏Êäû„Åï„Çå„ÅüÊ•≠ËÄÖ„Å´„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return { addresses: '', vendors: [] };
  }

  return { addresses: emailAddresses, vendors: selectedVendors };
}

function openGmailFromModal() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  const { addresses } = getSelectedEmailAddresses();

  if (!addresses) return;

  // Gmail URL„ÇíÁîüÊàê
  const gmailUrl = `https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(addresses)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  // Gmail„ÇíÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè
  window.open(gmailUrl, '_blank');

  // ÈÄÅ‰ø°Â±•Ê≠¥„ÇíË®òÈå≤
  logEmailSent('gmail', addresses, subject);

  // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
  closeEmailModal();

  // „Éà„Éº„Çπ„Éà„ÅßÈÄöÁü•
  showToast('Gmail„ÇíÈñã„Åç„Åæ„Åó„Åü', 'success');
}

function openOutlookFromModal() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  const { addresses } = getSelectedEmailAddresses();

  if (!addresses) return;

  // Outlook Web URL„ÇíÁîüÊàê
  const outlookUrl = `https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(addresses)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  // Outlook„ÇíÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè
  window.open(outlookUrl, '_blank');

  // ÈÄÅ‰ø°Â±•Ê≠¥„ÇíË®òÈå≤
  logEmailSent('outlook', addresses, subject);

  // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
  closeEmailModal();

  showToast('Outlook„ÇíÈñã„Åç„Åæ„Åó„Åü', 'success');
}

function copyEmailToClipboard() {
  const subject = document.getElementById('emailSubject').value;
  const body = document.getElementById('emailBody').value;
  const { addresses } = getSelectedEmailAddresses();

  if (!addresses) return;

  const emailText = `ÂÆõÂÖà: ${addresses}\n‰ª∂Âêç: ${subject}\n\n${body}`;

  navigator.clipboard.writeText(emailText).then(() => {
    showToast('„É°„Éº„É´ÂÜÖÂÆπ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
  }).catch(() => {
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
    const textarea = document.createElement('textarea');
    textarea.value = emailText;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast('„É°„Éº„É´ÂÜÖÂÆπ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
  });
}

// „É°„Éº„É´ÈÄÅ‰ø°Â±•Ê≠¥„ÇíË®òÈå≤
async function logEmailSent(method, to, subject) {
  const { project, taskDef } = window.__emailModalData || {};
  if (!project || !taskDef) return;

  console.log(`üìß „É°„Éº„É´ÈÄÅ‰ø°Ë®òÈå≤: ${method} -> ${to}, ‰ª∂Âêç: ${subject}`);

  // Â∞ÜÊù•: Supabase„Å´ÈÄÅ‰ø°Â±•Ê≠¥„Çí‰øùÂ≠ò
  // try {
  //   await supabase.from('email_logs').insert({
  //     project_id: project.id,
  //     task_key: taskDef.task_key,
  //     method,
  //     recipients: to,
  //     subject,
  //     sent_at: new Date().toISOString()
  //   });
  // } catch (e) {
  //   console.error('„É°„Éº„É´Â±•Ê≠¥‰øùÂ≠òÂ§±Êïó:', e);
  // }
}

// „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫
function showTemplateSelector(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  const currentTaskNames = getTaskNames();
  const taskName = currentTaskNames[taskKey];

  // ÁèæÂú®„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´Âøú„Åò„Åü„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí„Éï„Ç£„É´„Çø
  const availableTemplates = emailTemplates.filter(t => t.category === currentUserCategory);

  let html = `
    <div class="form-section">
      <h3 style="margin-bottom: 8px; color: var(--text-primary);">„É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû</h3>
      <p style="margin-bottom: 24px; color: var(--text-secondary); font-size: 14px;">
        Ê°à‰ª∂Ôºö${project.customer} Ôºè „Çø„Çπ„ÇØÔºö${taskName}
      </p>

      <div style="display: grid; gap: 12px;">
        ${availableTemplates.map(template => `
          <button class="template-select-btn" onclick="selectTemplateForTask('${projectId}', '${taskKey}', '${template.template_id}')">
            <div style="font-weight: 600; margin-bottom: 4px;">${template.display_name}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">${template.company}</div>
          </button>
        `).join('')}
      </div>

      ${availableTemplates.length === 0 ? '<p style="text-align: center; padding: 32px; color: var(--text-muted);">Âà©Áî®ÂèØËÉΩ„Å™„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>' : ''}
    </div>
  `;

  document.getElementById('emailComposerContent').innerHTML = html;
  document.getElementById('emailModal').classList.add('show');
}

// „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÂæå„Å´„É°„Éº„É´‰ΩúÊàêÁîªÈù¢„ÇíË°®Á§∫
function selectTemplateForTask(projectId, taskKey, templateId) {
  const project = projects.find(p => p.id === projectId);
  const template = emailTemplates.find(t => t.template_id === templateId);
  const designer = designers.find(d => d.id === project.designer_id);
  const staffName = designer ? designer.name : '';

  const composerHTML = createEmailComposer(project, template, staffName, taskKey);
  document.getElementById('emailComposerContent').innerHTML = composerHTML;
}

function createEmailComposer(project, template, staffName, taskKey) {
  const hasSubOptions = template.has_sub_options;
  const hasSpecialContent = template.has_special_content;

  let html = `
    <div class="form-section">
      <h3 style="margin-bottom: 16px; color: var(--text-primary);">${template.display_name}</h3>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div class="form-group">
          <label class="form-label">„ÅäÂÆ¢ÊßòÂêç:</label>
          <input type="text" class="form-input" id="modalCustomerName" value="${project.customer}" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label class="form-label">ÊãÖÂΩìËÄÖÂêç:</label>
          <input type="text" class="form-input" id="modalStaffName" value="${staffName}" oninput="updateModalEmail()">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ÊúüÊó•:</label>
        <input type="date" class="form-input" id="modalDueDate" oninput="updateModalEmail()">
      </div>
  `;

  if (hasSpecialContent) {
    const defaultContent = template.default_special_content || '';
    html += `
      <div class="form-group">
        <label class="form-label">ÁâπË®ò‰∫ãÈ†Ö:</label>
        <textarea class="form-textarea" id="modalSpecialContent" rows="4" oninput="updateModalEmail()">${defaultContent}</textarea>
      </div>
    `;
  }

  if (hasSubOptions) {
    const templateVendors = vendors.filter(v => v.template_id === template.template_id);
    html += `
      <div class="form-group">
        <label class="form-label">Ê•≠ËÄÖÈÅ∏Êäû:</label>
        <select class="form-select" id="modalVendorSelect" onchange="updateModalEmail()">
          <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
          ${templateVendors.map(v => `<option value="${v.vendor_id}">${v.company}</option>`).join('')}
        </select>
      </div>
    `;
  }

  html += `
    </div>

    <div style="margin-top: 24px;">
      <h3 style="margin-bottom: 12px; color: var(--text-primary);">üì¨ ÁîüÊàê„Åï„Çå„Åü„É°„Éº„É´</h3>

      <div class="form-group">
        <label class="form-label">‰ª∂Âêç:</label>
        <div id="modalEmailSubject" style="padding: 12px; background: #f8f9fa; border-radius: 8px; font-weight: 500;"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailSubject')" style="margin-top: 8px;">üìã ‰ª∂Âêç„Çí„Ç≥„Éî„Éº</button>
      </div>

      <div class="form-group">
        <label class="form-label">ÈÄÅ‰ø°ÂÖà:</label>
        <div id="modalEmailAddress" style="padding: 12px; background: #f8f9fa; border-radius: 8px; color: var(--primary-color);"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailAddress')" style="margin-top: 8px;">üìã „Ç¢„Éâ„É¨„Çπ„Çí„Ç≥„Éî„Éº</button>
      </div>

      <div class="form-group">
        <label class="form-label">Êú¨Êñá:</label>
        <div id="modalEmailBody" style="padding: 16px; background: #f8f9fa; border-radius: 8px; white-space: pre-wrap; line-height: 1.8; min-height: 200px;"></div>
        <button class="btn btn-ghost btn-small" onclick="copyModalText('modalEmailBody')" style="margin-top: 8px;">üìã Êú¨Êñá„Çí„Ç≥„Éî„Éº</button>
      </div>
    </div>

    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
      <button class="btn btn-secondary" onclick="closeEmailModal()">Èñâ„Åò„Çã</button>
      <button class="btn btn-primary" onclick="markTaskAsRequested('${project.id}', '${taskKey}')">‰æùÈ†ºÊ∏à„Åø„Å´„Åô„Çã</button>
    </div>
  `;

  // „Éá„Éº„Çø„Çí‰øùÂ≠òÔºàupdateModalEmail„Åß‰ΩøÁî®Ôºâ
  window.__currentEmailData = {
    project,
    template,
    staffName,
    taskKey
  };

  // ÂàùÂõû„É°„Éº„É´ÁîüÊàê
  setTimeout(() => updateModalEmail(), 100);

  return html;
}

function updateModalEmail() {
  if (!window.__currentEmailData) return;

  const { project, template } = window.__currentEmailData;

  const customerName = document.getElementById('modalCustomerName')?.value || project.customer;
  const staffName = document.getElementById('modalStaffName')?.value || '';
  const dueDate = document.getElementById('modalDueDate')?.value || '';
  const specialContent = document.getElementById('modalSpecialContent')?.value || template.default_special_content || '';
  const vendorSelect = document.getElementById('modalVendorSelect');
  const selectedVendorId = vendorSelect?.value || '';

  let subject = template.subject_format || '';
  let body = template.template_text || '';
  let email = template.email || '';
  let company = template.company || '';
  let contact = template.contact || '';

  // „Çµ„Éñ„Ç™„Éó„Ç∑„Éß„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊ•≠ËÄÖÊÉÖÂ†±„Çí‰ΩøÁî®
  if (template.has_sub_options && selectedVendorId) {
    const vendor = vendors.find(v => v.template_id === template.template_id && v.vendor_id === selectedVendorId);
    if (vendor) {
      company = vendor.company;
      contact = vendor.contact || '„ÅîÊãÖÂΩìËÄÖÊßò';
      email = vendor.email || '';
    }
  }

  // Â§âÊï∞„ÇíÁΩÆÊèõ
  subject = subject
    .replace(/\{customerName\}/g, customerName)
    .replace(/\{dueDate\}/g, dueDate);

  body = body
    .replace(/\{company\}/g, company)
    .replace(/\{contact\}/g, contact)
    .replace(/\{customerName\}/g, customerName)
    .replace(/\{staffName\}/g, staffName)
    .replace(/\{dueDate\}/g, dueDate)
    .replace(/\{specialContent\}/g, specialContent);

  // Ë°®Á§∫„ÇíÊõ¥Êñ∞
  const subjectEl = document.getElementById('modalEmailSubject');
  const addressEl = document.getElementById('modalEmailAddress');
  const bodyEl = document.getElementById('modalEmailBody');

  if (subjectEl) subjectEl.textContent = subject;
  if (addressEl) addressEl.textContent = email;
  if (bodyEl) bodyEl.textContent = body;
}

function copyModalText(elementId) {
  const text = document.getElementById(elementId)?.textContent;
  if (!text || text.includes('{') || text.includes('ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ')) {
    showToast('„Ç≥„Éî„Éº„Åß„Åç„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
  }).catch(err => {
    console.error('„Ç≥„Éî„Éº„Å´Â§±Êïó:', err);
    showToast('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  });
}

async function markTaskAsRequested(projectId, taskKey) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  const progressData = project.progress || {};
  if (!progressData[taskKey]) progressData[taskKey] = {};
  progressData[taskKey].state = '‰æùÈ†ºÊ∏à';

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');
  const { error } = await supabase
    .from('projects')
    .update({ progress: progressData, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    console.error('Êõ¥Êñ∞„Ç®„É©„Éº:', error);
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return;
  }

  project.progress = progressData;
  renderProjects();
  closeEmailModal();
  showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
  showToast('‰æùÈ†ºÊ∏à„Åø„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
}

function closeEmailModal() {
  document.getElementById('emailModal').classList.remove('show');
  window.__currentEmailData = null;
}

// ============================================
// Áã¨Á´ã„Åó„Åü„É°„Éº„É´‰ΩúÊàêÊ©üËÉΩÔºàÂâäÈô§‰∫àÂÆöÔºâ
// ============================================
function updateStandaloneEmail() {
  const templateSelect = document.getElementById('standaloneTemplateSelect');
  const templateId = templateSelect.value;

  if (!templateId) {
    // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊú™ÈÅ∏ÊäûÊôÇ„ÅØ„ÇØ„É™„Ç¢
    document.getElementById('standaloneEmailSubject').textContent = '';
    document.getElementById('standaloneEmailAddress').textContent = '';
    document.getElementById('standaloneEmailBody').textContent = '';
    document.getElementById('standaloneVendorGroup').style.display = 'none';
    document.getElementById('standaloneSpecialContentGroup').style.display = 'none';
    return;
  }

  const template = emailTemplates.find(t => t.template_id === templateId);
  if (!template) return;

  // ÁâπË®ò‰∫ãÈ†Ö„Éï„Ç£„Éº„É´„Éâ„ÅÆË°®Á§∫/ÈùûË°®Á§∫
  if (template.has_special_content) {
    document.getElementById('standaloneSpecialContentGroup').style.display = 'block';
  } else {
    document.getElementById('standaloneSpecialContentGroup').style.display = 'none';
  }

  // ÂÖ•ÂäõÂÄ§„ÇíÂèñÂæó
  const customerName = document.getElementById('standaloneCustomerName').value.trim();
  const staffName = document.getElementById('standaloneStaffName').value.trim();
  const dueDate = document.getElementById('standaloneDueDate').value;
  const specialContent = document.getElementById('standaloneSpecialContent').value.trim();

  // „Çµ„Éñ„Ç™„Éó„Ç∑„Éß„É≥ÔºàÊ•≠ËÄÖÈÅ∏ÊäûÔºâ„Åå„ÅÇ„Çã„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂ†¥Âêà
  if (template.has_sub_options) {
    document.getElementById('standaloneVendorGroup').style.display = 'block';
    const vendorSelect = document.getElementById('standaloneVendorSelect');
    const selectedVendorId = vendorSelect.value;

    // Ê•≠ËÄÖÈÅ∏Êäû„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞
    if (vendorSelect.options.length === 0) {
      const templateVendors = vendors.filter(v => v.template_id === templateId);
      vendorSelect.innerHTML = '<option value="">Ê•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' +
        templateVendors.map(v =>
          `<option value="${v.vendor_id}">${v.company}</option>`
        ).join('');
    }

    if (!selectedVendorId) {
      // Ê•≠ËÄÖÊú™ÈÅ∏ÊäûÊôÇ„ÅØ„É°„Éº„É´ÁîüÊàê„Åó„Å™„ÅÑ
      document.getElementById('standaloneEmailSubject').textContent = 'Ê•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      document.getElementById('standaloneEmailAddress').textContent = '';
      document.getElementById('standaloneEmailBody').textContent = '';
      return;
    }

    const vendor = vendors.find(v => v.template_id === templateId && v.vendor_id === selectedVendorId);
    if (!vendor) return;

    // Ê•≠ËÄÖÊÉÖÂ†±„ÅßÂ§âÊï∞„ÇíÁΩÆÊèõ
    let subject = template.subject_format || '';
    let body = template.template_text || '';

    subject = subject
      .replace(/\{customerName\}/g, customerName || '{„ÅäÂÆ¢ÊßòÂêç}')
      .replace(/\{dueDate\}/g, dueDate || '{ÊúüÊó•}');

    body = body
      .replace(/\{company\}/g, vendor.company)
      .replace(/\{contact\}/g, vendor.contact || '„ÅîÊãÖÂΩìËÄÖÊßò')
      .replace(/\{customerName\}/g, customerName || '{„ÅäÂÆ¢ÊßòÂêç}')
      .replace(/\{staffName\}/g, staffName || '{ÊãÖÂΩìËÄÖÂêç}')
      .replace(/\{dueDate\}/g, dueDate || '{ÊúüÊó•}')
      .replace(/\{specialContent\}/g, specialContent || template.default_special_content || '');

    document.getElementById('standaloneEmailSubject').textContent = subject;
    document.getElementById('standaloneEmailAddress').textContent = vendor.email || '';
    document.getElementById('standaloneEmailBody').textContent = body;
  } else {
    // „Çµ„Éñ„Ç™„Éó„Ç∑„Éß„É≥„Å™„Åó„ÉÜ„É≥„Éó„É¨„Éº„Éà
    document.getElementById('standaloneVendorGroup').style.display = 'none';

    let subject = template.subject_format || '';
    let body = template.template_text || '';

    subject = subject
      .replace(/\{customerName\}/g, customerName || '{„ÅäÂÆ¢ÊßòÂêç}')
      .replace(/\{dueDate\}/g, dueDate || '{ÊúüÊó•}');

    body = body
      .replace(/\{company\}/g, template.company)
      .replace(/\{contact\}/g, template.contact || '„ÅîÊãÖÂΩìËÄÖÊßò')
      .replace(/\{customerName\}/g, customerName || '{„ÅäÂÆ¢ÊßòÂêç}')
      .replace(/\{staffName\}/g, staffName || '{ÊãÖÂΩìËÄÖÂêç}')
      .replace(/\{dueDate\}/g, dueDate || '{ÊúüÊó•}')
      .replace(/\{specialContent\}/g, specialContent || template.default_special_content || '');

    document.getElementById('standaloneEmailSubject').textContent = subject;
    document.getElementById('standaloneEmailAddress').textContent = template.email || '';
    document.getElementById('standaloneEmailBody').textContent = body;
  }
}

function copyStandaloneText(elementId) {
  const text = document.getElementById(elementId).textContent;
  if (!text || text.includes('{') || text.includes('ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ')) {
    showToast('„Ç≥„Éî„Éº„Åß„Åç„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
  }).catch(err => {
    console.error('„Ç≥„Éî„Éº„Å´Â§±Êïó:', err);
    showToast('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  });
}

function populateStandaloneTemplateSelect() {
  const select = document.getElementById('standaloneTemplateSelect');
  if (!select) return;

  // currentUserCategory„Å´Âøú„Åò„Å¶„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
  let filtered = emailTemplates;
  if (currentUserCategory && currentUserCategory !== 'admin') {
    filtered = emailTemplates.filter(t => t.category === currentUserCategory);
  }

  select.innerHTML = '<option value="">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' +
    filtered.map(t =>
      `<option value="${t.template_id}">${t.display_name}</option>`
    ).join('');
}

// ============================================
// „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ
// ============================================
const ExportManager = {
  // „Ç®„ÇØ„Çπ„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
  showModal() {
    const modal = document.createElement('div');
    modal.id = 'exportModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 500px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">üìÅ „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂΩ¢Âºè</label>
            <div style="display: grid; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="exportFormat" value="csv" checked> CSVÔºàExcelÂØæÂøúÔºâ
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="exportFormat" value="json"> JSON
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="exportFormat" value="print"> Âç∞Âà∑Áî®„É¨„Éù„Éº„Éà
              </label>
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂØæË±°</label>
            <div style="display: grid; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exportProjects" checked> Ê°à‰ª∂„Éá„Éº„ÇøÔºà${projects.length}‰ª∂Ôºâ
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exportWithTasks" checked> „Çø„Çπ„ÇØË©≥Á¥∞„ÇíÂê´„ÇÅ„Çã
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exportOnlyActive" checked> „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ê°à‰ª∂„ÅÆ„Åø
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('exportModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="btn btn-primary" onclick="ExportManager.execute()">„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  },

  execute() {
    const format = document.querySelector('input[name="exportFormat"]:checked').value;
    const includeProjects = document.getElementById('exportProjects').checked;
    const includeTasks = document.getElementById('exportWithTasks').checked;
    const onlyActive = document.getElementById('exportOnlyActive').checked;

    document.getElementById('exportModal').remove();

    let dataToExport = projects;
    if (onlyActive) {
      dataToExport = dataToExport.filter(p => p.status !== 'completed' && !p.is_archived);
    }

    switch (format) {
      case 'csv':
        this.exportCSV(dataToExport, includeTasks);
        break;
      case 'json':
        this.exportJSON(dataToExport, includeTasks);
        break;
      case 'print':
        this.exportPrint(dataToExport, includeTasks);
        break;
    }
  },

  exportCSV(data, includeTasks) {
    if (data.length === 0) {
      showToast('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÊ°à‰ª∂„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }

    let headers, rows;

    if (includeTasks) {
      headers = ['È°ßÂÆ¢Âêç', 'ÊãÖÂΩìËÄÖ', 'ICÊãÖÂΩì', 'ÂïÜÂìÅ', 'ÈÄ≤ÊçóÁéá', '„Çø„Çπ„ÇØÂêç', '„Çø„Çπ„ÇØÁä∂ÊÖã', 'ÊúüÈôê', '„É°„É¢', '‰ΩúÊàêÊó•'];
      rows = [];
      data.forEach(p => {
        const progress = calculateProgress(p);
        const tasks = p.tasks || {};
        const taskEntries = Object.entries(tasks);

        if (taskEntries.length === 0) {
          rows.push([
            this.csvEscape(p.customer),
            this.csvEscape(p.assigned_to),
            this.csvEscape(p.ic_assignee),
            this.csvEscape(p.specifications || 'LIFE'),
            `${progress}%`,
            '', '', '',
            this.csvEscape(p.memo),
            p.created_at || ''
          ].join(','));
        } else {
          taskEntries.forEach(([key, task], idx) => {
            const taskDef = tasksV2.find(t => t.task_key === key);
            rows.push([
              idx === 0 ? this.csvEscape(p.customer) : '',
              idx === 0 ? this.csvEscape(p.assigned_to) : '',
              idx === 0 ? this.csvEscape(p.ic_assignee) : '',
              idx === 0 ? this.csvEscape(p.specifications || 'LIFE') : '',
              idx === 0 ? `${progress}%` : '',
              this.csvEscape(taskDef?.task_name || key),
              this.csvEscape(task.status || ''),
              task.due_date || '',
              idx === 0 ? this.csvEscape(p.memo) : '',
              idx === 0 ? (p.created_at || '') : ''
            ].join(','));
          });
        }
      });
    } else {
      headers = ['È°ßÂÆ¢Âêç', 'ÊãÖÂΩìËÄÖ', 'ICÊãÖÂΩì', 'ÂïÜÂìÅ', 'ÈÄ≤ÊçóÁéá', '„É°„É¢', '‰ΩúÊàêÊó•', 'Êõ¥Êñ∞Êó•'];
      rows = data.map(p => {
        const progress = calculateProgress(p);
        return [
          this.csvEscape(p.customer),
          this.csvEscape(p.assigned_to),
          this.csvEscape(p.ic_assignee),
          this.csvEscape(p.specifications || 'LIFE'),
          `${progress}%`,
          this.csvEscape(p.memo),
          p.created_at || '',
          p.updated_at || ''
        ].join(',');
      });
    }

    const csvContent = [headers.join(','), ...rows].join('\n');
    this.download(csvContent, 'csv', 'projects');
    showToast(`${data.length}‰ª∂„ÅÆÊ°à‰ª∂„ÇíCSV„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`, 'success');
  },

  exportJSON(data, includeTasks) {
    if (data.length === 0) {
      showToast('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÊ°à‰ª∂„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }

    const exportData = data.map(p => {
      const base = {
        customer: p.customer,
        assigned_to: p.assigned_to,
        ic_assignee: p.ic_assignee,
        specifications: p.specifications,
        progress: calculateProgress(p),
        status: p.status,
        memo: p.memo,
        created_at: p.created_at,
        updated_at: p.updated_at
      };

      if (includeTasks && p.tasks) {
        base.tasks = Object.entries(p.tasks).map(([key, task]) => {
          const taskDef = tasksV2.find(t => t.task_key === key);
          return {
            task_key: key,
            task_name: taskDef?.task_name || key,
            status: task.status,
            due_date: task.due_date,
            completed_at: task.completed_at
          };
        });
      }

      return base;
    });

    const jsonContent = JSON.stringify({
      exported_at: new Date().toISOString(),
      version: APP_VERSION,
      count: exportData.length,
      projects: exportData
    }, null, 2);

    this.download(jsonContent, 'json', 'projects');
    showToast(`${data.length}‰ª∂„ÅÆÊ°à‰ª∂„ÇíJSON„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`, 'success');
  },

  exportPrint(data, includeTasks) {
    if (data.length === 0) {
      showToast('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÊ°à‰ª∂„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }

    const printWindow = window.open('', '_blank');
    const html = `
      <!DOCTYPE html>
      <html lang="ja">
      <head>
        <meta charset="UTF-8">
        <title>ArchiDeck - Ê°à‰ª∂„É¨„Éù„Éº„Éà</title>
        <style>
          body { font-family: 'Noto Sans JP', sans-serif; padding: 20mm; color: #333; }
          h1 { text-align: center; border-bottom: 2px solid #2563EB; padding-bottom: 10px; }
          .meta { text-align: right; color: #666; margin-bottom: 20px; }
          table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background: #f5f5f5; font-weight: 600; }
          .project-section { margin-bottom: 30px; page-break-inside: avoid; }
          .project-title { background: #2563EB; color: white; padding: 10px; margin-bottom: 10px; }
          .tasks-table { font-size: 12px; }
          .progress { font-weight: bold; color: #2563EB; }
          @media print {
            body { padding: 10mm; }
            .project-section { page-break-inside: avoid; }
          }
        </style>
      </head>
      <body>
        <h1>ArchiDeck Ê°à‰ª∂„É¨„Éù„Éº„Éà</h1>
        <div class="meta">
          Âá∫ÂäõÊó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}<br>
          Ê°à‰ª∂Êï∞: ${data.length}‰ª∂
        </div>
        ${data.map(p => {
          const progress = calculateProgress(p);
          const taskRows = includeTasks && p.tasks ? Object.entries(p.tasks).map(([key, task]) => {
            const taskDef = tasksV2.find(t => t.task_key === key);
            return `<tr>
              <td>${this.escapeHtml(taskDef?.task_name || key)}</td>
              <td>${this.escapeHtml(task.status || 'Êú™ÁùÄÊâã')}</td>
              <td>${task.due_date || '-'}</td>
            </tr>`;
          }).join('') : '';

          return `
            <div class="project-section">
              <div class="project-title">${this.escapeHtml(p.customer)} - ${this.escapeHtml(p.specifications || 'LIFE')}</div>
              <table>
                <tr><th>ÊãÖÂΩìËÄÖ</th><td>${this.escapeHtml(p.assigned_to || '-')}</td><th>ICÊãÖÂΩì</th><td>${this.escapeHtml(p.ic_assignee || '-')}</td></tr>
                <tr><th>ÈÄ≤Êçó</th><td class="progress">${progress}%</td><th>‰ΩúÊàêÊó•</th><td>${p.created_at?.split('T')[0] || '-'}</td></tr>
                ${p.memo ? `<tr><th>„É°„É¢</th><td colspan="3">${this.escapeHtml(p.memo)}</td></tr>` : ''}
              </table>
              ${includeTasks && taskRows ? `
                <table class="tasks-table">
                  <thead><tr><th>„Çø„Çπ„ÇØ</th><th>Áä∂ÊÖã</th><th>ÊúüÈôê</th></tr></thead>
                  <tbody>${taskRows}</tbody>
                </table>
              ` : ''}
            </div>
          `;
        }).join('')}
      </body>
      </html>
    `;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.onload = () => printWindow.print();
    showToast('Âç∞Âà∑Áî®„É¨„Éù„Éº„Éà„ÇíÁîüÊàê„Åó„Åæ„Åó„Åü', 'success');
  },

  csvEscape(str) {
    if (!str) return '""';
    return `"${String(str).replace(/"/g, '""')}"`;
  },

  escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  },

  download(content, type, prefix) {
    const mimeTypes = {
      csv: 'text/csv;charset=utf-8;',
      json: 'application/json;charset=utf-8;'
    };
    const extensions = { csv: 'csv', json: 'json' };

    const bom = type === 'csv' ? new Uint8Array([0xEF, 0xBB, 0xBF]) : new Uint8Array([]);
    const blob = new Blob([bom, content], { type: mimeTypes[type] });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${prefix}_${new Date().toISOString().split('T')[0]}.${extensions[type]}`;
    link.click();
    URL.revokeObjectURL(url);
  }
};

// ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊóßÈñ¢Êï∞„ÇíÊÆã„Åô
function exportCSV() {
  ExportManager.showModal();
}

// ============================================
// „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„ÉàÊ©üËÉΩ
// ============================================
const DataImporter = {
  showModal() {
    const modal = document.createElement('div');
    modal.id = 'importModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 500px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">üì• „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">„Ç§„É≥„Éù„Éº„ÉàÂΩ¢Âºè</label>
            <select id="importFormat" class="form-input" style="width: 100%; padding: 10px;">
              <option value="csv">CSVÔºàExcelÂá∫Âäõ„Éï„Ç°„Ç§„É´Ôºâ</option>
              <option value="json">JSONÔºà„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´Ôºâ</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">„Éï„Ç°„Ç§„É´ÈÅ∏Êäû</label>
            <input type="file" id="importFile" accept=".csv,.json" style="width: 100%;">
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
              CSV: È°ßÂÆ¢Âêç,ÊãÖÂΩìËÄÖ,ICÊãÖÂΩì,ÂïÜÂìÅ,„É°„É¢ „ÅÆÂΩ¢Âºè<br>
              JSON: „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åü„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´
            </p>
          </div>
          <div id="importPreview" style="display: none; margin-bottom: 16px;">
            <label class="form-label" style="font-weight: 500; margin-bottom: 8px; display: block;">„Éó„É¨„Éì„É•„Éº</label>
            <div id="importPreviewContent" style="max-height: 200px; overflow-y: auto; background: var(--bg-secondary); padding: 12px; border-radius: 8px; font-size: 13px;"></div>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="importSkipDuplicates" checked>
              <span>ÈáçË§á„Åô„ÇãÈ°ßÂÆ¢Âêç„ÅØ„Çπ„Ç≠„ÉÉ„Éó</span>
            </label>
          </div>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('importModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="btn btn-primary" id="importExecuteBtn" onclick="DataImporter.execute()" disabled>„Ç§„É≥„Éù„Éº„Éà</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);

    // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆ„Éó„É¨„Éì„É•„Éº
    document.getElementById('importFile').addEventListener('change', (e) => {
      this.previewFile(e.target.files[0]);
    });
  },

  async previewFile(file) {
    if (!file) return;

    const format = document.getElementById('importFormat').value;
    const previewDiv = document.getElementById('importPreview');
    const previewContent = document.getElementById('importPreviewContent');
    const executeBtn = document.getElementById('importExecuteBtn');

    try {
      const text = await file.text();
      let data;

      if (format === 'csv') {
        data = this.parseCSV(text);
      } else {
        data = this.parseJSON(text);
      }

      if (data.length === 0) {
        previewContent.innerHTML = '<p style="color: var(--danger-color);">„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</p>';
        executeBtn.disabled = true;
        previewDiv.style.display = 'block';
        return;
      }

      // „Éó„É¨„Éì„É•„ÉºË°®Á§∫ÔºàÊúÄÂ§ß5‰ª∂Ôºâ
      const previewItems = data.slice(0, 5);
      previewContent.innerHTML = `
        <p style="margin-bottom: 8px; font-weight: 500;">${data.length}‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíÊ§úÂá∫</p>
        ${previewItems.map(item => `
          <div style="padding: 8px; background: var(--bg-primary); border-radius: 4px; margin-bottom: 4px;">
            ${item.customer || item.È°ßÂÆ¢Âêç || '(È°ßÂÆ¢Âêç„Å™„Åó)'} - ${item.specifications || item.ÂïÜÂìÅ || 'LIFE'}
          </div>
        `).join('')}
        ${data.length > 5 ? `<p style="color: var(--text-muted);">...‰ªñ ${data.length - 5}‰ª∂</p>` : ''}
      `;

      this.pendingData = data;
      executeBtn.disabled = false;
      previewDiv.style.display = 'block';

    } catch (error) {
      previewContent.innerHTML = `<p style="color: var(--danger-color);">„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${error.message}</p>`;
      executeBtn.disabled = true;
      previewDiv.style.display = 'block';
    }
  },

  parseCSV(text) {
    const lines = text.split('\n').filter(line => line.trim());
    if (lines.length < 2) return [];

    // „Éò„ÉÉ„ÉÄ„ÉºËß£Êûê
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const data = [];

    for (let i = 1; i < lines.length; i++) {
      const values = this.parseCSVLine(lines[i]);
      if (values.length === 0) continue;

      const row = {};
      headers.forEach((header, idx) => {
        row[header] = values[idx] || '';
      });

      // È°ßÂÆ¢Âêç„Åå„ÅÇ„Çå„Å∞ÊúâÂäπ„Å™„Éá„Éº„Çø„Å®„Åó„Å¶ËøΩÂä†
      if (row['È°ßÂÆ¢Âêç'] || row['customer']) {
        data.push({
          customer: row['È°ßÂÆ¢Âêç'] || row['customer'] || '',
          assigned_to: row['ÊãÖÂΩìËÄÖ'] || row['assigned_to'] || '',
          ic_assignee: row['ICÊãÖÂΩì'] || row['ic_assignee'] || '',
          specifications: row['ÂïÜÂìÅ'] || row['specifications'] || 'LIFE',
          memo: row['„É°„É¢'] || row['memo'] || ''
        });
      }
    }

    return data;
  },

  parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === ',' && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    result.push(current.trim());
    return result;
  },

  parseJSON(text) {
    const json = JSON.parse(text);
    // „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂΩ¢Âºè„ÅÆÂ†¥Âêà
    if (json.projects && Array.isArray(json.projects)) {
      return json.projects;
    }
    // ÈÖçÂàó„ÅÆÂ†¥Âêà
    if (Array.isArray(json)) {
      return json;
    }
    return [];
  },

  async execute() {
    if (!this.pendingData || this.pendingData.length === 0) {
      showToast('„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }

    const skipDuplicates = document.getElementById('importSkipDuplicates').checked;
    const existingCustomers = new Set(projects.map(p => p.customer?.toLowerCase()));

    let imported = 0;
    let skipped = 0;

    showStatus('„Ç§„É≥„Éù„Éº„Éà‰∏≠...', 'saving');

    for (const item of this.pendingData) {
      // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
      if (skipDuplicates && existingCustomers.has(item.customer?.toLowerCase())) {
        skipped++;
        continue;
      }

      try {
        const newProject = {
          customer: item.customer,
          assigned_to: item.assigned_to || null,
          ic_assignee: item.ic_assignee || null,
          specifications: item.specifications || 'LIFE',
          memo: item.memo || '',
          status: 'active',
          progress: {},
          tasks: {}
        };

        const { data, error } = await supabase
          .from('projects')
          .insert(newProject)
          .select()
          .single();

        if (!error && data) {
          projects.push(data);
          existingCustomers.add(item.customer?.toLowerCase());
          imported++;
        }
      } catch (e) {
        console.error('„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', e);
      }
    }

    document.getElementById('importModal').remove();
    renderProjects();
    renderSidebar();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');

    let message = `${imported}‰ª∂„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`;
    if (skipped > 0) {
      message += `Ôºà${skipped}‰ª∂„ÅØÈáçË§á„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„ÉóÔºâ`;
    }
    showToast(message, 'success');

    this.pendingData = null;
  },

  pendingData: null
};

// ============================================
// „ÅäÊ∞ó„Å´ÂÖ•„ÇäÁÆ°ÁêÜ
// ============================================
const FavoritesManager = {
  favorites: new Set(JSON.parse(localStorage.getItem('favorites') || '[]')),

  toggle(projectId) {
    if (this.favorites.has(projectId)) {
      this.favorites.delete(projectId);
      showToast('„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åã„ÇâÂâäÈô§„Åó„Åæ„Åó„Åü', 'info');
    } else {
      this.favorites.add(projectId);
      showToast('„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
    }
    this.save();
    renderProjects();
  },

  isFavorite(projectId) {
    return this.favorites.has(projectId);
  },

  save() {
    localStorage.setItem('favorites', JSON.stringify([...this.favorites]));
  },

  getCount() {
    return this.favorites.size;
  }
};

// ============================================
// „Éê„ÉÉ„ÉÅÊìç‰Ωú
// ============================================
const BatchOperations = {
  selected: new Set(),

  toggle(projectId) {
    if (this.selected.has(projectId)) {
      this.selected.delete(projectId);
    } else {
      this.selected.add(projectId);
    }
    this.updateUI();
  },

  selectAll() {
    const visibleCards = document.querySelectorAll('.project-card[data-project-id]');
    visibleCards.forEach(card => {
      this.selected.add(card.dataset.projectId);
    });
    this.updateUI();
    renderProjects();
  },

  deselectAll() {
    this.selected.clear();
    this.updateUI();
    renderProjects();
  },

  isSelected(projectId) {
    return this.selected.has(projectId);
  },

  updateUI() {
    const toolbar = document.getElementById('batchToolbar');
    const count = this.selected.size;

    if (count > 0) {
      if (!toolbar) {
        this.showToolbar();
      }
      document.getElementById('batchCount').textContent = `${count}‰ª∂ÈÅ∏Êäû‰∏≠`;
    } else {
      if (toolbar) toolbar.remove();
    }

    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    document.querySelectorAll('.batch-checkbox').forEach(cb => {
      cb.checked = this.selected.has(cb.dataset.projectId);
    });
  },

  showToolbar() {
    const toolbar = document.createElement('div');
    toolbar.id = 'batchToolbar';
    toolbar.style.cssText = `
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--bg-primary); border: 1px solid var(--border-color);
      padding: 12px 20px; border-radius: 12px; box-shadow: var(--shadow-lg);
      display: flex; align-items: center; gap: 16px; z-index: 1000;
    `;
    toolbar.innerHTML = `
      <span id="batchCount" style="font-weight: 600;">0‰ª∂ÈÅ∏Êäû‰∏≠</span>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.archiveSelected()">üì¶ ‰∏ÄÊã¨ÂÆå‰∫Ü</button>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.showAssignModal()">üë§ ÊãÖÂΩìÂ§âÊõ¥</button>
      <button class="btn btn-ghost btn-small" onclick="BatchOperations.deselectAll()">‚úï ÈÅ∏ÊäûËß£Èô§</button>
    `;
    document.body.appendChild(toolbar);
  },

  async archiveSelected() {
    if (this.selected.size === 0) return;

    const confirmed = confirm(`${this.selected.size}‰ª∂„ÅÆÊ°à‰ª∂„ÇíÂÆå‰∫ÜÊ∏à„Åø„Å´„Åó„Åæ„Åô„ÅãÔºü`);
    if (!confirmed) return;

    showStatus('Âá¶ÁêÜ‰∏≠...', 'saving');
    let count = 0;

    for (const projectId of this.selected) {
      const { error } = await supabase
        .from('projects')
        .update({ is_archived: true, updated_at: new Date().toISOString() })
        .eq('id', projectId);

      if (!error) {
        const project = projects.find(p => p.id === projectId);
        if (project) project.is_archived = true;
        count++;
      }
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    renderSidebar();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(`${count}‰ª∂„ÇíÂÆå‰∫ÜÊ∏à„Åø„Å´„Åó„Åæ„Åó„Åü`, 'success');
  },

  showAssignModal() {
    if (this.selected.size === 0) return;

    const modal = document.createElement('div');
    modal.id = 'batchAssignModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    const designerOptions = designers
      .filter(d => d.category === 'Ë®≠Ë®à')
      .map(d => `<option value="${d.name}">${d.name}</option>`)
      .join('');

    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; max-width: 400px; width: 90%;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">üë§ ‰∏ÄÊã¨ÊãÖÂΩìËÄÖÂ§âÊõ¥</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <p style="margin-bottom: 16px; color: var(--text-secondary);">${this.selected.size}‰ª∂„ÅÆÊ°à‰ª∂„ÅÆÊãÖÂΩìËÄÖ„ÇíÂ§âÊõ¥„Åó„Åæ„Åô</p>
          <select id="batchAssignee" class="form-input" style="width: 100%;">
            <option value="">ÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû</option>
            ${designerOptions}
          </select>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('batchAssignModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="btn btn-primary" onclick="BatchOperations.applyAssign()">Â§âÊõ¥</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);
  },

  async applyAssign() {
    const assignee = document.getElementById('batchAssignee').value;
    if (!assignee) {
      showToast('ÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
      return;
    }

    document.getElementById('batchAssignModal').remove();
    showStatus('Âá¶ÁêÜ‰∏≠...', 'saving');
    let count = 0;

    for (const projectId of this.selected) {
      const { error } = await supabase
        .from('projects')
        .update({ assigned_to: assignee, updated_at: new Date().toISOString() })
        .eq('id', projectId);

      if (!error) {
        const project = projects.find(p => p.id === projectId);
        if (project) project.assigned_to = assignee;
        count++;
      }
    }

    this.selected.clear();
    this.updateUI();
    renderProjects();
    renderSidebar();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(`${count}‰ª∂„ÅÆÊãÖÂΩìËÄÖ„Çí${assignee}„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'success');
  }
};

// ============================================
// „Éï„Ç£„É´„Çø„Éº„Éó„É™„Çª„ÉÉ„ÉàÁÆ°ÁêÜ
// ============================================
const FilterPresets = {
  presets: JSON.parse(localStorage.getItem('filterPresets') || '[]'),

  save() {
    localStorage.setItem('filterPresets', JSON.stringify(this.presets));
  },

  getCurrentFilter() {
    return {
      designer: currentDesignerTab,
      archive: document.getElementById('archiveFilter')?.value || 'active',
      search: document.getElementById('searchQuery')?.value || '',
      spec: document.getElementById('specFilter')?.value || ''
    };
  },

  addPreset(name) {
    if (!name || !name.trim()) {
      showToast('„Éó„É™„Çª„ÉÉ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
      return false;
    }

    const filter = this.getCurrentFilter();
    const preset = {
      id: Date.now().toString(),
      name: name.trim(),
      filter: filter,
      createdAt: new Date().toISOString()
    };

    this.presets.unshift(preset);
    this.save();
    this.renderDropdown();
    showToast(`„Äå${name}„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`, 'success');
    return true;
  },

  deletePreset(id) {
    const preset = this.presets.find(p => p.id === id);
    if (preset && confirm(`„Äå${preset.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
      this.presets = this.presets.filter(p => p.id !== id);
      this.save();
      this.renderDropdown();
      showToast('„Éó„É™„Çª„ÉÉ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'info');
    }
  },

  applyPreset(id) {
    const preset = this.presets.find(p => p.id === id);
    if (!preset) return;

    const { filter } = preset;

    // ÊãÖÂΩìËÄÖ„Çø„Éñ„ÇíÂàá„ÇäÊõø„Åà
    if (filter.designer) {
      currentDesignerTab = filter.designer;
      renderDesignerTabs();
    }

    // „Éï„Ç£„É´„Çø„ÉºÂÄ§„ÇíË®≠ÂÆö
    const archiveFilter = document.getElementById('archiveFilter');
    const searchQuery = document.getElementById('searchQuery');
    const specFilter = document.getElementById('specFilter');

    if (archiveFilter) archiveFilter.value = filter.archive || 'active';
    if (searchQuery) searchQuery.value = filter.search || '';
    if (specFilter) specFilter.value = filter.spec || '';

    renderProjects();
    showToast(`„Äå${preset.name}„Äç„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü`, 'success');
  },

  showSaveModal() {
    const filter = this.getCurrentFilter();
    const filterDesc = this.describeFilter(filter);

    const modal = document.createElement('div');
    modal.id = 'presetSaveModal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div class="modal-content" style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">„Éï„Ç£„É´„Çø„Éº„Çí‰øùÂ≠ò</h3>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
            <strong>ÁèæÂú®„ÅÆ„Éï„Ç£„É´„Çø„Éº:</strong><br>${filterDesc}
          </div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">„Éó„É™„Çª„ÉÉ„ÉàÂêç</label>
          <input type="text" id="presetName" class="form-input" style="width: 100%;" placeholder="‰æã: Áî∞‰∏≠„Åï„Çì„ÅÆÈÄ≤Ë°å‰∏≠Ê°à‰ª∂" autofocus>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-ghost" onclick="document.getElementById('presetSaveModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="btn btn-primary" onclick="FilterPresets.confirmSave()">‰øùÂ≠ò</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    document.body.appendChild(modal);

    // Enter„Ç≠„Éº„Åß‰øùÂ≠ò
    document.getElementById('presetName').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') FilterPresets.confirmSave();
    });
  },

  confirmSave() {
    const name = document.getElementById('presetName').value;
    if (this.addPreset(name)) {
      document.getElementById('presetSaveModal').remove();
    }
  },

  describeFilter(filter) {
    const parts = [];
    if (filter.designer && filter.designer !== 'ALL') {
      parts.push(`ÊãÖÂΩì: ${filter.designer}`);
    }
    if (filter.archive && filter.archive !== 'active') {
      const labels = { all: 'ÂÖ®„Å¶', archived: 'ÂÆå‰∫ÜÊ∏à„Åø', favorites: '„ÅäÊ∞ó„Å´ÂÖ•„Çä' };
      parts.push(labels[filter.archive] || filter.archive);
    }
    if (filter.search) {
      parts.push(`Ê§úÁ¥¢: "${filter.search}"`);
    }
    if (filter.spec) {
      parts.push(`‰ªïÊßò: ${filter.spec}`);
    }
    return parts.length > 0 ? parts.join('„ÄÅ') : '„Éï„Ç£„É´„Çø„Éº„Å™„Åó';
  },

  renderDropdown() {
    const container = document.getElementById('presetDropdown');
    if (!container) return;

    if (this.presets.length === 0) {
      container.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); font-size: 13px;">‰øùÂ≠òÊ∏à„Åø„Éó„É™„Çª„ÉÉ„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      return;
    }

    container.innerHTML = this.presets.map(preset => `
      <div class="preset-item" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid var(--border-color); cursor: pointer;"
           onmouseenter="this.style.background='var(--bg-secondary)'"
           onmouseleave="this.style.background='white'">
        <div style="flex: 1;" onclick="FilterPresets.applyPreset('${preset.id}'); document.getElementById('presetMenu').style.display='none';">
          <div style="font-weight: 500; font-size: 14px;">${preset.name}</div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${this.describeFilter(preset.filter)}</div>
        </div>
        <button class="btn btn-ghost btn-small" style="padding: 4px 8px; font-size: 12px;" onclick="event.stopPropagation(); FilterPresets.deletePreset('${preset.id}')">ÂâäÈô§</button>
      </div>
    `).join('');
  },

  toggleMenu() {
    const menu = document.getElementById('presetMenu');
    if (!menu) return;

    if (menu.style.display === 'none' || !menu.style.display) {
      this.renderDropdown();
      menu.style.display = 'block';
      // Â§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
      setTimeout(() => {
        document.addEventListener('click', this.closeMenuOnClickOutside);
      }, 10);
    } else {
      menu.style.display = 'none';
      document.removeEventListener('click', this.closeMenuOnClickOutside);
    }
  },

  closeMenuOnClickOutside(e) {
    const menu = document.getElementById('presetMenu');
    const btn = document.getElementById('presetBtn');
    if (menu && !menu.contains(e.target) && !btn.contains(e.target)) {
      menu.style.display = 'none';
      document.removeEventListener('click', FilterPresets.closeMenuOnClickOutside);
    }
  }
};

// ============================================
// „ÇØ„Ç§„ÉÉ„ÇØÁ∑®ÈõÜ
// ============================================
const QuickEdit = {
  showAssigneeDropdown(projectId, element) {
    // Êó¢Â≠ò„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÂâäÈô§
    document.querySelectorAll('.quick-edit-dropdown').forEach(el => el.remove());

    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const rect = element.getBoundingClientRect();
    const designerList = designers.filter(d => d.category === 'Ë®≠Ë®à' || d.category === 'IC');

    const dropdown = document.createElement('div');
    dropdown.className = 'quick-edit-dropdown';
    dropdown.style.cssText = `position: fixed; top: ${rect.bottom + 4}px; left: ${rect.left}px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; min-width: 150px;`;

    dropdown.innerHTML = `
      <div style="padding: 8px 12px; border-bottom: 1px solid var(--border-color); font-size: 12px; color: var(--text-secondary);">ÊãÖÂΩìËÄÖ„ÇíÂ§âÊõ¥</div>
      ${designerList.map(d => `
        <div class="quick-edit-option" style="padding: 10px 12px; cursor: pointer; font-size: 14px; ${project.assigned_to === d.name ? 'background: var(--primary-light); font-weight: 500;' : ''}"
             onmouseenter="this.style.background='var(--bg-secondary)'"
             onmouseleave="this.style.background='${project.assigned_to === d.name ? 'var(--primary-light)' : ''}'"
             onclick="QuickEdit.changeAssignee('${projectId}', '${d.name}')">${d.name}</div>
      `).join('')}
    `;

    document.body.appendChild(dropdown);

    // Â§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    setTimeout(() => {
      document.addEventListener('click', QuickEdit.closeDropdown);
    }, 10);
  },

  closeDropdown(e) {
    if (!e.target.closest('.quick-edit-dropdown') && !e.target.closest('.quick-edit-trigger')) {
      document.querySelectorAll('.quick-edit-dropdown').forEach(el => el.remove());
      document.removeEventListener('click', QuickEdit.closeDropdown);
    }
  },

  async changeAssignee(projectId, assignee) {
    document.querySelectorAll('.quick-edit-dropdown').forEach(el => el.remove());

    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const oldAssignee = project.assigned_to;
    showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

    const { error } = await supabase
      .from('projects')
      .update({ assigned_to: assignee, updated_at: new Date().toISOString() })
      .eq('id', projectId);

    if (error) {
      showStatus('„Ç®„É©„Éº', 'error');
      showToast('Â§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
      return;
    }

    UndoManager.record({
      type: 'UPDATE_PROJECT',
      projectId,
      description: `${project.customer} - ÊãÖÂΩìËÄÖ„Çí${oldAssignee || 'Êú™Ââ≤ÂΩì'}„Åã„Çâ${assignee}„Å´Â§âÊõ¥`,
      oldValue: { assigned_to: oldAssignee },
      newValue: { assigned_to: assignee }
    });

    project.assigned_to = assignee;
    project.updated_at = new Date().toISOString();
    renderProjects();
    renderSidebar();
    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(`ÊãÖÂΩìËÄÖ„Çí${assignee}„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'success');
  }
};

// ============================================
// ÊúüÈôê„Éª„É™„Éû„Ç§„É≥„ÉÄ„ÉºÁÆ°ÁêÜ
// ============================================
const DeadlineManager = {
  reminders: JSON.parse(localStorage.getItem('projectReminders') || '{}'),

  setDeadline(projectId, deadline) {
    this.reminders[projectId] = { deadline, notified: false };
    this.save();
  },

  getDeadline(projectId) {
    return this.reminders[projectId]?.deadline || null;
  },

  save() {
    localStorage.setItem('projectReminders', JSON.stringify(this.reminders));
  },

  checkReminders() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    projects.forEach(project => {
      const reminder = this.reminders[project.id];
      if (!reminder || reminder.notified || project.is_archived) return;

      const deadline = new Date(reminder.deadline);
      deadline.setHours(0, 0, 0, 0);
      const diffDays = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));

      if (diffDays <= 3 && diffDays >= 0) {
        const msg = diffDays === 0 ? 'Êú¨Êó•„ÅåÊúüÈôê„Åß„Åô' : `„ÅÇ„Å®${diffDays}Êó•„ÅßÊúüÈôê„Åß„Åô`;
        showToast(`üìÖ ${project.customer}: ${msg}`, 'warning');
        this.reminders[project.id].notified = true;
        this.save();
      } else if (diffDays < 0) {
        showToast(`‚ö†Ô∏è ${project.customer}: ÊúüÈôê„Çí${Math.abs(diffDays)}Êó•ÈÅé„Åé„Å¶„ÅÑ„Åæ„Åô`, 'error');
        this.reminders[project.id].notified = true;
        this.save();
      }
    });
  },

  getStatus(projectId) {
    const deadline = this.getDeadline(projectId);
    if (!deadline) return null;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const due = new Date(deadline);
    due.setHours(0, 0, 0, 0);
    const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

    if (diffDays < 0) return { class: 'overdue', label: `${Math.abs(diffDays)}Êó•Ë∂ÖÈÅé`, color: '#EF4444' };
    if (diffDays === 0) return { class: 'today', label: 'Êú¨Êó•', color: '#F59E0B' };
    if (diffDays <= 3) return { class: 'soon', label: `„ÅÇ„Å®${diffDays}Êó•`, color: '#F59E0B' };
    return { class: 'normal', label: `${due.getMonth() + 1}/${due.getDate()}`, color: '#6B7280' };
  },

  showModal(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const currentDeadline = this.getDeadline(projectId) || '';

    const modal = document.createElement('div');
    modal.id = 'deadlineModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 360px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">ÊúüÈôê„ÇíË®≠ÂÆö</h3>
          <p style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;">${project.customer}</p>
        </div>
        <div style="padding: 20px;">
          <input type="date" id="deadlineInput" class="form-input" style="width: 100%;" value="${currentDeadline}">
          <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">ÊúüÈôê„ÅÆ3Êó•Ââç„Åã„ÇâÈÄöÁü•„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between;">
          <button class="btn btn-ghost" onclick="DeadlineManager.clearDeadline('${projectId}')">„ÇØ„É™„Ç¢</button>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-ghost" onclick="document.getElementById('deadlineModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
            <button class="btn btn-primary" onclick="DeadlineManager.saveFromModal('${projectId}')">‰øùÂ≠ò</button>
          </div>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  },

  saveFromModal(projectId) {
    const deadline = document.getElementById('deadlineInput').value;
    if (deadline) {
      this.setDeadline(projectId, deadline);
      showToast('ÊúüÈôê„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü', 'success');
    }
    document.getElementById('deadlineModal').remove();
    renderProjects();
  },

  clearDeadline(projectId) {
    delete this.reminders[projectId];
    this.save();
    document.getElementById('deadlineModal').remove();
    renderProjects();
    showToast('ÊúüÈôê„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'info');
  }
};

// ============================================
// „Ç´„É¨„É≥„ÉÄ„Éº„Éì„É•„Éº
// ============================================
const CalendarView = {
  currentMonth: new Date(),

  render() {
    const container = document.getElementById('calendarContainer');
    if (!container) return;

    const year = this.currentMonth.getFullYear();
    const month = this.currentMonth.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDayOfWeek = firstDay.getDay();

    // Ê°à‰ª∂„ÇíÊúüÈôê„Åß„Ç∞„É´„Éº„ÉóÂåñ
    const projectsByDate = {};
    projects.forEach(project => {
      if (project.is_archived) return;
      const deadline = DeadlineManager.getDeadline(project.id);
      if (deadline) {
        if (!projectsByDate[deadline]) projectsByDate[deadline] = [];
        projectsByDate[deadline].push(project);
      }
    });

    const monthNames = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
    const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];

    let html = `
      <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <button class="btn btn-ghost" onclick="CalendarView.prevMonth()">‚óÄ</button>
        <h3 style="font-size: 18px; font-weight: 600;">${year}Âπ¥ ${monthNames[month]}</h3>
        <button class="btn btn-ghost" onclick="CalendarView.nextMonth()">‚ñ∂</button>
      </div>
      <div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border-color); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
        ${dayNames.map((day, i) => `<div style="padding: 8px; text-align: center; font-weight: 600; font-size: 12px; background: var(--bg-secondary); color: ${i === 0 ? '#EF4444' : i === 6 ? '#3B82F6' : 'var(--text-primary)'};">${day}</div>`).join('')}
    `;

    // Á©∫ÁôΩ„Çª„É´
    for (let i = 0; i < startDayOfWeek; i++) {
      html += '<div style="padding: 8px; background: var(--bg-primary); min-height: 80px;"></div>';
    }

    // Êó•‰ªò„Çª„É´
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let day = 1; day <= lastDay.getDate(); day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const dateProjects = projectsByDate[dateStr] || [];
      const isToday = new Date(year, month, day).getTime() === today.getTime();
      const dayOfWeek = new Date(year, month, day).getDay();

      html += `
        <div style="padding: 6px; background: ${isToday ? 'var(--primary-light)' : 'white'}; min-height: 80px; cursor: pointer;" onclick="CalendarView.showDateProjects('${dateStr}')">
          <div style="font-size: 14px; font-weight: ${isToday ? '600' : '400'}; color: ${dayOfWeek === 0 ? '#EF4444' : dayOfWeek === 6 ? '#3B82F6' : 'var(--text-primary)'}; margin-bottom: 4px;">${day}</div>
          ${dateProjects.slice(0, 3).map(p => `<div style="font-size: 11px; padding: 2px 4px; background: var(--primary-color); color: white; border-radius: 4px; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.customer}</div>`).join('')}
          ${dateProjects.length > 3 ? `<div style="font-size: 10px; color: var(--text-secondary);">+${dateProjects.length - 3}‰ª∂</div>` : ''}
        </div>
      `;
    }

    html += '</div>';
    container.innerHTML = html;
  },

  prevMonth() {
    this.currentMonth.setMonth(this.currentMonth.getMonth() - 1);
    this.render();
  },

  nextMonth() {
    this.currentMonth.setMonth(this.currentMonth.getMonth() + 1);
    this.render();
  },

  showDateProjects(dateStr) {
    const dateProjects = projects.filter(p => {
      const deadline = DeadlineManager.getDeadline(p.id);
      return deadline === dateStr && !p.is_archived;
    });

    if (dateProjects.length === 0) {
      showToast('„Åì„ÅÆÊó•„Å´ÊúüÈôê„ÅÆÊ°à‰ª∂„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì', 'info');
      return;
    }

    const date = new Date(dateStr);
    const modal = document.createElement('div');
    modal.id = 'dateProjectsModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 400px; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">${date.getMonth() + 1}/${date.getDate()} „ÅÆÊ°à‰ª∂</h3>
        </div>
        <div style="padding: 12px; max-height: 400px; overflow-y: auto;">
          ${dateProjects.map(p => `
            <div style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; cursor: pointer;"
                 onclick="document.getElementById('dateProjectsModal').remove(); editProject('${p.id}')">
              <div style="font-weight: 500;">${p.customer}</div>
              <div style="font-size: 13px; color: var(--text-secondary);">ÊãÖÂΩì: ${p.assigned_to || 'Êú™Ââ≤ÂΩì'}</div>
            </div>
          `).join('')}
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color);">
          <button class="btn btn-ghost" style="width: 100%;" onclick="document.getElementById('dateProjectsModal').remove()">Èñâ„Åò„Çã</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  }
};

// ============================================
// „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÉÜ„É≥„Éó„É¨„Éº„Éà
// ============================================
const TemplateManager = {
  templates: JSON.parse(localStorage.getItem('projectTemplates') || '[]'),

  save() {
    localStorage.setItem('projectTemplates', JSON.stringify(this.templates));
  },

  createFromProject(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    const name = prompt('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', `${project.specifications || 'LIFE'}„ÉÜ„É≥„Éó„É¨„Éº„Éà`);
    if (!name) return;

    const template = {
      id: Date.now().toString(),
      name: name,
      specifications: project.specifications,
      progress: project.progress || {},
      createdAt: new Date().toISOString()
    };

    this.templates.push(template);
    this.save();
    showToast(`„ÉÜ„É≥„Éó„É¨„Éº„Éà„Äå${name}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
  },

  applyTemplate(templateId, projectId) {
    const template = this.templates.find(t => t.id === templateId);
    const project = projects.find(p => p.id === projectId);
    if (!template || !project) return;

    project.specifications = template.specifications;
    project.progress = JSON.parse(JSON.stringify(template.progress));

    this.saveProject(project);
    showToast(`„ÉÜ„É≥„Éó„É¨„Éº„Éà„Äå${template.name}„Äç„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü`, 'success');
  },

  async saveProject(project) {
    const { error } = await supabase
      .from('projects')
      .update({
        specifications: project.specifications,
        progress: project.progress,
        updated_at: new Date().toISOString()
      })
      .eq('id', project.id);

    if (!error) {
      renderProjects();
    }
  },

  deleteTemplate(templateId) {
    const template = this.templates.find(t => t.id === templateId);
    if (template && confirm(`„ÉÜ„É≥„Éó„É¨„Éº„Éà„Äå${template.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
      this.templates = this.templates.filter(t => t.id !== templateId);
      this.save();
      showToast('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'info');
    }
  },

  showSelectModal(projectId) {
    if (this.templates.length === 0) {
      showToast('‰øùÂ≠òÊ∏à„Åø„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'info');
      return;
    }

    const modal = document.createElement('div');
    modal.id = 'templateSelectModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ©Áî®</h3>
        </div>
        <div style="padding: 12px; max-height: 300px; overflow-y: auto;">
          ${this.templates.map(t => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 500;">${t.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${t.specifications || 'LIFE'}</div>
              </div>
              <button class="btn btn-primary btn-small" onclick="TemplateManager.applyTemplate('${t.id}', '${projectId}'); document.getElementById('templateSelectModal').remove();">ÈÅ©Áî®</button>
            </div>
          `).join('')}
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color);">
          <button class="btn btn-ghost" style="width: 100%;" onclick="document.getElementById('templateSelectModal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  },

  showManageModal() {
    const modal = document.createElement('div');
    modal.id = 'templateManageModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    modal.innerHTML = `
      <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
          <h3 style="font-size: 18px; font-weight: 600;">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ</h3>
        </div>
        <div style="padding: 12px; max-height: 400px; overflow-y: auto;">
          ${this.templates.length === 0 ? '<p style="padding: 20px; text-align: center; color: var(--text-secondary);">„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br><small>Ê°à‰ª∂„ÅÆÁ∑®ÈõÜÁîªÈù¢„Åã„Çâ„Äå„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Äç„Åß‰ΩúÊàê„Åß„Åç„Åæ„Åô</small></p>' : this.templates.map(t => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 500;">${t.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${t.specifications || 'LIFE'} | ${new Date(t.createdAt).toLocaleDateString()}</div>
              </div>
              <button class="btn btn-ghost btn-small" style="color: #EF4444;" onclick="TemplateManager.deleteTemplate('${t.id}'); document.getElementById('templateManageModal').remove(); TemplateManager.showManageModal();">ÂâäÈô§</button>
            </div>
          `).join('')}
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid var(--border-color);">
          <button class="btn btn-ghost" style="width: 100%;" onclick="document.getElementById('templateManageModal').remove()">Èñâ„Åò„Çã</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  }
};

// ============================================
// „É¢„Éê„Ç§„É´„Çπ„ÉØ„Ç§„ÉóÊìç‰Ωú
// ============================================
const MobileGestures = {
  startX: 0,
  startY: 0,
  currentCard: null,

  init() {
    document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
    document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
    document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: true });
  },

  handleTouchStart(e) {
    const card = e.target.closest('.project-card');
    if (!card) return;

    this.startX = e.touches[0].clientX;
    this.startY = e.touches[0].clientY;
    this.currentCard = card;
  },

  handleTouchMove(e) {
    if (!this.currentCard) return;

    const diffX = e.touches[0].clientX - this.startX;
    const diffY = e.touches[0].clientY - this.startY;

    // Ê®™ÊñπÂêë„ÅÆ„Çπ„ÉØ„Ç§„Éó„ÇíÊ§úÂá∫
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 30) {
      e.preventDefault();
      const maxSwipe = 100;
      const translateX = Math.max(-maxSwipe, Math.min(maxSwipe, diffX));
      this.currentCard.style.transform = `translateX(${translateX}px)`;
      this.currentCard.style.transition = 'none';

      // „Çπ„ÉØ„Ç§„ÉóÊñπÂêë„Å´Âøú„Åò„ÅüËÉåÊôØËâ≤
      if (diffX > 50) {
        this.currentCard.style.background = 'linear-gradient(to right, #10B981 0%, white 30%)';
      } else if (diffX < -50) {
        this.currentCard.style.background = 'linear-gradient(to left, #F59E0B 0%, white 30%)';
      } else {
        this.currentCard.style.background = '';
      }
    }
  },

  handleTouchEnd(e) {
    if (!this.currentCard) return;

    const diffX = e.changedTouches[0].clientX - this.startX;
    const projectId = this.currentCard.dataset.projectId;

    this.currentCard.style.transform = '';
    this.currentCard.style.transition = 'transform 0.2s ease';
    this.currentCard.style.background = '';

    if (diffX > 80 && projectId) {
      // Âè≥„Çπ„ÉØ„Ç§„Éó: „ÅäÊ∞ó„Å´ÂÖ•„ÇäÂàá„ÇäÊõø„Åà
      FavoritesManager.toggle(projectId);
    } else if (diffX < -80 && projectId) {
      // Â∑¶„Çπ„ÉØ„Ç§„Éó: ÂÆå‰∫ÜÂàá„ÇäÊõø„Åà
      const project = projects.find(p => p.id === projectId);
      if (project && calculateProgress(project) >= 100) {
        toggleArchive(projectId, !project.is_archived);
      } else {
        showToast('ÂÆå‰∫Ü„Å´„Åô„Çã„Å´„ÅØÈÄ≤Êçó100%„ÅåÂøÖË¶Å„Åß„Åô', 'info');
      }
    }

    this.currentCard = null;
  }
};

// ============================================
// „Çª„ÉÉ„Ç∑„Éß„É≥„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÁÆ°ÁêÜ
// ============================================
const SessionManager = {
  timeoutMinutes: 60,
  warningMinutes: 5,
  lastActivity: Date.now(),
  timeoutId: null,
  warningId: null,
  warningShown: false,

  init() {
    this.resetTimer();
    this.setupActivityListeners();
    console.log('üîí „Çª„ÉÉ„Ç∑„Éß„É≥ÁÆ°ÁêÜÈñãÂßãÔºà„Çø„Ç§„É†„Ç¢„Ç¶„Éà: ' + this.timeoutMinutes + 'ÂàÜÔºâ');
  },

  setupActivityListeners() {
    const events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];
    events.forEach(event => {
      document.addEventListener(event, () => this.onActivity(), { passive: true });
    });
  },

  onActivity() {
    this.lastActivity = Date.now();
    if (this.warningShown) {
      this.hideWarning();
    }
    this.resetTimer();
  },

  resetTimer() {
    if (this.timeoutId) clearTimeout(this.timeoutId);
    if (this.warningId) clearTimeout(this.warningId);

    // Ë≠¶ÂëäË°®Á§∫„Çø„Ç§„Éû„Éº
    const warningMs = (this.timeoutMinutes - this.warningMinutes) * 60 * 1000;
    this.warningId = setTimeout(() => this.showWarning(), warningMs);

    // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„Çø„Ç§„Éû„Éº
    const timeoutMs = this.timeoutMinutes * 60 * 1000;
    this.timeoutId = setTimeout(() => this.onTimeout(), timeoutMs);
  },

  showWarning() {
    if (this.warningShown) return;
    this.warningShown = true;

    const warning = document.createElement('div');
    warning.id = 'sessionWarning';
    warning.style.cssText = `
      position: fixed; bottom: 20px; right: 20px; z-index: 10001;
      background: var(--warning-color); color: white;
      padding: 16px 20px; border-radius: 8px;
      box-shadow: var(--shadow-lg); max-width: 320px;
    `;
    warning.innerHTML = `
      <div style="font-weight: 600; margin-bottom: 8px;">‚è∞ „Çª„ÉÉ„Ç∑„Éß„É≥ÊúüÈôê</div>
      <div style="font-size: 14px; margin-bottom: 12px;">
        ${this.warningMinutes}ÂàÜÈñìÊìç‰Ωú„Åå„Å™„ÅÑ„Å®„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô
      </div>
      <button onclick="SessionManager.extendSession()"
        style="background: var(--bg-primary); color: var(--warning-color); border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
        „Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂª∂Èï∑
      </button>
    `;
    document.body.appendChild(warning);
  },

  hideWarning() {
    this.warningShown = false;
    const warning = document.getElementById('sessionWarning');
    if (warning) warning.remove();
  },

  extendSession() {
    this.onActivity();
    showToast('„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂª∂Èï∑„Åó„Åæ„Åó„Åü', 'success');
  },

  onTimeout() {
    this.hideWarning();
    showToast('„Çª„ÉÉ„Ç∑„Éß„É≥„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
    setTimeout(() => signOut(), 2000);
  },

  stop() {
    if (this.timeoutId) clearTimeout(this.timeoutId);
    if (this.warningId) clearTimeout(this.warningId);
    this.hideWarning();
  }
};

// ============================================
// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó‰∏¶„Å≥Êõø„Åà
// ============================================
let draggedProject = null;

function enableDragAndDrop() {
  // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç´„Éº„Éâ„Å´„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩÂ±ûÊÄß„ÇíËøΩÂä†
  const updateDraggable = () => {
    const cards = document.querySelectorAll('.project-card');
    cards.forEach((card, index) => {
      card.setAttribute('draggable', 'true');
      card.dataset.projectIndex = index;

      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragover', handleDragOver);
      card.addEventListener('drop', handleDrop);
      card.addEventListener('dragend', handleDragEnd);
    });
  };

  // ÂàùÂõû„Å®renderProjectsÂæå„Å´ÂÆüË°å
  updateDraggable();

  // MutationObserver„ÅßDOMÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
  const observer = new MutationObserver(updateDraggable);
  const container = document.getElementById('projectsContainer');
  if (container) {
    observer.observe(container, { childList: true, subtree: true });
  }
}

function handleDragStart(e) {
  draggedProject = this;
  this.style.opacity = '0.4';
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }

  if (draggedProject !== this) {
    const draggedIndex = parseInt(draggedProject.dataset.projectIndex);
    const targetIndex = parseInt(this.dataset.projectIndex);

    // ÈÖçÂàó„ÅÆÈ†ÜÂ∫è„ÇíÂÖ•„ÇåÊõø„Åà
    const temp = projects[draggedIndex];
    projects.splice(draggedIndex, 1);
    projects.splice(targetIndex, 0, temp);

    // ÂÜçÊèèÁîª
    renderProjects();
  }

  return false;
}

function handleDragEnd(e) {
  this.style.opacity = '1';

  // „Åô„Åπ„Å¶„ÅÆ„Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
  const cards = document.querySelectorAll('.project-card');
  cards.forEach(card => {
    card.classList.remove('over');
  });
}

// ============================================
// URLÁõ¥Êé•„Ç¢„ÇØ„Çª„ÇπÊ©üËÉΩÔºà„Éè„ÉÉ„Ç∑„É•„É´„Éº„ÉÜ„Ç£„É≥„Ç∞Ôºâ
// ============================================
function updateURLWithDesigner(designerName) {
  const currentHash = window.location.hash.substring(1); // #„ÇíÈô§Âéª
  const [pathPart] = currentHash.split('?');
  const mainTab = pathPart.split('/')[0] || 'projects';

  // Êñ∞„Åó„ÅÑURL„ÇíÊßãÁØâ
  let newHash = mainTab;
  if (designerName !== 'ALL') {
    newHash += `?designer=${encodeURIComponent(designerName)}`;
  }

  // hashchange„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´„Åï„Åõ„Åö„Å´URL„ÇíÊõ¥Êñ∞
  history.replaceState(null, '', `#${newHash}`);
}

function handleHashChange() {
  // ÁÑ°Èôê„É´„Éº„ÉóÈò≤Ê≠¢
  if (isHandlingHashChange) {
    console.log('‚è∏Ô∏è handleHashChange: „Åô„Åß„Å´Âá¶ÁêÜ‰∏≠„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
    return;
  }

  const hash = window.location.hash.substring(1); // #„ÇíÈô§Âéª
  console.log('üîó handleHashChange ÈñãÂßã:', {
    hash: hash,
    timestamp: new Date().toISOString(),
    vendorsV2Length: vendorsV2.length,
    taskVendorMappingsLength: taskVendorMappings.length
  });

  if (!hash) return;

  isHandlingHashChange = true;

  // URL„Éë„É©„É°„Éº„Çø„ÇíÂàÜÈõ¢Ôºà‰æã: projects?designer=ÁÆïÊµ¶Ôºâ
  const [pathPart, queryPart] = hash.split('?');
  const [mainTab, subTab] = pathPart.split('/');

  // URL„Éë„É©„É°„Éº„Çø„ÇíËß£Êûê
  const params = new URLSearchParams(queryPart || '');
  const designerParam = params.get('designer');

  // ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„Éº„ÇíÂæ©ÂÖÉ
  if (designerParam) {
    currentDesignerTab = designerParam;
    // „Çµ„Ç§„Éâ„Éê„Éº„Å®„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË°®Á§∫„ÇíÊõ¥Êñ∞Ôºà„Çø„ÉñÂàá„ÇäÊõø„ÅàÂæå„Å´ÂÆüË°åÔºâ
    setTimeout(() => {
      renderSidebar();
      if (mainTab === 'projects') {
        renderProjects();
      }
    }, 150);
  }

  // „É°„Ç§„É≥„Çø„Éñ„ÅÆÂàá„ÇäÊõø„Åà
  if (mainTab === 'projects') {
    const btn = document.querySelector('.tab-nav-btn');
    if (btn) switchMainTab('projects', btn);
  } else if (mainTab === 'settings') {
    const btn = document.querySelectorAll('.tab-nav-btn')[1];
    if (btn) switchMainTab('settings', btn);

    // „Çµ„Éñ„Çø„Éñ„ÅÆÂàá„ÇäÊõø„Åà
    if (subTab) {
      setTimeout(() => {
        const subTabMap = {
          'staff': 0,
          'vendors': 1,
          'categories': 2,
          'tasks': 3,
          'products': 4
        };
        const index = subTabMap[subTab];
        if (index !== undefined) {
          const subBtn = document.querySelectorAll('.sub-tab-btn')[index];
          if (subBtn) switchSubTab(subTab, subBtn);
        }
        // „Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„ÉàÔºàÈÅÖÂª∂ÂæåÔºâ
        setTimeout(() => {
          isHandlingHashChange = false;
          console.log('‚úÖ handleHashChangeÂÆå‰∫Ü');
        }, 150);
      }, 100);
    } else {
      // „Çµ„Éñ„Çø„Éñ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Åô„Åê„Å´„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
      setTimeout(() => {
        isHandlingHashChange = false;
        console.log('‚úÖ handleHashChangeÂÆå‰∫Ü');
      }, 150);
    }
  } else {
    // ‰∏çÊòé„Å™„Çø„Éñ„ÅÆÂ†¥Âêà„ÅØ„Åô„Åê„Å´„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
    isHandlingHashChange = false;
  }
}

// „Éè„ÉÉ„Ç∑„É•Â§âÊõ¥ÊôÇ„ÅÆ„É™„Çπ„Éä„Éº
window.addEventListener('hashchange', handleHashChange);

// ============================================
// ArchiDeck v3.0 Êñ∞Ê©üËÉΩ
// ============================================

// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ËøΩÂä†
let projectTasks = [];
let projectMinutes = [];
let kintoneSettings = null;
let currentTaskSort = 'due';

// Â§ñÊßãÊãÖÂΩì„ÅÆÂá¶ÁêÜ„ÇíËøΩÂä†
function getExteriorDesigners() {
  return designers.filter(d => d.category === 'Â§ñÊßã').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
}

// „Çµ„Ç§„Éâ„Éê„Éº„Å´Â§ñÊßãÊãÖÂΩì„Çª„ÇØ„Ç∑„Éß„É≥„ÇíËøΩÂä†ÔºàrenderSidebarÈñ¢Êï∞„ÅÆÊã°ÂºµÔºâ
const originalRenderSidebar = renderSidebar;
renderSidebar = function() {
  const container = document.getElementById('sidebarContent');
  if (!container) return;

  const sekkeiDesigners = designers.filter(d => d.category === 'Ë®≠Ë®à').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const icDesigners = designers.filter(d => d.category === 'IC').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const exteriorDesigners = designers.filter(d => d.category === 'Â§ñÊßã').sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
  const allCount = projects.filter(p => p.status !== 'completed' && !p.is_archived).length;

  let html = `
    <div class="sidebar-section">
      <div class="sidebar-item ${currentDesignerTab === 'ALL' ? 'active' : ''}" onclick="selectDesigner('ALL')">
        <span class="sidebar-item-label">ÂÖ®Ê°à‰ª∂</span>
        <span class="sidebar-item-count">${allCount}</span>
      </div>
    </div>
  `;

  // Ë®≠Ë®àÊãÖÂΩì„Çª„ÇØ„Ç∑„Éß„É≥ÔºàÁî≥Ë´ãGOÊï∞„ÅÆËâ≤ÂàÜ„Åë‰ªò„ÅçÔºâ
  if (sekkeiDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">üìê Ë®≠Ë®àÊãÖÂΩì</div>';
    sekkeiDesigners.forEach(designer => {
      const designerProjects = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const designerName = designer.name.trim();
        return assigned === designerName && p.status !== 'completed' && !p.is_archived;
      });
      const count = designerProjects.length;

      // Áî≥Ë´ãGOÊú™ÂÆå‰∫ÜÊï∞„Çí„Ç´„Ç¶„É≥„Éà
      const applicationNotDone = designerProjects.filter(p => {
        const progressData = p.progress || {};
        return !progressData['application']?.completed;
      }).length;

      // Ëâ≤ÂàÜ„Åë„É≠„Ç∏„ÉÉ„ÇØ
      let countClass = '';
      let nameClass = '';
      if (applicationNotDone >= 7) {
        nameClass = 'name-red';
        countClass = 'count-yellow';
      } else if (applicationNotDone >= 5) {
        countClass = 'count-yellow';
      } else if (applicationNotDone <= 4) {
        countClass = 'count-blue';
      }

      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label ${nameClass}">${designer.name}</span>
          <button class="sidebar-task-btn" onclick="event.stopPropagation(); openStaffTasksModal('${designer.name}')" title="„Çø„Çπ„ÇØ‰∏ÄË¶ß">üìã</button>
          <span class="sidebar-item-count ${countClass}">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  // ICÊãÖÂΩì„Çª„ÇØ„Ç∑„Éß„É≥ÔºàËâ≤ÂàÜ„Åë‰ªò„ÅçÔºâ
  if (icDesigners.length > 0) {
    html += '<div class="sidebar-section"><div class="sidebar-section-title">üé® ICÊãÖÂΩì</div>';
    icDesigners.forEach(designer => {
      const count = projects.filter(p => {
        const assigned = (p.assigned_to || '').trim();
        const icAssigned = (p.ic_assignee || '').trim();
        const designerName = designer.name.trim();
        return (assigned === designerName || icAssigned === designerName) && p.status !== 'completed' && !p.is_archived;
      }).length;

      // Ëâ≤ÂàÜ„Åë„É≠„Ç∏„ÉÉ„ÇØÔºàICÁî®Ôºâ
      let countClass = 'count-blue';
      let nameClass = '';
      if (count >= 7) {
        nameClass = 'name-red';
        countClass = 'count-yellow';
      } else if (count >= 5) {
        countClass = 'count-yellow';
      }

      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label ${nameClass}">${designer.name}</span>
          <button class="sidebar-task-btn" onclick="event.stopPropagation(); openStaffTasksModal('${designer.name}')" title="„Çø„Çπ„ÇØ‰∏ÄË¶ß">üìã</button>
          <span class="sidebar-item-count ${countClass}">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  // Â§ñÊßãÊãÖÂΩì„Çª„ÇØ„Ç∑„Éß„É≥ÔºàËâ≤ÂàÜ„Åë‰ªò„ÅçÔºâ
  if (exteriorDesigners.length > 0) {
    html += '<div class="sidebar-section sidebar-section-exterior"><div class="sidebar-section-title">üå≥ Â§ñÊßãÊãÖÂΩì</div>';
    exteriorDesigners.forEach(designer => {
      const count = projects.filter(p => {
        const exteriorAssigned = (p.exterior_assignee || '').trim();
        const designerName = designer.name.trim();
        return exteriorAssigned === designerName && p.status !== 'completed' && !p.is_archived;
      }).length;

      // Ëâ≤ÂàÜ„Åë„É≠„Ç∏„ÉÉ„ÇØÔºàÂ§ñÊßãÁî®Ôºâ
      let countClass = 'count-blue';
      let nameClass = '';
      if (count >= 7) {
        nameClass = 'name-red';
        countClass = 'count-yellow';
      } else if (count >= 5) {
        countClass = 'count-yellow';
      }

      html += `
        <div class="sidebar-item ${currentDesignerTab === designer.name ? 'active' : ''}" onclick="selectDesigner('${designer.name}')">
          <span class="sidebar-item-label ${nameClass}">${designer.name}</span>
          <button class="sidebar-task-btn" onclick="event.stopPropagation(); openStaffTasksModal('${designer.name}')" title="„Çø„Çπ„ÇØ‰∏ÄË¶ß">üìã</button>
          <span class="sidebar-item-count ${countClass}">${count}</span>
        </div>
      `;
    });
    html += '</div>';
  }

  container.innerHTML = html;
};

// ÊãÖÂΩìËÄÖ„Çø„Çπ„ÇØ‰∏ÄË¶ß„É¢„Éº„ÉÄ„É´
let currentStaffForTasks = null;

function openStaffTasksModal(staffName) {
  currentStaffForTasks = staffName;
  document.getElementById('staffTasksModalTitle').textContent = `${staffName} „ÅÆ„Çø„Çπ„ÇØ‰∏ÄË¶ß`;
  renderStaffTasksList();
  document.getElementById('staffTasksModal').classList.add('show');
}

function closeStaffTasksModal() {
  document.getElementById('staffTasksModal').classList.remove('show');
  currentStaffForTasks = null;
}

function sortTasksBy(sortType) {
  currentTaskSort = sortType;
  document.getElementById('sortByDueBtn').classList.toggle('btn-primary', sortType === 'due');
  document.getElementById('sortByDueBtn').classList.toggle('btn-ghost', sortType !== 'due');
  document.getElementById('sortByProjectBtn').classList.toggle('btn-primary', sortType === 'project');
  document.getElementById('sortByProjectBtn').classList.toggle('btn-ghost', sortType !== 'project');
  renderStaffTasksList();
}

async function renderStaffTasksList() {
  const container = document.getElementById('staffTasksList');
  if (!container || !currentStaffForTasks) return;

  // ÊãÖÂΩìËÄÖ„ÅÆÊ°à‰ª∂„ÇíÂèñÂæó
  const staffProjects = projects.filter(p => {
    const assigned = (p.assigned_to || '').trim();
    const icAssigned = (p.ic_assignee || '').trim();
    const exteriorAssigned = (p.exterior_assignee || '').trim();
    return (assigned === currentStaffForTasks || icAssigned === currentStaffForTasks || exteriorAssigned === currentStaffForTasks) &&
           p.status !== 'completed' && !p.is_archived;
  });

  // project_tasks„Åã„Çâ„Çø„Çπ„ÇØ„ÇíÂèñÂæó
  const { data: tasks } = await supabase
    .from('project_tasks')
    .select('*')
    .in('project_id', staffProjects.map(p => p.id))
    .eq('is_completed', false)
    .order('due_date');

  if (!tasks || tasks.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>Êú™ÂÆå‰∫Ü„ÅÆ„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>';
    return;
  }

  // „ÇΩ„Éº„Éà
  let sortedTasks = [...tasks];
  if (currentTaskSort === 'due') {
    sortedTasks.sort((a, b) => {
      if (!a.due_date) return 1;
      if (!b.due_date) return -1;
      return new Date(a.due_date) - new Date(b.due_date);
    });
  } else {
    sortedTasks.sort((a, b) => {
      const projectA = staffProjects.find(p => p.id === a.project_id);
      const projectB = staffProjects.find(p => p.id === b.project_id);
      return (projectA?.customer || '').localeCompare(projectB?.customer || '');
    });
  }

  // Ë°®Á§∫
  let html = '';
  const today = new Date().toISOString().split('T')[0];

  if (currentTaskSort === 'project') {
    // ÈÇ∏Âêç„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
    const grouped = {};
    sortedTasks.forEach(task => {
      const project = staffProjects.find(p => p.id === task.project_id);
      const key = project?.customer || '‰∏çÊòé';
      if (!grouped[key]) grouped[key] = [];
      grouped[key].push(task);
    });

    for (const [customer, customerTasks] of Object.entries(grouped)) {
      html += `<div class="task-list-group"><div class="task-list-group-title">${customer}</div>`;
      customerTasks.forEach(task => {
        const isOverdue = task.due_date && task.due_date < today;
        html += `
          <div class="project-task-item">
            <input type="checkbox" class="project-task-checkbox" onchange="toggleProjectTask('${task.id}', this.checked)">
            <span class="project-task-name">${task.task_name}</span>
            ${task.due_date ? `<span class="project-task-due ${isOverdue ? 'overdue' : ''}">${task.due_date}</span>` : ''}
          </div>
        `;
      });
      html += '</div>';
    }
  } else {
    // ÊúüÈôêÈ†Ü
    sortedTasks.forEach(task => {
      const project = staffProjects.find(p => p.id === task.project_id);
      const isOverdue = task.due_date && task.due_date < today;
      html += `
        <div class="project-task-item">
          <input type="checkbox" class="project-task-checkbox" onchange="toggleProjectTask('${task.id}', this.checked)">
          <span class="project-task-name">${task.task_name}</span>
          <span style="font-size: 12px; color: var(--text-muted);">${project?.customer || ''}</span>
          ${task.due_date ? `<span class="project-task-due ${isOverdue ? 'overdue' : ''}">${task.due_date}</span>` : ''}
        </div>
      `;
    });
  }

  container.innerHTML = html;
}

// „Çø„Çπ„ÇØÂÆå‰∫ÜÂàá„ÇäÊõø„Åà
async function toggleProjectTask(taskId, completed) {
  const { error } = await supabase
    .from('project_tasks')
    .update({ is_completed: completed, updated_at: new Date().toISOString() })
    .eq('id', taskId);

  if (error) {
    showToast('„Çø„Çπ„ÇØÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return;
  }

  renderStaffTasksList();
  renderProjects();
}

// Ê°à‰ª∂„Çø„Çπ„ÇØ‰∏ÄË¶ßË™≠„ÅøËæº„Åø
async function loadProjectTasksList(projectId) {
  const container = document.getElementById(`projectTasksList_${projectId}`);
  if (!container) return;

  try {
    const { data: tasks, error } = await supabase
      .from('project_tasks')
      .select('*')
      .eq('project_id', projectId)
      .order('due_date', { ascending: true, nullsFirst: false });

    if (error) {
      console.error('Load tasks error:', error);
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">„Çø„Çπ„ÇØ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
      return;
    }

    if (!tasks || tasks.length === 0) {
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      return;
    }

    container.innerHTML = tasks.map(t => `
      <div class="task-item" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: ${t.is_completed ? 'var(--success-light)' : 'var(--bg-secondary)'}; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${t.is_completed ? 'var(--success-color)' : 'var(--primary-color)'};">
        <input type="checkbox" ${t.is_completed ? 'checked' : ''} onchange="toggleProjectTask('${t.id}', '${projectId}', this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
        <div style="flex: 1; min-width: 0;">
          <div style="font-size: 13px; font-weight: 500; ${t.is_completed ? 'text-decoration: line-through; color: var(--text-muted);' : ''}">${escapeHtml(t.task_name)}</div>
          ${t.due_date ? `<div style="font-size: 11px; color: ${isOverdue(t.due_date) && !t.is_completed ? 'var(--danger-color)' : 'var(--text-muted)'}; margin-top: 2px;">ÊúüÈôê: ${formatDate(t.due_date)}</div>` : ''}
        </div>
        <button class="btn btn-small btn-ghost" onclick="deleteProjectTask('${t.id}', '${projectId}')" style="flex-shrink: 0; padding: 4px 8px; font-size: 12px; color: var(--danger-color);">ÂâäÈô§</button>
      </div>
    `).join('');
  } catch (error) {
    console.error('Load tasks error:', error);
    container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">„Çø„Çπ„ÇØ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
  }
}

// ÊúüÈôêÂàá„Çå„ÉÅ„Çß„ÉÉ„ÇØ
function isOverdue(dateStr) {
  if (!dateStr) return false;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const dueDate = new Date(dateStr);
  return dueDate < today;
}

// „Çø„Çπ„ÇØÂÆå‰∫ÜÁä∂ÊÖã„ÇíÂàá„ÇäÊõø„Åà
async function toggleProjectTask(taskId, projectId, isCompleted) {
  const { error } = await supabase
    .from('project_tasks')
    .update({ is_completed: isCompleted, updated_at: new Date().toISOString() })
    .eq('id', taskId);

  if (error) {
    showToast('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return;
  }

  await loadProjectTasksList(projectId);
}

// „Çø„Çπ„ÇØÂâäÈô§
async function deleteProjectTask(taskId, projectId) {
  if (!confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  const { error } = await supabase
    .from('project_tasks')
    .delete()
    .eq('id', taskId);

  if (error) {
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return;
  }

  showToast('„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
  await loadProjectTasksList(projectId);
}

// Ê°à‰ª∂„Å´„Çø„Çπ„ÇØ„ÇíËøΩÂä†
async function addProjectTask(projectId, taskName, dueDate) {
  if (!taskName.trim()) {
    showToast('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  const project = projects.find(p => p.id === projectId);

  try {
    const { data, error } = await supabase
      .from('project_tasks')
      .insert({
        project_id: projectId,
        task_name: taskName.trim(),
        due_date: dueDate || null,
        assigned_to: project?.assigned_to || '',
        is_completed: false
      })
      .select();

    if (error) {
      console.error('„Çø„Çπ„ÇØËøΩÂä†„Ç®„É©„Éº:', error);
      if (error.code === '42501') {
        showToast('„Çø„Çπ„ÇØËøΩÂä†„ÅÆÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´ÈÄ£Áµ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      } else if (error.code === '42P01') {
        showToast('„Çø„Çπ„ÇØ„ÉÜ„Éº„Éñ„É´„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì„ÄÇ„Éá„Éº„Çø„Éô„Éº„Çπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      } else {
        showToast(`„Çø„Çπ„ÇØËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`, 'error');
      }
      return;
    }

    // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
    document.getElementById(`newTaskName_${projectId}`).value = '';
    document.getElementById(`newTaskDue_${projectId}`).value = '';

    showToast('„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
    await loadProjectTasksList(projectId);
  } catch (err) {
    console.error('„Çø„Çπ„ÇØËøΩÂä†‰æãÂ§ñ:', err);
    showToast('„Çø„Çπ„ÇØËøΩÂä†‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
  }
}

// Áî≥Ë´ãGOÊù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
function canPressApplicationGo(project) {
  const progressData = project.progress || {};

  // Êù°‰ª∂: Â§™ÈôΩÂÖâ‰æùÈ†º„ÅåÂñ∂Ê•≠ÂÖ±ÊúâÊ∏à„ÄÅÁµ¶ÊéíÊ∞¥Âõ≥‰æùÈ†º„Åå‰øùÂ≠òÊ∏à„ÄÅÊèõÊ∞óÂõ≥‰æùÈ†º„Åå‰øùÂ≠òÊ∏à„ÄÅ„Çµ„ÉÉ„Ç∑‰æùÈ†º„Åå‰øùÂ≠òÊ∏à
  const solarOk = progressData['solar']?.state === 'Âñ∂Ê•≠ÂÖ±ÊúâÊ∏à';
  const plumbingOk = progressData['plumbing']?.state === '‰øùÂ≠òÊ∏à';
  const ventilationOk = progressData['ventilation']?.state === '‰øùÂ≠òÊ∏à';
  const sashOk = progressData['sash']?.state === '‰øùÂ≠òÊ∏à';

  return solarOk && plumbingOk && ventilationOk && sashOk;
}

// Êäò„Çä„Åü„Åü„ÅøÊ©üËÉΩ
function toggleCardSection(element) {
  const section = element.closest('.card-section');
  section.classList.toggle('collapsed');
}

// „É¢„Éê„Ç§„É´„Çµ„Ç§„Éâ„Éê„ÉºÈñãÈñâ
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
}

function closeSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
}

// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÈñ¢Êï∞
function handleDragOver(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.add('drag-over');
}

function handleDragLeave(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');
}

function handleDrop(event, projectId) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');

  const files = event.dataTransfer.files;
  if (files.length > 0) {
    uploadMinutes(projectId, files[0]);
  }
}

// ÊâìÂêà„ÅõÊó•‰ªò„Åç„Éâ„É≠„ÉÉ„Éó
function handleDropWithDate(event, projectId) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');

  const files = event.dataTransfer.files;
  if (files.length > 0) {
    uploadMinutesWithDate(projectId, files[0]);
  }
}

// „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Éà„É™„Ç¨„Éº
function triggerMinutesUpload(projectId) {
  document.getElementById(`minutesUpload_${projectId}`).click();
}

// ÊâìÂêà„ÅõÊó•„ÉªÊ°à‰ª∂Âêç„ÉªÊãÖÂΩìËÄÖ„ÇíÂê´„ÇÄË≠∞‰∫ãÈå≤„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
async function uploadMinutesWithDate(projectId, file) {
  if (!file) {
    showToast('„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  const project = projects.find(p => p.id === projectId);
  if (!project) {
    showToast('Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  // ÊâìÂêà„ÅõÊó•„ÇíÂèñÂæó
  const meetingDateInput = document.getElementById(`meetingDate_${projectId}`);
  const meetingDate = meetingDateInput?.value;

  if (!meetingDate) {
    showToast('ÊâìÂêà„ÅõÊó•„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà10MB‰∏äÈôêÔºâ
  const maxSize = 10 * 1024 * 1024;
  if (file.size > maxSize) {
    showToast('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅØ10MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  // ÂØæÂøú„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØ
  const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
  if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx|xls|xlsx)$/i)) {
    showToast('PDF, Word, Excel„Éï„Ç°„Ç§„É´„ÅÆ„ÅøÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åô', 'error');
    return;
  }

  // „Çø„Ç§„Éà„É´Ëá™ÂãïÁîüÊàê: ÊâìÂêà„ÅõÊó•_Ê°à‰ª∂Âêç_ÊãÖÂΩìËÄÖ
  const formattedDate = meetingDate.replace(/-/g, '');
  const customerName = project.customer || '‰∏çÊòé';
  const assignee = project.assigned_to || 'ÊãÖÂΩìÊú™ÂÆö';
  const ext = file.name.split('.').pop();
  const autoTitle = `${formattedDate}_${customerName}_${assignee}.${ext}`;

  showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...', 'info');

  try {
    // Supabase Storage„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
    const fileName = `${projectId}/${Date.now()}_${autoTitle}`;
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('minutes')
      .upload(fileName, file);

    if (uploadError) {
      console.error('Storage upload error:', uploadError);
      if (uploadError.message?.includes('bucket') || uploadError.statusCode === '404') {
        showToast('„Çπ„Éà„É¨„Éº„Ç∏„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´ÈÄ£Áµ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      } else if (uploadError.message?.includes('policy')) {
        showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
      } else {
        showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (uploadError.message || 'Unknown error'), 'error');
      }
      return;
    }

    // URL„ÇíÂèñÂæó
    const { data: urlData } = supabase.storage
      .from('minutes')
      .getPublicUrl(fileName);

    // DB„Å´ÁôªÈå≤Ôºà„Çø„Ç§„Éà„É´„ÇíËá™ÂãïÁîüÊàê„Åó„Åü„ÇÇ„ÅÆ„Å´Ôºâ
    const { error: dbError } = await supabase
      .from('project_minutes')
      .insert({
        project_id: projectId,
        file_name: autoTitle,
        file_url: urlData.publicUrl,
        file_size: file.size,
        uploaded_by: currentUser?.email || 'demo@archideck.jp'
      });

    if (dbError) {
      console.error('DB insert error:', dbError);
      showToast('Ë≠∞‰∫ãÈå≤ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (dbError.message || 'Unknown error'), 'error');
      return;
    }

    // ÈÄöÁü•„ÇíÈÄÅ‰ø°
    const notifyEmails = [];
    if (project.assigned_to) {
      const designer = designers.find(d => d.name === project.assigned_to);
      if (designer?.email) notifyEmails.push(designer.email);
    }
    if (project.ic_assignee) {
      const icDesigner = designers.find(d => d.name === project.ic_assignee);
      if (icDesigner?.email) notifyEmails.push(icDesigner.email);
    }
    if (project.exterior_assignee) {
      const extDesigner = designers.find(d => d.name === project.exterior_assignee);
      if (extDesigner?.email) notifyEmails.push(extDesigner.email);
    }

    for (const email of notifyEmails) {
      await supabase.from('notifications').insert({
        user_email: email,
        title: 'Êñ∞„Åó„ÅÑË≠∞‰∫ãÈå≤„Åå„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü',
        message: `${project.customer}Êßò„ÅÆË≠∞‰∫ãÈå≤„Äå${autoTitle}„Äç„Åå„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü`,
        link: `#projects?id=${projectId}`
      }).catch(() => {});
    }

    // ÊâìÂêà„ÅõÊó•ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
    meetingDateInput.value = '';

    showToast('Ë≠∞‰∫ãÈå≤„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
    await loadMinutesList(projectId);
  } catch (error) {
    console.error('Upload error:', error);
    showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
}

// ÂÖ±Êúâ„É°„É¢‰øùÂ≠ò
async function saveSharedMemo(projectId) {
  const memo = document.getElementById(`sharedMemo_${projectId}`).value;
  const { error } = await supabase
    .from('projects')
    .update({ shared_memo: memo, updated_at: new Date().toISOString() })
    .eq('id', projectId);

  if (error) {
    showToast('„É°„É¢‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return;
  }

  const project = projects.find(p => p.id === projectId);
  if (project) project.shared_memo = memo;
  showToast('„É°„É¢„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

// ÂºïÁ∂ôÊõ∏‰øùÂ≠ò
async function saveHandover(projectId) {
  const content = document.getElementById(`handover_${projectId}`).value;

  // Êó¢Â≠ò„ÅÆÂºïÁ∂ôÊõ∏„ÇíÁ¢∫Ë™ç
  const { data: existing } = await supabase
    .from('project_handovers')
    .select('id')
    .eq('project_id', projectId)
    .single();

  let error;
  if (existing) {
    ({ error } = await supabase
      .from('project_handovers')
      .update({ content, updated_at: new Date().toISOString() })
      .eq('id', existing.id));
  } else {
    ({ error } = await supabase
      .from('project_handovers')
      .insert({ project_id: projectId, content }));
  }

  if (error) {
    showToast('ÂºïÁ∂ôÊõ∏‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return;
  }

  showToast('ÂºïÁ∂ôÊõ∏„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

// Ë≠∞‰∫ãÈå≤„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
async function uploadMinutes(projectId, file) {
  if (!file) {
    showToast('„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà10MB‰∏äÈôêÔºâ
  const maxSize = 10 * 1024 * 1024;
  if (file.size > maxSize) {
    showToast('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅØ10MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  // ÂØæÂøú„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØ
  const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
  if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx|xls|xlsx)$/i)) {
    showToast('PDF, Word, Excel„Éï„Ç°„Ç§„É´„ÅÆ„ÅøÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åô', 'error');
    return;
  }

  showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...', 'info');

  try {
    // Supabase Storage„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
    const fileName = `${projectId}/${Date.now()}_${file.name}`;
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('minutes')
      .upload(fileName, file);

    if (uploadError) {
      console.error('Storage upload error:', uploadError);
      // „Éê„Ç±„ÉÉ„Éà„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅÆ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
      if (uploadError.message?.includes('bucket') || uploadError.statusCode === '404') {
        showToast('„Çπ„Éà„É¨„Éº„Ç∏„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´ÈÄ£Áµ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
      } else if (uploadError.message?.includes('policy')) {
        showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
      } else {
        showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (uploadError.message || 'Unknown error'), 'error');
      }
      return;
    }

    // URL„ÇíÂèñÂæó
    const { data: urlData } = supabase.storage
      .from('minutes')
      .getPublicUrl(fileName);

    // DB„Å´ÁôªÈå≤
    const { error: dbError } = await supabase
      .from('project_minutes')
      .insert({
        project_id: projectId,
        file_name: file.name,
        file_url: urlData.publicUrl,
        file_size: file.size,
        uploaded_by: currentUser?.email || 'demo@archideck.jp'
      });

    if (dbError) {
      console.error('DB insert error:', dbError);
      showToast('Ë≠∞‰∫ãÈå≤ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (dbError.message || 'Unknown error'), 'error');
      return;
    }

    // ÈÄöÁü•„ÇíÈÄÅ‰ø°
    const project = projects.find(p => p.id === projectId);
    if (project) {
      const notifyEmails = [];
      if (project.assigned_to) {
        const designer = designers.find(d => d.name === project.assigned_to);
        if (designer?.email) notifyEmails.push(designer.email);
      }
      if (project.ic_assignee) {
        const icDesigner = designers.find(d => d.name === project.ic_assignee);
        if (icDesigner?.email) notifyEmails.push(icDesigner.email);
      }
      if (project.exterior_assignee) {
        const extDesigner = designers.find(d => d.name === project.exterior_assignee);
        if (extDesigner?.email) notifyEmails.push(extDesigner.email);
      }

      // ÈÄöÁü•„ÇíDB„Å´ÁôªÈå≤Ôºà„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñÔºâ
      for (const email of notifyEmails) {
        await supabase.from('notifications').insert({
          user_email: email,
          title: 'Êñ∞„Åó„ÅÑË≠∞‰∫ãÈå≤„Åå„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü',
          message: `${project.customer}Êßò„ÅÆË≠∞‰∫ãÈå≤„Äå${file.name}„Äç„Åå„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü`,
          link: `#projects?id=${projectId}`
        }).catch(() => {});
      }
    }

    showToast('Ë≠∞‰∫ãÈå≤„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
    await loadMinutesList(projectId);
  } catch (error) {
    console.error('Upload error:', error);
    showToast('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
}

// Ë≠∞‰∫ãÈå≤‰∏ÄË¶ßË™≠„ÅøËæº„Åø
async function loadMinutesList(projectId) {
  const container = document.getElementById(`minutesList_${projectId}`);
  if (!container) return;

  try {
    const { data: minutes, error } = await supabase
      .from('project_minutes')
      .select('*')
      .eq('project_id', projectId)
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Load minutes error:', error);
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">Ë≠∞‰∫ãÈå≤„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
      return;
    }

    if (!minutes || minutes.length === 0) {
      container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„ÅüË≠∞‰∫ãÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      return;
    }

    container.innerHTML = minutes.map(m => `
      <div class="minute-item" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 8px;">
        <div style="flex: 1; min-width: 0;">
          <a href="${m.file_url}" target="_blank" style="color: var(--primary-color); text-decoration: none; font-size: 13px; font-weight: 500; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            üìÑ ${escapeHtml(m.file_name)}
          </a>
          <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
            ${formatFileSize(m.file_size)} ‚Ä¢ ${formatDate(m.created_at)}
          </div>
        </div>
        <button class="btn btn-small btn-ghost" onclick="deleteMinute('${m.id}', '${projectId}')" style="flex-shrink: 0; padding: 4px 8px; font-size: 12px; color: var(--danger-color);">ÂâäÈô§</button>
      </div>
    `).join('');
  } catch (error) {
    console.error('Load minutes error:', error);
    container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">Ë≠∞‰∫ãÈå≤„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
  }
}

// Ë≠∞‰∫ãÈå≤ÂâäÈô§
async function deleteMinute(minuteId, projectId) {
  if (!confirm('„Åì„ÅÆË≠∞‰∫ãÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

  try {
    const { error } = await supabase
      .from('project_minutes')
      .delete()
      .eq('id', minuteId);

    if (error) throw error;
    showToast('Ë≠∞‰∫ãÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
    await loadMinutesList(projectId);
  } catch (error) {
    console.error('Delete minute error:', error);
    showToast('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
}

// „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„Éï„Ç©„Éº„Éû„ÉÉ„Éà
function formatFileSize(bytes) {
  if (!bytes) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„Éà
function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
}

// HTML„Ç®„Çπ„Ç±„Éº„Éó
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

// ============================================
// „Éê„É™„Éá„Éº„Ç∑„Éß„É≥Èñ¢Êï∞
// ============================================
const Validators = {
  // „É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÊ§úË®º
  isValidEmail(email) {
    if (!email) return false;
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  },

  // „Éë„Çπ„ÉØ„Éº„ÉâÊ§úË®ºÔºà8ÊñáÂ≠ó‰ª•‰∏ä„ÄÅËã±Êï∞Â≠óÊ∑∑Âú®Ôºâ
  isValidPassword(password) {
    if (!password || password.length < 8) return false;
    return /^(?=.*[a-zA-Z])(?=.*\d).{8,}$/.test(password);
  },

  // ÈõªË©±Áï™Âè∑Ê§úË®º
  isValidPhone(phone) {
    if (!phone) return true; // ‰ªªÊÑè„Éï„Ç£„Éº„É´„Éâ
    return /^[\d\-\+\(\)\s]{10,}$/.test(phone);
  },

  // Êó•‰ªò„ÅåÈÅéÂéª„Åß„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  isNotPastDate(dateStr) {
    if (!dateStr) return true;
    const inputDate = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return inputDate >= today;
  },

  // Êó•‰ªò„ÅåÊúâÂäπ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  isValidDate(dateStr) {
    if (!dateStr) return true;
    const date = new Date(dateStr);
    return !isNaN(date.getTime());
  },

  // ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
  isRequired(value) {
    if (value === null || value === undefined) return false;
    if (typeof value === 'string') return value.trim().length > 0;
    return true;
  },

  // ÊñáÂ≠óÊï∞Âà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ
  maxLength(value, max) {
    if (!value) return true;
    return String(value).length <= max;
  },

  // Êï∞ÂÄ§ÁØÑÂõ≤„ÉÅ„Çß„ÉÉ„ÇØ
  inRange(value, min, max) {
    const num = Number(value);
    if (isNaN(num)) return false;
    return num >= min && num <= max;
  }
};

// „Éï„Ç©„Éº„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÁµêÊûú
function validateForm(rules) {
  const errors = [];
  for (const [fieldName, validations] of Object.entries(rules)) {
    for (const { validate, message, value } of validations) {
      if (!validate(value)) {
        errors.push({ field: fieldName, message });
      }
    }
  }
  return errors;
}

// ============================================
// „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
// ============================================
const ErrorHandler = {
  // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞
  messages: {
    'Invalid login credentials': '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì',
    'Email not confirmed': '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆÁ¢∫Ë™ç„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì',
    'User already registered': '„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô',
    'Password should be at least': '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ8ÊñáÂ≠ó‰ª•‰∏ä„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
    'Network error': '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
    'timeout': '„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ',
    'duplicate key': '„Åì„ÅÆ„Éá„Éº„Çø„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô',
    'foreign key constraint': 'Èñ¢ÈÄ£„Åô„Çã„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åô„Çã„Åü„ÇÅÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì',
    'permission denied': '„Åì„ÅÆÊìç‰Ωú„ÇíË°å„ÅÜÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
  },

  // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂ§âÊèõ
  getUserMessage(error) {
    if (!error) return '‰∫àÊúü„Åõ„Å¨„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';

    const errorMsg = error.message || String(error);

    // „Éû„ÉÉ„Éî„É≥„Ç∞„Åã„ÇâÊ§úÁ¥¢
    for (const [key, userMsg] of Object.entries(this.messages)) {
      if (errorMsg.toLowerCase().includes(key.toLowerCase())) {
        return userMsg;
      }
    }

    // Supabase„Ç®„É©„Éº„Ç≥„Éº„ÉâÂØæÂøú
    if (error.code === 'PGRST116') return '„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
    if (error.code === '23505') return '„Åì„ÅÆ„Éá„Éº„Çø„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô';
    if (error.code === '23503') return 'Èñ¢ÈÄ£„Åô„Çã„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì';
    if (error.code === '42501') return '„Åì„ÅÆÊìç‰Ωú„ÇíË°å„ÅÜÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';

    // „Éá„Éï„Ç©„É´„Éà„É°„ÉÉ„Çª„Éº„Ç∏
    return '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
  },

  // „Ç®„É©„Éº„Çí„É≠„Ç∞ÔºÜÈÄöÁü•
  handle(error, context = '') {
    console.error(`‚ùå „Ç®„É©„Éº [${context}]:`, error);

    const userMessage = this.getUserMessage(error);
    showToast(userMessage, 'error');

    // Êú¨Áï™Áí∞Â¢É„Åß„ÅØ„Ç®„É©„Éº„É≠„Ç∞„ÇíÈÄÅ‰ø°ÔºàÂ∞ÜÊù•ÂÆüË£ÖÔºâ
    // this.sendErrorLog(error, context);
  }
};

// ============================================
// „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
// ============================================
function showSkeletonLoading(containerId, type = 'card') {
  const container = document.getElementById(containerId);
  if (!container) return;

  const skeletons = {
    card: `
      <div class="skeleton-card animate-pulse">
        <div class="skeleton-line" style="width: 60%; height: 20px; margin-bottom: 12px;"></div>
        <div class="skeleton-line" style="width: 80%; height: 14px; margin-bottom: 8px;"></div>
        <div class="skeleton-line" style="width: 40%; height: 14px;"></div>
      </div>
    `,
    list: `
      <div class="skeleton-list animate-pulse">
        ${Array(5).fill().map(() => `
          <div class="skeleton-item" style="display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
            <div class="skeleton-circle" style="width: 40px; height: 40px; border-radius: 50%;"></div>
            <div style="flex: 1;">
              <div class="skeleton-line" style="width: 50%; height: 16px; margin-bottom: 8px;"></div>
              <div class="skeleton-line" style="width: 30%; height: 12px;"></div>
            </div>
          </div>
        `).join('')}
      </div>
    `,
    table: `
      <div class="skeleton-table animate-pulse">
        ${Array(5).fill().map(() => `
          <div style="display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid var(--border-color);">
            <div class="skeleton-line" style="width: 20%; height: 14px;"></div>
            <div class="skeleton-line" style="width: 30%; height: 14px;"></div>
            <div class="skeleton-line" style="width: 25%; height: 14px;"></div>
            <div class="skeleton-line" style="width: 15%; height: 14px;"></div>
          </div>
        `).join('')}
      </div>
    `
  };

  container.innerHTML = skeletons[type] || skeletons.card;
}

function hideSkeletonLoading(containerId) {
  const container = document.getElementById(containerId);
  if (container) {
    container.innerHTML = '';
  }
}

// ============================================
// ÂàÜÊûê„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊ©üËÉΩ
// ============================================
let ganttCurrentMonth = new Date();

function updateAnalyticsDashboard() {
  updateKPIs();
  updatePredictions();
  updateGanttChart();
  updatePerformanceTable();
}

function updateKPIs() {
  const total = projects.length;
  const completed = projects.filter(p => p.is_archived).length;
  const atRisk = projects.filter(p => {
    if (p.is_archived) return false;
    const progress = calculateProgress(p);
    if (progress >= 80 && !p.progress?.application?.completed) return true;
    if (!p.assigned_to) return true;
    return false;
  }).length;

  const avgProgress = total > 0
    ? Math.round(projects.filter(p => !p.is_archived).reduce((sum, p) => sum + calculateProgress(p), 0) / Math.max(1, total - completed))
    : 0;

  document.getElementById('kpiTotalProjects').textContent = total;
  document.getElementById('kpiCompletedProjects').textContent = completed;
  document.getElementById('kpiAtRiskProjects').textContent = atRisk;
  document.getElementById('kpiAvgProgress').textContent = avgProgress + '%';
}

function updatePredictions() {
  const activeProjects = projects.filter(p => !p.is_archived);
  const delayRisks = [];
  const recommendations = [];

  activeProjects.forEach(p => {
    const progress = calculateProgress(p);
    const progressData = p.progress || {};

    // ÈÅÖÂª∂„É™„Çπ„ÇØÂà§ÂÆö
    if (progress < 30 && p.construction_start_date) {
      const daysUntil = Math.ceil((new Date(p.construction_start_date) - new Date()) / (1000*60*60*24));
      if (daysUntil < 60) {
        delayRisks.push({ project: p, risk: 'high', message: `ÁùÄÂ∑•${daysUntil}Êó•Ââç„ÅßÈÄ≤Êçó${progress}%` });
      }
    }

    if (progress >= 50 && !progressData['layout_confirmed']?.completed) {
      delayRisks.push({ project: p, risk: 'medium', message: 'ÈñìÂèñÁ¢∫ÂÆö„ÅåÊú™ÂÆå‰∫Ü' });
    }

    // Êé®Â•®„Ç¢„ÇØ„Ç∑„Éß„É≥
    if (!p.assigned_to) {
      recommendations.push(`${p.customer}: ÊãÖÂΩìËÄÖ„ÇíÂâ≤„ÇäÂΩì„Å¶„Å¶„Åè„Å†„Åï„ÅÑ`);
    }
    if (progress >= 70 && !progressData['application']?.completed) {
      recommendations.push(`${p.customer}: Áî≥Ë´ãGOÊ∫ñÂÇô„ÇíÈÄ≤„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ`);
    }
  });

  const delayContent = document.getElementById('delayRiskContent');
  if (delayRisks.length === 0) {
    delayContent.innerHTML = '<div style="color: var(--success-color);">‚úÖ ÈÅÖÂª∂„É™„Çπ„ÇØ„ÅÆ„ÅÇ„ÇãÊ°à‰ª∂„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
  } else {
    delayContent.innerHTML = delayRisks.slice(0, 5).map(r => `
      <div class="prediction-item risk-${r.risk}">
        <strong>${r.project.customer}</strong>: ${r.message}
      </div>
    `).join('');
  }

  const recContent = document.getElementById('recommendedActions');
  if (recommendations.length === 0) {
    recContent.innerHTML = '<div style="color: var(--success-color);">‚úÖ Áâπ„Å´Êé®Â•®„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
  } else {
    recContent.innerHTML = recommendations.slice(0, 5).map(r => `
      <div class="prediction-item risk-low">üìå ${r}</div>
    `).join('');
  }
}

function updateGanttChart() {
  const container = document.getElementById('ganttChart');
  const label = document.getElementById('ganttMonthLabel');

  const year = ganttCurrentMonth.getFullYear();
  const month = ganttCurrentMonth.getMonth();
  label.textContent = `${year}Âπ¥${month + 1}Êúà`;

  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date();

  const activeProjects = projects.filter(p => !p.is_archived).slice(0, 15);

  let html = '<table class="gantt-table"><thead><tr><th>Ê°à‰ª∂Âêç</th>';
  for (let d = 1; d <= daysInMonth; d++) {
    const isToday = year === today.getFullYear() && month === today.getMonth() && d === today.getDate();
    html += `<th class="${isToday ? 'gantt-today' : ''}">${d}</th>`;
  }
  html += '</tr></thead><tbody>';

  activeProjects.forEach(p => {
    html += `<tr><td>${p.customer}</td>`;
    const progress = calculateProgress(p);
    const progressDays = Math.ceil(daysInMonth * progress / 100);

    for (let d = 1; d <= daysInMonth; d++) {
      const isToday = year === today.getFullYear() && month === today.getMonth() && d === today.getDate();
      if (d <= progressDays) {
        html += `<td class="${isToday ? 'gantt-today' : ''}"><div style="background: var(--primary-color); height: 20px; border-radius: 3px;"></div></td>`;
      } else {
        html += `<td class="${isToday ? 'gantt-today' : ''}"><div style="background: var(--bg-tertiary); height: 20px; border-radius: 3px;"></div></td>`;
      }
    }
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

function ganttPrevMonth() {
  ganttCurrentMonth.setMonth(ganttCurrentMonth.getMonth() - 1);
  updateGanttChart();
}

function ganttNextMonth() {
  ganttCurrentMonth.setMonth(ganttCurrentMonth.getMonth() + 1);
  updateGanttChart();
}

function updatePerformanceTable() {
  const tbody = document.getElementById('performanceTableBody');
  const designerStats = {};

  designers.filter(d => d.category === 'Ë®≠Ë®à').forEach(d => {
    designerStats[d.name] = { total: 0, completed: 0, progressSum: 0 };
  });

  projects.forEach(p => {
    if (p.assigned_to && designerStats[p.assigned_to]) {
      designerStats[p.assigned_to].total++;
      if (p.is_archived) designerStats[p.assigned_to].completed++;
      designerStats[p.assigned_to].progressSum += calculateProgress(p);
    }
  });

  tbody.innerHTML = Object.entries(designerStats).map(([name, stats]) => {
    const avgProgress = stats.total > 0 ? Math.round(stats.progressSum / stats.total) : 0;
    const completionRate = stats.total > 0 ? Math.round(stats.completed / stats.total * 100) : 0;
    return `<tr>
      <td><strong>${name}</strong></td>
      <td>${stats.total}‰ª∂</td>
      <td>${stats.completed}‰ª∂</td>
      <td>${avgProgress}%</td>
      <td><span class="badge ${completionRate >= 50 ? 'badge-success' : 'badge-warning'}">${completionRate}%</span></td>
    </tr>`;
  }).join('');
}

function generateWeeklyReport() {
  const today = new Date();
  const weekAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);

  const activeProjects = projects.filter(p => !p.is_archived);
  const completedThisWeek = projects.filter(p => {
    if (!p.is_archived) return false;
    const updated = new Date(p.updated_at);
    return updated >= weekAgo;
  });

  const avgProgress = activeProjects.length > 0
    ? Math.round(activeProjects.reduce((sum, p) => sum + calculateProgress(p), 0) / activeProjects.length)
    : 0;

  const atRisk = activeProjects.filter(p => !p.assigned_to || calculateProgress(p) < 30).length;

  const report = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä ArchiDeck ÈÄ±Â†±
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ÊúüÈñì: ${weekAgo.toLocaleDateString('ja-JP')} „Äú ${today.toLocaleDateString('ja-JP')}

„Äê„Çµ„Éû„É™„Éº„Äë
„ÉªÁ∑èÊ°à‰ª∂Êï∞: ${projects.length}‰ª∂
„ÉªÈÄ≤Ë°å‰∏≠: ${activeProjects.length}‰ª∂
„Éª‰ªäÈÄ±ÂÆå‰∫Ü: ${completedThisWeek.length}‰ª∂
„ÉªÂπ≥ÂùáÈÄ≤ÊçóÁéá: ${avgProgress}%
„ÉªË¶ÅÊ≥®ÊÑèÊ°à‰ª∂: ${atRisk}‰ª∂

„ÄêÈÄ≤Ë°å‰∏≠Ê°à‰ª∂„Äë
${activeProjects.slice(0, 10).map(p => `„Éª${p.customer} (${calculateProgress(p)}%) - ${p.assigned_to || 'Êú™Ââ≤ÂΩì'}`).join('\n')}

„Äê‰ªäÈÄ±„ÅÆÂÆå‰∫ÜÊ°à‰ª∂„Äë
${completedThisWeek.length > 0 ? completedThisWeek.map(p => `„Éª${p.customer}`).join('\n') : '„Å™„Åó'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  `;

  const preview = document.getElementById('reportPreview');
  preview.style.display = 'block';
  preview.textContent = report;
  showToast('ÈÄ±Â†±„ÇíÁîüÊàê„Åó„Åæ„Åó„Åü', 'success');
}

function generateMonthlyReport() {
  const today = new Date();
  const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

  const activeProjects = projects.filter(p => !p.is_archived);
  const completedThisMonth = projects.filter(p => {
    if (!p.is_archived) return false;
    const updated = new Date(p.updated_at);
    return updated >= monthAgo;
  });

  const designerStats = {};
  designers.filter(d => d.category === 'Ë®≠Ë®à').forEach(d => {
    designerStats[d.name] = { total: 0, completed: 0 };
  });
  projects.forEach(p => {
    if (p.assigned_to && designerStats[p.assigned_to]) {
      designerStats[p.assigned_to].total++;
      if (p.is_archived) designerStats[p.assigned_to].completed++;
    }
  });

  const report = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìà ArchiDeck ÊúàÂ†±
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ÊúüÈñì: ${monthAgo.toLocaleDateString('ja-JP')} „Äú ${today.toLocaleDateString('ja-JP')}

„Äê„Çµ„Éû„É™„Éº„Äë
„ÉªÁ∑èÊ°à‰ª∂Êï∞: ${projects.length}‰ª∂
„ÉªÈÄ≤Ë°å‰∏≠: ${activeProjects.length}‰ª∂
„Éª‰ªäÊúàÂÆå‰∫Ü: ${completedThisMonth.length}‰ª∂
„ÉªÂÆå‰∫ÜÁéá: ${projects.length > 0 ? Math.round(completedThisMonth.length / projects.length * 100) : 0}%

„ÄêÊãÖÂΩìËÄÖÂà•ÂÆüÁ∏æ„Äë
${Object.entries(designerStats).map(([name, stats]) => `„Éª${name}: ${stats.total}‰ª∂ÊãÖÂΩì / ${stats.completed}‰ª∂ÂÆå‰∫Ü`).join('\n')}

„Äê‰ªäÊúà„ÅÆÂÆå‰∫ÜÊ°à‰ª∂„Äë
${completedThisMonth.length > 0 ? completedThisMonth.map(p => `„Éª${p.customer} (ÊãÖÂΩì: ${p.assigned_to || 'Êú™Ââ≤ÂΩì'})`).join('\n') : '„Å™„Åó'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  `;

  const preview = document.getElementById('reportPreview');
  preview.style.display = 'block';
  preview.textContent = report;
  showToast('ÊúàÂ†±„ÇíÁîüÊàê„Åó„Åæ„Åó„Åü', 'success');
}

function exportAnalyticsCSV() {
  const headers = ['Ê°à‰ª∂Âêç', 'ÊãÖÂΩìËÄÖ', 'ÂïÜÂìÅ', 'ÈÄ≤ÊçóÁéá', '„Çπ„ÉÜ„Éº„Çø„Çπ', '‰ΩúÊàêÊó•'];
  const rows = projects.map(p => [
    p.customer,
    p.assigned_to || '',
    p.specifications || '',
    calculateProgress(p) + '%',
    p.is_archived ? 'ÂÆå‰∫Ü' : 'ÈÄ≤Ë°å‰∏≠',
    p.created_at ? new Date(p.created_at).toLocaleDateString('ja-JP') : ''
  ]);

  const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
  const bom = '\uFEFF';
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `archideck_analytics_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
}

// ============================================
// Èü≥Â£∞ÂÖ•ÂäõÊ©üËÉΩ
// ============================================
let recognition = null;

function initVoiceInput() {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;
    recognition.interimResults = false;
  }
}

function startVoiceInput(targetInputId) {
  if (!recognition) {
    showToast('Èü≥Â£∞ÂÖ•Âäõ„ÅØ„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„Åß„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return;
  }

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    const input = document.getElementById(targetInputId);
    if (input) {
      input.value = transcript;
      showToast('Èü≥Â£∞ÂÖ•ÂäõÂÆå‰∫Ü', 'success');
    }
  };

  recognition.onerror = (event) => {
    showToast('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº: ' + event.error, 'error');
  };

  recognition.start();
  showToast('Ë©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ...', 'info');
}

// ÂàùÊúüÂåñÊôÇ„Å´Èü≥Â£∞ÂÖ•Âäõ„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
document.addEventListener('DOMContentLoaded', initVoiceInput);

// ============================================
// „Ç´„Çπ„Çø„Éû„Ç§„Ç∫Ê©üËÉΩÔºàFCÂêë„Åë„Éé„Éº„Ç≥„Éº„ÉâÔºâ
// ============================================
function loadCustomization() {
  if (!currentOrganization) return;

  document.getElementById('customOrgName').value = currentOrganization.name || '';
  document.getElementById('customLogoUrl').value = currentOrganization.logo_url || '';
  document.getElementById('customPrimaryColor').value = currentOrganization.primary_color || '#2563EB';
  document.getElementById('customPrimaryColorText').value = currentOrganization.primary_color || '#2563EB';
  document.getElementById('customSecondaryColor').value = currentOrganization.secondary_color || '#059669';
  document.getElementById('customSecondaryColorText').value = currentOrganization.secondary_color || '#059669';

  updatePreview();
}

function previewCustomization() {
  const primaryColor = document.getElementById('customPrimaryColor').value;
  const secondaryColor = document.getElementById('customSecondaryColor').value;
  const name = document.getElementById('customOrgName').value;
  const logoUrl = document.getElementById('customLogoUrl').value;

  // CSS„Ç´„Çπ„Çø„É†„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÊõ¥Êñ∞
  document.documentElement.style.setProperty('--primary-color', primaryColor);
  document.documentElement.style.setProperty('--secondary-color', secondaryColor);

  // „Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞
  if (name) {
    document.title = `ArchiDeck | ${name}`;
  }

  // „Éó„É¨„Éì„É•„ÉºÈ†òÂüü„ÇíÊõ¥Êñ∞
  updatePreview();
  showToast('„Éó„É¨„Éì„É•„Éº„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü', 'success');
}

function updatePreview() {
  const primaryColor = document.getElementById('customPrimaryColor').value;
  const secondaryColor = document.getElementById('customSecondaryColor').value;
  const name = document.getElementById('customOrgName').value;
  const logoUrl = document.getElementById('customLogoUrl').value;

  const previewLogo = document.getElementById('previewLogo');
  const previewTitle = document.getElementById('previewTitle');

  if (logoUrl) {
    previewLogo.innerHTML = `<img src="${logoUrl}" style="max-width: 32px; max-height: 32px; object-fit: contain;">`;
  } else {
    previewLogo.innerHTML = 'üè†';
    previewLogo.style.background = `linear-gradient(135deg, ${primaryColor}, ${secondaryColor})`;
  }

  previewTitle.textContent = name || 'ArchiDeck';
}

async function saveCustomization() {
  if (!currentOrganization) {
    showToast('ÁµÑÁπîÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }

  const statusEl = document.getElementById('customizeStatus');
  statusEl.innerHTML = '<span style="color: var(--text-muted);">‰øùÂ≠ò‰∏≠...</span>';

  const updates = {
    name: document.getElementById('customOrgName').value,
    logo_url: document.getElementById('customLogoUrl').value,
    primary_color: document.getElementById('customPrimaryColor').value,
    secondary_color: document.getElementById('customSecondaryColor').value,
    updated_at: new Date().toISOString()
  };

  const { error } = await supabase
    .from('organizations')
    .update(updates)
    .eq('id', currentOrganization.id);

  if (error) {
    statusEl.innerHTML = `<span style="color: var(--danger-color);">‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}</span>`;
    return;
  }

  // „É≠„Éº„Ç´„É´„ÅÆÁµÑÁπîÊÉÖÂ†±„ÇíÊõ¥Êñ∞
  Object.assign(currentOrganization, updates);

  // ÁîªÈù¢„Å´ÈÅ©Áî®
  applyWhiteLabel(currentOrganization);

  statusEl.innerHTML = '<span style="color: var(--success-color);">‰øùÂ≠ò„Åó„Åæ„Åó„Åü</span>';
  showToast('„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');

  setTimeout(() => {
    statusEl.innerHTML = '';
  }, 3000);
}

function resetCustomization() {
  document.getElementById('customOrgName').value = '';
  document.getElementById('customLogoUrl').value = '';
  document.getElementById('customPrimaryColor').value = '#2563EB';
  document.getElementById('customPrimaryColorText').value = '#2563EB';
  document.getElementById('customSecondaryColor').value = '#059669';
  document.getElementById('customSecondaryColorText').value = '#059669';

  // CSS„Ç´„Çπ„Çø„É†„Éó„É≠„Éë„ÉÜ„Ç£„Çí„Éá„Éï„Ç©„É´„Éà„Å´„É™„Çª„ÉÉ„Éà
  document.documentElement.style.setProperty('--primary-color', '#2563EB');
  document.documentElement.style.setProperty('--secondary-color', '#059669');
  document.title = 'ArchiDeck | G„Éè„Ç¶„Çπ Ë®≠Ë®àÊ•≠ÂãôÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†';

  updatePreview();
  showToast('„Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü', 'success');
}

// „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº„ÅÆÂêåÊúü
document.addEventListener('DOMContentLoaded', function() {
  const primaryColorPicker = document.getElementById('customPrimaryColor');
  const primaryColorText = document.getElementById('customPrimaryColorText');
  const secondaryColorPicker = document.getElementById('customSecondaryColor');
  const secondaryColorText = document.getElementById('customSecondaryColorText');

  if (primaryColorPicker && primaryColorText) {
    primaryColorPicker.addEventListener('input', function() {
      primaryColorText.value = this.value;
      updatePreview();
    });
  }

  if (secondaryColorPicker && secondaryColorText) {
    secondaryColorPicker.addEventListener('input', function() {
      secondaryColorText.value = this.value;
      updatePreview();
    });
  }
});

// ============================================
// Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊ©üËÉΩ
// ============================================
let autoBackupEnabled = localStorage.getItem('autoBackupEnabled') !== 'false';

function toggleAutoBackup() {
  const toggle = document.getElementById('autoBackupToggle');
  autoBackupEnabled = toggle.checked;
  localStorage.setItem('autoBackupEnabled', autoBackupEnabled);
  showToast(autoBackupEnabled ? 'Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÊúâÂäπÂåñ„Åó„Åæ„Åó„Åü' : 'Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÁÑ°ÂäπÂåñ„Åó„Åæ„Åó„Åü', 'info');
}

function saveAutoBackup() {
  if (!autoBackupEnabled) return;

  try {
    const backup = {
      version: '4.3',
      created_at: new Date().toISOString(),
      data: {
        projects: projects,
        designers: designers,
        tasksV2: tasksV2,
        vendors: vendors,
        emailTemplates: emailTemplates,
        products: products,
        vendorCategories: vendorCategories,
        taskVendorMappings: taskVendorMappings
      }
    };

    const json = JSON.stringify(backup);

    // „Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ (5MBÂà∂Èôê)
    if (json.length > 5 * 1024 * 1024) {
      console.warn('‚ö†Ô∏è „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô„ÄÇ„É≠„Éº„Ç´„É´‰øùÂ≠ò„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ');
      return;
    }

    localStorage.setItem('archideck_auto_backup', json);
    localStorage.setItem('archideck_last_backup', new Date().toISOString());

    // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂ±•Ê≠¥„Çí‰øùÊåÅÔºàÊúÄÂ§ß3‰ª∂Ôºâ
    const history = JSON.parse(localStorage.getItem('archideck_backup_history') || '[]');
    history.unshift({
      timestamp: new Date().toISOString(),
      projectCount: projects.length,
      designerCount: designers.length
    });
    if (history.length > 3) history.pop();
    localStorage.setItem('archideck_backup_history', JSON.stringify(history));

    updateBackupUI();
    console.log('‚úÖ Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü:', new Date().toLocaleString());
  } catch (e) {
    console.warn('Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç®„É©„Éº:', e);
  }
}

function updateBackupUI() {
  const lastBackupEl = document.getElementById('lastBackupTime');
  const countEl = document.getElementById('localBackupCount');
  const toggleEl = document.getElementById('autoBackupToggle');

  if (lastBackupEl) {
    const lastBackup = localStorage.getItem('archideck_last_backup');
    lastBackupEl.textContent = lastBackup ? new Date(lastBackup).toLocaleString('ja-JP') : '-';
  }

  if (countEl) {
    const history = JSON.parse(localStorage.getItem('archideck_backup_history') || '[]');
    countEl.textContent = history.length.toString();
  }

  if (toggleEl) {
    toggleEl.checked = autoBackupEnabled;
  }
}

function downloadLocalBackup() {
  const backup = localStorage.getItem('archideck_auto_backup');
  if (!backup) {
    showToast('„É≠„Éº„Ç´„É´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'warning');
    return;
  }

  const blob = new Blob([backup], { type: 'application/json' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `archideck_local_backup_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  showToast('„É≠„Éº„Ç´„É´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
}

// ÂàùÊúüÂåñÊôÇ„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóUI„ÇíÊõ¥Êñ∞
setTimeout(updateBackupUI, 1000);

// ÂÆöÊúüÁöÑ„Å´Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºà5ÂàÜ„Åî„Å®Ôºâ
setInterval(() => {
  if (projects.length > 0 || designers.length > 0) {
    saveAutoBackup();
  }
}, 5 * 60 * 1000);

// „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê
async function createBackup() {
  const statusEl = document.getElementById('backupStatus');
  statusEl.innerHTML = '<span style="color: var(--text-muted);">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê‰∏≠...</span>';

  try {
    const backup = {
      version: '4.1',
      created_at: new Date().toISOString(),
      data: {
        projects: projects,
        designers: designers,
        tasksV2: tasksV2,
        vendors: vendors,
        emailTemplates: emailTemplates,
        products: products,
        vendorCategories: vendorCategories,
        taskVendorMappings: taskVendorMappings
      }
    };

    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `archideck_backup_${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    statusEl.innerHTML = '<span style="color: var(--success-color);">‚úÖ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü</span>';
    showToast('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
  } catch (error) {
    console.error('Backup error:', error);
    statusEl.innerHTML = '<span style="color: var(--danger-color);">‚ùå „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</span>';
    showToast('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
}

// „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂæ©ÂÖÉ
function restoreBackup() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.json';
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!confirm('ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇÊú¨ÂΩì„Å´Âæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü')) return;

    const statusEl = document.getElementById('backupStatus');
    statusEl.innerHTML = '<span style="color: var(--text-muted);">Âæ©ÂÖÉ‰∏≠...</span>';

    try {
      const text = await file.text();
      const backup = JSON.parse(text);

      if (!backup.version || !backup.data) {
        throw new Error('ÁÑ°Âäπ„Å™„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„Åß„Åô');
      }

      // ÂêÑ„ÉÜ„Éº„Éñ„É´„ÇíÂæ©ÂÖÉ
      const tables = ['projects', 'designers', 'vendors', 'email_templates', 'products', 'vendor_categories'];
      const dataMap = {
        projects: backup.data.projects,
        designers: backup.data.designers,
        vendors: backup.data.vendors,
        email_templates: backup.data.emailTemplates,
        products: backup.data.products,
        vendor_categories: backup.data.vendorCategories
      };

      for (const table of tables) {
        const data = dataMap[table];
        if (data && data.length > 0) {
          // Êó¢Â≠ò„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶Âæ©ÂÖÉ
          await supabase.from(table).delete().neq('id', '00000000-0000-0000-0000-000000000000');
          for (const item of data) {
            await supabase.from(table).insert(item).catch(() => {});
          }
        }
      }

      statusEl.innerHTML = '<span style="color: var(--success-color);">‚úÖ Âæ©ÂÖÉ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</span>';
      showToast('Âæ©ÂÖÉ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü', 'success');
    } catch (error) {
      console.error('Restore error:', error);
      statusEl.innerHTML = '<span style="color: var(--danger-color);">‚ùå Âæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message + '</span>';
      showToast('Âæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    }
  };
  fileInput.click();
}

// kintoneÈÄ£Êê∫Ë®≠ÂÆö‰øùÂ≠ò
async function saveKintoneSettings() {
  const settings = {
    domain: document.getElementById('kintoneDomain').value,
    app_id: document.getElementById('kintoneAppId').value,
    api_token: document.getElementById('kintoneApiToken').value
  };

  if (!settings.domain || !settings.app_id || !settings.api_token) {
    showToast('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  const { error } = await supabase
    .from('kintone_settings')
    .upsert({
      ...settings,
      is_active: true,
      updated_at: new Date().toISOString()
    });

  if (error) {
    showToast('Ë®≠ÂÆö‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    return;
  }

  kintoneSettings = settings;
  showToast('kintoneË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
}

// kintoneÊé•Á∂ö„ÉÜ„Çπ„Éà
async function testKintoneConnection() {
  const domain = document.getElementById('kintoneDomain').value;
  const appId = document.getElementById('kintoneAppId').value;
  const apiToken = document.getElementById('kintoneApiToken').value;

  if (!domain || !appId || !apiToken) {
    showToast('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
    return;
  }

  document.getElementById('kintoneStatus').innerHTML = '<span style="color: var(--text-muted);">Êé•Á∂ö„ÉÜ„Çπ„Éà‰∏≠...</span>';

  try {
    // CORSÂà∂Èôê„ÅÆ„Åü„ÇÅ„ÄÅÂÆüÈöõ„ÅÆÊé•Á∂ö„ÉÜ„Çπ„Éà„ÅØ„Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„ÅßË°å„ÅÜÂøÖË¶Å„Åå„ÅÇ„Çã
    // „Åì„Åì„Åß„ÅØUI„ÅÆ„ÅøÂÆüË£Ö
    setTimeout(() => {
      document.getElementById('kintoneStatus').innerHTML = '<span style="color: var(--success-color);">‚úÖ Êé•Á∂öË®≠ÂÆö„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇÂÆüÈöõ„ÅÆÂêåÊúü„ÅØ„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßË°å„Çè„Çå„Åæ„Åô„ÄÇ</span>';
    }, 1000);
  } catch (e) {
    document.getElementById('kintoneStatus').innerHTML = '<span style="color: var(--danger-color);">‚ùå Êé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</span>';
  }
}

// kintoneË®≠ÂÆöË™≠„ÅøËæº„Åø
async function loadKintoneSettings() {
  const { data } = await supabase
    .from('kintone_settings')
    .select('*')
    .eq('is_active', true)
    .single();

  if (data) {
    kintoneSettings = data;
    document.getElementById('kintoneDomain').value = data.domain || '';
    document.getElementById('kintoneAppId').value = data.app_id || '';
    // API„Éà„Éº„ÇØ„É≥„ÅØË°®Á§∫„Åó„Å™„ÅÑÔºà„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ôºâ
  }
}

// kintone„Åã„Çâ„Ç§„É≥„Éù„Éº„ÉàÔºàCSV„Éô„Éº„ÇπÔºâ
async function importFromKintone() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.csv';
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const text = await file.text();
    const lines = text.split('\n');
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

    const customerIdx = headers.findIndex(h => h.includes('È°ßÂÆ¢') || h.includes('ÈÇ∏Âêç') || h.includes('customer'));
    const addressIdx = headers.findIndex(h => h.includes('Âª∫ÁØâÂú∞') || h.includes('‰ΩèÊâÄ') || h.includes('address'));
    const recordIdIdx = headers.findIndex(h => h.includes('„É¨„Ç≥„Éº„Éâ') || h.includes('record') || h === '$id');

    if (customerIdx === -1) {
      showToast('È°ßÂÆ¢Âêç/ÈÇ∏Âêç„Ç´„É©„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
      return;
    }

    let importCount = 0;
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
      if (!cols[customerIdx]) continue;

      const customer = cols[customerIdx];
      const address = addressIdx >= 0 ? cols[addressIdx] : '';
      const kintoneRecordId = recordIdIdx >= 0 ? cols[recordIdIdx] : '';

      // Êó¢Â≠ò„ÉÅ„Çß„ÉÉ„ÇØ
      const existing = projects.find(p => p.customer === customer);
      if (existing) continue;

      // Êñ∞Ë¶è‰ΩúÊàê
      const { error } = await supabase.from('projects').insert({
        customer,
        building_address: address,
        kintone_record_id: kintoneRecordId,
        assigned_to: designers.find(d => d.category === 'Ë®≠Ë®à')?.name || '',
        specifications: 'LIFE',
        status: 'active',
        progress: {}
      });

      if (!error) importCount++;
    }

    showToast(`${importCount}‰ª∂„ÅÆÊ°à‰ª∂„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`, 'success');
    await loadProjects();
    renderProjects();
  };
  fileInput.click();
}

// kintone„Å∏„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÔºàCSVÔºâ
function exportToKintone() {
  const headers = ['Ê°à‰ª∂ID', 'kintone_record_id', 'È°ßÂÆ¢Âêç', 'Âª∫ÁØâÂú∞', 'Ë®≠Ë®àÊãÖÂΩì', 'ÂïÜÂìÅ', 'ÈÄ≤ÊçóÁéá', 'ÈñìÂèñÁ¢∫ÂÆöÊó•', 'ÁùÄÂ∑•Ë®±ÂèØÊó•', 'Â§âÊõ¥Â•ëÁ¥ÑÂâç‰ºöË≠∞Êó•', 'Êõ¥Êñ∞Êó•'];
  const rows = projects.map(p => [
    p.id,
    p.kintone_record_id || '',
    p.customer,
    p.building_address || '',
    p.assigned_to,
    p.specifications,
    calculateProgress(p) + '%',
    p.layout_confirmed_date || '',
    p.construction_permit_date || '',
    p.pre_contract_meeting_date || '',
    p.updated_at
  ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));

  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `archideck_export_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  showToast('CSV„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü', 'success');
}

// kintoneÂêåÊúüÂØæË±°„Éï„Ç£„Éº„É´„Éâ„ÇíÊõ¥Êñ∞
async function syncToKintone(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project || !project.kintone_record_id) {
    showToast('kintone record ID„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return;
  }

  if (!kintoneSettings?.domain || !kintoneSettings?.api_token) {
    showToast('kintoneË®≠ÂÆö„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    return;
  }

  // ÂÆüÈöõ„ÅÆAPI„Ç≥„Éº„É´„ÅØCORSÂà∂Èôê„ÅÆ„Åü„ÇÅ„Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„ÅßÂÆüË°å„ÅåÂøÖË¶Å
  // „Åì„Åì„Åß„ÅØUI„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅÆ„Åø
  showToast('kintoneÂêåÊúü„Çí„É™„ÇØ„Ç®„Çπ„Éà„Åó„Åæ„Åó„ÅüÔºà„Çµ„Éº„Éê„Éº„Çµ„Ç§„ÉâÂá¶ÁêÜÂæÖ„Å°Ôºâ', 'info');

  // ÂêåÊúü„É™„ÇØ„Ç®„Çπ„Éà„ÇíDB„Å´Ë®òÈå≤
  await supabase.from('kintone_sync_queue').insert({
    project_id: projectId,
    kintone_record_id: project.kintone_record_id,
    sync_type: 'push',
    status: 'pending',
    data: {
      layout_confirmed_date: project.layout_confirmed_date,
      construction_permit_date: project.construction_permit_date,
      pre_contract_meeting_date: project.pre_contract_meeting_date
    }
  }).catch(() => {});
}

// Â§ñÊßãÊãÖÂΩì„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíË®≠ÂÆö
function populateExteriorAssigneeDropdown(projectId = null, project = null) {
  const exteriorDesigners = designers.filter(d => d.category === 'Â§ñÊßã');
  const exteriorAssigneeSelect = document.getElementById('projectExteriorAssignee');

  if (exteriorAssigneeSelect) {
    exteriorAssigneeSelect.innerHTML = '<option value="">Êú™ÂÆö</option>' +
      exteriorDesigners.map(d => `<option value="${d.name}">${d.name}</option>`).join('');

    if (projectId && project) {
      exteriorAssigneeSelect.value = project.exterior_assignee || '';
    }
  }
}

// openProjectModal„ÇíÊã°Âºµ
const originalOpenProjectModal = openProjectModal;
openProjectModal = function(projectId = null) {
  originalOpenProjectModal(projectId);

  const project = projectId ? projects.find(p => p.id === projectId) : null;
  populateExteriorAssigneeDropdown(projectId, project);
};

// saveProject„ÇíÊã°Âºµ
const originalSaveProject = saveProject;
saveProject = async function() {
  const customer = document.getElementById('projectCustomer').value.trim();
  const assignedTo = document.getElementById('projectAssignedTo').value.trim();
  const icAssignee = document.getElementById('projectIcAssignee').value.trim();
  const exteriorAssignee = document.getElementById('projectExteriorAssignee')?.value.trim() || '';
  const specifications = document.getElementById('projectSpecifications').value;
  const memo = document.getElementById('projectMemo').value.trim();

  if (!customer || !assignedTo) {
    showToast('„ÅäÂÆ¢ÊßòÂêç„Å®ÊãÖÂΩìÔºàË®≠Ë®àÔºâ„ÅØÂøÖÈ†à„Åß„Åô', 'error');
    return;
  }

  showStatus('‰øùÂ≠ò‰∏≠...', 'saving');

  const projectData = {
    customer,
    assigned_to: assignedTo,
    ic_assignee: icAssignee || null,
    exterior_assignee: exteriorAssignee || null,
    specifications,
    memo,
    updated_at: new Date().toISOString()
  };

  try {
    if (editingProjectId) {
      const { error } = await supabase
        .from('projects')
        .update(projectData)
        .eq('id', editingProjectId);

      if (error) throw error;

      const idx = projects.findIndex(p => p.id === editingProjectId);
      if (idx !== -1) {
        projects[idx] = { ...projects[idx], ...projectData };
      }
    } else {
      const uid = 'P-' + Date.now();
      projectData.uid = uid;
      projectData.progress = {};
      projectData.status = 'active';

      const { data, error } = await supabase
        .from('projects')
        .insert(projectData)
        .select()
        .single();

      if (error) throw error;
      projects.push(data);
    }

    showStatus('‰øùÂ≠òÊ∏à„Åø', 'saved');
    showToast(editingProjectId ? 'Ê°à‰ª∂„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü' : 'Ê°à‰ª∂„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
    closeProjectModal();
    renderSidebar();
    renderProjects();
  } catch (error) {
    console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
    showStatus('„Ç®„É©„Éº', 'error');
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  }
};

// ============================================
// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ
// ============================================
window.addEventListener('DOMContentLoaded', () => {
  checkAuth();
  // URLÁõ¥Êé•„Ç¢„ÇØ„Çª„Çπ„ÅÆÂá¶ÁêÜ„ÅØcheckAuth() ‚Üí init()ÂÆå‰∫ÜÂæå„Å´Ëá™ÂãïÂÆüË°å„Åï„Çå„Çã

  // Service WorkerÁôªÈå≤ÔºàPWAÂØæÂøúÔºâ- Âº∑Âà∂Êõ¥Êñ∞
  if ('serviceWorker' in navigator) {
    // Âè§„ÅÑ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂÖ®„Å¶„ÇØ„É™„Ç¢
    caches.keys().then(cacheNames => {
      cacheNames.forEach(cacheName => {
        caches.delete(cacheName);
        console.log('üóëÔ∏è „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢:', cacheName);
      });
    });

    // Êó¢Â≠ò„ÅÆService Worker„ÇíÊõ¥Êñ∞
    navigator.serviceWorker.getRegistrations().then(registrations => {
      registrations.forEach(registration => {
        registration.update();
        console.log('üîÑ Service WorkerÊõ¥Êñ∞„ÇíÁ¢∫Ë™ç');
      });
    });

    navigator.serviceWorker.register('/archideck/sw.js', { updateViaCache: 'none' })
      .then(reg => {
        console.log('‚úÖ Service Worker registered:', reg.scope);
        // Êñ∞„Åó„ÅÑService Worker„Åå„ÅÇ„Çå„Å∞Âç≥Â∫ß„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éô„Éº„Éà
        if (reg.waiting) {
          reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
      })
      .catch(err => console.log('‚ùå Service Worker registration failed:', err));
  }

  // „Éó„ÉÉ„Ç∑„É•ÈÄöÁü•„ÅÆË®±ÂèØ„É™„ÇØ„Ç®„Çπ„Éà
  if ('Notification' in window && Notification.permission === 'default') {
    // 3ÁßíÂæå„Å´ÈÄöÁü•Ë®±ÂèØ„ÇíÊ±Ç„ÇÅ„Çã
    setTimeout(() => {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          console.log('‚úÖ Push notifications enabled');
        }
      });
    }, 3000);
  }
});
</script>
</body>
</html>
